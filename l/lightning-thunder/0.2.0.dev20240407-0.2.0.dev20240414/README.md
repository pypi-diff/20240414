# Comparing `tmp/lightning-thunder-0.2.0.dev20240407.tar.gz` & `tmp/lightning_thunder-0.2.0.dev20240414.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "lightning-thunder-0.2.0.dev20240407.tar", last modified: Sun Apr  7 00:21:01 2024, max compression
+gzip compressed data, was "lightning_thunder-0.2.0.dev20240414.tar", last modified: Sun Apr 14 00:21:59 2024, max compression
```

## Comparing `lightning-thunder-0.2.0.dev20240407.tar` & `lightning_thunder-0.2.0.dev20240414.tar`

### file list

```diff
@@ -1,101 +1,101 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 00:21:01.723020 lightning-thunder-0.2.0.dev20240407/
--rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      760 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12478 2024-04-07 00:21:01.723020 lightning-thunder-0.2.0.dev20240407/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     9649 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/README.md
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 00:21:01.719020 lightning-thunder-0.2.0.dev20240407/lightning_thunder.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    12478 2024-04-07 00:21:01.000000 lightning-thunder-0.2.0.dev20240407/lightning_thunder.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     2438 2024-04-07 00:21:01.000000 lightning-thunder-0.2.0.dev20240407/lightning_thunder.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-07 00:21:01.000000 lightning-thunder-0.2.0.dev20240407/lightning_thunder.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-07 00:21:01.000000 lightning-thunder-0.2.0.dev20240407/lightning_thunder.egg-info/not-zip-safe
--rw-r--r--   0 runner    (1001) docker     (127)      512 2024-04-07 00:21:01.000000 lightning-thunder-0.2.0.dev20240407/lightning_thunder.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        8 2024-04-07 00:21:01.000000 lightning-thunder-0.2.0.dev20240407/lightning_thunder.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 00:21:01.703020 lightning-thunder-0.2.0.dev20240407/requirements/
--rw-r--r--   0 runner    (1001) docker     (127)      239 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/requirements/base.txt
--rw-r--r--   0 runner    (1001) docker     (127)       12 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/requirements/devel.txt
--rw-r--r--   0 runner    (1001) docker     (127)      344 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/requirements/docs.txt
--rw-r--r--   0 runner    (1001) docker     (127)      117 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/requirements/notebooks.txt
--rw-r--r--   0 runner    (1001) docker     (127)      864 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/requirements/test.txt
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-04-07 00:21:01.723020 lightning-thunder-0.2.0.dev20240407/setup.cfg
--rwxr-xr-x   0 runner    (1001) docker     (127)     5871 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 00:21:01.703020 lightning-thunder-0.2.0.dev20240407/thunder/
--rw-r--r--   0 runner    (1001) docker     (127)      436 2024-04-07 00:21:01.000000 lightning-thunder-0.2.0.dev20240407/thunder/__about__.py
--rw-r--r--   0 runner    (1001) docker     (127)    33198 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 00:21:01.707020 lightning-thunder-0.2.0.dev20240407/thunder/benchmarks/
--rw-r--r--   0 runner    (1001) docker     (127)   101338 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/benchmarks/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    21165 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/benchmarks/benchmark_litgpt.py
--rw-r--r--   0 runner    (1001) docker     (127)    20006 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/benchmarks/distributed.py
--rw-r--r--   0 runner    (1001) docker     (127)     3726 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/benchmarks/einsum.py
--rw-r--r--   0 runner    (1001) docker     (127)    26212 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/benchmarks/targets.py
--rw-r--r--   0 runner    (1001) docker     (127)    11181 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/benchmarks/test_benchmark_litgpt.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 00:21:01.707020 lightning-thunder-0.2.0.dev20240407/thunder/clang/
--rw-r--r--   0 runner    (1001) docker     (127)    63665 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/clang/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2516 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/clang/langctx.py
--rw-r--r--   0 runner    (1001) docker     (127)    31687 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/common.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 00:21:01.711020 lightning-thunder-0.2.0.dev20240407/thunder/core/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    14999 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/baseutils.py
--rw-r--r--   0 runner    (1001) docker     (127)    13335 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/codeutils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2139 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/compile_data.py
--rw-r--r--   0 runner    (1001) docker     (127)     5921 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/devices.py
--rw-r--r--   0 runner    (1001) docker     (127)    17106 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/dtypes.py
--rw-r--r--   0 runner    (1001) docker     (127)   256512 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/interpreter.py
--rw-r--r--   0 runner    (1001) docker     (127)    54102 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/jit_ext.py
--rw-r--r--   0 runner    (1001) docker     (127)     4146 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/langctxs.py
--rw-r--r--   0 runner    (1001) docker     (127)     7046 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/options.py
--rw-r--r--   0 runner    (1001) docker     (127)    14058 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/patterns.py
--rw-r--r--   0 runner    (1001) docker     (127)   116011 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/prims.py
--rw-r--r--   0 runner    (1001) docker     (127)      629 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/profile.py
--rw-r--r--   0 runner    (1001) docker     (127)    48752 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/proxies.py
--rw-r--r--   0 runner    (1001) docker     (127)      731 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/pytree.py
--rw-r--r--   0 runner    (1001) docker     (127)    28140 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/rematerialization.py
--rw-r--r--   0 runner    (1001) docker     (127)    25222 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/symbol.py
--rw-r--r--   0 runner    (1001) docker     (127)    18726 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/trace.py
--rw-r--r--   0 runner    (1001) docker     (127)    10446 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/transform_common.py
--rw-r--r--   0 runner    (1001) docker     (127)   140309 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/transforms.py
--rw-r--r--   0 runner    (1001) docker     (127)    37010 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     7663 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/core/vjp_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 00:21:01.711020 lightning-thunder-0.2.0.dev20240407/thunder/cudagraphs/
--rw-r--r--   0 runner    (1001) docker     (127)     5265 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/cudagraphs/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 00:21:01.715020 lightning-thunder-0.2.0.dev20240407/thunder/distributed/
--rw-r--r--   0 runner    (1001) docker     (127)    17549 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/distributed/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7100 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/distributed/bucketing.py
--rw-r--r--   0 runner    (1001) docker     (127)     9307 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/distributed/checkpoint.py
--rw-r--r--   0 runner    (1001) docker     (127)    10906 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/distributed/prims.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 00:21:01.715020 lightning-thunder-0.2.0.dev20240407/thunder/distributed/transforms/
--rw-r--r--   0 runner    (1001) docker     (127)      171 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/distributed/transforms/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     8449 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/distributed/transforms/ddp.py
--rw-r--r--   0 runner    (1001) docker     (127)    28416 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/distributed/transforms/fsdp.py
--rw-r--r--   0 runner    (1001) docker     (127)    10897 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/distributed/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 00:21:01.715020 lightning-thunder-0.2.0.dev20240407/thunder/examine/
--rw-r--r--   0 runner    (1001) docker     (127)     8681 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/examine/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5761 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/examine/memory_caculation.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 00:21:01.719020 lightning-thunder-0.2.0.dev20240407/thunder/executors/
--rw-r--r--   0 runner    (1001) docker     (127)      598 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7092 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/apex_entropyex.py
--rw-r--r--   0 runner    (1001) docker     (127)     4558 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/cudnn_layernormex.py
--rw-r--r--   0 runner    (1001) docker     (127)    24903 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/cudnnex.py
--rw-r--r--   0 runner    (1001) docker     (127)    10546 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/data_dependent_partition.py
--rw-r--r--   0 runner    (1001) docker     (127)     1085 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/nvfuserex.py
--rw-r--r--   0 runner    (1001) docker     (127)    74595 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/nvfuserex_impl.py
--rw-r--r--   0 runner    (1001) docker     (127)    10861 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/passes.py
--rw-r--r--   0 runner    (1001) docker     (127)    13938 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/pythonex.py
--rw-r--r--   0 runner    (1001) docker     (127)    26538 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/sdpaex.py
--rw-r--r--   0 runner    (1001) docker     (127)    15407 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/torch_autograd.py
--rw-r--r--   0 runner    (1001) docker     (127)     7908 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/torch_compile.py
--rw-r--r--   0 runner    (1001) docker     (127)    76466 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/torchex.py
--rw-r--r--   0 runner    (1001) docker     (127)    22098 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/transformer_engineex.py
--rw-r--r--   0 runner    (1001) docker     (127)      326 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/triton_crossentropy.py
--rw-r--r--   0 runner    (1001) docker     (127)    19675 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/triton_crossentropy_impl.py
--rw-r--r--   0 runner    (1001) docker     (127)      443 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/triton_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2646 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/executors/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 00:21:01.719020 lightning-thunder-0.2.0.dev20240407/thunder/extend/
--rw-r--r--   0 runner    (1001) docker     (127)    11671 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/extend/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    16957 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/functional.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 00:21:01.719020 lightning-thunder-0.2.0.dev20240407/thunder/numpy/
--rw-r--r--   0 runner    (1001) docker     (127)     1652 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/numpy/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2554 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/numpy/langctx.py
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/py.typed
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 00:21:01.719020 lightning-thunder-0.2.0.dev20240407/thunder/torch/
--rw-r--r--   0 runner    (1001) docker     (127)   146468 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/torch/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2494 2024-04-07 00:20:59.000000 lightning-thunder-0.2.0.dev20240407/thunder/torch/langctx.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.183459 lightning_thunder-0.2.0.dev20240414/
+-rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      760 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12527 2024-04-14 00:21:59.183459 lightning_thunder-0.2.0.dev20240414/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9649 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/README.md
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.183459 lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    12527 2024-04-14 00:21:59.000000 lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     2438 2024-04-14 00:21:59.000000 lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-14 00:21:59.000000 lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-14 00:21:59.000000 lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/not-zip-safe
+-rw-r--r--   0 runner    (1001) docker     (127)      524 2024-04-14 00:21:59.000000 lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        8 2024-04-14 00:21:59.000000 lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.167459 lightning_thunder-0.2.0.dev20240414/requirements/
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/requirements/base.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       12 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/requirements/devel.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      344 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/requirements/docs.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      130 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/requirements/notebooks.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      864 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/requirements/test.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-04-14 00:21:59.183459 lightning_thunder-0.2.0.dev20240414/setup.cfg
+-rwxr-xr-x   0 runner    (1001) docker     (127)     5871 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.171459 lightning_thunder-0.2.0.dev20240414/thunder/
+-rw-r--r--   0 runner    (1001) docker     (127)      436 2024-04-14 00:21:59.000000 lightning_thunder-0.2.0.dev20240414/thunder/__about__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35864 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.171459 lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/
+-rw-r--r--   0 runner    (1001) docker     (127)   101338 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21055 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/benchmark_litgpt.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20006 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/distributed.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3726 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/einsum.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26212 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/targets.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11181 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/test_benchmark_litgpt.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.171459 lightning_thunder-0.2.0.dev20240414/thunder/clang/
+-rw-r--r--   0 runner    (1001) docker     (127)    63815 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/clang/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2516 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/clang/langctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31678 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.175459 lightning_thunder-0.2.0.dev20240414/thunder/core/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14981 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/baseutils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13335 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/codeutils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2139 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/compile_data.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5921 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/devices.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17106 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/dtypes.py
+-rw-r--r--   0 runner    (1001) docker     (127)   255602 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/interpreter.py
+-rw-r--r--   0 runner    (1001) docker     (127)    54226 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/jit_ext.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4146 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/langctxs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7046 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/options.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14058 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/patterns.py
+-rw-r--r--   0 runner    (1001) docker     (127)   117252 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/prims.py
+-rw-r--r--   0 runner    (1001) docker     (127)      629 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/profile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    48759 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/proxies.py
+-rw-r--r--   0 runner    (1001) docker     (127)      731 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/pytree.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28170 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/rematerialization.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25979 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/symbol.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19122 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/trace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10446 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/transform_common.py
+-rw-r--r--   0 runner    (1001) docker     (127)   140614 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/transforms.py
+-rw-r--r--   0 runner    (1001) docker     (127)    37010 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7663 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/vjp_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.175459 lightning_thunder-0.2.0.dev20240414/thunder/cudagraphs/
+-rw-r--r--   0 runner    (1001) docker     (127)     5265 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/cudagraphs/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.175459 lightning_thunder-0.2.0.dev20240414/thunder/distributed/
+-rw-r--r--   0 runner    (1001) docker     (127)    17879 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/distributed/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7100 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/distributed/bucketing.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9307 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/distributed/checkpoint.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10906 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/distributed/prims.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.175459 lightning_thunder-0.2.0.dev20240414/thunder/distributed/transforms/
+-rw-r--r--   0 runner    (1001) docker     (127)      171 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/distributed/transforms/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8449 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/distributed/transforms/ddp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28416 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/distributed/transforms/fsdp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10897 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/distributed/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.179459 lightning_thunder-0.2.0.dev20240414/thunder/examine/
+-rw-r--r--   0 runner    (1001) docker     (127)     8681 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/examine/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5761 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/examine/memory_caculation.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.179459 lightning_thunder-0.2.0.dev20240414/thunder/executors/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7092 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/apex_entropyex.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4558 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/cudnn_layernormex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24903 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/cudnnex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10546 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/data_dependent_partition.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1085 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/nvfuserex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    75512 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/nvfuserex_impl.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10861 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/passes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13938 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/pythonex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26538 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/sdpaex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15407 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/torch_autograd.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7872 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/torch_compile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    82431 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/torchex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22098 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/transformer_engineex.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/triton_crossentropy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19675 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/triton_crossentropy_impl.py
+-rw-r--r--   0 runner    (1001) docker     (127)      443 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/triton_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2646 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.179459 lightning_thunder-0.2.0.dev20240414/thunder/extend/
+-rw-r--r--   0 runner    (1001) docker     (127)    15889 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/extend/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17053 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/functional.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.179459 lightning_thunder-0.2.0.dev20240414/thunder/numpy/
+-rw-r--r--   0 runner    (1001) docker     (127)     1652 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/numpy/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2554 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/numpy/langctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/py.typed
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.183459 lightning_thunder-0.2.0.dev20240414/thunder/torch/
+-rw-r--r--   0 runner    (1001) docker     (127)   148213 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/torch/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2494 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/torch/langctx.py
```

### Comparing `lightning-thunder-0.2.0.dev20240407/LICENSE` & `lightning_thunder-0.2.0.dev20240414/LICENSE`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/MANIFEST.in` & `lightning_thunder-0.2.0.dev20240414/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/PKG-INFO` & `lightning_thunder-0.2.0.dev20240414/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: lightning-thunder
-Version: 0.2.0.dev20240407
+Version: 0.2.0.dev20240414
 Summary: Lightning Thunder project.
 Home-page: https://github.com/Lightning-AI/lightning-thunder
 Download-URL: https://github.com/Lightning-AI/lightning-thunder
 Author: Lightning-AI et al
 Author-email: community@lightning.ai
 License: Apache 2.0
 Project-URL: Bug Tracker, https://github.com/Lightning-AI/lightning-thunder/issues
@@ -29,14 +29,15 @@
 Requires-Dist: lightning-utilities>=0.7.0
 Requires-Dist: numpy<2,>=1.23.0
 Requires-Dist: igraph>=0.10.4
 Requires-Dist: optree>=0.9.2
 Requires-Dist: opt_einsum>=3.3.0
 Requires-Dist: mpmath<1.4.0
 Provides-Extra: notebooks
+Requires-Dist: cuda-python; extra == "notebooks"
 Requires-Dist: ipython[all]==8.23.0; extra == "notebooks"
 Provides-Extra: test
 Requires-Dist: absl-py; extra == "test"
 Requires-Dist: coverage==7.4.4; extra == "test"
 Requires-Dist: einops; extra == "test"
 Requires-Dist: expecttest==0.2.1; extra == "test"
 Requires-Dist: fdm==0.4.1; extra == "test"
@@ -52,16 +53,16 @@
 Requires-Dist: pytest-timeout==2.2.0; extra == "test"
 Requires-Dist: pytest-timestamper==0.0.10; extra == "test"
 Requires-Dist: pytest-xdist==3.5.0; extra == "test"
 Requires-Dist: pytest==8.1.1; extra == "test"
 Requires-Dist: xlsxwriter; extra == "test"
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240407/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240407/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240414/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240414/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
     <br/>
 <br/>
 
 **Make PyTorch models Lightning fast.**
 
 ______________________________________________________________________
 
@@ -101,27 +102,27 @@
 &#160;
 
 ## Single-GPU performance
 
 Thunder can achieve significant speedups over standard non-compiled PyTorch code ("PyTorch eager"), through the compounding effects of optimizations and the use of best-in-class executors. The figure below shows the pretraining throughput for Llama 2 7B as implemented in [LitGPT](https://github.com/Lightning-AI/litgpt).
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240407/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240414/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
 </div>
 
 As shown in the plot above, Thunder achieves a 40% speedup in training throughput compared to eager code on H100 using a combination of executors including nvFuser, torch.compile, cuDNN, and TransformerEngine FP8.
 
 &#160;
 
 ## Multi-GPU performance
 
 Thunder also supports distributed strategies such as DDP and FSDP for training models on multiple GPUs. The following plot displays the normalized throughput measured for Llama 2 7B without FP8 mixed precision; support for FSDP is in progress.
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240407/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240414/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
 </div>
 
 &#160;
 
 ## Get started
 
 The easiest way to get started with Thunder, requiring no extra installations or setups, is by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240407
+Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240414
 Summary: Lightning Thunder project. Home-page: https://github.com/Lightning-AI/
 lightning-thunder Download-URL: https://github.com/Lightning-AI/lightning-
 thunder Author: Lightning-AI et al Author-email: community@lightning.ai
 License: Apache 2.0 Project-URL: Bug Tracker, https://github.com/Lightning-AI/
 lightning-thunder/issues Project-URL: Documentation, https://lightning-
 thunder.rtfd.io/en/latest/ Project-URL: Source Code, https://github.com/
 Lightning-AI/lightning-thunder Keywords: deep learning,AI Classifier:
@@ -13,29 +13,30 @@
 License :: OSI Approved :: Apache Software License Classifier: Operating System
 :: OS Independent Classifier: Programming Language :: Python :: 3 Classifier:
 Programming Language :: Python :: 3.10 Requires-Python: >=3.10, <3.12
 Description-Content-Type: text/markdown License-File: LICENSE Requires-Dist:
 torch>=2.2.0 Requires-Dist: looseversion==1.3.0 Requires-Dist: lightning-
 utilities>=0.7.0 Requires-Dist: numpy<2,>=1.23.0 Requires-Dist: igraph>=0.10.4
 Requires-Dist: optree>=0.9.2 Requires-Dist: opt_einsum>=3.3.0 Requires-Dist:
-mpmath<1.4.0 Provides-Extra: notebooks Requires-Dist: ipython[all]==8.23.0;
-extra == "notebooks" Provides-Extra: test Requires-Dist: absl-py; extra ==
-"test" Requires-Dist: coverage==7.4.4; extra == "test" Requires-Dist: einops;
-extra == "test" Requires-Dist: expecttest==0.2.1; extra == "test" Requires-
-Dist: fdm==0.4.1; extra == "test" Requires-Dist: graphviz==0.20.1; extra ==
-"test" Requires-Dist: hypothesis==6.100.0; extra == "test" Requires-Dist: jax;
+mpmath<1.4.0 Provides-Extra: notebooks Requires-Dist: cuda-python; extra ==
+"notebooks" Requires-Dist: ipython[all]==8.23.0; extra == "notebooks" Provides-
+Extra: test Requires-Dist: absl-py; extra == "test" Requires-Dist:
+coverage==7.4.4; extra == "test" Requires-Dist: einops; extra == "test"
+Requires-Dist: expecttest==0.2.1; extra == "test" Requires-Dist: fdm==0.4.1;
+extra == "test" Requires-Dist: graphviz==0.20.1; extra == "test" Requires-Dist:
+hypothesis==6.100.0; extra == "test" Requires-Dist: jax; (sys_platform ==
+"linux" or sys_platform == "darwin") and extra == "test" Requires-Dist: jaxlib;
 (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
-Requires-Dist: jaxlib; (sys_platform == "linux" or sys_platform == "darwin")
-and extra == "test" Requires-Dist: jsonargparse; extra == "test" Requires-Dist:
-numpy; extra == "test" Requires-Dist: pandas; extra == "test" Requires-Dist:
-pytest-cov==4.1.0; extra == "test" Requires-Dist: pytest-random-order==1.1.1;
-extra == "test" Requires-Dist: pytest-timeout==2.2.0; extra == "test" Requires-
-Dist: pytest-timestamper==0.0.10; extra == "test" Requires-Dist: pytest-
-xdist==3.5.0; extra == "test" Requires-Dist: pytest==8.1.1; extra == "test"
-Requires-Dist: xlsxwriter; extra == "test"
+Requires-Dist: jsonargparse; extra == "test" Requires-Dist: numpy; extra ==
+"test" Requires-Dist: pandas; extra == "test" Requires-Dist: pytest-cov==4.1.0;
+extra == "test" Requires-Dist: pytest-random-order==1.1.1; extra == "test"
+Requires-Dist: pytest-timeout==2.2.0; extra == "test" Requires-Dist: pytest-
+timestamper==0.0.10; extra == "test" Requires-Dist: pytest-xdist==3.5.0; extra
+== "test" Requires-Dist: pytest==8.1.1; extra == "test" Requires-Dist:
+xlsxwriter; extra == "test"
                               [Thunder][Thunder]
 
                     **Make PyTorch models Lightning fast.**
     ______________________________________________________________________
    _L_i_g_h_t_n_i_n_g_._a_i â¢ _P_e_r_f_o_r_m_a_n_c_e â¢ _G_e_t_ _s_t_a_r_t_e_d â¢ _I_n_s_t_a_l_l â¢ _E_x_a_m_p_l_e_s â¢
               _I_n_s_i_d_e_ _T_h_u_n_d_e_r â¢ _G_e_t_ _i_n_v_o_l_v_e_d_! â¢ _D_o_c_u_m_e_n_t_a_t_i_o_n
 [![license](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https:
```

### Comparing `lightning-thunder-0.2.0.dev20240407/README.md` & `lightning_thunder-0.2.0.dev20240414/README.md`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/lightning_thunder.egg-info/PKG-INFO` & `lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: lightning-thunder
-Version: 0.2.0.dev20240407
+Version: 0.2.0.dev20240414
 Summary: Lightning Thunder project.
 Home-page: https://github.com/Lightning-AI/lightning-thunder
 Download-URL: https://github.com/Lightning-AI/lightning-thunder
 Author: Lightning-AI et al
 Author-email: community@lightning.ai
 License: Apache 2.0
 Project-URL: Bug Tracker, https://github.com/Lightning-AI/lightning-thunder/issues
@@ -29,14 +29,15 @@
 Requires-Dist: lightning-utilities>=0.7.0
 Requires-Dist: numpy<2,>=1.23.0
 Requires-Dist: igraph>=0.10.4
 Requires-Dist: optree>=0.9.2
 Requires-Dist: opt_einsum>=3.3.0
 Requires-Dist: mpmath<1.4.0
 Provides-Extra: notebooks
+Requires-Dist: cuda-python; extra == "notebooks"
 Requires-Dist: ipython[all]==8.23.0; extra == "notebooks"
 Provides-Extra: test
 Requires-Dist: absl-py; extra == "test"
 Requires-Dist: coverage==7.4.4; extra == "test"
 Requires-Dist: einops; extra == "test"
 Requires-Dist: expecttest==0.2.1; extra == "test"
 Requires-Dist: fdm==0.4.1; extra == "test"
@@ -52,16 +53,16 @@
 Requires-Dist: pytest-timeout==2.2.0; extra == "test"
 Requires-Dist: pytest-timestamper==0.0.10; extra == "test"
 Requires-Dist: pytest-xdist==3.5.0; extra == "test"
 Requires-Dist: pytest==8.1.1; extra == "test"
 Requires-Dist: xlsxwriter; extra == "test"
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240407/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240407/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240414/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240414/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
     <br/>
 <br/>
 
 **Make PyTorch models Lightning fast.**
 
 ______________________________________________________________________
 
@@ -101,27 +102,27 @@
 &#160;
 
 ## Single-GPU performance
 
 Thunder can achieve significant speedups over standard non-compiled PyTorch code ("PyTorch eager"), through the compounding effects of optimizations and the use of best-in-class executors. The figure below shows the pretraining throughput for Llama 2 7B as implemented in [LitGPT](https://github.com/Lightning-AI/litgpt).
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240407/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240414/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
 </div>
 
 As shown in the plot above, Thunder achieves a 40% speedup in training throughput compared to eager code on H100 using a combination of executors including nvFuser, torch.compile, cuDNN, and TransformerEngine FP8.
 
 &#160;
 
 ## Multi-GPU performance
 
 Thunder also supports distributed strategies such as DDP and FSDP for training models on multiple GPUs. The following plot displays the normalized throughput measured for Llama 2 7B without FP8 mixed precision; support for FSDP is in progress.
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240407/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240414/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
 </div>
 
 &#160;
 
 ## Get started
 
 The easiest way to get started with Thunder, requiring no extra installations or setups, is by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240407
+Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240414
 Summary: Lightning Thunder project. Home-page: https://github.com/Lightning-AI/
 lightning-thunder Download-URL: https://github.com/Lightning-AI/lightning-
 thunder Author: Lightning-AI et al Author-email: community@lightning.ai
 License: Apache 2.0 Project-URL: Bug Tracker, https://github.com/Lightning-AI/
 lightning-thunder/issues Project-URL: Documentation, https://lightning-
 thunder.rtfd.io/en/latest/ Project-URL: Source Code, https://github.com/
 Lightning-AI/lightning-thunder Keywords: deep learning,AI Classifier:
@@ -13,29 +13,30 @@
 License :: OSI Approved :: Apache Software License Classifier: Operating System
 :: OS Independent Classifier: Programming Language :: Python :: 3 Classifier:
 Programming Language :: Python :: 3.10 Requires-Python: >=3.10, <3.12
 Description-Content-Type: text/markdown License-File: LICENSE Requires-Dist:
 torch>=2.2.0 Requires-Dist: looseversion==1.3.0 Requires-Dist: lightning-
 utilities>=0.7.0 Requires-Dist: numpy<2,>=1.23.0 Requires-Dist: igraph>=0.10.4
 Requires-Dist: optree>=0.9.2 Requires-Dist: opt_einsum>=3.3.0 Requires-Dist:
-mpmath<1.4.0 Provides-Extra: notebooks Requires-Dist: ipython[all]==8.23.0;
-extra == "notebooks" Provides-Extra: test Requires-Dist: absl-py; extra ==
-"test" Requires-Dist: coverage==7.4.4; extra == "test" Requires-Dist: einops;
-extra == "test" Requires-Dist: expecttest==0.2.1; extra == "test" Requires-
-Dist: fdm==0.4.1; extra == "test" Requires-Dist: graphviz==0.20.1; extra ==
-"test" Requires-Dist: hypothesis==6.100.0; extra == "test" Requires-Dist: jax;
+mpmath<1.4.0 Provides-Extra: notebooks Requires-Dist: cuda-python; extra ==
+"notebooks" Requires-Dist: ipython[all]==8.23.0; extra == "notebooks" Provides-
+Extra: test Requires-Dist: absl-py; extra == "test" Requires-Dist:
+coverage==7.4.4; extra == "test" Requires-Dist: einops; extra == "test"
+Requires-Dist: expecttest==0.2.1; extra == "test" Requires-Dist: fdm==0.4.1;
+extra == "test" Requires-Dist: graphviz==0.20.1; extra == "test" Requires-Dist:
+hypothesis==6.100.0; extra == "test" Requires-Dist: jax; (sys_platform ==
+"linux" or sys_platform == "darwin") and extra == "test" Requires-Dist: jaxlib;
 (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
-Requires-Dist: jaxlib; (sys_platform == "linux" or sys_platform == "darwin")
-and extra == "test" Requires-Dist: jsonargparse; extra == "test" Requires-Dist:
-numpy; extra == "test" Requires-Dist: pandas; extra == "test" Requires-Dist:
-pytest-cov==4.1.0; extra == "test" Requires-Dist: pytest-random-order==1.1.1;
-extra == "test" Requires-Dist: pytest-timeout==2.2.0; extra == "test" Requires-
-Dist: pytest-timestamper==0.0.10; extra == "test" Requires-Dist: pytest-
-xdist==3.5.0; extra == "test" Requires-Dist: pytest==8.1.1; extra == "test"
-Requires-Dist: xlsxwriter; extra == "test"
+Requires-Dist: jsonargparse; extra == "test" Requires-Dist: numpy; extra ==
+"test" Requires-Dist: pandas; extra == "test" Requires-Dist: pytest-cov==4.1.0;
+extra == "test" Requires-Dist: pytest-random-order==1.1.1; extra == "test"
+Requires-Dist: pytest-timeout==2.2.0; extra == "test" Requires-Dist: pytest-
+timestamper==0.0.10; extra == "test" Requires-Dist: pytest-xdist==3.5.0; extra
+== "test" Requires-Dist: pytest==8.1.1; extra == "test" Requires-Dist:
+xlsxwriter; extra == "test"
                               [Thunder][Thunder]
 
                     **Make PyTorch models Lightning fast.**
     ______________________________________________________________________
    _L_i_g_h_t_n_i_n_g_._a_i â¢ _P_e_r_f_o_r_m_a_n_c_e â¢ _G_e_t_ _s_t_a_r_t_e_d â¢ _I_n_s_t_a_l_l â¢ _E_x_a_m_p_l_e_s â¢
               _I_n_s_i_d_e_ _T_h_u_n_d_e_r â¢ _G_e_t_ _i_n_v_o_l_v_e_d_! â¢ _D_o_c_u_m_e_n_t_a_t_i_o_n
 [![license](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https:
```

### Comparing `lightning-thunder-0.2.0.dev20240407/lightning_thunder.egg-info/SOURCES.txt` & `lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/lightning_thunder.egg-info/requires.txt` & `lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/requires.txt`

 * *Files 3% similar despite different names*

```diff
@@ -4,14 +4,15 @@
 numpy<2,>=1.23.0
 igraph>=0.10.4
 optree>=0.9.2
 opt_einsum>=3.3.0
 mpmath<1.4.0
 
 [notebooks]
+cuda-python
 ipython[all]==8.23.0
 
 [test]
 absl-py
 coverage==7.4.4
 einops
 expecttest==0.2.1
```

### Comparing `lightning-thunder-0.2.0.dev20240407/requirements/test.txt` & `lightning_thunder-0.2.0.dev20240414/requirements/test.txt`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/setup.py` & `lightning_thunder-0.2.0.dev20240414/setup.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/__init__.py` & `lightning_thunder-0.2.0.dev20240414/thunder/__init__.py`

 * *Files 4% similar despite different names*

```diff
@@ -8,22 +8,24 @@
 import os
 import dis
 import time
 import warnings
 
 from looseversion import LooseVersion
 
+from thunder.core.interpreter import InterpreterLogItem
 from thunder.core.options import (
     INTERPRETATION_OPTIONS,
     resolve_interpretation_option,
     resolve_sharp_edges_option,
     CACHE_OPTIONS,
     SHARP_EDGES_OPTIONS,
 )
 from thunder.core.trace import (
+    TraceResults,
     TraceCtx,
     from_trace,
     set_tracectx,
     reset_tracectx,
     is_tracing,
 )
 
@@ -54,14 +56,15 @@
     FloatProxy,
     ComplexProxy,
     TupleProxy,
     ListProxy,
     DictProxy,
     AnyProxy,
 )
+from thunder.core.interpreter import print_interpreter_log, print_to_log
 from thunder.core.jit_ext import thunder_general_jit
 from thunder.executors.torch_autograd import split_forward_backward, ThunderFunction
 from thunder.cudagraphs import CUDAGraphExecutor
 
 # NOTE This import is intentionally pytorch so that it thunder.torch doesn't import this
 import torch as pytorch
 
@@ -69,14 +72,15 @@
 
 # Imports executors (to populate default executors and make them accessible)
 import thunder.executors.pythonex
 import thunder.executors.torchex
 import thunder.executors.nvfuserex
 
 pythonex = extend.get_executor("python")
+assert pythonex is not None
 
 
 _PACKAGE_ROOT = os.path.dirname(__file__)
 _PROJECT_ROOT = os.path.dirname(_PACKAGE_ROOT)
 
 # TODO RC1 Review exposed names
 __all__ = [
@@ -140,14 +144,17 @@
 from thunder.clang import *
 
 #
 # Promoted executor-related functions and objects
 #
 
 # TODO Add more of these functions
+resolve_executors = extend.resolve_executors
+add_executor_lists = extend.add_executor_lists
+get_executor = extend.get_executor
 get_all_executors = extend.get_all_executors
 get_default_executors = extend.get_default_executors
 get_always_executors = extend.get_always_executors
 
 sdpa_executor: None | extend.Executor = extend.get_executor("sdpa")
 nvfuser_executor: None | extend.Executor = extend.get_executor("nvfuser")
 pytorch_executor: None | extend.Executor = extend.get_executor("torch")
@@ -167,15 +174,15 @@
 #   the file is modified then the modified version of the program will be compiled and executed, instead.
 from thunder.core.trace import _set_execution_file
 
 set_execution_callback_file = _set_execution_file
 
 
 # Translates the Python function to a thunder program using the thunder interpreter
-def _general_frontend(fn: Callable, args, kwargs, /, *, sharp_edges: SHARP_EDGES_OPTIONS) -> tuple[TraceCtx, TraceCtx]:
+def _general_frontend(fn: Callable, args, kwargs, /, *, sharp_edges: SHARP_EDGES_OPTIONS) -> TraceResults:
     return thunder_general_jit(fn, args, kwargs, sharp_edges=sharp_edges)
 
 
 class ThunderModule(pytorch.nn.Module):
     """A wrapper nn.Module subclass.
 
     This wrapper is returned by ``thunder.jit``, you would typically not
@@ -267,14 +274,27 @@
     return cache_info_wrapper
 
 
 def _get_cache_info():
     return _cache_info_ctx.get()
 
 
+def add_executor_lists(
+    exc_list: None | Sequence[Executor | str], other_exc_list: None | Sequence[Executor | str]
+) -> Sequence[Executor]:
+    new_exc_list = []
+    exc_list = resolve_executors(exc_list)
+    other_exc_list = resolve_executors(other_exc_list)
+    for exc in itertools.chain(exc_list, other_exc_list):
+        if not exc in new_exc_list:
+            new_exc_list.append(exc)
+
+    return new_exc_list
+
+
 @run_once
 def _recursive_jit_call_warning() -> None:
     warnings.warn(
         "Calling a jitted function from a jitted function currently uses all settings from the caller. In the future this behavior may change."
     )
 
 
@@ -297,30 +317,30 @@
 # TODO RC1 Consider adding a debug_log parameter to control debug printing
 # TODO RC1 Consider renaming compile_options to additional_compile_options
 def jit(
     fn: Callable,
     /,
     *,
     langctx: None | str | Any | LanguageContext = None,
-    executors: None | Sequence[Executor] = None,
+    executors: None | Sequence[Executor | str] = None,
     sharp_edges: None | SHARP_EDGES_OPTIONS | str = None,
     interpretation: None | INTERPRETATION_OPTIONS | str = None,
     cache: None | CACHE_OPTIONS | str = None,
     disable_torch_autograd: bool = False,  # TODO Revisit this UX for RC1
     additional_transforms: list | None = None,
     **compile_options,  # TODO RC1 Make this explicit -- dict of options
 ) -> Callable:
     """Just-in-time compile a callable (function or model).
 
     Args:
         fn: A :class:`~torch.nn.Module` or a function to compile.
     Keyword Args:
         langctx: the language context, which language / library to emulate. default: "torch" for PyTorch compatibility.
         executors: list of executors to use. Defaults to the executors returned by `thunder.get_default_executors()` and always amened by `thunder.get_always_executors()`.
-                   You can get a list of all available executors with `thunder.get_all_executors()`.
+                   You can get a list of all available executors with `thunder.get_all_executors()`. You can also pass the name of an executor that's been registered, and it will be resolved with get_executor().
         sharp_edges: sharp edge detection action. What to do when thunder detects a construct that is likely to lead to errors. Can be ``"allow"``, ``"warn"``, ``"error"``. Defaults to ``"allow"``.
         cache: caching mode. default: ``"constant values"```
 
                - ``"no caching"`` - disable caching and always recompute,
                - ``"constant values"`` - require Tensors to be of the same shape, device, dtype etc., and integers and strings to match exactly,
                - ``"same input"`` - don't check, but just assume that a cached function works if it exists.
         interpretation: (deprecated: don't use this, use the thunder.functional.jit entry point to get the functional jit)
@@ -340,21 +360,24 @@
         interpreter = functional._translate_functions_interpreter
     elif interpretation is INTERPRETATION_OPTIONS.TRANSLATE_PYTHON:
         interpreter = _general_frontend
 
     if additional_transforms is None:
         additional_transforms = []
 
+    # Resolve names of executors
+    executors = resolve_executors(executors)
+
     # TODO: verify that tutorials don't have false positives and enable warning by default
     # # Make sharp_edges == warn default if not supplied and if in the general jit
     # if interpretation is INTERPRETATION_OPTIONS.TRANSLATE_PYTHON and sharp_edges is None:
     #     sharp_edges = SHARP_EDGES_OPTIONS.WARN
 
     executor_lookasides = {}
-    for ex in executors or []:
+    for ex in executors:
         # TODO: sharp edge if lookasides are shadowed?
         executor_lookasides.update(ex._lookasides)
 
     # TODO RC1 Refine the compile data option to remove unused options
     cd = CompileData(
         fn=fn,
         langctx=langctx,
@@ -438,15 +461,15 @@
                 cs.last_trace_host_tracing_start = time.time_ns()
                 cs.last_trace_host_tracing_stop = time.time_ns()
 
                 # Updates cache statistics
                 cs.cache_hits += 1
                 cs.last_traces = comp_traces
                 cs.last_interpreted_instructions = None
-                cs.last_interpreted_history = None
+                cs.last_interpreter_log = None
                 cs.last_prologue_traces = pro_traces
                 cs.last_prologue = pro
                 cs.last_prologue_transformation_start = 0
                 cs.last_prologue_transformation_stop = 0
                 cs.last_computation_transformation_start = 0
                 cs.last_computation_transformation_stop = 0
 
@@ -477,15 +500,15 @@
                 cs.last_trace_host_tracing_start = time.time_ns()
                 cs.last_trace_host_tracing_stop = time.time_ns()
 
                 # Updates cache statistics
                 cs.cache_hits += 1
                 cs.last_traces = comp_traces
                 cs.last_interpreted_instructions = None
-                cs.last_interpreted_history = None
+                cs.last_interpreter_log = None
                 cs.last_prologue_traces = pro_traces
                 cs.last_prologue = pro
 
                 return cache_entry, inps, pro_to_epi
 
         cs.cache_misses += 1
         cs.last_trace_cache_stop = time.time_ns()
@@ -497,25 +520,23 @@
             # Acquires the trace OR inlines the trace into an existing trace and
             #   returns the (proxied) result of the operation
             cs.last_trace_tracing_start = time.time_ns()
 
             with langctxs.langctx(cd.langctx):
                 prologue_trc: TraceCtx
                 computation_trc: TraceCtx
-                prologue_trc, computation_trc, *maybe_epilogue = interpreter(
-                    fn, args, kwargs, sharp_edges=cd.sharp_edges
-                )
-
-            if maybe_epilogue:
-                epilogue_traces = maybe_epilogue
-                if epilogue_traces[-1] is not None:
-                    epilogue = epilogue_traces[-1].python_callable()
-                else:
-                    epilogue_traces = None
-                    epilogue = None
+                jit_results: TraceResults = interpreter(fn, args, kwargs, sharp_edges=cd.sharp_edges)
+                prologue_trc = jit_results.prologue_trace
+                computation_trc = jit_results.computation_trace
+                epilogue_trc = jit_results.epilogue_trace
+                last_interpreter_log = jit_results.interpreter_log
+
+            if epilogue_trc is not None:
+                epilogue_traces = [epilogue_trc]
+                epilogue = epilogue_trc.python_callable()
             else:
                 epilogue_traces = None
                 epilogue = None
 
             cs.last_trace_tracing_stop = time.time_ns()
 
             # Makes the prologue callable
@@ -538,14 +559,16 @@
                 pro_to_epi = None
             cs.last_prologue_execution_stop = time.time_ns()
 
             computation_traces = [computation_trc]
             cs.last_traces = computation_traces
             backward_traces = []
             cs.last_backward_traces = backward_traces
+            cs.last_interpreter_log = last_interpreter_log
+            cs.last_interpreted_instructions = (i for i in last_interpreter_log if isinstance(i, dis.Instruction))
 
             computation_trc = dce(computation_trc)
             computation_traces.append(computation_trc)
 
             if is_autocast_enabled:
                 from thunder.core.transforms import autocast
 
@@ -783,36 +806,69 @@
 
 
 def list_transforms(fn) -> list:
     """Returns the list of (explicit) transforms applied to the JITed function."""
     return fn._lc_transforms
 
 
-def last_interpreted_instructions(fn: Callable) -> list[dis.Instruction]:
-    """Returns the list of instructions the interpreter encountered while tracing through the
+def last_interpreter_log(fn: Callable) -> list[InterpreterLogItem]:
+    """Returns the list of instructions and other information the interpreter encountered while tracing through the
     user program (on the last cache miss).
     """
     cs = compile_stats(fn)
     if cs is None:
         raise TypeError(f"{fn} doesn't seem to be a thunder compiled function.")
-    if cs.last_interpreted_instructions is None:
+    if cs.last_interpreter_log is None:
         raise TypeError(f"{fn} doesn't seem to have been called yet.")
-    return cs.last_interpreted_instructions
+    return cs.last_interpreter_log
 
 
-def last_interpreted_history(fn: Callable) -> list[dis.Instruction | str]:
-    """Returns the list of instructions and other information the interpreter encountered while tracing through the
+def last_interpreted_instructions(fn: Callable) -> list[dis.Instruction]:
+    """Returns the list of instructions the interpreter encountered while tracing through the
     user program (on the last cache miss).
     """
     cs = compile_stats(fn)
     if cs is None:
         raise TypeError(f"{fn} doesn't seem to be a thunder compiled function.")
-    if cs.last_interpreted_history is None:
+    if cs.last_interpreted_instructions is None:
         raise TypeError(f"{fn} doesn't seem to have been called yet.")
-    return cs.last_interpreted_history
+    return list(cs.last_interpreted_instructions)
+
+
+def print_last_interpreter_log(
+    fn: Callable,
+    /,
+    print_fn: Callable = print,
+    use_colors: bool = True,
+    indent: bool = True,
+    max_depth: int | None = None,
+    color_internals: bool = False,
+    print_source_code: bool = True,
+) -> None:
+    """Prints a log of the last run of the interpreter for the given function.
+
+    Args:
+        fn: The function returned by `thunder.jit()` to print the last interpreter run log for. The function must have been called at least once first.
+        print_fn: The function to use for printing. Defaults to builtin `print`.
+        use_colors: Whether to use colors in the output. Defaults to `None`, which attempts to autodetect if the terminal supports ANSI color.
+        indent: Whether to indent the output with function scope. Defaults to `True`.
+        max_depth: The maximum indentation depth of the output. Doesn't print log items nested deeper than the max depth. Defaults to `None`, which means no limit.
+        color_internals: Whether to color instructions implicitly interpreted by other instructions. Defaults to `False`, so that only the instructions in the user's code are highlighted in color.
+        print_source_code: Whether to print the source line below each LineLogItem in the log. Defaults to `True`.
+    """
+    log = last_interpreter_log(fn)
+    print_interpreter_log(
+        log,
+        print_fn=print_fn,
+        use_colors=use_colors,
+        indent=indent,
+        max_depth=max_depth,
+        color_internals=color_internals,
+        print_source_code=print_source_code,
+    )
 
 
 def last_compile_options(fn: Callable, /) -> None:
     """Prints how compiled options were used (or not)"""
 
     cd = compile_data(fn)
     cs = compile_stats(fn)
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/benchmarks/__init__.py` & `lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/benchmarks/benchmark_litgpt.py` & `lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/benchmark_litgpt.py`

 * *Files 2% similar despite different names*

```diff
@@ -149,25 +149,23 @@
         # Initialize the model
         t0 = time.perf_counter()
         print(f"Loading model with {self.config.__dict__}")
         self.model = self.init_model()
         print(f"Time to instantiate model: {time.perf_counter() - t0:.02f} seconds.")
 
         # Setup the distributed algorithm choices
-        if self.distributed_mode != "none":
-            self.model = self.setup_distributed()
+        self.model = self.setup_distributed(self.model)
 
         # Initialize the optimizer after the model is sharded if using FSDP
         self.optimizer = configure_optimizers(
             self.model, weight_decay, learning_rate, (beta1, beta2), device_type="cuda"
         )
 
         # Compile the model
-        if self.compile not in ["eager", None]:
-            self.model = self.setup_compile()
+        self.model = self.setup_compile(self.model)
 
         # Setup the Dummy dataloader for training
         self.train_dataloader = self.setup_dummy_dataloader()
         self.train_data_iter = iter(self.train_dataloader)
 
         # Setup empty metrics dict
         if global_rank in [0, None]:
@@ -181,43 +179,46 @@
     def init_model(self):
         init_device = torch.device("meta") if self.distributed_mode == "fsdp" else self.device
         with init_device:
             model = GPT(self.config)
         model.to(dtype=torch.bfloat16)
         return model
 
-    def setup_distributed(self):
+    def setup_distributed(self, model):
+        if self.distributed_mode == "none":
+            return model
+
         # Distributed Setup
         # TODO: Change compiler call names
         if "thunder" in self.compile:
             if self.distributed_mode == "ddp":
                 from thunder.distributed import ddp
 
                 model = ddp(
-                    self.model,
+                    model,
                     broadcast_from=0,
                     bucket_size_in_mb=self.ddp_bucket_size,
                 )
             elif self.distributed_mode == "fsdp":
                 from thunder.distributed import fsdp, FSDPType, FSDPBucketingStrategy
 
                 sharding_strategy = {"zero2": FSDPType.ZERO2, "zero3": FSDPType.ZERO3}[self.shard_mode]
                 bucketing_strategy = {"none": FSDPBucketingStrategy.NONE, "block": FSDPBucketingStrategy.BLOCK}[
                     self.bucketing_mode
                 ]
                 model = fsdp(
-                    self.model,
+                    model,
                     broadcast_from=None,
                     sharding_strategy=sharding_strategy,
                     bucketing_strategy=bucketing_strategy,
                 )
         else:
             if self.distributed_mode == "ddp":
                 model = torch.nn.parallel.DistributedDataParallel(
-                    self.model,
+                    model,
                     device_ids=[local_rank],
                     bucket_cap_mb=self.ddp_bucket_size,
                 )
             elif self.distributed_mode == "fsdp":
                 from torch.distributed.fsdp import FullyShardedDataParallel as FSDP, ShardingStrategy
                 from torch.distributed.fsdp.wrap import transformer_auto_wrap_policy, size_based_auto_wrap_policy
 
@@ -243,55 +244,54 @@
                     "hybrid_zero2": ShardingStrategy._HYBRID_SHARD_ZERO2,
                     "hybrid_zero3": ShardingStrategy.HYBRID_SHARD,
                 }[self.shard_mode]
 
                 # AssertionError: Dynamo only supports FSDP with use_orig_params=True
                 torch.cuda.set_device(local_rank)
                 model = FSDP(
-                    self.model,
+                    model,
                     sharding_strategy=sharding_strategy,
                     auto_wrap_policy=custom_wrap_policy,
                     device_id=local_rank,
                     use_orig_params=True,
                     device_mesh=mesh,
                 )
         return model
 
-    def setup_compile(self):
+    def setup_compile(self, model):
         if self.compile == "inductor":
-            # model = torch.compile(self.model, fullgraph=True, mode="reduce-overhead")
             print("Resetting cache size for torch.compile")
             import torch._dynamo.config as dynamo_config
 
             dynamo_config.cache_size_limit = 64
-            model = torch.compile(self.model)
+            model = torch.compile(model)
         elif "thunder" in self.compile:
-            executors_list = [thunder.nvfuser_executor, thunder.pytorch_executor]
+            executors = [thunder.nvfuser_executor, thunder.pytorch_executor]
             if "inductor" in self.compile:
                 from thunder.executors.torch_compile import torch_compile_executor as torch_compile_ex
 
-                executors_list.insert(0, torch_compile_ex)
+                executors.insert(0, torch_compile_ex)
             if "cudnn" in self.compile:
                 from thunder.executors.cudnnex import cudnn_ex
 
-                executors_list.insert(0, cudnn_ex)
+                executors.insert(0, cudnn_ex)
             else:
                 from thunder.executors.sdpaex import sdpa_ex
 
-                executors_list.insert(0, sdpa_ex)
+                executors.insert(0, sdpa_ex)
 
             if "transformerengine" in self.compile:
                 from thunder.executors.transformer_engineex import transformer_engine_ex
 
-                executors_list.insert(0, transformer_engine_ex)
+                executors.insert(0, transformer_engine_ex)
 
-            model = thunder.jit(self.model, executors=executors_list)
+            model = thunder.jit(model, executors=executors)
 
         elif self.compile != "eager":
-            raise ValueError(compile)
+            raise ValueError(f"Invalid compile option: {self.compile}")
 
         return model
 
     def setup_dummy_dataloader(self):
         def pad_collate(batch):
             x, y = zip(*batch)
             x_padded = torch.nn.utils.rnn.pad_sequence(x, batch_first=True, padding_value=0)
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/benchmarks/distributed.py` & `lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/distributed.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/benchmarks/einsum.py` & `lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/einsum.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/benchmarks/targets.py` & `lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/targets.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/benchmarks/test_benchmark_litgpt.py` & `lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/test_benchmark_litgpt.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/clang/__init__.py` & `lightning_thunder-0.2.0.dev20240414/thunder/clang/__init__.py`

 * *Files 0% similar despite different names*

```diff
@@ -562,15 +562,15 @@
 
     # Resolves ellipses and unsqueezes
     unsqueeze_dims_pre_ellipsis = []
     unsqueeze_dims_post_ellipsis = []
     specified_slices = 0
     ellipsis_idx = None
 
-    if isinstance(key, (Number, slice, EllipsisType)):
+    if key is None or isinstance(key, (Number, slice, EllipsisType)):
         key = (key,)
 
     for idx, x in enumerate(key):
         if x is Ellipsis:
             utils.check(ellipsis_idx is None, lambda: f"Found two (or more) ellipses in key={key}")
             ellipsis_idx = idx
         elif isinstance(x, (Number, slice)):
@@ -1113,14 +1113,19 @@
             broadcast_dims.append(a_idx + dims_idx)
             a_idx += 1
 
     return prims.broadcast_in_dim(a, shape, broadcast_dims)
 
 
 @clangop()
+def unfold(a: TensorProxy, /, dim: int, size: int, step: int) -> TensorProxy:
+    return prims.unfold(a, dim, size, step)
+
+
+@clangop()
 def cat(tensors: list[TensorProxy], dim: int):
     """Concatenates the given sequence of tensors in the given dimension."""
     return prims.cat(tensors, dim)
 
 
 @clangop()
 def stack(tensors: list[TensorProxy], dim: int):
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/clang/langctx.py` & `lightning_thunder-0.2.0.dev20240414/thunder/clang/langctx.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/common.py` & `lightning_thunder-0.2.0.dev20240414/thunder/common.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,8 +1,10 @@
+import dis
 from typing import Any, Optional
+from collections.abc import Generator
 from collections.abc import Callable
 from enum import Enum, auto
 from collections import deque, defaultdict
 from contextlib import contextmanager
 import time
 import warnings
 from collections.abc import Hashable, Sequence
@@ -30,15 +32,15 @@
     reset_tracectx,
 )
 from thunder.core.transform_common import dce, cse
 from thunder.core.proxies import is_proxyable, proxy, Proxy, CollectionProxy, TensorProxy, DDPType, FutureTensorProxy
 import thunder.core.prims as prims
 import thunder.distributed as dist
 import thunder.torch as ltorch
-from thunder.extend import Executor, get_default_executors, get_always_executors, OperatorExecutor
+from thunder.extend import Executor, get_default_executors, get_always_executors, OperatorExecutor, add_executor_lists
 import thunder.executors as executors
 from thunder.executors.torch_autograd import thunder_backward
 from thunder.core.transforms import autocast
 from thunder.core.dtypes import to_dtype
 
 import torch as torch
 import numpy as np
@@ -54,16 +56,16 @@
 class CompileStats:
     def __init__(self):
         # Callables and traces
         self.last_executed = None
         self.last_traces = None
         self.last_prologue = None
         self.last_prologue_traces = None
-        self.last_interpreted_instructions = None
-        self.last_interpreted_history = None
+        self.last_interpreted_instructions: Generator[dis.Instruction, None, None] | None = None
+        self.last_interpreter_log: list[InterpreterLogItem] | None = None
 
         # torch.autograd.Function specific data
         self.last_backward_traces = None
 
         # Timing stats
         self.last_trace_host_start: int = -1
         self.last_trace_host_stop: int = -1
@@ -177,23 +179,18 @@
 
         # Constructs executors list
         # NOTE The executors list is fixed at compile time
         always_executors: tuple[Executor] = get_always_executors()
         if executors_list is None:
             self.executors_list = get_default_executors() + always_executors
         else:
-            # Validates executors list
-            for ex in executors_list:
-                if not isinstance(ex, Executor):
-                    raise ValueError(f"{ex} was not an executor")
-
             self.executors_list = tuple(executors_list)
             # Adds always executors (if not present)
             if self.executors_list[-len(always_executors) :] != always_executors:
-                self.executors_list = self.executors_list + always_executors
+                self.executors_list = add_executor_lists(self.executors_list, always_executors)
 
         # Validates executors list
         for ex in self.executors_list:
             assert isinstance(
                 ex, Executor
             ), f"Expected all elements of the executors list to be executors, but found {ex}"
 
@@ -462,15 +459,15 @@
 #   This can be useful when trace() is called in a context where proxies have already
 #   been constructed.
 # If include_return_statement is True then the trace will terminate with a RETURN operation
 # If include_return_statement is False then the trace will end without an explicit RETURN
 # TODO Consider modeling additional calls to trace()
 # TODO RC1 Change the way this is called to be trace(langctx, inline_trace, rename_proxies...)(fn, *args, **kwargs)
 #   to separate the traced function's args and kwargs from this function's kwargs
-from thunder.core.interpreter import make_opaque
+from thunder.core.interpreter import InterpreterLogItem, make_opaque
 
 
 def trace(
     compile_data: None | CompileData = None,
     inline_trace: bool = True,
     rename_proxies: bool = True,
     include_return_statement: bool = True,
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/baseutils.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/baseutils.py`

 * *Files 0% similar despite different names*

```diff
@@ -461,15 +461,15 @@
 
 
 #
 # Functions related to printing with colors
 #
 
 
-def run_once(f: Callable[[], Any]) -> Callable[[], Any]:
+def run_once(f: Callable) -> Callable:
     """
     Wraps a function with no arguments so that it caches the output and only runs once.
     This is similar to functools.cache, but unlike the standard wrapper does not cache the arguments,
     and provides a strong guarantee that the function will only be run once.
     """
 
     def wrapper(*args, **kwargs):
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/codeutils.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/codeutils.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/compile_data.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/compile_data.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/devices.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/devices.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/dtypes.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/dtypes.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/interpreter.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/interpreter.py`

 * *Files 1% similar despite different names*

```diff
@@ -447,52 +447,46 @@
     tok: Any = set_interpretercompilectx(_interpretercompilectx)
     try:
         yield
     finally:
         reset_interpretercompilectx(tok)
 
 
-class LineHistoryItem(TypedDict):
+class LineLogItem(TypedDict):
     kind: Literal["Line"]
     fn: Callable | CodeType
     filename: str
     position: Positions | None
 
 
-class OpaqueHistoryItem(TypedDict):
+class OpaqueLogItem(TypedDict):
     kind: Literal["Opaque"]
     fn: Callable
 
 
-class LookasideHistoryItem(TypedDict):
+class LookasideLogItem(TypedDict):
     kind: Literal["Lookaside"]
     fn: Callable
 
 
-class CallHistoryItem(TypedDict):
+class CallLogItem(TypedDict):
     kind: Literal["InterpreterCall"]
     fn: Callable
     prev_frame: str
 
 
-class ReturnHistoryItem(TypedDict):
+class ReturnLogItem(TypedDict):
     kind: Literal["InterpreterReturn"]
     fn: Callable
     is_signal: bool
     rval: type | INTERPRETER_SIGNALS
 
 
-InterpreterHistoryItem = (
-    dis.Instruction
-    | str
-    | LineHistoryItem
-    | OpaqueHistoryItem
-    | LookasideHistoryItem
-    | CallHistoryItem
-    | ReturnHistoryItem
+InterpreterLogItem = (
+    dis.Instruction | str | LineLogItem | OpaqueLogItem | LookasideLogItem | CallLogItem | ReturnLogItem
 )
 
 
 # How the Interpreter deals with exceptions:
 # Conceptually, there are two sources of exceptions that we want to distinguish:
 # - Things arising from user code ("User Exceptions").
 # - Things that stem from the interpreter itself ("Interpreter Errors").
@@ -517,15 +511,15 @@
 
 
 # The interpreter's runtime context, which tracks stack changes in Python mode
 class InterpreterRuntimeCtx:
     def __init__(self, *, debug_log: None | StringIO = None):
         self.frame_stack: list[InterpreterFrame] = []
         self._globals_dict: dict[str, Any] | None = None
-        self._history: list[InterpreterHistoryItem] = []
+        self._interpreter_log: list[InterpreterLogItem] = []
         self._interpreted_instructions: list[dis.Instruction] = []
         self._curexc: BaseException | None = None
         # The exception_stack mirrors the exc_info/exc_state from PyThreadState
         # exception_stack is the stack of exceptions currently being handled, we only have exceptions here
         self.exception_stack = [None]
         # ts.exc_info is the top of the stack (self.exception_stack[-1]).
         # Note that most of the time, we are changing the self.exception_stack[-1] instead of popping/pushing exceptions.
@@ -570,22 +564,22 @@
     # The operations encountered while interpreting
     @property
     def interpreted_instructions(self) -> list[dis.Instruction]:
         return self._interpreted_instructions
 
     # The operations and opaque calls encountered while interpreting
     @property
-    def history(self) -> list[InterpreterHistoryItem]:
-        return self._history
+    def interp_log(self) -> list[InterpreterLogItem]:
+        return self._interpreter_log
 
-    def record(self, val: InterpreterHistoryItem, /) -> None:
-        self._history.append(val)
+    def record(self, val: InterpreterLogItem, /) -> None:
+        self._interpreter_log.append(val)
 
         if self.debug_log is not None:
-            self.debug_log.write(f"Appended to history: {val}" + os.linesep)
+            self.debug_log.write(f"Appended to log: {val}" + os.linesep)
 
     def peek_interpreter_stack(self) -> InterpreterStack:
         return self.frame_stack[-1].interpreter_stack
 
     # get current top of stack
     def peek_frame_stack(self) -> InterpreterFrame | None:
         return self.frame_stack[-1] if len(self.frame_stack) != 0 else None
@@ -603,16 +597,16 @@
         self._push_frame_stack(frame)
         try:
             yield
         finally:
             pf = self._pop_frame_stack()
             assert pf is frame, "Frame stack inconsistency"
 
-    # TODO Instead of appending to both history and and interpreted_instructions we could
-    #   consider just appending to history and then filtering to only instructions when
+    # TODO Instead of appending to both the log and and interpreted_instructions we could
+    #   consider just appending to the log and then filtering to only instructions when
     #   interpreted_instructions is accessed
     def record_interpreted_instruction(self, inst: dis.Instruction, /) -> InterpreterRuntimeCtx:
         self._interpreted_instructions.append(inst)
         self.record(inst)
         return self
 
     def record_interpreter_call(self, fn: Callable) -> InterpreterRuntimeCtx:
@@ -636,54 +630,54 @@
                     "prev_frame": self._original_callsite.function,
                 }
             )
         return self
 
     def record_interpreter_return(self, fn: Callable, rval: Any | INTERPRETER_SIGNALS, /) -> InterpreterRuntimeCtx:
         is_signal: bool = isinstance(rval, INTERPRETER_SIGNALS)
-        rv: type | INTERPRETER_SIGNALS = rval if is_signal else type(rval)
-        self.record(ReturnHistoryItem(kind="InterpreterReturn", fn=fn, is_signal=is_signal, rval=rv))
+        rv: type | INTERPRETER_SIGNALS = rval if is_signal else type(unwrap(rval))
+        self.record(ReturnLogItem(kind="InterpreterReturn", fn=fn, is_signal=is_signal, rval=rv))
         return self
 
     def record_opaque_call(self, fn: Callable) -> InterpreterRuntimeCtx:
-        self.record(OpaqueHistoryItem(kind="Opaque", fn=fn))
+        self.record(OpaqueLogItem(kind="Opaque", fn=fn))
         return self
 
     def record_lookaside(self, fn: Callable) -> InterpreterRuntimeCtx:
-        self.record(LookasideHistoryItem(kind="Lookaside", fn=fn))
+        self.record(LookasideLogItem(kind="Lookaside", fn=fn))
         return self
 
     def record_position(
         self, fn: Callable | CodeType, filename: str, position: Positions | None, /
     ) -> InterpreterRuntimeCtx:
         # Only record a change in the Python line
         if filename == self._prev_filename and _positions_equal(position, self._prev_position):
             return self
 
         if position is not None and position.lineno is None:
             position = None
 
         self._prev_position = position
         self._prev_filename = filename
-        line = LineHistoryItem(kind="Line", fn=fn, filename=filename, position=position)
+        line = LineLogItem(kind="Line", fn=fn, filename=filename, position=position)
         self.record(line)
         return self
 
     def format_traceback(self):
         return os.linesep.join(f.format_with_source() for f in self.frame_stack)
 
 
-def print_to_history(*objects, sep=" ", end=os.linesep):
+def print_to_log(*objects, sep=" ", end=os.linesep):
     if sep is None:
         sep = " "
     if end is None:
         end = os.linesep
 
     ctx: InterpreterRuntimeCtx = get_interpreterruntimectx()
-    ctx._history.append(str(sep).join(str(o) for o in objects) + str(end))
+    ctx._interpreter_log.append(str(sep).join(str(o) for o in objects) + str(end))
 
 
 _interpreterruntimectx = contextvars.ContextVar("interpreterruntimectx")
 
 
 # Sets the interpreter ctx
 def set_interpreterruntimectx(ctx) -> Any:
@@ -6656,163 +6650,140 @@
                     wrapped_cell = wrap_binary_subscr(wrapped_closure.value[0], wrapped_closure, 0)
                     assert isinstance(wrapped_closure.item_wrappers, list)
                     wrapped_closure.item_wrappers[0] = wrapped_cell
                     populate_attribute_wrapper(wrapped_cell, "cell_contents", fn_wrapped)
 
                 interpretation_result: Any = _interpret_call(wrapped_fn_2, args, kwargs)
                 interpretation_result = unwrap(interpretation_result)
-            except Exception as e:
+            except BaseException as e:
                 # TODO Highlight the portion of the line that originated the opcode on Python versions that include
                 #      the line offset information in the instruction
                 traceback_str = os.linesep.join(f.format_with_source() for f in runtimectx.frame_stack)
                 msg = (
                     f"Encountered exception {type(e).__name__}: {e} while tracing {fn}:{os.linesep}" f"{traceback_str}"
                 )
                 raise InterpreterError(msg) from e
-            finally:
-                # NOTE: Wrapped functions are valid to assign new attributes to.
-                fn_._last_interpreted_instructions = runtimectx.interpreted_instructions  # type: ignore
-                fn_._last_interpreted_history = runtimectx.history  # type: ignore
-
-            # # NOTE: Wrapped functions are valid to assign new attributes to.
-            # fn_._last_interpreted_instructions = runtimectx.interpreted_instructions  # type: ignore
-            # fn_._last_interpreted_history = runtimectx.history  # type: ignore
+
+            # NOTE: Wrapped functions are valid to assign new attributes to.
+            fn_._last_interpreter_log = runtimectx.interp_log  # type: ignore
 
             if interpretation_result is INTERPRETER_SIGNALS.EXCEPTION_RAISED:
                 e = runtimectx.curexc
                 assert isinstance(e, BaseException), e
                 runtimectx.curexc = None
                 raise e
 
             return interpretation_result
 
     fn_.__thunder_interpreter_orig_fn = fn  # type: ignore
     return fn_
 
 
-def last_interpreted_instructions(fn: Callable) -> None | list[dis.Instruction]:
-    return getattr(fn, "_last_interpreted_instructions", None)
+def last_interpreted_instructions(fn: Callable) -> list[dis.Instruction]:
+    return [i for i in getattr(fn, "_last_interpreter_log", ()) if isinstance(i, dis.Instruction)]
 
 
-def last_interpreted_history(fn: Callable) -> None | list[InterpreterHistoryItem]:
-    return getattr(fn, "_last_interpreted_history", None)
+def last_interpreter_log(fn: Callable) -> list[InterpreterLogItem]:
+    return getattr(fn, "_last_interpreter_log", [])
 
 
-def print_history(
-    history: list[InterpreterHistoryItem],
+def print_interpreter_log(
+    interpreter_log: list[InterpreterLogItem],
     /,
     print_fn: Callable = print,
-    use_colors: bool = True,
+    use_colors: bool | None = None,
     indent: bool = True,
     max_depth: int | None = None,
     color_internals: bool = False,
     print_source_code: bool = True,
 ) -> None:
     colors = init_colors(use_colors)
     interpreter_path = os.path.join("thunder", "core", "interpreter.py")
 
     c_indent = -1
     inside_inner_interpreter = False
-    for item in history:
+    for item in interpreter_log:
         linecolor = ""
         nl = ""
         deindent = False
         source_line = None
 
-        # Match each kind of history item. The history items are instructions, strings,
+        # Match each kind of log item. The log items are instructions, strings,
         # or typed dicts, with "kind" describing what kind of entry it is.
         match item:
             case dis.Instruction():
                 if color_internals or not inside_inner_interpreter:
                     linecolor = colors["MAGENTA"]
-                history_line = f"Instruction('{item.opname}', arg={item.arg}, argrepr={repr(item.argrepr)})"
+                log_line = f"Instruction('{item.opname}', arg={item.arg}, argrepr={repr(item.argrepr)})"
 
             case str():
                 # Print the string as-is, indented, without colors.
                 linecolor = colors["RESET"]
-                history_line = item
+                log_line = item
 
             case {"kind": "Line", "fn": _fn, "filename": filename, "position": position}:
-                # LineHistoryItem
+                # LineLogItem
+                _fn = unwrap(_fn)
                 inside_inner_interpreter = interpreter_path in filename
                 if color_internals or not inside_inner_interpreter:
                     linecolor = colors["YELLOW"]
                 nl = os.linesep
                 fnname = extract_callable_name(_fn)
                 if position:
-                    history_line = f"# Line {filename}:{position.lineno} in {fnname}()"
+                    log_line = f"# Line {filename}:{position.lineno} in {fnname}()"
                 else:
-                    history_line = f"# {filename} in {fnname}()"
+                    log_line = f"# {filename} in {fnname}()"
 
                 if not print_source_code or not position:
                     continue
 
                 first_lineno = position.lineno
                 assert first_lineno
                 linestr = linecache.getline(filename, first_lineno)
                 if linestr.endswith(os.linesep):
                     linestr = linestr[: -len(os.linesep)]
                 source_line = linestr
 
             case {"kind": "InterpreterCall", "fn": fn, "prev_frame": prev_frame}:
-                # CallHistoryItem
+                # CallLogItem
+                fn = unwrap(fn)
                 if color_internals or not inside_inner_interpreter:
                     linecolor = colors["GREEN"]
                 c_indent += 1
-                history_line = f"Interpreting call to {extract_callable_name(fn)}() from {prev_frame}{'()' if not prev_frame.endswith('>') else ''}"
+                log_line = f"Interpreting call to {extract_callable_name(fn)}() from {prev_frame}{'()' if not prev_frame.endswith('>') else ''}"
 
             case {"kind": "InterpreterReturn", "fn": fn, "is_signal": is_signal, "rval": rval}:
-                # ReturnHistoryItem
+                # ReturnLogItem
+                fn = unwrap(fn)
+                rval = unwrap(rval)
                 if color_internals or not inside_inner_interpreter:
                     linecolor = colors["RED"]
                 deindent = True
                 meaning = "signal" if is_signal else "value of type"
                 val = rval if is_signal else rval.__qualname__
-                history_line = f"Returning from call to {extract_callable_name(fn)}() with {meaning} {val}"
+                log_line = f"Returning from call to {extract_callable_name(fn)}() with {meaning} {val}"
 
             case {"kind": "Lookaside", "fn": fn}:
-                # LookasideHistoryItem
+                # LookasideLogItem
+                fn = unwrap(fn)
                 if color_internals or not inside_inner_interpreter:
                     linecolor = colors["BLUE"]
-                history_line = f"Lookaside to {extract_callable_name(fn)}()"
+                log_line = f"Lookaside to {extract_callable_name(fn)}()"
 
             case {"kind": "Opaque", "fn": fn}:
-                # OpaqueHistoryItem
+                # OpaqueLogItem
+                fn = unwrap(fn)
                 if color_internals or not inside_inner_interpreter:
                     linecolor = colors["CYAN"]
-                history_line = f"Opaque call to {fn} with name {extract_callable_name(fn)}"
+                log_line = f"Opaque call to {fn} with name {extract_callable_name(fn)}"
 
             case _:
-                raise NotImplementedError(f"Unexpected history item {item}")
+                raise NotImplementedError(f"Unexpected log item {item}")
 
         if max_depth is None or c_indent <= max_depth:
-            print_fn(f"{nl}{' ' * c_indent if indent else ''}{linecolor}{history_line}{colors['RESET']}")
+            print_fn(f"{nl}{' ' * c_indent if indent else ''}{linecolor}{log_line}{colors['RESET']}")
 
             if source_line:
                 print_fn(f"{' ' * c_indent if indent else ''}{linecolor}{source_line}{colors['RESET']}")
 
         if deindent:
             c_indent -= 1
-
-
-def print_last_interpreted_history(
-    fn: Callable,
-    /,
-    print_fn: Callable = print,
-    use_colors: bool = True,
-    indent: bool = True,
-    max_depth: int | None = None,
-    color_internals: bool = False,
-    print_source_code: bool = True,
-) -> None:
-    if (history := last_interpreted_history(fn)) is None:
-        print("No history could be found.")
-        return
-    print_history(
-        history,
-        print_fn=print_fn,
-        use_colors=use_colors,
-        indent=indent,
-        max_depth=max_depth,
-        color_internals=color_internals,
-        print_source_code=print_source_code,
-    )
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/jit_ext.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/jit_ext.py`

 * *Files 1% similar despite different names*

```diff
@@ -63,14 +63,15 @@
     Variable,
     variableify,
     unvariableify,
     is_proxy_name_available,
 )
 from thunder.core.trace import set_tracectx, reset_tracectx, tracectx, from_trace
 from thunder.core.interpreter import (
+    InterpreterLogItem,
     interpret,
     _interpret_call,
     CapsuleType,
     default_callbacks,
     INTERPRETER_CALLBACKS,
     INTERPRETER_SIGNALS,
     default_opcode_interpreter,
@@ -94,15 +95,15 @@
 import thunder.core.prims as prims
 from thunder.common import transform_for_execution
 from thunder.core.options import CACHE_OPTIONS, SHARP_EDGES_OPTIONS
 from thunder.core.symbol import Symbol, BoundSymbol, is_traceable
 
 from thunder.extend import Executor
 from thunder.common import CompileData, CompileStats
-from thunder.core.trace import TraceCtx
+from thunder.core.trace import TraceCtx, TraceResults
 from thunder.torch import _torch_to_thunder_function_map
 from thunder.clang import _clang_fn_set
 from thunder.core.pytree import tree_map
 from thunder.core.compile_data import compile_data_and_stats
 
 #
 # jit_ext.py implements extensions of thunder's interpreter
@@ -1390,30 +1391,28 @@
         if pg is not None and found_pg is None:
             found_pg = pg
         elif pg is not None and pg != found_pg:
             raise NotImplementedError("jitting modules with different ProcessGroup is not supported currently.")
     return found_pg
 
 
-def thunder_general_jit(
-    fn: Callable, args, kwargs, /, *, sharp_edges: SHARP_EDGES_OPTIONS
-) -> tuple[TraceCtx, TraceCtx]:
+def thunder_general_jit(fn: Callable, args, kwargs, /, *, sharp_edges: SHARP_EDGES_OPTIONS) -> TraceResults:
     # TODO: move into wrap_callback or so
     if isinstance(fn, torch.nn.parallel.DistributedDataParallel):
         raise NotImplementedError(
             f"jitting DistributedDataParallel modules is not supported compile the module and then wrap in DDP"
         )
 
     co: CACHE_OPTIONS = get_cache_option()
     if co not in {CACHE_OPTIONS.CONSTANT_VALUES, CACHE_OPTIONS.NO_CACHING}:
         raise NotImplementedError(f"Only constant constraints is supported")
 
     prologue_trace: TraceCtx = TraceCtx(fn)
     computation_trace: TraceCtx = TraceCtx()
-    epilogue_trace: TraceCtx = TraceCtx()
+    epilogue_trace: TraceCtx | None = TraceCtx()
 
     si = SigInfo("prologue")
     si.varargs = ("args", None)
     si.varkwargs = ("kwargs", None)
     prologue_trace._siginfo = si
 
     compile_data = get_compile_data()
@@ -1437,14 +1436,16 @@
 
     with general_jit_ctx(ctx):
         with tracectx(computation_trace):
             result = jfn(*args, **kwargs)
             prims.python_return(result)
             process_recorded_modifications(ctx, epilogue_trace)
 
+            last_interpreter_log = jfn._last_interpreter_log
+
     pro_to_comp, computation_intermediates = get_computation_inputs_and_intermediates(computation_trace)
 
     epilogue_inputs, _ = get_computation_inputs_and_intermediates(epilogue_trace)
 
     comp_to_epi = []
     pro_to_epi = []
 
@@ -1495,8 +1496,8 @@
 
     # Update epilogue trace by renaming proxies which are passed to the epilogue trace from prologue and computation traces
     if epilogue_trace:
         epilogue_trace = _apply_trace_proxy_rename(
             epilogue_trace, restrict_proxy_swapmap(pro_to_epi_proxies + comp_to_epi_proxies), "epilogue"
         )
 
-    return prologue_trace, computation_trace, epilogue_trace
+    return TraceResults(prologue_trace, computation_trace, epilogue_trace, last_interpreter_log)
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/langctxs.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/langctxs.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/options.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/options.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/patterns.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/patterns.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/prims.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/prims.py`

 * *Files 2% similar despite different names*

```diff
@@ -148,14 +148,15 @@
     BROADCAST_IN_DIM = auto()
     CAT = auto()
     FLIP = auto()
     RESHAPE = auto()
     SLICE = auto()
     SQUEEZE = auto()
     TRANSPOSE = auto()
+    UNFOLD = auto()
     VIEW = auto()
     # Memory layout prims (Experimental)
     STRIDE_ORDER = auto()
     # Elementwise unary prims
     PY_ABS = auto()
     ABS = auto()
     ACOS = auto()
@@ -245,14 +246,15 @@
     EMBEDDING = auto()
     EMBEDDING_BACKWARD = auto()
     LINEAR = auto()
     PAD = auto()
     BATCH_NORM = auto()
     # Memory access methods
     ITEM = auto()
+    COPY_ = auto()
 
 
 class OpTags(Enum):
     # TODO -- Consider renaming this tag
     # The operation manipulates a tensor's shape
     #   These operations may return a view or a new tensor in PyTorch
     #   e.g. slice, squeeze, transpose, view, reshape
@@ -262,14 +264,15 @@
     # Ops that might cause a device sync
     DEVICE_SYNC_OP = auto()
     # Labels operations that should not be removed by the dead code elimination (DCE) pass
     DONT_DCE = auto()
 
 
 # TODO RC1 Document this function and describe the parts of a primitive
+# NOTE: See extend.single_op_executor
 def make_prim(
     id,
     name,
     *,
     meta,
     python_printer=default_python_printer,
     python_impl: None | Callable = None,
@@ -279,15 +282,15 @@
     _print_as_impl: bool = False,
 ):
     sym = Symbol(
         name=name,
         meta=langctx(Languages.PRIMS)(meta),
         id=id,
         is_prim=True,
-        tags=tags,
+        tags=None if tags is None else list(tags),
         python_printer=python_printer,
         python_impl=python_impl,
         _bind_postprocess=_bind_postprocess,
         _print_as_impl=_print_as_impl,
     )
 
     if method_name is not None:
@@ -523,15 +526,15 @@
     meta=_check_literal_like_meta,
     tags=(OpTags.DONT_DCE,),
 )
 
 
 def _check_type_meta(x: Any, typ: type, /) -> None:
     # Validates types
-    baseutils.check(typ, type, lambda: f"Expected a type for check_type, but found {typ}")
+    baseutils.check(isinstance(typ, type), lambda: f"Expected a type for check_type, but found {typ}")
     baseutils.check(pytype(x) is typ, lambda: f"Different types for {pytype(x)} and {typ}")
 
 
 check_type = make_prim(
     PrimIDs.CHECK_TYPE,
     "check_type",
     meta=_check_type_meta,
@@ -3073,14 +3076,34 @@
 
 
 transpose = make_prim(PrimIDs.TRANSPOSE, "transpose", meta=transpose_meta, tags=(OpTags.SHAPE_OP,))
 
 
 view = make_prim(PrimIDs.VIEW, "view", meta=reshape_meta, tags=(OpTags.SHAPE_OP,))
 
+
+def unfold_meta(a: TensorProxy, /, dim: int, size: int, step: int) -> TensorProxy:
+    dim = utils.canonicalize_dim(a.ndim, dim)
+    max_size = 1 if a.ndim == 0 else a.shape[dim]
+
+    utils.check(
+        size <= max_size, lambda: f"Maximum size for tensor at dimension {dim} is {max_size} but size is {size}"
+    )
+    utils.check(size >= 0, lambda: f"Size is {size} but must be >= 0")
+    utils.check(step > 0, lambda: f"Step is {step} but must be > 0")
+
+    shape = list(a.shape)
+    shape.append(size)
+    shape[dim] = (shape[dim] - size) // step + 1
+
+    return TensorProxy(like=a, shape=shape)
+
+
+unfold = make_prim(PrimIDs.UNFOLD, "unfold", meta=unfold_meta, tags=(OpTags.SHAPE_OP,))
+
 #
 # Memory format prims (Experimental)
 #
 
 
 def stride_order_meta(a: TensorProxy, /, order: Sequence[int]) -> TensorProxy:
     # Validates inputs
@@ -3582,7 +3605,22 @@
         TensorProxy(like=a),
         (TensorProxy(like=a, shape=(num_features,)) if running_mean is None else TensorProxy(like=running_mean)),
         (TensorProxy(like=a, shape=(num_features,)) if running_var is None else TensorProxy(like=running_var)),
     )
 
 
 batch_norm = make_prim(PrimIDs.BATCH_NORM, "batch_norm", meta=batch_norm_meta, tags=(OpTags.REDUCTION_OP,))
+
+
+def copy__meta(
+    copy_from: TensorProxy,
+    copy_to: TensorProxy,
+):
+    utils.check_type(copy_from, TensorProxy)
+    utils.check_type(copy_to, TensorProxy)
+    utils.check_same_device(copy_from, copy_to)
+    utils.check_same_shape(copy_from, copy_to)
+    utils.check_same_dtype(copy_from, copy_to)
+    return TensorProxy(like=copy_to)
+
+
+copy_ = make_prim(PrimIDs.COPY_, "copy_", meta=copy__meta, tags=(OpTags.DONT_DCE,))
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/profile.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/profile.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/proxies.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/proxies.py`

 * *Files 0% similar despite different names*

```diff
@@ -388,15 +388,15 @@
 
     def __repr__(self) -> str:
         return f"<StringProxy '{self.value}'>"
 
     def type_string(self) -> str:
         return "str"
 
-    def __hash__(self) -> str:
+    def __hash__(self) -> int:
         return hash(self.value)
 
     def __eq__(self, other):
         if not isinstance(other, str):
             # important: *StringProxies* are isintance str
             return False
         return str(self) == str(other)
@@ -892,15 +892,15 @@
 
     if isinstance(x, (NumberProxy, StringProxy)):
         return x.value
 
     return x
 
 
-def pytype(x: Proxy) -> type:
+def pytype(x: Proxy) -> type | None:
     if isinstance(x, AnyProxy):
         return type(x._o)
 
     if isinstance(x, complex):
         return complex
     if isinstance(x, float):
         return float
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/pytree.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/pytree.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/rematerialization.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/rematerialization.py`

 * *Files 1% similar despite different names*

```diff
@@ -83,15 +83,15 @@
         producer (BoundSymbolInterface): Producer node.
         consumer (BoundSymbolInterface): Consumer node.
 
     Returns:
         Tuple[ProxyInterface, ...]: Consumer's inputs that must be included in
         the input of the consumer.
     """
-    all_produced_vars = tuple(chain.from_iterable((y for y in x.flat_outs) for x in producer.subsymbols))
+    all_produced_vars = tuple(chain.from_iterable((y for y in x.flat_proxy_outs) for x in producer.subsymbols))
     external_consumer_inputs_names = tuple(
         sorted(
             {x.name for x in consumer.args}
             - {x.name for x in producer.output}
             - {x.name for x in producer.args}
             - {x.name for x in all_produced_vars}
         )
@@ -119,15 +119,15 @@
     new_producer_output_names = (
         tuple(x.name if isinstance(x, ProxyInterface) else x for x in external_producer_outputs) + cut_names
     )
     # Remove the producer's inputs from the new producer's output.
     new_producer_output_names = tuple(
         x for x in new_producer_output_names if x not in (y.name for y in producer.flat_args)
     )
-    all_produced_vars = tuple(chain.from_iterable((y for y in x.flat_outs) for x in producer.subsymbols))
+    all_produced_vars = tuple(chain.from_iterable((y for y in x.flat_proxy_outs) for x in producer.subsymbols))
     # Choose the new producer's output from all the produced variables.
     new_producer_output = tuple(x for x in all_produced_vars if x.name in new_producer_output_names)
     new_producer_output = tuple(sorted(new_producer_output, key=lambda x: x.name))
     new_producer = replace(producer, output=new_producer_output)
     return new_producer
 
 
@@ -147,15 +147,15 @@
         BoundSymbolInterface: Updated consumer node.
     """
     # It's a bit more complicated to update the consumer node, we need to
     # update the consumer's input with the cut information.
     # We need to keep consumer's inputs that are not in the cut and are not
     # produced by the producer. We call these inputs "external inputs".
     external_inputs = find_external_consumer_inputs(producer, consumer)
-    all_produced_vars = tuple(chain.from_iterable((y for y in x.flat_outs) for x in producer.subsymbols))
+    all_produced_vars = tuple(chain.from_iterable((y for y in x.flat_proxy_outs) for x in producer.subsymbols))
     cut_names = tuple(map(lambda x: x.name, cut)) if isinstance(cut[0], ProxyInterface) else tuple(cut)
     cut_inputs = tuple(filter(lambda x: x.name in cut_names, (*all_produced_vars, *producer.args)))
     new_consumer_args = cut_inputs + external_inputs
 
     # We need to rematerialize the consumer's inputs that are not in the new consumer's inputs.
     rematerialized_inputs = tuple(
         filter(lambda x: x.name not in map(lambda x: x.name, new_consumer_args), consumer.args)
@@ -338,29 +338,29 @@
         var_name = var.name
         weight = get_weight(var)
         weight = weight / 2.0 if var_name in (x.name for x in producer.args) else weight
         add_edge(var_name + "_in", var_name + "_out", capacity=weight)
         for user in combined_consumers._dict.get(var_name, tuple()):
             if user.sym.id in sym_skip_list:
                 continue
-            for out in user.flat_outs:
+            for out in user.flat_proxy_outs:
                 user_name = out.name
                 add_edge(var_name + "_out", user_name + "_in", capacity=float("inf"))
 
     if not required_producer_vars:
         # If there are no required producer variables, we need to make sure that
         # the source node is added to the graph.
         add_edge("source", "source", capacity=float("inf"))
 
     for var in required_producer_vars:
         add_edge("source", var.name + "_in", capacity=float("inf"))
         add_edges(var)
 
     for symbol in chain(producer.subsymbols, consumer.subsymbols):
-        for var in symbol.flat_outs:
+        for var in symbol.flat_proxy_outs:
             add_edges(var)
 
     g = Graph(
         n=len(name_to_id),
         edges=edges,
         directed=True,
         edge_attrs={"capacity": capacities},
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/symbol.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/symbol.py`

 * *Files 3% similar despite different names*

```diff
@@ -125,15 +125,15 @@
 # TODO Improve annotations
 @dataclass(**baseutils.default_dataclass_params)
 class Symbol:
     name: str
     meta: Callable | None = None
     id: None | Any = None
     is_prim: bool = False
-    tags: None | list[Any] = None
+    tags: None | list[OpTags] = None
     is_fusion: bool = False
     python_printer: Callable = default_python_printer
     _module: None | type | ModuleType = None
     _hash: int | None = None
     executor: None | Any = None
     python_impl: None | Callable = None
     _print_as_impl: bool = False  # If not None, w
@@ -145,15 +145,17 @@
     def __name__(self):
         return self.name
 
     # Relies on the assumption that symbols with the same non-None ids are equal.
     # If both IDs are none, then symbols with the same name and module are equal.
     def __hash__(self) -> int:
         if self._hash is None:
-            object.__setattr__(self, "_hash", hash((self.name, self._module, self.id)))
+            h = hash((self.name, self._module, self.id))
+            object.__setattr__(self, "_hash", h)
+            return h
         return self._hash
 
     # Symbols are equal if they have the same id (if present),
     #   or name and module if id is not present.
     # NOTE This does not check if the two Symbol objects have the same meta, impls,
     #   if they are prims, if they have the same executor, or if they have the same printer, etc.
     # TODO Catch and warn when people construct symbols violating these assumptions
@@ -196,14 +198,15 @@
             result = inspect.getmodule(fn_)
         return result
 
     def __repr__(self) -> str:
         return f"[Symbol name={self.name}]"
 
     def normalize(self, *args, **kwargs):
+        assert self.meta is not None
         si = inspect.signature(self.meta)
         ba = si.bind(*args, **kwargs)
         ba.apply_defaults()
         return ba.args, ba.kwargs
 
     # TODO Remove _call_ctx
     def bind(self, *args, output, subsymbols=(), _call_ctx: None | dict = None, **kwargs) -> BoundSymbol:
@@ -222,31 +225,35 @@
         if self._bind_postprocess:
             self._bind_postprocess(b)
         return b
 
     def __call__(self, *args, **kwargs):
         trace = get_tracectx()
 
-        baseutils.check(
-            trace is not None,
-            lambda: f"Attempting to execute outside of a tracing context, which is not supported",
-            exception_type=NotImplementedError,
-        )
+        if trace is None:
+            raise NotImplementedError(
+                f"Attempting to execute symbol {self.name} outside of a tracing context, which is not supported."
+            )
+
+        if self.meta is None:
+            raise NotImplementedError(
+                f"Symbol {self.name} of executor {self.executor} does not have a meta function defined"
+            )
 
         baseutils.check(not trace._complete, lambda: f"Trying to add {self} to a trace that is complete!")
         result: Any
         subsymbols = []
         if self.is_prim:
             symbols_list = trace.peek_scope()
             # NOTE Operations within primitives are not recorded
             # TODO Revisit this when adding constraints -- meta operations can originate constraints
             if symbols_list is None:
                 return self.meta(*args, **kwargs)
 
-            trace.push_scope(None)
+            trace.push_scope(None)  # BUG: This is wrong, push_scope only accepts lists. What should this be instead?
             result = self.meta(*args, **kwargs)
             trace.pop_scope()
         else:
             trace.push_scope(subsymbols)
             result = self.meta(*args, **kwargs)
             trace.pop_scope()
 
@@ -254,14 +261,15 @@
         symbols_list = trace.peek_scope()
 
         baseutils.check(
             symbols_list is not None,
             lambda: f"A symbol {self} was called while processing a primitive",
             exception_type=AssertionError,
         )
+        assert symbols_list is not None
 
         symbols_list.append(bsym)
         return result
 
 
 # A symbol, arguments (and kwarguments), output, and sub-symbols
 # args is a sequence of the arguments
@@ -400,15 +408,15 @@
 
         subsymbols: list[BoundSymbol]
         if not skip_subsymbols:
             subsymbols = []
             for bsym in self.subsymbols:
                 subsymbols.append(bsym.from_bsym_swap_proxies(swap_map, skip_inputs, skip_output, skip_subsymbols))
         else:
-            subsymbols = self.subsymbols
+            subsymbols = list(self.subsymbols)
 
         return self.from_bsym(args=nargs, kwargs=nkwargs, output=new_output, subsymbols=subsymbols)
 
     # NOTE Making these cached properties relies on the assumption that the inputs to and output of a BoundSymbol
     #   are immutable
 
     @functools.cached_property
@@ -504,45 +512,47 @@
         return (self.sym, self._var_args, self._var_output) == (other.sym, other._var_args, other._var_output)
 
     def rhs(self):
         return BoundSymbolRHS(self)
 
     # TODO Document contexts
     def import_ctx(self):
-        # NOTE This initializes the context
-        self._out_printables, self._arg_printables, self._kwarg_printables
+        # NOTE This initializes the context (Accessing these properties is a function call with the desired side effect)
+        self._out_printables, self._arg_printables, self._kwarg_printables  # type: ignore
         if self.sym is not None and self.sym.python_impl is not None:
             # NOTE BoundSymbols of Symbols with a python_impl defined are run in Python, and are assumed
             #   to not need any imports to run properly, unless _import_prims is True
             if self.sym._print_as_impl:
+                assert self.sym.module is not None  # TODO: Is this a valid assumption?
                 module_name = self.sym.module.__name__
                 import_ctx = {module_name: self.sym.module}
             else:
                 import_ctx = {}
         elif self._call_ctx is not None:
             # NOTE If the call ctx was specified directly, then no import is needed to call the function
             import_ctx = {}
         else:
             # BoundSymbols of Symbols without Python implementations (either because they
             #   have Python implementations or defined call ctxs) are assumed to need
             #   a module import to run properly
+            assert self.sym.module is not None  # TODO: Is this a valid assumption?
             module_name = self.sym.module.__name__
             import_ctx = {module_name: self.sym.module}
 
             # TODO Include the other modules on the path?
             # Also includes the root module of this (potential) submodule
             if "." in module_name:
                 root_name = module_name.split(".")[0]
                 import_ctx[root_name] = sys.modules[root_name]
 
         self._import_ctx.update(import_ctx)
         return self._import_ctx
 
     def object_ctx(self):
-        # NOTE This initializes the context
+        # NOTE This initializes the context (Accessing these properties is a function call with the desired side effect)
         self._out_printables, self._arg_printables, self._kwarg_printables
 
         return self._object_ctx
 
     # def set_output(self, output: Any):
     #     self.output = output
 
@@ -638,15 +648,17 @@
         try:
             return hash((self.parent.sym, self.parent._var_args))
         except:
             return id(self)
 
     def __hash__(self) -> int:
         if not self._hash:
-            object.__setattr__(self, "_hash", self._do_hash())
+            h = self._do_hash()
+            object.__setattr__(self, "_hash", h)
+            return h
         return self._hash
 
     # TODO: Deal with kwargs, in __eq__ and __hash__, just like with BoundSymbol.
     def __eq__(self, other: BoundSymbolRHS) -> bool:
         if not isinstance(other, BoundSymbolRHS):
             return False
         if self.parent is other.parent:
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/trace.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/trace.py`

 * *Files 2% similar despite different names*

```diff
@@ -568,7 +568,20 @@
 # TODO Consider generalizing these to take a file object, too
 def _set_execution_file(path: str) -> None:
     _execution_file.set(path)
 
 
 def _get_execution_file() -> None | str:
     return _execution_file.get()
+
+
+#
+# Container for the two/three types of traces, plus extra tracked data
+#
+
+
+class TraceResults:
+    def __init__(self, prologue: TraceCtx, computation: TraceCtx, epilogue: TraceCtx | None, interpreter_log: list):
+        self.prologue_trace = prologue
+        self.computation_trace: TraceCtx = computation
+        self.epilogue_trace = epilogue
+        self.interpreter_log = interpreter_log
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/transform_common.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/transform_common.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/transforms.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/transforms.py`

 * *Files 1% similar despite different names*

```diff
@@ -971,7800 +971,7819 @@
 00003ca0: 6c65 5f74 6f72 6368 5f61 7574 6f67 7261  le_torch_autogra
 00003cb0: 643d 5472 7565 2c20 2023 2063 642e 6469  d=True,  # cd.di
 00003cc0: 7361 626c 655f 746f 7263 685f 6175 746f  sable_torch_auto
 00003cd0: 6772 6164 5f73 7570 706f 7274 2c0a 2020  grad_support,.  
 00003ce0: 2020 2020 2020 2020 2020 2a2a 6364 2e63            **cd.c
 00003cf0: 6f6d 7069 6c65 5f6f 7074 696f 6e73 2c0a  ompile_options,.
 00003d00: 2020 2020 2020 2020 290a 0a20 2020 2063          )..    c
-00003d10: 7320 3d20 436f 6d70 696c 6553 7461 7473  s = CompileStats
-00003d20: 2829 0a20 2020 2074 7261 6e73 666f 726d  ().    transform
-00003d30: 7320 3d20 6366 6e2e 5f6c 635f 7472 616e  s = cfn._lc_tran
-00003d40: 7366 6f72 6d73 202b 205b 7472 616e 7366  sforms + [transf
-00003d50: 6f72 6d5d 0a20 2020 2070 6f74 7261 6e73  orm].    potrans
-00003d60: 666f 726d 7320 3d20 6366 6e2e 5f6c 635f  forms = cfn._lc_
-00003d70: 706f 7374 5f6f 7074 696d 697a 6174 696f  post_optimizatio
-00003d80: 6e5f 7472 616e 7366 6f72 6d73 0a20 2020  n_transforms.   
-00003d90: 2075 7369 6e67 5f67 7261 645f 7472 616e   using_grad_tran
-00003da0: 7366 6f72 6d20 3d20 6366 6e2e 5f75 7369  sform = cfn._usi
-00003db0: 6e67 5f67 7261 645f 7472 616e 7366 6f72  ng_grad_transfor
-00003dc0: 6d0a 0a20 2020 206e 6366 6e20 3d20 5f63  m..    ncfn = _c
-00003dd0: 7265 6174 655f 6361 6c6c 6162 6c65 280a  reate_callable(.
-00003de0: 2020 2020 2020 2020 6364 2c0a 2020 2020          cd,.    
-00003df0: 2020 2020 6373 2c0a 2020 2020 2020 2020      cs,.        
-00003e00: 7472 616e 7366 6f72 6d73 3d74 7261 6e73  transforms=trans
-00003e10: 666f 726d 732c 0a20 2020 2020 2020 2070  forms,.        p
-00003e20: 6f73 745f 6f70 7469 6d69 7a61 7469 6f6e  ost_optimization
-00003e30: 5f74 7261 6e73 666f 726d 733d 706f 7472  _transforms=potr
-00003e40: 616e 7366 6f72 6d73 2c0a 2020 2020 2020  ansforms,.      
-00003e50: 2020 5f75 7369 6e67 5f67 7261 645f 7472    _using_grad_tr
-00003e60: 616e 7366 6f72 6d3d 7573 696e 675f 6772  ansform=using_gr
-00003e70: 6164 5f74 7261 6e73 666f 726d 2c0a 2020  ad_transform,.  
-00003e80: 2020 290a 2020 2020 7265 7475 726e 206e    ).    return n
-00003e90: 6366 6e0a 0a0a 2320 544f 444f 2043 6f6e  cfn...# TODO Con
-00003ea0: 7369 6465 7220 7265 6661 6374 6f72 696e  sider refactorin
-00003eb0: 6720 7468 6973 2077 6974 6820 7468 6520  g this with the 
-00003ec0: 6162 6f76 650a 2320 4865 6c70 6572 2066  above.# Helper f
-00003ed0: 756e 6374 696f 6e20 746f 2061 6464 2061  unction to add a
-00003ee0: 2070 6f73 742d 6f70 7469 6d69 7a61 7469   post-optimizati
-00003ef0: 6f6e 2074 7261 6e73 666f 726d 0a64 6566  on transform.def
-00003f00: 2061 6464 5f70 6f73 745f 6f70 7469 6d69   add_post_optimi
-00003f10: 7a61 7469 6f6e 5f74 7261 6e73 666f 726d  zation_transform
-00003f20: 2863 666e 3a20 4361 6c6c 6162 6c65 2c20  (cfn: Callable, 
-00003f30: 7472 616e 7366 6f72 6d3a 2043 616c 6c61  transform: Calla
-00003f40: 626c 6529 202d 3e20 4361 6c6c 6162 6c65  ble) -> Callable
-00003f50: 3a0a 2020 2020 6672 6f6d 2074 6875 6e64  :.    from thund
-00003f60: 6572 2e63 6f6d 6d6f 6e20 696d 706f 7274  er.common import
-00003f70: 205f 6372 6561 7465 5f63 616c 6c61 626c   _create_callabl
-00003f80: 652c 2043 6f6d 7069 6c65 4461 7461 2c20  e, CompileData, 
-00003f90: 436f 6d70 696c 6553 7461 7473 0a0a 2020  CompileStats..  
-00003fa0: 2020 6364 3a20 4e6f 6e65 207c 2041 6e79    cd: None | Any
-00003fb0: 203d 2067 6574 6174 7472 2863 666e 2c20   = getattr(cfn, 
-00003fc0: 225f 6c63 5f63 6422 2c20 4e6f 6e65 290a  "_lc_cd", None).
-00003fd0: 0a20 2020 2075 7469 6c73 2e63 6865 636b  .    utils.check
-00003fe0: 2863 6420 6973 206e 6f74 204e 6f6e 652c  (cd is not None,
-00003ff0: 206c 616d 6264 613a 2066 2243 616e 206f   lambda: f"Can o
-00004000: 6e6c 7920 7472 616e 7366 6f72 6d20 636f  nly transform co
-00004010: 6d70 696c 6564 2074 6875 6e64 6572 2066  mpiled thunder f
-00004020: 756e 6374 696f 6e73 2229 0a20 2020 2075  unctions").    u
-00004030: 7469 6c73 2e63 6865 636b 2869 7369 6e73  tils.check(isins
-00004040: 7461 6e63 6528 6364 2c20 436f 6d70 696c  tance(cd, Compil
-00004050: 6544 6174 6129 2c20 6c61 6d62 6461 3a20  eData), lambda: 
-00004060: 6622 466f 756e 6420 616e 2075 6e6b 6e6f  f"Found an unkno
-00004070: 776e 2063 6f6d 7069 6c65 2064 6174 6120  wn compile data 
-00004080: 6174 7472 6962 7574 6520 7b63 647d 2229  attribute {cd}")
-00004090: 0a0a 2020 2020 6373 203d 2043 6f6d 7069  ..    cs = Compi
-000040a0: 6c65 5374 6174 7328 290a 2020 2020 7472  leStats().    tr
-000040b0: 616e 7366 6f72 6d73 203d 2063 666e 2e5f  ansforms = cfn._
-000040c0: 6c63 5f74 7261 6e73 666f 726d 730a 2020  lc_transforms.  
-000040d0: 2020 706f 7472 616e 7366 6f72 6d73 203d    potransforms =
-000040e0: 2063 666e 2e5f 6c63 5f70 6f73 745f 6f70   cfn._lc_post_op
-000040f0: 7469 6d69 7a61 7469 6f6e 5f74 7261 6e73  timization_trans
-00004100: 666f 726d 7320 2b20 5b74 7261 6e73 666f  forms + [transfo
-00004110: 726d 5d0a 0a20 2020 206e 6366 6e20 3d20  rm]..    ncfn = 
-00004120: 5f63 7265 6174 655f 6361 6c6c 6162 6c65  _create_callable
-00004130: 2863 642c 2063 732c 2074 7261 6e73 666f  (cd, cs, transfo
-00004140: 726d 733d 7472 616e 7366 6f72 6d73 2c20  rms=transforms, 
-00004150: 706f 7374 5f6f 7074 696d 697a 6174 696f  post_optimizatio
-00004160: 6e5f 7472 616e 7366 6f72 6d73 3d70 6f74  n_transforms=pot
-00004170: 7261 6e73 666f 726d 7329 0a20 2020 2072  ransforms).    r
-00004180: 6574 7572 6e20 6e63 666e 0a0a 0a23 2054  eturn ncfn...# T
-00004190: 6865 206e 6f2d 6f70 2074 7261 6e73 666f  he no-op transfo
-000041a0: 726d 2e20 4120 7472 6976 6961 6c20 636f  rm. A trivial co
-000041b0: 6d70 6f73 6162 6c65 2074 7261 6e73 666f  mposable transfo
-000041c0: 726d 2c20 6f6e 6c79 2075 7365 6675 6c20  rm, only useful 
-000041d0: 6173 2061 6e20 6578 616d 706c 652e 0a64  as an example..d
-000041e0: 6566 205f 6e6f 6f70 5f74 7261 6e73 666f  ef _noop_transfo
-000041f0: 726d 2874 7261 6365 3a20 5472 6163 652c  rm(trace: Trace,
-00004200: 202a 2a6b 7761 7267 7329 202d 3e20 5472   **kwargs) -> Tr
-00004210: 6163 653a 0a20 2020 2073 7461 7274 5f74  ace:.    start_t
-00004220: 696d 655f 6e73 203d 2074 696d 652e 7469  ime_ns = time.ti
-00004230: 6d65 5f6e 7328 290a 2020 2020 6e6f 6f70  me_ns().    noop
-00004240: 5f74 7261 6365 203d 2066 726f 6d5f 7472  _trace = from_tr
-00004250: 6163 6528 7472 6163 6529 0a0a 2020 2020  ace(trace)..    
-00004260: 7472 6163 6563 7478 5f74 6f6b 3a20 416e  tracectx_tok: An
-00004270: 790a 2020 2020 7472 793a 0a20 2020 2020  y.    try:.     
-00004280: 2020 2074 7261 6365 6374 785f 746f 6b20     tracectx_tok 
-00004290: 3d20 7365 745f 7472 6163 6563 7478 286e  = set_tracectx(n
-000042a0: 6f6f 705f 7472 6163 6529 0a20 2020 2020  oop_trace).     
-000042b0: 2020 2070 7269 6d73 2e63 6f6d 6d65 6e74     prims.comment
-000042c0: 2822 5468 6973 2063 6f6d 6d65 6e74 2061  ("This comment a
-000042d0: 6464 6564 2062 7920 7468 6520 6e6f 2d6f  dded by the no-o
-000042e0: 7020 7472 616e 7366 6f72 6d22 290a 2020  p transform").  
-000042f0: 2020 6669 6e61 6c6c 793a 0a20 2020 2020    finally:.     
-00004300: 2020 2072 6573 6574 5f74 7261 6365 6374     reset_tracect
-00004310: 7828 7472 6163 6563 7478 5f74 6f6b 290a  x(tracectx_tok).
-00004320: 0a20 2020 206e 6f6f 705f 7472 6163 652e  .    noop_trace.
-00004330: 626f 756e 645f 7379 6d62 6f6c 732e 6578  bound_symbols.ex
-00004340: 7465 6e64 2874 7261 6365 2e62 6f75 6e64  tend(trace.bound
-00004350: 5f73 796d 626f 6c73 290a 0a20 2020 2065  _symbols)..    e
-00004360: 6e64 5f74 696d 655f 6e73 203d 2074 696d  nd_time_ns = tim
-00004370: 652e 7469 6d65 5f6e 7328 290a 2020 2020  e.time_ns().    
-00004380: 656c 6170 7365 645f 7469 6d65 5f6e 7320  elapsed_time_ns 
-00004390: 3d20 656e 645f 7469 6d65 5f6e 7320 2d20  = end_time_ns - 
-000043a0: 7374 6172 745f 7469 6d65 5f6e 730a 2020  start_time_ns.  
-000043b0: 2020 656c 6170 7365 645f 7469 6d65 5f6d    elapsed_time_m
-000043c0: 696c 6c69 7320 3d20 656c 6170 7365 645f  illis = elapsed_
-000043d0: 7469 6d65 5f6e 7320 2f2f 2031 3030 3030  time_ns // 10000
-000043e0: 3030 0a20 2020 206e 6f6f 705f 7472 6163  00.    noop_trac
-000043f0: 652e 7365 745f 7072 6f76 656e 616e 6365  e.set_provenance
-00004400: 2854 7261 6365 5072 6f76 656e 616e 6365  (TraceProvenance
-00004410: 2866 224e 6f2d 6f70 2054 7261 6e73 666f  (f"No-op Transfo
-00004420: 726d 2028 746f 6f6b 207b 656c 6170 7365  rm (took {elapse
-00004430: 645f 7469 6d65 5f6d 696c 6c69 737d 206d  d_time_millis} m
-00004440: 696c 6c69 7365 636f 6e64 7329 2229 290a  illiseconds)")).
-00004450: 0a20 2020 2072 6574 7572 6e20 6e6f 6f70  .    return noop
-00004460: 5f74 7261 6365 0a0a 0a64 6566 206e 6f6f  _trace...def noo
-00004470: 7028 6366 6e3a 2043 616c 6c61 626c 6529  p(cfn: Callable)
-00004480: 202d 3e20 4361 6c6c 6162 6c65 3a0a 2020   -> Callable:.  
-00004490: 2020 7265 7475 726e 2061 6464 5f74 7261    return add_tra
-000044a0: 6e73 666f 726d 2863 666e 2c20 5f6e 6f6f  nsform(cfn, _noo
-000044b0: 705f 7472 616e 7366 6f72 6d29 0a0a 0a23  p_transform)...#
-000044c0: 2054 6865 2063 6f6d 6d65 6e74 2066 7573   The comment fus
-000044d0: 696f 6e73 2074 7261 6e73 666f 726d 2e20  ions transform. 
-000044e0: 4a75 7374 2061 6464 7320 6120 636f 6d6d  Just adds a comm
-000044f0: 656e 7420 6265 666f 7265 2061 6e64 2061  ent before and a
-00004500: 6674 6572 2065 6163 6820 6675 7369 6f6e  fter each fusion
-00004510: 2e0a 2320 2020 5468 6973 2069 7320 616e  ..#   This is an
-00004520: 2065 7861 6d70 6c65 206f 6620 6120 706f   example of a po
-00004530: 7374 2d6f 7074 696d 697a 6174 696f 6e20  st-optimization 
-00004540: 7472 616e 7366 6f72 6d2e 0a64 6566 205f  transform..def _
-00004550: 636f 6d6d 656e 745f 6675 7369 6f6e 735f  comment_fusions_
-00004560: 7472 616e 7366 6f72 6d28 7472 6163 653a  transform(trace:
-00004570: 2054 7261 6365 2c20 2a2a 6b77 6172 6773   Trace, **kwargs
-00004580: 2920 2d3e 2054 7261 6365 3a0a 2020 2020  ) -> Trace:.    
-00004590: 7374 6172 745f 7469 6d65 5f6e 7320 3d20  start_time_ns = 
-000045a0: 7469 6d65 2e74 696d 655f 6e73 2829 0a20  time.time_ns(). 
-000045b0: 2020 2063 6f6d 6d65 6e74 6564 5f74 7261     commented_tra
-000045c0: 6365 203d 2066 726f 6d5f 7472 6163 6528  ce = from_trace(
-000045d0: 7472 6163 6529 0a0a 2020 2020 6e62 7379  trace)..    nbsy
-000045e0: 6d73 3a20 6c69 7374 5b42 6f75 6e64 5379  ms: list[BoundSy
-000045f0: 6d62 6f6c 5d20 3d20 5b5d 0a20 2020 2066  mbol] = [].    f
-00004600: 6f72 2062 7379 6d20 696e 2074 7261 6365  or bsym in trace
-00004610: 2e62 6f75 6e64 5f73 796d 626f 6c73 3a0a  .bound_symbols:.
-00004620: 2020 2020 2020 2020 6966 2062 7379 6d2e          if bsym.
-00004630: 7379 6d2e 6973 5f66 7573 696f 6e3a 0a20  sym.is_fusion:. 
-00004640: 2020 2020 2020 2020 2020 2066 7573 696f             fusio
-00004650: 6e5f 6e61 6d65 203d 2062 7379 6d2e 7379  n_name = bsym.sy
-00004660: 6d2e 6e61 6d65 0a20 2020 2020 2020 2020  m.name.         
-00004670: 2020 2070 7265 5f63 6f6d 6d65 6e74 5f62     pre_comment_b
-00004680: 7379 6d20 3d20 7072 696d 732e 636f 6d6d  sym = prims.comm
-00004690: 656e 742e 6269 6e64 2866 2242 6566 6f72  ent.bind(f"Befor
-000046a0: 6520 7b66 7573 696f 6e5f 6e61 6d65 7d22  e {fusion_name}"
-000046b0: 2c20 6f75 7470 7574 3d4e 6f6e 6529 0a20  , output=None). 
-000046c0: 2020 2020 2020 2020 2020 2070 6f73 745f             post_
-000046d0: 636f 6d6d 656e 745f 6273 796d 203d 2070  comment_bsym = p
-000046e0: 7269 6d73 2e63 6f6d 6d65 6e74 2e62 696e  rims.comment.bin
-000046f0: 6428 6622 4166 7465 7220 7b66 7573 696f  d(f"After {fusio
-00004700: 6e5f 6e61 6d65 7d22 2c20 6f75 7470 7574  n_name}", output
-00004710: 3d4e 6f6e 6529 0a0a 2020 2020 2020 2020  =None)..        
-00004720: 2020 2020 6e62 7379 6d73 2e65 7874 656e      nbsyms.exten
-00004730: 6428 5b70 7265 5f63 6f6d 6d65 6e74 5f62  d([pre_comment_b
-00004740: 7379 6d2c 2062 7379 6d2c 2070 6f73 745f  sym, bsym, post_
-00004750: 636f 6d6d 656e 745f 6273 796d 5d29 0a20  comment_bsym]). 
-00004760: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00004770: 2020 2020 2020 2020 206e 6273 796d 732e           nbsyms.
-00004780: 6170 7065 6e64 2862 7379 6d29 0a0a 2020  append(bsym)..  
-00004790: 2020 636f 6d6d 656e 7465 645f 7472 6163    commented_trac
-000047a0: 652e 626f 756e 645f 7379 6d62 6f6c 7320  e.bound_symbols 
-000047b0: 3d20 6e62 7379 6d73 0a20 2020 2065 6e64  = nbsyms.    end
-000047c0: 5f74 696d 655f 6e73 203d 2074 696d 652e  _time_ns = time.
-000047d0: 7469 6d65 5f6e 7328 290a 2020 2020 656c  time_ns().    el
-000047e0: 6170 7365 645f 7469 6d65 5f6e 7320 3d20  apsed_time_ns = 
-000047f0: 656e 645f 7469 6d65 5f6e 7320 2d20 7374  end_time_ns - st
-00004800: 6172 745f 7469 6d65 5f6e 730a 2020 2020  art_time_ns.    
-00004810: 656c 6170 7365 645f 7469 6d65 5f6d 696c  elapsed_time_mil
-00004820: 6c69 7320 3d20 656c 6170 7365 645f 7469  lis = elapsed_ti
-00004830: 6d65 5f6e 7320 2f2f 2031 3030 3030 3030  me_ns // 1000000
-00004840: 0a0a 2020 2020 636f 6d6d 656e 7465 645f  ..    commented_
-00004850: 7472 6163 652e 7365 745f 7072 6f76 656e  trace.set_proven
-00004860: 616e 6365 2854 7261 6365 5072 6f76 656e  ance(TraceProven
-00004870: 616e 6365 2866 2243 6f6d 6d65 6e74 2046  ance(f"Comment F
-00004880: 7573 696f 6e73 2028 746f 6f6b 207b 656c  usions (took {el
-00004890: 6170 7365 645f 7469 6d65 5f6d 696c 6c69  apsed_time_milli
-000048a0: 737d 206d 696c 6c69 7365 636f 6e64 7329  s} milliseconds)
-000048b0: 2229 290a 0a20 2020 2072 6574 7572 6e20  "))..    return 
-000048c0: 636f 6d6d 656e 7465 645f 7472 6163 650a  commented_trace.
-000048d0: 0a0a 6465 6620 636f 6d6d 656e 745f 6675  ..def comment_fu
-000048e0: 7369 6f6e 7328 6366 6e3a 2043 616c 6c61  sions(cfn: Calla
-000048f0: 626c 6529 202d 3e20 4361 6c6c 6162 6c65  ble) -> Callable
-00004900: 3a0a 2020 2020 7265 7475 726e 2061 6464  :.    return add
-00004910: 5f70 6f73 745f 6f70 7469 6d69 7a61 7469  _post_optimizati
-00004920: 6f6e 5f74 7261 6e73 666f 726d 2863 666e  on_transform(cfn
-00004930: 2c20 5f63 6f6d 6d65 6e74 5f66 7573 696f  , _comment_fusio
-00004940: 6e73 5f74 7261 6e73 666f 726d 290a 0a0a  ns_transform)...
-00004950: 230a 2320 4865 6c70 6572 2066 756e 6374  #.# Helper funct
-00004960: 696f 6e73 2066 6f72 2063 6f6d 706f 7361  ions for composa
-00004970: 626c 6520 7472 616e 7366 6f72 6d73 0a23  ble transforms.#
-00004980: 0a0a 0a23 2046 6c61 7474 656e 7320 6120  ...# Flattens a 
-00004990: 6c69 7374 206f 6620 626f 756e 6420 7379  list of bound sy
-000049a0: 6d62 6f6c 732c 2072 6574 7572 6e69 6e67  mbols, returning
-000049b0: 2074 6865 2066 6c61 7474 656e 6564 206c   the flattened l
-000049c0: 6973 740a 6465 6620 666c 6174 7465 6e5f  ist.def flatten_
-000049d0: 666f 725f 7472 616e 7366 6f72 6d28 7368  for_transform(sh
-000049e0: 6f75 6c64 5f66 6c61 7474 656e 3a20 4361  ould_flatten: Ca
-000049f0: 6c6c 6162 6c65 2c20 6273 796d 733a 206c  llable, bsyms: l
-00004a00: 6973 745b 426f 756e 6453 796d 626f 6c5d  ist[BoundSymbol]
-00004a10: 2920 2d3e 206c 6973 745b 426f 756e 6453  ) -> list[BoundS
-00004a20: 796d 626f 6c5d 3a0a 2020 2020 666c 6174  ymbol]:.    flat
-00004a30: 7465 6e65 643a 206c 6973 745b 426f 756e  tened: list[Boun
-00004a40: 6453 796d 626f 6c5d 203d 205b 5d0a 0a20  dSymbol] = [].. 
-00004a50: 2020 2064 6566 205f 666c 6174 7465 6e28     def _flatten(
-00004a60: 6273 796d 3a20 426f 756e 6453 796d 626f  bsym: BoundSymbo
-00004a70: 6c29 3a0a 2020 2020 2020 2020 6966 2073  l):.        if s
-00004a80: 686f 756c 645f 666c 6174 7465 6e28 6273  hould_flatten(bs
-00004a90: 796d 293a 0a20 2020 2020 2020 2020 2020  ym):.           
-00004aa0: 2063 6865 636b 280a 2020 2020 2020 2020   check(.        
-00004ab0: 2020 2020 2020 2020 6c65 6e28 6273 796d          len(bsym
-00004ac0: 2e73 7562 7379 6d62 6f6c 7329 203e 2030  .subsymbols) > 0
-00004ad0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00004ae0: 2020 6c61 6d62 6461 3a20 6622 5472 7969    lambda: f"Tryi
-00004af0: 6e67 2074 6f20 666c 6174 7465 6e20 7b62  ng to flatten {b
-00004b00: 7379 6d7d 2074 6f20 6372 6561 7465 2061  sym} to create a
-00004b10: 2067 7261 6420 666f 726d 756c 612c 2062   grad formula, b
-00004b20: 7574 2069 7420 6861 7320 6e6f 2073 7562  ut it has no sub
-00004b30: 7379 6d62 6f6c 7322 2c0a 2020 2020 2020  symbols",.      
-00004b40: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00004b50: 2020 2020 666f 7220 7362 7379 6d20 696e      for sbsym in
-00004b60: 2062 7379 6d2e 7375 6273 796d 626f 6c73   bsym.subsymbols
-00004b70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00004b80: 2020 5f66 6c61 7474 656e 2873 6273 796d    _flatten(sbsym
-00004b90: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00004ba0: 2020 2020 2020 2020 2020 2020 666c 6174              flat
-00004bb0: 7465 6e65 642e 6170 7065 6e64 2862 7379  tened.append(bsy
-00004bc0: 6d29 0a0a 2020 2020 666f 7220 6273 796d  m)..    for bsym
-00004bd0: 2069 6e20 6273 796d 733a 0a20 2020 2020   in bsyms:.     
-00004be0: 2020 205f 666c 6174 7465 6e28 6273 796d     _flatten(bsym
-00004bf0: 290a 0a20 2020 2072 6574 7572 6e20 666c  )..    return fl
-00004c00: 6174 7465 6e65 640a 0a0a 230a 2320 5068  attened...#.# Ph
-00004c10: 616e 746f 6d20 6772 6164 2074 7261 6e73  antom grad trans
-00004c20: 666f 726d 0a23 0a0a 230a 2320 4675 6e63  form.#..#.# Func
-00004c30: 7469 6f6e 7320 7265 6c61 7465 6420 746f  tions related to
-00004c40: 2066 756e 6374 696f 6e61 6c69 7a69 6e67   functionalizing
-00004c50: 2054 6875 6e64 6572 4f70 7469 6d69 7a65   ThunderOptimize
-00004c60: 644d 6f64 756c 6573 0a23 0a0a 0a23 2054  dModules.#...# T
-00004c70: 4f44 4f20 5465 7374 2077 6974 6820 6275  ODO Test with bu
-00004c80: 6666 6572 730a 6465 6620 706f 7075 6c61  ffers.def popula
-00004c90: 7465 5f67 7261 6473 2867 7261 6473 3a20  te_grads(grads: 
-00004ca0: 6c69 7374 5b54 656e 736f 7250 726f 7879  list[TensorProxy
-00004cb0: 5d2c 2074 6f6d 3a20 4e6f 6e65 207c 2074  ], tom: None | t
-00004cc0: 6f72 6368 2e6e 6e2e 4d6f 6475 6c65 203d  orch.nn.Module =
-00004cd0: 204e 6f6e 652c 2061 7267 733d 4e6f 6e65   None, args=None
-00004ce0: 2c20 6b77 6172 6773 3d4e 6f6e 6529 202d  , kwargs=None) -
-00004cf0: 3e20 4e6f 6e65 3a0a 2020 2020 6964 783a  > None:.    idx:
-00004d00: 2069 6e74 203d 2030 0a20 2020 2066 726f   int = 0.    fro
-00004d10: 6d20 7468 756e 6465 7220 696d 706f 7274  m thunder import
-00004d20: 2054 6875 6e64 6572 4d6f 6475 6c65 2c20   ThunderModule, 
-00004d30: 636f 6d70 696c 655f 6461 7461 0a0a 2020  compile_data..  
-00004d40: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00004d50: 746f 6d2c 2054 6875 6e64 6572 4d6f 6475  tom, ThunderModu
-00004d60: 6c65 2920 6f72 2074 6875 6e64 6572 2e63  le) or thunder.c
-00004d70: 6f6d 7069 6c65 5f64 6174 6128 746f 6d29  ompile_data(tom)
-00004d80: 2e75 7369 6e67 5f6a 6974 3a0a 2020 2020  .using_jit:.    
-00004d90: 2020 2020 6173 7365 7274 2061 7267 7320      assert args 
-00004da0: 6973 206e 6f74 204e 6f6e 652c 2022 706f  is not None, "po
-00004db0: 7075 6c61 7465 2067 7261 6420 6e65 6564  pulate grad need
-00004dc0: 7320 6172 6773 2028 616e 6420 706f 7373  s args (and poss
-00004dd0: 6962 6c79 206b 7761 7267 7329 2074 6f20  ibly kwargs) to 
-00004de0: 776f 726b 2077 6974 6820 5468 756e 6465  work with Thunde
-00004df0: 724d 6f64 756c 6573 220a 2020 2020 2020  rModules".      
-00004e00: 2020 6966 206b 7761 7267 7320 6973 204e    if kwargs is N
-00004e10: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00004e20: 206b 7761 7267 7320 3d20 7b7d 0a20 2020   kwargs = {}.   
-00004e30: 2020 2020 205f 2c20 636f 6d70 7574 6174       _, computat
-00004e40: 696f 6e5f 696e 7075 7473 2c20 5f20 3d20  ion_inputs, _ = 
-00004e50: 636f 6d70 696c 655f 6461 7461 2874 6f6d  compile_data(tom
-00004e60: 292e 6765 745f 636f 6d70 7574 6174 696f  ).get_computatio
-00004e70: 6e5f 616e 645f 696e 7075 7473 282a 6172  n_and_inputs(*ar
-00004e80: 6773 2c20 2a2a 6b77 6172 6773 290a 2020  gs, **kwargs).  
-00004e90: 2020 2020 2020 666f 7220 7020 696e 2063        for p in c
-00004ea0: 6f6d 7075 7461 7469 6f6e 5f69 6e70 7574  omputation_input
-00004eb0: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-00004ec0: 6620 6973 696e 7374 616e 6365 2870 2c20  f isinstance(p, 
-00004ed0: 746f 7263 682e 5465 6e73 6f72 2920 616e  torch.Tensor) an
-00004ee0: 6420 702e 7265 7175 6972 6573 5f67 7261  d p.requires_gra
-00004ef0: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-00004f00: 2020 2023 2053 7570 706f 7274 7320 6772     # Supports gr
-00004f10: 6164 2061 6363 756d 756c 6174 696f 6e20  ad accumulation 
-00004f20: 286c 696b 6520 7768 656e 2077 6569 6768  (like when weigh
-00004f30: 7420 7479 696e 6729 0a20 2020 2020 2020  t tying).       
-00004f40: 2020 2020 2020 2020 2069 6620 702e 6772           if p.gr
-00004f50: 6164 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ad is not None:.
-00004f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004f70: 2020 2020 702e 6772 6164 202b 3d20 6772      p.grad += gr
-00004f80: 6164 735b 6964 785d 0a20 2020 2020 2020  ads[idx].       
-00004f90: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00004fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004fb0: 2020 2070 2e67 7261 6420 3d20 6772 6164     p.grad = grad
-00004fc0: 735b 6964 785d 0a20 2020 2020 2020 2020  s[idx].         
-00004fd0: 2020 2020 2020 2069 6478 202b 3d20 310a         idx += 1.
-00004fe0: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-00004ff0: 2020 2020 2320 5368 6f72 742d 6369 7263      # Short-circ
-00005000: 7569 7473 2069 6620 7468 6572 6520 6172  uits if there ar
-00005010: 6520 6e6f 2061 7267 7320 6f72 206b 7761  e no args or kwa
-00005020: 7267 730a 2020 2020 6966 2061 7267 7320  rgs.    if args 
-00005030: 6973 204e 6f6e 6520 616e 6420 6b77 6172  is None and kwar
-00005040: 6773 2069 7320 4e6f 6e65 3a0a 2020 2020  gs is None:.    
-00005050: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-00005060: 666c 6174 732c 205f 203d 2074 7265 655f  flats, _ = tree_
-00005070: 666c 6174 7465 6e28 2861 7267 732c 206b  flatten((args, k
-00005080: 7761 7267 7329 290a 2020 2020 666f 7220  wargs)).    for 
-00005090: 6620 696e 2066 6c61 7473 3a0a 2020 2020  f in flats:.    
-000050a0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-000050b0: 6528 662c 2074 6f72 6368 2e54 656e 736f  e(f, torch.Tenso
-000050c0: 7229 2061 6e64 2066 2e72 6571 7569 7265  r) and f.require
-000050d0: 735f 6772 6164 3a0a 2020 2020 2020 2020  s_grad:.        
-000050e0: 2020 2020 662e 6772 6164 203d 2067 7261      f.grad = gra
-000050f0: 6473 5b69 6478 5d0a 2020 2020 2020 2020  ds[idx].        
-00005100: 2020 2020 6964 7820 2b3d 2031 0a0a 0a64      idx += 1...d
-00005110: 6566 2065 7874 7261 6374 5f67 7261 6473  ef extract_grads
-00005120: 286d 6f64 756c 653a 2074 6f72 6368 2e6e  (module: torch.n
-00005130: 6e2e 4d6f 6475 6c65 2920 2d3e 2074 7570  n.Module) -> tup
-00005140: 6c65 5b74 6f72 6368 2e54 656e 736f 722c  le[torch.Tensor,
-00005150: 202e 2e2e 5d3a 0a20 2020 2067 7261 6473   ...]:.    grads
-00005160: 203d 2074 7570 6c65 280a 2020 2020 2020   = tuple(.      
-00005170: 2020 662e 6772 6164 0a20 2020 2020 2020    f.grad.       
-00005180: 2066 6f72 2066 2069 6e20 6368 6169 6e28   for f in chain(
-00005190: 6d6f 6475 6c65 2e70 6172 616d 6574 6572  module.parameter
-000051a0: 7328 292c 206d 6f64 756c 652e 6275 6666  s(), module.buff
-000051b0: 6572 7328 2929 0a20 2020 2020 2020 2069  ers()).        i
-000051c0: 6620 6973 696e 7374 616e 6365 2866 2c20  f isinstance(f, 
-000051d0: 746f 7263 682e 5465 6e73 6f72 2920 616e  torch.Tensor) an
-000051e0: 6420 662e 7265 7175 6972 6573 5f67 7261  d f.requires_gra
-000051f0: 6420 616e 6420 662e 6772 6164 2069 7320  d and f.grad is 
-00005200: 6e6f 7420 4e6f 6e65 0a20 2020 2029 0a20  not None.    ). 
-00005210: 2020 2072 6574 7572 6e20 6772 6164 730a     return grads.
-00005220: 0a0a 6465 6620 636c 6561 725f 6772 6164  ..def clear_grad
-00005230: 7328 6d6f 6475 6c65 3a20 746f 7263 682e  s(module: torch.
-00005240: 6e6e 2e4d 6f64 756c 6529 202d 3e20 4e6f  nn.Module) -> No
-00005250: 6e65 3a0a 2020 2020 6966 206e 6f74 2069  ne:.    if not i
-00005260: 7369 6e73 7461 6e63 6528 6d6f 6475 6c65  sinstance(module
-00005270: 2c20 746f 7263 682e 6e6e 2e4d 6f64 756c  , torch.nn.Modul
-00005280: 6529 3a0a 2020 2020 2020 2020 7265 7475  e):.        retu
-00005290: 726e 0a0a 2020 2020 666f 7220 7020 696e  rn..    for p in
-000052a0: 206d 6f64 756c 652e 7061 7261 6d65 7465   module.paramete
-000052b0: 7273 2829 3a0a 2020 2020 2020 2020 702e  rs():.        p.
-000052c0: 6772 6164 203d 204e 6f6e 650a 2020 2020  grad = None.    
-000052d0: 666f 7220 6220 696e 206d 6f64 756c 652e  for b in module.
-000052e0: 6275 6666 6572 7328 293a 0a20 2020 2020  buffers():.     
-000052f0: 2020 2062 2e67 7261 6420 3d20 4e6f 6e65     b.grad = None
-00005300: 0a0a 0a66 726f 6d20 7468 756e 6465 722e  ...from thunder.
-00005310: 636f 7265 2e69 6e74 6572 7072 6574 6572  core.interpreter
-00005320: 2069 6d70 6f72 7420 6d61 6b65 5f6f 7061   import make_opa
-00005330: 7175 650a 6672 6f6d 2074 6875 6e64 6572  que.from thunder
-00005340: 2e63 6f72 652e 6c61 6e67 6374 7873 2069  .core.langctxs i
-00005350: 6d70 6f72 7420 6c61 6e67 6374 782c 204c  mport langctx, L
-00005360: 616e 6775 6167 6573 0a0a 0a23 2054 4f44  anguages...# TOD
-00005370: 4f20 5243 3120 5265 706c 6163 6520 7769  O RC1 Replace wi
-00005380: 7468 206c 616e 6763 7478 0a64 6566 2074  th langctx.def t
-00005390: 6f72 6368 6374 7828 666e 293a 0a20 2020  orchctx(fn):.   
-000053a0: 205f 666e 203d 206c 616e 6763 7478 284c   _fn = langctx(L
-000053b0: 616e 6775 6167 6573 2e54 4f52 4348 2928  anguages.TORCH)(
-000053c0: 666e 290a 2020 2020 7265 7475 726e 206d  fn).    return m
-000053d0: 616b 655f 6f70 6171 7565 285f 666e 290a  ake_opaque(_fn).
-000053e0: 0a0a 5f67 7261 645f 666e 5f6d 6170 3a20  .._grad_fn_map: 
-000053f0: 6469 6374 5b41 6e79 2c20 4361 6c6c 6162  dict[Any, Callab
-00005400: 6c65 5d20 3d20 7b7d 0a0a 0a64 6566 2072  le] = {}...def r
-00005410: 6567 6973 7465 725f 6772 6164 2873 796d  egister_grad(sym
-00005420: 5f6f 725f 6964 3a20 5379 6d62 6f6c 207c  _or_id: Symbol |
-00005430: 2041 6e79 2c20 6772 6164 666e 3a20 4361   Any, gradfn: Ca
-00005440: 6c6c 6162 6c65 2920 2d3e 204e 6f6e 653a  llable) -> None:
-00005450: 0a20 2020 2069 643a 2041 6e79 203d 2073  .    id: Any = s
-00005460: 796d 5f6f 725f 6964 0a20 2020 2069 6620  ym_or_id.    if 
-00005470: 6973 696e 7374 616e 6365 2873 796d 5f6f  isinstance(sym_o
-00005480: 725f 6964 2c20 5379 6d62 6f6c 293a 0a20  r_id, Symbol):. 
-00005490: 2020 2020 2020 2069 6420 3d20 7379 6d5f         id = sym_
-000054a0: 6f72 5f69 642e 6964 0a20 2020 205f 6772  or_id.id.    _gr
-000054b0: 6164 5f66 6e5f 6d61 705b 6964 5d20 3d20  ad_fn_map[id] = 
-000054c0: 6772 6164 666e 0a0a 0a23 2047 7261 6420  gradfn...# Grad 
-000054d0: 6675 6e63 7469 6f6e 7320 666f 7220 7072  functions for pr
-000054e0: 696d 730a 6672 6f6d 2074 6875 6e64 6572  ims.from thunder
-000054f0: 2e63 6f72 652e 7072 696d 7320 696d 706f  .core.prims impo
-00005500: 7274 2050 7269 6d49 4473 2061 7320 7069  rt PrimIDs as pi
-00005510: 6473 2c20 6765 745f 6772 6164 2c20 7075  ds, get_grad, pu
-00005520: 745f 6772 6164 0a0a 0a23 2041 2067 656e  t_grad...# A gen
-00005530: 6572 616c 697a 6174 696f 6e20 6f66 2070  eralization of p
-00005540: 7269 6d73 2e70 7574 5f67 7261 6420 746f  rims.put_grad to
-00005550: 2070 7974 7265 6573 0a23 2054 4f44 4f20   pytrees.# TODO 
-00005560: 436f 6e73 6964 6572 2076 616c 6964 6174  Consider validat
-00005570: 696e 6720 7468 6174 2074 6865 2073 7065  ing that the spe
-00005580: 6373 2061 7265 2074 6865 2073 616d 650a  cs are the same.
-00005590: 2320 544f 444f 2043 6f6e 7369 6465 7220  # TODO Consider 
-000055a0: 7661 6c69 6461 7469 6e67 2074 6861 7420  validating that 
-000055b0: 7468 6174 206f 626a 6563 7420 7265 7175  that object requ
-000055c0: 6972 6573 2067 7261 6420 2861 6e64 2066  ires grad (and f
-000055d0: 696c 7465 7269 6e67 206f 2e77 2e29 0a64  iltering o.w.).d
-000055e0: 6566 2070 7574 5f67 7261 6473 2861 2c20  ef put_grads(a, 
-000055f0: 6729 3a0a 2020 2020 666c 6174 732c 205f  g):.    flats, _
-00005600: 203d 2074 7265 655f 666c 6174 7465 6e28   = tree_flatten(
-00005610: 6129 0a20 2020 2066 6c61 7467 7261 6473  a).    flatgrads
-00005620: 2c20 5f20 3d20 7472 6565 5f66 6c61 7474  , _ = tree_flatt
-00005630: 656e 2867 290a 0a20 2020 2066 6f72 2066  en(g)..    for f
-00005640: 2c20 6667 2069 6e20 7a69 7028 666c 6174  , fg in zip(flat
-00005650: 732c 2066 6c61 7467 7261 6473 293a 0a20  s, flatgrads):. 
-00005660: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-00005670: 616e 6365 2866 2c20 5465 6e73 6f72 5072  ance(f, TensorPr
-00005680: 6f78 7929 2061 6e64 2069 7369 6e73 7461  oxy) and isinsta
-00005690: 6e63 6528 6667 2c20 5465 6e73 6f72 5072  nce(fg, TensorPr
-000056a0: 6f78 7929 3a0a 2020 2020 2020 2020 2020  oxy):.          
-000056b0: 2020 7075 745f 6772 6164 2866 2c20 6667    put_grad(f, fg
-000056c0: 290a 0a0a 230a 2320 556e 7061 636b 696e  )...#.# Unpackin
-000056d0: 6720 6f70 6572 6174 6f72 2067 7261 6473  g operator grads
-000056e0: 0a23 0a0a 2320 4e4f 5445 2070 7269 6d73  .#..# NOTE prims
-000056f0: 2e75 6e70 6163 6b5f 656d 7074 795f 6469  .unpack_empty_di
-00005700: 6374 2063 7265 6174 6573 206e 6f20 6772  ct creates no gr
-00005710: 6164 2061 7373 6f63 6961 7469 6f6e 730a  ad associations.
-00005720: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
-00005730: 6473 2e55 4e50 4143 4b5f 454d 5054 595f  ds.UNPACK_EMPTY_
-00005740: 4449 4354 2c20 7072 696d 732e 756e 7061  DICT, prims.unpa
-00005750: 636b 5f65 6d70 7479 5f64 6963 7429 0a0a  ck_empty_dict)..
-00005760: 2320 4e4f 5445 2070 7269 6d73 2e75 6e70  # NOTE prims.unp
-00005770: 6163 6b5f 6b65 7920 6372 6561 7465 7320  ack_key creates 
-00005780: 6e6f 2067 7261 6420 6173 736f 6369 6174  no grad associat
-00005790: 696f 6e73 0a72 6567 6973 7465 725f 6772  ions.register_gr
-000057a0: 6164 2870 6964 732e 554e 5041 434b 5f4b  ad(pids.UNPACK_K
-000057b0: 4559 2c20 7072 696d 732e 756e 7061 636b  EY, prims.unpack
-000057c0: 5f6b 6579 290a 0a23 204e 4f54 4520 7072  _key)..# NOTE pr
-000057d0: 696d 732e 756e 7061 636b 5f73 6571 7565  ims.unpack_seque
-000057e0: 6e63 6520 6372 6561 7465 7320 6e6f 2067  nce creates no g
-000057f0: 7261 6420 6173 736f 6369 6174 696f 6e73  rad associations
-00005800: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-00005810: 6964 732e 554e 5041 434b 5f53 4551 5545  ids.UNPACK_SEQUE
-00005820: 4e43 452c 2070 7269 6d73 2e75 6e70 6163  NCE, prims.unpac
-00005830: 6b5f 7365 7175 656e 6365 290a 0a0a 230a  k_sequence)...#.
-00005840: 2320 4461 7461 206d 6f76 656d 656e 7420  # Data movement 
-00005850: 616e 6420 7472 616e 7366 6f72 6d61 7469  and transformati
-00005860: 6f6e 206f 7065 7261 746f 7220 6772 6164  on operator grad
-00005870: 730a 230a 4074 6f72 6368 6374 780a 6465  s.#.@torchctx.de
-00005880: 6620 5f63 6f6e 7665 7274 5f65 6c65 6d65  f _convert_eleme
-00005890: 6e74 5f74 7970 655f 7072 696d 5f67 7261  nt_type_prim_gra
-000058a0: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
-000058b0: 6e73 6f72 5072 6f78 792c 2064 7479 7065  nsorProxy, dtype
-000058c0: 3a20 7479 7065 207c 2064 7479 7065 732e  : type | dtypes.
-000058d0: 6474 7970 6529 202d 3e20 4e75 6d62 6572  dtype) -> Number
-000058e0: 207c 2054 656e 736f 7250 726f 7879 3a0a   | TensorProxy:.
-000058f0: 2020 2020 6677 6420 3d20 7072 696d 732e      fwd = prims.
-00005900: 636f 6e76 6572 745f 656c 656d 656e 745f  convert_element_
-00005910: 7479 7065 2861 2c20 6474 7970 6529 0a0a  type(a, dtype)..
-00005920: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
-00005930: 2866 7764 290a 2020 2020 675f 636f 6e76  (fwd).    g_conv
-00005940: 6572 7465 6420 3d20 7072 696d 732e 636f  erted = prims.co
-00005950: 6e76 6572 745f 656c 656d 656e 745f 7479  nvert_element_ty
-00005960: 7065 2867 2c20 6474 7970 6573 2e74 6f5f  pe(g, dtypes.to_
-00005970: 6474 7970 6528 6129 290a 2020 2020 7075  dtype(a)).    pu
-00005980: 745f 6772 6164 2861 2c20 675f 636f 6e76  t_grad(a, g_conv
-00005990: 6572 7465 6429 0a0a 2020 2020 7265 7475  erted)..    retu
-000059a0: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
-000059b0: 725f 6772 6164 2870 6964 732e 434f 4e56  r_grad(pids.CONV
-000059c0: 4552 545f 454c 454d 454e 545f 5459 5045  ERT_ELEMENT_TYPE
-000059d0: 2c20 5f63 6f6e 7665 7274 5f65 6c65 6d65  , _convert_eleme
-000059e0: 6e74 5f74 7970 655f 7072 696d 5f67 7261  nt_type_prim_gra
-000059f0: 6429 0a0a 230a 2320 5465 6e73 6f72 2063  d)..#.# Tensor c
-00005a00: 7265 6174 696f 6e20 6f70 6572 6174 6f72  reation operator
-00005a10: 2067 7261 6473 0a23 0a0a 2320 4e4f 5445   grads.#..# NOTE
-00005a20: 2070 7269 6d73 2e66 756c 6c20 6372 6561   prims.full crea
-00005a30: 7465 7320 6e6f 2067 7261 6420 6173 736f  tes no grad asso
-00005a40: 6369 6174 696f 6e73 0a72 6567 6973 7465  ciations.registe
-00005a50: 725f 6772 6164 2870 6964 732e 4655 4c4c  r_grad(pids.FULL
-00005a60: 2c20 7072 696d 732e 6675 6c6c 290a 0a23  , prims.full)..#
-00005a70: 204e 4f54 4520 7072 696d 732e 696f 7461   NOTE prims.iota
-00005a80: 2063 7265 6174 6573 206e 6f20 6772 6164   creates no grad
-00005a90: 2061 7373 6f63 6961 7469 6f6e 730a 7265   associations.re
-00005aa0: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
-00005ab0: 2e49 4f54 412c 2070 7269 6d73 2e69 6f74  .IOTA, prims.iot
-00005ac0: 6129 0a0a 0a64 6566 205f 756e 6966 6f72  a)...def _unifor
-00005ad0: 6d5f 6772 6164 2873 6861 7065 2c20 6d69  m_grad(shape, mi
-00005ae0: 6e76 616c 2c20 6d61 7876 616c 2c20 2a2c  nval, maxval, *,
-00005af0: 2064 6576 6963 652c 2064 7479 7065 293a   device, dtype):
-00005b00: 0a20 2020 2066 7764 2c20 7361 7665 6420  .    fwd, saved 
-00005b10: 3d20 756e 6966 6f72 6d5f 6175 675f 6677  = uniform_aug_fw
-00005b20: 6428 7368 6170 652c 206d 696e 7661 6c2c  d(shape, minval,
-00005b30: 206d 6178 7661 6c2c 2064 6576 6963 653d   maxval, device=
-00005b40: 6465 7669 6365 2c20 6474 7970 653d 6474  device, dtype=dt
-00005b50: 7970 6529 0a20 2020 2067 203d 2067 6574  ype).    g = get
-00005b60: 5f67 7261 6428 6677 6429 0a20 2020 205f  _grad(fwd).    _
-00005b70: 2c20 676d 696e 7661 6c2c 2067 6d61 7876  , gminval, gmaxv
-00005b80: 616c 203d 2075 6e69 666f 726d 5f62 6163  al = uniform_bac
-00005b90: 6b77 6172 6428 2a73 6176 6564 2c20 6729  kward(*saved, g)
-00005ba0: 0a20 2020 2070 7574 5f67 7261 6473 2828  .    put_grads((
-00005bb0: 6d69 6e76 616c 2c20 6d61 7876 616c 292c  minval, maxval),
-00005bc0: 2028 676d 696e 7661 6c2c 2067 6d61 7876   (gminval, gmaxv
-00005bd0: 616c 2929 0a20 2020 2072 6574 7572 6e20  al)).    return 
-00005be0: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
-00005bf0: 7261 6428 7069 6473 2e55 4e49 464f 524d  rad(pids.UNIFORM
-00005c00: 2c20 5f75 6e69 666f 726d 5f67 7261 6429  , _uniform_grad)
-00005c10: 0a0a 230a 2320 5265 7368 6170 696e 6720  ..#.# Reshaping 
-00005c20: 616e 6420 7065 726d 7574 696e 6720 6f70  and permuting op
-00005c30: 6572 6174 6f72 2067 7261 6473 0a23 0a0a  erator grads.#..
-00005c40: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
-00005c50: 6272 6f61 6463 6173 745f 696e 5f64 696d  broadcast_in_dim
-00005c60: 5f70 7269 6d5f 6772 6164 280a 2020 2020  _prim_grad(.    
-00005c70: 613a 2054 656e 736f 7250 726f 7879 2c20  a: TensorProxy, 
-00005c80: 7368 6170 653a 2053 6571 7565 6e63 655b  shape: Sequence[
-00005c90: 696e 745d 2c20 6272 6f61 6463 6173 745f  int], broadcast_
-00005ca0: 6469 6d65 6e73 696f 6e73 3a20 5365 7175  dimensions: Sequ
-00005cb0: 656e 6365 5b69 6e74 5d0a 2920 2d3e 2054  ence[int].) -> T
-00005cc0: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-00005cd0: 6677 6420 3d20 7072 696d 732e 6272 6f61  fwd = prims.broa
-00005ce0: 6463 6173 745f 696e 5f64 696d 2861 2c20  dcast_in_dim(a, 
-00005cf0: 7368 6170 652c 2062 726f 6164 6361 7374  shape, broadcast
-00005d00: 5f64 696d 656e 7369 6f6e 7329 0a0a 2020  _dimensions)..  
-00005d10: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
-00005d20: 7764 290a 0a20 2020 2075 6e69 745f 6469  wd)..    unit_di
-00005d30: 6d73 203d 2074 7570 6c65 2869 2066 6f72  ms = tuple(i for
-00005d40: 2069 2c20 7320 696e 2065 6e75 6d65 7261   i, s in enumera
-00005d50: 7465 2861 2e73 6861 7065 2920 6966 2073  te(a.shape) if s
-00005d60: 203d 3d20 3129 0a20 2020 2062 6361 7374   == 1).    bcast
-00005d70: 5f64 696d 7320 3d20 7475 706c 6528 6220  _dims = tuple(b 
-00005d80: 666f 7220 692c 2062 2069 6e20 656e 756d  for i, b in enum
-00005d90: 6572 6174 6528 6272 6f61 6463 6173 745f  erate(broadcast_
-00005da0: 6469 6d65 6e73 696f 6e73 2920 6966 2069  dimensions) if i
-00005db0: 206e 6f74 2069 6e20 756e 6974 5f64 696d   not in unit_dim
-00005dc0: 7329 0a20 2020 2072 6564 7563 655f 6469  s).    reduce_di
-00005dd0: 6d73 203d 2074 7570 6c65 2873 2066 6f72  ms = tuple(s for
-00005de0: 2069 2c20 7320 696e 2065 6e75 6d65 7261   i, s in enumera
-00005df0: 7465 2872 616e 6765 286c 656e 2873 6861  te(range(len(sha
-00005e00: 7065 2929 2920 6966 2069 206e 6f74 2069  pe))) if i not i
-00005e10: 6e20 6263 6173 745f 6469 6d73 290a 0a20  n bcast_dims).. 
-00005e20: 2020 2067 203d 206c 746f 7263 682e 7375     g = ltorch.su
-00005e30: 6d28 672c 2072 6564 7563 655f 6469 6d73  m(g, reduce_dims
-00005e40: 290a 0a20 2020 2023 204e 4f54 4520 5468  )..    # NOTE Th
-00005e50: 6973 206d 7573 7420 6265 2063 6c61 6e67  is must be clang
-00005e60: 2e75 6e73 7175 6565 7a65 2062 6563 6175  .unsqueeze becau
-00005e70: 7365 2074 6f72 6368 2e75 6e73 7175 6565  se torch.unsquee
-00005e80: 7a65 2c20 756e 6c69 6b65 2063 6c61 6e67  ze, unlike clang
-00005e90: 2e75 6e73 7175 6565 7a65 2c20 6f6e 6c79  .unsqueeze, only
-00005ea0: 2061 6363 6570 7473 2061 6e20 696e 7465   accepts an inte
-00005eb0: 6765 720a 2020 2020 2320 2020 2870 7574  ger.    #   (put
-00005ec0: 2061 6e6f 7468 6572 2077 6179 2c20 746f   another way, to
-00005ed0: 7263 6820 6f6e 6c79 2061 6c6c 6f77 7320  rch only allows 
-00005ee0: 6f6e 6520 756e 7371 7565 657a 6520 6174  one unsqueeze at
-00005ef0: 2061 2074 696d 6529 0a20 2020 2067 203d   a time).    g =
-00005f00: 2063 6c61 6e67 2e75 6e73 7175 6565 7a65   clang.unsqueeze
-00005f10: 2867 2c20 756e 6974 5f64 696d 7329 0a0a  (g, unit_dims)..
-00005f20: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
-00005f30: 6729 0a0a 2020 2020 7265 7475 726e 2066  g)..    return f
-00005f40: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
-00005f50: 6164 2870 6964 732e 4252 4f41 4443 4153  ad(pids.BROADCAS
-00005f60: 545f 494e 5f44 494d 2c20 5f62 726f 6164  T_IN_DIM, _broad
-00005f70: 6361 7374 5f69 6e5f 6469 6d5f 7072 696d  cast_in_dim_prim
-00005f80: 5f67 7261 6429 0a0a 0a40 746f 7263 6863  _grad)...@torchc
-00005f90: 7478 0a64 6566 205f 6361 745f 7072 696d  tx.def _cat_prim
-00005fa0: 5f67 7261 6428 7465 6e73 6f72 733a 206c  _grad(tensors: l
-00005fb0: 6973 745b 5465 6e73 6f72 5072 6f78 795d  ist[TensorProxy]
-00005fc0: 2c20 2f2c 2064 696d 3a20 696e 7429 202d  , /, dim: int) -
-00005fd0: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
-00005fe0: 2020 2066 7764 203d 2070 7269 6d73 2e63     fwd = prims.c
-00005ff0: 6174 2874 656e 736f 7273 2c20 6469 6d29  at(tensors, dim)
-00006000: 0a0a 2020 2020 6720 3d20 6765 745f 6772  ..    g = get_gr
-00006010: 6164 2866 7764 290a 0a20 2020 2073 6c69  ad(fwd)..    sli
-00006020: 6365 5f73 7461 7274 3a20 696e 7420 3d20  ce_start: int = 
-00006030: 300a 2020 2020 743a 2054 656e 736f 7250  0.    t: TensorP
-00006040: 726f 7879 0a20 2020 2066 6f72 2074 2069  roxy.    for t i
-00006050: 6e20 7465 6e73 6f72 733a 0a20 2020 2020  n tensors:.     
-00006060: 2020 2064 696d 5f6c 656e 3a20 696e 7420     dim_len: int 
-00006070: 3d20 742e 7368 6170 655b 6469 6d5d 0a20  = t.shape[dim]. 
-00006080: 2020 2020 2020 2073 6c69 6365 5f65 6e64         slice_end
-00006090: 3a20 696e 7420 3d20 736c 6963 655f 7374  : int = slice_st
-000060a0: 6172 7420 2b20 6469 6d5f 6c65 6e0a 2020  art + dim_len.  
-000060b0: 2020 2020 2020 675f 736c 6963 653a 2054        g_slice: T
-000060c0: 656e 736f 7250 726f 7879 203d 2063 6c61  ensorProxy = cla
-000060d0: 6e67 2e73 6c69 6365 5f69 6e5f 6469 6d28  ng.slice_in_dim(
-000060e0: 672c 2073 6c69 6365 5f73 7461 7274 2c20  g, slice_start, 
-000060f0: 736c 6963 655f 656e 642c 2064 696d 3d64  slice_end, dim=d
-00006100: 696d 290a 2020 2020 2020 2020 736c 6963  im).        slic
-00006110: 655f 7374 6172 7420 3d20 736c 6963 655f  e_start = slice_
-00006120: 656e 640a 2020 2020 2020 2020 7075 745f  end.        put_
-00006130: 6772 6164 2874 2c20 675f 736c 6963 6529  grad(t, g_slice)
-00006140: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
-00006150: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
-00006160: 2870 6964 732e 4341 542c 205f 6361 745f  (pids.CAT, _cat_
-00006170: 7072 696d 5f67 7261 6429 0a0a 0a64 6566  prim_grad)...def
-00006180: 205f 7265 7368 6170 655f 7072 696d 5f67   _reshape_prim_g
-00006190: 7261 6428 613a 2054 656e 736f 7250 726f  rad(a: TensorPro
-000061a0: 7879 2c20 7368 6170 653a 2074 7570 6c65  xy, shape: tuple
-000061b0: 5b69 6e74 2c20 2e2e 2e5d 2920 2d3e 2054  [int, ...]) -> T
-000061c0: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-000061d0: 6677 6420 3d20 7072 696d 732e 7265 7368  fwd = prims.resh
-000061e0: 6170 6528 612c 2073 6861 7065 290a 0a20  ape(a, shape).. 
-000061f0: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
-00006200: 6677 6429 0a0a 2020 2020 615f 6772 6164  fwd)..    a_grad
-00006210: 203d 2070 7269 6d73 2e72 6573 6861 7065   = prims.reshape
-00006220: 2867 2c20 612e 7368 6170 6529 0a20 2020  (g, a.shape).   
-00006230: 2070 7574 5f67 7261 6428 612c 2061 5f67   put_grad(a, a_g
-00006240: 7261 6429 0a0a 2020 2020 7265 7475 726e  rad)..    return
-00006250: 2066 7764 0a0a 0a72 6567 6973 7465 725f   fwd...register_
-00006260: 6772 6164 2870 6964 732e 5245 5348 4150  grad(pids.RESHAP
-00006270: 452c 205f 7265 7368 6170 655f 7072 696d  E, _reshape_prim
-00006280: 5f67 7261 6429 0a0a 0a40 746f 7263 6863  _grad)...@torchc
-00006290: 7478 0a64 6566 205f 736c 6963 655f 7072  tx.def _slice_pr
-000062a0: 696d 5f67 7261 6428 0a20 2020 2061 3a20  im_grad(.    a: 
-000062b0: 5465 6e73 6f72 5072 6f78 792c 2073 7461  TensorProxy, sta
-000062c0: 7274 5f69 6e64 6963 6573 3a20 5365 7175  rt_indices: Sequ
-000062d0: 656e 6365 5b69 6e74 5d2c 2065 6e64 5f69  ence[int], end_i
-000062e0: 6e64 6963 6573 3a20 5365 7175 656e 6365  ndices: Sequence
-000062f0: 5b69 6e74 5d2c 2073 7472 6964 6573 3a20  [int], strides: 
-00006300: 4e6f 6e65 207c 2053 6571 7565 6e63 655b  None | Sequence[
-00006310: 696e 745d 203d 204e 6f6e 650a 2920 2d3e  int] = None.) ->
-00006320: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
-00006330: 2020 6677 6420 3d20 7072 696d 732e 736c    fwd = prims.sl
-00006340: 6963 655f 7072 696d 2861 2c20 7374 6172  ice_prim(a, star
-00006350: 745f 696e 6469 6365 732c 2065 6e64 5f69  t_indices, end_i
-00006360: 6e64 6963 6573 2c20 7374 7269 6465 7329  ndices, strides)
-00006370: 0a0a 2020 2020 6720 3d20 6765 745f 6772  ..    g = get_gr
-00006380: 6164 2866 7764 290a 0a20 2020 2070 6164  ad(fwd)..    pad
-00006390: 6469 6e67 203d 204e 6f6e 650a 2020 2020  ding = None.    
-000063a0: 6966 2073 7472 6964 6573 2069 7320 4e6f  if strides is No
-000063b0: 6e65 206f 7220 6e70 2e61 6c6c 286e 702e  ne or np.all(np.
-000063c0: 6571 7561 6c28 7374 7269 6465 732c 2031  equal(strides, 1
-000063d0: 2929 3a0a 2020 2020 2020 2020 7061 6464  )):.        padd
-000063e0: 696e 6720 3d20 7475 706c 6528 7a69 7028  ing = tuple(zip(
-000063f0: 7374 6172 745f 696e 6469 6365 732c 206e  start_indices, n
-00006400: 702e 7375 6274 7261 6374 2861 2e73 6861  p.subtract(a.sha
-00006410: 7065 2c20 656e 645f 696e 6469 6365 7329  pe, end_indices)
-00006420: 2c20 2830 2c29 202a 206c 656e 2873 7461  , (0,) * len(sta
-00006430: 7274 5f69 6e64 6963 6573 2929 290a 2020  rt_indices))).  
-00006440: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00006450: 7265 616c 5f6c 696d 6974 7320 3d20 6e70  real_limits = np
-00006460: 2e61 6464 280a 2020 2020 2020 2020 2020  .add(.          
-00006470: 2020 7374 6172 745f 696e 6469 6365 732c    start_indices,
-00006480: 0a20 2020 2020 2020 2020 2020 206e 702e  .            np.
-00006490: 7768 6572 6528 6e70 2e65 7175 616c 2867  where(np.equal(g
-000064a0: 2e73 6861 7065 2c20 3029 2c20 302c 206e  .shape, 0), 0, n
-000064b0: 702e 6164 6428 312c 206e 702e 6d75 6c74  p.add(1, np.mult
-000064c0: 6970 6c79 286e 702e 7375 6274 7261 6374  iply(np.subtract
-000064d0: 2867 2e73 6861 7065 2c20 3129 2c20 7374  (g.shape, 1), st
-000064e0: 7269 6465 7329 2929 2c0a 2020 2020 2020  rides))),.      
-000064f0: 2020 290a 2020 2020 2020 2020 7061 6464    ).        padd
-00006500: 696e 6720 3d20 7475 706c 6528 7a69 7028  ing = tuple(zip(
-00006510: 7374 6172 745f 696e 6469 6365 732c 206e  start_indices, n
-00006520: 702e 7375 6274 7261 6374 2861 2e73 6861  p.subtract(a.sha
-00006530: 7065 2c20 7265 616c 5f6c 696d 6974 7329  pe, real_limits)
-00006540: 2c20 6e70 2e73 7562 7472 6163 7428 7374  , np.subtract(st
-00006550: 7269 6465 732c 2031 2929 290a 0a20 2020  rides, 1)))..   
-00006560: 2023 2043 6f6e 7665 7274 7320 4e75 6d50   # Converts NumP
-00006570: 7920 6e75 6d62 6572 7320 746f 2050 7974  y numbers to Pyt
-00006580: 686f 6e20 696e 7473 0a20 2020 2023 2054  hon ints.    # T
-00006590: 4f44 4f20 5368 6f75 6c64 2077 6520 7375  ODO Should we su
-000065a0: 7070 6f72 7420 4e75 6d50 7920 6e75 6d62  pport NumPy numb
-000065b0: 6572 7320 6265 7474 6572 3f0a 2020 2020  ers better?.    
-000065c0: 7061 6464 696e 6720 3d20 7472 6565 5f6d  padding = tree_m
-000065d0: 6170 2869 6e74 2c20 7061 6464 696e 6729  ap(int, padding)
-000065e0: 0a20 2020 2061 5f67 7261 6420 3d20 7072  .    a_grad = pr
-000065f0: 696d 732e 7061 6428 672c 2063 6f6e 7374  ims.pad(g, const
-00006600: 5f61 7328 302c 2067 2e64 7479 7065 292c  _as(0, g.dtype),
-00006610: 2070 6164 6469 6e67 290a 2020 2020 7075   padding).    pu
-00006620: 745f 6772 6164 2861 2c20 615f 6772 6164  t_grad(a, a_grad
-00006630: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
-00006640: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
-00006650: 6428 7069 6473 2e53 4c49 4345 2c20 5f73  d(pids.SLICE, _s
-00006660: 6c69 6365 5f70 7269 6d5f 6772 6164 290a  lice_prim_grad).
-00006670: 0a0a 4074 6f72 6368 6374 780a 6465 6620  ..@torchctx.def 
-00006680: 5f73 7175 6565 7a65 5f70 7269 6d5f 6772  _squeeze_prim_gr
-00006690: 6164 2861 3a20 5465 6e73 6f72 5072 6f78  ad(a: TensorProx
-000066a0: 792c 202f 2c20 6469 6d73 3a20 7475 706c  y, /, dims: tupl
-000066b0: 655b 696e 742c 202e 2e2e 5d29 202d 3e20  e[int, ...]) -> 
-000066c0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-000066d0: 2066 7764 203d 2070 7269 6d73 2e73 7175   fwd = prims.squ
-000066e0: 6565 7a65 2861 2c20 7475 706c 6528 6469  eeze(a, tuple(di
-000066f0: 6d73 2929 0a0a 2020 2020 6720 3d20 6765  ms))..    g = ge
-00006700: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
-00006710: 2320 4e4f 5445 2054 6869 7320 6361 6c6c  # NOTE This call
-00006720: 7320 636c 616e 672e 756e 7371 7565 657a  s clang.unsqueez
-00006730: 652c 2061 6e64 206e 6f74 2074 6f72 6368  e, and not torch
-00006740: 2e75 6e73 7175 6565 7a65 2c20 6265 6361  .unsqueeze, beca
-00006750: 7573 6520 746f 7263 682e 756e 7371 7565  use torch.unsque
-00006760: 657a 6520 6f6e 6c79 2073 7570 706f 7274  eze only support
-00006770: 730a 2020 2020 2320 2020 756e 7371 7565  s.    #   unsque
-00006780: 657a 696e 6720 6120 7369 6e67 6c65 2064  ezing a single d
-00006790: 696d 656e 7369 6f6e 0a20 2020 2061 5f67  imension.    a_g
-000067a0: 7261 6420 3d20 636c 616e 672e 756e 7371  rad = clang.unsq
-000067b0: 7565 657a 6528 672c 2064 696d 7329 0a20  ueeze(g, dims). 
-000067c0: 2020 2070 7574 5f67 7261 6428 612c 2061     put_grad(a, a
-000067d0: 5f67 7261 6429 0a0a 2020 2020 7265 7475  _grad)..    retu
-000067e0: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
-000067f0: 725f 6772 6164 2870 6964 732e 5351 5545  r_grad(pids.SQUE
-00006800: 455a 452c 205f 7371 7565 657a 655f 7072  EZE, _squeeze_pr
-00006810: 696d 5f67 7261 6429 0a0a 0a40 746f 7263  im_grad)...@torc
-00006820: 6863 7478 0a64 6566 205f 7461 6b65 5f70  hctx.def _take_p
-00006830: 7269 6d5f 6772 6164 2861 3a20 5465 6e73  rim_grad(a: Tens
-00006840: 6f72 5072 6f78 792c 2069 6e64 6578 3a20  orProxy, index: 
-00006850: 5465 6e73 6f72 5072 6f78 792c 2064 696d  TensorProxy, dim
-00006860: 3a20 696e 7429 202d 3e20 5465 6e73 6f72  : int) -> Tensor
-00006870: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
-00006880: 2070 7269 6d73 2e74 616b 6528 612c 2069   prims.take(a, i
-00006890: 6e64 6578 2c20 6469 6d29 0a0a 2020 2020  ndex, dim)..    
-000068a0: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
-000068b0: 290a 0a20 2020 2023 2054 4f44 4f20 5377  )..    # TODO Sw
-000068c0: 6974 6368 2074 6f20 6c74 6f72 6368 2e69  itch to ltorch.i
-000068d0: 6e64 6578 5f61 6464 3f0a 2020 2020 2320  ndex_add?.    # 
-000068e0: 4e4f 5445 2049 6e74 656e 7469 6f6e 616c  NOTE Intentional
-000068f0: 6c79 206e 6f74 2063 616c 6c69 6e67 207a  ly not calling z
-00006900: 6572 6f73 5f6c 696b 6520 746f 2061 766f  eros_like to avo
-00006910: 6964 2070 7265 7365 7276 696e 6720 610a  id preserving a.
-00006920: 2020 2020 2320 544f 444f 2055 7064 6174      # TODO Updat
-00006930: 6520 746f 2063 616c 6c20 6c74 6f72 6368  e to call ltorch
-00006940: 2e7a 6572 6f73 0a20 2020 207a 6572 6f73  .zeros.    zeros
-00006950: 203d 2070 7269 6d73 2e66 756c 6c28 612e   = prims.full(a.
-00006960: 7368 6170 652c 2066 696c 6c5f 7661 6c75  shape, fill_valu
-00006970: 653d 302c 2064 6576 6963 653d 612e 6465  e=0, device=a.de
-00006980: 7669 6365 2c20 6474 7970 653d 612e 6474  vice, dtype=a.dt
-00006990: 7970 6529 0a20 2020 2061 5f67 7261 6420  ype).    a_grad 
-000069a0: 3d20 7072 696d 732e 696e 6465 785f 6164  = prims.index_ad
-000069b0: 6428 7a65 726f 732c 2069 6e64 6578 2c20  d(zeros, index, 
-000069c0: 672c 2064 696d 290a 2020 2020 7075 745f  g, dim).    put_
-000069d0: 6772 6164 2861 2c20 615f 6772 6164 290a  grad(a, a_grad).
-000069e0: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
-000069f0: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
-00006a00: 7069 6473 2e54 414b 452c 205f 7461 6b65  pids.TAKE, _take
-00006a10: 5f70 7269 6d5f 6772 6164 290a 0a0a 4074  _prim_grad)...@t
-00006a20: 6f72 6368 6374 780a 6465 6620 5f74 616b  orchctx.def _tak
-00006a30: 655f 616c 6f6e 675f 6178 6973 5f70 7269  e_along_axis_pri
-00006a40: 6d5f 6772 6164 2861 3a20 5465 6e73 6f72  m_grad(a: Tensor
-00006a50: 5072 6f78 792c 2069 6e64 6578 3a20 5465  Proxy, index: Te
-00006a60: 6e73 6f72 5072 6f78 792c 2064 696d 3a20  nsorProxy, dim: 
-00006a70: 696e 7429 202d 3e20 5465 6e73 6f72 5072  int) -> TensorPr
-00006a80: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
-00006a90: 7269 6d73 2e74 616b 655f 616c 6f6e 675f  rims.take_along_
-00006aa0: 6178 6973 2861 2c20 696e 6465 782c 2064  axis(a, index, d
-00006ab0: 696d 290a 0a20 2020 2067 203d 2067 6574  im)..    g = get
-00006ac0: 5f67 7261 6428 6677 6429 0a20 2020 2023  _grad(fwd).    #
-00006ad0: 204e 4f54 4520 496e 7465 6e74 696f 6e61   NOTE Intentiona
-00006ae0: 6c6c 7920 6e6f 7420 6361 6c6c 696e 6720  lly not calling 
-00006af0: 7a65 726f 735f 6c69 6b65 2074 6f20 6176  zeros_like to av
-00006b00: 6f69 6420 7072 6573 6572 7669 6e67 2061  oid preserving a
-00006b10: 0a20 2020 2023 2054 4f44 4f20 5570 6461  .    # TODO Upda
-00006b20: 7465 2074 6f20 6361 6c6c 206c 746f 7263  te to call ltorc
-00006b30: 682e 7a65 726f 730a 2020 2020 7a65 726f  h.zeros.    zero
-00006b40: 7320 3d20 7072 696d 732e 6675 6c6c 2861  s = prims.full(a
-00006b50: 2e73 6861 7065 2c20 6669 6c6c 5f76 616c  .shape, fill_val
-00006b60: 7565 3d30 2c20 6465 7669 6365 3d61 2e64  ue=0, device=a.d
-00006b70: 6576 6963 652c 2064 7479 7065 3d61 2e64  evice, dtype=a.d
-00006b80: 7479 7065 290a 2020 2020 615f 6772 6164  type).    a_grad
-00006b90: 203d 2070 7269 6d73 2e73 6361 7474 6572   = prims.scatter
-00006ba0: 5f61 6464 287a 6572 6f73 2c20 696e 6465  _add(zeros, inde
-00006bb0: 782c 2067 2c20 6469 6d29 0a20 2020 2070  x, g, dim).    p
-00006bc0: 7574 5f67 7261 6428 612c 2061 5f67 7261  ut_grad(a, a_gra
-00006bd0: 6429 0a0a 2020 2020 7265 7475 726e 2066  d)..    return f
-00006be0: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
-00006bf0: 6164 2870 6964 732e 5441 4b45 5f41 4c4f  ad(pids.TAKE_ALO
-00006c00: 4e47 5f41 5849 532c 205f 7461 6b65 5f61  NG_AXIS, _take_a
-00006c10: 6c6f 6e67 5f61 7869 735f 7072 696d 5f67  long_axis_prim_g
-00006c20: 7261 6429 0a0a 0a40 746f 7263 6863 7478  rad)...@torchctx
-00006c30: 0a64 6566 205f 7472 616e 7370 6f73 655f  .def _transpose_
-00006c40: 7072 696d 5f67 7261 6428 613a 2054 656e  prim_grad(a: Ten
-00006c50: 736f 7250 726f 7879 2c20 7065 726d 7574  sorProxy, permut
-00006c60: 6174 696f 6e3a 2074 7570 6c65 5b69 6e74  ation: tuple[int
-00006c70: 2c20 2e2e 2e5d 2920 2d3e 2054 656e 736f  , ...]) -> Tenso
-00006c80: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
-00006c90: 3d20 7072 696d 732e 7472 616e 7370 6f73  = prims.transpos
-00006ca0: 6528 612c 2074 7570 6c65 2870 6572 6d75  e(a, tuple(permu
-00006cb0: 7461 7469 6f6e 2929 0a0a 2020 2020 6720  tation))..    g 
-00006cc0: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
-00006cd0: 2020 2020 756e 646f 203d 205f 6172 6773      undo = _args
-00006ce0: 6f72 7428 7065 726d 7574 6174 696f 6e29  ort(permutation)
-00006cf0: 0a20 2020 2061 5f67 7261 6420 3d20 7072  .    a_grad = pr
-00006d00: 696d 732e 7472 616e 7370 6f73 6528 672c  ims.transpose(g,
-00006d10: 2074 7570 6c65 2875 6e64 6f29 290a 2020   tuple(undo)).  
-00006d20: 2020 7075 745f 6772 6164 2861 2c20 615f    put_grad(a, a_
-00006d30: 6772 6164 290a 0a20 2020 2072 6574 7572  grad)..    retur
-00006d40: 6e20 6677 640a 0a0a 7265 6769 7374 6572  n fwd...register
-00006d50: 5f67 7261 6428 7069 6473 2e54 5241 4e53  _grad(pids.TRANS
-00006d60: 504f 5345 2c20 5f74 7261 6e73 706f 7365  POSE, _transpose
-00006d70: 5f70 7269 6d5f 6772 6164 290a 0a23 0a23  _prim_grad)..#.#
-00006d80: 204d 656d 6f72 7920 6c61 796f 7574 206f   Memory layout o
-00006d90: 7065 7261 746f 7220 6772 6164 730a 230a  perator grads.#.
-00006da0: 0a0a 4074 6f72 6368 6374 780a 6465 6620  ..@torchctx.def 
-00006db0: 5f73 7472 6964 655f 6f72 6465 725f 7072  _stride_order_pr
-00006dc0: 696d 5f67 7261 6428 613a 2054 656e 736f  im_grad(a: Tenso
-00006dd0: 7250 726f 7879 2c20 2f2c 206f 7264 6572  rProxy, /, order
-00006de0: 3a20 5365 7175 656e 6365 5b69 6e74 5d29  : Sequence[int])
-00006df0: 202d 3e20 5465 6e73 6f72 5072 6f78 793a   -> TensorProxy:
-00006e00: 0a20 2020 2066 7764 203d 2070 7269 6d73  .    fwd = prims
-00006e10: 2e73 7472 6964 655f 6f72 6465 7228 612c  .stride_order(a,
-00006e20: 206f 7264 6572 290a 0a20 2020 2067 203d   order)..    g =
-00006e30: 2067 6574 5f67 7261 6428 6677 6429 0a20   get_grad(fwd). 
-00006e40: 2020 2070 7574 5f67 7261 6428 612c 2067     put_grad(a, g
-00006e50: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
-00006e60: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
-00006e70: 6428 7069 6473 2e53 5452 4944 455f 4f52  d(pids.STRIDE_OR
-00006e80: 4445 522c 205f 7374 7269 6465 5f6f 7264  DER, _stride_ord
-00006e90: 6572 5f70 7269 6d5f 6772 6164 290a 0a0a  er_prim_grad)...
-00006ea0: 230a 2320 456c 656d 656e 7477 6973 6520  #.# Elementwise 
-00006eb0: 756e 6172 7920 6f70 6572 6174 6f72 2067  unary operator g
-00006ec0: 7261 6473 0a23 0a40 746f 7263 6863 7478  rads.#.@torchctx
-00006ed0: 0a64 6566 205f 6162 735f 7072 696d 5f67  .def _abs_prim_g
-00006ee0: 7261 6428 613a 204e 756d 6265 7220 7c20  rad(a: Number | 
-00006ef0: 5465 6e73 6f72 5072 6f78 7929 202d 3e20  TensorProxy) -> 
-00006f00: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
-00006f10: 726f 7879 3a0a 2020 2020 6677 6420 3d20  roxy:.    fwd = 
-00006f20: 7072 696d 732e 6162 7328 6129 0a0a 2020  prims.abs(a)..  
-00006f30: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
-00006f40: 7764 290a 2020 2020 7075 745f 6772 6164  wd).    put_grad
-00006f50: 2861 2c20 6720 2a20 6c74 6f72 6368 2e73  (a, g * ltorch.s
-00006f60: 6967 6e28 6129 290a 0a20 2020 2072 6574  ign(a))..    ret
-00006f70: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
-00006f80: 6572 5f67 7261 6428 7069 6473 2e41 4253  er_grad(pids.ABS
-00006f90: 2c20 5f61 6273 5f70 7269 6d5f 6772 6164  , _abs_prim_grad
-00006fa0: 290a 0a0a 6465 6620 5f63 6f73 5f70 7269  )...def _cos_pri
-00006fb0: 6d5f 6772 6164 2861 3a20 4e75 6d62 6572  m_grad(a: Number
-00006fc0: 207c 2054 656e 736f 7250 726f 7879 2920   | TensorProxy) 
-00006fd0: 2d3e 204e 756d 6265 7220 7c20 5465 6e73  -> Number | Tens
-00006fe0: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
-00006ff0: 203d 2070 7269 6d73 2e63 6f73 2861 290a   = prims.cos(a).
-00007000: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
-00007010: 6428 6677 6429 0a20 2020 2070 7574 5f67  d(fwd).    put_g
-00007020: 7261 6428 612c 2067 202a 2028 2d70 7269  rad(a, g * (-pri
-00007030: 6d73 2e73 696e 2861 2929 290a 0a20 2020  ms.sin(a)))..   
-00007040: 2072 6574 7572 6e20 6677 640a 0a0a 7265   return fwd...re
-00007050: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
-00007060: 2e43 4f53 2c20 5f63 6f73 5f70 7269 6d5f  .COS, _cos_prim_
-00007070: 6772 6164 290a 0a0a 4074 6f72 6368 6374  grad)...@torchct
-00007080: 780a 6465 6620 5f65 7266 5f70 7269 6d5f  x.def _erf_prim_
-00007090: 6772 6164 2861 3a20 4e75 6d62 6572 207c  grad(a: Number |
-000070a0: 2054 656e 736f 7250 726f 7879 2920 2d3e   TensorProxy) ->
-000070b0: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
-000070c0: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
-000070d0: 2070 7269 6d73 2e65 7266 2861 290a 0a20   prims.erf(a).. 
-000070e0: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
-000070f0: 6677 6429 0a20 2020 2061 5f67 7261 6420  fwd).    a_grad 
-00007100: 3d20 3220 2f20 6d61 7468 2e73 7172 7428  = 2 / math.sqrt(
-00007110: 6d61 7468 2e70 6929 202a 206c 746f 7263  math.pi) * ltorc
-00007120: 682e 6578 7028 2d28 612a 2a32 2929 202a  h.exp(-(a**2)) *
-00007130: 2067 0a20 2020 2070 7574 5f67 7261 6428   g.    put_grad(
-00007140: 612c 2061 5f67 7261 6429 0a0a 2020 2020  a, a_grad)..    
-00007150: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
-00007160: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
-00007170: 4552 462c 205f 6572 665f 7072 696d 5f67  ERF, _erf_prim_g
-00007180: 7261 6429 0a0a 0a40 746f 7263 6863 7478  rad)...@torchctx
-00007190: 0a64 6566 205f 6578 705f 7072 696d 5f67  .def _exp_prim_g
-000071a0: 7261 6428 613a 204e 756d 6265 7220 7c20  rad(a: Number | 
-000071b0: 5465 6e73 6f72 5072 6f78 7929 202d 3e20  TensorProxy) -> 
-000071c0: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
-000071d0: 726f 7879 3a0a 2020 2020 6677 6420 3d20  roxy:.    fwd = 
-000071e0: 7072 696d 732e 6578 7028 6129 0a0a 2020  prims.exp(a)..  
-000071f0: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
-00007200: 7764 290a 2020 2020 615f 6772 6164 203d  wd).    a_grad =
-00007210: 2067 202a 2066 7764 0a20 2020 2070 7574   g * fwd.    put
-00007220: 5f67 7261 6428 612c 2061 5f67 7261 6429  _grad(a, a_grad)
-00007230: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
-00007240: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
-00007250: 2870 6964 732e 4558 502c 205f 6578 705f  (pids.EXP, _exp_
-00007260: 7072 696d 5f67 7261 6429 0a0a 0a40 746f  prim_grad)...@to
-00007270: 7263 6863 7478 0a64 6566 205f 6c6f 675f  rchctx.def _log_
-00007280: 7072 696d 5f67 7261 6428 613a 204e 756d  prim_grad(a: Num
-00007290: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-000072a0: 7929 202d 3e20 4e75 6d62 6572 207c 2054  y) -> Number | T
-000072b0: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-000072c0: 6677 6420 3d20 7072 696d 732e 6c6f 6728  fwd = prims.log(
-000072d0: 6129 0a0a 2020 2020 6720 3d20 6765 745f  a)..    g = get_
-000072e0: 6772 6164 2866 7764 290a 2020 2020 615f  grad(fwd).    a_
-000072f0: 6772 6164 203d 2067 202f 2061 0a20 2020  grad = g / a.   
-00007300: 2070 7574 5f67 7261 6428 612c 2061 5f67   put_grad(a, a_g
-00007310: 7261 6429 0a0a 2020 2020 7265 7475 726e  rad)..    return
-00007320: 2066 7764 0a0a 0a72 6567 6973 7465 725f   fwd...register_
-00007330: 6772 6164 2870 6964 732e 4c4f 472c 205f  grad(pids.LOG, _
-00007340: 6c6f 675f 7072 696d 5f67 7261 6429 0a0a  log_prim_grad)..
-00007350: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
-00007360: 6e65 675f 7072 696d 5f67 7261 6428 613a  neg_prim_grad(a:
-00007370: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
-00007380: 5072 6f78 7929 202d 3e20 4e75 6d62 6572  Proxy) -> Number
-00007390: 207c 2054 656e 736f 7250 726f 7879 3a0a   | TensorProxy:.
-000073a0: 2020 2020 6677 6420 3d20 7072 696d 732e      fwd = prims.
-000073b0: 6e65 6728 6129 0a0a 2020 2020 6720 3d20  neg(a)..    g = 
-000073c0: 6765 745f 6772 6164 2866 7764 290a 2020  get_grad(fwd).  
-000073d0: 2020 7075 745f 6772 6164 2861 2c20 2d67    put_grad(a, -g
-000073e0: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
-000073f0: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
-00007400: 6428 7069 6473 2e4e 4547 2c20 5f6e 6567  d(pids.NEG, _neg
-00007410: 5f70 7269 6d5f 6772 6164 290a 0a0a 4074  _prim_grad)...@t
-00007420: 6f72 6368 6374 780a 6465 6620 5f72 7371  orchctx.def _rsq
-00007430: 7274 5f70 7269 6d5f 6772 6164 2861 3a20  rt_prim_grad(a: 
-00007440: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
-00007450: 726f 7879 2c20 2f29 202d 3e20 4e75 6d62  roxy, /) -> Numb
-00007460: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-00007470: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
-00007480: 732e 7273 7172 7428 6129 0a0a 2020 2020  s.rsqrt(a)..    
-00007490: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
-000074a0: 290a 2020 2020 2320 416e 2061 6c74 6572  ).    # An alter
-000074b0: 6e61 7469 7665 2064 6572 6976 6174 696f  native derivatio
-000074c0: 6e20 7573 6564 2062 7920 4a41 5820 6973  n used by JAX is
-000074d0: 202d 302e 3520 2a20 6720 2a20 7273 7172   -0.5 * g * rsqr
-000074e0: 7428 7829 202f 2078 0a20 2020 2023 2077  t(x) / x.    # w
-000074f0: 6865 7265 2072 7371 7274 2878 2920 616e  here rsqrt(x) an
-00007500: 6420 7820 6172 6520 7361 7665 6420 666f  d x are saved fo
-00007510: 7220 7468 6520 6261 636b 7761 7264 7320  r the backwards 
-00007520: 7061 7373 2e0a 2020 2020 2320 5468 6973  pass..    # This
-00007530: 2064 6572 6976 6174 696f 6e20 7761 7320   derivation was 
-00007540: 7365 6c65 6374 6564 2062 6563 6175 7365  selected because
-00007550: 2069 7420 6176 6f69 6473 2073 6176 696e   it avoids savin
-00007560: 6720 7468 6520 696e 7075 7420 7465 6e73  g the input tens
-00007570: 6f72 2e0a 2020 2020 615f 6772 6164 203d  or..    a_grad =
-00007580: 202d 302e 3520 2a20 6720 2a20 6677 642a   -0.5 * g * fwd*
-00007590: 2a33 2e30 0a20 2020 2070 7574 5f67 7261  *3.0.    put_gra
-000075a0: 6428 612c 2061 5f67 7261 6429 0a0a 2020  d(a, a_grad)..  
-000075b0: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
-000075c0: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
-000075d0: 732e 5253 5152 542c 205f 7273 7172 745f  s.RSQRT, _rsqrt_
-000075e0: 7072 696d 5f67 7261 6429 0a0a 0a64 6566  prim_grad)...def
-000075f0: 205f 7369 6e5f 7072 696d 5f67 7261 6428   _sin_prim_grad(
-00007600: 613a 204e 756d 6265 7220 7c20 5465 6e73  a: Number | Tens
-00007610: 6f72 5072 6f78 7929 202d 3e20 4e75 6d62  orProxy) -> Numb
-00007620: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-00007630: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
-00007640: 732e 7369 6e28 6129 0a0a 2020 2020 6720  s.sin(a)..    g 
-00007650: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
-00007660: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
-00007670: 6720 2a20 7072 696d 732e 636f 7328 6129  g * prims.cos(a)
-00007680: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
-00007690: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
-000076a0: 6428 7069 6473 2e53 494e 2c20 5f73 696e  d(pids.SIN, _sin
-000076b0: 5f70 7269 6d5f 6772 6164 290a 0a0a 4074  _prim_grad)...@t
-000076c0: 6f72 6368 6374 780a 6465 6620 5f74 616e  orchctx.def _tan
-000076d0: 685f 7072 696d 5f67 7261 6428 613a 204e  h_prim_grad(a: N
-000076e0: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
-000076f0: 6f78 792c 202f 2920 2d3e 204e 756d 6265  oxy, /) -> Numbe
-00007700: 7220 7c20 5465 6e73 6f72 5072 6f78 793a  r | TensorProxy:
-00007710: 0a20 2020 2066 7764 203d 2070 7269 6d73  .    fwd = prims
-00007720: 2e74 616e 6828 6129 0a0a 2020 2020 6720  .tanh(a)..    g 
-00007730: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
-00007740: 2020 2020 615f 6772 6164 203d 2067 202a      a_grad = g *
-00007750: 2028 3120 2d20 6677 6420 2a20 6677 6429   (1 - fwd * fwd)
-00007760: 0a20 2020 2070 7574 5f67 7261 6428 612c  .    put_grad(a,
-00007770: 2061 5f67 7261 6429 0a0a 2020 2020 7265   a_grad)..    re
-00007780: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
-00007790: 7465 725f 6772 6164 2870 6964 732e 5441  ter_grad(pids.TA
-000077a0: 4e48 2c20 5f74 616e 685f 7072 696d 5f67  NH, _tanh_prim_g
-000077b0: 7261 6429 0a0a 230a 2320 456c 656d 656e  rad)..#.# Elemen
-000077c0: 7477 6973 6520 6269 6e61 7279 206f 7065  twise binary ope
-000077d0: 7261 746f 7220 6772 6164 730a 230a 0a0a  rator grads.#...
-000077e0: 4074 6f72 6368 6374 780a 6465 6620 5f61  @torchctx.def _a
-000077f0: 6464 5f70 7269 6d5f 6772 6164 2861 3a20  dd_prim_grad(a: 
-00007800: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
-00007810: 726f 7879 2c20 623a 204e 756d 6265 7220  roxy, b: Number 
-00007820: 7c20 5465 6e73 6f72 5072 6f78 792c 202f  | TensorProxy, /
-00007830: 2920 2d3e 204e 756d 6265 7220 7c20 5465  ) -> Number | Te
-00007840: 6e73 6f72 5072 6f78 793a 0a20 2020 2066  nsorProxy:.    f
-00007850: 7764 203d 2061 202b 2062 0a0a 2020 2020  wd = a + b..    
-00007860: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
-00007870: 290a 2020 2020 615f 6772 6164 203d 2067  ).    a_grad = g
-00007880: 0a20 2020 2062 5f67 7261 6420 3d20 670a  .    b_grad = g.
-00007890: 2020 2020 7075 745f 6772 6164 7328 2861      put_grads((a
-000078a0: 2c20 6229 2c20 2861 5f67 7261 642c 2062  , b), (a_grad, b
-000078b0: 5f67 7261 6429 290a 0a20 2020 2072 6574  _grad))..    ret
-000078c0: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
-000078d0: 6572 5f67 7261 6428 7069 6473 2e41 4444  er_grad(pids.ADD
-000078e0: 2c20 5f61 6464 5f70 7269 6d5f 6772 6164  , _add_prim_grad
-000078f0: 290a 0a0a 2320 4e4f 5445 2054 6865 2066  )...# NOTE The f
-00007900: 6f6c 6c6f 7769 6e67 2067 7261 6420 6465  ollowing grad de
-00007910: 6669 6e69 7469 6f6e 2072 656c 6965 7320  finition relies 
-00007920: 6f6e 2074 6865 2066 6163 7420 7468 6174  on the fact that
-00007930: 206f 6e6c 7920 696e 6578 6163 7420 6474   only inexact dt
-00007940: 7970 6573 2061 7265 2064 6966 6665 7265  ypes are differe
-00007950: 6e74 6961 626c 652c 0a23 2020 2061 6e64  ntiable,.#   and
-00007960: 2074 6f72 6368 2773 2074 7275 6520 6469   torch's true di
-00007970: 7669 7369 6f6e 206f 7065 7261 746f 7220  vision operator 
-00007980: 616e 6420 7468 6520 6469 7669 7369 6f6e  and the division
-00007990: 2070 7269 6d69 7469 7665 2061 6772 6565   primitive agree
-000079a0: 206f 6e20 7468 6f73 6520 7479 7065 730a   on those types.
-000079b0: 4074 6f72 6368 6374 780a 6465 6620 5f64  @torchctx.def _d
-000079c0: 6976 5f70 7269 6d5f 6772 6164 2861 3a20  iv_prim_grad(a: 
-000079d0: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
-000079e0: 726f 7879 2c20 623a 204e 756d 6265 7220  roxy, b: Number 
-000079f0: 7c20 5465 6e73 6f72 5072 6f78 792c 202f  | TensorProxy, /
-00007a00: 2920 2d3e 204e 756d 6265 7220 7c20 5465  ) -> Number | Te
-00007a10: 6e73 6f72 5072 6f78 793a 0a20 2020 2066  nsorProxy:.    f
-00007a20: 7764 203d 2061 202f 2062 0a0a 2020 2020  wd = a / b..    
-00007a30: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
-00007a40: 290a 2020 2020 615f 6772 6164 203d 2067  ).    a_grad = g
-00007a50: 202f 2062 0a20 2020 2062 5f67 7261 6420   / b.    b_grad 
-00007a60: 3d20 2d67 202a 2028 2861 202f 2062 2920  = -g * ((a / b) 
-00007a70: 2f20 6229 0a20 2020 2070 7574 5f67 7261  / b).    put_gra
-00007a80: 6473 2828 612c 2062 292c 2028 615f 6772  ds((a, b), (a_gr
-00007a90: 6164 2c20 625f 6772 6164 2929 0a0a 2020  ad, b_grad))..  
-00007aa0: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
-00007ab0: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
-00007ac0: 732e 4449 562c 205f 6469 765f 7072 696d  s.DIV, _div_prim
-00007ad0: 5f67 7261 6429 0a0a 2320 436f 6d70 6172  _grad)..# Compar
-00007ae0: 6973 6f6e 206f 7065 7261 746f 7273 202d  ison operators -
-00007af0: 2d20 7468 6573 6520 6372 6561 7465 206e  - these create n
-00007b00: 6f20 6772 6164 2061 7373 6f63 6961 7469  o grad associati
-00007b10: 6f6e 730a 7265 6769 7374 6572 5f67 7261  ons.register_gra
-00007b20: 6428 7069 6473 2e45 512c 2070 7269 6d73  d(pids.EQ, prims
-00007b30: 2e65 7129 0a72 6567 6973 7465 725f 6772  .eq).register_gr
-00007b40: 6164 2870 6964 732e 4745 2c20 7072 696d  ad(pids.GE, prim
-00007b50: 732e 6765 290a 7265 6769 7374 6572 5f67  s.ge).register_g
-00007b60: 7261 6428 7069 6473 2e4c 542c 2070 7269  rad(pids.LT, pri
-00007b70: 6d73 2e6c 7429 0a0a 0a40 746f 7263 6863  ms.lt)...@torchc
-00007b80: 7478 0a64 6566 205f 6d75 6c5f 7072 696d  tx.def _mul_prim
-00007b90: 5f67 7261 6428 613a 204e 756d 6265 7220  _grad(a: Number 
-00007ba0: 7c20 5465 6e73 6f72 5072 6f78 792c 2062  | TensorProxy, b
-00007bb0: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
-00007bc0: 7250 726f 7879 2c20 2f29 202d 3e20 4e75  rProxy, /) -> Nu
-00007bd0: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
-00007be0: 7879 3a0a 2020 2020 6677 6420 3d20 6120  xy:.    fwd = a 
-00007bf0: 2a20 620a 0a20 2020 2067 203d 2067 6574  * b..    g = get
-00007c00: 5f67 7261 6428 6677 6429 0a20 2020 2061  _grad(fwd).    a
-00007c10: 5f67 7261 6420 3d20 6220 2a20 670a 2020  _grad = b * g.  
-00007c20: 2020 625f 6772 6164 203d 2061 202a 2067    b_grad = a * g
-00007c30: 0a20 2020 2070 7574 5f67 7261 6473 2828  .    put_grads((
-00007c40: 612c 2062 292c 2028 615f 6772 6164 2c20  a, b), (a_grad, 
-00007c50: 625f 6772 6164 2929 0a0a 2020 2020 7265  b_grad))..    re
-00007c60: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
-00007c70: 7465 725f 6772 6164 2870 6964 732e 4d55  ter_grad(pids.MU
-00007c80: 4c2c 205f 6d75 6c5f 7072 696d 5f67 7261  L, _mul_prim_gra
-00007c90: 6429 0a0a 0a40 746f 7263 6863 7478 0a64  d)...@torchctx.d
-00007ca0: 6566 205f 7375 625f 7072 696d 5f67 7261  ef _sub_prim_gra
-00007cb0: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
-00007cc0: 6e73 6f72 5072 6f78 792c 2062 3a20 4e75  nsorProxy, b: Nu
-00007cd0: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
-00007ce0: 7879 2920 2d3e 204e 756d 6265 7220 7c20  xy) -> Number | 
-00007cf0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-00007d00: 2066 7764 203d 2061 202d 2062 0a0a 2020   fwd = a - b..  
-00007d10: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
-00007d20: 7764 290a 2020 2020 615f 6772 6164 203d  wd).    a_grad =
-00007d30: 2067 0a20 2020 2062 5f67 7261 6420 3d20   g.    b_grad = 
-00007d40: 2d67 0a20 2020 2070 7574 5f67 7261 6473  -g.    put_grads
-00007d50: 2828 612c 2062 292c 2028 615f 6772 6164  ((a, b), (a_grad
-00007d60: 2c20 625f 6772 6164 2929 0a0a 2020 2020  , b_grad))..    
-00007d70: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
-00007d80: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
-00007d90: 5355 422c 205f 7375 625f 7072 696d 5f67  SUB, _sub_prim_g
-00007da0: 7261 6429 0a0a 0a23 0a23 2043 6f6e 6469  rad)...#.# Condi
-00007db0: 7469 6f6e 616c 206f 7065 7261 746f 7220  tional operator 
-00007dc0: 6772 6164 730a 230a 0a0a 6465 6620 5f77  grads.#...def _w
-00007dd0: 6865 7265 5f70 7269 6d5f 6772 6164 2870  here_prim_grad(p
-00007de0: 7265 643a 204e 756d 6265 7220 7c20 5465  red: Number | Te
-00007df0: 6e73 6f72 5072 6f78 792c 2061 3a20 4e75  nsorProxy, a: Nu
-00007e00: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
-00007e10: 7879 2c20 623a 204e 756d 6265 7220 7c20  xy, b: Number | 
-00007e20: 5465 6e73 6f72 5072 6f78 7929 202d 3e20  TensorProxy) -> 
-00007e30: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-00007e40: 2066 7764 203d 2070 7269 6d73 2e77 6865   fwd = prims.whe
-00007e50: 7265 2870 7265 642c 2061 2c20 6229 0a0a  re(pred, a, b)..
-00007e60: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
-00007e70: 2866 7764 290a 2020 2020 615f 6772 6164  (fwd).    a_grad
-00007e80: 203d 206c 746f 7263 682e 7768 6572 6528   = ltorch.where(
-00007e90: 7072 6564 2c20 672c 2030 290a 2020 2020  pred, g, 0).    
-00007ea0: 625f 6772 6164 203d 206c 746f 7263 682e  b_grad = ltorch.
-00007eb0: 7768 6572 6528 7072 6564 2c20 302c 2067  where(pred, 0, g
-00007ec0: 290a 2020 2020 7075 745f 6772 6164 7328  ).    put_grads(
-00007ed0: 2861 2c20 6229 2c20 2861 5f67 7261 642c  (a, b), (a_grad,
-00007ee0: 2062 5f67 7261 6429 290a 0a20 2020 2072   b_grad))..    r
-00007ef0: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
-00007f00: 7374 6572 5f67 7261 6428 7069 6473 2e57  ster_grad(pids.W
-00007f10: 4845 5245 2c20 5f77 6865 7265 5f70 7269  HERE, _where_pri
-00007f20: 6d5f 6772 6164 290a 0a23 0a23 2052 6564  m_grad)..#.# Red
-00007f30: 7563 7469 6f6e 206f 7065 7261 746f 7220  uction operator 
-00007f40: 6772 6164 730a 230a 0a0a 2320 544f 444f  grads.#...# TODO
-00007f50: 2052 6576 6965 7720 7477 6561 6b69 6e67   Review tweaking
-00007f60: 2067 7261 645f 6368 6f6f 7365 725f 7075   grad_chooser_pu
-00007f70: 6c6c 6261 636b 2069 6e74 6572 6661 6365  llback interface
-00007f80: 0a64 6566 205f 616d 6178 5f70 7269 6d5f  .def _amax_prim_
-00007f90: 6772 6164 2861 3a20 5465 6e73 6f72 5072  grad(a: TensorPr
-00007fa0: 6f78 792c 202f 2c20 6469 6d73 3a20 5365  oxy, /, dims: Se
-00007fb0: 7175 656e 6365 5b69 6e74 5d29 202d 3e20  quence[int]) -> 
-00007fc0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-00007fd0: 2066 7764 203d 2070 7269 6d73 2e61 6d61   fwd = prims.ama
-00007fe0: 7828 612c 2064 696d 7329 0a0a 2020 2020  x(a, dims)..    
-00007ff0: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
-00008000: 290a 2020 2020 615f 6772 6164 203d 2067  ).    a_grad = g
-00008010: 7261 645f 6368 6f6f 7365 725f 6261 636b  rad_chooser_back
-00008020: 7761 7264 2866 7764 2c20 612c 2061 2e73  ward(fwd, a, a.s
-00008030: 6861 7065 2c20 6469 6d73 2c20 6729 0a20  hape, dims, g). 
-00008040: 2020 2070 7574 5f67 7261 6428 612c 2061     put_grad(a, a
-00008050: 5f67 7261 6429 0a0a 2020 2020 7265 7475  _grad)..    retu
-00008060: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
-00008070: 725f 6772 6164 2870 6964 732e 414d 4158  r_grad(pids.AMAX
-00008080: 2c20 5f61 6d61 785f 7072 696d 5f67 7261  , _amax_prim_gra
-00008090: 6429 0a0a 0a64 6566 205f 7375 6d5f 7072  d)...def _sum_pr
-000080a0: 696d 5f67 7261 6428 613a 2054 656e 736f  im_grad(a: Tenso
-000080b0: 7250 726f 7879 2c20 2f2c 2064 696d 733a  rProxy, /, dims:
-000080c0: 2053 6571 7565 6e63 655b 696e 745d 2920   Sequence[int]) 
-000080d0: 2d3e 2054 656e 736f 7250 726f 7879 3a0a  -> TensorProxy:.
-000080e0: 2020 2020 6677 6420 3d20 7072 696d 732e      fwd = prims.
-000080f0: 7375 6d28 612c 2064 696d 7329 0a0a 2020  sum(a, dims)..  
-00008100: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
-00008110: 7764 290a 2020 2020 615f 6772 6164 203d  wd).    a_grad =
-00008120: 2072 6573 746f 7265 5f72 6564 7563 6564   restore_reduced
-00008130: 5f64 696d 7328 672c 2064 696d 732c 2061  _dims(g, dims, a
-00008140: 2e73 6861 7065 290a 2020 2020 7075 745f  .shape).    put_
-00008150: 6772 6164 2861 2c20 615f 6772 6164 290a  grad(a, a_grad).
-00008160: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
-00008170: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
-00008180: 7069 6473 2e53 554d 2c20 5f73 756d 5f70  pids.SUM, _sum_p
-00008190: 7269 6d5f 6772 6164 290a 0a0a 4074 6f72  rim_grad)...@tor
-000081a0: 6368 6374 780a 6465 6620 5f74 6f70 6b5f  chctx.def _topk_
-000081b0: 7072 696d 5f67 7261 6428 0a20 2020 2061  prim_grad(.    a
-000081c0: 3a20 5465 6e73 6f72 5072 6f78 792c 202f  : TensorProxy, /
-000081d0: 2c20 6b3a 2069 6e74 2c20 6469 6d3a 204e  , k: int, dim: N
-000081e0: 6f6e 6520 7c20 696e 7420 3d20 4e6f 6e65  one | int = None
-000081f0: 2c20 6c61 7267 6573 743a 2062 6f6f 6c20  , largest: bool 
-00008200: 3d20 5472 7565 2c20 736f 7274 6564 3a20  = True, sorted: 
-00008210: 626f 6f6c 203d 2054 7275 652c 202a 2c20  bool = True, *, 
-00008220: 6f75 743d 4e6f 6e65 0a29 3a0a 2020 2020  out=None.):.    
-00008230: 6677 6420 3d20 7072 696d 732e 746f 706b  fwd = prims.topk
-00008240: 2861 2c20 6b2c 2064 696d 2c20 6c61 7267  (a, k, dim, larg
-00008250: 6573 742c 2073 6f72 7465 642c 206f 7574  est, sorted, out
-00008260: 3d6f 7574 290a 2020 2020 7661 6c2c 2069  =out).    val, i
-00008270: 6478 203d 2066 7764 0a0a 2020 2020 7661  dx = fwd..    va
-00008280: 6c5f 6772 6164 203d 2067 6574 5f67 7261  l_grad = get_gra
-00008290: 6428 7661 6c29 0a0a 2020 2020 615f 6772  d(val)..    a_gr
-000082a0: 6164 203d 206c 746f 7263 682e 7a65 726f  ad = ltorch.zero
-000082b0: 735f 6c69 6b65 2861 290a 2020 2020 2320  s_like(a).    # 
-000082c0: 544f 444f 3a20 7265 706c 6163 6520 7769  TODO: replace wi
-000082d0: 7468 2073 6361 7474 6572 206f 6e63 6520  th scatter once 
-000082e0: 7765 2068 6176 6520 6974 2e0a 2020 2020  we have it..    
-000082f0: 2320 7363 6174 7465 725f 6164 6420 6973  # scatter_add is
-00008300: 2061 2070 7269 6d20 616e 6420 6974 2072   a prim and it r
-00008310: 656c 6965 7320 6f6e 2061 746f 6d69 6320  elies on atomic 
-00008320: 6f70 732e 0a20 2020 2061 5f67 7261 6420  ops..    a_grad 
-00008330: 3d20 6c74 6f72 6368 2e73 6361 7474 6572  = ltorch.scatter
-00008340: 5f61 6464 2861 5f67 7261 642c 2064 696d  _add(a_grad, dim
-00008350: 2c20 6964 782c 2076 616c 5f67 7261 6429  , idx, val_grad)
-00008360: 0a20 2020 2070 7574 5f67 7261 6428 612c  .    put_grad(a,
-00008370: 2061 5f67 7261 6429 0a0a 2020 2020 7265   a_grad)..    re
-00008380: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
-00008390: 7465 725f 6772 6164 2870 6964 732e 544f  ter_grad(pids.TO
-000083a0: 504b 2c20 5f74 6f70 6b5f 7072 696d 5f67  PK, _topk_prim_g
-000083b0: 7261 6429 0a0a 0a23 2054 4f44 4f20 4669  rad)...# TODO Fi
-000083c0: 7820 6469 7669 7369 6f6e 2062 7920 7a65  x division by ze
-000083d0: 726f 2077 6865 6e20 6e5f 656c 656d 5f72  ro when n_elem_r
-000083e0: 6564 7563 6564 203d 3d20 3020 6f72 2077  educed == 0 or w
-000083f0: 6865 6e20 6d65 616e 2e6e 756d 656c 203d  hen mean.numel =
-00008400: 3d20 300a 2320 2020 6279 2072 6574 7572  = 0.#   by retur
-00008410: 6e69 6e67 207a 6572 6f73 5f6c 696b 6528  ning zeros_like(
-00008420: 6129 206f 7220 7369 6d69 6c61 722e 0a23  a) or similar..#
-00008430: 2054 4f44 4f20 4669 7820 6772 6164 2077   TODO Fix grad w
-00008440: 6865 6e20 636f 7272 6563 7469 6f6e 203e  hen correction >
-00008450: 206e 5f65 6c65 6d5f 7265 6475 6365 642e   n_elem_reduced.
-00008460: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
-00008470: 7661 725f 6d65 616e 5f70 7269 6d5f 6772  var_mean_prim_gr
-00008480: 6164 2861 3a20 5465 6e73 6f72 5072 6f78  ad(a: TensorProx
-00008490: 792c 202f 2c20 6469 6d73 3a20 5365 7175  y, /, dims: Sequ
-000084a0: 656e 6365 5b69 6e74 5d2c 202a 2c20 636f  ence[int], *, co
-000084b0: 7272 6563 7469 6f6e 3a20 4e75 6d62 6572  rrection: Number
-000084c0: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
-000084d0: 3a0a 2020 2020 762c 206d 203d 2070 7269  :.    v, m = pri
-000084e0: 6d73 2e76 6172 5f6d 6561 6e28 612c 2064  ms.var_mean(a, d
-000084f0: 696d 732c 2063 6f72 7265 6374 696f 6e3d  ims, correction=
-00008500: 636f 7272 6563 7469 6f6e 290a 0a20 2020  correction)..   
-00008510: 2067 7620 3d20 6765 745f 6772 6164 2876   gv = get_grad(v
-00008520: 290a 2020 2020 676d 203d 2067 6574 5f67  ).    gm = get_g
-00008530: 7261 6428 6d29 0a0a 2020 2020 6e5f 656c  rad(m)..    n_el
-00008540: 656d 5f72 6564 7563 6564 203d 2061 2e6e  em_reduced = a.n
-00008550: 756d 656c 202f 2f20 6d2e 6e75 6d65 6c20  umel // m.numel 
-00008560: 6966 2061 2e6e 756d 656c 2021 3d20 3020  if a.numel != 0 
-00008570: 656c 7365 2031 0a0a 2020 2020 2320 436f  else 1..    # Co
-00008580: 6d70 7574 6573 206d 6561 6e20 6277 640a  mputes mean bwd.
-00008590: 2020 2020 6d65 616e 5f73 6361 6c65 203d      mean_scale =
-000085a0: 2031 2e30 202f 206e 5f65 6c65 6d5f 7265   1.0 / n_elem_re
-000085b0: 6475 6365 640a 2020 2020 6d65 616e 5f67  duced.    mean_g
-000085c0: 7261 6420 3d20 6d65 616e 5f73 6361 6c65  rad = mean_scale
-000085d0: 202a 2072 6573 746f 7265 5f72 6564 7563   * restore_reduc
-000085e0: 6564 5f64 696d 7328 676d 2c20 6469 6d73  ed_dims(gm, dims
-000085f0: 2c20 612e 7368 6170 6529 0a0a 2020 2020  , a.shape)..    
-00008600: 2320 436f 6d70 7574 6573 2076 6172 2062  # Computes var b
-00008610: 7764 0a20 2020 206e 6f72 6d61 6c69 7a61  wd.    normaliza
-00008620: 7469 6f6e 5f73 6361 6c61 7220 3d20 6e5f  tion_scalar = n_
-00008630: 656c 656d 5f72 6564 7563 6564 202d 2063  elem_reduced - c
-00008640: 6f72 7265 6374 696f 6e0a 2020 2020 7265  orrection.    re
-00008650: 7374 6f72 6564 5f67 7620 3d20 7265 7374  stored_gv = rest
-00008660: 6f72 655f 7265 6475 6365 645f 6469 6d73  ore_reduced_dims
-00008670: 2867 762c 2064 696d 732c 2061 2e73 6861  (gv, dims, a.sha
-00008680: 7065 290a 2020 2020 7265 7374 6f72 6564  pe).    restored
-00008690: 5f6d 6561 6e20 3d20 7265 7374 6f72 655f  _mean = restore_
-000086a0: 7265 6475 6365 645f 6469 6d73 286d 2c20  reduced_dims(m, 
-000086b0: 6469 6d73 2c20 612e 7368 6170 6529 0a20  dims, a.shape). 
-000086c0: 2020 2076 6172 5f67 7261 6420 3d20 2832     var_grad = (2
-000086d0: 202a 2072 6573 746f 7265 645f 6776 202a   * restored_gv *
-000086e0: 2028 6120 2d20 7265 7374 6f72 6564 5f6d   (a - restored_m
-000086f0: 6561 6e29 2920 2f20 6e6f 726d 616c 697a  ean)) / normaliz
-00008700: 6174 696f 6e5f 7363 616c 6172 0a0a 2020  ation_scalar..  
-00008710: 2020 7075 745f 6772 6164 2861 2c20 6d65    put_grad(a, me
-00008720: 616e 5f67 7261 6420 2b20 7661 725f 6772  an_grad + var_gr
-00008730: 6164 290a 0a20 2020 2072 6574 7572 6e20  ad)..    return 
-00008740: 762c 206d 0a0a 0a72 6567 6973 7465 725f  v, m...register_
-00008750: 6772 6164 2870 6964 732e 5641 525f 4d45  grad(pids.VAR_ME
-00008760: 414e 2c20 5f76 6172 5f6d 6561 6e5f 7072  AN, _var_mean_pr
-00008770: 696d 5f67 7261 6429 0a0a 0a23 0a23 204c  im_grad)...#.# L
-00008780: 696e 6561 7220 616c 6765 6272 6120 6f70  inear algebra op
-00008790: 6572 6174 6f72 2067 7261 6473 0a23 0a40  erator grads.#.@
-000087a0: 746f 7263 6863 7478 0a64 6566 205f 6c69  torchctx.def _li
-000087b0: 6e65 6172 5f70 7269 6d5f 6772 6164 2861  near_prim_grad(a
-000087c0: 3a20 5465 6e73 6f72 5072 6f78 792c 2077  : TensorProxy, w
-000087d0: 3a20 5465 6e73 6f72 5072 6f78 792c 2062  : TensorProxy, b
-000087e0: 6961 733a 204e 6f6e 6520 7c20 5465 6e73  ias: None | Tens
-000087f0: 6f72 5072 6f78 7929 202d 3e20 5465 6e73  orProxy) -> Tens
-00008800: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
-00008810: 203d 2070 7269 6d73 2e6c 696e 6561 7228   = prims.linear(
-00008820: 612c 2077 2c20 6269 6173 290a 0a20 2020  a, w, bias)..   
-00008830: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
-00008840: 6429 0a0a 2020 2020 6669 7273 745f 6469  d)..    first_di
-00008850: 6d20 3d20 2d32 0a20 2020 2067 7261 645f  m = -2.    grad_
-00008860: 6120 3d20 6c74 6f72 6368 2e6d 6174 6d75  a = ltorch.matmu
-00008870: 6c28 672e 7265 7368 6170 6528 2d31 2c20  l(g.reshape(-1, 
-00008880: 672e 7368 6170 655b 2d31 5d29 2c20 7729  g.shape[-1]), w)
-00008890: 2e72 6573 6861 7065 2861 2e73 6861 7065  .reshape(a.shape
-000088a0: 290a 0a20 2020 2067 7261 645f 773a 2054  )..    grad_w: T
-000088b0: 656e 736f 7250 726f 7879 0a20 2020 2069  ensorProxy.    i
-000088c0: 6620 612e 6e64 696d 203d 3d20 313a 0a20  f a.ndim == 1:. 
-000088d0: 2020 2020 2020 2067 7261 645f 7720 3d20         grad_w = 
-000088e0: 6c74 6f72 6368 2e6d 6174 6d75 6c28 672e  ltorch.matmul(g.
-000088f0: 756e 7371 7565 657a 6528 6669 7273 745f  unsqueeze(first_
-00008900: 6469 6d29 2e6d 542c 2061 2e75 6e73 7175  dim).mT, a.unsqu
-00008910: 6565 7a65 2866 6972 7374 5f64 696d 2929  eeze(first_dim))
-00008920: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00008930: 2020 2067 7261 645f 7720 3d20 6c74 6f72     grad_w = ltor
-00008940: 6368 2e6d 6174 6d75 6c28 672e 7265 7368  ch.matmul(g.resh
-00008950: 6170 6528 2d31 2c20 672e 7368 6170 655b  ape(-1, g.shape[
-00008960: 2d31 5d29 2e6d 542c 2061 2e72 6573 6861  -1]).mT, a.resha
-00008970: 7065 282d 312c 2061 2e73 6861 7065 5b2d  pe(-1, a.shape[-
-00008980: 315d 2929 0a0a 2020 2020 7075 745f 6772  1]))..    put_gr
-00008990: 6164 7328 2861 2c20 7729 2c20 2867 7261  ads((a, w), (gra
-000089a0: 645f 612c 2067 7261 645f 7729 290a 0a20  d_a, grad_w)).. 
-000089b0: 2020 2069 6620 6269 6173 2069 7320 6e6f     if bias is no
-000089c0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000089d0: 6966 2067 2e6e 6469 6d20 3e20 313a 0a20  if g.ndim > 1:. 
-000089e0: 2020 2020 2020 2020 2020 2067 7261 645f             grad_
-000089f0: 6269 6173 203d 206c 746f 7263 682e 7375  bias = ltorch.su
-00008a00: 6d28 672c 2074 7570 6c65 2872 616e 6765  m(g, tuple(range
-00008a10: 2867 2e6e 6469 6d20 2d20 3129 2929 0a20  (g.ndim - 1))). 
-00008a20: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00008a30: 2020 2020 2020 2020 2067 7261 645f 6269           grad_bi
-00008a40: 6173 203d 2067 0a20 2020 2020 2020 2070  as = g.        p
-00008a50: 7574 5f67 7261 6428 6269 6173 2c20 6772  ut_grad(bias, gr
-00008a60: 6164 5f62 6961 7329 0a0a 2020 2020 7265  ad_bias)..    re
-00008a70: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
-00008a80: 7465 725f 6772 6164 2870 6964 732e 4c49  ter_grad(pids.LI
-00008a90: 4e45 4152 2c20 5f6c 696e 6561 725f 7072  NEAR, _linear_pr
-00008aa0: 696d 5f67 7261 6429 0a0a 0a23 2054 4f44  im_grad)...# TOD
-00008ab0: 4f20 4164 6420 6578 706c 6963 6974 206c  O Add explicit l
-00008ac0: 746f 7263 6820 7673 2063 6c61 6e67 206d  torch vs clang m
-00008ad0: 6f64 756c 6520 746f 2074 6865 2074 656e  odule to the ten
-00008ae0: 736f 7220 6f70 6572 6174 696f 6e73 2062  sor operations b
-00008af0: 656c 6f77 0a23 2054 4f44 4f20 636f 756c  elow.# TODO coul
-00008b00: 6420 7765 2067 6574 2072 6964 206f 6620  d we get rid of 
-00008b10: 7468 6520 6669 6e61 6c20 7371 7565 657a  the final squeez
-00008b20: 6573 2069 6e20 7468 6520 622e 6e64 696d  es in the b.ndim
-00008b30: 203d 3d20 3120 6361 7365 2061 6e64 2074   == 1 case and t
-00008b40: 6865 2061 2e6e 6469 6d20 3d3d 2031 2063  he a.ndim == 1 c
-00008b50: 6173 653f 0a40 746f 7263 6863 7478 0a64  ase?.@torchctx.d
-00008b60: 6566 205f 6d61 746d 756c 5f70 7269 6d5f  ef _matmul_prim_
-00008b70: 6772 6164 2861 3a20 5465 6e73 6f72 5072  grad(a: TensorPr
-00008b80: 6f78 792c 2062 3a20 5465 6e73 6f72 5072  oxy, b: TensorPr
-00008b90: 6f78 792c 202f 2920 2d3e 2054 656e 736f  oxy, /) -> Tenso
-00008ba0: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
-00008bb0: 3d20 7072 696d 732e 6d61 746d 756c 2861  = prims.matmul(a
-00008bc0: 2c20 6229 0a20 2020 2067 203d 2067 6574  , b).    g = get
-00008bd0: 5f67 7261 6428 6677 6429 0a0a 2020 2020  _grad(fwd)..    
-00008be0: 6c61 7374 5f64 696d 203d 2028 2d31 2c29  last_dim = (-1,)
-00008bf0: 0a20 2020 2066 6972 7374 5f64 696d 203d  .    first_dim =
-00008c00: 2028 2d32 2c29 0a20 2020 2069 6620 612e   (-2,).    if a.
-00008c10: 6e64 696d 203d 3d20 3120 616e 6420 622e  ndim == 1 and b.
-00008c20: 6e64 696d 203d 3d20 313a 0a20 2020 2020  ndim == 1:.     
-00008c30: 2020 2070 7574 5f67 7261 6473 2828 612c     put_grads((a,
-00008c40: 2062 292c 2028 6720 2a20 622c 2067 202a   b), (g * b, g *
-00008c50: 2061 2929 0a20 2020 2065 6c69 6620 622e   a)).    elif b.
-00008c60: 6e64 696d 203d 3d20 313a 0a20 2020 2020  ndim == 1:.     
-00008c70: 2020 2067 6120 3d20 756e 7371 7565 657a     ga = unsqueez
-00008c80: 6528 672c 206c 6173 745f 6469 6d29 2040  e(g, last_dim) @
-00008c90: 2075 6e73 7175 6565 7a65 2862 2c20 6c61   unsqueeze(b, la
-00008ca0: 7374 5f64 696d 292e 6d54 0a20 2020 2020  st_dim).mT.     
-00008cb0: 2020 2067 6220 3d20 612e 6d54 2040 2075     gb = a.mT @ u
-00008cc0: 6e73 7175 6565 7a65 2867 2c20 6c61 7374  nsqueeze(g, last
-00008cd0: 5f64 696d 290a 2020 2020 2020 2020 6966  _dim).        if
-00008ce0: 2067 2e6e 6469 6d20 3e20 313a 0a20 2020   g.ndim > 1:.   
-00008cf0: 2020 2020 2020 2020 2067 6220 3d20 7371           gb = sq
-00008d00: 7565 657a 6528 6762 2c20 6c61 7374 5f64  ueeze(gb, last_d
-00008d10: 696d 290a 2020 2020 2020 2020 2020 2020  im).            
-00008d20: 6762 203d 206c 746f 7263 682e 7375 6d28  gb = ltorch.sum(
-00008d30: 6762 2c20 7475 706c 6528 7261 6e67 6528  gb, tuple(range(
-00008d40: 6762 2e6e 6469 6d20 2d20 3129 2929 0a20  gb.ndim - 1))). 
-00008d50: 2020 2020 2020 2070 7574 5f67 7261 6473         put_grads
-00008d60: 2828 612c 2062 292c 2028 6761 2c20 6762  ((a, b), (ga, gb
-00008d70: 2e73 7175 6565 7a65 2829 2929 0a20 2020  .squeeze())).   
-00008d80: 2065 6c69 6620 612e 6e64 696d 203d 3d20   elif a.ndim == 
-00008d90: 313a 0a20 2020 2020 2020 2067 6120 3d20  1:.        ga = 
-00008da0: 756e 7371 7565 657a 6528 672c 2066 6972  unsqueeze(g, fir
-00008db0: 7374 5f64 696d 2920 4020 622e 6d54 0a20  st_dim) @ b.mT. 
-00008dc0: 2020 2020 2020 2069 6620 672e 6e64 696d         if g.ndim
-00008dd0: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
-00008de0: 2020 6761 203d 206c 746f 7263 682e 7375    ga = ltorch.su
-00008df0: 6d28 6761 2c20 7475 706c 6528 7261 6e67  m(ga, tuple(rang
-00008e00: 6528 6761 2e6e 6469 6d20 2d20 3129 2929  e(ga.ndim - 1)))
-00008e10: 0a20 2020 2020 2020 2067 6220 3d20 756e  .        gb = un
-00008e20: 7371 7565 657a 6528 612c 2066 6972 7374  squeeze(a, first
-00008e30: 5f64 696d 292e 6d54 2040 2075 6e73 7175  _dim).mT @ unsqu
-00008e40: 6565 7a65 2867 2c20 6669 7273 745f 6469  eeze(g, first_di
-00008e50: 6d29 0a20 2020 2020 2020 2070 7574 5f67  m).        put_g
-00008e60: 7261 6473 2828 612c 2062 292c 2028 6761  rads((a, b), (ga
-00008e70: 2e73 7175 6565 7a65 2829 2c20 6762 2929  .squeeze(), gb))
-00008e80: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00008e90: 2020 2070 7574 5f67 7261 6473 2828 612c     put_grads((a,
-00008ea0: 2062 292c 2028 6720 4020 622e 6d54 2c20   b), (g @ b.mT, 
-00008eb0: 612e 6d54 2040 2067 2929 0a0a 2020 2020  a.mT @ g))..    
-00008ec0: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
-00008ed0: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
-00008ee0: 4d41 544d 554c 2c20 5f6d 6174 6d75 6c5f  MATMUL, _matmul_
-00008ef0: 7072 696d 5f67 7261 6429 0a0a 230a 2320  prim_grad)..#.# 
-00008f00: 4e4e 206f 7065 7261 746f 7220 6772 6164  NN operator grad
-00008f10: 730a 230a 0a0a 4074 6f72 6368 6374 780a  s.#...@torchctx.
-00008f20: 6465 6620 5f65 6d62 6564 6469 6e67 5f70  def _embedding_p
-00008f30: 7269 6d5f 6772 6164 280a 2020 2020 613a  rim_grad(.    a:
-00008f40: 2054 656e 736f 7250 726f 7879 2c20 2f2c   TensorProxy, /,
-00008f50: 2077 6569 6768 742c 202a 2c20 7061 6464   weight, *, padd
-00008f60: 696e 675f 6964 783d 2d31 2c20 6d61 785f  ing_idx=-1, max_
-00008f70: 6e6f 726d 3d4e 6f6e 652c 206e 6f72 6d5f  norm=None, norm_
-00008f80: 7479 7065 3d32 2e30 2c20 7363 616c 655f  type=2.0, scale_
-00008f90: 6772 6164 5f62 795f 6672 6571 3d46 616c  grad_by_freq=Fal
-00008fa0: 7365 2c20 7370 6172 7365 3d46 616c 7365  se, sparse=False
-00008fb0: 0a29 202d 3e20 5465 6e73 6f72 5072 6f78  .) -> TensorProx
-00008fc0: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
-00008fd0: 6d73 2e65 6d62 6564 6469 6e67 280a 2020  ms.embedding(.  
-00008fe0: 2020 2020 2020 612c 0a20 2020 2020 2020        a,.       
-00008ff0: 2077 6569 6768 742c 0a20 2020 2020 2020   weight,.       
-00009000: 2070 6164 6469 6e67 5f69 6478 3d70 6164   padding_idx=pad
-00009010: 6469 6e67 5f69 6478 2c0a 2020 2020 2020  ding_idx,.      
-00009020: 2020 6d61 785f 6e6f 726d 3d6d 6178 5f6e    max_norm=max_n
-00009030: 6f72 6d2c 0a20 2020 2020 2020 206e 6f72  orm,.        nor
-00009040: 6d5f 7479 7065 3d6e 6f72 6d5f 7479 7065  m_type=norm_type
-00009050: 2c0a 2020 2020 2020 2020 7363 616c 655f  ,.        scale_
-00009060: 6772 6164 5f62 795f 6672 6571 3d73 6361  grad_by_freq=sca
-00009070: 6c65 5f67 7261 645f 6279 5f66 7265 712c  le_grad_by_freq,
-00009080: 0a20 2020 2020 2020 2073 7061 7273 653d  .        sparse=
-00009090: 7370 6172 7365 2c0a 2020 2020 290a 0a20  sparse,.    ).. 
-000090a0: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
-000090b0: 6677 6429 0a20 2020 2061 5f67 7261 6420  fwd).    a_grad 
-000090c0: 3d20 7072 696d 732e 656d 6265 6464 696e  = prims.embeddin
-000090d0: 675f 6261 636b 7761 7264 2867 2c20 612c  g_backward(g, a,
-000090e0: 2077 6569 6768 742e 7368 6170 655b 305d   weight.shape[0]
-000090f0: 2c20 7061 6464 696e 675f 6964 782c 2073  , padding_idx, s
-00009100: 6361 6c65 5f67 7261 645f 6279 5f66 7265  cale_grad_by_fre
-00009110: 712c 2073 7061 7273 6529 0a20 2020 2070  q, sparse).    p
-00009120: 7574 5f67 7261 6428 612c 2061 5f67 7261  ut_grad(a, a_gra
-00009130: 6429 0a0a 2020 2020 7265 7475 726e 2066  d)..    return f
-00009140: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
-00009150: 6164 2870 6964 732e 454d 4245 4444 494e  ad(pids.EMBEDDIN
-00009160: 472c 205f 656d 6265 6464 696e 675f 7072  G, _embedding_pr
-00009170: 696d 5f67 7261 6429 0a0a 230a 2320 5068  im_grad)..#.# Ph
-00009180: 616e 746f 6d20 6772 6164 2074 7261 6e73  antom grad trans
-00009190: 666f 726d 2068 656c 7065 7273 0a23 0a0a  form helpers.#..
-000091a0: 0a64 6566 205f 6765 745f 6772 6164 666e  .def _get_gradfn
-000091b0: 2862 7379 6d3a 2042 6f75 6e64 5379 6d62  (bsym: BoundSymb
-000091c0: 6f6c 2c20 2a2c 2065 7865 6375 746f 7273  ol, *, executors
-000091d0: 5f6c 6973 743a 2053 6571 7565 6e63 655b  _list: Sequence[
-000091e0: 416e 795d 203d 2074 7570 6c65 2829 2920  Any] = tuple()) 
-000091f0: 2d3e 204e 6f6e 6520 7c20 4361 6c6c 6162  -> None | Callab
-00009200: 6c65 3a0a 2020 2020 6364 203d 2067 6574  le:.    cd = get
-00009210: 5f63 6f6d 7069 6c65 5f64 6174 6128 290a  _compile_data().
-00009220: 2020 2020 6578 6563 7574 6f72 735f 6c69      executors_li
-00009230: 7374 203d 2063 642e 6578 6563 7574 6f72  st = cd.executor
-00009240: 735f 6c69 7374 2069 6620 6364 2069 7320  s_list if cd is 
-00009250: 6e6f 7420 4e6f 6e65 2065 6c73 6520 6578  not None else ex
-00009260: 6563 7574 6f72 735f 6c69 7374 0a20 2020  ecutors_list.   
-00009270: 2023 2043 6865 636b 7320 6966 2074 6865   # Checks if the
-00009280: 2065 7865 6375 746f 7220 7768 6963 6820   executor which 
-00009290: 6861 7320 7072 696f 7269 7479 2066 6f72  has priority for
-000092a0: 2074 6869 7320 6f70 6572 6174 696f 6e20   this operation 
-000092b0: 6861 7320 6120 7370 6563 6966 6963 2067  has a specific g
-000092c0: 7261 6420 7472 616e 7366 6f72 6d20 666f  rad transform fo
-000092d0: 7220 6974 0a20 2020 2066 6f72 2065 7820  r it.    for ex 
-000092e0: 696e 2065 7865 6375 746f 7273 5f6c 6973  in executors_lis
-000092f0: 743a 0a20 2020 2020 2020 2069 6620 6578  t:.        if ex
-00009300: 2e63 616e 5f65 7865 6375 7465 5f6f 725f  .can_execute_or_
-00009310: 6675 7365 2862 7379 6d29 3a0a 2020 2020  fuse(bsym):.    
-00009320: 2020 2020 2020 2020 6578 5f67 7261 645f          ex_grad_
-00009330: 7472 616e 7366 6f72 6d3a 204e 6f6e 6520  transform: None 
-00009340: 7c20 4361 6c6c 6162 6c65 203d 2065 782e  | Callable = ex.
-00009350: 6765 745f 6772 6164 5f74 7261 6e73 666f  get_grad_transfo
-00009360: 726d 2862 7379 6d2e 7379 6d29 0a20 2020  rm(bsym.sym).   
-00009370: 2020 2020 2020 2020 2069 6620 6578 5f67           if ex_g
-00009380: 7261 645f 7472 616e 7366 6f72 6d20 6973  rad_transform is
-00009390: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-000093a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000093b0: 6e20 6578 5f67 7261 645f 7472 616e 7366  n ex_grad_transf
-000093c0: 6f72 6d0a 2020 2020 2020 2020 2020 2020  orm.            
-000093d0: 6272 6561 6b0a 0a20 2020 2023 2049 6620  break..    # If 
-000093e0: 7468 6520 6578 6563 7574 6f72 2064 6f65  the executor doe
-000093f0: 736e 2774 2064 6566 696e 6520 6974 7320  sn't define its 
-00009400: 6f77 6e20 6772 6164 2074 7261 6e73 666f  own grad transfo
-00009410: 726d 2c20 7468 6973 206a 7573 7420 7265  rm, this just re
-00009420: 7475 726e 7320 7468 6520 6465 6661 756c  turns the defaul
-00009430: 7420 6772 6164 2074 7261 6e73 666f 726d  t grad transform
-00009440: 2066 6f72 2074 6865 2062 7379 6d0a 2020   for the bsym.  
-00009450: 2020 6772 6164 666e 203d 205f 6772 6164    gradfn = _grad
-00009460: 5f66 6e5f 6d61 702e 6765 7428 6273 796d  _fn_map.get(bsym
-00009470: 2e73 796d 2e69 642c 204e 6f6e 6529 0a20  .sym.id, None). 
-00009480: 2020 2072 6574 7572 6e20 6772 6164 666e     return gradfn
-00009490: 0a0a 0a23 2054 6865 2064 6566 6175 6c74  ...# The default
-000094a0: 2067 7261 6420 7370 6563 6966 6965 7220   grad specifier 
-000094b0: 666f 7220 7468 6520 6772 6164 2074 7261  for the grad tra
-000094c0: 6e73 666f 726d 0a23 2020 2046 6f72 2065  nsform.#   For e
-000094d0: 6163 6820 7465 6e73 6f72 206f 7574 7075  ach tensor outpu
-000094e0: 7420 226f 2220 7265 7175 6972 696e 6720  t "o" requiring 
-000094f0: 6772 6164 2c20 7370 6563 6966 6965 7320  grad, specifies 
-00009500: 6120 6772 6164 206f 6620 6f6e 6573 5f6c  a grad of ones_l
-00009510: 696b 6528 6f29 0a64 6566 205f 6772 6164  ike(o).def _grad
-00009520: 5f73 7065 6369 6669 6572 5f64 6566 6175  _specifier_defau
-00009530: 6c74 2870 7974 7265 653a 2041 6e79 2920  lt(pytree: Any) 
-00009540: 2d3e 204e 6f6e 653a 0a20 2020 2066 6c61  -> None:.    fla
-00009550: 7473 2c20 5f20 3d20 7472 6565 5f66 6c61  ts, _ = tree_fla
-00009560: 7474 656e 2870 7974 7265 6529 0a0a 2020  tten(pytree)..  
-00009570: 2020 666f 7220 6620 696e 2066 6c61 7473    for f in flats
-00009580: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
-00009590: 6e73 7461 6e63 6528 662c 2054 656e 736f  nstance(f, Tenso
-000095a0: 7250 726f 7879 2920 616e 6420 662e 7265  rProxy) and f.re
-000095b0: 7175 6972 6573 5f67 7261 643a 0a20 2020  quires_grad:.   
-000095c0: 2020 2020 2020 2020 2023 204e 4f54 4520           # NOTE 
-000095d0: 5468 6973 2075 7365 7320 636c 616e 672e  This uses clang.
-000095e0: 6f6e 6573 5f6c 696b 6520 666f 7220 6e6f  ones_like for no
-000095f0: 7720 6265 6361 7573 6520 6c74 6f72 6368  w because ltorch
-00009600: 2e6f 6e65 735f 6c69 6b65 2077 696c 6c20  .ones_like will 
-00009610: 6578 7465 6e64 2074 6865 0a20 2020 2020  extend the.     
-00009620: 2020 2020 2020 2023 2020 206c 6966 6574         #   lifet
-00009630: 696d 6520 6f66 2066 2c20 7768 696c 6520  ime of f, while 
-00009640: 636c 616e 672e 6f6e 6573 5f6c 696b 6520  clang.ones_like 
-00009650: 7769 6c6c 2065 7874 7261 6374 2074 6865  will extract the
-00009660: 206d 6574 6164 6174 6120 6f66 2066 2061   metadata of f a
-00009670: 7420 7472 6163 6520 7469 6d65 0a20 2020  t trace time.   
-00009680: 2020 2020 2020 2020 2070 7269 6d73 2e70           prims.p
-00009690: 7574 5f67 7261 6428 662c 2063 6c61 6e67  ut_grad(f, clang
-000096a0: 2e66 756c 6c5f 6c69 6b65 2866 2c20 312e  .full_like(f, 1.
-000096b0: 3029 290a 0a0a 2320 544f 444f 2054 6573  0))...# TODO Tes
-000096c0: 7420 7769 7468 2062 7566 6665 7273 0a64  t with buffers.d
-000096d0: 6566 205f 6772 6164 5f6f 7574 5f73 7065  ef _grad_out_spe
-000096e0: 6369 6669 6572 5f64 6566 6175 6c74 2870  cifier_default(p
-000096f0: 7974 7265 653a 2041 6e79 2920 2d3e 206c  ytree: Any) -> l
-00009700: 6973 745b 5465 6e73 6f72 5072 6f78 795d  ist[TensorProxy]
-00009710: 3a0a 2020 2020 666c 6174 732c 205f 203d  :.    flats, _ =
-00009720: 2074 7265 655f 666c 6174 7465 6e28 7079   tree_flatten(py
-00009730: 7472 6565 290a 2020 2020 6772 6164 7320  tree).    grads 
-00009740: 3d20 6c69 7374 285b 7072 696d 732e 6765  = list([prims.ge
-00009750: 745f 6772 6164 2866 2920 666f 7220 6620  t_grad(f) for f 
-00009760: 696e 2066 6c61 7473 2069 6620 6973 696e  in flats if isin
-00009770: 7374 616e 6365 2866 2c20 5465 6e73 6f72  stance(f, Tensor
-00009780: 5072 6f78 7929 2061 6e64 2066 2e72 6571  Proxy) and f.req
-00009790: 7569 7265 735f 6772 6164 5d29 0a20 2020  uires_grad]).   
-000097a0: 2072 6574 7572 6e20 6772 6164 730a 0a0a   return grads...
-000097b0: 2320 544f 444f 2046 6f72 6d61 6c6c 7920  # TODO Formally 
-000097c0: 6465 6669 6e65 2074 6865 2022 6772 6164  define the "grad
-000097d0: 6965 6e74 2220 6f66 2061 2074 656e 736f  ient" of a tenso
-000097e0: 720a 2320 544f 444f 2049 6620 6e6f 6e65  r.# TODO If none
-000097f0: 206f 6620 7468 6520 696e 7075 7473 2074   of the inputs t
-00009800: 6f20 616e 206f 7065 7261 7469 6f6e 2072  o an operation r
-00009810: 6571 7569 7265 2067 7261 642c 2074 6865  equire grad, the
-00009820: 6e20 7765 2063 6f75 6c64 206c 6561 7665  n we could leave
-00009830: 2074 6861 7420 6f70 6572 6174 696f 6e20   that operation 
-00009840: 616c 6f6e 650a 2320 2020 5468 6973 2063  alone.#   This c
-00009850: 6f75 6c64 2061 6374 7561 6c6c 7920 696d  ould actually im
-00009860: 7072 6f76 6520 7065 7266 6f72 6d61 6e63  prove performanc
-00009870: 6520 6966 2074 6865 206f 7065 7261 7469  e if the operati
-00009880: 6f6e 2070 6572 666f 726d 7320 6578 7472  on performs extr
-00009890: 6120 636f 6d70 7574 6174 696f 6e73 2069  a computations i
-000098a0: 6e20 6974 7320 6772 6164 2074 7261 6e73  n its grad trans
-000098b0: 666f 726d 0a23 2020 2041 2077 6f72 6b61  form.#   A worka
-000098c0: 726f 756e 6420 666f 7220 7468 6973 2077  round for this w
-000098d0: 6f75 6c64 2062 6520 666f 7220 7468 6520  ould be for the 
-000098e0: 6f70 6572 6174 696f 6e20 6974 7365 6c66  operation itself
-000098f0: 2074 6f20 6368 6563 6b20 6966 2069 7473   to check if its
-00009900: 2069 6e70 7574 2072 6571 7569 7265 7320   input requires 
-00009910: 6772 6164 206f 7220 6e6f 740a 2320 5472  grad or not.# Tr
-00009920: 616e 7366 6f72 6d73 2061 2066 756e 6374  ansforms a funct
-00009930: 696f 6e20 746f 2063 6f6d 7075 7465 2074  ion to compute t
-00009940: 6865 2022 6772 6164 6965 6e74 2220 6f66  he "gradient" of
-00009950: 2069 7473 2069 6e70 7574 7320 7265 7175   its inputs requ
-00009960: 6972 696e 6720 6772 6164 2c20 706f 7373  iring grad, poss
-00009970: 6962 6c79 0a23 2020 206d 6f64 6966 6965  ibly.#   modifie
-00009980: 6420 6279 2074 6865 2067 7261 6420 7370  d by the grad sp
-00009990: 6563 6966 6965 7273 2028 7365 6520 6265  ecifiers (see be
-000099a0: 6c6f 7729 2e0a 2320 5468 6520 6f70 7469  low)..# The opti
-000099b0: 6f6e 616c 2067 7261 645f 7370 6563 6966  onal grad_specif
-000099c0: 6965 7220 6172 6775 6d65 6e74 2061 6363  ier argument acc
-000099d0: 6570 7473 2074 6865 2066 756e 6374 696f  epts the functio
-000099e0: 6e27 7320 6f75 7470 7574 2c20 7275 6e73  n's output, runs
-000099f0: 2069 6e20 6120 6e6f 2d67 7261 6420 636f   in a no-grad co
-00009a00: 6e74 6578 742c 0a23 2020 2061 6e64 2063  ntext,.#   and c
-00009a10: 616e 2070 7574 2067 7261 6473 2028 7573  an put grads (us
-00009a20: 696e 6720 7072 696d 732e 7075 745f 6772  ing prims.put_gr
-00009a30: 6164 2829 2920 666f 7220 7465 6e73 6f72  ad()) for tensor
-00009a40: 732e 2042 7920 6465 6661 756c 742c 2066  s. By default, f
-00009a50: 6f72 2065 7665 7279 2074 656e 736f 7220  or every tensor 
-00009a60: 6f75 7470 7574 2022 6f22 0a23 2020 2074  output "o".#   t
-00009a70: 6861 7420 7265 7175 6972 6573 2067 7261  hat requires gra
-00009a80: 642c 2061 2067 7261 6420 6f66 206f 6e65  d, a grad of one
-00009a90: 735f 6c69 6b65 286f 2920 6973 2070 7574  s_like(o) is put
-00009aa0: 2e0a 2320 5468 6520 6f70 7469 6f6e 616c  ..# The optional
-00009ab0: 2067 7261 645f 6f75 745f 7370 6563 6966   grad_out_specif
-00009ac0: 6965 7220 6163 6365 7074 7320 7468 6520  ier accepts the 
-00009ad0: 6675 6e63 7469 6f6e 2773 2069 6e70 7574  function's input
-00009ae0: 2061 6e64 2063 616e 2063 616c 6c20 7072   and can call pr
-00009af0: 696d 732e 6765 745f 6772 6164 2829 2074  ims.get_grad() t
-00009b00: 6f0a 2320 2020 6163 7175 6972 6520 616e  o.#   acquire an
-00009b10: 6420 7265 7475 726e 2067 7261 6469 656e  d return gradien
-00009b20: 7473 2061 7320 6465 7369 7265 642e 2042  ts as desired. B
-00009b30: 7920 6465 6661 756c 742c 2074 6865 2069  y default, the i
-00009b40: 6e70 7574 2069 7320 666c 6174 7465 6e65  nput is flattene
-00009b50: 640a 2320 2020 2874 7265 655f 666c 6174  d.#   (tree_flat
-00009b60: 7465 6e28 6172 6773 2c20 6b77 6172 6773  ten(args, kwargs
-00009b70: 2929 2061 6e64 2061 2066 6c61 7420 6c69  )) and a flat li
-00009b80: 7374 206f 6620 6772 6164 7320 666f 7220  st of grads for 
-00009b90: 616c 6c20 7465 6e73 6f72 7320 7265 7175  all tensors requ
-00009ba0: 6972 696e 6720 6772 6164 0a23 2020 2061  iring grad.#   a
-00009bb0: 6e64 204e 6f6e 6520 666f 7220 6f74 6865  nd None for othe
-00009bc0: 7220 696e 7075 7473 2069 7320 7265 7475  r inputs is retu
-00009bd0: 726e 6564 2e0a 2320 5468 6520 616c 676f  rned..# The algo
-00009be0: 7269 7468 6d20 666f 7220 6d6f 6469 6679  rithm for modify
-00009bf0: 696e 6720 7468 6520 7072 6f67 7261 6d20  ing the program 
-00009c00: 6861 7320 7468 6520 666f 6c6c 6f77 696e  has the followin
-00009c10: 6720 7374 6570 733a 0a23 2020 2031 2920  g steps:.#   1) 
-00009c20: 466c 6174 7465 6e73 2074 6865 206f 7269  Flattens the ori
-00009c30: 6769 6e61 6c20 7472 6163 6520 666f 7220  ginal trace for 
-00009c40: 7468 6520 6772 6164 2074 7261 6e73 666f  the grad transfo
-00009c50: 726d 202d 2d20 656e 7375 696e 6720 7468  rm -- ensuing th
-00009c60: 6174 2061 6c6c 2074 6f70 2d6c 6576 656c  at all top-level
-00009c70: 2073 796d 626f 6c73 2068 6176 650a 2320   symbols have.# 
-00009c80: 2020 2020 2020 6120 6772 6164 2066 756e        a grad fun
-00009c90: 6374 696f 6e2e 0a64 6566 2067 7261 6428  ction..def grad(
-00009ca0: 0a20 2020 2063 666e 2c20 6772 6164 5f73  .    cfn, grad_s
-00009cb0: 7065 6369 6669 6572 3a20 4361 6c6c 6162  pecifier: Callab
-00009cc0: 6c65 203d 205f 6772 6164 5f73 7065 6369  le = _grad_speci
-00009cd0: 6669 6572 5f64 6566 6175 6c74 2c20 6772  fier_default, gr
-00009ce0: 6164 5f6f 7574 5f73 7065 6369 6669 6572  ad_out_specifier
-00009cf0: 3a20 4361 6c6c 6162 6c65 203d 205f 6772  : Callable = _gr
-00009d00: 6164 5f6f 7574 5f73 7065 6369 6669 6572  ad_out_specifier
-00009d10: 5f64 6566 6175 6c74 0a29 202d 3e20 4361  _default.) -> Ca
-00009d20: 6c6c 6162 6c65 3a0a 2020 2020 2320 4372  llable:.    # Cr
-00009d30: 6561 7465 7320 6120 6375 7374 6f6d 2074  eates a custom t
-00009d40: 7261 6e73 666f 726d 2063 616c 6c61 626c  ransform callabl
-00009d50: 6520 7468 6174 2062 696e 6473 2074 6865  e that binds the
-00009d60: 2061 6464 6974 696f 6e61 6c20 6172 6775   additional argu
-00009d70: 6d65 6e74 7320 746f 2074 6865 2067 7261  ments to the gra
-00009d80: 6420 7472 616e 7366 6f72 6d0a 2020 2020  d transform.    
-00009d90: 406c 616e 6763 7478 284c 616e 6775 6167  @langctx(Languag
-00009da0: 6573 2e43 4c41 4e47 290a 2020 2020 6465  es.CLANG).    de
-00009db0: 6620 5f67 7261 645f 7472 616e 7366 6f72  f _grad_transfor
-00009dc0: 6d28 7472 633a 2054 7261 6365 2c20 2a2c  m(trc: Trace, *,
-00009dd0: 2065 7865 6375 746f 7273 5f6c 6973 743a   executors_list:
-00009de0: 2053 6571 7565 6e63 655b 416e 795d 2920   Sequence[Any]) 
-00009df0: 2d3e 2054 7261 6365 3a0a 2020 2020 2020  -> Trace:.      
-00009e00: 2020 7374 6172 745f 7469 6d65 5f6e 7320    start_time_ns 
-00009e10: 3d20 7469 6d65 2e74 696d 655f 6e73 2829  = time.time_ns()
-00009e20: 0a0a 2020 2020 2020 2020 2320 5354 4550  ..        # STEP
-00009e30: 204f 4e45 202d 2d20 466c 6174 7465 6e73   ONE -- Flattens
-00009e40: 2061 6e64 2064 6365 730a 0a20 2020 2020   and dces..     
-00009e50: 2020 2023 2052 6574 7572 6e73 2054 7275     # Returns Tru
-00009e60: 6520 6966 2074 6865 2062 7379 6d20 6861  e if the bsym ha
-00009e70: 7320 6e6f 2067 7261 6420 6675 6e63 7469  s no grad functi
-00009e80: 6f6e 2c20 616e 6420 736f 206d 7573 7420  on, and so must 
-00009e90: 6265 2066 6c61 7474 656e 6564 2066 6f72  be flattened for
-00009ea0: 2074 6865 2067 7261 6420 7472 616e 7366   the grad transf
-00009eb0: 6f72 6d0a 2020 2020 2020 2020 6e65 7665  orm.        neve
-00009ec0: 725f 666c 6174 7465 6e3a 2073 6574 5b48  r_flatten: set[H
-00009ed0: 6173 6861 626c 655d 203d 207b 7072 696d  ashable] = {prim
-00009ee0: 732e 5072 696d 4944 732e 5245 5455 524e  s.PrimIDs.RETURN
-00009ef0: 2c20 7072 696d 732e 5072 696d 4944 732e  , prims.PrimIDs.
-00009f00: 554e 5041 434b 5f54 5249 5649 414c 7d0a  UNPACK_TRIVIAL}.
-00009f10: 0a20 2020 2020 2020 2064 6566 2073 686f  .        def sho
-00009f20: 756c 645f 666c 6174 7465 6e5f 666f 725f  uld_flatten_for_
-00009f30: 6772 6164 2862 7379 6d3a 2042 6f75 6e64  grad(bsym: Bound
-00009f40: 5379 6d62 6f6c 2920 2d3e 2062 6f6f 6c3a  Symbol) -> bool:
-00009f50: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00009f60: 6273 796d 2e73 796d 2e69 6420 696e 206e  bsym.sym.id in n
-00009f70: 6576 6572 5f66 6c61 7474 656e 3a0a 2020  ever_flatten:.  
-00009f80: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00009f90: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
-00009fa0: 2020 2020 2020 2020 6772 6164 666e 3a20          gradfn: 
-00009fb0: 4e6f 6e65 207c 2043 616c 6c61 626c 6520  None | Callable 
-00009fc0: 3d20 5f67 6574 5f67 7261 6466 6e28 6273  = _get_gradfn(bs
-00009fd0: 796d 2c20 6578 6563 7574 6f72 735f 6c69  ym, executors_li
-00009fe0: 7374 3d65 7865 6375 746f 7273 5f6c 6973  st=executors_lis
-00009ff0: 7429 0a20 2020 2020 2020 2020 2020 2072  t).            r
-0000a000: 6574 7572 6e20 6772 6164 666e 2069 7320  eturn gradfn is 
-0000a010: 4e6f 6e65 0a0a 2020 2020 2020 2020 2320  None..        # 
-0000a020: 544f 444f 2052 4331 3a20 6d61 7962 6520  TODO RC1: maybe 
-0000a030: 6d6f 7665 2074 6f20 7072 6f64 7563 6520  move to produce 
-0000a040: 7468 6573 6520 616c 7761 7973 206f 6e20  these always on 
-0000a050: 6372 6561 7469 6f6e 0a20 2020 2020 2020  creation.       
-0000a060: 2069 6620 7472 632e 6b77 6172 6773 2069   if trc.kwargs i
-0000a070: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0000a080: 2020 2020 7472 632e 6b77 6172 6773 203d      trc.kwargs =
-0000a090: 207b 7d0a 2020 2020 2020 2020 6966 2074   {}.        if t
-0000a0a0: 7263 2e66 6e20 6973 204e 6f6e 653a 0a20  rc.fn is None:. 
-0000a0b0: 2020 2020 2020 2020 2020 2074 7263 2e66             trc.f
-0000a0c0: 6e20 3d20 7472 632e 7079 7468 6f6e 5f63  n = trc.python_c
-0000a0d0: 616c 6c61 626c 6528 290a 0a20 2020 2020  allable()..     
-0000a0e0: 2020 2067 7261 6474 7263 203d 2066 726f     gradtrc = fro
-0000a0f0: 6d5f 7472 6163 6528 7472 6329 0a20 2020  m_trace(trc).   
-0000a100: 2020 2020 2066 6c61 7474 656e 6564 5f62       flattened_b
-0000a110: 7379 6d73 3a20 6c69 7374 5b42 6f75 6e64  syms: list[Bound
-0000a120: 5379 6d62 6f6c 5d20 3d20 666c 6174 7465  Symbol] = flatte
-0000a130: 6e5f 666f 725f 7472 616e 7366 6f72 6d28  n_for_transform(
-0000a140: 7368 6f75 6c64 5f66 6c61 7474 656e 5f66  should_flatten_f
-0000a150: 6f72 5f67 7261 642c 2074 7263 2e62 6f75  or_grad, trc.bou
-0000a160: 6e64 5f73 796d 626f 6c73 290a 2020 2020  nd_symbols).    
-0000a170: 2020 2020 6772 6164 7472 632e 626f 756e      gradtrc.boun
-0000a180: 645f 7379 6d62 6f6c 7320 3d20 666c 6174  d_symbols = flat
-0000a190: 7465 6e65 645f 6273 796d 730a 2020 2020  tened_bsyms.    
-0000a1a0: 2020 2020 6772 6164 7472 6320 3d20 6463      gradtrc = dc
-0000a1b0: 6528 6772 6164 7472 6329 0a0a 2020 2020  e(gradtrc)..    
-0000a1c0: 2020 2020 2320 5354 4550 2054 574f 202d      # STEP TWO -
-0000a1d0: 2d20 5265 706c 6163 6573 206f 7269 6769  - Replaces origi
-0000a1e0: 6e61 6c20 6361 6c6c 7320 7769 7468 2067  nal calls with g
-0000a1f0: 7261 6420 6361 6c6c 730a 0a20 2020 2020  rad calls..     
-0000a200: 2020 2023 2044 6566 696e 6573 2074 6865     # Defines the
-0000a210: 2076 6973 6974 6f72 2070 6174 7465 726e   visitor pattern
-0000a220: 2066 6f72 2074 6865 2066 6972 7374 2070   for the first p
-0000a230: 6173 7320 6f66 2074 6865 2067 7261 6420  ass of the grad 
-0000a240: 7472 616e 7366 6f72 6d2c 0a20 2020 2020  transform,.     
-0000a250: 2020 2023 2020 2077 6869 6368 2073 7761     #   which swa
-0000a260: 7073 2042 6f75 6e64 5379 6d62 6f6c 7320  ps BoundSymbols 
-0000a270: 7769 7468 2074 6865 6972 2067 7261 6420  with their grad 
-0000a280: 6675 6e63 7469 6f6e 730a 2020 2020 2020  functions.      
-0000a290: 2020 6465 6620 7669 7369 745f 2862 7379    def visit_(bsy
-0000a2a0: 6d3a 2042 6f75 6e64 5379 6d62 6f6c 2920  m: BoundSymbol) 
-0000a2b0: 2d3e 2043 616c 6c61 626c 653a 0a20 2020  -> Callable:.   
-0000a2c0: 2020 2020 2020 2020 2067 7261 6466 6e3a           gradfn:
-0000a2d0: 204e 6f6e 6520 7c20 4361 6c6c 6162 6c65   None | Callable
-0000a2e0: 203d 205f 6765 745f 6772 6164 666e 2862   = _get_gradfn(b
-0000a2f0: 7379 6d2c 2065 7865 6375 746f 7273 5f6c  sym, executors_l
-0000a300: 6973 743d 6578 6563 7574 6f72 735f 6c69  ist=executors_li
-0000a310: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
-0000a320: 6368 6563 6b28 0a20 2020 2020 2020 2020  check(.         
-0000a330: 2020 2020 2020 2067 7261 6466 6e20 6973         gradfn is
-0000a340: 206e 6f74 204e 6f6e 652c 0a20 2020 2020   not None,.     
-0000a350: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
-0000a360: 613a 2066 2246 6169 6c65 6420 746f 2066  a: f"Failed to f
-0000a370: 696e 6420 6120 6772 6164 666e 2066 6f72  ind a gradfn for
-0000a380: 207b 6273 796d 3d7d 2061 6674 6572 2066   {bsym=} after f
-0000a390: 6c61 7474 656e 696e 6722 2c0a 2020 2020  lattening",.    
-0000a3a0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0000a3b0: 7074 696f 6e5f 7479 7065 3d41 7373 6572  ption_type=Asser
-0000a3c0: 7469 6f6e 4572 726f 722c 0a20 2020 2020  tionError,.     
-0000a3d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000a3e0: 2020 2020 2072 6574 7572 6e20 6772 6164       return grad
-0000a3f0: 666e 0a0a 2020 2020 2020 2020 4077 7261  fn..        @wra
-0000a400: 7073 2874 7263 2e66 6e2e 6d65 7461 2069  ps(trc.fn.meta i
-0000a410: 6620 6973 696e 7374 616e 6365 2874 7263  f isinstance(trc
-0000a420: 2e66 6e2c 2053 796d 626f 6c29 2065 6c73  .fn, Symbol) els
-0000a430: 6520 7472 632e 666e 290a 2020 2020 2020  e trc.fn).      
-0000a440: 2020 6465 6620 696e 7465 7270 7265 7469    def interpreti
-0000a450: 6e67 5f66 6e28 2a61 7267 732c 202a 2a6b  ng_fn(*args, **k
-0000a460: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-0000a470: 2020 2020 7265 7375 6c74 203d 2065 7661      result = eva
-0000a480: 6c5f 7472 6163 6528 6772 6164 7472 632c  l_trace(gradtrc,
-0000a490: 202a 6172 6773 2c20 7379 6d62 6f6c 5f6d   *args, symbol_m
-0000a4a0: 6170 7065 723d 7669 7369 745f 2c20 2a2a  apper=visit_, **
-0000a4b0: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
-0000a4c0: 2020 2020 2320 5365 7473 2067 7261 6473      # Sets grads
-0000a4d0: 2066 6f72 206f 7574 7075 740a 2020 2020   for output.    
-0000a4e0: 2020 2020 2020 2020 2320 544f 444f 2054          # TODO T
-0000a4f0: 6869 7320 6566 6665 6374 6976 656c 7920  his effectively 
-0000a500: 7275 6e73 2069 6e20 6120 6e6f 2067 7261  runs in a no gra
-0000a510: 6420 636f 6e74 6578 7420 2d2d 2073 686f  d context -- sho
-0000a520: 756c 6420 6974 2072 756e 2069 6e20 6120  uld it run in a 
-0000a530: 6772 6164 2063 6f6e 7465 7874 2c0a 2020  grad context,.  
-0000a540: 2020 2020 2020 2020 2020 2320 2020 6f72            #   or
-0000a550: 2073 686f 756c 6420 7468 6572 6520 6265   should there be
-0000a560: 2074 6865 206f 7074 696f 6e20 746f 2072   the option to r
-0000a570: 756e 2069 7420 696e 2061 2067 7261 6420  un it in a grad 
-0000a580: 636f 6e74 6578 743f 0a20 2020 2020 2020  context?.       
-0000a590: 2020 2020 2067 7261 645f 7370 6563 6966       grad_specif
-0000a5a0: 6965 7228 7265 7375 6c74 290a 2020 2020  ier(result).    
-0000a5b0: 2020 2020 2020 2020 2320 436f 6e73 7472          # Constr
-0000a5c0: 7563 7473 2072 6574 7572 6e20 7661 6c75  ucts return valu
-0000a5d0: 650a 2020 2020 2020 2020 2020 2020 666c  e.            fl
-0000a5e0: 6174 5f67 7261 6473 203d 2067 7261 645f  at_grads = grad_
-0000a5f0: 6f75 745f 7370 6563 6966 6965 7228 2861  out_specifier((a
-0000a600: 7267 732c 206b 7761 7267 7329 290a 2020  rgs, kwargs)).  
-0000a610: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000a620: 2066 6c61 745f 6772 6164 730a 0a20 2020   flat_grads..   
-0000a630: 2020 2020 2023 204e 4f54 4520 4166 7465       # NOTE Afte
-0000a640: 7220 7468 6973 2063 616c 6c20 7468 6520  r this call the 
-0000a650: 6772 6164 7472 6320 6973 2069 6e76 616c  gradtrc is inval
-0000a660: 6964 2c20 6265 6361 7573 653a 0a20 2020  id, because:.   
-0000a670: 2020 2020 2023 2020 2031 2920 5468 6520       #   1) The 
-0000a680: 6e6f 6e2d 6578 6563 7574 6162 6c65 2070  non-executable p
-0000a690: 7574 5f67 7261 6420 6f70 6572 6174 696f  ut_grad operatio
-0000a6a0: 6e73 2061 7265 2073 7469 6c6c 2069 6e20  ns are still in 
-0000a6b0: 7468 6520 7472 6163 652c 2061 6e64 206d  the trace, and m
-0000a6c0: 756c 7469 706c 6520 6361 6c6c 7320 746f  ultiple calls to
-0000a6d0: 2070 7574 2067 7261 6420 6172 6520 6e6f   put grad are no
-0000a6e0: 7420 6163 6375 6d75 6c61 7465 640a 2020  t accumulated.  
-0000a6f0: 2020 2020 2020 2320 2020 3229 2054 6865        #   2) The
-0000a700: 206e 6f6e 2d65 7865 6375 7461 626c 6520   non-executable 
-0000a710: 6765 745f 6772 6164 206f 7065 7261 7469  get_grad operati
-0000a720: 6f6e 7320 6172 6520 7374 696c 6c20 696e  ons are still in
-0000a730: 2074 6865 2074 7261 6365 2c20 616e 6420   the trace, and 
-0000a740: 7468 6579 206d 6179 2070 726f 6475 6365  they may produce
-0000a750: 2064 6966 6665 7265 6e74 2070 726f 7869   different proxi
-0000a760: 6573 2077 6865 6e0a 2020 2020 2020 2020  es when.        
-0000a770: 2320 2020 2020 2020 6361 6c6c 6564 206f  #       called o
-0000a780: 6e20 7468 6520 7361 6d65 2069 6e70 7574  n the same input
-0000a790: 730a 2020 2020 2020 2020 2320 2020 3329  s.        #   3)
-0000a7a0: 2054 6865 206f 7065 7261 7469 6f6e 7320   The operations 
-0000a7b0: 6172 6520 6e6f 7420 696e 2061 2076 616c  are not in a val
-0000a7c0: 6964 206f 7264 6572 0a20 2020 2020 2020  id order.       
-0000a7d0: 2067 7261 6474 7263 203d 2063 6f6e 7374   gradtrc = const
-0000a7e0: 7275 6374 5f74 7261 6365 280a 2020 2020  ruct_trace(.    
-0000a7f0: 2020 2020 2020 2020 7265 6e61 6d65 5f70          rename_p
-0000a800: 726f 7869 6573 3d46 616c 7365 2c0a 2020  roxies=False,.  
-0000a810: 2020 2020 2020 2020 2020 7573 655f 6463            use_dc
-0000a820: 653d 4661 6c73 652c 0a20 2020 2020 2020  e=False,.       
-0000a830: 2029 2869 6e74 6572 7072 6574 696e 675f   )(interpreting_
-0000a840: 666e 2c20 2a67 7261 6474 7263 2e61 7267  fn, *gradtrc.arg
-0000a850: 732c 202a 2a67 7261 6474 7263 2e6b 7761  s, **gradtrc.kwa
-0000a860: 7267 7329 0a20 2020 2020 2020 2067 7261  rgs).        gra
-0000a870: 6474 7263 2e73 636f 7065 7320 3d20 5b67  dtrc.scopes = [g
-0000a880: 7261 6474 7263 2e62 6f75 6e64 5f73 796d  radtrc.bound_sym
-0000a890: 626f 6c73 5d0a 2020 2020 2020 2020 6772  bols].        gr
-0000a8a0: 6164 7472 632e 5f63 6f6d 706c 6574 6520  adtrc._complete 
-0000a8b0: 3d20 4661 6c73 650a 0a20 2020 2020 2020  = False..       
-0000a8c0: 2023 2053 5445 5020 5448 5245 4520 2d2d   # STEP THREE --
-0000a8d0: 2048 616e 646c 6573 2070 7574 5f67 7261   Handles put_gra
-0000a8e0: 6420 616e 6420 6765 745f 6772 6164 206f  d and get_grad o
-0000a8f0: 7065 7261 7469 6f6e 7320 616e 6420 6163  perations and ac
-0000a900: 6375 6d75 6c61 7465 7320 6772 6164 6965  cumulates gradie
-0000a910: 6e74 730a 0a20 2020 2020 2020 2023 2041  nts..        # A
-0000a920: 6363 756d 756c 6174 6573 2067 7261 6469  ccumulates gradi
-0000a930: 656e 7473 2c20 6372 6561 7469 6e67 2074  ents, creating t
-0000a940: 6865 2070 7269 6d61 6c20 2d3e 2061 6363  he primal -> acc
-0000a950: 756d 756c 6174 6564 2067 7261 6420 6d61  umulated grad ma
-0000a960: 7070 696e 670a 2020 2020 2020 2020 2320  pping.        # 
-0000a970: 5365 7473 2074 6865 2074 7261 6369 6e67  Sets the tracing
-0000a980: 2063 6f6e 7465 7874 2073 6f20 6163 6375   context so accu
-0000a990: 6d75 6c61 7469 6f6e 206f 7065 7261 7469  mulation operati
-0000a9a0: 6f6e 7320 6172 6520 7265 636f 7264 6564  ons are recorded
-0000a9b0: 2069 6e74 6f20 7468 6520 7472 6163 650a   into the trace.
-0000a9c0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000a9d0: 2020 2020 2020 2020 2074 7261 6365 6374           tracect
-0000a9e0: 785f 746f 6b20 3d20 7365 745f 7472 6163  x_tok = set_trac
-0000a9f0: 6563 7478 2867 7261 6474 7263 290a 0a20  ectx(gradtrc).. 
-0000aa00: 2020 2020 2020 2020 2020 2023 204d 6170             # Map
-0000aa10: 7320 7072 696d 616c 7320 746f 2074 6865  s primals to the
-0000aa20: 6972 2067 7261 6469 656e 7473 2028 7768  ir gradients (wh
-0000aa30: 6963 6820 6172 6520 7265 7475 726e 6564  ich are returned
-0000aa40: 2066 726f 6d20 6361 6c6c 696e 6720 6765   from calling ge
-0000aa50: 745f 6772 6164 206f 6e20 7468 6520 7072  t_grad on the pr
-0000aa60: 696d 616c 290a 2020 2020 2020 2020 2020  imal).          
-0000aa70: 2020 7072 696d 616c 735f 746f 5f67 696e    primals_to_gin
-0000aa80: 7075 745f 6d61 703a 2064 6963 745b 5661  put_map: dict[Va
-0000aa90: 7269 6162 6c65 2c20 5465 6e73 6f72 5072  riable, TensorPr
-0000aaa0: 6f78 795d 203d 207b 7d0a 0a20 2020 2020  oxy] = {}..     
-0000aab0: 2020 2020 2020 2023 2048 616e 646c 6573         # Handles
-0000aac0: 2070 7574 5f67 7261 6420 6f70 6572 6174   put_grad operat
-0000aad0: 696f 6e73 0a20 2020 2020 2020 2020 2020  ions.           
-0000aae0: 2023 204e 4f54 4520 5468 6973 206d 6f64   # NOTE This mod
-0000aaf0: 6966 6965 7320 6120 6c69 7374 2074 6861  ifies a list tha
-0000ab00: 7420 6973 2062 6569 6e67 2065 6e75 6d65  t is being enume
-0000ab10: 7261 7465 6420 6f76 6572 2c20 6275 7420  rated over, but 
-0000ab20: 6974 2773 204f 4b20 6265 6361 7573 6520  it's OK because 
-0000ab30: 7765 2772 6520 6f6e 6c79 0a20 2020 2020  we're only.     
-0000ab40: 2020 2020 2020 2023 2020 2061 7070 656e         #   appen
-0000ab50: 6469 6e67 2074 6f20 7468 6520 656e 6420  ding to the end 
-0000ab60: 6f66 2074 6865 206c 6973 740a 2020 2020  of the list.    
-0000ab70: 2020 2020 2020 2020 6273 796d 3a20 426f          bsym: Bo
-0000ab80: 756e 6453 796d 626f 6c0a 2020 2020 2020  undSymbol.      
-0000ab90: 2020 2020 2020 666f 7220 6273 796d 2069        for bsym i
-0000aba0: 6e20 6772 6164 7472 632e 626f 756e 645f  n gradtrc.bound_
-0000abb0: 7379 6d62 6f6c 733a 0a20 2020 2020 2020  symbols:.       
-0000abc0: 2020 2020 2020 2020 2069 643a 2048 6173           id: Has
-0000abd0: 6861 626c 6520 3d20 6273 796d 2e73 796d  hable = bsym.sym
-0000abe0: 2e69 640a 2020 2020 2020 2020 2020 2020  .id.            
-0000abf0: 2020 2020 6966 2069 6420 6973 2070 6964      if id is pid
-0000ac00: 732e 5055 545f 4752 4144 3a0a 2020 2020  s.PUT_GRAD:.    
-0000ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac20: 7072 696d 616c 3a20 4e75 6d62 6572 207c  primal: Number |
-0000ac30: 2054 656e 736f 7250 726f 7879 0a20 2020   TensorProxy.   
-0000ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac50: 2067 7261 643a 204e 756d 6265 7220 7c20   grad: Number | 
-0000ac60: 5465 6e73 6f72 5072 6f78 790a 2020 2020  TensorProxy.    
-0000ac70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac80: 7072 696d 616c 2c20 6772 6164 203d 2062  primal, grad = b
-0000ac90: 7379 6d2e 666c 6174 5f61 7267 730a 0a20  sym.flat_args.. 
-0000aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000acb0: 2020 2023 2054 4f44 4f20 5375 7070 6f72     # TODO Suppor
-0000acc0: 7420 6175 746f 6772 6164 206f 6e20 6e75  t autograd on nu
-0000acd0: 6d62 6572 730a 2020 2020 2020 2020 2020  mbers.          
-0000ace0: 2020 2020 2020 2020 2020 2320 4669 6c74            # Filt
-0000acf0: 6572 7320 6361 6c6c 7320 746f 2070 7574  ers calls to put
-0000ad00: 5f67 7261 6420 7468 6174 2077 6f75 6c64  _grad that would
-0000ad10: 2070 7574 2061 2067 7261 6420 6f6e 2061   put a grad on a
-0000ad20: 206e 6f6e 2d74 656e 736f 7220 6f72 2061   non-tensor or a
-0000ad30: 2074 656e 736f 7220 7468 6174 2064 6f65   tensor that doe
-0000ad40: 736e 2774 2072 6571 7569 7265 2067 7261  sn't require gra
-0000ad50: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-0000ad60: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
-0000ad70: 6e73 7461 6e63 6528 7072 696d 616c 2c20  nstance(primal, 
-0000ad80: 5465 6e73 6f72 5072 6f78 7929 206f 7220  TensorProxy) or 
-0000ad90: 6e6f 7420 7072 696d 616c 2e72 6571 7569  not primal.requi
-0000ada0: 7265 735f 6772 6164 3a0a 2020 2020 2020  res_grad:.      
-0000adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000adc0: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
-0000add0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ade0: 2320 544f 444f 2053 7570 706f 7274 2063  # TODO Support c
-0000adf0: 6f6d 706c 6578 2061 7574 6f67 7261 640a  omplex autograd.
-0000ae00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae10: 2020 2020 6368 6563 6b28 0a20 2020 2020      check(.     
-0000ae20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae30: 2020 206e 6f74 2064 7479 7065 732e 6973     not dtypes.is
-0000ae40: 5f63 6f6d 706c 6578 5f64 7479 7065 2864  _complex_dtype(d
-0000ae50: 7479 7065 732e 746f 5f64 7479 7065 2870  types.to_dtype(p
-0000ae60: 7269 6d61 6c29 292c 0a20 2020 2020 2020  rimal)),.       
-0000ae70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae80: 206c 616d 6264 613a 2066 2243 6f6d 706c   lambda: f"Compl
-0000ae90: 6578 2067 7261 6420 6973 206e 6f74 2073  ex grad is not s
-0000aea0: 7570 706f 7274 6564 2079 6574 222c 0a20  upported yet",. 
-0000aeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aec0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-0000aed0: 2020 2020 2020 2020 2020 7670 7269 6d61            vprima
-0000aee0: 6c3a 2056 6172 6961 626c 6520 3d20 7661  l: Variable = va
-0000aef0: 7269 6162 6c65 6966 7928 7072 696d 616c  riableify(primal
-0000af00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000af10: 2020 2020 2020 6163 6375 6d3a 204e 6f6e        accum: Non
-0000af20: 6520 7c20 5465 6e73 6f72 5072 6f78 7920  e | TensorProxy 
-0000af30: 3d20 7072 696d 616c 735f 746f 5f67 696e  = primals_to_gin
-0000af40: 7075 745f 6d61 702e 6765 7428 7670 7269  put_map.get(vpri
-0000af50: 6d61 6c2c 204e 6f6e 6529 0a0a 2020 2020  mal, None)..    
-0000af60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af70: 6966 2061 6363 756d 2069 7320 4e6f 6e65  if accum is None
-0000af80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000af90: 2020 2020 2020 2020 2020 7072 696d 616c            primal
-0000afa0: 735f 746f 5f67 696e 7075 745f 6d61 705b  s_to_ginput_map[
-0000afb0: 7670 7269 6d61 6c5d 203d 2067 7261 640a  vprimal] = grad.
+00003d10: 7320 3d20 6765 7461 7474 7228 6366 6e2c  s = getattr(cfn,
+00003d20: 2022 5f6c 635f 6373 222c 204e 6f6e 6529   "_lc_cs", None)
+00003d30: 0a20 2020 2069 6620 6373 2069 7320 4e6f  .    if cs is No
+00003d40: 6e65 3a0a 2020 2020 2020 2020 6373 203d  ne:.        cs =
+00003d50: 2043 6f6d 7069 6c65 5374 6174 7328 290a   CompileStats().
+00003d60: 0a20 2020 2074 7261 6e73 666f 726d 7320  .    transforms 
+00003d70: 3d20 6366 6e2e 5f6c 635f 7472 616e 7366  = cfn._lc_transf
+00003d80: 6f72 6d73 202b 205b 7472 616e 7366 6f72  orms + [transfor
+00003d90: 6d5d 0a20 2020 2070 6f74 7261 6e73 666f  m].    potransfo
+00003da0: 726d 7320 3d20 6366 6e2e 5f6c 635f 706f  rms = cfn._lc_po
+00003db0: 7374 5f6f 7074 696d 697a 6174 696f 6e5f  st_optimization_
+00003dc0: 7472 616e 7366 6f72 6d73 0a20 2020 2075  transforms.    u
+00003dd0: 7369 6e67 5f67 7261 645f 7472 616e 7366  sing_grad_transf
+00003de0: 6f72 6d20 3d20 6366 6e2e 5f75 7369 6e67  orm = cfn._using
+00003df0: 5f67 7261 645f 7472 616e 7366 6f72 6d0a  _grad_transform.
+00003e00: 0a20 2020 206e 6366 6e20 3d20 5f63 7265  .    ncfn = _cre
+00003e10: 6174 655f 6361 6c6c 6162 6c65 280a 2020  ate_callable(.  
+00003e20: 2020 2020 2020 6364 2c0a 2020 2020 2020        cd,.      
+00003e30: 2020 6373 2c0a 2020 2020 2020 2020 7472    cs,.        tr
+00003e40: 616e 7366 6f72 6d73 3d74 7261 6e73 666f  ansforms=transfo
+00003e50: 726d 732c 0a20 2020 2020 2020 2070 6f73  rms,.        pos
+00003e60: 745f 6f70 7469 6d69 7a61 7469 6f6e 5f74  t_optimization_t
+00003e70: 7261 6e73 666f 726d 733d 706f 7472 616e  ransforms=potran
+00003e80: 7366 6f72 6d73 2c0a 2020 2020 2020 2020  sforms,.        
+00003e90: 5f75 7369 6e67 5f67 7261 645f 7472 616e  _using_grad_tran
+00003ea0: 7366 6f72 6d3d 7573 696e 675f 6772 6164  sform=using_grad
+00003eb0: 5f74 7261 6e73 666f 726d 2c0a 2020 2020  _transform,.    
+00003ec0: 290a 2020 2020 7265 7475 726e 206e 6366  ).    return ncf
+00003ed0: 6e0a 0a0a 2320 544f 444f 2043 6f6e 7369  n...# TODO Consi
+00003ee0: 6465 7220 7265 6661 6374 6f72 696e 6720  der refactoring 
+00003ef0: 7468 6973 2077 6974 6820 7468 6520 6162  this with the ab
+00003f00: 6f76 650a 2320 4865 6c70 6572 2066 756e  ove.# Helper fun
+00003f10: 6374 696f 6e20 746f 2061 6464 2061 2070  ction to add a p
+00003f20: 6f73 742d 6f70 7469 6d69 7a61 7469 6f6e  ost-optimization
+00003f30: 2074 7261 6e73 666f 726d 0a64 6566 2061   transform.def a
+00003f40: 6464 5f70 6f73 745f 6f70 7469 6d69 7a61  dd_post_optimiza
+00003f50: 7469 6f6e 5f74 7261 6e73 666f 726d 2863  tion_transform(c
+00003f60: 666e 3a20 4361 6c6c 6162 6c65 2c20 7472  fn: Callable, tr
+00003f70: 616e 7366 6f72 6d3a 2043 616c 6c61 626c  ansform: Callabl
+00003f80: 6529 202d 3e20 4361 6c6c 6162 6c65 3a0a  e) -> Callable:.
+00003f90: 2020 2020 6672 6f6d 2074 6875 6e64 6572      from thunder
+00003fa0: 2e63 6f6d 6d6f 6e20 696d 706f 7274 205f  .common import _
+00003fb0: 6372 6561 7465 5f63 616c 6c61 626c 652c  create_callable,
+00003fc0: 2043 6f6d 7069 6c65 4461 7461 2c20 436f   CompileData, Co
+00003fd0: 6d70 696c 6553 7461 7473 0a0a 2020 2020  mpileStats..    
+00003fe0: 6364 3a20 4e6f 6e65 207c 2041 6e79 203d  cd: None | Any =
+00003ff0: 2067 6574 6174 7472 2863 666e 2c20 225f   getattr(cfn, "_
+00004000: 6c63 5f63 6422 2c20 4e6f 6e65 290a 0a20  lc_cd", None).. 
+00004010: 2020 2075 7469 6c73 2e63 6865 636b 2863     utils.check(c
+00004020: 6420 6973 206e 6f74 204e 6f6e 652c 206c  d is not None, l
+00004030: 616d 6264 613a 2066 2243 616e 206f 6e6c  ambda: f"Can onl
+00004040: 7920 7472 616e 7366 6f72 6d20 636f 6d70  y transform comp
+00004050: 696c 6564 2074 6875 6e64 6572 2066 756e  iled thunder fun
+00004060: 6374 696f 6e73 2229 0a20 2020 2075 7469  ctions").    uti
+00004070: 6c73 2e63 6865 636b 2869 7369 6e73 7461  ls.check(isinsta
+00004080: 6e63 6528 6364 2c20 436f 6d70 696c 6544  nce(cd, CompileD
+00004090: 6174 6129 2c20 6c61 6d62 6461 3a20 6622  ata), lambda: f"
+000040a0: 466f 756e 6420 616e 2075 6e6b 6e6f 776e  Found an unknown
+000040b0: 2063 6f6d 7069 6c65 2064 6174 6120 6174   compile data at
+000040c0: 7472 6962 7574 6520 7b63 647d 2229 0a0a  tribute {cd}")..
+000040d0: 2020 2020 6373 203d 2043 6f6d 7069 6c65      cs = Compile
+000040e0: 5374 6174 7328 290a 2020 2020 7472 616e  Stats().    tran
+000040f0: 7366 6f72 6d73 203d 2063 666e 2e5f 6c63  sforms = cfn._lc
+00004100: 5f74 7261 6e73 666f 726d 730a 2020 2020  _transforms.    
+00004110: 706f 7472 616e 7366 6f72 6d73 203d 2063  potransforms = c
+00004120: 666e 2e5f 6c63 5f70 6f73 745f 6f70 7469  fn._lc_post_opti
+00004130: 6d69 7a61 7469 6f6e 5f74 7261 6e73 666f  mization_transfo
+00004140: 726d 7320 2b20 5b74 7261 6e73 666f 726d  rms + [transform
+00004150: 5d0a 0a20 2020 206e 6366 6e20 3d20 5f63  ]..    ncfn = _c
+00004160: 7265 6174 655f 6361 6c6c 6162 6c65 2863  reate_callable(c
+00004170: 642c 2063 732c 2074 7261 6e73 666f 726d  d, cs, transform
+00004180: 733d 7472 616e 7366 6f72 6d73 2c20 706f  s=transforms, po
+00004190: 7374 5f6f 7074 696d 697a 6174 696f 6e5f  st_optimization_
+000041a0: 7472 616e 7366 6f72 6d73 3d70 6f74 7261  transforms=potra
+000041b0: 6e73 666f 726d 7329 0a20 2020 2072 6574  nsforms).    ret
+000041c0: 7572 6e20 6e63 666e 0a0a 0a23 2054 6865  urn ncfn...# The
+000041d0: 206e 6f2d 6f70 2074 7261 6e73 666f 726d   no-op transform
+000041e0: 2e20 4120 7472 6976 6961 6c20 636f 6d70  . A trivial comp
+000041f0: 6f73 6162 6c65 2074 7261 6e73 666f 726d  osable transform
+00004200: 2c20 6f6e 6c79 2075 7365 6675 6c20 6173  , only useful as
+00004210: 2061 6e20 6578 616d 706c 652e 0a64 6566   an example..def
+00004220: 205f 6e6f 6f70 5f74 7261 6e73 666f 726d   _noop_transform
+00004230: 2874 7261 6365 3a20 5472 6163 652c 202a  (trace: Trace, *
+00004240: 2a6b 7761 7267 7329 202d 3e20 5472 6163  *kwargs) -> Trac
+00004250: 653a 0a20 2020 2073 7461 7274 5f74 696d  e:.    start_tim
+00004260: 655f 6e73 203d 2074 696d 652e 7469 6d65  e_ns = time.time
+00004270: 5f6e 7328 290a 2020 2020 6e6f 6f70 5f74  _ns().    noop_t
+00004280: 7261 6365 203d 2066 726f 6d5f 7472 6163  race = from_trac
+00004290: 6528 7472 6163 6529 0a0a 2020 2020 7472  e(trace)..    tr
+000042a0: 6163 6563 7478 5f74 6f6b 3a20 416e 790a  acectx_tok: Any.
+000042b0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+000042c0: 2074 7261 6365 6374 785f 746f 6b20 3d20   tracectx_tok = 
+000042d0: 7365 745f 7472 6163 6563 7478 286e 6f6f  set_tracectx(noo
+000042e0: 705f 7472 6163 6529 0a20 2020 2020 2020  p_trace).       
+000042f0: 2070 7269 6d73 2e63 6f6d 6d65 6e74 2822   prims.comment("
+00004300: 5468 6973 2063 6f6d 6d65 6e74 2061 6464  This comment add
+00004310: 6564 2062 7920 7468 6520 6e6f 2d6f 7020  ed by the no-op 
+00004320: 7472 616e 7366 6f72 6d22 290a 2020 2020  transform").    
+00004330: 6669 6e61 6c6c 793a 0a20 2020 2020 2020  finally:.       
+00004340: 2072 6573 6574 5f74 7261 6365 6374 7828   reset_tracectx(
+00004350: 7472 6163 6563 7478 5f74 6f6b 290a 0a20  tracectx_tok).. 
+00004360: 2020 206e 6f6f 705f 7472 6163 652e 626f     noop_trace.bo
+00004370: 756e 645f 7379 6d62 6f6c 732e 6578 7465  und_symbols.exte
+00004380: 6e64 2874 7261 6365 2e62 6f75 6e64 5f73  nd(trace.bound_s
+00004390: 796d 626f 6c73 290a 0a20 2020 2065 6e64  ymbols)..    end
+000043a0: 5f74 696d 655f 6e73 203d 2074 696d 652e  _time_ns = time.
+000043b0: 7469 6d65 5f6e 7328 290a 2020 2020 656c  time_ns().    el
+000043c0: 6170 7365 645f 7469 6d65 5f6e 7320 3d20  apsed_time_ns = 
+000043d0: 656e 645f 7469 6d65 5f6e 7320 2d20 7374  end_time_ns - st
+000043e0: 6172 745f 7469 6d65 5f6e 730a 2020 2020  art_time_ns.    
+000043f0: 656c 6170 7365 645f 7469 6d65 5f6d 696c  elapsed_time_mil
+00004400: 6c69 7320 3d20 656c 6170 7365 645f 7469  lis = elapsed_ti
+00004410: 6d65 5f6e 7320 2f2f 2031 3030 3030 3030  me_ns // 1000000
+00004420: 0a20 2020 206e 6f6f 705f 7472 6163 652e  .    noop_trace.
+00004430: 7365 745f 7072 6f76 656e 616e 6365 2854  set_provenance(T
+00004440: 7261 6365 5072 6f76 656e 616e 6365 2866  raceProvenance(f
+00004450: 224e 6f2d 6f70 2054 7261 6e73 666f 726d  "No-op Transform
+00004460: 2028 746f 6f6b 207b 656c 6170 7365 645f   (took {elapsed_
+00004470: 7469 6d65 5f6d 696c 6c69 737d 206d 696c  time_millis} mil
+00004480: 6c69 7365 636f 6e64 7329 2229 290a 0a20  liseconds)")).. 
+00004490: 2020 2072 6574 7572 6e20 6e6f 6f70 5f74     return noop_t
+000044a0: 7261 6365 0a0a 0a64 6566 206e 6f6f 7028  race...def noop(
+000044b0: 6366 6e3a 2043 616c 6c61 626c 6529 202d  cfn: Callable) -
+000044c0: 3e20 4361 6c6c 6162 6c65 3a0a 2020 2020  > Callable:.    
+000044d0: 7265 7475 726e 2061 6464 5f74 7261 6e73  return add_trans
+000044e0: 666f 726d 2863 666e 2c20 5f6e 6f6f 705f  form(cfn, _noop_
+000044f0: 7472 616e 7366 6f72 6d29 0a0a 0a23 2054  transform)...# T
+00004500: 6865 2063 6f6d 6d65 6e74 2066 7573 696f  he comment fusio
+00004510: 6e73 2074 7261 6e73 666f 726d 2e20 4a75  ns transform. Ju
+00004520: 7374 2061 6464 7320 6120 636f 6d6d 656e  st adds a commen
+00004530: 7420 6265 666f 7265 2061 6e64 2061 6674  t before and aft
+00004540: 6572 2065 6163 6820 6675 7369 6f6e 2e0a  er each fusion..
+00004550: 2320 2020 5468 6973 2069 7320 616e 2065  #   This is an e
+00004560: 7861 6d70 6c65 206f 6620 6120 706f 7374  xample of a post
+00004570: 2d6f 7074 696d 697a 6174 696f 6e20 7472  -optimization tr
+00004580: 616e 7366 6f72 6d2e 0a64 6566 205f 636f  ansform..def _co
+00004590: 6d6d 656e 745f 6675 7369 6f6e 735f 7472  mment_fusions_tr
+000045a0: 616e 7366 6f72 6d28 7472 6163 653a 2054  ansform(trace: T
+000045b0: 7261 6365 2c20 2a2a 6b77 6172 6773 2920  race, **kwargs) 
+000045c0: 2d3e 2054 7261 6365 3a0a 2020 2020 7374  -> Trace:.    st
+000045d0: 6172 745f 7469 6d65 5f6e 7320 3d20 7469  art_time_ns = ti
+000045e0: 6d65 2e74 696d 655f 6e73 2829 0a20 2020  me.time_ns().   
+000045f0: 2063 6f6d 6d65 6e74 6564 5f74 7261 6365   commented_trace
+00004600: 203d 2066 726f 6d5f 7472 6163 6528 7472   = from_trace(tr
+00004610: 6163 6529 0a0a 2020 2020 6e62 7379 6d73  ace)..    nbsyms
+00004620: 3a20 6c69 7374 5b42 6f75 6e64 5379 6d62  : list[BoundSymb
+00004630: 6f6c 5d20 3d20 5b5d 0a20 2020 2066 6f72  ol] = [].    for
+00004640: 2062 7379 6d20 696e 2074 7261 6365 2e62   bsym in trace.b
+00004650: 6f75 6e64 5f73 796d 626f 6c73 3a0a 2020  ound_symbols:.  
+00004660: 2020 2020 2020 6966 2062 7379 6d2e 7379        if bsym.sy
+00004670: 6d2e 6973 5f66 7573 696f 6e3a 0a20 2020  m.is_fusion:.   
+00004680: 2020 2020 2020 2020 2066 7573 696f 6e5f           fusion_
+00004690: 6e61 6d65 203d 2062 7379 6d2e 7379 6d2e  name = bsym.sym.
+000046a0: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
+000046b0: 2070 7265 5f63 6f6d 6d65 6e74 5f62 7379   pre_comment_bsy
+000046c0: 6d20 3d20 7072 696d 732e 636f 6d6d 656e  m = prims.commen
+000046d0: 742e 6269 6e64 2866 2242 6566 6f72 6520  t.bind(f"Before 
+000046e0: 7b66 7573 696f 6e5f 6e61 6d65 7d22 2c20  {fusion_name}", 
+000046f0: 6f75 7470 7574 3d4e 6f6e 6529 0a20 2020  output=None).   
+00004700: 2020 2020 2020 2020 2070 6f73 745f 636f           post_co
+00004710: 6d6d 656e 745f 6273 796d 203d 2070 7269  mment_bsym = pri
+00004720: 6d73 2e63 6f6d 6d65 6e74 2e62 696e 6428  ms.comment.bind(
+00004730: 6622 4166 7465 7220 7b66 7573 696f 6e5f  f"After {fusion_
+00004740: 6e61 6d65 7d22 2c20 6f75 7470 7574 3d4e  name}", output=N
+00004750: 6f6e 6529 0a0a 2020 2020 2020 2020 2020  one)..          
+00004760: 2020 6e62 7379 6d73 2e65 7874 656e 6428    nbsyms.extend(
+00004770: 5b70 7265 5f63 6f6d 6d65 6e74 5f62 7379  [pre_comment_bsy
+00004780: 6d2c 2062 7379 6d2c 2070 6f73 745f 636f  m, bsym, post_co
+00004790: 6d6d 656e 745f 6273 796d 5d29 0a20 2020  mment_bsym]).   
+000047a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000047b0: 2020 2020 2020 206e 6273 796d 732e 6170         nbsyms.ap
+000047c0: 7065 6e64 2862 7379 6d29 0a0a 2020 2020  pend(bsym)..    
+000047d0: 636f 6d6d 656e 7465 645f 7472 6163 652e  commented_trace.
+000047e0: 626f 756e 645f 7379 6d62 6f6c 7320 3d20  bound_symbols = 
+000047f0: 6e62 7379 6d73 0a20 2020 2065 6e64 5f74  nbsyms.    end_t
+00004800: 696d 655f 6e73 203d 2074 696d 652e 7469  ime_ns = time.ti
+00004810: 6d65 5f6e 7328 290a 2020 2020 656c 6170  me_ns().    elap
+00004820: 7365 645f 7469 6d65 5f6e 7320 3d20 656e  sed_time_ns = en
+00004830: 645f 7469 6d65 5f6e 7320 2d20 7374 6172  d_time_ns - star
+00004840: 745f 7469 6d65 5f6e 730a 2020 2020 656c  t_time_ns.    el
+00004850: 6170 7365 645f 7469 6d65 5f6d 696c 6c69  apsed_time_milli
+00004860: 7320 3d20 656c 6170 7365 645f 7469 6d65  s = elapsed_time
+00004870: 5f6e 7320 2f2f 2031 3030 3030 3030 0a0a  _ns // 1000000..
+00004880: 2020 2020 636f 6d6d 656e 7465 645f 7472      commented_tr
+00004890: 6163 652e 7365 745f 7072 6f76 656e 616e  ace.set_provenan
+000048a0: 6365 2854 7261 6365 5072 6f76 656e 616e  ce(TraceProvenan
+000048b0: 6365 2866 2243 6f6d 6d65 6e74 2046 7573  ce(f"Comment Fus
+000048c0: 696f 6e73 2028 746f 6f6b 207b 656c 6170  ions (took {elap
+000048d0: 7365 645f 7469 6d65 5f6d 696c 6c69 737d  sed_time_millis}
+000048e0: 206d 696c 6c69 7365 636f 6e64 7329 2229   milliseconds)")
+000048f0: 290a 0a20 2020 2072 6574 7572 6e20 636f  )..    return co
+00004900: 6d6d 656e 7465 645f 7472 6163 650a 0a0a  mmented_trace...
+00004910: 6465 6620 636f 6d6d 656e 745f 6675 7369  def comment_fusi
+00004920: 6f6e 7328 6366 6e3a 2043 616c 6c61 626c  ons(cfn: Callabl
+00004930: 6529 202d 3e20 4361 6c6c 6162 6c65 3a0a  e) -> Callable:.
+00004940: 2020 2020 7265 7475 726e 2061 6464 5f70      return add_p
+00004950: 6f73 745f 6f70 7469 6d69 7a61 7469 6f6e  ost_optimization
+00004960: 5f74 7261 6e73 666f 726d 2863 666e 2c20  _transform(cfn, 
+00004970: 5f63 6f6d 6d65 6e74 5f66 7573 696f 6e73  _comment_fusions
+00004980: 5f74 7261 6e73 666f 726d 290a 0a0a 230a  _transform)...#.
+00004990: 2320 4865 6c70 6572 2066 756e 6374 696f  # Helper functio
+000049a0: 6e73 2066 6f72 2063 6f6d 706f 7361 626c  ns for composabl
+000049b0: 6520 7472 616e 7366 6f72 6d73 0a23 0a0a  e transforms.#..
+000049c0: 0a23 2046 6c61 7474 656e 7320 6120 6c69  .# Flattens a li
+000049d0: 7374 206f 6620 626f 756e 6420 7379 6d62  st of bound symb
+000049e0: 6f6c 732c 2072 6574 7572 6e69 6e67 2074  ols, returning t
+000049f0: 6865 2066 6c61 7474 656e 6564 206c 6973  he flattened lis
+00004a00: 740a 6465 6620 666c 6174 7465 6e5f 666f  t.def flatten_fo
+00004a10: 725f 7472 616e 7366 6f72 6d28 7368 6f75  r_transform(shou
+00004a20: 6c64 5f66 6c61 7474 656e 3a20 4361 6c6c  ld_flatten: Call
+00004a30: 6162 6c65 2c20 6273 796d 733a 206c 6973  able, bsyms: lis
+00004a40: 745b 426f 756e 6453 796d 626f 6c5d 2920  t[BoundSymbol]) 
+00004a50: 2d3e 206c 6973 745b 426f 756e 6453 796d  -> list[BoundSym
+00004a60: 626f 6c5d 3a0a 2020 2020 666c 6174 7465  bol]:.    flatte
+00004a70: 6e65 643a 206c 6973 745b 426f 756e 6453  ned: list[BoundS
+00004a80: 796d 626f 6c5d 203d 205b 5d0a 0a20 2020  ymbol] = []..   
+00004a90: 2064 6566 205f 666c 6174 7465 6e28 6273   def _flatten(bs
+00004aa0: 796d 3a20 426f 756e 6453 796d 626f 6c29  ym: BoundSymbol)
+00004ab0: 3a0a 2020 2020 2020 2020 6966 2073 686f  :.        if sho
+00004ac0: 756c 645f 666c 6174 7465 6e28 6273 796d  uld_flatten(bsym
+00004ad0: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
+00004ae0: 6865 636b 280a 2020 2020 2020 2020 2020  heck(.          
+00004af0: 2020 2020 2020 6c65 6e28 6273 796d 2e73        len(bsym.s
+00004b00: 7562 7379 6d62 6f6c 7329 203e 2030 2c0a  ubsymbols) > 0,.
+00004b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b20: 6c61 6d62 6461 3a20 6622 5472 7969 6e67  lambda: f"Trying
+00004b30: 2074 6f20 666c 6174 7465 6e20 7b62 7379   to flatten {bsy
+00004b40: 6d7d 2074 6f20 6372 6561 7465 2061 2067  m} to create a g
+00004b50: 7261 6420 666f 726d 756c 612c 2062 7574  rad formula, but
+00004b60: 2069 7420 6861 7320 6e6f 2073 7562 7379   it has no subsy
+00004b70: 6d62 6f6c 7322 2c0a 2020 2020 2020 2020  mbols",.        
+00004b80: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00004b90: 2020 666f 7220 7362 7379 6d20 696e 2062    for sbsym in b
+00004ba0: 7379 6d2e 7375 6273 796d 626f 6c73 3a0a  sym.subsymbols:.
+00004bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004bc0: 5f66 6c61 7474 656e 2873 6273 796d 290a  _flatten(sbsym).
+00004bd0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00004be0: 2020 2020 2020 2020 2020 666c 6174 7465            flatte
+00004bf0: 6e65 642e 6170 7065 6e64 2862 7379 6d29  ned.append(bsym)
+00004c00: 0a0a 2020 2020 666f 7220 6273 796d 2069  ..    for bsym i
+00004c10: 6e20 6273 796d 733a 0a20 2020 2020 2020  n bsyms:.       
+00004c20: 205f 666c 6174 7465 6e28 6273 796d 290a   _flatten(bsym).
+00004c30: 0a20 2020 2072 6574 7572 6e20 666c 6174  .    return flat
+00004c40: 7465 6e65 640a 0a0a 230a 2320 5068 616e  tened...#.# Phan
+00004c50: 746f 6d20 6772 6164 2074 7261 6e73 666f  tom grad transfo
+00004c60: 726d 0a23 0a0a 230a 2320 4675 6e63 7469  rm.#..#.# Functi
+00004c70: 6f6e 7320 7265 6c61 7465 6420 746f 2066  ons related to f
+00004c80: 756e 6374 696f 6e61 6c69 7a69 6e67 2054  unctionalizing T
+00004c90: 6875 6e64 6572 4f70 7469 6d69 7a65 644d  hunderOptimizedM
+00004ca0: 6f64 756c 6573 0a23 0a0a 0a23 2054 4f44  odules.#...# TOD
+00004cb0: 4f20 5465 7374 2077 6974 6820 6275 6666  O Test with buff
+00004cc0: 6572 730a 6465 6620 706f 7075 6c61 7465  ers.def populate
+00004cd0: 5f67 7261 6473 2867 7261 6473 3a20 6c69  _grads(grads: li
+00004ce0: 7374 5b54 656e 736f 7250 726f 7879 5d2c  st[TensorProxy],
+00004cf0: 2074 6f6d 3a20 4e6f 6e65 207c 2074 6f72   tom: None | tor
+00004d00: 6368 2e6e 6e2e 4d6f 6475 6c65 203d 204e  ch.nn.Module = N
+00004d10: 6f6e 652c 2061 7267 733d 4e6f 6e65 2c20  one, args=None, 
+00004d20: 6b77 6172 6773 3d4e 6f6e 6529 202d 3e20  kwargs=None) -> 
+00004d30: 4e6f 6e65 3a0a 2020 2020 6964 783a 2069  None:.    idx: i
+00004d40: 6e74 203d 2030 0a20 2020 2066 726f 6d20  nt = 0.    from 
+00004d50: 7468 756e 6465 7220 696d 706f 7274 2054  thunder import T
+00004d60: 6875 6e64 6572 4d6f 6475 6c65 2c20 636f  hunderModule, co
+00004d70: 6d70 696c 655f 6461 7461 0a0a 2020 2020  mpile_data..    
+00004d80: 6966 2069 7369 6e73 7461 6e63 6528 746f  if isinstance(to
+00004d90: 6d2c 2054 6875 6e64 6572 4d6f 6475 6c65  m, ThunderModule
+00004da0: 2920 6f72 2063 6f6d 7069 6c65 5f64 6174  ) or compile_dat
+00004db0: 6128 746f 6d29 2e75 7369 6e67 5f6a 6974  a(tom).using_jit
+00004dc0: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+00004dd0: 2061 7267 7320 6973 206e 6f74 204e 6f6e   args is not Non
+00004de0: 652c 2022 706f 7075 6c61 7465 2067 7261  e, "populate gra
+00004df0: 6420 6e65 6564 7320 6172 6773 2028 616e  d needs args (an
+00004e00: 6420 706f 7373 6962 6c79 206b 7761 7267  d possibly kwarg
+00004e10: 7329 2074 6f20 776f 726b 2077 6974 6820  s) to work with 
+00004e20: 5468 756e 6465 724d 6f64 756c 6573 220a  ThunderModules".
+00004e30: 2020 2020 2020 2020 6966 206b 7761 7267          if kwarg
+00004e40: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+00004e50: 2020 2020 2020 206b 7761 7267 7320 3d20         kwargs = 
+00004e60: 7b7d 0a20 2020 2020 2020 205f 2c20 636f  {}.        _, co
+00004e70: 6d70 7574 6174 696f 6e5f 696e 7075 7473  mputation_inputs
+00004e80: 2c20 5f20 3d20 636f 6d70 696c 655f 6461  , _ = compile_da
+00004e90: 7461 2874 6f6d 292e 6765 745f 636f 6d70  ta(tom).get_comp
+00004ea0: 7574 6174 696f 6e5f 616e 645f 696e 7075  utation_and_inpu
+00004eb0: 7473 282a 6172 6773 2c20 2a2a 6b77 6172  ts(*args, **kwar
+00004ec0: 6773 290a 2020 2020 2020 2020 666f 7220  gs).        for 
+00004ed0: 7020 696e 2063 6f6d 7075 7461 7469 6f6e  p in computation
+00004ee0: 5f69 6e70 7574 733a 0a20 2020 2020 2020  _inputs:.       
+00004ef0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00004f00: 6365 2870 2c20 746f 7263 682e 5465 6e73  ce(p, torch.Tens
+00004f10: 6f72 2920 616e 6420 702e 7265 7175 6972  or) and p.requir
+00004f20: 6573 5f67 7261 643a 0a20 2020 2020 2020  es_grad:.       
+00004f30: 2020 2020 2020 2020 2023 2053 7570 706f           # Suppo
+00004f40: 7274 7320 6772 6164 2061 6363 756d 756c  rts grad accumul
+00004f50: 6174 696f 6e20 286c 696b 6520 7768 656e  ation (like when
+00004f60: 2077 6569 6768 7420 7479 696e 6729 0a20   weight tying). 
+00004f70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00004f80: 6620 702e 6772 6164 2069 7320 6e6f 7420  f p.grad is not 
+00004f90: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00004fa0: 2020 2020 2020 2020 2020 702e 6772 6164            p.grad
+00004fb0: 202b 3d20 6772 6164 735b 6964 785d 0a20   += grads[idx]. 
+00004fc0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00004fd0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00004fe0: 2020 2020 2020 2020 2070 2e67 7261 6420           p.grad 
+00004ff0: 3d20 6772 6164 735b 6964 785d 0a20 2020  = grads[idx].   
+00005000: 2020 2020 2020 2020 2020 2020 2069 6478               idx
+00005010: 202b 3d20 310a 2020 2020 2020 2020 7265   += 1.        re
+00005020: 7475 726e 0a0a 2020 2020 2320 5368 6f72  turn..    # Shor
+00005030: 742d 6369 7263 7569 7473 2069 6620 7468  t-circuits if th
+00005040: 6572 6520 6172 6520 6e6f 2061 7267 7320  ere are no args 
+00005050: 6f72 206b 7761 7267 730a 2020 2020 6966  or kwargs.    if
+00005060: 2061 7267 7320 6973 204e 6f6e 6520 616e   args is None an
+00005070: 6420 6b77 6172 6773 2069 7320 4e6f 6e65  d kwargs is None
+00005080: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00005090: 0a0a 2020 2020 666c 6174 732c 205f 203d  ..    flats, _ =
+000050a0: 2074 7265 655f 666c 6174 7465 6e28 2861   tree_flatten((a
+000050b0: 7267 732c 206b 7761 7267 7329 290a 2020  rgs, kwargs)).  
+000050c0: 2020 666f 7220 6620 696e 2066 6c61 7473    for f in flats
+000050d0: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
+000050e0: 6e73 7461 6e63 6528 662c 2074 6f72 6368  nstance(f, torch
+000050f0: 2e54 656e 736f 7229 2061 6e64 2066 2e72  .Tensor) and f.r
+00005100: 6571 7569 7265 735f 6772 6164 3a0a 2020  equires_grad:.  
+00005110: 2020 2020 2020 2020 2020 662e 6772 6164            f.grad
+00005120: 203d 2067 7261 6473 5b69 6478 5d0a 2020   = grads[idx].  
+00005130: 2020 2020 2020 2020 2020 6964 7820 2b3d            idx +=
+00005140: 2031 0a0a 0a64 6566 2065 7874 7261 6374   1...def extract
+00005150: 5f67 7261 6473 286d 6f64 756c 653a 2074  _grads(module: t
+00005160: 6f72 6368 2e6e 6e2e 4d6f 6475 6c65 2920  orch.nn.Module) 
+00005170: 2d3e 2074 7570 6c65 5b74 6f72 6368 2e54  -> tuple[torch.T
+00005180: 656e 736f 722c 202e 2e2e 5d3a 0a20 2020  ensor, ...]:.   
+00005190: 2067 7261 6473 203d 2074 7570 6c65 280a   grads = tuple(.
+000051a0: 2020 2020 2020 2020 662e 6772 6164 0a20          f.grad. 
+000051b0: 2020 2020 2020 2066 6f72 2066 2069 6e20         for f in 
+000051c0: 6368 6169 6e28 6d6f 6475 6c65 2e70 6172  chain(module.par
+000051d0: 616d 6574 6572 7328 292c 206d 6f64 756c  ameters(), modul
+000051e0: 652e 6275 6666 6572 7328 2929 0a20 2020  e.buffers()).   
+000051f0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00005200: 6365 2866 2c20 746f 7263 682e 5465 6e73  ce(f, torch.Tens
+00005210: 6f72 2920 616e 6420 662e 7265 7175 6972  or) and f.requir
+00005220: 6573 5f67 7261 6420 616e 6420 662e 6772  es_grad and f.gr
+00005230: 6164 2069 7320 6e6f 7420 4e6f 6e65 0a20  ad is not None. 
+00005240: 2020 2029 0a20 2020 2072 6574 7572 6e20     ).    return 
+00005250: 6772 6164 730a 0a0a 6465 6620 636c 6561  grads...def clea
+00005260: 725f 6772 6164 7328 6d6f 6475 6c65 3a20  r_grads(module: 
+00005270: 746f 7263 682e 6e6e 2e4d 6f64 756c 6529  torch.nn.Module)
+00005280: 202d 3e20 4e6f 6e65 3a0a 2020 2020 6966   -> None:.    if
+00005290: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+000052a0: 6d6f 6475 6c65 2c20 746f 7263 682e 6e6e  module, torch.nn
+000052b0: 2e4d 6f64 756c 6529 3a0a 2020 2020 2020  .Module):.      
+000052c0: 2020 7265 7475 726e 0a0a 2020 2020 666f    return..    fo
+000052d0: 7220 7020 696e 206d 6f64 756c 652e 7061  r p in module.pa
+000052e0: 7261 6d65 7465 7273 2829 3a0a 2020 2020  rameters():.    
+000052f0: 2020 2020 702e 6772 6164 203d 204e 6f6e      p.grad = Non
+00005300: 650a 2020 2020 666f 7220 6220 696e 206d  e.    for b in m
+00005310: 6f64 756c 652e 6275 6666 6572 7328 293a  odule.buffers():
+00005320: 0a20 2020 2020 2020 2062 2e67 7261 6420  .        b.grad 
+00005330: 3d20 4e6f 6e65 0a0a 0a66 726f 6d20 7468  = None...from th
+00005340: 756e 6465 722e 636f 7265 2e69 6e74 6572  under.core.inter
+00005350: 7072 6574 6572 2069 6d70 6f72 7420 6d61  preter import ma
+00005360: 6b65 5f6f 7061 7175 650a 6672 6f6d 2074  ke_opaque.from t
+00005370: 6875 6e64 6572 2e63 6f72 652e 6c61 6e67  hunder.core.lang
+00005380: 6374 7873 2069 6d70 6f72 7420 6c61 6e67  ctxs import lang
+00005390: 6374 782c 204c 616e 6775 6167 6573 0a0a  ctx, Languages..
+000053a0: 0a23 2054 4f44 4f20 5243 3120 5265 706c  .# TODO RC1 Repl
+000053b0: 6163 6520 7769 7468 206c 616e 6763 7478  ace with langctx
+000053c0: 0a64 6566 2074 6f72 6368 6374 7828 666e  .def torchctx(fn
+000053d0: 293a 0a20 2020 205f 666e 203d 206c 616e  ):.    _fn = lan
+000053e0: 6763 7478 284c 616e 6775 6167 6573 2e54  gctx(Languages.T
+000053f0: 4f52 4348 2928 666e 290a 2020 2020 7265  ORCH)(fn).    re
+00005400: 7475 726e 206d 616b 655f 6f70 6171 7565  turn make_opaque
+00005410: 285f 666e 290a 0a0a 5f67 7261 645f 666e  (_fn)..._grad_fn
+00005420: 5f6d 6170 3a20 6469 6374 5b41 6e79 2c20  _map: dict[Any, 
+00005430: 4361 6c6c 6162 6c65 5d20 3d20 7b7d 0a0a  Callable] = {}..
+00005440: 0a64 6566 2072 6567 6973 7465 725f 6772  .def register_gr
+00005450: 6164 2873 796d 5f6f 725f 6964 3a20 5379  ad(sym_or_id: Sy
+00005460: 6d62 6f6c 207c 2041 6e79 2c20 6772 6164  mbol | Any, grad
+00005470: 666e 3a20 4361 6c6c 6162 6c65 2920 2d3e  fn: Callable) ->
+00005480: 204e 6f6e 653a 0a20 2020 2069 643a 2041   None:.    id: A
+00005490: 6e79 203d 2073 796d 5f6f 725f 6964 0a20  ny = sym_or_id. 
+000054a0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+000054b0: 2873 796d 5f6f 725f 6964 2c20 5379 6d62  (sym_or_id, Symb
+000054c0: 6f6c 293a 0a20 2020 2020 2020 2069 6420  ol):.        id 
+000054d0: 3d20 7379 6d5f 6f72 5f69 642e 6964 0a20  = sym_or_id.id. 
+000054e0: 2020 205f 6772 6164 5f66 6e5f 6d61 705b     _grad_fn_map[
+000054f0: 6964 5d20 3d20 6772 6164 666e 0a0a 0a23  id] = gradfn...#
+00005500: 2047 7261 6420 6675 6e63 7469 6f6e 7320   Grad functions 
+00005510: 666f 7220 7072 696d 730a 6672 6f6d 2074  for prims.from t
+00005520: 6875 6e64 6572 2e63 6f72 652e 7072 696d  hunder.core.prim
+00005530: 7320 696d 706f 7274 2050 7269 6d49 4473  s import PrimIDs
+00005540: 2061 7320 7069 6473 2c20 6765 745f 6772   as pids, get_gr
+00005550: 6164 2c20 7075 745f 6772 6164 0a0a 0a23  ad, put_grad...#
+00005560: 2041 2067 656e 6572 616c 697a 6174 696f   A generalizatio
+00005570: 6e20 6f66 2070 7269 6d73 2e70 7574 5f67  n of prims.put_g
+00005580: 7261 6420 746f 2070 7974 7265 6573 0a23  rad to pytrees.#
+00005590: 2054 4f44 4f20 436f 6e73 6964 6572 2076   TODO Consider v
+000055a0: 616c 6964 6174 696e 6720 7468 6174 2074  alidating that t
+000055b0: 6865 2073 7065 6373 2061 7265 2074 6865  he specs are the
+000055c0: 2073 616d 650a 2320 544f 444f 2043 6f6e   same.# TODO Con
+000055d0: 7369 6465 7220 7661 6c69 6461 7469 6e67  sider validating
+000055e0: 2074 6861 7420 7468 6174 206f 626a 6563   that that objec
+000055f0: 7420 7265 7175 6972 6573 2067 7261 6420  t requires grad 
+00005600: 2861 6e64 2066 696c 7465 7269 6e67 206f  (and filtering o
+00005610: 2e77 2e29 0a64 6566 2070 7574 5f67 7261  .w.).def put_gra
+00005620: 6473 2861 2c20 6729 3a0a 2020 2020 666c  ds(a, g):.    fl
+00005630: 6174 732c 205f 203d 2074 7265 655f 666c  ats, _ = tree_fl
+00005640: 6174 7465 6e28 6129 0a20 2020 2066 6c61  atten(a).    fla
+00005650: 7467 7261 6473 2c20 5f20 3d20 7472 6565  tgrads, _ = tree
+00005660: 5f66 6c61 7474 656e 2867 290a 0a20 2020  _flatten(g)..   
+00005670: 2066 6f72 2066 2c20 6667 2069 6e20 7a69   for f, fg in zi
+00005680: 7028 666c 6174 732c 2066 6c61 7467 7261  p(flats, flatgra
+00005690: 6473 293a 0a20 2020 2020 2020 2069 6620  ds):.        if 
+000056a0: 6973 696e 7374 616e 6365 2866 2c20 5465  isinstance(f, Te
+000056b0: 6e73 6f72 5072 6f78 7929 2061 6e64 2069  nsorProxy) and i
+000056c0: 7369 6e73 7461 6e63 6528 6667 2c20 5465  sinstance(fg, Te
+000056d0: 6e73 6f72 5072 6f78 7929 3a0a 2020 2020  nsorProxy):.    
+000056e0: 2020 2020 2020 2020 7075 745f 6772 6164          put_grad
+000056f0: 2866 2c20 6667 290a 0a0a 230a 2320 556e  (f, fg)...#.# Un
+00005700: 7061 636b 696e 6720 6f70 6572 6174 6f72  packing operator
+00005710: 2067 7261 6473 0a23 0a0a 2320 4e4f 5445   grads.#..# NOTE
+00005720: 2070 7269 6d73 2e75 6e70 6163 6b5f 656d   prims.unpack_em
+00005730: 7074 795f 6469 6374 2063 7265 6174 6573  pty_dict creates
+00005740: 206e 6f20 6772 6164 2061 7373 6f63 6961   no grad associa
+00005750: 7469 6f6e 730a 7265 6769 7374 6572 5f67  tions.register_g
+00005760: 7261 6428 7069 6473 2e55 4e50 4143 4b5f  rad(pids.UNPACK_
+00005770: 454d 5054 595f 4449 4354 2c20 7072 696d  EMPTY_DICT, prim
+00005780: 732e 756e 7061 636b 5f65 6d70 7479 5f64  s.unpack_empty_d
+00005790: 6963 7429 0a0a 2320 4e4f 5445 2070 7269  ict)..# NOTE pri
+000057a0: 6d73 2e75 6e70 6163 6b5f 6b65 7920 6372  ms.unpack_key cr
+000057b0: 6561 7465 7320 6e6f 2067 7261 6420 6173  eates no grad as
+000057c0: 736f 6369 6174 696f 6e73 0a72 6567 6973  sociations.regis
+000057d0: 7465 725f 6772 6164 2870 6964 732e 554e  ter_grad(pids.UN
+000057e0: 5041 434b 5f4b 4559 2c20 7072 696d 732e  PACK_KEY, prims.
+000057f0: 756e 7061 636b 5f6b 6579 290a 0a23 204e  unpack_key)..# N
+00005800: 4f54 4520 7072 696d 732e 756e 7061 636b  OTE prims.unpack
+00005810: 5f73 6571 7565 6e63 6520 6372 6561 7465  _sequence create
+00005820: 7320 6e6f 2067 7261 6420 6173 736f 6369  s no grad associ
+00005830: 6174 696f 6e73 0a72 6567 6973 7465 725f  ations.register_
+00005840: 6772 6164 2870 6964 732e 554e 5041 434b  grad(pids.UNPACK
+00005850: 5f53 4551 5545 4e43 452c 2070 7269 6d73  _SEQUENCE, prims
+00005860: 2e75 6e70 6163 6b5f 7365 7175 656e 6365  .unpack_sequence
+00005870: 290a 0a0a 230a 2320 4461 7461 206d 6f76  )...#.# Data mov
+00005880: 656d 656e 7420 616e 6420 7472 616e 7366  ement and transf
+00005890: 6f72 6d61 7469 6f6e 206f 7065 7261 746f  ormation operato
+000058a0: 7220 6772 6164 730a 230a 4074 6f72 6368  r grads.#.@torch
+000058b0: 6374 780a 6465 6620 5f63 6f6e 7665 7274  ctx.def _convert
+000058c0: 5f65 6c65 6d65 6e74 5f74 7970 655f 7072  _element_type_pr
+000058d0: 696d 5f67 7261 6428 613a 204e 756d 6265  im_grad(a: Numbe
+000058e0: 7220 7c20 5465 6e73 6f72 5072 6f78 792c  r | TensorProxy,
+000058f0: 2064 7479 7065 3a20 7479 7065 207c 2064   dtype: type | d
+00005900: 7479 7065 732e 6474 7970 6529 202d 3e20  types.dtype) -> 
+00005910: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
+00005920: 726f 7879 3a0a 2020 2020 6677 6420 3d20  roxy:.    fwd = 
+00005930: 7072 696d 732e 636f 6e76 6572 745f 656c  prims.convert_el
+00005940: 656d 656e 745f 7479 7065 2861 2c20 6474  ement_type(a, dt
+00005950: 7970 6529 0a0a 2020 2020 6720 3d20 6765  ype)..    g = ge
+00005960: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
+00005970: 675f 636f 6e76 6572 7465 6420 3d20 7072  g_converted = pr
+00005980: 696d 732e 636f 6e76 6572 745f 656c 656d  ims.convert_elem
+00005990: 656e 745f 7479 7065 2867 2c20 6474 7970  ent_type(g, dtyp
+000059a0: 6573 2e74 6f5f 6474 7970 6528 6129 290a  es.to_dtype(a)).
+000059b0: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
+000059c0: 675f 636f 6e76 6572 7465 6429 0a0a 2020  g_converted)..  
+000059d0: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
+000059e0: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
+000059f0: 732e 434f 4e56 4552 545f 454c 454d 454e  s.CONVERT_ELEMEN
+00005a00: 545f 5459 5045 2c20 5f63 6f6e 7665 7274  T_TYPE, _convert
+00005a10: 5f65 6c65 6d65 6e74 5f74 7970 655f 7072  _element_type_pr
+00005a20: 696d 5f67 7261 6429 0a0a 230a 2320 5465  im_grad)..#.# Te
+00005a30: 6e73 6f72 2063 7265 6174 696f 6e20 6f70  nsor creation op
+00005a40: 6572 6174 6f72 2067 7261 6473 0a23 0a0a  erator grads.#..
+00005a50: 2320 4e4f 5445 2070 7269 6d73 2e66 756c  # NOTE prims.ful
+00005a60: 6c20 6372 6561 7465 7320 6e6f 2067 7261  l creates no gra
+00005a70: 6420 6173 736f 6369 6174 696f 6e73 0a72  d associations.r
+00005a80: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
+00005a90: 732e 4655 4c4c 2c20 7072 696d 732e 6675  s.FULL, prims.fu
+00005aa0: 6c6c 290a 0a23 204e 4f54 4520 7072 696d  ll)..# NOTE prim
+00005ab0: 732e 696f 7461 2063 7265 6174 6573 206e  s.iota creates n
+00005ac0: 6f20 6772 6164 2061 7373 6f63 6961 7469  o grad associati
+00005ad0: 6f6e 730a 7265 6769 7374 6572 5f67 7261  ons.register_gra
+00005ae0: 6428 7069 6473 2e49 4f54 412c 2070 7269  d(pids.IOTA, pri
+00005af0: 6d73 2e69 6f74 6129 0a0a 0a64 6566 205f  ms.iota)...def _
+00005b00: 756e 6966 6f72 6d5f 6772 6164 2873 6861  uniform_grad(sha
+00005b10: 7065 2c20 6d69 6e76 616c 2c20 6d61 7876  pe, minval, maxv
+00005b20: 616c 2c20 2a2c 2064 6576 6963 652c 2064  al, *, device, d
+00005b30: 7479 7065 293a 0a20 2020 2066 7764 2c20  type):.    fwd, 
+00005b40: 7361 7665 6420 3d20 756e 6966 6f72 6d5f  saved = uniform_
+00005b50: 6175 675f 6677 6428 7368 6170 652c 206d  aug_fwd(shape, m
+00005b60: 696e 7661 6c2c 206d 6178 7661 6c2c 2064  inval, maxval, d
+00005b70: 6576 6963 653d 6465 7669 6365 2c20 6474  evice=device, dt
+00005b80: 7970 653d 6474 7970 6529 0a20 2020 2067  ype=dtype).    g
+00005b90: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
+00005ba0: 0a20 2020 205f 2c20 676d 696e 7661 6c2c  .    _, gminval,
+00005bb0: 2067 6d61 7876 616c 203d 2075 6e69 666f   gmaxval = unifo
+00005bc0: 726d 5f62 6163 6b77 6172 6428 2a73 6176  rm_backward(*sav
+00005bd0: 6564 2c20 6729 0a20 2020 2070 7574 5f67  ed, g).    put_g
+00005be0: 7261 6473 2828 6d69 6e76 616c 2c20 6d61  rads((minval, ma
+00005bf0: 7876 616c 292c 2028 676d 696e 7661 6c2c  xval), (gminval,
+00005c00: 2067 6d61 7876 616c 2929 0a20 2020 2072   gmaxval)).    r
+00005c10: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
+00005c20: 7374 6572 5f67 7261 6428 7069 6473 2e55  ster_grad(pids.U
+00005c30: 4e49 464f 524d 2c20 5f75 6e69 666f 726d  NIFORM, _uniform
+00005c40: 5f67 7261 6429 0a0a 230a 2320 5265 7368  _grad)..#.# Resh
+00005c50: 6170 696e 6720 616e 6420 7065 726d 7574  aping and permut
+00005c60: 696e 6720 6f70 6572 6174 6f72 2067 7261  ing operator gra
+00005c70: 6473 0a23 0a0a 0a40 746f 7263 6863 7478  ds.#...@torchctx
+00005c80: 0a64 6566 205f 6272 6f61 6463 6173 745f  .def _broadcast_
+00005c90: 696e 5f64 696d 5f70 7269 6d5f 6772 6164  in_dim_prim_grad
+00005ca0: 280a 2020 2020 613a 2054 656e 736f 7250  (.    a: TensorP
+00005cb0: 726f 7879 2c20 7368 6170 653a 2053 6571  roxy, shape: Seq
+00005cc0: 7565 6e63 655b 696e 745d 2c20 6272 6f61  uence[int], broa
+00005cd0: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
+00005ce0: 3a20 5365 7175 656e 6365 5b69 6e74 5d0a  : Sequence[int].
+00005cf0: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
+00005d00: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
+00005d10: 732e 6272 6f61 6463 6173 745f 696e 5f64  s.broadcast_in_d
+00005d20: 696d 2861 2c20 7368 6170 652c 2062 726f  im(a, shape, bro
+00005d30: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
+00005d40: 7329 0a0a 2020 2020 6720 3d20 6765 745f  s)..    g = get_
+00005d50: 6772 6164 2866 7764 290a 0a20 2020 2075  grad(fwd)..    u
+00005d60: 6e69 745f 6469 6d73 203d 2074 7570 6c65  nit_dims = tuple
+00005d70: 2869 2066 6f72 2069 2c20 7320 696e 2065  (i for i, s in e
+00005d80: 6e75 6d65 7261 7465 2861 2e73 6861 7065  numerate(a.shape
+00005d90: 2920 6966 2073 203d 3d20 3129 0a20 2020  ) if s == 1).   
+00005da0: 2062 6361 7374 5f64 696d 7320 3d20 7475   bcast_dims = tu
+00005db0: 706c 6528 6220 666f 7220 692c 2062 2069  ple(b for i, b i
+00005dc0: 6e20 656e 756d 6572 6174 6528 6272 6f61  n enumerate(broa
+00005dd0: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
+00005de0: 2920 6966 2069 206e 6f74 2069 6e20 756e  ) if i not in un
+00005df0: 6974 5f64 696d 7329 0a20 2020 2072 6564  it_dims).    red
+00005e00: 7563 655f 6469 6d73 203d 2074 7570 6c65  uce_dims = tuple
+00005e10: 2873 2066 6f72 2069 2c20 7320 696e 2065  (s for i, s in e
+00005e20: 6e75 6d65 7261 7465 2872 616e 6765 286c  numerate(range(l
+00005e30: 656e 2873 6861 7065 2929 2920 6966 2069  en(shape))) if i
+00005e40: 206e 6f74 2069 6e20 6263 6173 745f 6469   not in bcast_di
+00005e50: 6d73 290a 0a20 2020 2067 203d 206c 746f  ms)..    g = lto
+00005e60: 7263 682e 7375 6d28 672c 2072 6564 7563  rch.sum(g, reduc
+00005e70: 655f 6469 6d73 290a 0a20 2020 2023 204e  e_dims)..    # N
+00005e80: 4f54 4520 5468 6973 206d 7573 7420 6265  OTE This must be
+00005e90: 2063 6c61 6e67 2e75 6e73 7175 6565 7a65   clang.unsqueeze
+00005ea0: 2062 6563 6175 7365 2074 6f72 6368 2e75   because torch.u
+00005eb0: 6e73 7175 6565 7a65 2c20 756e 6c69 6b65  nsqueeze, unlike
+00005ec0: 2063 6c61 6e67 2e75 6e73 7175 6565 7a65   clang.unsqueeze
+00005ed0: 2c20 6f6e 6c79 2061 6363 6570 7473 2061  , only accepts a
+00005ee0: 6e20 696e 7465 6765 720a 2020 2020 2320  n integer.    # 
+00005ef0: 2020 2870 7574 2061 6e6f 7468 6572 2077    (put another w
+00005f00: 6179 2c20 746f 7263 6820 6f6e 6c79 2061  ay, torch only a
+00005f10: 6c6c 6f77 7320 6f6e 6520 756e 7371 7565  llows one unsque
+00005f20: 657a 6520 6174 2061 2074 696d 6529 0a20  eze at a time). 
+00005f30: 2020 2067 203d 2063 6c61 6e67 2e75 6e73     g = clang.uns
+00005f40: 7175 6565 7a65 2867 2c20 756e 6974 5f64  queeze(g, unit_d
+00005f50: 696d 7329 0a0a 2020 2020 7075 745f 6772  ims)..    put_gr
+00005f60: 6164 2861 2c20 6729 0a0a 2020 2020 7265  ad(a, g)..    re
+00005f70: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
+00005f80: 7465 725f 6772 6164 2870 6964 732e 4252  ter_grad(pids.BR
+00005f90: 4f41 4443 4153 545f 494e 5f44 494d 2c20  OADCAST_IN_DIM, 
+00005fa0: 5f62 726f 6164 6361 7374 5f69 6e5f 6469  _broadcast_in_di
+00005fb0: 6d5f 7072 696d 5f67 7261 6429 0a0a 0a40  m_prim_grad)...@
+00005fc0: 746f 7263 6863 7478 0a64 6566 205f 6361  torchctx.def _ca
+00005fd0: 745f 7072 696d 5f67 7261 6428 7465 6e73  t_prim_grad(tens
+00005fe0: 6f72 733a 206c 6973 745b 5465 6e73 6f72  ors: list[Tensor
+00005ff0: 5072 6f78 795d 2c20 2f2c 2064 696d 3a20  Proxy], /, dim: 
+00006000: 696e 7429 202d 3e20 5465 6e73 6f72 5072  int) -> TensorPr
+00006010: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
+00006020: 7269 6d73 2e63 6174 2874 656e 736f 7273  rims.cat(tensors
+00006030: 2c20 6469 6d29 0a0a 2020 2020 6720 3d20  , dim)..    g = 
+00006040: 6765 745f 6772 6164 2866 7764 290a 0a20  get_grad(fwd).. 
+00006050: 2020 2073 6c69 6365 5f73 7461 7274 3a20     slice_start: 
+00006060: 696e 7420 3d20 300a 2020 2020 743a 2054  int = 0.    t: T
+00006070: 656e 736f 7250 726f 7879 0a20 2020 2066  ensorProxy.    f
+00006080: 6f72 2074 2069 6e20 7465 6e73 6f72 733a  or t in tensors:
+00006090: 0a20 2020 2020 2020 2064 696d 5f6c 656e  .        dim_len
+000060a0: 3a20 696e 7420 3d20 742e 7368 6170 655b  : int = t.shape[
+000060b0: 6469 6d5d 0a20 2020 2020 2020 2073 6c69  dim].        sli
+000060c0: 6365 5f65 6e64 3a20 696e 7420 3d20 736c  ce_end: int = sl
+000060d0: 6963 655f 7374 6172 7420 2b20 6469 6d5f  ice_start + dim_
+000060e0: 6c65 6e0a 2020 2020 2020 2020 675f 736c  len.        g_sl
+000060f0: 6963 653a 2054 656e 736f 7250 726f 7879  ice: TensorProxy
+00006100: 203d 2063 6c61 6e67 2e73 6c69 6365 5f69   = clang.slice_i
+00006110: 6e5f 6469 6d28 672c 2073 6c69 6365 5f73  n_dim(g, slice_s
+00006120: 7461 7274 2c20 736c 6963 655f 656e 642c  tart, slice_end,
+00006130: 2064 696d 3d64 696d 290a 2020 2020 2020   dim=dim).      
+00006140: 2020 736c 6963 655f 7374 6172 7420 3d20    slice_start = 
+00006150: 736c 6963 655f 656e 640a 2020 2020 2020  slice_end.      
+00006160: 2020 7075 745f 6772 6164 2874 2c20 675f    put_grad(t, g_
+00006170: 736c 6963 6529 0a0a 2020 2020 7265 7475  slice)..    retu
+00006180: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
+00006190: 725f 6772 6164 2870 6964 732e 4341 542c  r_grad(pids.CAT,
+000061a0: 205f 6361 745f 7072 696d 5f67 7261 6429   _cat_prim_grad)
+000061b0: 0a0a 0a64 6566 205f 7265 7368 6170 655f  ...def _reshape_
+000061c0: 7072 696d 5f67 7261 6428 613a 2054 656e  prim_grad(a: Ten
+000061d0: 736f 7250 726f 7879 2c20 7368 6170 653a  sorProxy, shape:
+000061e0: 2074 7570 6c65 5b69 6e74 2c20 2e2e 2e5d   tuple[int, ...]
+000061f0: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
+00006200: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
+00006210: 732e 7265 7368 6170 6528 612c 2073 6861  s.reshape(a, sha
+00006220: 7065 290a 0a20 2020 2067 203d 2067 6574  pe)..    g = get
+00006230: 5f67 7261 6428 6677 6429 0a0a 2020 2020  _grad(fwd)..    
+00006240: 615f 6772 6164 203d 2070 7269 6d73 2e72  a_grad = prims.r
+00006250: 6573 6861 7065 2867 2c20 612e 7368 6170  eshape(g, a.shap
+00006260: 6529 0a20 2020 2070 7574 5f67 7261 6428  e).    put_grad(
+00006270: 612c 2061 5f67 7261 6429 0a0a 2020 2020  a, a_grad)..    
+00006280: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
+00006290: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
+000062a0: 5245 5348 4150 452c 205f 7265 7368 6170  RESHAPE, _reshap
+000062b0: 655f 7072 696d 5f67 7261 6429 0a0a 0a40  e_prim_grad)...@
+000062c0: 746f 7263 6863 7478 0a64 6566 205f 736c  torchctx.def _sl
+000062d0: 6963 655f 7072 696d 5f67 7261 6428 0a20  ice_prim_grad(. 
+000062e0: 2020 2061 3a20 5465 6e73 6f72 5072 6f78     a: TensorProx
+000062f0: 792c 2073 7461 7274 5f69 6e64 6963 6573  y, start_indices
+00006300: 3a20 5365 7175 656e 6365 5b69 6e74 5d2c  : Sequence[int],
+00006310: 2065 6e64 5f69 6e64 6963 6573 3a20 5365   end_indices: Se
+00006320: 7175 656e 6365 5b69 6e74 5d2c 2073 7472  quence[int], str
+00006330: 6964 6573 3a20 4e6f 6e65 207c 2053 6571  ides: None | Seq
+00006340: 7565 6e63 655b 696e 745d 203d 204e 6f6e  uence[int] = Non
+00006350: 650a 2920 2d3e 2054 656e 736f 7250 726f  e.) -> TensorPro
+00006360: 7879 3a0a 2020 2020 6677 6420 3d20 7072  xy:.    fwd = pr
+00006370: 696d 732e 736c 6963 655f 7072 696d 2861  ims.slice_prim(a
+00006380: 2c20 7374 6172 745f 696e 6469 6365 732c  , start_indices,
+00006390: 2065 6e64 5f69 6e64 6963 6573 2c20 7374   end_indices, st
+000063a0: 7269 6465 7329 0a0a 2020 2020 6720 3d20  rides)..    g = 
+000063b0: 6765 745f 6772 6164 2866 7764 290a 0a20  get_grad(fwd).. 
+000063c0: 2020 2070 6164 6469 6e67 203d 204e 6f6e     padding = Non
+000063d0: 650a 2020 2020 6966 2073 7472 6964 6573  e.    if strides
+000063e0: 2069 7320 4e6f 6e65 206f 7220 6e70 2e61   is None or np.a
+000063f0: 6c6c 286e 702e 6571 7561 6c28 7374 7269  ll(np.equal(stri
+00006400: 6465 732c 2031 2929 3a0a 2020 2020 2020  des, 1)):.      
+00006410: 2020 7061 6464 696e 6720 3d20 7475 706c    padding = tupl
+00006420: 6528 7a69 7028 7374 6172 745f 696e 6469  e(zip(start_indi
+00006430: 6365 732c 206e 702e 7375 6274 7261 6374  ces, np.subtract
+00006440: 2861 2e73 6861 7065 2c20 656e 645f 696e  (a.shape, end_in
+00006450: 6469 6365 7329 2c20 2830 2c29 202a 206c  dices), (0,) * l
+00006460: 656e 2873 7461 7274 5f69 6e64 6963 6573  en(start_indices
+00006470: 2929 290a 2020 2020 656c 7365 3a0a 2020  ))).    else:.  
+00006480: 2020 2020 2020 7265 616c 5f6c 696d 6974        real_limit
+00006490: 7320 3d20 6e70 2e61 6464 280a 2020 2020  s = np.add(.    
+000064a0: 2020 2020 2020 2020 7374 6172 745f 696e          start_in
+000064b0: 6469 6365 732c 0a20 2020 2020 2020 2020  dices,.         
+000064c0: 2020 206e 702e 7768 6572 6528 6e70 2e65     np.where(np.e
+000064d0: 7175 616c 2867 2e73 6861 7065 2c20 3029  qual(g.shape, 0)
+000064e0: 2c20 302c 206e 702e 6164 6428 312c 206e  , 0, np.add(1, n
+000064f0: 702e 6d75 6c74 6970 6c79 286e 702e 7375  p.multiply(np.su
+00006500: 6274 7261 6374 2867 2e73 6861 7065 2c20  btract(g.shape, 
+00006510: 3129 2c20 7374 7269 6465 7329 2929 2c0a  1), strides))),.
+00006520: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00006530: 2020 7061 6464 696e 6720 3d20 7475 706c    padding = tupl
+00006540: 6528 7a69 7028 7374 6172 745f 696e 6469  e(zip(start_indi
+00006550: 6365 732c 206e 702e 7375 6274 7261 6374  ces, np.subtract
+00006560: 2861 2e73 6861 7065 2c20 7265 616c 5f6c  (a.shape, real_l
+00006570: 696d 6974 7329 2c20 6e70 2e73 7562 7472  imits), np.subtr
+00006580: 6163 7428 7374 7269 6465 732c 2031 2929  act(strides, 1))
+00006590: 290a 0a20 2020 2023 2043 6f6e 7665 7274  )..    # Convert
+000065a0: 7320 4e75 6d50 7920 6e75 6d62 6572 7320  s NumPy numbers 
+000065b0: 746f 2050 7974 686f 6e20 696e 7473 0a20  to Python ints. 
+000065c0: 2020 2023 2054 4f44 4f20 5368 6f75 6c64     # TODO Should
+000065d0: 2077 6520 7375 7070 6f72 7420 4e75 6d50   we support NumP
+000065e0: 7920 6e75 6d62 6572 7320 6265 7474 6572  y numbers better
+000065f0: 3f0a 2020 2020 7061 6464 696e 6720 3d20  ?.    padding = 
+00006600: 7472 6565 5f6d 6170 2869 6e74 2c20 7061  tree_map(int, pa
+00006610: 6464 696e 6729 0a20 2020 2061 5f67 7261  dding).    a_gra
+00006620: 6420 3d20 7072 696d 732e 7061 6428 672c  d = prims.pad(g,
+00006630: 2063 6f6e 7374 5f61 7328 302c 2067 2e64   const_as(0, g.d
+00006640: 7479 7065 292c 2070 6164 6469 6e67 290a  type), padding).
+00006650: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
+00006660: 615f 6772 6164 290a 0a20 2020 2072 6574  a_grad)..    ret
+00006670: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
+00006680: 6572 5f67 7261 6428 7069 6473 2e53 4c49  er_grad(pids.SLI
+00006690: 4345 2c20 5f73 6c69 6365 5f70 7269 6d5f  CE, _slice_prim_
+000066a0: 6772 6164 290a 0a0a 4074 6f72 6368 6374  grad)...@torchct
+000066b0: 780a 6465 6620 5f73 7175 6565 7a65 5f70  x.def _squeeze_p
+000066c0: 7269 6d5f 6772 6164 2861 3a20 5465 6e73  rim_grad(a: Tens
+000066d0: 6f72 5072 6f78 792c 202f 2c20 6469 6d73  orProxy, /, dims
+000066e0: 3a20 7475 706c 655b 696e 742c 202e 2e2e  : tuple[int, ...
+000066f0: 5d29 202d 3e20 5465 6e73 6f72 5072 6f78  ]) -> TensorProx
+00006700: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
+00006710: 6d73 2e73 7175 6565 7a65 2861 2c20 7475  ms.squeeze(a, tu
+00006720: 706c 6528 6469 6d73 2929 0a0a 2020 2020  ple(dims))..    
+00006730: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
+00006740: 290a 2020 2020 2320 4e4f 5445 2054 6869  ).    # NOTE Thi
+00006750: 7320 6361 6c6c 7320 636c 616e 672e 756e  s calls clang.un
+00006760: 7371 7565 657a 652c 2061 6e64 206e 6f74  squeeze, and not
+00006770: 2074 6f72 6368 2e75 6e73 7175 6565 7a65   torch.unsqueeze
+00006780: 2c20 6265 6361 7573 6520 746f 7263 682e  , because torch.
+00006790: 756e 7371 7565 657a 6520 6f6e 6c79 2073  unsqueeze only s
+000067a0: 7570 706f 7274 730a 2020 2020 2320 2020  upports.    #   
+000067b0: 756e 7371 7565 657a 696e 6720 6120 7369  unsqueezing a si
+000067c0: 6e67 6c65 2064 696d 656e 7369 6f6e 0a20  ngle dimension. 
+000067d0: 2020 2061 5f67 7261 6420 3d20 636c 616e     a_grad = clan
+000067e0: 672e 756e 7371 7565 657a 6528 672c 2064  g.unsqueeze(g, d
+000067f0: 696d 7329 0a20 2020 2070 7574 5f67 7261  ims).    put_gra
+00006800: 6428 612c 2061 5f67 7261 6429 0a0a 2020  d(a, a_grad)..  
+00006810: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
+00006820: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
+00006830: 732e 5351 5545 455a 452c 205f 7371 7565  s.SQUEEZE, _sque
+00006840: 657a 655f 7072 696d 5f67 7261 6429 0a0a  eze_prim_grad)..
+00006850: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
+00006860: 7461 6b65 5f70 7269 6d5f 6772 6164 2861  take_prim_grad(a
+00006870: 3a20 5465 6e73 6f72 5072 6f78 792c 2069  : TensorProxy, i
+00006880: 6e64 6578 3a20 5465 6e73 6f72 5072 6f78  ndex: TensorProx
+00006890: 792c 2064 696d 3a20 696e 7429 202d 3e20  y, dim: int) -> 
+000068a0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+000068b0: 2066 7764 203d 2070 7269 6d73 2e74 616b   fwd = prims.tak
+000068c0: 6528 612c 2069 6e64 6578 2c20 6469 6d29  e(a, index, dim)
+000068d0: 0a0a 2020 2020 6720 3d20 6765 745f 6772  ..    g = get_gr
+000068e0: 6164 2866 7764 290a 0a20 2020 2023 2054  ad(fwd)..    # T
+000068f0: 4f44 4f20 5377 6974 6368 2074 6f20 6c74  ODO Switch to lt
+00006900: 6f72 6368 2e69 6e64 6578 5f61 6464 3f0a  orch.index_add?.
+00006910: 2020 2020 2320 4e4f 5445 2049 6e74 656e      # NOTE Inten
+00006920: 7469 6f6e 616c 6c79 206e 6f74 2063 616c  tionally not cal
+00006930: 6c69 6e67 207a 6572 6f73 5f6c 696b 6520  ling zeros_like 
+00006940: 746f 2061 766f 6964 2070 7265 7365 7276  to avoid preserv
+00006950: 696e 6720 610a 2020 2020 2320 544f 444f  ing a.    # TODO
+00006960: 2055 7064 6174 6520 746f 2063 616c 6c20   Update to call 
+00006970: 6c74 6f72 6368 2e7a 6572 6f73 0a20 2020  ltorch.zeros.   
+00006980: 207a 6572 6f73 203d 2070 7269 6d73 2e66   zeros = prims.f
+00006990: 756c 6c28 612e 7368 6170 652c 2066 696c  ull(a.shape, fil
+000069a0: 6c5f 7661 6c75 653d 302c 2064 6576 6963  l_value=0, devic
+000069b0: 653d 612e 6465 7669 6365 2c20 6474 7970  e=a.device, dtyp
+000069c0: 653d 612e 6474 7970 6529 0a20 2020 2061  e=a.dtype).    a
+000069d0: 5f67 7261 6420 3d20 7072 696d 732e 696e  _grad = prims.in
+000069e0: 6465 785f 6164 6428 7a65 726f 732c 2069  dex_add(zeros, i
+000069f0: 6e64 6578 2c20 672c 2064 696d 290a 2020  ndex, g, dim).  
+00006a00: 2020 7075 745f 6772 6164 2861 2c20 615f    put_grad(a, a_
+00006a10: 6772 6164 290a 0a20 2020 2072 6574 7572  grad)..    retur
+00006a20: 6e20 6677 640a 0a0a 7265 6769 7374 6572  n fwd...register
+00006a30: 5f67 7261 6428 7069 6473 2e54 414b 452c  _grad(pids.TAKE,
+00006a40: 205f 7461 6b65 5f70 7269 6d5f 6772 6164   _take_prim_grad
+00006a50: 290a 0a0a 4074 6f72 6368 6374 780a 6465  )...@torchctx.de
+00006a60: 6620 5f74 616b 655f 616c 6f6e 675f 6178  f _take_along_ax
+00006a70: 6973 5f70 7269 6d5f 6772 6164 2861 3a20  is_prim_grad(a: 
+00006a80: 5465 6e73 6f72 5072 6f78 792c 2069 6e64  TensorProxy, ind
+00006a90: 6578 3a20 5465 6e73 6f72 5072 6f78 792c  ex: TensorProxy,
+00006aa0: 2064 696d 3a20 696e 7429 202d 3e20 5465   dim: int) -> Te
+00006ab0: 6e73 6f72 5072 6f78 793a 0a20 2020 2066  nsorProxy:.    f
+00006ac0: 7764 203d 2070 7269 6d73 2e74 616b 655f  wd = prims.take_
+00006ad0: 616c 6f6e 675f 6178 6973 2861 2c20 696e  along_axis(a, in
+00006ae0: 6465 782c 2064 696d 290a 0a20 2020 2067  dex, dim)..    g
+00006af0: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
+00006b00: 0a20 2020 2023 204e 4f54 4520 496e 7465  .    # NOTE Inte
+00006b10: 6e74 696f 6e61 6c6c 7920 6e6f 7420 6361  ntionally not ca
+00006b20: 6c6c 696e 6720 7a65 726f 735f 6c69 6b65  lling zeros_like
+00006b30: 2074 6f20 6176 6f69 6420 7072 6573 6572   to avoid preser
+00006b40: 7669 6e67 2061 0a20 2020 2023 2054 4f44  ving a.    # TOD
+00006b50: 4f20 5570 6461 7465 2074 6f20 6361 6c6c  O Update to call
+00006b60: 206c 746f 7263 682e 7a65 726f 730a 2020   ltorch.zeros.  
+00006b70: 2020 7a65 726f 7320 3d20 7072 696d 732e    zeros = prims.
+00006b80: 6675 6c6c 2861 2e73 6861 7065 2c20 6669  full(a.shape, fi
+00006b90: 6c6c 5f76 616c 7565 3d30 2c20 6465 7669  ll_value=0, devi
+00006ba0: 6365 3d61 2e64 6576 6963 652c 2064 7479  ce=a.device, dty
+00006bb0: 7065 3d61 2e64 7479 7065 290a 2020 2020  pe=a.dtype).    
+00006bc0: 615f 6772 6164 203d 2070 7269 6d73 2e73  a_grad = prims.s
+00006bd0: 6361 7474 6572 5f61 6464 287a 6572 6f73  catter_add(zeros
+00006be0: 2c20 696e 6465 782c 2067 2c20 6469 6d29  , index, g, dim)
+00006bf0: 0a20 2020 2070 7574 5f67 7261 6428 612c  .    put_grad(a,
+00006c00: 2061 5f67 7261 6429 0a0a 2020 2020 7265   a_grad)..    re
+00006c10: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
+00006c20: 7465 725f 6772 6164 2870 6964 732e 5441  ter_grad(pids.TA
+00006c30: 4b45 5f41 4c4f 4e47 5f41 5849 532c 205f  KE_ALONG_AXIS, _
+00006c40: 7461 6b65 5f61 6c6f 6e67 5f61 7869 735f  take_along_axis_
+00006c50: 7072 696d 5f67 7261 6429 0a0a 0a40 746f  prim_grad)...@to
+00006c60: 7263 6863 7478 0a64 6566 205f 7472 616e  rchctx.def _tran
+00006c70: 7370 6f73 655f 7072 696d 5f67 7261 6428  spose_prim_grad(
+00006c80: 613a 2054 656e 736f 7250 726f 7879 2c20  a: TensorProxy, 
+00006c90: 7065 726d 7574 6174 696f 6e3a 2074 7570  permutation: tup
+00006ca0: 6c65 5b69 6e74 2c20 2e2e 2e5d 2920 2d3e  le[int, ...]) ->
+00006cb0: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
+00006cc0: 2020 6677 6420 3d20 7072 696d 732e 7472    fwd = prims.tr
+00006cd0: 616e 7370 6f73 6528 612c 2074 7570 6c65  anspose(a, tuple
+00006ce0: 2870 6572 6d75 7461 7469 6f6e 2929 0a0a  (permutation))..
+00006cf0: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
+00006d00: 2866 7764 290a 2020 2020 756e 646f 203d  (fwd).    undo =
+00006d10: 205f 6172 6773 6f72 7428 7065 726d 7574   _argsort(permut
+00006d20: 6174 696f 6e29 0a20 2020 2061 5f67 7261  ation).    a_gra
+00006d30: 6420 3d20 7072 696d 732e 7472 616e 7370  d = prims.transp
+00006d40: 6f73 6528 672c 2074 7570 6c65 2875 6e64  ose(g, tuple(und
+00006d50: 6f29 290a 2020 2020 7075 745f 6772 6164  o)).    put_grad
+00006d60: 2861 2c20 615f 6772 6164 290a 0a20 2020  (a, a_grad)..   
+00006d70: 2072 6574 7572 6e20 6677 640a 0a0a 7265   return fwd...re
+00006d80: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
+00006d90: 2e54 5241 4e53 504f 5345 2c20 5f74 7261  .TRANSPOSE, _tra
+00006da0: 6e73 706f 7365 5f70 7269 6d5f 6772 6164  nspose_prim_grad
+00006db0: 290a 0a23 0a23 204d 656d 6f72 7920 6c61  )..#.# Memory la
+00006dc0: 796f 7574 206f 7065 7261 746f 7220 6772  yout operator gr
+00006dd0: 6164 730a 230a 0a0a 4074 6f72 6368 6374  ads.#...@torchct
+00006de0: 780a 6465 6620 5f73 7472 6964 655f 6f72  x.def _stride_or
+00006df0: 6465 725f 7072 696d 5f67 7261 6428 613a  der_prim_grad(a:
+00006e00: 2054 656e 736f 7250 726f 7879 2c20 2f2c   TensorProxy, /,
+00006e10: 206f 7264 6572 3a20 5365 7175 656e 6365   order: Sequence
+00006e20: 5b69 6e74 5d29 202d 3e20 5465 6e73 6f72  [int]) -> Tensor
+00006e30: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
+00006e40: 2070 7269 6d73 2e73 7472 6964 655f 6f72   prims.stride_or
+00006e50: 6465 7228 612c 206f 7264 6572 290a 0a20  der(a, order).. 
+00006e60: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
+00006e70: 6677 6429 0a20 2020 2070 7574 5f67 7261  fwd).    put_gra
+00006e80: 6428 612c 2067 290a 0a20 2020 2072 6574  d(a, g)..    ret
+00006e90: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
+00006ea0: 6572 5f67 7261 6428 7069 6473 2e53 5452  er_grad(pids.STR
+00006eb0: 4944 455f 4f52 4445 522c 205f 7374 7269  IDE_ORDER, _stri
+00006ec0: 6465 5f6f 7264 6572 5f70 7269 6d5f 6772  de_order_prim_gr
+00006ed0: 6164 290a 0a0a 230a 2320 456c 656d 656e  ad)...#.# Elemen
+00006ee0: 7477 6973 6520 756e 6172 7920 6f70 6572  twise unary oper
+00006ef0: 6174 6f72 2067 7261 6473 0a23 0a40 746f  ator grads.#.@to
+00006f00: 7263 6863 7478 0a64 6566 205f 6162 735f  rchctx.def _abs_
+00006f10: 7072 696d 5f67 7261 6428 613a 204e 756d  prim_grad(a: Num
+00006f20: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+00006f30: 7929 202d 3e20 4e75 6d62 6572 207c 2054  y) -> Number | T
+00006f40: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+00006f50: 6677 6420 3d20 7072 696d 732e 6162 7328  fwd = prims.abs(
+00006f60: 6129 0a0a 2020 2020 6720 3d20 6765 745f  a)..    g = get_
+00006f70: 6772 6164 2866 7764 290a 2020 2020 7075  grad(fwd).    pu
+00006f80: 745f 6772 6164 2861 2c20 6720 2a20 6c74  t_grad(a, g * lt
+00006f90: 6f72 6368 2e73 6967 6e28 6129 290a 0a20  orch.sign(a)).. 
+00006fa0: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
+00006fb0: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
+00006fc0: 6473 2e41 4253 2c20 5f61 6273 5f70 7269  ds.ABS, _abs_pri
+00006fd0: 6d5f 6772 6164 290a 0a0a 6465 6620 5f63  m_grad)...def _c
+00006fe0: 6f73 5f70 7269 6d5f 6772 6164 2861 3a20  os_prim_grad(a: 
+00006ff0: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
+00007000: 726f 7879 2920 2d3e 204e 756d 6265 7220  roxy) -> Number 
+00007010: 7c20 5465 6e73 6f72 5072 6f78 793a 0a20  | TensorProxy:. 
+00007020: 2020 2066 7764 203d 2070 7269 6d73 2e63     fwd = prims.c
+00007030: 6f73 2861 290a 0a20 2020 2067 203d 2067  os(a)..    g = g
+00007040: 6574 5f67 7261 6428 6677 6429 0a20 2020  et_grad(fwd).   
+00007050: 2070 7574 5f67 7261 6428 612c 2067 202a   put_grad(a, g *
+00007060: 2028 2d70 7269 6d73 2e73 696e 2861 2929   (-prims.sin(a))
+00007070: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
+00007080: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
+00007090: 6428 7069 6473 2e43 4f53 2c20 5f63 6f73  d(pids.COS, _cos
+000070a0: 5f70 7269 6d5f 6772 6164 290a 0a0a 4074  _prim_grad)...@t
+000070b0: 6f72 6368 6374 780a 6465 6620 5f65 7266  orchctx.def _erf
+000070c0: 5f70 7269 6d5f 6772 6164 2861 3a20 4e75  _prim_grad(a: Nu
+000070d0: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
+000070e0: 7879 2920 2d3e 204e 756d 6265 7220 7c20  xy) -> Number | 
+000070f0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+00007100: 2066 7764 203d 2070 7269 6d73 2e65 7266   fwd = prims.erf
+00007110: 2861 290a 0a20 2020 2067 203d 2067 6574  (a)..    g = get
+00007120: 5f67 7261 6428 6677 6429 0a20 2020 2061  _grad(fwd).    a
+00007130: 5f67 7261 6420 3d20 3220 2f20 6d61 7468  _grad = 2 / math
+00007140: 2e73 7172 7428 6d61 7468 2e70 6929 202a  .sqrt(math.pi) *
+00007150: 206c 746f 7263 682e 6578 7028 2d28 612a   ltorch.exp(-(a*
+00007160: 2a32 2929 202a 2067 0a20 2020 2070 7574  *2)) * g.    put
+00007170: 5f67 7261 6428 612c 2061 5f67 7261 6429  _grad(a, a_grad)
+00007180: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
+00007190: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
+000071a0: 2870 6964 732e 4552 462c 205f 6572 665f  (pids.ERF, _erf_
+000071b0: 7072 696d 5f67 7261 6429 0a0a 0a40 746f  prim_grad)...@to
+000071c0: 7263 6863 7478 0a64 6566 205f 6578 705f  rchctx.def _exp_
+000071d0: 7072 696d 5f67 7261 6428 613a 204e 756d  prim_grad(a: Num
+000071e0: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+000071f0: 7929 202d 3e20 4e75 6d62 6572 207c 2054  y) -> Number | T
+00007200: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+00007210: 6677 6420 3d20 7072 696d 732e 6578 7028  fwd = prims.exp(
+00007220: 6129 0a0a 2020 2020 6720 3d20 6765 745f  a)..    g = get_
+00007230: 6772 6164 2866 7764 290a 2020 2020 615f  grad(fwd).    a_
+00007240: 6772 6164 203d 2067 202a 2066 7764 0a20  grad = g * fwd. 
+00007250: 2020 2070 7574 5f67 7261 6428 612c 2061     put_grad(a, a
+00007260: 5f67 7261 6429 0a0a 2020 2020 7265 7475  _grad)..    retu
+00007270: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
+00007280: 725f 6772 6164 2870 6964 732e 4558 502c  r_grad(pids.EXP,
+00007290: 205f 6578 705f 7072 696d 5f67 7261 6429   _exp_prim_grad)
+000072a0: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
+000072b0: 205f 6c6f 675f 7072 696d 5f67 7261 6428   _log_prim_grad(
+000072c0: 613a 204e 756d 6265 7220 7c20 5465 6e73  a: Number | Tens
+000072d0: 6f72 5072 6f78 7929 202d 3e20 4e75 6d62  orProxy) -> Numb
+000072e0: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+000072f0: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
+00007300: 732e 6c6f 6728 6129 0a0a 2020 2020 6720  s.log(a)..    g 
+00007310: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
+00007320: 2020 2020 615f 6772 6164 203d 2067 202f      a_grad = g /
+00007330: 2061 0a20 2020 2070 7574 5f67 7261 6428   a.    put_grad(
+00007340: 612c 2061 5f67 7261 6429 0a0a 2020 2020  a, a_grad)..    
+00007350: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
+00007360: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
+00007370: 4c4f 472c 205f 6c6f 675f 7072 696d 5f67  LOG, _log_prim_g
+00007380: 7261 6429 0a0a 0a40 746f 7263 6863 7478  rad)...@torchctx
+00007390: 0a64 6566 205f 6e65 675f 7072 696d 5f67  .def _neg_prim_g
+000073a0: 7261 6428 613a 204e 756d 6265 7220 7c20  rad(a: Number | 
+000073b0: 5465 6e73 6f72 5072 6f78 7929 202d 3e20  TensorProxy) -> 
+000073c0: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
+000073d0: 726f 7879 3a0a 2020 2020 6677 6420 3d20  roxy:.    fwd = 
+000073e0: 7072 696d 732e 6e65 6728 6129 0a0a 2020  prims.neg(a)..  
+000073f0: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
+00007400: 7764 290a 2020 2020 7075 745f 6772 6164  wd).    put_grad
+00007410: 2861 2c20 2d67 290a 0a20 2020 2072 6574  (a, -g)..    ret
+00007420: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
+00007430: 6572 5f67 7261 6428 7069 6473 2e4e 4547  er_grad(pids.NEG
+00007440: 2c20 5f6e 6567 5f70 7269 6d5f 6772 6164  , _neg_prim_grad
+00007450: 290a 0a0a 4074 6f72 6368 6374 780a 6465  )...@torchctx.de
+00007460: 6620 5f72 7371 7274 5f70 7269 6d5f 6772  f _rsqrt_prim_gr
+00007470: 6164 2861 3a20 4e75 6d62 6572 207c 2054  ad(a: Number | T
+00007480: 656e 736f 7250 726f 7879 2c20 2f29 202d  ensorProxy, /) -
+00007490: 3e20 4e75 6d62 6572 207c 2054 656e 736f  > Number | Tenso
+000074a0: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
+000074b0: 3d20 7072 696d 732e 7273 7172 7428 6129  = prims.rsqrt(a)
+000074c0: 0a0a 2020 2020 6720 3d20 6765 745f 6772  ..    g = get_gr
+000074d0: 6164 2866 7764 290a 2020 2020 2320 416e  ad(fwd).    # An
+000074e0: 2061 6c74 6572 6e61 7469 7665 2064 6572   alternative der
+000074f0: 6976 6174 696f 6e20 7573 6564 2062 7920  ivation used by 
+00007500: 4a41 5820 6973 202d 302e 3520 2a20 6720  JAX is -0.5 * g 
+00007510: 2a20 7273 7172 7428 7829 202f 2078 0a20  * rsqrt(x) / x. 
+00007520: 2020 2023 2077 6865 7265 2072 7371 7274     # where rsqrt
+00007530: 2878 2920 616e 6420 7820 6172 6520 7361  (x) and x are sa
+00007540: 7665 6420 666f 7220 7468 6520 6261 636b  ved for the back
+00007550: 7761 7264 7320 7061 7373 2e0a 2020 2020  wards pass..    
+00007560: 2320 5468 6973 2064 6572 6976 6174 696f  # This derivatio
+00007570: 6e20 7761 7320 7365 6c65 6374 6564 2062  n was selected b
+00007580: 6563 6175 7365 2069 7420 6176 6f69 6473  ecause it avoids
+00007590: 2073 6176 696e 6720 7468 6520 696e 7075   saving the inpu
+000075a0: 7420 7465 6e73 6f72 2e0a 2020 2020 615f  t tensor..    a_
+000075b0: 6772 6164 203d 202d 302e 3520 2a20 6720  grad = -0.5 * g 
+000075c0: 2a20 6677 642a 2a33 2e30 0a20 2020 2070  * fwd**3.0.    p
+000075d0: 7574 5f67 7261 6428 612c 2061 5f67 7261  ut_grad(a, a_gra
+000075e0: 6429 0a0a 2020 2020 7265 7475 726e 2066  d)..    return f
+000075f0: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
+00007600: 6164 2870 6964 732e 5253 5152 542c 205f  ad(pids.RSQRT, _
+00007610: 7273 7172 745f 7072 696d 5f67 7261 6429  rsqrt_prim_grad)
+00007620: 0a0a 0a64 6566 205f 7369 6e5f 7072 696d  ...def _sin_prim
+00007630: 5f67 7261 6428 613a 204e 756d 6265 7220  _grad(a: Number 
+00007640: 7c20 5465 6e73 6f72 5072 6f78 7929 202d  | TensorProxy) -
+00007650: 3e20 4e75 6d62 6572 207c 2054 656e 736f  > Number | Tenso
+00007660: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
+00007670: 3d20 7072 696d 732e 7369 6e28 6129 0a0a  = prims.sin(a)..
+00007680: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
+00007690: 2866 7764 290a 2020 2020 7075 745f 6772  (fwd).    put_gr
+000076a0: 6164 2861 2c20 6720 2a20 7072 696d 732e  ad(a, g * prims.
+000076b0: 636f 7328 6129 290a 0a20 2020 2072 6574  cos(a))..    ret
+000076c0: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
+000076d0: 6572 5f67 7261 6428 7069 6473 2e53 494e  er_grad(pids.SIN
+000076e0: 2c20 5f73 696e 5f70 7269 6d5f 6772 6164  , _sin_prim_grad
+000076f0: 290a 0a0a 4074 6f72 6368 6374 780a 6465  )...@torchctx.de
+00007700: 6620 5f74 616e 685f 7072 696d 5f67 7261  f _tanh_prim_gra
+00007710: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
+00007720: 6e73 6f72 5072 6f78 792c 202f 2920 2d3e  nsorProxy, /) ->
+00007730: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
+00007740: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
+00007750: 2070 7269 6d73 2e74 616e 6828 6129 0a0a   prims.tanh(a)..
+00007760: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
+00007770: 2866 7764 290a 2020 2020 615f 6772 6164  (fwd).    a_grad
+00007780: 203d 2067 202a 2028 3120 2d20 6677 6420   = g * (1 - fwd 
+00007790: 2a20 6677 6429 0a20 2020 2070 7574 5f67  * fwd).    put_g
+000077a0: 7261 6428 612c 2061 5f67 7261 6429 0a0a  rad(a, a_grad)..
+000077b0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
+000077c0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+000077d0: 6964 732e 5441 4e48 2c20 5f74 616e 685f  ids.TANH, _tanh_
+000077e0: 7072 696d 5f67 7261 6429 0a0a 230a 2320  prim_grad)..#.# 
+000077f0: 456c 656d 656e 7477 6973 6520 6269 6e61  Elementwise bina
+00007800: 7279 206f 7065 7261 746f 7220 6772 6164  ry operator grad
+00007810: 730a 230a 0a0a 4074 6f72 6368 6374 780a  s.#...@torchctx.
+00007820: 6465 6620 5f61 6464 5f70 7269 6d5f 6772  def _add_prim_gr
+00007830: 6164 2861 3a20 4e75 6d62 6572 207c 2054  ad(a: Number | T
+00007840: 656e 736f 7250 726f 7879 2c20 623a 204e  ensorProxy, b: N
+00007850: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+00007860: 6f78 792c 202f 2920 2d3e 204e 756d 6265  oxy, /) -> Numbe
+00007870: 7220 7c20 5465 6e73 6f72 5072 6f78 793a  r | TensorProxy:
+00007880: 0a20 2020 2066 7764 203d 2061 202b 2062  .    fwd = a + b
+00007890: 0a0a 2020 2020 6720 3d20 6765 745f 6772  ..    g = get_gr
+000078a0: 6164 2866 7764 290a 2020 2020 615f 6772  ad(fwd).    a_gr
+000078b0: 6164 203d 2067 0a20 2020 2062 5f67 7261  ad = g.    b_gra
+000078c0: 6420 3d20 670a 2020 2020 7075 745f 6772  d = g.    put_gr
+000078d0: 6164 7328 2861 2c20 6229 2c20 2861 5f67  ads((a, b), (a_g
+000078e0: 7261 642c 2062 5f67 7261 6429 290a 0a20  rad, b_grad)).. 
+000078f0: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
+00007900: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
+00007910: 6473 2e41 4444 2c20 5f61 6464 5f70 7269  ds.ADD, _add_pri
+00007920: 6d5f 6772 6164 290a 0a0a 2320 4e4f 5445  m_grad)...# NOTE
+00007930: 2054 6865 2066 6f6c 6c6f 7769 6e67 2067   The following g
+00007940: 7261 6420 6465 6669 6e69 7469 6f6e 2072  rad definition r
+00007950: 656c 6965 7320 6f6e 2074 6865 2066 6163  elies on the fac
+00007960: 7420 7468 6174 206f 6e6c 7920 696e 6578  t that only inex
+00007970: 6163 7420 6474 7970 6573 2061 7265 2064  act dtypes are d
+00007980: 6966 6665 7265 6e74 6961 626c 652c 0a23  ifferentiable,.#
+00007990: 2020 2061 6e64 2074 6f72 6368 2773 2074     and torch's t
+000079a0: 7275 6520 6469 7669 7369 6f6e 206f 7065  rue division ope
+000079b0: 7261 746f 7220 616e 6420 7468 6520 6469  rator and the di
+000079c0: 7669 7369 6f6e 2070 7269 6d69 7469 7665  vision primitive
+000079d0: 2061 6772 6565 206f 6e20 7468 6f73 6520   agree on those 
+000079e0: 7479 7065 730a 4074 6f72 6368 6374 780a  types.@torchctx.
+000079f0: 6465 6620 5f64 6976 5f70 7269 6d5f 6772  def _div_prim_gr
+00007a00: 6164 2861 3a20 4e75 6d62 6572 207c 2054  ad(a: Number | T
+00007a10: 656e 736f 7250 726f 7879 2c20 623a 204e  ensorProxy, b: N
+00007a20: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+00007a30: 6f78 792c 202f 2920 2d3e 204e 756d 6265  oxy, /) -> Numbe
+00007a40: 7220 7c20 5465 6e73 6f72 5072 6f78 793a  r | TensorProxy:
+00007a50: 0a20 2020 2066 7764 203d 2061 202f 2062  .    fwd = a / b
+00007a60: 0a0a 2020 2020 6720 3d20 6765 745f 6772  ..    g = get_gr
+00007a70: 6164 2866 7764 290a 2020 2020 615f 6772  ad(fwd).    a_gr
+00007a80: 6164 203d 2067 202f 2062 0a20 2020 2062  ad = g / b.    b
+00007a90: 5f67 7261 6420 3d20 2d67 202a 2028 2861  _grad = -g * ((a
+00007aa0: 202f 2062 2920 2f20 6229 0a20 2020 2070   / b) / b).    p
+00007ab0: 7574 5f67 7261 6473 2828 612c 2062 292c  ut_grads((a, b),
+00007ac0: 2028 615f 6772 6164 2c20 625f 6772 6164   (a_grad, b_grad
+00007ad0: 2929 0a0a 2020 2020 7265 7475 726e 2066  ))..    return f
+00007ae0: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
+00007af0: 6164 2870 6964 732e 4449 562c 205f 6469  ad(pids.DIV, _di
+00007b00: 765f 7072 696d 5f67 7261 6429 0a0a 2320  v_prim_grad)..# 
+00007b10: 436f 6d70 6172 6973 6f6e 206f 7065 7261  Comparison opera
+00007b20: 746f 7273 202d 2d20 7468 6573 6520 6372  tors -- these cr
+00007b30: 6561 7465 206e 6f20 6772 6164 2061 7373  eate no grad ass
+00007b40: 6f63 6961 7469 6f6e 730a 7265 6769 7374  ociations.regist
+00007b50: 6572 5f67 7261 6428 7069 6473 2e45 512c  er_grad(pids.EQ,
+00007b60: 2070 7269 6d73 2e65 7129 0a72 6567 6973   prims.eq).regis
+00007b70: 7465 725f 6772 6164 2870 6964 732e 4745  ter_grad(pids.GE
+00007b80: 2c20 7072 696d 732e 6765 290a 7265 6769  , prims.ge).regi
+00007b90: 7374 6572 5f67 7261 6428 7069 6473 2e4c  ster_grad(pids.L
+00007ba0: 542c 2070 7269 6d73 2e6c 7429 0a0a 0a40  T, prims.lt)...@
+00007bb0: 746f 7263 6863 7478 0a64 6566 205f 6d75  torchctx.def _mu
+00007bc0: 6c5f 7072 696d 5f67 7261 6428 613a 204e  l_prim_grad(a: N
+00007bd0: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+00007be0: 6f78 792c 2062 3a20 4e75 6d62 6572 207c  oxy, b: Number |
+00007bf0: 2054 656e 736f 7250 726f 7879 2c20 2f29   TensorProxy, /)
+00007c00: 202d 3e20 4e75 6d62 6572 207c 2054 656e   -> Number | Ten
+00007c10: 736f 7250 726f 7879 3a0a 2020 2020 6677  sorProxy:.    fw
+00007c20: 6420 3d20 6120 2a20 620a 0a20 2020 2067  d = a * b..    g
+00007c30: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
+00007c40: 0a20 2020 2061 5f67 7261 6420 3d20 6220  .    a_grad = b 
+00007c50: 2a20 670a 2020 2020 625f 6772 6164 203d  * g.    b_grad =
+00007c60: 2061 202a 2067 0a20 2020 2070 7574 5f67   a * g.    put_g
+00007c70: 7261 6473 2828 612c 2062 292c 2028 615f  rads((a, b), (a_
+00007c80: 6772 6164 2c20 625f 6772 6164 2929 0a0a  grad, b_grad))..
+00007c90: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
+00007ca0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+00007cb0: 6964 732e 4d55 4c2c 205f 6d75 6c5f 7072  ids.MUL, _mul_pr
+00007cc0: 696d 5f67 7261 6429 0a0a 0a40 746f 7263  im_grad)...@torc
+00007cd0: 6863 7478 0a64 6566 205f 7375 625f 7072  hctx.def _sub_pr
+00007ce0: 696d 5f67 7261 6428 613a 204e 756d 6265  im_grad(a: Numbe
+00007cf0: 7220 7c20 5465 6e73 6f72 5072 6f78 792c  r | TensorProxy,
+00007d00: 2062 3a20 4e75 6d62 6572 207c 2054 656e   b: Number | Ten
+00007d10: 736f 7250 726f 7879 2920 2d3e 204e 756d  sorProxy) -> Num
+00007d20: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+00007d30: 793a 0a20 2020 2066 7764 203d 2061 202d  y:.    fwd = a -
+00007d40: 2062 0a0a 2020 2020 6720 3d20 6765 745f   b..    g = get_
+00007d50: 6772 6164 2866 7764 290a 2020 2020 615f  grad(fwd).    a_
+00007d60: 6772 6164 203d 2067 0a20 2020 2062 5f67  grad = g.    b_g
+00007d70: 7261 6420 3d20 2d67 0a20 2020 2070 7574  rad = -g.    put
+00007d80: 5f67 7261 6473 2828 612c 2062 292c 2028  _grads((a, b), (
+00007d90: 615f 6772 6164 2c20 625f 6772 6164 2929  a_grad, b_grad))
+00007da0: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
+00007db0: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
+00007dc0: 2870 6964 732e 5355 422c 205f 7375 625f  (pids.SUB, _sub_
+00007dd0: 7072 696d 5f67 7261 6429 0a0a 0a23 0a23  prim_grad)...#.#
+00007de0: 2043 6f6e 6469 7469 6f6e 616c 206f 7065   Conditional ope
+00007df0: 7261 746f 7220 6772 6164 730a 230a 0a0a  rator grads.#...
+00007e00: 6465 6620 5f77 6865 7265 5f70 7269 6d5f  def _where_prim_
+00007e10: 6772 6164 2870 7265 643a 204e 756d 6265  grad(pred: Numbe
+00007e20: 7220 7c20 5465 6e73 6f72 5072 6f78 792c  r | TensorProxy,
+00007e30: 2061 3a20 4e75 6d62 6572 207c 2054 656e   a: Number | Ten
+00007e40: 736f 7250 726f 7879 2c20 623a 204e 756d  sorProxy, b: Num
+00007e50: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+00007e60: 7929 202d 3e20 5465 6e73 6f72 5072 6f78  y) -> TensorProx
+00007e70: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
+00007e80: 6d73 2e77 6865 7265 2870 7265 642c 2061  ms.where(pred, a
+00007e90: 2c20 6229 0a0a 2020 2020 6720 3d20 6765  , b)..    g = ge
+00007ea0: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
+00007eb0: 615f 6772 6164 203d 206c 746f 7263 682e  a_grad = ltorch.
+00007ec0: 7768 6572 6528 7072 6564 2c20 672c 2030  where(pred, g, 0
+00007ed0: 290a 2020 2020 625f 6772 6164 203d 206c  ).    b_grad = l
+00007ee0: 746f 7263 682e 7768 6572 6528 7072 6564  torch.where(pred
+00007ef0: 2c20 302c 2067 290a 2020 2020 7075 745f  , 0, g).    put_
+00007f00: 6772 6164 7328 2861 2c20 6229 2c20 2861  grads((a, b), (a
+00007f10: 5f67 7261 642c 2062 5f67 7261 6429 290a  _grad, b_grad)).
+00007f20: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
+00007f30: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
+00007f40: 7069 6473 2e57 4845 5245 2c20 5f77 6865  pids.WHERE, _whe
+00007f50: 7265 5f70 7269 6d5f 6772 6164 290a 0a23  re_prim_grad)..#
+00007f60: 0a23 2052 6564 7563 7469 6f6e 206f 7065  .# Reduction ope
+00007f70: 7261 746f 7220 6772 6164 730a 230a 0a0a  rator grads.#...
+00007f80: 2320 544f 444f 2052 6576 6965 7720 7477  # TODO Review tw
+00007f90: 6561 6b69 6e67 2067 7261 645f 6368 6f6f  eaking grad_choo
+00007fa0: 7365 725f 7075 6c6c 6261 636b 2069 6e74  ser_pullback int
+00007fb0: 6572 6661 6365 0a64 6566 205f 616d 6178  erface.def _amax
+00007fc0: 5f70 7269 6d5f 6772 6164 2861 3a20 5465  _prim_grad(a: Te
+00007fd0: 6e73 6f72 5072 6f78 792c 202f 2c20 6469  nsorProxy, /, di
+00007fe0: 6d73 3a20 5365 7175 656e 6365 5b69 6e74  ms: Sequence[int
+00007ff0: 5d29 202d 3e20 5465 6e73 6f72 5072 6f78  ]) -> TensorProx
+00008000: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
+00008010: 6d73 2e61 6d61 7828 612c 2064 696d 7329  ms.amax(a, dims)
+00008020: 0a0a 2020 2020 6720 3d20 6765 745f 6772  ..    g = get_gr
+00008030: 6164 2866 7764 290a 2020 2020 615f 6772  ad(fwd).    a_gr
+00008040: 6164 203d 2067 7261 645f 6368 6f6f 7365  ad = grad_choose
+00008050: 725f 6261 636b 7761 7264 2866 7764 2c20  r_backward(fwd, 
+00008060: 612c 2061 2e73 6861 7065 2c20 6469 6d73  a, a.shape, dims
+00008070: 2c20 6729 0a20 2020 2070 7574 5f67 7261  , g).    put_gra
+00008080: 6428 612c 2061 5f67 7261 6429 0a0a 2020  d(a, a_grad)..  
+00008090: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
+000080a0: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
+000080b0: 732e 414d 4158 2c20 5f61 6d61 785f 7072  s.AMAX, _amax_pr
+000080c0: 696d 5f67 7261 6429 0a0a 0a64 6566 205f  im_grad)...def _
+000080d0: 7375 6d5f 7072 696d 5f67 7261 6428 613a  sum_prim_grad(a:
+000080e0: 2054 656e 736f 7250 726f 7879 2c20 2f2c   TensorProxy, /,
+000080f0: 2064 696d 733a 2053 6571 7565 6e63 655b   dims: Sequence[
+00008100: 696e 745d 2920 2d3e 2054 656e 736f 7250  int]) -> TensorP
+00008110: 726f 7879 3a0a 2020 2020 6677 6420 3d20  roxy:.    fwd = 
+00008120: 7072 696d 732e 7375 6d28 612c 2064 696d  prims.sum(a, dim
+00008130: 7329 0a0a 2020 2020 6720 3d20 6765 745f  s)..    g = get_
+00008140: 6772 6164 2866 7764 290a 2020 2020 615f  grad(fwd).    a_
+00008150: 6772 6164 203d 2072 6573 746f 7265 5f72  grad = restore_r
+00008160: 6564 7563 6564 5f64 696d 7328 672c 2064  educed_dims(g, d
+00008170: 696d 732c 2061 2e73 6861 7065 290a 2020  ims, a.shape).  
+00008180: 2020 7075 745f 6772 6164 2861 2c20 615f    put_grad(a, a_
+00008190: 6772 6164 290a 0a20 2020 2072 6574 7572  grad)..    retur
+000081a0: 6e20 6677 640a 0a0a 7265 6769 7374 6572  n fwd...register
+000081b0: 5f67 7261 6428 7069 6473 2e53 554d 2c20  _grad(pids.SUM, 
+000081c0: 5f73 756d 5f70 7269 6d5f 6772 6164 290a  _sum_prim_grad).
+000081d0: 0a0a 4074 6f72 6368 6374 780a 6465 6620  ..@torchctx.def 
+000081e0: 5f74 6f70 6b5f 7072 696d 5f67 7261 6428  _topk_prim_grad(
+000081f0: 0a20 2020 2061 3a20 5465 6e73 6f72 5072  .    a: TensorPr
+00008200: 6f78 792c 202f 2c20 6b3a 2069 6e74 2c20  oxy, /, k: int, 
+00008210: 6469 6d3a 204e 6f6e 6520 7c20 696e 7420  dim: None | int 
+00008220: 3d20 4e6f 6e65 2c20 6c61 7267 6573 743a  = None, largest:
+00008230: 2062 6f6f 6c20 3d20 5472 7565 2c20 736f   bool = True, so
+00008240: 7274 6564 3a20 626f 6f6c 203d 2054 7275  rted: bool = Tru
+00008250: 652c 202a 2c20 6f75 743d 4e6f 6e65 0a29  e, *, out=None.)
+00008260: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
+00008270: 732e 746f 706b 2861 2c20 6b2c 2064 696d  s.topk(a, k, dim
+00008280: 2c20 6c61 7267 6573 742c 2073 6f72 7465  , largest, sorte
+00008290: 642c 206f 7574 3d6f 7574 290a 2020 2020  d, out=out).    
+000082a0: 7661 6c2c 2069 6478 203d 2066 7764 0a0a  val, idx = fwd..
+000082b0: 2020 2020 7661 6c5f 6772 6164 203d 2067      val_grad = g
+000082c0: 6574 5f67 7261 6428 7661 6c29 0a0a 2020  et_grad(val)..  
+000082d0: 2020 615f 6772 6164 203d 206c 746f 7263    a_grad = ltorc
+000082e0: 682e 7a65 726f 735f 6c69 6b65 2861 290a  h.zeros_like(a).
+000082f0: 2020 2020 2320 544f 444f 3a20 7265 706c      # TODO: repl
+00008300: 6163 6520 7769 7468 2073 6361 7474 6572  ace with scatter
+00008310: 206f 6e63 6520 7765 2068 6176 6520 6974   once we have it
+00008320: 2e0a 2020 2020 2320 7363 6174 7465 725f  ..    # scatter_
+00008330: 6164 6420 6973 2061 2070 7269 6d20 616e  add is a prim an
+00008340: 6420 6974 2072 656c 6965 7320 6f6e 2061  d it relies on a
+00008350: 746f 6d69 6320 6f70 732e 0a20 2020 2061  tomic ops..    a
+00008360: 5f67 7261 6420 3d20 6c74 6f72 6368 2e73  _grad = ltorch.s
+00008370: 6361 7474 6572 5f61 6464 2861 5f67 7261  catter_add(a_gra
+00008380: 642c 2064 696d 2c20 6964 782c 2076 616c  d, dim, idx, val
+00008390: 5f67 7261 6429 0a20 2020 2070 7574 5f67  _grad).    put_g
+000083a0: 7261 6428 612c 2061 5f67 7261 6429 0a0a  rad(a, a_grad)..
+000083b0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
+000083c0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+000083d0: 6964 732e 544f 504b 2c20 5f74 6f70 6b5f  ids.TOPK, _topk_
+000083e0: 7072 696d 5f67 7261 6429 0a0a 0a23 2054  prim_grad)...# T
+000083f0: 4f44 4f20 4669 7820 6469 7669 7369 6f6e  ODO Fix division
+00008400: 2062 7920 7a65 726f 2077 6865 6e20 6e5f   by zero when n_
+00008410: 656c 656d 5f72 6564 7563 6564 203d 3d20  elem_reduced == 
+00008420: 3020 6f72 2077 6865 6e20 6d65 616e 2e6e  0 or when mean.n
+00008430: 756d 656c 203d 3d20 300a 2320 2020 6279  umel == 0.#   by
+00008440: 2072 6574 7572 6e69 6e67 207a 6572 6f73   returning zeros
+00008450: 5f6c 696b 6528 6129 206f 7220 7369 6d69  _like(a) or simi
+00008460: 6c61 722e 0a23 2054 4f44 4f20 4669 7820  lar..# TODO Fix 
+00008470: 6772 6164 2077 6865 6e20 636f 7272 6563  grad when correc
+00008480: 7469 6f6e 203e 206e 5f65 6c65 6d5f 7265  tion > n_elem_re
+00008490: 6475 6365 642e 0a40 746f 7263 6863 7478  duced..@torchctx
+000084a0: 0a64 6566 205f 7661 725f 6d65 616e 5f70  .def _var_mean_p
+000084b0: 7269 6d5f 6772 6164 2861 3a20 5465 6e73  rim_grad(a: Tens
+000084c0: 6f72 5072 6f78 792c 202f 2c20 6469 6d73  orProxy, /, dims
+000084d0: 3a20 5365 7175 656e 6365 5b69 6e74 5d2c  : Sequence[int],
+000084e0: 202a 2c20 636f 7272 6563 7469 6f6e 3a20   *, correction: 
+000084f0: 4e75 6d62 6572 2920 2d3e 2054 656e 736f  Number) -> Tenso
+00008500: 7250 726f 7879 3a0a 2020 2020 762c 206d  rProxy:.    v, m
+00008510: 203d 2070 7269 6d73 2e76 6172 5f6d 6561   = prims.var_mea
+00008520: 6e28 612c 2064 696d 732c 2063 6f72 7265  n(a, dims, corre
+00008530: 6374 696f 6e3d 636f 7272 6563 7469 6f6e  ction=correction
+00008540: 290a 0a20 2020 2067 7620 3d20 6765 745f  )..    gv = get_
+00008550: 6772 6164 2876 290a 2020 2020 676d 203d  grad(v).    gm =
+00008560: 2067 6574 5f67 7261 6428 6d29 0a0a 2020   get_grad(m)..  
+00008570: 2020 6e5f 656c 656d 5f72 6564 7563 6564    n_elem_reduced
+00008580: 203d 2061 2e6e 756d 656c 202f 2f20 6d2e   = a.numel // m.
+00008590: 6e75 6d65 6c20 6966 2061 2e6e 756d 656c  numel if a.numel
+000085a0: 2021 3d20 3020 656c 7365 2031 0a0a 2020   != 0 else 1..  
+000085b0: 2020 2320 436f 6d70 7574 6573 206d 6561    # Computes mea
+000085c0: 6e20 6277 640a 2020 2020 6d65 616e 5f73  n bwd.    mean_s
+000085d0: 6361 6c65 203d 2031 2e30 202f 206e 5f65  cale = 1.0 / n_e
+000085e0: 6c65 6d5f 7265 6475 6365 640a 2020 2020  lem_reduced.    
+000085f0: 6d65 616e 5f67 7261 6420 3d20 6d65 616e  mean_grad = mean
+00008600: 5f73 6361 6c65 202a 2072 6573 746f 7265  _scale * restore
+00008610: 5f72 6564 7563 6564 5f64 696d 7328 676d  _reduced_dims(gm
+00008620: 2c20 6469 6d73 2c20 612e 7368 6170 6529  , dims, a.shape)
+00008630: 0a0a 2020 2020 2320 436f 6d70 7574 6573  ..    # Computes
+00008640: 2076 6172 2062 7764 0a20 2020 206e 6f72   var bwd.    nor
+00008650: 6d61 6c69 7a61 7469 6f6e 5f73 6361 6c61  malization_scala
+00008660: 7220 3d20 6e5f 656c 656d 5f72 6564 7563  r = n_elem_reduc
+00008670: 6564 202d 2063 6f72 7265 6374 696f 6e0a  ed - correction.
+00008680: 2020 2020 7265 7374 6f72 6564 5f67 7620      restored_gv 
+00008690: 3d20 7265 7374 6f72 655f 7265 6475 6365  = restore_reduce
+000086a0: 645f 6469 6d73 2867 762c 2064 696d 732c  d_dims(gv, dims,
+000086b0: 2061 2e73 6861 7065 290a 2020 2020 7265   a.shape).    re
+000086c0: 7374 6f72 6564 5f6d 6561 6e20 3d20 7265  stored_mean = re
+000086d0: 7374 6f72 655f 7265 6475 6365 645f 6469  store_reduced_di
+000086e0: 6d73 286d 2c20 6469 6d73 2c20 612e 7368  ms(m, dims, a.sh
+000086f0: 6170 6529 0a20 2020 2076 6172 5f67 7261  ape).    var_gra
+00008700: 6420 3d20 2832 202a 2072 6573 746f 7265  d = (2 * restore
+00008710: 645f 6776 202a 2028 6120 2d20 7265 7374  d_gv * (a - rest
+00008720: 6f72 6564 5f6d 6561 6e29 2920 2f20 6e6f  ored_mean)) / no
+00008730: 726d 616c 697a 6174 696f 6e5f 7363 616c  rmalization_scal
+00008740: 6172 0a0a 2020 2020 7075 745f 6772 6164  ar..    put_grad
+00008750: 2861 2c20 6d65 616e 5f67 7261 6420 2b20  (a, mean_grad + 
+00008760: 7661 725f 6772 6164 290a 0a20 2020 2072  var_grad)..    r
+00008770: 6574 7572 6e20 762c 206d 0a0a 0a72 6567  eturn v, m...reg
+00008780: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
+00008790: 5641 525f 4d45 414e 2c20 5f76 6172 5f6d  VAR_MEAN, _var_m
+000087a0: 6561 6e5f 7072 696d 5f67 7261 6429 0a0a  ean_prim_grad)..
+000087b0: 0a23 0a23 204c 696e 6561 7220 616c 6765  .#.# Linear alge
+000087c0: 6272 6120 6f70 6572 6174 6f72 2067 7261  bra operator gra
+000087d0: 6473 0a23 0a40 746f 7263 6863 7478 0a64  ds.#.@torchctx.d
+000087e0: 6566 205f 6c69 6e65 6172 5f70 7269 6d5f  ef _linear_prim_
+000087f0: 6772 6164 2861 3a20 5465 6e73 6f72 5072  grad(a: TensorPr
+00008800: 6f78 792c 2077 3a20 5465 6e73 6f72 5072  oxy, w: TensorPr
+00008810: 6f78 792c 2062 6961 733a 204e 6f6e 6520  oxy, bias: None 
+00008820: 7c20 5465 6e73 6f72 5072 6f78 7929 202d  | TensorProxy) -
+00008830: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
+00008840: 2020 2066 7764 203d 2070 7269 6d73 2e6c     fwd = prims.l
+00008850: 696e 6561 7228 612c 2077 2c20 6269 6173  inear(a, w, bias
+00008860: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
+00008870: 7261 6428 6677 6429 0a0a 2020 2020 6669  rad(fwd)..    fi
+00008880: 7273 745f 6469 6d20 3d20 2d32 0a20 2020  rst_dim = -2.   
+00008890: 2067 7261 645f 6120 3d20 6c74 6f72 6368   grad_a = ltorch
+000088a0: 2e6d 6174 6d75 6c28 672e 7265 7368 6170  .matmul(g.reshap
+000088b0: 6528 2d31 2c20 672e 7368 6170 655b 2d31  e(-1, g.shape[-1
+000088c0: 5d29 2c20 7729 2e72 6573 6861 7065 2861  ]), w).reshape(a
+000088d0: 2e73 6861 7065 290a 0a20 2020 2067 7261  .shape)..    gra
+000088e0: 645f 773a 2054 656e 736f 7250 726f 7879  d_w: TensorProxy
+000088f0: 0a20 2020 2069 6620 612e 6e64 696d 203d  .    if a.ndim =
+00008900: 3d20 313a 0a20 2020 2020 2020 2067 7261  = 1:.        gra
+00008910: 645f 7720 3d20 6c74 6f72 6368 2e6d 6174  d_w = ltorch.mat
+00008920: 6d75 6c28 672e 756e 7371 7565 657a 6528  mul(g.unsqueeze(
+00008930: 6669 7273 745f 6469 6d29 2e6d 542c 2061  first_dim).mT, a
+00008940: 2e75 6e73 7175 6565 7a65 2866 6972 7374  .unsqueeze(first
+00008950: 5f64 696d 2929 0a20 2020 2065 6c73 653a  _dim)).    else:
+00008960: 0a20 2020 2020 2020 2067 7261 645f 7720  .        grad_w 
+00008970: 3d20 6c74 6f72 6368 2e6d 6174 6d75 6c28  = ltorch.matmul(
+00008980: 672e 7265 7368 6170 6528 2d31 2c20 672e  g.reshape(-1, g.
+00008990: 7368 6170 655b 2d31 5d29 2e6d 542c 2061  shape[-1]).mT, a
+000089a0: 2e72 6573 6861 7065 282d 312c 2061 2e73  .reshape(-1, a.s
+000089b0: 6861 7065 5b2d 315d 2929 0a0a 2020 2020  hape[-1]))..    
+000089c0: 7075 745f 6772 6164 7328 2861 2c20 7729  put_grads((a, w)
+000089d0: 2c20 2867 7261 645f 612c 2067 7261 645f  , (grad_a, grad_
+000089e0: 7729 290a 0a20 2020 2069 6620 6269 6173  w))..    if bias
+000089f0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00008a00: 2020 2020 2020 6966 2067 2e6e 6469 6d20        if g.ndim 
+00008a10: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
+00008a20: 2067 7261 645f 6269 6173 203d 206c 746f   grad_bias = lto
+00008a30: 7263 682e 7375 6d28 672c 2074 7570 6c65  rch.sum(g, tuple
+00008a40: 2872 616e 6765 2867 2e6e 6469 6d20 2d20  (range(g.ndim - 
+00008a50: 3129 2929 0a20 2020 2020 2020 2065 6c73  1))).        els
+00008a60: 653a 0a20 2020 2020 2020 2020 2020 2067  e:.            g
+00008a70: 7261 645f 6269 6173 203d 2067 0a20 2020  rad_bias = g.   
+00008a80: 2020 2020 2070 7574 5f67 7261 6428 6269       put_grad(bi
+00008a90: 6173 2c20 6772 6164 5f62 6961 7329 0a0a  as, grad_bias)..
+00008aa0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
+00008ab0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+00008ac0: 6964 732e 4c49 4e45 4152 2c20 5f6c 696e  ids.LINEAR, _lin
+00008ad0: 6561 725f 7072 696d 5f67 7261 6429 0a0a  ear_prim_grad)..
+00008ae0: 0a23 2054 4f44 4f20 4164 6420 6578 706c  .# TODO Add expl
+00008af0: 6963 6974 206c 746f 7263 6820 7673 2063  icit ltorch vs c
+00008b00: 6c61 6e67 206d 6f64 756c 6520 746f 2074  lang module to t
+00008b10: 6865 2074 656e 736f 7220 6f70 6572 6174  he tensor operat
+00008b20: 696f 6e73 2062 656c 6f77 0a23 2054 4f44  ions below.# TOD
+00008b30: 4f20 636f 756c 6420 7765 2067 6574 2072  O could we get r
+00008b40: 6964 206f 6620 7468 6520 6669 6e61 6c20  id of the final 
+00008b50: 7371 7565 657a 6573 2069 6e20 7468 6520  squeezes in the 
+00008b60: 622e 6e64 696d 203d 3d20 3120 6361 7365  b.ndim == 1 case
+00008b70: 2061 6e64 2074 6865 2061 2e6e 6469 6d20   and the a.ndim 
+00008b80: 3d3d 2031 2063 6173 653f 0a40 746f 7263  == 1 case?.@torc
+00008b90: 6863 7478 0a64 6566 205f 6d61 746d 756c  hctx.def _matmul
+00008ba0: 5f70 7269 6d5f 6772 6164 2861 3a20 5465  _prim_grad(a: Te
+00008bb0: 6e73 6f72 5072 6f78 792c 2062 3a20 5465  nsorProxy, b: Te
+00008bc0: 6e73 6f72 5072 6f78 792c 202f 2920 2d3e  nsorProxy, /) ->
+00008bd0: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
+00008be0: 2020 6677 6420 3d20 7072 696d 732e 6d61    fwd = prims.ma
+00008bf0: 746d 756c 2861 2c20 6229 0a20 2020 2067  tmul(a, b).    g
+00008c00: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
+00008c10: 0a0a 2020 2020 6c61 7374 5f64 696d 203d  ..    last_dim =
+00008c20: 2028 2d31 2c29 0a20 2020 2066 6972 7374   (-1,).    first
+00008c30: 5f64 696d 203d 2028 2d32 2c29 0a20 2020  _dim = (-2,).   
+00008c40: 2069 6620 612e 6e64 696d 203d 3d20 3120   if a.ndim == 1 
+00008c50: 616e 6420 622e 6e64 696d 203d 3d20 313a  and b.ndim == 1:
+00008c60: 0a20 2020 2020 2020 2070 7574 5f67 7261  .        put_gra
+00008c70: 6473 2828 612c 2062 292c 2028 6720 2a20  ds((a, b), (g * 
+00008c80: 622c 2067 202a 2061 2929 0a20 2020 2065  b, g * a)).    e
+00008c90: 6c69 6620 622e 6e64 696d 203d 3d20 313a  lif b.ndim == 1:
+00008ca0: 0a20 2020 2020 2020 2067 6120 3d20 756e  .        ga = un
+00008cb0: 7371 7565 657a 6528 672c 206c 6173 745f  squeeze(g, last_
+00008cc0: 6469 6d29 2040 2075 6e73 7175 6565 7a65  dim) @ unsqueeze
+00008cd0: 2862 2c20 6c61 7374 5f64 696d 292e 6d54  (b, last_dim).mT
+00008ce0: 0a20 2020 2020 2020 2067 6220 3d20 612e  .        gb = a.
+00008cf0: 6d54 2040 2075 6e73 7175 6565 7a65 2867  mT @ unsqueeze(g
+00008d00: 2c20 6c61 7374 5f64 696d 290a 2020 2020  , last_dim).    
+00008d10: 2020 2020 6966 2067 2e6e 6469 6d20 3e20      if g.ndim > 
+00008d20: 313a 0a20 2020 2020 2020 2020 2020 2067  1:.            g
+00008d30: 6220 3d20 7371 7565 657a 6528 6762 2c20  b = squeeze(gb, 
+00008d40: 6c61 7374 5f64 696d 290a 2020 2020 2020  last_dim).      
+00008d50: 2020 2020 2020 6762 203d 206c 746f 7263        gb = ltorc
+00008d60: 682e 7375 6d28 6762 2c20 7475 706c 6528  h.sum(gb, tuple(
+00008d70: 7261 6e67 6528 6762 2e6e 6469 6d20 2d20  range(gb.ndim - 
+00008d80: 3129 2929 0a20 2020 2020 2020 2070 7574  1))).        put
+00008d90: 5f67 7261 6473 2828 612c 2062 292c 2028  _grads((a, b), (
+00008da0: 6761 2c20 6762 2e73 7175 6565 7a65 2829  ga, gb.squeeze()
+00008db0: 2929 0a20 2020 2065 6c69 6620 612e 6e64  )).    elif a.nd
+00008dc0: 696d 203d 3d20 313a 0a20 2020 2020 2020  im == 1:.       
+00008dd0: 2067 6120 3d20 756e 7371 7565 657a 6528   ga = unsqueeze(
+00008de0: 672c 2066 6972 7374 5f64 696d 2920 4020  g, first_dim) @ 
+00008df0: 622e 6d54 0a20 2020 2020 2020 2069 6620  b.mT.        if 
+00008e00: 672e 6e64 696d 203e 2031 3a0a 2020 2020  g.ndim > 1:.    
+00008e10: 2020 2020 2020 2020 6761 203d 206c 746f          ga = lto
+00008e20: 7263 682e 7375 6d28 6761 2c20 7475 706c  rch.sum(ga, tupl
+00008e30: 6528 7261 6e67 6528 6761 2e6e 6469 6d20  e(range(ga.ndim 
+00008e40: 2d20 3129 2929 0a20 2020 2020 2020 2067  - 1))).        g
+00008e50: 6220 3d20 756e 7371 7565 657a 6528 612c  b = unsqueeze(a,
+00008e60: 2066 6972 7374 5f64 696d 292e 6d54 2040   first_dim).mT @
+00008e70: 2075 6e73 7175 6565 7a65 2867 2c20 6669   unsqueeze(g, fi
+00008e80: 7273 745f 6469 6d29 0a20 2020 2020 2020  rst_dim).       
+00008e90: 2070 7574 5f67 7261 6473 2828 612c 2062   put_grads((a, b
+00008ea0: 292c 2028 6761 2e73 7175 6565 7a65 2829  ), (ga.squeeze()
+00008eb0: 2c20 6762 2929 0a20 2020 2065 6c73 653a  , gb)).    else:
+00008ec0: 0a20 2020 2020 2020 2070 7574 5f67 7261  .        put_gra
+00008ed0: 6473 2828 612c 2062 292c 2028 6720 4020  ds((a, b), (g @ 
+00008ee0: 622e 6d54 2c20 612e 6d54 2040 2067 2929  b.mT, a.mT @ g))
+00008ef0: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
+00008f00: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
+00008f10: 2870 6964 732e 4d41 544d 554c 2c20 5f6d  (pids.MATMUL, _m
+00008f20: 6174 6d75 6c5f 7072 696d 5f67 7261 6429  atmul_prim_grad)
+00008f30: 0a0a 230a 2320 4e4e 206f 7065 7261 746f  ..#.# NN operato
+00008f40: 7220 6772 6164 730a 230a 0a0a 4074 6f72  r grads.#...@tor
+00008f50: 6368 6374 780a 6465 6620 5f65 6d62 6564  chctx.def _embed
+00008f60: 6469 6e67 5f70 7269 6d5f 6772 6164 280a  ding_prim_grad(.
+00008f70: 2020 2020 613a 2054 656e 736f 7250 726f      a: TensorPro
+00008f80: 7879 2c20 2f2c 2077 6569 6768 742c 202a  xy, /, weight, *
+00008f90: 2c20 7061 6464 696e 675f 6964 783d 2d31  , padding_idx=-1
+00008fa0: 2c20 6d61 785f 6e6f 726d 3d4e 6f6e 652c  , max_norm=None,
+00008fb0: 206e 6f72 6d5f 7479 7065 3d32 2e30 2c20   norm_type=2.0, 
+00008fc0: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
+00008fd0: 6571 3d46 616c 7365 2c20 7370 6172 7365  eq=False, sparse
+00008fe0: 3d46 616c 7365 0a29 202d 3e20 5465 6e73  =False.) -> Tens
+00008ff0: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
+00009000: 203d 2070 7269 6d73 2e65 6d62 6564 6469   = prims.embeddi
+00009010: 6e67 280a 2020 2020 2020 2020 612c 0a20  ng(.        a,. 
+00009020: 2020 2020 2020 2077 6569 6768 742c 0a20         weight,. 
+00009030: 2020 2020 2020 2070 6164 6469 6e67 5f69         padding_i
+00009040: 6478 3d70 6164 6469 6e67 5f69 6478 2c0a  dx=padding_idx,.
+00009050: 2020 2020 2020 2020 6d61 785f 6e6f 726d          max_norm
+00009060: 3d6d 6178 5f6e 6f72 6d2c 0a20 2020 2020  =max_norm,.     
+00009070: 2020 206e 6f72 6d5f 7479 7065 3d6e 6f72     norm_type=nor
+00009080: 6d5f 7479 7065 2c0a 2020 2020 2020 2020  m_type,.        
+00009090: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
+000090a0: 6571 3d73 6361 6c65 5f67 7261 645f 6279  eq=scale_grad_by
+000090b0: 5f66 7265 712c 0a20 2020 2020 2020 2073  _freq,.        s
+000090c0: 7061 7273 653d 7370 6172 7365 2c0a 2020  parse=sparse,.  
+000090d0: 2020 290a 0a20 2020 2067 203d 2067 6574    )..    g = get
+000090e0: 5f67 7261 6428 6677 6429 0a20 2020 2061  _grad(fwd).    a
+000090f0: 5f67 7261 6420 3d20 7072 696d 732e 656d  _grad = prims.em
+00009100: 6265 6464 696e 675f 6261 636b 7761 7264  bedding_backward
+00009110: 2867 2c20 612c 2077 6569 6768 742e 7368  (g, a, weight.sh
+00009120: 6170 655b 305d 2c20 7061 6464 696e 675f  ape[0], padding_
+00009130: 6964 782c 2073 6361 6c65 5f67 7261 645f  idx, scale_grad_
+00009140: 6279 5f66 7265 712c 2073 7061 7273 6529  by_freq, sparse)
+00009150: 0a20 2020 2070 7574 5f67 7261 6428 612c  .    put_grad(a,
+00009160: 2061 5f67 7261 6429 0a0a 2020 2020 7265   a_grad)..    re
+00009170: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
+00009180: 7465 725f 6772 6164 2870 6964 732e 454d  ter_grad(pids.EM
+00009190: 4245 4444 494e 472c 205f 656d 6265 6464  BEDDING, _embedd
+000091a0: 696e 675f 7072 696d 5f67 7261 6429 0a0a  ing_prim_grad)..
+000091b0: 230a 2320 5068 616e 746f 6d20 6772 6164  #.# Phantom grad
+000091c0: 2074 7261 6e73 666f 726d 2068 656c 7065   transform helpe
+000091d0: 7273 0a23 0a0a 0a64 6566 205f 6765 745f  rs.#...def _get_
+000091e0: 6772 6164 666e 2862 7379 6d3a 2042 6f75  gradfn(bsym: Bou
+000091f0: 6e64 5379 6d62 6f6c 2c20 2a2c 2065 7865  ndSymbol, *, exe
+00009200: 6375 746f 7273 5f6c 6973 743a 2053 6571  cutors_list: Seq
+00009210: 7565 6e63 655b 416e 795d 203d 2074 7570  uence[Any] = tup
+00009220: 6c65 2829 2920 2d3e 204e 6f6e 6520 7c20  le()) -> None | 
+00009230: 4361 6c6c 6162 6c65 3a0a 2020 2020 6364  Callable:.    cd
+00009240: 203d 2067 6574 5f63 6f6d 7069 6c65 5f64   = get_compile_d
+00009250: 6174 6128 290a 2020 2020 6578 6563 7574  ata().    execut
+00009260: 6f72 735f 6c69 7374 203d 2063 642e 6578  ors_list = cd.ex
+00009270: 6563 7574 6f72 735f 6c69 7374 2069 6620  ecutors_list if 
+00009280: 6364 2069 7320 6e6f 7420 4e6f 6e65 2065  cd is not None e
+00009290: 6c73 6520 6578 6563 7574 6f72 735f 6c69  lse executors_li
+000092a0: 7374 0a20 2020 2023 2043 6865 636b 7320  st.    # Checks 
+000092b0: 6966 2074 6865 2065 7865 6375 746f 7220  if the executor 
+000092c0: 7768 6963 6820 6861 7320 7072 696f 7269  which has priori
+000092d0: 7479 2066 6f72 2074 6869 7320 6f70 6572  ty for this oper
+000092e0: 6174 696f 6e20 6861 7320 6120 7370 6563  ation has a spec
+000092f0: 6966 6963 2067 7261 6420 7472 616e 7366  ific grad transf
+00009300: 6f72 6d20 666f 7220 6974 0a20 2020 2066  orm for it.    f
+00009310: 6f72 2065 7820 696e 2065 7865 6375 746f  or ex in executo
+00009320: 7273 5f6c 6973 743a 0a20 2020 2020 2020  rs_list:.       
+00009330: 2069 6620 6578 2e63 616e 5f65 7865 6375   if ex.can_execu
+00009340: 7465 5f6f 725f 6675 7365 2862 7379 6d29  te_or_fuse(bsym)
+00009350: 3a0a 2020 2020 2020 2020 2020 2020 6578  :.            ex
+00009360: 5f67 7261 645f 7472 616e 7366 6f72 6d3a  _grad_transform:
+00009370: 204e 6f6e 6520 7c20 4361 6c6c 6162 6c65   None | Callable
+00009380: 203d 2065 782e 6765 745f 6772 6164 5f74   = ex.get_grad_t
+00009390: 7261 6e73 666f 726d 2862 7379 6d2e 7379  ransform(bsym.sy
+000093a0: 6d29 0a20 2020 2020 2020 2020 2020 2069  m).            i
+000093b0: 6620 6578 5f67 7261 645f 7472 616e 7366  f ex_grad_transf
+000093c0: 6f72 6d20 6973 206e 6f74 204e 6f6e 653a  orm is not None:
+000093d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000093e0: 2072 6574 7572 6e20 6578 5f67 7261 645f   return ex_grad_
+000093f0: 7472 616e 7366 6f72 6d0a 2020 2020 2020  transform.      
+00009400: 2020 2020 2020 6272 6561 6b0a 0a20 2020        break..   
+00009410: 2023 2049 6620 7468 6520 6578 6563 7574   # If the execut
+00009420: 6f72 2064 6f65 736e 2774 2064 6566 696e  or doesn't defin
+00009430: 6520 6974 7320 6f77 6e20 6772 6164 2074  e its own grad t
+00009440: 7261 6e73 666f 726d 2c20 7468 6973 206a  ransform, this j
+00009450: 7573 7420 7265 7475 726e 7320 7468 6520  ust returns the 
+00009460: 6465 6661 756c 7420 6772 6164 2074 7261  default grad tra
+00009470: 6e73 666f 726d 2066 6f72 2074 6865 2062  nsform for the b
+00009480: 7379 6d0a 2020 2020 6772 6164 666e 203d  sym.    gradfn =
+00009490: 205f 6772 6164 5f66 6e5f 6d61 702e 6765   _grad_fn_map.ge
+000094a0: 7428 6273 796d 2e73 796d 2e69 642c 204e  t(bsym.sym.id, N
+000094b0: 6f6e 6529 0a20 2020 2072 6574 7572 6e20  one).    return 
+000094c0: 6772 6164 666e 0a0a 0a23 2054 6865 2064  gradfn...# The d
+000094d0: 6566 6175 6c74 2067 7261 6420 7370 6563  efault grad spec
+000094e0: 6966 6965 7220 666f 7220 7468 6520 6772  ifier for the gr
+000094f0: 6164 2074 7261 6e73 666f 726d 0a23 2020  ad transform.#  
+00009500: 2046 6f72 2065 6163 6820 7465 6e73 6f72   For each tensor
+00009510: 206f 7574 7075 7420 226f 2220 7265 7175   output "o" requ
+00009520: 6972 696e 6720 6772 6164 2c20 7370 6563  iring grad, spec
+00009530: 6966 6965 7320 6120 6772 6164 206f 6620  ifies a grad of 
+00009540: 6f6e 6573 5f6c 696b 6528 6f29 0a64 6566  ones_like(o).def
+00009550: 205f 6772 6164 5f73 7065 6369 6669 6572   _grad_specifier
+00009560: 5f64 6566 6175 6c74 2870 7974 7265 653a  _default(pytree:
+00009570: 2041 6e79 2920 2d3e 204e 6f6e 653a 0a20   Any) -> None:. 
+00009580: 2020 2066 6c61 7473 2c20 5f20 3d20 7472     flats, _ = tr
+00009590: 6565 5f66 6c61 7474 656e 2870 7974 7265  ee_flatten(pytre
+000095a0: 6529 0a0a 2020 2020 666f 7220 6620 696e  e)..    for f in
+000095b0: 2066 6c61 7473 3a0a 2020 2020 2020 2020   flats:.        
+000095c0: 6966 2069 7369 6e73 7461 6e63 6528 662c  if isinstance(f,
+000095d0: 2054 656e 736f 7250 726f 7879 2920 616e   TensorProxy) an
+000095e0: 6420 662e 7265 7175 6972 6573 5f67 7261  d f.requires_gra
+000095f0: 643a 0a20 2020 2020 2020 2020 2020 2023  d:.            #
+00009600: 204e 4f54 4520 5468 6973 2075 7365 7320   NOTE This uses 
+00009610: 636c 616e 672e 6f6e 6573 5f6c 696b 6520  clang.ones_like 
+00009620: 666f 7220 6e6f 7720 6265 6361 7573 6520  for now because 
+00009630: 6c74 6f72 6368 2e6f 6e65 735f 6c69 6b65  ltorch.ones_like
+00009640: 2077 696c 6c20 6578 7465 6e64 2074 6865   will extend the
+00009650: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
+00009660: 206c 6966 6574 696d 6520 6f66 2066 2c20   lifetime of f, 
+00009670: 7768 696c 6520 636c 616e 672e 6f6e 6573  while clang.ones
+00009680: 5f6c 696b 6520 7769 6c6c 2065 7874 7261  _like will extra
+00009690: 6374 2074 6865 206d 6574 6164 6174 6120  ct the metadata 
+000096a0: 6f66 2066 2061 7420 7472 6163 6520 7469  of f at trace ti
+000096b0: 6d65 0a20 2020 2020 2020 2020 2020 2070  me.            p
+000096c0: 7269 6d73 2e70 7574 5f67 7261 6428 662c  rims.put_grad(f,
+000096d0: 2063 6c61 6e67 2e66 756c 6c5f 6c69 6b65   clang.full_like
+000096e0: 2866 2c20 312e 3029 290a 0a0a 2320 544f  (f, 1.0))...# TO
+000096f0: 444f 2054 6573 7420 7769 7468 2062 7566  DO Test with buf
+00009700: 6665 7273 0a64 6566 205f 6772 6164 5f6f  fers.def _grad_o
+00009710: 7574 5f73 7065 6369 6669 6572 5f64 6566  ut_specifier_def
+00009720: 6175 6c74 2870 7974 7265 653a 2041 6e79  ault(pytree: Any
+00009730: 2920 2d3e 206c 6973 745b 5465 6e73 6f72  ) -> list[Tensor
+00009740: 5072 6f78 795d 3a0a 2020 2020 666c 6174  Proxy]:.    flat
+00009750: 732c 205f 203d 2074 7265 655f 666c 6174  s, _ = tree_flat
+00009760: 7465 6e28 7079 7472 6565 290a 2020 2020  ten(pytree).    
+00009770: 6772 6164 7320 3d20 6c69 7374 285b 7072  grads = list([pr
+00009780: 696d 732e 6765 745f 6772 6164 2866 2920  ims.get_grad(f) 
+00009790: 666f 7220 6620 696e 2066 6c61 7473 2069  for f in flats i
+000097a0: 6620 6973 696e 7374 616e 6365 2866 2c20  f isinstance(f, 
+000097b0: 5465 6e73 6f72 5072 6f78 7929 2061 6e64  TensorProxy) and
+000097c0: 2066 2e72 6571 7569 7265 735f 6772 6164   f.requires_grad
+000097d0: 5d29 0a20 2020 2072 6574 7572 6e20 6772  ]).    return gr
+000097e0: 6164 730a 0a0a 2320 544f 444f 2046 6f72  ads...# TODO For
+000097f0: 6d61 6c6c 7920 6465 6669 6e65 2074 6865  mally define the
+00009800: 2022 6772 6164 6965 6e74 2220 6f66 2061   "gradient" of a
+00009810: 2074 656e 736f 720a 2320 544f 444f 2049   tensor.# TODO I
+00009820: 6620 6e6f 6e65 206f 6620 7468 6520 696e  f none of the in
+00009830: 7075 7473 2074 6f20 616e 206f 7065 7261  puts to an opera
+00009840: 7469 6f6e 2072 6571 7569 7265 2067 7261  tion require gra
+00009850: 642c 2074 6865 6e20 7765 2063 6f75 6c64  d, then we could
+00009860: 206c 6561 7665 2074 6861 7420 6f70 6572   leave that oper
+00009870: 6174 696f 6e20 616c 6f6e 650a 2320 2020  ation alone.#   
+00009880: 5468 6973 2063 6f75 6c64 2061 6374 7561  This could actua
+00009890: 6c6c 7920 696d 7072 6f76 6520 7065 7266  lly improve perf
+000098a0: 6f72 6d61 6e63 6520 6966 2074 6865 206f  ormance if the o
+000098b0: 7065 7261 7469 6f6e 2070 6572 666f 726d  peration perform
+000098c0: 7320 6578 7472 6120 636f 6d70 7574 6174  s extra computat
+000098d0: 696f 6e73 2069 6e20 6974 7320 6772 6164  ions in its grad
+000098e0: 2074 7261 6e73 666f 726d 0a23 2020 2041   transform.#   A
+000098f0: 2077 6f72 6b61 726f 756e 6420 666f 7220   workaround for 
+00009900: 7468 6973 2077 6f75 6c64 2062 6520 666f  this would be fo
+00009910: 7220 7468 6520 6f70 6572 6174 696f 6e20  r the operation 
+00009920: 6974 7365 6c66 2074 6f20 6368 6563 6b20  itself to check 
+00009930: 6966 2069 7473 2069 6e70 7574 2072 6571  if its input req
+00009940: 7569 7265 7320 6772 6164 206f 7220 6e6f  uires grad or no
+00009950: 740a 2320 5472 616e 7366 6f72 6d73 2061  t.# Transforms a
+00009960: 2066 756e 6374 696f 6e20 746f 2063 6f6d   function to com
+00009970: 7075 7465 2074 6865 2022 6772 6164 6965  pute the "gradie
+00009980: 6e74 2220 6f66 2069 7473 2069 6e70 7574  nt" of its input
+00009990: 7320 7265 7175 6972 696e 6720 6772 6164  s requiring grad
+000099a0: 2c20 706f 7373 6962 6c79 0a23 2020 206d  , possibly.#   m
+000099b0: 6f64 6966 6965 6420 6279 2074 6865 2067  odified by the g
+000099c0: 7261 6420 7370 6563 6966 6965 7273 2028  rad specifiers (
+000099d0: 7365 6520 6265 6c6f 7729 2e0a 2320 5468  see below)..# Th
+000099e0: 6520 6f70 7469 6f6e 616c 2067 7261 645f  e optional grad_
+000099f0: 7370 6563 6966 6965 7220 6172 6775 6d65  specifier argume
+00009a00: 6e74 2061 6363 6570 7473 2074 6865 2066  nt accepts the f
+00009a10: 756e 6374 696f 6e27 7320 6f75 7470 7574  unction's output
+00009a20: 2c20 7275 6e73 2069 6e20 6120 6e6f 2d67  , runs in a no-g
+00009a30: 7261 6420 636f 6e74 6578 742c 0a23 2020  rad context,.#  
+00009a40: 2061 6e64 2063 616e 2070 7574 2067 7261   and can put gra
+00009a50: 6473 2028 7573 696e 6720 7072 696d 732e  ds (using prims.
+00009a60: 7075 745f 6772 6164 2829 2920 666f 7220  put_grad()) for 
+00009a70: 7465 6e73 6f72 732e 2042 7920 6465 6661  tensors. By defa
+00009a80: 756c 742c 2066 6f72 2065 7665 7279 2074  ult, for every t
+00009a90: 656e 736f 7220 6f75 7470 7574 2022 6f22  ensor output "o"
+00009aa0: 0a23 2020 2074 6861 7420 7265 7175 6972  .#   that requir
+00009ab0: 6573 2067 7261 642c 2061 2067 7261 6420  es grad, a grad 
+00009ac0: 6f66 206f 6e65 735f 6c69 6b65 286f 2920  of ones_like(o) 
+00009ad0: 6973 2070 7574 2e0a 2320 5468 6520 6f70  is put..# The op
+00009ae0: 7469 6f6e 616c 2067 7261 645f 6f75 745f  tional grad_out_
+00009af0: 7370 6563 6966 6965 7220 6163 6365 7074  specifier accept
+00009b00: 7320 7468 6520 6675 6e63 7469 6f6e 2773  s the function's
+00009b10: 2069 6e70 7574 2061 6e64 2063 616e 2063   input and can c
+00009b20: 616c 6c20 7072 696d 732e 6765 745f 6772  all prims.get_gr
+00009b30: 6164 2829 2074 6f0a 2320 2020 6163 7175  ad() to.#   acqu
+00009b40: 6972 6520 616e 6420 7265 7475 726e 2067  ire and return g
+00009b50: 7261 6469 656e 7473 2061 7320 6465 7369  radients as desi
+00009b60: 7265 642e 2042 7920 6465 6661 756c 742c  red. By default,
+00009b70: 2074 6865 2069 6e70 7574 2069 7320 666c   the input is fl
+00009b80: 6174 7465 6e65 640a 2320 2020 2874 7265  attened.#   (tre
+00009b90: 655f 666c 6174 7465 6e28 6172 6773 2c20  e_flatten(args, 
+00009ba0: 6b77 6172 6773 2929 2061 6e64 2061 2066  kwargs)) and a f
+00009bb0: 6c61 7420 6c69 7374 206f 6620 6772 6164  lat list of grad
+00009bc0: 7320 666f 7220 616c 6c20 7465 6e73 6f72  s for all tensor
+00009bd0: 7320 7265 7175 6972 696e 6720 6772 6164  s requiring grad
+00009be0: 0a23 2020 2061 6e64 204e 6f6e 6520 666f  .#   and None fo
+00009bf0: 7220 6f74 6865 7220 696e 7075 7473 2069  r other inputs i
+00009c00: 7320 7265 7475 726e 6564 2e0a 2320 5468  s returned..# Th
+00009c10: 6520 616c 676f 7269 7468 6d20 666f 7220  e algorithm for 
+00009c20: 6d6f 6469 6679 696e 6720 7468 6520 7072  modifying the pr
+00009c30: 6f67 7261 6d20 6861 7320 7468 6520 666f  ogram has the fo
+00009c40: 6c6c 6f77 696e 6720 7374 6570 733a 0a23  llowing steps:.#
+00009c50: 2020 2031 2920 466c 6174 7465 6e73 2074     1) Flattens t
+00009c60: 6865 206f 7269 6769 6e61 6c20 7472 6163  he original trac
+00009c70: 6520 666f 7220 7468 6520 6772 6164 2074  e for the grad t
+00009c80: 7261 6e73 666f 726d 202d 2d20 656e 7375  ransform -- ensu
+00009c90: 696e 6720 7468 6174 2061 6c6c 2074 6f70  ing that all top
+00009ca0: 2d6c 6576 656c 2073 796d 626f 6c73 2068  -level symbols h
+00009cb0: 6176 650a 2320 2020 2020 2020 6120 6772  ave.#       a gr
+00009cc0: 6164 2066 756e 6374 696f 6e2e 0a64 6566  ad function..def
+00009cd0: 2067 7261 6428 0a20 2020 2063 666e 2c20   grad(.    cfn, 
+00009ce0: 6772 6164 5f73 7065 6369 6669 6572 3a20  grad_specifier: 
+00009cf0: 4361 6c6c 6162 6c65 203d 205f 6772 6164  Callable = _grad
+00009d00: 5f73 7065 6369 6669 6572 5f64 6566 6175  _specifier_defau
+00009d10: 6c74 2c20 6772 6164 5f6f 7574 5f73 7065  lt, grad_out_spe
+00009d20: 6369 6669 6572 3a20 4361 6c6c 6162 6c65  cifier: Callable
+00009d30: 203d 205f 6772 6164 5f6f 7574 5f73 7065   = _grad_out_spe
+00009d40: 6369 6669 6572 5f64 6566 6175 6c74 0a29  cifier_default.)
+00009d50: 202d 3e20 4361 6c6c 6162 6c65 3a0a 2020   -> Callable:.  
+00009d60: 2020 2320 4372 6561 7465 7320 6120 6375    # Creates a cu
+00009d70: 7374 6f6d 2074 7261 6e73 666f 726d 2063  stom transform c
+00009d80: 616c 6c61 626c 6520 7468 6174 2062 696e  allable that bin
+00009d90: 6473 2074 6865 2061 6464 6974 696f 6e61  ds the additiona
+00009da0: 6c20 6172 6775 6d65 6e74 7320 746f 2074  l arguments to t
+00009db0: 6865 2067 7261 6420 7472 616e 7366 6f72  he grad transfor
+00009dc0: 6d0a 2020 2020 406c 616e 6763 7478 284c  m.    @langctx(L
+00009dd0: 616e 6775 6167 6573 2e43 4c41 4e47 290a  anguages.CLANG).
+00009de0: 2020 2020 6465 6620 5f67 7261 645f 7472      def _grad_tr
+00009df0: 616e 7366 6f72 6d28 7472 633a 2054 7261  ansform(trc: Tra
+00009e00: 6365 2c20 2a2c 2065 7865 6375 746f 7273  ce, *, executors
+00009e10: 5f6c 6973 743a 2053 6571 7565 6e63 655b  _list: Sequence[
+00009e20: 416e 795d 2920 2d3e 2054 7261 6365 3a0a  Any]) -> Trace:.
+00009e30: 2020 2020 2020 2020 7374 6172 745f 7469          start_ti
+00009e40: 6d65 5f6e 7320 3d20 7469 6d65 2e74 696d  me_ns = time.tim
+00009e50: 655f 6e73 2829 0a0a 2020 2020 2020 2020  e_ns()..        
+00009e60: 2320 5354 4550 204f 4e45 202d 2d20 466c  # STEP ONE -- Fl
+00009e70: 6174 7465 6e73 2061 6e64 2064 6365 730a  attens and dces.
+00009e80: 0a20 2020 2020 2020 2023 2052 6574 7572  .        # Retur
+00009e90: 6e73 2054 7275 6520 6966 2074 6865 2062  ns True if the b
+00009ea0: 7379 6d20 6861 7320 6e6f 2067 7261 6420  sym has no grad 
+00009eb0: 6675 6e63 7469 6f6e 2c20 616e 6420 736f  function, and so
+00009ec0: 206d 7573 7420 6265 2066 6c61 7474 656e   must be flatten
+00009ed0: 6564 2066 6f72 2074 6865 2067 7261 6420  ed for the grad 
+00009ee0: 7472 616e 7366 6f72 6d0a 2020 2020 2020  transform.      
+00009ef0: 2020 6e65 7665 725f 666c 6174 7465 6e3a    never_flatten:
+00009f00: 2073 6574 5b48 6173 6861 626c 655d 203d   set[Hashable] =
+00009f10: 207b 7072 696d 732e 5072 696d 4944 732e   {prims.PrimIDs.
+00009f20: 5245 5455 524e 2c20 7072 696d 732e 5072  RETURN, prims.Pr
+00009f30: 696d 4944 732e 554e 5041 434b 5f54 5249  imIDs.UNPACK_TRI
+00009f40: 5649 414c 7d0a 0a20 2020 2020 2020 2064  VIAL}..        d
+00009f50: 6566 2073 686f 756c 645f 666c 6174 7465  ef should_flatte
+00009f60: 6e5f 666f 725f 6772 6164 2862 7379 6d3a  n_for_grad(bsym:
+00009f70: 2042 6f75 6e64 5379 6d62 6f6c 2920 2d3e   BoundSymbol) ->
+00009f80: 2062 6f6f 6c3a 0a20 2020 2020 2020 2020   bool:.         
+00009f90: 2020 2069 6620 6273 796d 2e73 796d 2e69     if bsym.sym.i
+00009fa0: 6420 696e 206e 6576 6572 5f66 6c61 7474  d in never_flatt
+00009fb0: 656e 3a0a 2020 2020 2020 2020 2020 2020  en:.            
+00009fc0: 2020 2020 7265 7475 726e 2046 616c 7365      return False
+00009fd0: 0a0a 2020 2020 2020 2020 2020 2020 6772  ..            gr
+00009fe0: 6164 666e 3a20 4e6f 6e65 207c 2043 616c  adfn: None | Cal
+00009ff0: 6c61 626c 6520 3d20 5f67 6574 5f67 7261  lable = _get_gra
+0000a000: 6466 6e28 6273 796d 2c20 6578 6563 7574  dfn(bsym, execut
+0000a010: 6f72 735f 6c69 7374 3d65 7865 6375 746f  ors_list=executo
+0000a020: 7273 5f6c 6973 7429 0a20 2020 2020 2020  rs_list).       
+0000a030: 2020 2020 2072 6574 7572 6e20 6772 6164       return grad
+0000a040: 666e 2069 7320 4e6f 6e65 0a0a 2020 2020  fn is None..    
+0000a050: 2020 2020 2320 544f 444f 2052 4331 3a20      # TODO RC1: 
+0000a060: 6d61 7962 6520 6d6f 7665 2074 6f20 7072  maybe move to pr
+0000a070: 6f64 7563 6520 7468 6573 6520 616c 7761  oduce these alwa
+0000a080: 7973 206f 6e20 6372 6561 7469 6f6e 0a20  ys on creation. 
+0000a090: 2020 2020 2020 2069 6620 7472 632e 6b77         if trc.kw
+0000a0a0: 6172 6773 2069 7320 4e6f 6e65 3a0a 2020  args is None:.  
+0000a0b0: 2020 2020 2020 2020 2020 7472 632e 6b77            trc.kw
+0000a0c0: 6172 6773 203d 207b 7d0a 2020 2020 2020  args = {}.      
+0000a0d0: 2020 6966 2074 7263 2e66 6e20 6973 204e    if trc.fn is N
+0000a0e0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000a0f0: 2074 7263 2e66 6e20 3d20 7472 632e 7079   trc.fn = trc.py
+0000a100: 7468 6f6e 5f63 616c 6c61 626c 6528 290a  thon_callable().
+0000a110: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
+0000a120: 203d 2066 726f 6d5f 7472 6163 6528 7472   = from_trace(tr
+0000a130: 6329 0a20 2020 2020 2020 2066 6c61 7474  c).        flatt
+0000a140: 656e 6564 5f62 7379 6d73 3a20 6c69 7374  ened_bsyms: list
+0000a150: 5b42 6f75 6e64 5379 6d62 6f6c 5d20 3d20  [BoundSymbol] = 
+0000a160: 666c 6174 7465 6e5f 666f 725f 7472 616e  flatten_for_tran
+0000a170: 7366 6f72 6d28 7368 6f75 6c64 5f66 6c61  sform(should_fla
+0000a180: 7474 656e 5f66 6f72 5f67 7261 642c 2074  tten_for_grad, t
+0000a190: 7263 2e62 6f75 6e64 5f73 796d 626f 6c73  rc.bound_symbols
+0000a1a0: 290a 2020 2020 2020 2020 6772 6164 7472  ).        gradtr
+0000a1b0: 632e 626f 756e 645f 7379 6d62 6f6c 7320  c.bound_symbols 
+0000a1c0: 3d20 666c 6174 7465 6e65 645f 6273 796d  = flattened_bsym
+0000a1d0: 730a 2020 2020 2020 2020 6772 6164 7472  s.        gradtr
+0000a1e0: 6320 3d20 6463 6528 6772 6164 7472 6329  c = dce(gradtrc)
+0000a1f0: 0a0a 2020 2020 2020 2020 2320 5354 4550  ..        # STEP
+0000a200: 2054 574f 202d 2d20 5265 706c 6163 6573   TWO -- Replaces
+0000a210: 206f 7269 6769 6e61 6c20 6361 6c6c 7320   original calls 
+0000a220: 7769 7468 2067 7261 6420 6361 6c6c 730a  with grad calls.
+0000a230: 0a20 2020 2020 2020 2023 2044 6566 696e  .        # Defin
+0000a240: 6573 2074 6865 2076 6973 6974 6f72 2070  es the visitor p
+0000a250: 6174 7465 726e 2066 6f72 2074 6865 2066  attern for the f
+0000a260: 6972 7374 2070 6173 7320 6f66 2074 6865  irst pass of the
+0000a270: 2067 7261 6420 7472 616e 7366 6f72 6d2c   grad transform,
+0000a280: 0a20 2020 2020 2020 2023 2020 2077 6869  .        #   whi
+0000a290: 6368 2073 7761 7073 2042 6f75 6e64 5379  ch swaps BoundSy
+0000a2a0: 6d62 6f6c 7320 7769 7468 2074 6865 6972  mbols with their
+0000a2b0: 2067 7261 6420 6675 6e63 7469 6f6e 730a   grad functions.
+0000a2c0: 2020 2020 2020 2020 6465 6620 7669 7369          def visi
+0000a2d0: 745f 2862 7379 6d3a 2042 6f75 6e64 5379  t_(bsym: BoundSy
+0000a2e0: 6d62 6f6c 2920 2d3e 2043 616c 6c61 626c  mbol) -> Callabl
+0000a2f0: 653a 0a20 2020 2020 2020 2020 2020 2067  e:.            g
+0000a300: 7261 6466 6e3a 204e 6f6e 6520 7c20 4361  radfn: None | Ca
+0000a310: 6c6c 6162 6c65 203d 205f 6765 745f 6772  llable = _get_gr
+0000a320: 6164 666e 2862 7379 6d2c 2065 7865 6375  adfn(bsym, execu
+0000a330: 746f 7273 5f6c 6973 743d 6578 6563 7574  tors_list=execut
+0000a340: 6f72 735f 6c69 7374 290a 2020 2020 2020  ors_list).      
+0000a350: 2020 2020 2020 6368 6563 6b28 0a20 2020        check(.   
+0000a360: 2020 2020 2020 2020 2020 2020 2067 7261               gra
+0000a370: 6466 6e20 6973 206e 6f74 204e 6f6e 652c  dfn is not None,
+0000a380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a390: 206c 616d 6264 613a 2066 2246 6169 6c65   lambda: f"Faile
+0000a3a0: 6420 746f 2066 696e 6420 6120 6772 6164  d to find a grad
+0000a3b0: 666e 2066 6f72 207b 6273 796d 3d7d 2061  fn for {bsym=} a
+0000a3c0: 6674 6572 2066 6c61 7474 656e 696e 6722  fter flattening"
+0000a3d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a3e0: 2020 6578 6365 7074 696f 6e5f 7479 7065    exception_type
+0000a3f0: 3d41 7373 6572 7469 6f6e 4572 726f 722c  =AssertionError,
+0000a400: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0000a410: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000a420: 6e20 6772 6164 666e 0a0a 2020 2020 2020  n gradfn..      
+0000a430: 2020 4077 7261 7073 2874 7263 2e66 6e2e    @wraps(trc.fn.
+0000a440: 6d65 7461 2069 6620 6973 696e 7374 616e  meta if isinstan
+0000a450: 6365 2874 7263 2e66 6e2c 2053 796d 626f  ce(trc.fn, Symbo
+0000a460: 6c29 2065 6c73 6520 7472 632e 666e 290a  l) else trc.fn).
+0000a470: 2020 2020 2020 2020 6465 6620 696e 7465          def inte
+0000a480: 7270 7265 7469 6e67 5f66 6e28 2a61 7267  rpreting_fn(*arg
+0000a490: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
+0000a4a0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+0000a4b0: 203d 2065 7661 6c5f 7472 6163 6528 6772   = eval_trace(gr
+0000a4c0: 6164 7472 632c 202a 6172 6773 2c20 7379  adtrc, *args, sy
+0000a4d0: 6d62 6f6c 5f6d 6170 7065 723d 7669 7369  mbol_mapper=visi
+0000a4e0: 745f 2c20 2a2a 6b77 6172 6773 290a 2020  t_, **kwargs).  
+0000a4f0: 2020 2020 2020 2020 2020 2320 5365 7473            # Sets
+0000a500: 2067 7261 6473 2066 6f72 206f 7574 7075   grads for outpu
+0000a510: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
+0000a520: 544f 444f 2054 6869 7320 6566 6665 6374  TODO This effect
+0000a530: 6976 656c 7920 7275 6e73 2069 6e20 6120  ively runs in a 
+0000a540: 6e6f 2067 7261 6420 636f 6e74 6578 7420  no grad context 
+0000a550: 2d2d 2073 686f 756c 6420 6974 2072 756e  -- should it run
+0000a560: 2069 6e20 6120 6772 6164 2063 6f6e 7465   in a grad conte
+0000a570: 7874 2c0a 2020 2020 2020 2020 2020 2020  xt,.            
+0000a580: 2320 2020 6f72 2073 686f 756c 6420 7468  #   or should th
+0000a590: 6572 6520 6265 2074 6865 206f 7074 696f  ere be the optio
+0000a5a0: 6e20 746f 2072 756e 2069 7420 696e 2061  n to run it in a
+0000a5b0: 2067 7261 6420 636f 6e74 6578 743f 0a20   grad context?. 
+0000a5c0: 2020 2020 2020 2020 2020 2067 7261 645f             grad_
+0000a5d0: 7370 6563 6966 6965 7228 7265 7375 6c74  specifier(result
+0000a5e0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+0000a5f0: 436f 6e73 7472 7563 7473 2072 6574 7572  Constructs retur
+0000a600: 6e20 7661 6c75 650a 2020 2020 2020 2020  n value.        
+0000a610: 2020 2020 666c 6174 5f67 7261 6473 203d      flat_grads =
+0000a620: 2067 7261 645f 6f75 745f 7370 6563 6966   grad_out_specif
+0000a630: 6965 7228 2861 7267 732c 206b 7761 7267  ier((args, kwarg
+0000a640: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
+0000a650: 7265 7475 726e 2066 6c61 745f 6772 6164  return flat_grad
+0000a660: 730a 0a20 2020 2020 2020 2023 204e 4f54  s..        # NOT
+0000a670: 4520 4166 7465 7220 7468 6973 2063 616c  E After this cal
+0000a680: 6c20 7468 6520 6772 6164 7472 6320 6973  l the gradtrc is
+0000a690: 2069 6e76 616c 6964 2c20 6265 6361 7573   invalid, becaus
+0000a6a0: 653a 0a20 2020 2020 2020 2023 2020 2031  e:.        #   1
+0000a6b0: 2920 5468 6520 6e6f 6e2d 6578 6563 7574  ) The non-execut
+0000a6c0: 6162 6c65 2070 7574 5f67 7261 6420 6f70  able put_grad op
+0000a6d0: 6572 6174 696f 6e73 2061 7265 2073 7469  erations are sti
+0000a6e0: 6c6c 2069 6e20 7468 6520 7472 6163 652c  ll in the trace,
+0000a6f0: 2061 6e64 206d 756c 7469 706c 6520 6361   and multiple ca
+0000a700: 6c6c 7320 746f 2070 7574 2067 7261 6420  lls to put grad 
+0000a710: 6172 6520 6e6f 7420 6163 6375 6d75 6c61  are not accumula
+0000a720: 7465 640a 2020 2020 2020 2020 2320 2020  ted.        #   
+0000a730: 3229 2054 6865 206e 6f6e 2d65 7865 6375  2) The non-execu
+0000a740: 7461 626c 6520 6765 745f 6772 6164 206f  table get_grad o
+0000a750: 7065 7261 7469 6f6e 7320 6172 6520 7374  perations are st
+0000a760: 696c 6c20 696e 2074 6865 2074 7261 6365  ill in the trace
+0000a770: 2c20 616e 6420 7468 6579 206d 6179 2070  , and they may p
+0000a780: 726f 6475 6365 2064 6966 6665 7265 6e74  roduce different
+0000a790: 2070 726f 7869 6573 2077 6865 6e0a 2020   proxies when.  
+0000a7a0: 2020 2020 2020 2320 2020 2020 2020 6361        #       ca
+0000a7b0: 6c6c 6564 206f 6e20 7468 6520 7361 6d65  lled on the same
+0000a7c0: 2069 6e70 7574 730a 2020 2020 2020 2020   inputs.        
+0000a7d0: 2320 2020 3329 2054 6865 206f 7065 7261  #   3) The opera
+0000a7e0: 7469 6f6e 7320 6172 6520 6e6f 7420 696e  tions are not in
+0000a7f0: 2061 2076 616c 6964 206f 7264 6572 0a20   a valid order. 
+0000a800: 2020 2020 2020 2067 7261 6474 7263 203d         gradtrc =
+0000a810: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
+0000a820: 280a 2020 2020 2020 2020 2020 2020 7265  (.            re
+0000a830: 6e61 6d65 5f70 726f 7869 6573 3d46 616c  name_proxies=Fal
+0000a840: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+0000a850: 7573 655f 6463 653d 4661 6c73 652c 0a20  use_dce=False,. 
+0000a860: 2020 2020 2020 2029 2869 6e74 6572 7072         )(interpr
+0000a870: 6574 696e 675f 666e 2c20 2a67 7261 6474  eting_fn, *gradt
+0000a880: 7263 2e61 7267 732c 202a 2a67 7261 6474  rc.args, **gradt
+0000a890: 7263 2e6b 7761 7267 7329 0a20 2020 2020  rc.kwargs).     
+0000a8a0: 2020 2067 7261 6474 7263 2e73 636f 7065     gradtrc.scope
+0000a8b0: 7320 3d20 5b67 7261 6474 7263 2e62 6f75  s = [gradtrc.bou
+0000a8c0: 6e64 5f73 796d 626f 6c73 5d0a 2020 2020  nd_symbols].    
+0000a8d0: 2020 2020 6772 6164 7472 632e 5f63 6f6d      gradtrc._com
+0000a8e0: 706c 6574 6520 3d20 4661 6c73 650a 0a20  plete = False.. 
+0000a8f0: 2020 2020 2020 2023 2053 5445 5020 5448         # STEP TH
+0000a900: 5245 4520 2d2d 2048 616e 646c 6573 2070  REE -- Handles p
+0000a910: 7574 5f67 7261 6420 616e 6420 6765 745f  ut_grad and get_
+0000a920: 6772 6164 206f 7065 7261 7469 6f6e 7320  grad operations 
+0000a930: 616e 6420 6163 6375 6d75 6c61 7465 7320  and accumulates 
+0000a940: 6772 6164 6965 6e74 730a 0a20 2020 2020  gradients..     
+0000a950: 2020 2023 2041 6363 756d 756c 6174 6573     # Accumulates
+0000a960: 2067 7261 6469 656e 7473 2c20 6372 6561   gradients, crea
+0000a970: 7469 6e67 2074 6865 2070 7269 6d61 6c20  ting the primal 
+0000a980: 2d3e 2061 6363 756d 756c 6174 6564 2067  -> accumulated g
+0000a990: 7261 6420 6d61 7070 696e 670a 2020 2020  rad mapping.    
+0000a9a0: 2020 2020 2320 5365 7473 2074 6865 2074      # Sets the t
+0000a9b0: 7261 6369 6e67 2063 6f6e 7465 7874 2073  racing context s
+0000a9c0: 6f20 6163 6375 6d75 6c61 7469 6f6e 206f  o accumulation o
+0000a9d0: 7065 7261 7469 6f6e 7320 6172 6520 7265  perations are re
+0000a9e0: 636f 7264 6564 2069 6e74 6f20 7468 6520  corded into the 
+0000a9f0: 7472 6163 650a 2020 2020 2020 2020 7472  trace.        tr
+0000aa00: 793a 0a20 2020 2020 2020 2020 2020 2074  y:.            t
+0000aa10: 7261 6365 6374 785f 746f 6b20 3d20 7365  racectx_tok = se
+0000aa20: 745f 7472 6163 6563 7478 2867 7261 6474  t_tracectx(gradt
+0000aa30: 7263 290a 0a20 2020 2020 2020 2020 2020  rc)..           
+0000aa40: 2023 204d 6170 7320 7072 696d 616c 7320   # Maps primals 
+0000aa50: 746f 2074 6865 6972 2067 7261 6469 656e  to their gradien
+0000aa60: 7473 2028 7768 6963 6820 6172 6520 7265  ts (which are re
+0000aa70: 7475 726e 6564 2066 726f 6d20 6361 6c6c  turned from call
+0000aa80: 696e 6720 6765 745f 6772 6164 206f 6e20  ing get_grad on 
+0000aa90: 7468 6520 7072 696d 616c 290a 2020 2020  the primal).    
+0000aaa0: 2020 2020 2020 2020 7072 696d 616c 735f          primals_
+0000aab0: 746f 5f67 696e 7075 745f 6d61 703a 2064  to_ginput_map: d
+0000aac0: 6963 745b 5661 7269 6162 6c65 2c20 5465  ict[Variable, Te
+0000aad0: 6e73 6f72 5072 6f78 795d 203d 207b 7d0a  nsorProxy] = {}.
+0000aae0: 0a20 2020 2020 2020 2020 2020 2023 2048  .            # H
+0000aaf0: 616e 646c 6573 2070 7574 5f67 7261 6420  andles put_grad 
+0000ab00: 6f70 6572 6174 696f 6e73 0a20 2020 2020  operations.     
+0000ab10: 2020 2020 2020 2023 204e 4f54 4520 5468         # NOTE Th
+0000ab20: 6973 206d 6f64 6966 6965 7320 6120 6c69  is modifies a li
+0000ab30: 7374 2074 6861 7420 6973 2062 6569 6e67  st that is being
+0000ab40: 2065 6e75 6d65 7261 7465 6420 6f76 6572   enumerated over
+0000ab50: 2c20 6275 7420 6974 2773 204f 4b20 6265  , but it's OK be
+0000ab60: 6361 7573 6520 7765 2772 6520 6f6e 6c79  cause we're only
+0000ab70: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
+0000ab80: 2061 7070 656e 6469 6e67 2074 6f20 7468   appending to th
+0000ab90: 6520 656e 6420 6f66 2074 6865 206c 6973  e end of the lis
+0000aba0: 740a 2020 2020 2020 2020 2020 2020 6273  t.            bs
+0000abb0: 796d 3a20 426f 756e 6453 796d 626f 6c0a  ym: BoundSymbol.
+0000abc0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000abd0: 6273 796d 2069 6e20 6772 6164 7472 632e  bsym in gradtrc.
+0000abe0: 626f 756e 645f 7379 6d62 6f6c 733a 0a20  bound_symbols:. 
+0000abf0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000ac00: 643a 2048 6173 6861 626c 6520 3d20 6273  d: Hashable = bs
+0000ac10: 796d 2e73 796d 2e69 640a 2020 2020 2020  ym.sym.id.      
+0000ac20: 2020 2020 2020 2020 2020 6966 2069 6420            if id 
+0000ac30: 6973 2070 6964 732e 5055 545f 4752 4144  is pids.PUT_GRAD
+0000ac40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000ac50: 2020 2020 2020 7072 696d 616c 3a20 4e75        primal: Nu
+0000ac60: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
+0000ac70: 7879 0a20 2020 2020 2020 2020 2020 2020  xy.             
+0000ac80: 2020 2020 2020 2067 7261 643a 204e 756d         grad: Num
+0000ac90: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+0000aca0: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
+0000acb0: 2020 2020 2020 7072 696d 616c 2c20 6772        primal, gr
+0000acc0: 6164 203d 2062 7379 6d2e 666c 6174 5f61  ad = bsym.flat_a
+0000acd0: 7267 730a 0a20 2020 2020 2020 2020 2020  rgs..           
+0000ace0: 2020 2020 2020 2020 2023 2054 4f44 4f20           # TODO 
+0000acf0: 5375 7070 6f72 7420 6175 746f 6772 6164  Support autograd
+0000ad00: 206f 6e20 6e75 6d62 6572 730a 2020 2020   on numbers.    
+0000ad10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ad20: 2320 4669 6c74 6572 7320 6361 6c6c 7320  # Filters calls 
+0000ad30: 746f 2070 7574 5f67 7261 6420 7468 6174  to put_grad that
+0000ad40: 2077 6f75 6c64 2070 7574 2061 2067 7261   would put a gra
+0000ad50: 6420 6f6e 2061 206e 6f6e 2d74 656e 736f  d on a non-tenso
+0000ad60: 7220 6f72 2061 2074 656e 736f 7220 7468  r or a tensor th
+0000ad70: 6174 2064 6f65 736e 2774 2072 6571 7569  at doesn't requi
+0000ad80: 7265 2067 7261 640a 2020 2020 2020 2020  re grad.        
+0000ad90: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0000ada0: 6f74 2069 7369 6e73 7461 6e63 6528 7072  ot isinstance(pr
+0000adb0: 696d 616c 2c20 5465 6e73 6f72 5072 6f78  imal, TensorProx
+0000adc0: 7929 206f 7220 6e6f 7420 7072 696d 616c  y) or not primal
+0000add0: 2e72 6571 7569 7265 735f 6772 6164 3a0a  .requires_grad:.
+0000ade0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000adf0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+0000ae00: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000ae10: 2020 2020 2020 2320 544f 444f 2053 7570        # TODO Sup
+0000ae20: 706f 7274 2063 6f6d 706c 6578 2061 7574  port complex aut
+0000ae30: 6f67 7261 640a 2020 2020 2020 2020 2020  ograd.          
+0000ae40: 2020 2020 2020 2020 2020 6368 6563 6b28            check(
+0000ae50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ae60: 2020 2020 2020 2020 206e 6f74 2064 7479           not dty
+0000ae70: 7065 732e 6973 5f63 6f6d 706c 6578 5f64  pes.is_complex_d
+0000ae80: 7479 7065 2864 7479 7065 732e 746f 5f64  type(dtypes.to_d
+0000ae90: 7479 7065 2870 7269 6d61 6c29 292c 0a20  type(primal)),. 
+0000aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aeb0: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
+0000aec0: 2243 6f6d 706c 6578 2067 7261 6420 6973  "Complex grad is
+0000aed0: 206e 6f74 2073 7570 706f 7274 6564 2079   not supported y
+0000aee0: 6574 222c 0a20 2020 2020 2020 2020 2020  et",.           
+0000aef0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0000af00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af10: 7670 7269 6d61 6c3a 2056 6172 6961 626c  vprimal: Variabl
+0000af20: 6520 3d20 7661 7269 6162 6c65 6966 7928  e = variableify(
+0000af30: 7072 696d 616c 290a 2020 2020 2020 2020  primal).        
+0000af40: 2020 2020 2020 2020 2020 2020 6163 6375              accu
+0000af50: 6d3a 204e 6f6e 6520 7c20 5465 6e73 6f72  m: None | Tensor
+0000af60: 5072 6f78 7920 3d20 7072 696d 616c 735f  Proxy = primals_
+0000af70: 746f 5f67 696e 7075 745f 6d61 702e 6765  to_ginput_map.ge
+0000af80: 7428 7670 7269 6d61 6c2c 204e 6f6e 6529  t(vprimal, None)
+0000af90: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000afa0: 2020 2020 2020 6966 2061 6363 756d 2069        if accum i
+0000afb0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
 0000afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000afd0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000afe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aff0: 2020 6163 6375 6d20 3d20 6163 6375 6d20    accum = accum 
-0000b000: 2b20 6772 6164 0a20 2020 2020 2020 2020  + grad.         
-0000b010: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000b020: 7269 6d61 6c73 5f74 6f5f 6769 6e70 7574  rimals_to_ginput
-0000b030: 5f6d 6170 5b76 7072 696d 616c 5d20 3d20  _map[vprimal] = 
-0000b040: 6163 6375 6d0a 0a20 2020 2020 2020 2020  accum..         
-0000b050: 2020 2023 2048 616e 646c 6573 2067 6574     # Handles get
-0000b060: 5f67 7261 6420 6f70 6572 6174 696f 6e73  _grad operations
-0000b070: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000b080: 5265 7365 7473 2074 6865 2073 7761 706d  Resets the swapm
-0000b090: 6170 2066 6f72 2067 7261 6473 0a20 2020  ap for grads.   
-0000b0a0: 2020 2020 2020 2020 2073 7761 706d 6170           swapmap
-0000b0b0: 3a20 6469 6374 5b56 6172 6961 626c 652c  : dict[Variable,
-0000b0c0: 2050 726f 7879 5d20 3d20 7b7d 0a0a 2020   Proxy] = {}..  
-0000b0d0: 2020 2020 2020 2020 2020 666f 7220 6273            for bs
-0000b0e0: 796d 2069 6e20 6772 6164 7472 632e 626f  ym in gradtrc.bo
-0000b0f0: 756e 645f 7379 6d62 6f6c 733a 0a20 2020  und_symbols:.   
-0000b100: 2020 2020 2020 2020 2020 2020 2069 643a               id:
-0000b110: 2048 6173 6861 626c 6520 3d20 6273 796d   Hashable = bsym
-0000b120: 2e73 796d 2e69 640a 2020 2020 2020 2020  .sym.id.        
-0000b130: 2020 2020 2020 2020 6966 2069 6420 6973          if id is
-0000b140: 2070 6964 732e 4745 545f 4752 4144 3a0a   pids.GET_GRAD:.
-0000b150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b160: 2020 2020 7072 696d 616c 3a20 4e75 6d62      primal: Numb
-0000b170: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-0000b180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b190: 2020 2020 2028 7072 696d 616c 2c29 203d       (primal,) =
-0000b1a0: 2062 7379 6d2e 666c 6174 5f61 7267 730a   bsym.flat_args.
-0000b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1c0: 2020 2020 6772 6164 3a20 4e75 6d62 6572      grad: Number
-0000b1d0: 207c 2054 656e 736f 7250 726f 7879 203d   | TensorProxy =
-0000b1e0: 2062 7379 6d2e 6f75 7470 7574 0a0a 2020   bsym.output..  
-0000b1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b200: 2020 7670 7269 6d61 6c3a 2056 6172 6961    vprimal: Varia
-0000b210: 626c 650a 2020 2020 2020 2020 2020 2020  ble.            
-0000b220: 2020 2020 2020 2020 7667 7261 643a 2056          vgrad: V
-0000b230: 6172 6961 626c 650a 2020 2020 2020 2020  ariable.        
-0000b240: 2020 2020 2020 2020 2020 2020 7670 7269              vpri
-0000b250: 6d61 6c2c 2076 6772 6164 203d 2076 6172  mal, vgrad = var
-0000b260: 6961 626c 6569 6679 2870 7269 6d61 6c29  iableify(primal)
-0000b270: 2c20 7661 7269 6162 6c65 6966 7928 6772  , variableify(gr
-0000b280: 6164 290a 0a20 2020 2020 2020 2020 2020  ad)..           
-0000b290: 2020 2020 2020 2020 2061 6374 7561 6c5f           actual_
-0000b2a0: 6772 6164 3a20 4e6f 6e65 207c 2054 656e  grad: None | Ten
-0000b2b0: 736f 7250 726f 7879 203d 2070 7269 6d61  sorProxy = prima
-0000b2c0: 6c73 5f74 6f5f 6769 6e70 7574 5f6d 6170  ls_to_ginput_map
-0000b2d0: 2e67 6574 2876 7072 696d 616c 2c20 4e6f  .get(vprimal, No
-0000b2e0: 6e65 290a 0a20 2020 2020 2020 2020 2020  ne)..           
-0000b2f0: 2020 2020 2020 2020 2023 204e 4f54 4520           # NOTE 
-0000b300: 4966 2061 6374 7561 6c5f 6772 6164 2069  If actual_grad i
-0000b310: 7320 4e6f 6e65 2074 6865 6e20 7468 6572  s None then ther
-0000b320: 6527 7320 6120 6765 745f 6772 6164 2829  e's a get_grad()
-0000b330: 2072 6571 7565 7374 2066 6f72 2061 2074   request for a t
-0000b340: 656e 736f 7220 7768 6963 680a 2020 2020  ensor which.    
-0000b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b360: 2320 2020 6861 7320 6e6f 2070 7574 5f67  #   has no put_g
-0000b370: 7261 6428 292c 2073 6f20 7765 2072 6574  rad(), so we ret
-0000b380: 7572 6e20 7a65 726f 7320 666f 7220 7468  urn zeros for th
-0000b390: 6520 6772 6164 0a20 2020 2020 2020 2020  e grad.         
-0000b3a0: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
-0000b3b0: 4f20 5265 7669 7369 7420 7468 6973 202d  O Revisit this -
-0000b3c0: 2d20 6361 6e20 7765 2072 656d 6f76 6520  - can we remove 
-0000b3d0: 7468 6573 6520 636f 6d70 7574 6174 696f  these computatio
-0000b3e0: 6e73 2c20 6f72 2075 7365 2061 2073 7065  ns, or use a spe
-0000b3f0: 6369 616c 205a 6572 6f54 656e 736f 720a  cial ZeroTensor.
-0000b400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b410: 2020 2020 2320 2020 746f 2073 696d 706c      #   to simpl
-0000b420: 6966 7920 7468 656d 3f0a 2020 2020 2020  ify them?.      
-0000b430: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000b440: 2061 6374 7561 6c5f 6772 6164 2069 7320   actual_grad is 
-0000b450: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000b460: 2020 2020 2020 2020 2020 2020 2020 6163                ac
-0000b470: 7475 616c 5f67 7261 6420 3d20 6c74 6f72  tual_grad = ltor
-0000b480: 6368 2e7a 6572 6f73 5f6c 696b 6528 7072  ch.zeros_like(pr
-0000b490: 696d 616c 290a 2020 2020 2020 2020 2020  imal).          
-0000b4a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0000b4b0: 696d 616c 735f 746f 5f67 696e 7075 745f  imals_to_ginput_
-0000b4c0: 6d61 705b 7670 7269 6d61 6c5d 203d 2061  map[vprimal] = a
-0000b4d0: 6374 7561 6c5f 6772 6164 0a0a 2020 2020  ctual_grad..    
-0000b4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b4f0: 2320 5570 6461 7465 7320 7468 6520 6772  # Updates the gr
-0000b500: 6164 2061 6c69 6173 206d 6170 0a20 2020  ad alias map.   
-0000b510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b520: 2076 6163 7475 616c 5f67 7261 643a 2056   vactual_grad: V
-0000b530: 6172 6961 626c 6520 3d20 7661 7269 6162  ariable = variab
-0000b540: 6c65 6966 7928 6163 7475 616c 5f67 7261  leify(actual_gra
-0000b550: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
-0000b560: 2020 2020 2020 2069 6620 7661 6374 7561         if vactua
-0000b570: 6c5f 6772 6164 2021 3d20 7667 7261 643a  l_grad != vgrad:
-0000b580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b590: 2020 2020 2020 2020 2073 7761 706d 6170           swapmap
-0000b5a0: 5b76 6772 6164 5d20 3d20 6163 7475 616c  [vgrad] = actual
-0000b5b0: 5f67 7261 640a 0a20 2020 2020 2020 2066  _grad..        f
-0000b5c0: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
-0000b5d0: 2020 2020 2320 5265 7374 6f72 6573 2073      # Restores s
-0000b5e0: 636f 7065 0a20 2020 2020 2020 2020 2020  cope.           
-0000b5f0: 2072 6573 6574 5f74 7261 6365 6374 7828   reset_tracectx(
-0000b600: 7472 6163 6563 7478 5f74 6f6b 290a 0a20  tracectx_tok).. 
-0000b610: 2020 2020 2020 2023 2046 696c 7465 7273         # Filters
-0000b620: 2070 7574 5f67 7261 6420 616e 6420 6765   put_grad and ge
-0000b630: 745f 6772 6164 206f 7065 7261 7469 6f6e  t_grad operation
-0000b640: 7320 616e 6420 6170 706c 6965 7320 7468  s and applies th
-0000b650: 6520 7377 6170 6d61 700a 2020 2020 2020  e swapmap.      
-0000b660: 2020 6465 6620 5f66 696c 7465 7228 6273    def _filter(bs
-0000b670: 796d 3a20 426f 756e 6453 796d 626f 6c29  ym: BoundSymbol)
-0000b680: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
-0000b690: 2020 2020 2020 6964 3a20 4861 7368 6162        id: Hashab
-0000b6a0: 6c65 203d 2062 7379 6d2e 7379 6d2e 6964  le = bsym.sym.id
-0000b6b0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000b6c0: 7572 6e20 6964 2069 6e20 2870 6964 732e  urn id in (pids.
-0000b6d0: 5055 545f 4752 4144 2c20 7069 6473 2e47  PUT_GRAD, pids.G
-0000b6e0: 4554 5f47 5241 4429 0a0a 2020 2020 2020  ET_GRAD)..      
-0000b6f0: 2020 6772 6164 7472 632e 626f 756e 645f    gradtrc.bound_
-0000b700: 7379 6d62 6f6c 7320 3d20 5b0a 2020 2020  symbols = [.    
-0000b710: 2020 2020 2020 2020 6273 796d 2e66 726f          bsym.fro
-0000b720: 6d5f 6273 796d 5f73 7761 705f 7072 6f78  m_bsym_swap_prox
-0000b730: 6965 7328 7377 6170 6d61 7029 2066 6f72  ies(swapmap) for
-0000b740: 2062 7379 6d20 696e 2067 7261 6474 7263   bsym in gradtrc
-0000b750: 2e62 6f75 6e64 5f73 796d 626f 6c73 2069  .bound_symbols i
-0000b760: 6620 6e6f 7420 5f66 696c 7465 7228 6273  f not _filter(bs
-0000b770: 796d 290a 2020 2020 2020 2020 5d0a 0a20  ym).        ].. 
-0000b780: 2020 2020 2020 2023 2053 5445 5020 464f         # STEP FO
-0000b790: 5552 202d 2d2d 204f 7264 6572 7320 7468  UR --- Orders th
-0000b7a0: 6520 6f70 6572 6174 696f 6e73 0a20 2020  e operations.   
-0000b7b0: 2020 2020 2023 2054 4f44 4f20 436f 6e73       # TODO Cons
-0000b7c0: 6964 6572 2061 6c74 6572 6e61 7469 7665  ider alternative
-0000b7d0: 2073 6368 6564 756c 696e 6720 616c 676f   scheduling algo
-0000b7e0: 7269 7468 6d73 2c20 6d61 7962 6520 6279  rithms, maybe by
-0000b7f0: 2075 7369 6e67 2067 7261 7068 2066 6561   using graph fea
-0000b800: 7475 7265 730a 2020 2020 2020 2020 2320  tures.        # 
-0000b810: 2020 536f 6d65 2069 6465 6173 2061 7265    Some ideas are
-0000b820: 206c 6f6f 6b69 6e67 2061 7420 6d65 6d6f   looking at memo
-0000b830: 7279 2d73 6176 696e 6720 6e6f 6465 732c  ry-saving nodes,
-0000b840: 2061 6e64 206e 6f64 6573 2077 6974 6820   and nodes with 
-0000b850: 6120 6869 6768 2069 6e2d 6465 6772 6565  a high in-degree
-0000b860: 206f 7220 6869 6768 206f 7574 2d64 6567   or high out-deg
-0000b870: 7265 650a 0a20 2020 2020 2020 2023 2043  ree..        # C
-0000b880: 7265 6174 6573 2061 6e20 696e 6974 6961  reates an initia
-0000b890: 6c20 7661 6c69 6420 6f72 6465 7269 6e67  l valid ordering
-0000b8a0: 2074 6f20 4443 452c 2073 6f20 7468 6174   to DCE, so that
-0000b8b0: 2061 6464 6974 696f 6e61 6c20 6f72 6465   additional orde
-0000b8c0: 7269 6e67 2061 6e61 6c79 7369 7320 646f  ring analysis do
-0000b8d0: 6573 6e27 7420 6e65 6564 2074 6f20 636f  esn't need to co
-0000b8e0: 6e73 6964 6572 2061 6c6c 2073 796d 626f  nsider all symbo
-0000b8f0: 6c73 0a20 2020 2020 2020 2072 6f6f 7473  ls.        roots
-0000b900: 2c20 6c65 6176 6573 203d 2062 7379 6d5f  , leaves = bsym_
-0000b910: 6c69 7374 5f74 6f5f 6461 6728 6772 6164  list_to_dag(grad
-0000b920: 7472 632e 626f 756e 645f 7379 6d62 6f6c  trc.bound_symbol
-0000b930: 7329 0a20 2020 2020 2020 206f 7264 6572  s).        order
-0000b940: 6564 5f62 7379 6d73 203d 2074 6f70 6f73  ed_bsyms = topos
-0000b950: 6f72 745f 6273 796d 5f64 6167 2872 6f6f  ort_bsym_dag(roo
-0000b960: 7473 2c20 544f 504f 534f 5254 5f4f 5244  ts, TOPOSORT_ORD
-0000b970: 4552 2e54 4f50 5f44 4f57 4e29 0a20 2020  ER.TOP_DOWN).   
-0000b980: 2020 2020 2067 7261 6474 7263 2e62 6f75       gradtrc.bou
-0000b990: 6e64 5f73 796d 626f 6c73 203d 206f 7264  nd_symbols = ord
-0000b9a0: 6572 6564 5f62 7379 6d73 0a20 2020 2020  ered_bsyms.     
-0000b9b0: 2020 2067 7261 6474 7263 203d 2064 6365     gradtrc = dce
-0000b9c0: 2867 7261 6474 7263 290a 0a20 2020 2020  (gradtrc)..     
-0000b9d0: 2020 2023 2049 6465 6e74 6966 6965 7320     # Identifies 
-0000b9e0: 7468 6520 6f72 6465 7220 6f66 2042 6f75  the order of Bou
-0000b9f0: 6e64 5379 6d62 6f6c 7320 7573 696e 6720  ndSymbols using 
-0000ba00: 6120 2244 4653 2061 6e64 2063 6861 696e  a "DFS and chain
-0000ba10: 2220 616c 676f 7269 7468 6d0a 2020 2020  " algorithm.    
-0000ba20: 2020 2020 2320 544f 444f 2045 6c61 626f      # TODO Elabo
-0000ba30: 7261 7465 206f 6e20 7468 6973 2061 6c67  rate on this alg
-0000ba40: 6f72 6974 686d 2061 6e64 2074 6865 2069  orithm and the i
-0000ba50: 6d70 6c65 6d65 6e74 6174 696f 6e0a 2020  mplementation.  
-0000ba60: 2020 2020 2020 726f 6f74 732c 206c 6561        roots, lea
-0000ba70: 7665 7320 3d20 6273 796d 5f6c 6973 745f  ves = bsym_list_
-0000ba80: 746f 5f64 6167 2867 7261 6474 7263 2e62  to_dag(gradtrc.b
-0000ba90: 6f75 6e64 5f73 796d 626f 6c73 290a 2020  ound_symbols).  
-0000baa0: 2020 2020 2020 6368 6563 6b28 0a20 2020        check(.   
-0000bab0: 2020 2020 2020 2020 206c 656e 286c 6561           len(lea
-0000bac0: 7665 7329 203d 3d20 312c 0a20 2020 2020  ves) == 1,.     
-0000bad0: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
-0000bae0: 2245 7870 6563 7465 6420 6f6e 6c79 206f  "Expected only o
-0000baf0: 6e65 206c 6561 6620 6e6f 6465 2077 6865  ne leaf node whe
-0000bb00: 6e20 736f 7274 696e 6720 666f 7220 6772  n sorting for gr
-0000bb10: 6164 2c20 666f 756e 6420 7468 6572 6520  ad, found there 
-0000bb20: 7765 7265 207b 6c65 6e28 6c65 6176 6573  were {len(leaves
-0000bb30: 297d 206c 6561 7665 7322 2c0a 2020 2020  )} leaves",.    
-0000bb40: 2020 2020 290a 2020 2020 2020 2020 286c      ).        (l
-0000bb50: 6561 662c 2920 3d20 6c65 6176 6573 0a0a  eaf,) = leaves..
-0000bb60: 2020 2020 2020 2020 2320 436f 6d70 7574          # Comput
-0000bb70: 6573 2074 6865 2074 656e 736f 7220 6d65  es the tensor me
-0000bb80: 6d6f 7279 2075 7365 6420 6279 2074 6865  mory used by the
-0000bb90: 2067 6976 656e 2070 7974 7265 650a 2020   given pytree.  
-0000bba0: 2020 2020 2020 6465 6620 6d65 6d6f 7279        def memory
-0000bbb0: 5f75 7365 6428 7079 7472 6565 2920 2d3e  _used(pytree) ->
-0000bbc0: 2069 6e74 3a0a 2020 2020 2020 2020 2020   int:.          
-0000bbd0: 2020 6d65 6d6f 7279 5f75 7365 3a20 696e    memory_use: in
-0000bbe0: 7420 3d20 300a 0a20 2020 2020 2020 2020  t = 0..         
-0000bbf0: 2020 2064 6566 2063 6f75 6e74 5f6d 656d     def count_mem
-0000bc00: 6f72 795f 7573 6528 7829 3a0a 2020 2020  ory_use(x):.    
-0000bc10: 2020 2020 2020 2020 2020 2020 6e6f 6e6c              nonl
-0000bc20: 6f63 616c 206d 656d 6f72 795f 7573 650a  ocal memory_use.
-0000bc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc40: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
-0000bc50: 2054 656e 736f 7250 726f 7879 293a 0a20   TensorProxy):. 
-0000bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc70: 2020 206d 656d 6f72 795f 7573 6520 2b3d     memory_use +=
-0000bc80: 2078 2e64 7479 7065 2e5f 6279 7465 7320   x.dtype._bytes 
-0000bc90: 2a20 782e 6e75 6d65 6c0a 0a20 2020 2020  * x.numel..     
-0000bca0: 2020 2020 2020 2074 7265 655f 6d61 7028         tree_map(
-0000bcb0: 636f 756e 745f 6d65 6d6f 7279 5f75 7365  count_memory_use
-0000bcc0: 2c20 7079 7472 6565 290a 2020 2020 2020  , pytree).      
-0000bcd0: 2020 2020 2020 7265 7475 726e 206d 656d        return mem
-0000bce0: 6f72 795f 7573 650a 0a20 2020 2020 2020  ory_use..       
-0000bcf0: 2023 2054 7275 6520 7768 656e 2061 206e   # True when a n
-0000bd00: 6f64 6520 6973 2061 2022 6c69 6e6b 2220  ode is a "link" 
-0000bd10: 2d2d 2061 206e 6f64 6520 7769 7468 206f  -- a node with o
-0000bd20: 6e6c 7920 6f6e 6520 6368 696c 6420 616e  nly one child an
-0000bd30: 6420 6174 206d 6f73 7420 6f6e 6520 7061  d at most one pa
-0000bd40: 7265 6e74 0a20 2020 2020 2020 2023 2020  rent.        #  
-0000bd50: 2043 6f6e 6365 7074 7561 6c6c 7920 7468   Conceptually th
-0000bd60: 6520 6e6f 6465 2069 7320 6120 226c 696e  e node is a "lin
-0000bd70: 6b22 2069 6e20 6120 6368 6169 6e20 6f66  k" in a chain of
-0000bd80: 206e 6f64 6573 206c 696b 6520 4120 2d3e   nodes like A ->
-0000bd90: 2042 202d 3e20 430a 2020 2020 2020 2020   B -> C.        
-0000bda0: 6465 6620 6973 5f6c 696e 6b28 6e3a 204e  def is_link(n: N
-0000bdb0: 6f64 6529 202d 3e20 626f 6f6c 3a0a 2020  ode) -> bool:.  
-0000bdc0: 2020 2020 2020 2020 2020 5f69 735f 6c69            _is_li
-0000bdd0: 6e6b 203d 206c 656e 286e 2e63 6869 6c64  nk = len(n.child
-0000bde0: 7265 6e29 203d 3d20 3120 616e 6420 6c65  ren) == 1 and le
-0000bdf0: 6e28 6e2e 7061 7265 6e74 7329 203c 3d20  n(n.parents) <= 
-0000be00: 310a 2020 2020 2020 2020 2020 2020 7265  1.            re
-0000be10: 7475 726e 205f 6973 5f6c 696e 6b0a 0a20  turn _is_link.. 
-0000be20: 2020 2020 2020 2063 6f75 6e74 6572 3a20         counter: 
-0000be30: 696e 7420 3d20 300a 0a20 2020 2020 2020  int = 0..       
-0000be40: 2064 6566 205f 6368 6169 6e28 633a 206c   def _chain(c: l
-0000be50: 6973 745b 4e6f 6465 5d2c 2065 6e64 3a20  ist[Node], end: 
-0000be60: 4e6f 6465 2920 2d3e 206c 6973 745b 4e6f  Node) -> list[No
-0000be70: 6465 5d3a 0a20 2020 2020 2020 2020 2020  de]:.           
-0000be80: 206e 6f6e 6c6f 6361 6c20 636f 756e 7465   nonlocal counte
-0000be90: 720a 0a20 2020 2020 2020 2020 2020 2023  r..            #
-0000bea0: 2054 4f44 4f20 4578 7065 7269 6d65 6e74   TODO Experiment
-0000beb0: 2077 6974 6820 6e6f 7420 616c 7761 7973   with not always
-0000bec0: 2066 7573 696e 6720 7468 6973 2069 6e74   fusing this int
-0000bed0: 6f20 7468 6520 636f 6e73 756d 6572 202d  o the consumer -
-0000bee0: 2d20 7468 6572 6520 636f 756c 6420 6265  - there could be
-0000bef0: 2061 6e0a 2020 2020 2020 2020 2020 2020   an.            
-0000bf00: 2320 2020 696e 7465 7265 7374 696e 6720  #   interesting 
-0000bf10: 6d69 6e63 7574 0a20 2020 2020 2020 2020  mincut.         
-0000bf20: 2020 2023 204e 4f54 4520 496e 2074 6869     # NOTE In thi
-0000bf30: 7320 6361 7365 2074 6865 2063 6861 696e  s case the chain
-0000bf40: 2063 616e 6e6f 7420 6265 2065 7874 656e   cannot be exten
-0000bf50: 6465 642c 2061 6e64 2069 7473 206f 7269  ded, and its ori
-0000bf60: 6769 6e20 6973 2069 6e70 7574 2074 6f20  gin is input to 
-0000bf70: 7468 6520 6675 6e63 7469 6f6e 0a20 2020  the function.   
-0000bf80: 2020 2020 2020 2020 2023 2020 2073 6f20           #   so 
-0000bf90: 7468 6973 206a 7573 7420 6675 7365 7320  this just fuses 
-0000bfa0: 6974 2069 6e74 6f20 7468 6520 636f 6e73  it into the cons
-0000bfb0: 756d 6572 0a20 2020 2020 2020 2020 2020  umer.           
-0000bfc0: 2069 6620 6c65 6e28 656e 642e 7061 7265   if len(end.pare
-0000bfd0: 6e74 7329 203d 3d20 303a 0a20 2020 2020  nts) == 0:.     
-0000bfe0: 2020 2020 2020 2020 2020 2066 6f72 206e             for n
-0000bff0: 2069 6e20 633a 0a20 2020 2020 2020 2020   in c:.         
-0000c000: 2020 2020 2020 2020 2020 206e 2e6e 756d             n.num
-0000c010: 6265 7220 3d20 636f 756e 7465 720a 2020  ber = counter.  
-0000c020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c030: 2020 636f 756e 7465 7220 2b3d 2031 0a20    counter += 1. 
-0000c040: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000c050: 6574 7572 6e20 5b5d 0a0a 2020 2020 2020  eturn []..      
-0000c060: 2020 2020 2020 2320 4e4f 5445 206c 656e        # NOTE len
-0000c070: 2865 6e64 2e70 6172 656e 7473 2920 3d3d  (end.parents) ==
-0000c080: 2031 206f 6e20 7468 6973 2070 6174 680a   1 on this path.
-0000c090: 2020 2020 2020 2020 2020 2020 2870 6172              (par
-0000c0a0: 656e 742c 2920 3d20 656e 642e 7061 7265  ent,) = end.pare
-0000c0b0: 6e74 730a 0a20 2020 2020 2020 2020 2020  nts..           
-0000c0c0: 2023 2045 7874 656e 6473 2074 6865 2063   # Extends the c
-0000c0d0: 6861 696e 2069 6620 7468 6520 7061 7265  hain if the pare
-0000c0e0: 6e74 2069 7320 6120 6c69 6e6b 0a20 2020  nt is a link.   
-0000c0f0: 2020 2020 2020 2020 2069 6620 6973 5f6c           if is_l
-0000c100: 696e 6b28 7061 7265 6e74 293a 0a20 2020  ink(parent):.   
-0000c110: 2020 2020 2020 2020 2020 2020 2063 2e61               c.a
-0000c120: 7070 656e 6428 7061 7265 6e74 290a 2020  ppend(parent).  
-0000c130: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000c140: 7475 726e 205f 6368 6169 6e28 632c 2070  turn _chain(c, p
-0000c150: 6172 656e 7429 0a0a 2020 2020 2020 2020  arent)..        
-0000c160: 2020 2020 2320 4e4f 5445 2049 6e20 7468      # NOTE In th
-0000c170: 6973 2063 6173 6520 7468 6520 6368 6169  is case the chai
-0000c180: 6e20 6861 7320 6120 7061 7265 6e74 2074  n has a parent t
-0000c190: 6861 7420 6973 206e 6f74 2061 206c 696e  hat is not a lin
-0000c1a0: 6b0a 2020 2020 2020 2020 2020 2020 2320  k.            # 
-0000c1b0: 4669 6e64 7320 7468 6520 6d69 6e63 7574  Finds the mincut
-0000c1c0: 0a20 2020 2020 2020 2020 2020 206d 696e  .            min
-0000c1d0: 6375 745f 6964 783a 2069 6e74 203d 206c  cut_idx: int = l
-0000c1e0: 656e 2863 290a 2020 2020 2020 2020 2020  en(c).          
-0000c1f0: 2020 6d69 6e5f 6d65 6d6f 7279 5f75 7361    min_memory_usa
-0000c200: 6765 3a20 696e 7420 3d20 6d65 6d6f 7279  ge: int = memory
-0000c210: 5f75 7365 6428 7061 7265 6e74 2e62 7379  _used(parent.bsy
-0000c220: 6d2e 6f75 7470 7574 290a 0a20 2020 2020  m.output)..     
-0000c230: 2020 2020 2020 2066 6f72 2069 6478 2c20         for idx, 
-0000c240: 6e20 696e 2065 6e75 6d65 7261 7465 2863  n in enumerate(c
-0000c250: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000c260: 2020 206d 656d 203d 206d 656d 6f72 795f     mem = memory_
-0000c270: 7573 6564 286e 2e62 7379 6d2e 6f75 7470  used(n.bsym.outp
-0000c280: 7574 290a 2020 2020 2020 2020 2020 2020  ut).            
-0000c290: 2020 2020 6966 206d 656d 203c 206d 696e      if mem < min
-0000c2a0: 5f6d 656d 6f72 795f 7573 6167 653a 0a20  _memory_usage:. 
-0000c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2c0: 2020 206d 696e 6375 745f 6964 7820 3d20     mincut_idx = 
-0000c2d0: 6964 780a 2020 2020 2020 2020 2020 2020  idx.            
-0000c2e0: 2020 2020 2020 2020 6d69 6e5f 6d65 6d6f          min_memo
-0000c2f0: 7279 5f75 7361 6765 203d 206d 656d 0a0a  ry_usage = mem..
-0000c300: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000c310: 6964 782c 206e 2069 6e20 656e 756d 6572  idx, n in enumer
-0000c320: 6174 6528 6329 3a0a 2020 2020 2020 2020  ate(c):.        
-0000c330: 2020 2020 2020 2020 6966 2069 6478 203c          if idx <
-0000c340: 206d 696e 6375 745f 6964 783a 0a20 2020   mincut_idx:.   
-0000c350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c360: 206e 2e6e 756d 6265 7220 3d20 636f 756e   n.number = coun
-0000c370: 7465 720a 2020 2020 2020 2020 2020 2020  ter.            
-0000c380: 2020 2020 2020 2020 636f 756e 7465 7220          counter 
-0000c390: 2b3d 2031 0a0a 2020 2020 2020 2020 2020  += 1..          
-0000c3a0: 2020 2320 5265 7475 726e 7320 7468 6520    # Returns the 
-0000c3b0: 7072 6f64 7563 6572 2d73 6964 6520 6368  producer-side ch
-0000c3c0: 6169 6e20 6375 7420 6966 2069 7420 6578  ain cut if it ex
-0000c3d0: 6973 7473 0a20 2020 2020 2020 2020 2020  ists.           
-0000c3e0: 2069 6620 6d69 6e63 7574 5f69 6478 203c   if mincut_idx <
-0000c3f0: 206c 656e 2863 293a 0a20 2020 2020 2020   len(c):.       
-0000c400: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000c410: 5b63 5b6d 696e 6375 745f 6964 785d 5d0a  [c[mincut_idx]].
-0000c420: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000c430: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c440: 2020 6173 7365 7274 206d 696e 6375 745f    assert mincut_
-0000c450: 6964 7820 3d3d 206c 656e 2863 290a 2020  idx == len(c).  
-0000c460: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000c470: 7475 726e 2065 6e64 2e70 6172 656e 7473  turn end.parents
-0000c480: 0a0a 2020 2020 2020 2020 6465 6620 6368  ..        def ch
-0000c490: 6169 6e5f 6f75 7428 6e3a 204e 6f64 652c  ain_out(n: Node,
-0000c4a0: 2073 7461 636b 3a20 6c69 7374 5b4e 6f64   stack: list[Nod
-0000c4b0: 655d 2920 2d3e 204e 6f6e 653a 0a20 2020  e]) -> None:.   
-0000c4c0: 2020 2020 2020 2020 2023 2053 686f 7274           # Short
-0000c4d0: 2d63 6972 6375 6974 7320 6966 2074 6865  -circuits if the
-0000c4e0: 206f 7269 6769 6e61 6c20 6e6f 6465 206e   original node n
-0000c4f0: 2063 616e 6e6f 7420 6265 2070 6172 7420   cannot be part 
-0000c500: 6f66 2061 2063 6861 696e 0a20 2020 2020  of a chain.     
-0000c510: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
-0000c520: 5f6c 696e 6b28 6e29 3a0a 2020 2020 2020  _link(n):.      
-0000c530: 2020 2020 2020 2020 2020 7374 6163 6b2e            stack.
-0000c540: 6170 7065 6e64 286e 290a 2020 2020 2020  append(n).      
-0000c550: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000c560: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000c570: 4e4f 5445 2069 735f 6c69 6e6b 286e 2920  NOTE is_link(n) 
-0000c580: 3d3d 2054 7275 650a 2020 2020 2020 2020  == True.        
-0000c590: 2020 2020 706f 7374 5f63 6861 696e 3a20      post_chain: 
-0000c5a0: 6c69 7374 5b4e 6f64 655d 203d 205f 6368  list[Node] = _ch
-0000c5b0: 6169 6e28 5b6e 5d2c 206e 290a 0a20 2020  ain([n], n)..   
-0000c5c0: 2020 2020 2020 2020 2066 6f72 2070 6320           for pc 
-0000c5d0: 696e 2070 6f73 745f 6368 6169 6e3a 0a20  in post_chain:. 
-0000c5e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000c5f0: 7461 636b 2e61 7070 656e 6428 7063 290a  tack.append(pc).
-0000c600: 0a20 2020 2020 2020 2073 7461 636b 3a20  .        stack: 
-0000c610: 6c69 7374 5b4e 6f64 655d 203d 205b 6c65  list[Node] = [le
-0000c620: 6166 5d0a 2020 2020 2020 2020 7768 696c  af].        whil
-0000c630: 6520 6c65 6e28 7374 6163 6b29 203e 2030  e len(stack) > 0
-0000c640: 3a0a 2020 2020 2020 2020 2020 2020 6e3a  :.            n:
-0000c650: 204e 6f64 6520 3d20 7374 6163 6b2e 706f   Node = stack.po
-0000c660: 7028 290a 0a20 2020 2020 2020 2020 2020  p()..           
-0000c670: 2069 6620 6e2e 6e75 6d62 6572 2069 7320   if n.number is 
-0000c680: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0000c690: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-0000c6a0: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
-0000c6b0: 6e2e 6e75 6d62 6572 203d 2063 6f75 6e74  n.number = count
-0000c6c0: 6572 0a20 2020 2020 2020 2020 2020 2063  er.            c
-0000c6d0: 6f75 6e74 6572 202b 3d20 310a 0a20 2020  ounter += 1..   
-0000c6e0: 2020 2020 2020 2020 2066 6f72 2070 2069           for p i
-0000c6f0: 6e20 6e2e 7061 7265 6e74 733a 0a20 2020  n n.parents:.   
-0000c700: 2020 2020 2020 2020 2020 2020 2063 6861               cha
-0000c710: 696e 5f6f 7574 2870 2c20 7374 6163 6b29  in_out(p, stack)
-0000c720: 0a0a 2020 2020 2020 2020 6465 6620 5f73  ..        def _s
-0000c730: 656c 6563 746f 7228 656c 6967 6962 6c65  elector(eligible
-0000c740: 5f6e 6f64 6573 3a20 6c69 7374 5b4e 6f64  _nodes: list[Nod
-0000c750: 655d 2920 2d3e 2069 6e74 3a0a 2020 2020  e]) -> int:.    
-0000c760: 2020 2020 2020 2020 6d69 6e5f 6964 783a          min_idx:
-0000c770: 2069 6e74 203d 2030 0a20 2020 2020 2020   int = 0.       
-0000c780: 2020 2020 206d 696e 5f6e 756d 6265 723a       min_number:
-0000c790: 2069 6e74 203d 2065 6c69 6769 626c 655f   int = eligible_
-0000c7a0: 6e6f 6465 735b 305d 2e6e 756d 6265 720a  nodes[0].number.
-0000c7b0: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
-0000c7c0: 4f54 4520 416c 7468 6f75 6768 2077 6527  OTE Although we'
-0000c7d0: 7665 2061 6c72 6561 6479 2070 726f 6365  ve already proce
-0000c7e0: 7373 6564 2074 6865 2066 6972 7374 2065  ssed the first e
-0000c7f0: 6c65 6d65 6e74 2068 6572 652c 2074 6869  lement here, thi
-0000c800: 7320 7374 696c 6c0a 2020 2020 2020 2020  s still.        
-0000c810: 2020 2020 2320 2020 656e 756d 6572 6174      #   enumerat
-0000c820: 6573 2074 6865 2065 6e74 6972 6520 6c69  es the entire li
-0000c830: 7374 2063 2074 6f20 616c 6967 6e20 7468  st c to align th
-0000c840: 6520 656e 756d 6572 6174 696f 6e20 6964  e enumeration id
-0000c850: 7820 7072 6f70 6572 6c79 0a20 2020 2020  x properly.     
-0000c860: 2020 2020 2020 2066 6f72 2069 6478 2c20         for idx, 
-0000c870: 6e20 696e 2065 6e75 6d65 7261 7465 2865  n in enumerate(e
-0000c880: 6c69 6769 626c 655f 6e6f 6465 7329 3a0a  ligible_nodes):.
-0000c890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c8a0: 6368 6563 6b28 6e2e 6e75 6d62 6572 2069  check(n.number i
-0000c8b0: 7320 6e6f 7420 4e6f 6e65 2c20 6c61 6d62  s not None, lamb
-0000c8c0: 6461 3a20 6622 4578 7065 6374 6564 2065  da: f"Expected e
-0000c8d0: 6163 6820 6e6f 6465 2074 6f20 6265 206e  ach node to be n
-0000c8e0: 756d 6265 7265 642c 2062 7574 207b 6e7d  umbered, but {n}
-0000c8f0: 2077 6173 206e 6f74 2229 0a0a 2020 2020   was not")..    
-0000c900: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0000c910: 2e6e 756d 6265 7220 3c20 6d69 6e5f 6e75  .number < min_nu
-0000c920: 6d62 6572 3a0a 2020 2020 2020 2020 2020  mber:.          
-0000c930: 2020 2020 2020 2020 2020 6d69 6e5f 6964            min_id
-0000c940: 7820 3d20 6964 780a 2020 2020 2020 2020  x = idx.        
-0000c950: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
-0000c960: 6e75 6d62 6572 203d 206e 2e6e 756d 6265  number = n.numbe
-0000c970: 720a 0a20 2020 2020 2020 2020 2020 2072  r..            r
-0000c980: 6574 7572 6e20 6d69 6e5f 6964 780a 0a20  eturn min_idx.. 
-0000c990: 2020 2020 2020 2073 6f72 7465 645f 6273         sorted_bs
-0000c9a0: 796d 7320 3d20 746f 706f 736f 7274 5f62  yms = toposort_b
-0000c9b0: 7379 6d5f 6461 6728 6c65 6176 6573 2c20  sym_dag(leaves, 
-0000c9c0: 746f 706f 736f 7274 5f6f 7264 6572 3d54  toposort_order=T
-0000c9d0: 4f50 4f53 4f52 545f 4f52 4445 522e 424f  OPOSORT_ORDER.BO
-0000c9e0: 5454 4f4d 5f55 502c 2073 656c 6563 746f  TTOM_UP, selecto
-0000c9f0: 723d 5f73 656c 6563 746f 7229 0a20 2020  r=_selector).   
-0000ca00: 2020 2020 2067 7261 6474 7263 2e62 6f75       gradtrc.bou
-0000ca10: 6e64 5f73 796d 626f 6c73 203d 2073 6f72  nd_symbols = sor
-0000ca20: 7465 645f 6273 796d 730a 2020 2020 2020  ted_bsyms.      
-0000ca30: 2020 6772 6164 7472 6320 3d20 6463 6528    gradtrc = dce(
-0000ca40: 6772 6164 7472 6329 0a0a 2020 2020 2020  gradtrc)..      
-0000ca50: 2020 2320 544f 444f 2043 6f6e 7369 6465    # TODO Conside
-0000ca60: 7220 686f 7720 746f 2068 616e 646c 6520  r how to handle 
-0000ca70: 6772 6164 2077 2e72 2e74 2e20 6f6e 6c79  grad w.r.t. only
-0000ca80: 2073 6f6d 6520 6f75 7470 7574 7320 2d2d   some outputs --
-0000ca90: 2073 686f 756c 6420 616c 6c20 6772 6164   should all grad
-0000caa0: 0a20 2020 2020 2020 2023 2020 206f 7065  .        #   ope
-0000cab0: 7261 7469 6f6e 7320 7573 696e 6720 7468  rations using th
-0000cac0: 6520 6f74 6865 7220 6f75 7470 7574 2062  e other output b
-0000cad0: 6520 7265 6d6f 7665 643f 2057 6861 7420  e removed? What 
-0000cae0: 6b69 6e64 206f 6620 6173 7375 6d70 7469  kind of assumpti
-0000caf0: 6f6e 2064 6f65 7320 7468 6174 0a20 2020  on does that.   
-0000cb00: 2020 2020 2023 2020 206d 616b 6520 6162       #   make ab
-0000cb10: 6f75 7420 7468 6520 6772 6164 2073 7472  out the grad str
-0000cb20: 7563 7475 7265 3f20 5072 6f62 6162 6c79  ucture? Probably
-0000cb30: 2073 6f6d 6520 6b69 6e64 206f 6620 696e   some kind of in
-0000cb40: 6465 7065 6e64 656e 6365 2061 7373 756d  dependence assum
-0000cb50: 7074 696f 6e3f 2041 7265 0a20 2020 2020  ption? Are.     
-0000cb60: 2020 2023 2020 2074 6865 7265 2070 7261     #   there pra
-0000cb70: 6374 6963 616c 2065 7861 6d70 6c65 7320  ctical examples 
-0000cb80: 7768 6572 6520 7468 6174 2773 2061 6e20  where that's an 
-0000cb90: 6973 7375 653f 0a0a 2020 2020 2020 2020  issue?..        
-0000cba0: 656e 645f 7469 6d65 5f6e 7320 3d20 7469  end_time_ns = ti
-0000cbb0: 6d65 2e74 696d 655f 6e73 2829 0a20 2020  me.time_ns().   
-0000cbc0: 2020 2020 2065 6c61 7073 6564 5f74 696d       elapsed_tim
-0000cbd0: 655f 6e73 203d 2065 6e64 5f74 696d 655f  e_ns = end_time_
-0000cbe0: 6e73 202d 2073 7461 7274 5f74 696d 655f  ns - start_time_
-0000cbf0: 6e73 0a20 2020 2020 2020 2065 6c61 7073  ns.        elaps
-0000cc00: 6564 5f74 696d 655f 6d69 6c6c 6973 203d  ed_time_millis =
-0000cc10: 2065 6c61 7073 6564 5f74 696d 655f 6e73   elapsed_time_ns
-0000cc20: 202f 2f20 3130 3030 3030 300a 2020 2020   // 1000000.    
-0000cc30: 2020 2020 6772 6164 7472 632e 7365 745f      gradtrc.set_
-0000cc40: 7072 6f76 656e 616e 6365 2854 7261 6365  provenance(Trace
-0000cc50: 5072 6f76 656e 616e 6365 2866 2247 7261  Provenance(f"Gra
-0000cc60: 6420 2874 6f6f 6b20 7b65 6c61 7073 6564  d (took {elapsed
-0000cc70: 5f74 696d 655f 6d69 6c6c 6973 7d20 6d69  _time_millis} mi
-0000cc80: 6c6c 6973 6563 6f6e 6473 2922 2929 0a0a  lliseconds)"))..
-0000cc90: 2020 2020 2020 2020 7265 7475 726e 2067          return g
-0000cca0: 7261 6474 7263 0a0a 2020 2020 2320 4e4f  radtrc..    # NO
-0000ccb0: 5445 2054 6869 7320 6973 2061 206b 6c75  TE This is a klu
-0000ccc0: 6467 6520 746f 2069 6e64 6963 6174 6520  dge to indicate 
-0000ccd0: 7468 6174 2077 6520 7368 6f75 6c64 6e27  that we shouldn'
-0000cce0: 7420 7573 6520 5079 546f 7263 6827 7320  t use PyTorch's 
-0000ccf0: 6175 746f 6772 6164 2062 6563 6175 7365  autograd because
-0000cd00: 0a20 2020 2023 2020 2077 6527 7265 2075  .    #   we're u
-0000cd10: 7369 6e67 206f 7572 206f 776e 2061 7574  sing our own aut
-0000cd20: 6f67 7261 6420 7472 616e 7366 6f72 6d0a  ograd transform.
-0000cd30: 2020 2020 6366 6e2e 5f75 7369 6e67 5f67      cfn._using_g
-0000cd40: 7261 645f 7472 616e 7366 6f72 6d20 3d20  rad_transform = 
-0000cd50: 5472 7565 0a0a 2020 2020 7265 7475 726e  True..    return
-0000cd60: 2061 6464 5f74 7261 6e73 666f 726d 2863   add_transform(c
-0000cd70: 666e 2c20 5f67 7261 645f 7472 616e 7366  fn, _grad_transf
-0000cd80: 6f72 6d29 0a0a 0a64 6566 2067 7261 645f  orm)...def grad_
-0000cd90: 7631 280a 2020 2020 6366 6e2c 0a29 202d  v1(.    cfn,.) -
-0000cda0: 3e20 4361 6c6c 6162 6c65 3a0a 2020 2020  > Callable:.    
-0000cdb0: 6465 6620 6772 6164 2866 756e 6329 3a0a  def grad(func):.
-0000cdc0: 2020 2020 2020 2020 6465 6620 6772 6164          def grad
-0000cdd0: 5f66 756e 6328 2a61 7267 732c 202a 2a6b  _func(*args, **k
-0000cde0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-0000cdf0: 2020 2020 5f2c 2067 7261 6473 203d 2076      _, grads = v
-0000ce00: 616c 7565 5f61 6e64 5f67 7261 6428 6675  alue_and_grad(fu
-0000ce10: 6e63 2928 2a61 7267 732c 202a 2a6b 7761  nc)(*args, **kwa
-0000ce20: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
-0000ce30: 2067 7261 6473 203d 205b 6720 666f 7220   grads = [g for 
-0000ce40: 6720 696e 2067 7261 6473 2069 6620 6720  g in grads if g 
-0000ce50: 6973 206e 6f74 204e 6f6e 655d 0a20 2020  is not None].   
-0000ce60: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000ce70: 6772 6164 730a 0a20 2020 2020 2020 2072  grads..        r
-0000ce80: 6574 7572 6e20 6772 6164 5f66 756e 630a  eturn grad_func.
-0000ce90: 0a20 2020 2064 6566 205f 6772 6164 5f74  .    def _grad_t
-0000cea0: 7261 6e73 666f 726d 2874 7263 3a20 5472  ransform(trc: Tr
-0000ceb0: 6163 652c 202a 2c20 6578 6563 7574 6f72  ace, *, executor
-0000cec0: 735f 6c69 7374 3a20 5365 7175 656e 6365  s_list: Sequence
-0000ced0: 5b41 6e79 5d29 202d 3e20 5472 6163 653a  [Any]) -> Trace:
-0000cee0: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
-0000cef0: 203d 2063 6f6e 7374 7275 6374 5f74 7261   = construct_tra
-0000cf00: 6365 2829 2867 7261 6428 7472 632e 7079  ce()(grad(trc.py
-0000cf10: 7468 6f6e 5f63 616c 6c61 626c 6528 2929  thon_callable())
-0000cf20: 2c20 2a74 7263 2e61 7267 732c 202a 2a74  , *trc.args, **t
-0000cf30: 7263 2e6b 7761 7267 7329 0a20 2020 2020  rc.kwargs).     
-0000cf40: 2020 2072 6574 7572 6e20 6772 6164 7472     return gradtr
-0000cf50: 630a 0a20 2020 2063 666e 2e5f 7573 696e  c..    cfn._usin
-0000cf60: 675f 6772 6164 5f74 7261 6e73 666f 726d  g_grad_transform
-0000cf70: 203d 2054 7275 650a 2020 2020 7265 7475   = True.    retu
-0000cf80: 726e 2061 6464 5f74 7261 6e73 666f 726d  rn add_transform
-0000cf90: 2863 666e 2c20 5f67 7261 645f 7472 616e  (cfn, _grad_tran
-0000cfa0: 7366 6f72 6d29 0a0a 0a63 6c61 7373 2054  sform)...class T
-0000cfb0: 7261 6e73 666f 726d 7328 456e 756d 293a  ransforms(Enum):
-0000cfc0: 0a20 2020 2049 6465 6e74 6974 794f 7020  .    IdentityOp 
-0000cfd0: 3d20 6175 746f 2829 0a20 2020 2056 6d61  = auto().    Vma
-0000cfe0: 704f 7020 3d20 6175 746f 2829 0a20 2020  pOp = auto().   
-0000cff0: 204a 7670 4f70 203d 2061 7574 6f28 290a   JvpOp = auto().
-0000d000: 2020 2020 566a 704f 7020 3d20 6175 746f      VjpOp = auto
-0000d010: 2829 0a0a 0a40 6c72 755f 6361 6368 6528  ()...@lru_cache(
-0000d020: 6d61 7873 697a 653d 4e6f 6e65 290a 6465  maxsize=None).de
-0000d030: 6620 7379 6d62 6f6c 5f74 6f5f 6576 616c  f symbol_to_eval
-0000d040: 2862 6f75 6e64 5f73 796d 626f 6c29 3a0a  (bound_symbol):.
-0000d050: 2020 2020 2222 224d 6170 2061 2042 6f75      """Map a Bou
-0000d060: 6e64 5379 6d62 6f6c 2074 6f20 6120 6675  ndSymbol to a fu
-0000d070: 6e63 7469 6f6e 2074 6861 7420 6576 616c  nction that eval
-0000d080: 7561 7465 7320 6974 2e0a 0a20 2020 2041  uates it...    A
-0000d090: 7267 733a 0a20 2020 2020 2020 2062 6f75  rgs:.        bou
-0000d0a0: 6e64 5f73 796d 626f 6c3a 2042 6f75 6e64  nd_symbol: Bound
-0000d0b0: 5379 6d62 6f6c 2074 6f20 6d61 700a 2020  Symbol to map.  
-0000d0c0: 2020 2222 220a 2020 2020 2320 5379 6d62    """.    # Symb
-0000d0d0: 6f6c 2069 7320 6361 6c6c 6162 6c65 0a20  ol is callable. 
-0000d0e0: 2020 2072 6574 7572 6e20 626f 756e 645f     return bound_
-0000d0f0: 7379 6d62 6f6c 2e73 796d 0a0a 0a23 2054  symbol.sym...# T
-0000d100: 4f44 4f3a 2043 7572 7265 6e74 6c79 2077  ODO: Currently w
-0000d110: 6520 7573 6520 7472 6163 652e 6172 6773  e use trace.args
-0000d120: 2061 6e64 2074 7261 6365 2e6b 7761 7267   and trace.kwarg
-0000d130: 7320 746f 2067 6574 2074 6865 2061 7267  s to get the arg
-0000d140: 756d 656e 7473 0a23 204d 6179 6265 2077  uments.# Maybe w
-0000d150: 6520 7368 6f75 6c64 2075 7365 2074 6865  e should use the
-0000d160: 7365 2069 6e73 7465 6164 0a74 7261 6e73  se instead.trans
-0000d170: 666f 726d 5f73 6b69 705f 6c69 7374 203d  form_skip_list =
-0000d180: 2028 0a20 2020 2070 7269 6d73 2e50 7269   (.    prims.Pri
-0000d190: 6d49 4473 2e55 4e50 4143 4b5f 454d 5054  mIDs.UNPACK_EMPT
-0000d1a0: 595f 4449 4354 2c0a 2020 2020 7072 696d  Y_DICT,.    prim
-0000d1b0: 732e 5072 696d 4944 732e 554e 5041 434b  s.PrimIDs.UNPACK
-0000d1c0: 5f4b 4559 2c0a 2020 2020 7072 696d 732e  _KEY,.    prims.
-0000d1d0: 5072 696d 4944 732e 554e 5041 434b 5f53  PrimIDs.UNPACK_S
-0000d1e0: 4551 5545 4e43 452c 0a20 2020 2070 7269  EQUENCE,.    pri
-0000d1f0: 6d73 2e50 7269 6d49 4473 2e55 4e50 4143  ms.PrimIDs.UNPAC
-0000d200: 4b5f 5452 4956 4941 4c2c 0a20 2020 2070  K_TRIVIAL,.    p
-0000d210: 7269 6d73 2e50 7269 6d49 4473 2e52 4554  rims.PrimIDs.RET
-0000d220: 5552 4e2c 0a29 0a0a 0a64 6566 2065 7661  URN,.)...def eva
-0000d230: 6c5f 7472 6163 6528 7472 6163 652c 202a  l_trace(trace, *
-0000d240: 6172 6773 2c20 7379 6d62 6f6c 5f6d 6170  args, symbol_map
-0000d250: 7065 723d 7379 6d62 6f6c 5f74 6f5f 6576  per=symbol_to_ev
-0000d260: 616c 2c20 7769 7468 5f65 6e76 3d46 616c  al, with_env=Fal
-0000d270: 7365 2c20 2a2a 6b77 6172 6773 293a 0a20  se, **kwargs):. 
-0000d280: 2020 2022 2222 4576 616c 7561 7465 2061     """Evaluate a
-0000d290: 2074 7261 6365 2e0a 0a20 2020 2041 7267   trace...    Arg
-0000d2a0: 733a 0a20 2020 2020 2020 2074 7261 6365  s:.        trace
-0000d2b0: 3a20 7472 6163 6520 746f 2065 7661 6c75  : trace to evalu
-0000d2c0: 6174 650a 2020 2020 2020 2020 2a61 7267  ate.        *arg
-0000d2d0: 733a 2061 7267 756d 656e 7473 2074 6f20  s: arguments to 
-0000d2e0: 6576 616c 7561 7465 2074 6865 2074 7261  evaluate the tra
-0000d2f0: 6365 2077 6974 680a 2020 2020 2020 2020  ce with.        
-0000d300: 7379 6d62 6f6c 5f6d 6170 7065 723a 2066  symbol_mapper: f
-0000d310: 756e 6374 696f 6e20 7468 6174 206d 6170  unction that map
-0000d320: 7320 6120 7379 6d62 6f6c 2074 6f20 6120  s a symbol to a 
-0000d330: 6675 6e63 7469 6f6e 2074 6861 7420 6576  function that ev
-0000d340: 616c 7561 7465 7320 6974 0a20 2020 2020  aluates it.     
-0000d350: 2020 202a 2a6b 7761 7267 733a 206b 6579     **kwargs: key
-0000d360: 776f 7264 2061 7267 756d 656e 7473 2074  word arguments t
-0000d370: 6f20 6576 616c 7561 7465 2074 6865 2074  o evaluate the t
-0000d380: 7261 6365 2077 6974 680a 0a20 2020 2052  race with..    R
-0000d390: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-0000d3a0: 7265 7375 6c74 206f 6620 6576 616c 7561  result of evalua
-0000d3b0: 7469 6e67 2074 6865 2074 7261 6365 0a20  ting the trace. 
-0000d3c0: 2020 2022 2222 0a20 2020 2065 6e76 203d     """.    env =
-0000d3d0: 207b 7d0a 0a20 2020 2064 6566 2072 6561   {}..    def rea
-0000d3e0: 6428 783a 2056 6172 6961 626c 6529 3a0a  d(x: Variable):.
-0000d3f0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0000d400: 7461 6e63 6528 782c 2056 6172 6961 626c  tance(x, Variabl
-0000d410: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0000d420: 7265 7475 726e 2065 6e76 5b78 2e6e 616d  return env[x.nam
-0000d430: 655d 0a20 2020 2020 2020 2065 6c73 653a  e].        else:
-0000d440: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000d450: 7572 6e20 780a 0a20 2020 2064 6566 2077  urn x..    def w
-0000d460: 7269 7465 2876 3a20 5661 7269 6162 6c65  rite(v: Variable
-0000d470: 2c20 7661 6c3a 2041 6e79 2c20 616c 6c6f  , val: Any, allo
-0000d480: 775f 6475 706c 6963 6174 6573 3d46 616c  w_duplicates=Fal
-0000d490: 7365 2920 2d3e 204e 6f6e 653a 0a20 2020  se) -> None:.   
-0000d4a0: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
-0000d4b0: 7374 616e 6365 2876 2c20 5661 7269 6162  stance(v, Variab
-0000d4c0: 6c65 293a 0a20 2020 2020 2020 2020 2020  le):.           
-0000d4d0: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-0000d4e0: 2320 4475 706c 6963 6174 6573 2061 7265  # Duplicates are
-0000d4f0: 2061 6c6c 6f77 6564 2061 6e64 206f 7665   allowed and ove
-0000d500: 7277 7269 7474 656e 0a20 2020 2020 2020  rwritten.       
-0000d510: 2069 6620 762e 6e61 6d65 2069 6e20 656e   if v.name in en
-0000d520: 763a 0a20 2020 2020 2020 2020 2020 2069  v:.            i
-0000d530: 6620 616c 6c6f 775f 6475 706c 6963 6174  f allow_duplicat
-0000d540: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0000d550: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
-0000d560: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-0000d570: 7565 4572 726f 7228 6622 5661 7269 6162  ueError(f"Variab
-0000d580: 6c65 207b 762e 6e61 6d65 7d20 6973 2062  le {v.name} is b
-0000d590: 6569 6e67 206f 7665 7277 7269 7474 656e  eing overwritten
-0000d5a0: 2074 6869 7320 6973 206e 6f74 2061 6c6c   this is not all
-0000d5b0: 6f77 6564 2229 0a20 2020 2020 2020 2065  owed").        e
-0000d5c0: 6e76 5b76 2e6e 616d 655d 203d 2076 616c  nv[v.name] = val
-0000d5d0: 0a0a 2020 2020 7361 6665 5f6d 6170 5f66  ..    safe_map_f
-0000d5e0: 6c61 7428 7772 6974 652c 206c 6973 7428  lat(write, list(
-0000d5f0: 7472 6163 652e 6172 6773 292c 206c 6973  trace.args), lis
-0000d600: 7428 6172 6773 2929 0a20 2020 2073 6166  t(args)).    saf
-0000d610: 655f 6d61 705f 666c 6174 2877 7269 7465  e_map_flat(write
-0000d620: 2c20 6c69 7374 2874 7261 6365 2e6b 7761  , list(trace.kwa
-0000d630: 7267 732e 7661 6c75 6573 2829 292c 206c  rgs.values()), l
-0000d640: 6973 7428 6b77 6172 6773 2e76 616c 7565  ist(kwargs.value
-0000d650: 7328 2929 290a 0a20 2020 2066 6f72 2073  s()))..    for s
-0000d660: 796d 626f 6c20 696e 2074 7261 6365 2e62  ymbol in trace.b
-0000d670: 6f75 6e64 5f73 796d 626f 6c73 3a0a 2020  ound_symbols:.  
-0000d680: 2020 2020 2020 6966 2073 796d 626f 6c2e        if symbol.
-0000d690: 7379 6d2e 6964 2069 6e20 7472 616e 7366  sym.id in transf
-0000d6a0: 6f72 6d5f 736b 6970 5f6c 6973 743a 0a20  orm_skip_list:. 
-0000d6b0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0000d6c0: 6e75 650a 2020 2020 2020 2020 6172 6773  nue.        args
-0000d6d0: 203d 2074 7265 655f 6d61 7028 7265 6164   = tree_map(read
-0000d6e0: 2c20 7379 6d62 6f6c 2e61 7267 7329 0a20  , symbol.args). 
-0000d6f0: 2020 2020 2020 206b 7761 7267 7320 3d20         kwargs = 
-0000d700: 7472 6565 5f6d 6170 2872 6561 642c 2073  tree_map(read, s
-0000d710: 796d 626f 6c2e 6b77 6172 6773 290a 2020  ymbol.kwargs).  
-0000d720: 2020 2020 2020 7072 696d 5f66 756e 6320        prim_func 
-0000d730: 3d20 7379 6d62 6f6c 5f6d 6170 7065 7228  = symbol_mapper(
-0000d740: 7379 6d62 6f6c 290a 2020 2020 2020 2020  symbol).        
-0000d750: 6966 2070 7269 6d5f 6675 6e63 2069 7320  if prim_func is 
-0000d760: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000d770: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-0000d780: 2020 2072 6573 756c 7420 3d20 7072 696d     result = prim
-0000d790: 5f66 756e 6328 2a61 7267 732c 202a 2a6b  _func(*args, **k
-0000d7a0: 7761 7267 7329 0a20 2020 2020 2020 2073  wargs).        s
-0000d7b0: 6166 655f 6d61 705f 666c 6174 2877 7269  afe_map_flat(wri
-0000d7c0: 7465 2c20 6c69 7374 2873 6571 7565 6e63  te, list(sequenc
-0000d7d0: 6966 7928 7379 6d62 6f6c 2e6f 7574 7075  ify(symbol.outpu
-0000d7e0: 7429 292c 206c 6973 7428 7365 7175 656e  t)), list(sequen
-0000d7f0: 6369 6679 2872 6573 756c 7429 2929 0a0a  cify(result)))..
-0000d800: 2020 2020 6966 2077 6974 685f 656e 763a      if with_env:
-0000d810: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000d820: 7472 6565 5f6d 6170 2872 6561 642c 2074  tree_map(read, t
-0000d830: 7261 6365 2e6f 7574 7075 7429 2c20 656e  race.output), en
-0000d840: 760a 0a20 2020 2072 6574 7572 6e20 7472  v..    return tr
-0000d850: 6565 5f6d 6170 2872 6561 642c 2074 7261  ee_map(read, tra
-0000d860: 6365 2e6f 7574 7075 7429 0a0a 0a64 6566  ce.output)...def
-0000d870: 205f 6964 656e 7469 7479 5f63 616c 6c5f   _identity_call_
-0000d880: 6d65 7461 6675 6e63 282a 6172 6773 2c20  metafunc(*args, 
-0000d890: 7472 6163 653a 2054 7261 6365 2c20 2a2a  trace: Trace, **
-0000d8a0: 6b77 6172 6773 293a 0a20 2020 2077 6974  kwargs):.    wit
-0000d8b0: 6820 6465 7461 6368 6564 5f74 7261 6365  h detached_trace
-0000d8c0: 2829 3a0a 2020 2020 2020 2020 7265 7475  ():.        retu
-0000d8d0: 726e 2065 7661 6c5f 7472 6163 6528 7472  rn eval_trace(tr
-0000d8e0: 6163 652c 202a 6172 6773 2c20 2a2a 6b77  ace, *args, **kw
-0000d8f0: 6172 6773 290a 0a0a 6964 656e 7469 7479  args)...identity
-0000d900: 5f63 616c 6c20 3d20 5379 6d62 6f6c 2869  _call = Symbol(i
-0000d910: 643d 5472 616e 7366 6f72 6d73 2e49 6465  d=Transforms.Ide
-0000d920: 6e74 6974 794f 702c 206e 616d 653d 2269  ntityOp, name="i
-0000d930: 6465 6e74 6974 795f 6361 6c6c 222c 206d  dentity_call", m
-0000d940: 6574 613d 5f69 6465 6e74 6974 795f 6361  eta=_identity_ca
-0000d950: 6c6c 5f6d 6574 6166 756e 6329 0a0a 0a64  ll_metafunc)...d
-0000d960: 6566 2069 6465 6e74 6974 7928 6675 6e63  ef identity(func
-0000d970: 293a 0a20 2020 2022 2222 4964 656e 7469  ):.    """Identi
-0000d980: 7479 2074 7261 6e73 666f 726d 2066 6f72  ty transform for
-0000d990: 2061 2054 6875 6e64 6572 2066 756e 6374   a Thunder funct
-0000d9a0: 696f 6e2e 0a0a 2020 2020 4172 6773 3a0a  ion...    Args:.
-0000d9b0: 2020 2020 2020 2020 6675 6e63 2028 4361          func (Ca
-0000d9c0: 6c6c 6162 6c65 293a 2041 2054 6875 6e64  llable): A Thund
-0000d9d0: 6572 2066 756e 6374 696f 6e20 746f 2062  er function to b
-0000d9e0: 6520 7472 616e 7366 6f72 6d65 642e 0a20  e transformed.. 
-0000d9f0: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
-0000da00: 7772 6170 7065 7228 2a61 7267 732c 202a  wrapper(*args, *
-0000da10: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-0000da20: 2020 7472 6163 6520 3d20 636f 6e73 7472    trace = constr
-0000da30: 7563 745f 7472 6163 6528 2928 6675 6e63  uct_trace()(func
-0000da40: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
-0000da50: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
-0000da60: 6e20 6964 656e 7469 7479 5f63 616c 6c28  n identity_call(
-0000da70: 2a61 7267 732c 202a 2a6b 7761 7267 732c  *args, **kwargs,
-0000da80: 2074 7261 6365 3d74 7261 6365 290a 0a20   trace=trace).. 
-0000da90: 2020 2072 6574 7572 6e20 7772 6170 7065     return wrappe
-0000daa0: 720a 0a0a 6465 6620 5f69 6465 6e74 6974  r...def _identit
-0000dab0: 795f 6361 6c6c 5f70 7974 6f72 6368 282a  y_call_pytorch(*
-0000dac0: 6172 6773 2c20 7472 6163 653a 2054 7261  args, trace: Tra
-0000dad0: 6365 2c20 2a2a 6b77 6172 6773 293a 0a20  ce, **kwargs):. 
-0000dae0: 2020 2069 6d70 6f72 7420 746f 7263 680a     import torch.
-0000daf0: 0a20 2020 2064 6566 2073 796d 626f 6c5f  .    def symbol_
-0000db00: 6d61 7070 6572 286f 7029 3a0a 2020 2020  mapper(op):.    
-0000db10: 2020 2020 6966 206f 702e 6f70 203d 3d20      if op.op == 
-0000db20: 5472 616e 7366 6f72 6d73 2e49 6465 6e74  Transforms.Ident
-0000db30: 6974 794f 703a 0a20 2020 2020 2020 2020  ityOp:.         
-0000db40: 2020 2072 6574 7572 6e20 5f69 6465 6e74     return _ident
-0000db50: 6974 795f 6361 6c6c 5f70 7974 6f72 6368  ity_call_pytorch
-0000db60: 0a0a 2020 2020 2020 2020 746f 7263 685f  ..        torch_
-0000db70: 6f70 203d 206f 7073 5f74 6f5f 746f 7263  op = ops_to_torc
-0000db80: 685f 6f70 735f 6d61 705b 6f70 2e6f 705d  h_ops_map[op.op]
-0000db90: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-0000dba0: 7374 616e 6365 2874 6f72 6368 5f6f 702c  stance(torch_op,
-0000dbb0: 2073 7472 293a 0a20 2020 2020 2020 2020   str):.         
-0000dbc0: 2020 2072 6574 7572 6e20 6765 7461 7474     return getatt
-0000dbd0: 7228 746f 7263 682c 2074 6f72 6368 5f6f  r(torch, torch_o
-0000dbe0: 702e 7374 7269 7028 2270 7974 6f72 6368  p.strip("pytorch
-0000dbf0: 2e22 2929 0a20 2020 2020 2020 2072 6574  .")).        ret
-0000dc00: 7572 6e20 746f 7263 685f 6f70 0a0a 2020  urn torch_op..  
-0000dc10: 2020 7769 7468 2064 6574 6163 6865 645f    with detached_
-0000dc20: 7472 6163 6528 293a 0a20 2020 2020 2020  trace():.       
-0000dc30: 2072 6574 7572 6e20 6576 616c 5f74 7261   return eval_tra
-0000dc40: 6365 2874 7261 6365 2c20 2a61 7267 732c  ce(trace, *args,
-0000dc50: 202a 2a6b 7761 7267 732c 2073 796d 626f   **kwargs, symbo
-0000dc60: 6c5f 6d61 7070 6572 3d73 796d 626f 6c5f  l_mapper=symbol_
-0000dc70: 6d61 7070 6572 290a 0a0a 2320 5265 6769  mapper)...# Regi
-0000dc80: 7374 6572 2074 6865 2069 6465 6e74 6974  ster the identit
-0000dc90: 7920 6361 6c6c 2066 6f72 2050 7954 6f72  y call for PyTor
-0000dca0: 6368 2065 7865 6375 746f 722e 0a23 206f  ch executor..# o
-0000dcb0: 7073 5f74 6f5f 746f 7263 685f 6f70 735f  ps_to_torch_ops_
-0000dcc0: 6d61 705b 5472 616e 7366 6f72 6d73 2e49  map[Transforms.I
-0000dcd0: 6465 6e74 6974 794f 705d 203d 205f 6964  dentityOp] = _id
-0000dce0: 656e 7469 7479 5f63 616c 6c5f 7079 746f  entity_call_pyto
-0000dcf0: 7263 680a 0a0a 2320 564d 4150 2074 7261  rch...# VMAP tra
-0000dd00: 6e73 666f 726d 0a23 202d 2d2d 2d2d 2d2d  nsform.# -------
-0000dd10: 2d2d 2d2d 2d2d 0a0a 0a63 6c61 7373 204e  ------...class N
-0000dd20: 6f74 4d61 7070 6564 3a0a 2020 2020 2222  otMapped:.    ""
-0000dd30: 2252 6570 7265 7365 6e74 7320 6120 6e6f  "Represents a no
-0000dd40: 6e2d 6261 7463 6865 6420 6469 6d65 6e73  n-batched dimens
-0000dd50: 696f 6e2e 2222 220a 0a20 2020 2064 6566  ion."""..    def
-0000dd60: 205f 5f72 6570 725f 5f28 7365 6c66 293a   __repr__(self):
-0000dd70: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000dd80: 226e 6f74 5f6d 6170 7065 6422 0a0a 0a40  "not_mapped"...@
-0000dd90: 6461 7461 636c 6173 7328 6672 6f7a 656e  dataclass(frozen
-0000dda0: 3d54 7275 6529 0a63 6c61 7373 2042 6174  =True).class Bat
-0000ddb0: 6368 6564 5661 6c75 653a 0a20 2020 2022  chedValue:.    "
-0000ddc0: 2222 4261 7463 6865 6420 7661 6c75 6520  ""Batched value 
-0000ddd0: 666f 7220 7468 6520 766d 6170 2074 7261  for the vmap tra
-0000dde0: 6e73 666f 726d 2e0a 0a20 2020 2041 7474  nsform...    Att
-0000ddf0: 7269 6275 7465 733a 0a20 2020 2020 2020  ributes:.       
-0000de00: 2076 616c 7565 3a20 4261 7463 6865 6420   value: Batched 
-0000de10: 7661 6c75 652e 0a20 2020 2020 2020 2062  value..        b
-0000de20: 6174 6368 5f64 696d 3a20 4261 7463 6869  atch_dim: Batchi
-0000de30: 6e67 2064 696d 656e 7369 6f6e 206f 7220  ng dimension or 
-0000de40: 6e6f 745f 6d61 7070 6564 0a20 2020 2022  not_mapped.    "
-0000de50: 2222 0a0a 2020 2020 7661 6c75 653a 2041  ""..    value: A
-0000de60: 6e79 0a20 2020 2062 6174 6368 5f64 696d  ny.    batch_dim
-0000de70: 3a20 696e 7420 7c20 4e6f 744d 6170 7065  : int | NotMappe
-0000de80: 640a 0a20 2020 2064 6566 205f 5f69 7465  d..    def __ite
-0000de90: 725f 5f28 7365 6c66 293a 0a20 2020 2020  r__(self):.     
-0000dea0: 2020 2079 6965 6c64 2073 656c 662e 7661     yield self.va
-0000deb0: 6c75 650a 2020 2020 2020 2020 7969 656c  lue.        yiel
-0000dec0: 6420 7365 6c66 2e62 6174 6368 5f64 696d  d self.batch_dim
-0000ded0: 0a0a 0a64 6566 2070 6169 725f 746f 5f62  ...def pair_to_b
-0000dee0: 6174 6368 6564 5f76 616c 7565 2870 6169  atched_value(pai
-0000def0: 7229 3a0a 2020 2020 2222 2243 6f6e 7665  r):.    """Conve
-0000df00: 7274 7320 6120 7061 6972 2074 6f20 6120  rts a pair to a 
-0000df10: 4261 7463 6865 6456 616c 7565 2e0a 0a20  BatchedValue... 
-0000df20: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0000df30: 2070 6169 7220 2853 6571 7565 6e63 6529   pair (Sequence)
-0000df40: 3a20 5061 6972 2074 6f20 636f 6e76 6572  : Pair to conver
-0000df50: 742e 0a0a 2020 2020 5265 7475 726e 733a  t...    Returns:
-0000df60: 0a20 2020 2020 2020 2042 6174 6368 6564  .        Batched
-0000df70: 5661 6c75 653a 2042 6174 6368 6564 5661  Value: BatchedVa
-0000df80: 6c75 6520 7265 7072 6573 656e 7461 7469  lue representati
-0000df90: 6f6e 206f 6620 7468 6520 7061 6972 2e0a  on of the pair..
-0000dfa0: 2020 2020 2222 220a 2020 2020 6966 2069      """.    if i
-0000dfb0: 7369 6e73 7461 6e63 6528 7061 6972 2c20  sinstance(pair, 
-0000dfc0: 4261 7463 6865 6456 616c 7565 293a 0a20  BatchedValue):. 
-0000dfd0: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
-0000dfe0: 6972 0a20 2020 2065 6c73 653a 0a20 2020  ir.    else:.   
-0000dff0: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-0000e000: 7374 616e 6365 2870 6169 722c 2053 6571  stance(pair, Seq
-0000e010: 7565 6e63 6529 2061 6e64 206c 656e 2870  uence) and len(p
-0000e020: 6169 7229 203d 3d20 320a 2020 2020 2020  air) == 2.      
-0000e030: 2020 7265 7475 726e 2042 6174 6368 6564    return Batched
-0000e040: 5661 6c75 6528 2a70 6169 7229 0a0a 0a64  Value(*pair)...d
-0000e050: 6566 2076 6563 746f 7269 7a65 645f 6261  ef vectorized_ba
-0000e060: 7463 6865 7228 7072 696d 2c20 6178 6973  tcher(prim, axis
-0000e070: 5f73 697a 652c 2062 6174 6368 6564 5f76  _size, batched_v
-0000e080: 616c 7565 732c 202a 2a6b 7761 7267 7329  alues, **kwargs)
-0000e090: 3a0a 2020 2020 6261 7463 685f 6469 6d20  :.    batch_dim 
-0000e0a0: 3d20 6261 7463 6865 645f 7661 6c75 6573  = batched_values
-0000e0b0: 5b30 5d2e 6261 7463 685f 6469 6d0a 2020  [0].batch_dim.  
-0000e0c0: 2020 6173 7365 7274 2061 6c6c 280a 2020    assert all(.  
-0000e0d0: 2020 2020 2020 6261 7463 685f 6469 6d20        batch_dim 
-0000e0e0: 3d3d 2062 762e 6261 7463 685f 6469 6d20  == bv.batch_dim 
-0000e0f0: 666f 7220 6276 2069 6e20 6261 7463 6865  for bv in batche
-0000e100: 645f 7661 6c75 6573 5b31 3a5d 0a20 2020  d_values[1:].   
-0000e110: 2029 2c20 6622 6076 6563 746f 7269 7a65   ), f"`vectorize
-0000e120: 645f 6261 7463 6865 7260 2067 6f74 2064  d_batcher` got d
-0000e130: 6966 6665 7265 6e74 2062 6174 6368 6564  ifferent batched
-0000e140: 2064 696d 656e 7369 6f6e 7320 7b5b 6276   dimensions {[bv
-0000e150: 2e62 6174 6368 5f64 696d 2066 6f72 2062  .batch_dim for b
-0000e160: 7620 696e 2062 6174 6368 6564 5f76 616c  v in batched_val
-0000e170: 7565 735d 7d22 0a20 2020 2072 6574 7572  ues]}".    retur
-0000e180: 6e20 4261 7463 6865 6456 616c 7565 2870  n BatchedValue(p
-0000e190: 7269 6d28 2a5b 6276 2e76 616c 7565 2066  rim(*[bv.value f
-0000e1a0: 6f72 2062 7620 696e 2062 6174 6368 6564  or bv in batched
-0000e1b0: 5f76 616c 7565 735d 2c20 2a2a 6b77 6172  _values], **kwar
-0000e1c0: 6773 292c 2062 6174 6368 5f64 696d 290a  gs), batch_dim).
-0000e1d0: 0a0a 6e6f 745f 6d61 7070 6564 203d 204e  ..not_mapped = N
-0000e1e0: 6f74 4d61 7070 6564 2829 0a0a 0a64 6566  otMapped()...def
-0000e1f0: 206d 6f76 6564 696d 2878 2c20 7372 633a   movedim(x, src:
-0000e200: 2069 6e74 2c20 6473 743a 2069 6e74 293a   int, dst: int):
-0000e210: 0a20 2020 2070 6572 6d20 3d20 5b69 2066  .    perm = [i f
-0000e220: 6f72 2069 2069 6e20 7261 6e67 6528 782e  or i in range(x.
-0000e230: 6e64 696d 2920 6966 2069 2021 3d20 7372  ndim) if i != sr
-0000e240: 635d 0a20 2020 2070 6572 6d2e 696e 7365  c].    perm.inse
-0000e250: 7274 2864 7374 2c20 7372 6329 0a20 2020  rt(dst, src).   
-0000e260: 2072 6574 7572 6e20 7072 696d 732e 7472   return prims.tr
-0000e270: 616e 7370 6f73 6528 782c 2074 7570 6c65  anspose(x, tuple
-0000e280: 2870 6572 6d29 290a 0a0a 6465 6620 6d6f  (perm))...def mo
-0000e290: 7665 5f62 6174 6368 5f64 696d 2861 7869  ve_batch_dim(axi
-0000e2a0: 735f 7369 7a65 2c20 7372 632c 2064 7374  s_size, src, dst
-0000e2b0: 2c20 7829 3a0a 2020 2020 6966 2073 7263  , x):.    if src
-0000e2c0: 2069 7320 6e6f 745f 6d61 7070 6564 3a0a   is not_mapped:.
-0000e2d0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0000e2e0: 7461 6e63 6528 782c 204e 756d 6265 7229  tance(x, Number)
-0000e2f0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000e300: 7475 726e 2078 0a20 2020 2020 2020 2074  turn x.        t
-0000e310: 6172 6765 745f 7368 6170 6520 3d20 6c69  arget_shape = li
-0000e320: 7374 2878 2e73 6861 7065 290a 2020 2020  st(x.shape).    
-0000e330: 2020 2020 7461 7267 6574 5f73 6861 7065      target_shape
-0000e340: 2e69 6e73 6572 7428 6473 742c 2061 7869  .insert(dst, axi
-0000e350: 735f 7369 7a65 290a 2020 2020 2020 2020  s_size).        
-0000e360: 6263 6173 745f 6469 6d73 203d 206c 6973  bcast_dims = lis
-0000e370: 7428 7261 6e67 6528 6c65 6e28 7461 7267  t(range(len(targ
-0000e380: 6574 5f73 6861 7065 2929 290a 2020 2020  et_shape))).    
-0000e390: 2020 2020 6263 6173 745f 6469 6d73 2e70      bcast_dims.p
-0000e3a0: 6f70 2864 7374 290a 2020 2020 2020 2020  op(dst).        
-0000e3b0: 7265 7475 726e 2070 7269 6d73 2e62 726f  return prims.bro
-0000e3c0: 6164 6361 7374 5f69 6e5f 6469 6d28 782c  adcast_in_dim(x,
-0000e3d0: 2074 6172 6765 745f 7368 6170 652c 2062   target_shape, b
-0000e3e0: 6361 7374 5f64 696d 7329 0a20 2020 2065  cast_dims).    e
-0000e3f0: 6c69 6620 7372 6320 3d3d 2064 7374 3a0a  lif src == dst:.
-0000e400: 2020 2020 2020 2020 7265 7475 726e 2078          return x
-0000e410: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0000e420: 2020 2072 6574 7572 6e20 6d6f 7665 6469     return movedi
-0000e430: 6d28 782c 2073 7263 2c20 6473 7429 0a0a  m(x, src, dst)..
-0000e440: 0a64 6566 2062 696e 6172 795f 6f70 5f62  .def binary_op_b
-0000e450: 6174 6368 696e 675f 7275 6c65 286f 703a  atching_rule(op:
-0000e460: 2070 7269 6d73 2e50 7269 6d49 4473 2c20   prims.PrimIDs, 
-0000e470: 6178 6973 5f73 697a 653a 2069 6e74 2c20  axis_size: int, 
-0000e480: 7661 6c73 5f69 6e3a 2042 6174 6368 6564  vals_in: Batched
-0000e490: 5661 6c75 6529 3a0a 2020 2020 2828 782c  Value):.    ((x,
-0000e4a0: 2078 5f62 6469 6d29 2c20 2879 2c20 795f   x_bdim), (y, y_
-0000e4b0: 6264 696d 2929 203d 2076 616c 735f 696e  bdim)) = vals_in
-0000e4c0: 0a20 2020 2069 6620 785f 6264 696d 2021  .    if x_bdim !
-0000e4d0: 3d20 795f 6264 696d 3a0a 2020 2020 2020  = y_bdim:.      
-0000e4e0: 2020 6966 2078 5f62 6469 6d20 6973 206e    if x_bdim is n
-0000e4f0: 6f74 5f6d 6170 7065 643a 0a20 2020 2020  ot_mapped:.     
-0000e500: 2020 2020 2020 2078 203d 206d 6f76 655f         x = move_
-0000e510: 6261 7463 685f 6469 6d28 6178 6973 5f73  batch_dim(axis_s
-0000e520: 697a 652c 2078 5f62 6469 6d2c 2079 5f62  ize, x_bdim, y_b
-0000e530: 6469 6d2c 2078 290a 2020 2020 2020 2020  dim, x).        
-0000e540: 2020 2020 785f 6264 696d 203d 2079 5f62      x_bdim = y_b
-0000e550: 6469 6d0a 2020 2020 2020 2020 656c 7365  dim.        else
-0000e560: 3a0a 2020 2020 2020 2020 2020 2020 7920  :.            y 
-0000e570: 3d20 6d6f 7665 5f62 6174 6368 5f64 696d  = move_batch_dim
-0000e580: 2861 7869 735f 7369 7a65 2c20 795f 6264  (axis_size, y_bd
-0000e590: 696d 2c20 785f 6264 696d 2c20 7929 0a20  im, x_bdim, y). 
-0000e5a0: 2020 2072 6574 7572 6e20 4261 7463 6865     return Batche
-0000e5b0: 6456 616c 7565 286f 7028 782c 2079 292c  dValue(op(x, y),
-0000e5c0: 2078 5f62 6469 6d29 0a0a 0a64 6566 2073   x_bdim)...def s
-0000e5d0: 696e 5f76 6d61 7028 6178 6973 5f73 697a  in_vmap(axis_siz
-0000e5e0: 653a 2069 6e74 2c20 613a 2042 6174 6368  e: int, a: Batch
-0000e5f0: 6564 5661 6c75 6529 202d 3e20 4261 7463  edValue) -> Batc
-0000e600: 6865 6456 616c 7565 3a0a 2020 2020 7265  hedValue:.    re
-0000e610: 7475 726e 2076 6563 746f 7269 7a65 645f  turn vectorized_
-0000e620: 6261 7463 6865 7228 7072 696d 732e 7369  batcher(prims.si
-0000e630: 6e2c 2061 7869 735f 7369 7a65 2c20 2861  n, axis_size, (a
-0000e640: 2c29 290a 0a0a 6465 6620 636f 735f 766d  ,))...def cos_vm
-0000e650: 6170 2861 7869 735f 7369 7a65 3a20 696e  ap(axis_size: in
-0000e660: 742c 2061 3a20 4261 7463 6865 6456 616c  t, a: BatchedVal
-0000e670: 7565 2920 2d3e 2042 6174 6368 6564 5661  ue) -> BatchedVa
-0000e680: 6c75 653a 0a20 2020 2072 6574 7572 6e20  lue:.    return 
-0000e690: 7665 6374 6f72 697a 6564 5f62 6174 6368  vectorized_batch
-0000e6a0: 6572 2870 7269 6d73 2e63 6f73 2c20 6178  er(prims.cos, ax
-0000e6b0: 6973 5f73 697a 652c 2028 612c 2929 0a0a  is_size, (a,))..
-0000e6c0: 0a64 6566 206d 756c 5f76 6d61 7028 6178  .def mul_vmap(ax
-0000e6d0: 6973 5f73 697a 653a 2069 6e74 2c20 613a  is_size: int, a:
-0000e6e0: 2042 6174 6368 6564 5661 6c75 652c 2062   BatchedValue, b
-0000e6f0: 3a20 4261 7463 6865 6456 616c 7565 2920  : BatchedValue) 
-0000e700: 2d3e 2042 6174 6368 6564 5661 6c75 653a  -> BatchedValue:
-0000e710: 0a20 2020 2072 6574 7572 6e20 6269 6e61  .    return bina
-0000e720: 7279 5f6f 705f 6261 7463 6869 6e67 5f72  ry_op_batching_r
-0000e730: 756c 6528 7072 696d 732e 6d75 6c2c 2061  ule(prims.mul, a
-0000e740: 7869 735f 7369 7a65 2c20 2861 2c20 6229  xis_size, (a, b)
-0000e750: 290a 0a0a 6465 6620 6164 645f 766d 6170  )...def add_vmap
-0000e760: 2861 7869 735f 7369 7a65 3a20 696e 742c  (axis_size: int,
-0000e770: 2061 3a20 4261 7463 6865 6456 616c 7565   a: BatchedValue
-0000e780: 2c20 623a 2042 6174 6368 6564 5661 6c75  , b: BatchedValu
-0000e790: 6529 202d 3e20 4261 7463 6865 6456 616c  e) -> BatchedVal
-0000e7a0: 7565 3a0a 2020 2020 7265 7475 726e 2062  ue:.    return b
-0000e7b0: 696e 6172 795f 6f70 5f62 6174 6368 696e  inary_op_batchin
-0000e7c0: 675f 7275 6c65 2870 7269 6d73 2e61 6464  g_rule(prims.add
-0000e7d0: 2c20 6178 6973 5f73 697a 652c 2028 612c  , axis_size, (a,
-0000e7e0: 2062 2929 0a0a 0a64 6566 2073 756d 5f76   b))...def sum_v
-0000e7f0: 6d61 7028 6178 6973 5f73 697a 653a 2069  map(axis_size: i
-0000e800: 6e74 2c20 613a 2042 6174 6368 6564 5661  nt, a: BatchedVa
-0000e810: 6c75 652c 2064 696d 733a 2053 6571 7565  lue, dims: Seque
-0000e820: 6e63 655b 696e 745d 2c20 2a2a 6b77 6172  nce[int], **kwar
-0000e830: 6773 2920 2d3e 2042 6174 6368 6564 5661  gs) -> BatchedVa
-0000e840: 6c75 653a 0a20 2020 2062 6469 6d20 3d20  lue:.    bdim = 
-0000e850: 612e 6261 7463 685f 6469 6d0a 2020 2020  a.batch_dim.    
-0000e860: 2320 544f 444f 3a20 7265 6d6f 7665 2074  # TODO: remove t
-0000e870: 6869 7320 7768 656e 2064 696d 7320 6265  his when dims be
-0000e880: 636f 6d65 7320 6120 6d61 6e64 6174 6f72  comes a mandator
-0000e890: 7920 6b77 6172 670a 2020 2020 6966 206c  y kwarg.    if l
-0000e8a0: 656e 2864 696d 7329 203e 2030 3a0a 2020  en(dims) > 0:.  
-0000e8b0: 2020 2020 2020 6469 6d73 2c20 5f20 3d20        dims, _ = 
-0000e8c0: 7361 6665 5f7a 6970 282a 6469 6d73 290a  safe_zip(*dims).
-0000e8d0: 2020 2020 6469 6d73 5f62 6566 6f72 6520      dims_before 
-0000e8e0: 3d20 7475 706c 6528 656c 2066 6f72 2065  = tuple(el for e
-0000e8f0: 6c20 696e 2064 696d 7320 6966 2065 6c20  l in dims if el 
-0000e900: 3c20 6264 696d 290a 2020 2020 6469 6d73  < bdim).    dims
-0000e910: 5f61 6674 6572 203d 2074 7570 6c65 2865  _after = tuple(e
-0000e920: 6c20 2b20 3120 666f 7220 656c 2069 6e20  l + 1 for el in 
-0000e930: 6469 6d73 2069 6620 656c 203e 3d20 6264  dims if el >= bd
-0000e940: 696d 290a 2020 2020 6261 7463 6865 645f  im).    batched_
-0000e950: 6469 6d73 203d 2064 696d 735f 6265 666f  dims = dims_befo
-0000e960: 7265 202b 2064 696d 735f 6166 7465 720a  re + dims_after.
-0000e970: 2020 2020 7265 7475 726e 2076 6563 746f      return vecto
-0000e980: 7269 7a65 645f 6261 7463 6865 7228 7072  rized_batcher(pr
-0000e990: 696d 732e 7375 6d2c 2061 7869 735f 7369  ims.sum, axis_si
-0000e9a0: 7a65 2c20 2861 2c29 2c20 6469 6d73 3d62  ze, (a,), dims=b
-0000e9b0: 6174 6368 6564 5f64 696d 732c 202a 2a6b  atched_dims, **k
-0000e9c0: 7761 7267 7329 0a0a 0a23 2054 4f44 4f3a  wargs)...# TODO:
-0000e9d0: 2050 6c65 6173 6520 7465 7374 2074 6869   Please test thi
-0000e9e0: 7320 6578 7465 6e73 6976 656c 790a 6465  s extensively.de
-0000e9f0: 6620 6272 6f61 6463 6173 745f 696e 5f64  f broadcast_in_d
-0000ea00: 696d 5f76 6d61 7028 0a20 2020 2061 7869  im_vmap(.    axi
-0000ea10: 735f 7369 7a65 3a20 696e 742c 2061 3a20  s_size: int, a: 
-0000ea20: 4261 7463 6865 6456 616c 7565 2c20 7368  BatchedValue, sh
-0000ea30: 6170 653a 2053 6571 7565 6e63 655b 4261  ape: Sequence[Ba
-0000ea40: 7463 6865 6456 616c 7565 5d2c 2062 726f  tchedValue], bro
-0000ea50: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-0000ea60: 733a 2053 6571 7565 6e63 655b 4261 7463  s: Sequence[Batc
-0000ea70: 6865 6456 616c 7565 5d0a 2920 2d3e 2042  hedValue].) -> B
-0000ea80: 6174 6368 6564 5661 6c75 653a 0a20 2020  atchedValue:.   
-0000ea90: 2062 6469 6d20 3d20 612e 6261 7463 685f   bdim = a.batch_
-0000eaa0: 6469 6d0a 2020 2020 2320 544f 444f 3a20  dim.    # TODO: 
-0000eab0: 7265 6d6f 7665 2074 6869 7320 7768 656e  remove this when
-0000eac0: 2073 6861 7065 2061 6e64 2062 726f 6164   shape and broad
-0000ead0: 6361 7374 5f64 696d 656e 7369 6f6e 7320  cast_dimensions 
-0000eae0: 6265 636f 6d65 206d 616e 6461 746f 7279  become mandatory
-0000eaf0: 206b 7761 7267 730a 2020 2020 7368 6170   kwargs.    shap
-0000eb00: 652c 205f 203d 2073 6166 655f 7a69 7028  e, _ = safe_zip(
-0000eb10: 2a73 6861 7065 290a 2020 2020 6966 206c  *shape).    if l
-0000eb20: 656e 2862 726f 6164 6361 7374 5f64 696d  en(broadcast_dim
-0000eb30: 656e 7369 6f6e 7329 203e 2030 3a0a 2020  ensions) > 0:.  
-0000eb40: 2020 2020 2020 6272 6f61 6463 6173 745f        broadcast_
-0000eb50: 6469 6d65 6e73 696f 6e73 2c20 5f20 3d20  dimensions, _ = 
-0000eb60: 7361 6665 5f7a 6970 282a 6272 6f61 6463  safe_zip(*broadc
-0000eb70: 6173 745f 6469 6d65 6e73 696f 6e73 290a  ast_dimensions).
-0000eb80: 2020 2020 6966 2062 6469 6d20 6973 206e      if bdim is n
-0000eb90: 6f74 5f6d 6170 7065 643a 0a20 2020 2020  ot_mapped:.     
-0000eba0: 2020 2072 6574 7572 6e20 4261 7463 6865     return Batche
-0000ebb0: 6456 616c 7565 2870 7269 6d73 2e62 726f  dValue(prims.bro
-0000ebc0: 6164 6361 7374 5f69 6e5f 6469 6d28 612e  adcast_in_dim(a.
-0000ebd0: 7661 6c75 652c 2073 6861 7065 2c20 6272  value, shape, br
-0000ebe0: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
-0000ebf0: 6e73 292c 2062 6469 6d29 0a20 2020 2065  ns), bdim).    e
-0000ec00: 6c73 653a 0a20 2020 2020 2020 206e 6577  lse:.        new
-0000ec10: 5f62 6469 6d20 3d20 6264 696d 202b 2073  _bdim = bdim + s
-0000ec20: 756d 2831 2066 6f72 2064 696d 2069 6e20  um(1 for dim in 
-0000ec30: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
-0000ec40: 696f 6e73 2069 6620 6469 6d20 3c20 6264  ions if dim < bd
-0000ec50: 696d 290a 2020 2020 2020 2020 6e65 775f  im).        new_
-0000ec60: 7368 6170 6520 3d20 6c69 7374 2873 6861  shape = list(sha
-0000ec70: 7065 290a 2020 2020 2020 2020 6e65 775f  pe).        new_
-0000ec80: 7368 6170 652e 696e 7365 7274 286e 6577  shape.insert(new
-0000ec90: 5f62 6469 6d2c 2061 7869 735f 7369 7a65  _bdim, axis_size
-0000eca0: 290a 2020 2020 2020 2020 6e65 775f 6272  ).        new_br
-0000ecb0: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
-0000ecc0: 6e73 203d 2028 302c 2920 2b20 7475 706c  ns = (0,) + tupl
-0000ecd0: 6528 6469 6d20 2b20 3120 6966 2064 696d  e(dim + 1 if dim
-0000ece0: 203e 3d20 6264 696d 2065 6c73 6520 6469   >= bdim else di
-0000ecf0: 6d20 666f 7220 6469 6d20 696e 2062 726f  m for dim in bro
-0000ed00: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-0000ed10: 7329 0a20 2020 2020 2020 2069 6620 6272  s).        if br
-0000ed20: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
-0000ed30: 6e73 203d 3d20 2829 3a0a 2020 2020 2020  ns == ():.      
-0000ed40: 2020 2020 2020 6e65 775f 6272 6f61 6463        new_broadc
-0000ed50: 6173 745f 6469 6d65 6e73 696f 6e73 203d  ast_dimensions =
-0000ed60: 2028 290a 2020 2020 2020 2020 7265 7475   ().        retu
-0000ed70: 726e 2042 6174 6368 6564 5661 6c75 6528  rn BatchedValue(
-0000ed80: 7072 696d 732e 6272 6f61 6463 6173 745f  prims.broadcast_
-0000ed90: 696e 5f64 696d 2861 2e76 616c 7565 2c20  in_dim(a.value, 
-0000eda0: 6e65 775f 7368 6170 652c 206e 6577 5f62  new_shape, new_b
-0000edb0: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
-0000edc0: 6f6e 7329 2c20 6e65 775f 6264 696d 290a  ons), new_bdim).
-0000edd0: 0a0a 766d 6170 5f69 6d70 6c73 3a20 6469  ..vmap_impls: di
-0000ede0: 6374 5b70 7269 6d73 2e53 796d 626f 6c2c  ct[prims.Symbol,
-0000edf0: 2043 616c 6c61 626c 655d 203d 2064 6963   Callable] = dic
-0000ee00: 7428 290a 0a0a 6465 6620 756e 7772 6170  t()...def unwrap
-0000ee10: 5f6f 6e65 5f6c 6576 656c 5f6f 665f 7375  _one_level_of_su
-0000ee20: 6273 796d 626f 6c73 2874 7261 6365 293a  bsymbols(trace):
-0000ee30: 0a20 2020 206e 6577 5f73 796d 626f 6c73  .    new_symbols
-0000ee40: 5f69 7465 7220 3d20 280a 2020 2020 2020  _iter = (.      
-0000ee50: 2020 626f 756e 645f 7379 6d62 6f6c 2e73    bound_symbol.s
-0000ee60: 7562 7379 6d62 6f6c 7320 6966 206c 656e  ubsymbols if len
-0000ee70: 2862 6f75 6e64 5f73 796d 626f 6c2e 7375  (bound_symbol.su
-0000ee80: 6273 796d 626f 6c73 2920 3e20 3020 656c  bsymbols) > 0 el
-0000ee90: 7365 205b 626f 756e 645f 7379 6d62 6f6c  se [bound_symbol
-0000eea0: 5d0a 2020 2020 2020 2020 666f 7220 626f  ].        for bo
-0000eeb0: 756e 645f 7379 6d62 6f6c 2069 6e20 7472  und_symbol in tr
-0000eec0: 6163 652e 626f 756e 645f 7379 6d62 6f6c  ace.bound_symbol
-0000eed0: 730a 2020 2020 290a 2020 2020 6e65 775f  s.    ).    new_
-0000eee0: 7379 6d62 6f6c 7320 3d20 6c69 7374 2863  symbols = list(c
-0000eef0: 6861 696e 2e66 726f 6d5f 6974 6572 6162  hain.from_iterab
-0000ef00: 6c65 286e 6577 5f73 796d 626f 6c73 5f69  le(new_symbols_i
-0000ef10: 7465 7229 290a 2020 2020 7472 6163 652e  ter)).    trace.
-0000ef20: 626f 756e 645f 7379 6d62 6f6c 7320 3d20  bound_symbols = 
-0000ef30: 6e65 775f 7379 6d62 6f6c 730a 2020 2020  new_symbols.    
-0000ef40: 7265 7475 726e 2074 7261 6365 0a0a 0a64  return trace...d
-0000ef50: 6566 2064 6563 6f6d 706f 7365 645f 666e  ef decomposed_fn
-0000ef60: 5f76 6d61 705f 7275 6c65 2861 7869 735f  _vmap_rule(axis_
-0000ef70: 7369 7a65 2c20 2a61 7267 732c 2066 6e2c  size, *args, fn,
-0000ef80: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-0000ef90: 6172 6773 2c20 696e 5f64 696d 7320 3d20  args, in_dims = 
-0000efa0: 756e 7a69 7032 2861 7267 7329 0a20 2020  unzip2(args).   
-0000efb0: 2075 6e62 6174 6368 6564 5f61 7267 7320   unbatched_args 
-0000efc0: 3d20 7472 6565 5f6d 6170 286c 616d 6264  = tree_map(lambd
-0000efd0: 6120 783a 2072 656d 6f76 655f 6261 7463  a x: remove_batc
-0000efe0: 685f 6469 6d28 7829 2069 6620 6973 696e  h_dim(x) if isin
-0000eff0: 7374 616e 6365 2878 2c20 5465 6e73 6f72  stance(x, Tensor
-0000f000: 5072 6f78 7929 2065 6c73 6520 782c 2061  Proxy) else x, a
-0000f010: 7267 7329 0a20 2020 2074 7261 6365 203d  rgs).    trace =
-0000f020: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
-0000f030: 2829 2866 6e2c 202a 756e 6261 7463 6865  ()(fn, *unbatche
-0000f040: 645f 6172 6773 2c20 2a2a 6b77 6172 6773  d_args, **kwargs
-0000f050: 290a 2020 2020 7472 6163 6520 3d20 756e  ).    trace = un
-0000f060: 7772 6170 5f6f 6e65 5f6c 6576 656c 5f6f  wrap_one_level_o
-0000f070: 665f 7375 6273 796d 626f 6c73 2874 7261  f_subsymbols(tra
-0000f080: 6365 290a 2020 2020 6f75 7473 203d 205f  ce).    outs = _
-0000f090: 766d 6170 5f63 616c 6c5f 6d65 7461 6675  vmap_call_metafu
-0000f0a0: 6e63 2846 616c 7365 2c20 6172 6773 2c20  nc(False, args, 
-0000f0b0: 696e 5f64 696d 732c 2030 2c20 6178 6973  in_dims, 0, axis
-0000f0c0: 5f73 697a 652c 2066 756e 6374 696f 6e5f  _size, function_
-0000f0d0: 7472 6163 653d 7472 6163 652c 202a 2a6b  trace=trace, **k
-0000f0e0: 7761 7267 7329 0a20 2020 2069 6620 6973  wargs).    if is
-0000f0f0: 696e 7374 616e 6365 286f 7574 732c 2053  instance(outs, S
-0000f100: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
-0000f110: 2020 6f75 745f 6469 6d73 203d 2028 302c    out_dims = (0,
-0000f120: 2920 2a20 6c65 6e28 6f75 7473 290a 2020  ) * len(outs).  
-0000f130: 2020 2020 2020 7265 7475 726e 2073 6166        return saf
-0000f140: 655f 6d61 7028 7061 6972 5f74 6f5f 6261  e_map(pair_to_ba
-0000f150: 7463 6865 645f 7661 6c75 652c 2073 6166  tched_value, saf
-0000f160: 655f 7a69 7028 6f75 7473 2c20 6f75 745f  e_zip(outs, out_
-0000f170: 6469 6d73 2929 0a20 2020 2072 6574 7572  dims)).    retur
-0000f180: 6e20 4261 7463 6865 6456 616c 7565 286f  n BatchedValue(o
-0000f190: 7574 732c 2030 290a 0a0a 766d 6170 5f69  uts, 0)...vmap_i
-0000f1a0: 6d70 6c73 5b70 7269 6d73 2e50 7269 6d49  mpls[prims.PrimI
-0000f1b0: 4473 2e53 494e 5d20 3d20 7369 6e5f 766d  Ds.SIN] = sin_vm
-0000f1c0: 6170 0a76 6d61 705f 696d 706c 735b 7072  ap.vmap_impls[pr
-0000f1d0: 696d 732e 5072 696d 4944 732e 434f 535d  ims.PrimIDs.COS]
-0000f1e0: 203d 2063 6f73 5f76 6d61 700a 766d 6170   = cos_vmap.vmap
-0000f1f0: 5f69 6d70 6c73 5b70 7269 6d73 2e50 7269  _impls[prims.Pri
-0000f200: 6d49 4473 2e4d 554c 5d20 3d20 6d75 6c5f  mIDs.MUL] = mul_
-0000f210: 766d 6170 0a76 6d61 705f 696d 706c 735b  vmap.vmap_impls[
-0000f220: 7072 696d 732e 5072 696d 4944 732e 4144  prims.PrimIDs.AD
-0000f230: 445d 203d 2061 6464 5f76 6d61 700a 766d  D] = add_vmap.vm
-0000f240: 6170 5f69 6d70 6c73 5b70 7269 6d73 2e50  ap_impls[prims.P
-0000f250: 7269 6d49 4473 2e53 554d 5d20 3d20 7375  rimIDs.SUM] = su
-0000f260: 6d5f 766d 6170 0a76 6d61 705f 696d 706c  m_vmap.vmap_impl
-0000f270: 735b 7072 696d 732e 5072 696d 4944 732e  s[prims.PrimIDs.
-0000f280: 4252 4f41 4443 4153 545f 494e 5f44 494d  BROADCAST_IN_DIM
-0000f290: 5d20 3d20 6272 6f61 6463 6173 745f 696e  ] = broadcast_in
-0000f2a0: 5f64 696d 5f76 6d61 700a 0a0a 6465 6620  _dim_vmap...def 
-0000f2b0: 766d 6170 5f73 796d 626f 6c5f 6d61 7070  vmap_symbol_mapp
-0000f2c0: 6572 2873 796d 626f 6c3a 2070 7269 6d73  er(symbol: prims
-0000f2d0: 2e53 796d 626f 6c2c 202a 2c20 6178 6973  .Symbol, *, axis
-0000f2e0: 5f73 697a 653a 2069 6e74 293a 0a20 2020  _size: int):.   
-0000f2f0: 2022 2222 4d61 7073 2061 2073 796d 626f   """Maps a symbo
-0000f300: 6c20 746f 2061 2076 6d61 7020 6675 6e63  l to a vmap func
-0000f310: 7469 6f6e 2074 6861 7420 6576 616c 7561  tion that evalua
-0000f320: 7465 7320 6974 2e0a 0a20 2020 2041 7267  tes it...    Arg
-0000f330: 733a 0a20 2020 2020 2020 2073 796d 626f  s:.        symbo
-0000f340: 6c20 2870 7269 6d73 2e53 796d 626f 6c29  l (prims.Symbol)
-0000f350: 3a20 5379 6d62 6f6c 2074 6f20 6576 616c  : Symbol to eval
-0000f360: 7561 7465 2e0a 0a20 2020 2052 6169 7365  uate...    Raise
-0000f370: 733a 0a20 2020 2020 2020 204e 6f74 496d  s:.        NotIm
-0000f380: 706c 656d 656e 7465 6445 7272 6f72 3a20  plementedError: 
-0000f390: 4966 2074 6865 2076 6d61 7020 666f 7220  If the vmap for 
-0000f3a0: 7468 6520 7379 6d62 6f6c 2069 7320 6e6f  the symbol is no
-0000f3b0: 7420 696d 706c 656d 656e 7465 642e 0a0a  t implemented...
-0000f3c0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0000f3d0: 2020 2020 2043 616c 6c61 626c 653a 2076       Callable: v
-0000f3e0: 6d61 7020 6675 6e63 7469 6f6e 2074 6861  map function tha
-0000f3f0: 7420 6576 616c 7561 7465 7320 7468 6520  t evaluates the 
-0000f400: 7379 6d62 6f6c 2e0a 2020 2020 2222 220a  symbol..    """.
-0000f410: 0a20 2020 2064 6566 2077 7261 705f 6172  .    def wrap_ar
-0000f420: 6728 7829 3a0a 2020 2020 2020 2020 6966  g(x):.        if
-0000f430: 2069 7369 6e73 7461 6e63 6528 782c 2042   isinstance(x, B
-0000f440: 6174 6368 6564 5661 6c75 6529 3a0a 2020  atchedValue):.  
-0000f450: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000f460: 2078 0a20 2020 2020 2020 2065 6c69 6620   x.        elif 
-0000f470: 6973 696e 7374 616e 6365 2878 2c20 4e75  isinstance(x, Nu
-0000f480: 6d62 6572 293a 0a20 2020 2020 2020 2020  mber):.         
-0000f490: 2020 2072 6574 7572 6e20 4261 7463 6865     return Batche
-0000f4a0: 6456 616c 7565 2878 2c20 6e6f 745f 6d61  dValue(x, not_ma
-0000f4b0: 7070 6564 290a 2020 2020 2020 2020 656c  pped).        el
-0000f4c0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000f4d0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-0000f4e0: 2866 2276 6d61 7020 7772 6170 5f61 7267  (f"vmap wrap_arg
-0000f4f0: 2067 6f74 2061 6e20 756e 7375 7070 6f72   got an unsuppor
-0000f500: 7465 6420 7479 7065 207b 7479 7065 2878  ted type {type(x
-0000f510: 297d 2229 0a0a 2020 2020 6966 2073 796d  )}")..    if sym
-0000f520: 626f 6c2e 6172 655f 616c 6c5f 6172 6773  bol.are_all_args
-0000f530: 5f63 6f6e 7374 616e 743a 0a0a 2020 2020  _constant:..    
-0000f540: 2020 2020 6465 6620 5f76 6d61 705f 696d      def _vmap_im
-0000f550: 706c 5f63 6f6e 7374 2873 796d 626f 6c2c  pl_const(symbol,
-0000f560: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
-0000f570: 293a 0a20 2020 2020 2020 2020 2020 206f  ):.            o
-0000f580: 7574 203d 2073 796d 626f 6c5f 746f 5f65  ut = symbol_to_e
-0000f590: 7661 6c28 7379 6d62 6f6c 2928 2a61 7267  val(symbol)(*arg
-0000f5a0: 732c 202a 2a6b 7761 7267 7329 0a0a 2020  s, **kwargs)..  
-0000f5b0: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-0000f5c0: 6e73 7461 6e63 6528 6f75 742c 2053 6571  nstance(out, Seq
-0000f5d0: 7565 6e63 6529 3a0a 2020 2020 2020 2020  uence):.        
-0000f5e0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0000f5f0: 6166 655f 6d61 7028 7061 6972 5f74 6f5f  afe_map(pair_to_
-0000f600: 6261 7463 6865 645f 7661 6c75 652c 2073  batched_value, s
-0000f610: 6166 655f 7a69 7028 6172 6773 2c20 5b6e  afe_zip(args, [n
-0000f620: 6f74 5f6d 6170 7065 645d 202a 206c 656e  ot_mapped] * len
-0000f630: 286f 7574 2929 290a 0a20 2020 2020 2020  (out)))..       
-0000f640: 2020 2020 2072 6574 7572 6e20 4261 7463       return Batc
-0000f650: 6865 6456 616c 7565 286f 7574 2c20 6e6f  hedValue(out, no
-0000f660: 745f 6d61 7070 6564 290a 0a20 2020 2020  t_mapped)..     
-0000f670: 2020 2072 6574 7572 6e20 7061 7274 6961     return partia
-0000f680: 6c28 5f76 6d61 705f 696d 706c 5f63 6f6e  l(_vmap_impl_con
-0000f690: 7374 2c20 7379 6d62 6f6c 290a 0a20 2020  st, symbol)..   
-0000f6a0: 2076 6d61 705f 696d 706c 203d 2076 6d61   vmap_impl = vma
-0000f6b0: 705f 696d 706c 732e 6765 7428 7379 6d62  p_impls.get(symb
-0000f6c0: 6f6c 2e73 796d 2e69 6429 0a20 2020 2069  ol.sym.id).    i
-0000f6d0: 6620 766d 6170 5f69 6d70 6c20 6973 204e  f vmap_impl is N
-0000f6e0: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
-0000f6f0: 6c65 6e28 7379 6d62 6f6c 2e73 7562 7379  len(symbol.subsy
-0000f700: 6d62 6f6c 7329 203e 2030 3a0a 2020 2020  mbols) > 0:.    
-0000f710: 2020 2020 2020 2020 766d 6170 5f69 6d70          vmap_imp
-0000f720: 6c20 3d20 7061 7274 6961 6c28 6465 636f  l = partial(deco
-0000f730: 6d70 6f73 6564 5f66 6e5f 766d 6170 5f72  mposed_fn_vmap_r
-0000f740: 756c 652c 2066 6e3d 7379 6d62 6f6c 2e73  ule, fn=symbol.s
-0000f750: 796d 290a 2020 2020 2020 2020 656c 7365  ym).        else
-0000f760: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0000f770: 6973 6520 4e6f 7449 6d70 6c65 6d65 6e74  ise NotImplement
-0000f780: 6564 4572 726f 7228 6622 766d 6170 2066  edError(f"vmap f
-0000f790: 6f72 207b 7379 6d62 6f6c 2e73 796d 2e69  or {symbol.sym.i
-0000f7a0: 647d 2069 7320 6e6f 7420 696d 706c 656d  d} is not implem
-0000f7b0: 656e 7465 6422 290a 0a20 2020 2064 6566  ented")..    def
-0000f7c0: 205f 766d 6170 5f69 6d70 6c28 2a61 7267   _vmap_impl(*arg
-0000f7d0: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
-0000f7e0: 2020 2020 2020 6172 6773 203d 2074 7265        args = tre
-0000f7f0: 655f 6d61 7028 7772 6170 5f61 7267 2c20  e_map(wrap_arg, 
-0000f800: 6172 6773 290a 2020 2020 2020 2020 6173  args).        as
-0000f810: 7365 7274 2061 6c6c 2869 7369 6e73 7461  sert all(isinsta
-0000f820: 6e63 6528 6172 672c 2042 6174 6368 6564  nce(arg, Batched
-0000f830: 5661 6c75 6529 2066 6f72 2061 7267 2069  Value) for arg i
-0000f840: 6e20 7472 6565 5f66 6c61 7474 656e 2861  n tree_flatten(a
-0000f850: 7267 7329 5b30 5d29 0a20 2020 2020 2020  rgs)[0]).       
-0000f860: 2072 6574 7572 6e20 766d 6170 5f69 6d70   return vmap_imp
-0000f870: 6c28 6178 6973 5f73 697a 652c 202a 6172  l(axis_size, *ar
-0000f880: 6773 2c20 2a2a 6b77 6172 6773 290a 0a20  gs, **kwargs).. 
-0000f890: 2020 2072 6574 7572 6e20 5f76 6d61 705f     return _vmap_
-0000f8a0: 696d 706c 0a0a 0a64 6566 2072 656d 6f76  impl...def remov
-0000f8b0: 655f 6261 7463 685f 6469 6d28 7465 6e73  e_batch_dim(tens
-0000f8c0: 6f72 3a20 5465 6e73 6f72 5072 6f78 792c  or: TensorProxy,
-0000f8d0: 2062 6174 6368 5f64 696d 3a20 696e 7420   batch_dim: int 
-0000f8e0: 3d20 3029 202d 3e20 5465 6e73 6f72 5072  = 0) -> TensorPr
-0000f8f0: 6f78 793a 0a20 2020 2022 2222 5265 6d6f  oxy:.    """Remo
-0000f900: 7665 7320 7468 6520 6261 7463 6820 6469  ves the batch di
-0000f910: 6d65 6e73 696f 6e20 6672 6f6d 2061 2074  mension from a t
-0000f920: 656e 736f 722e 0a0a 2020 2020 4172 6773  ensor...    Args
-0000f930: 3a0a 2020 2020 2020 2020 7465 6e73 6f72  :.        tensor
-0000f940: 2028 5465 6e73 6f72 5072 6f78 7929 3a20   (TensorProxy): 
-0000f950: 5465 6e73 6f72 2074 6f20 7265 6d6f 7665  Tensor to remove
-0000f960: 2074 6865 2062 6174 6368 2064 696d 656e   the batch dimen
-0000f970: 7369 6f6e 2066 726f 6d2e 0a0a 2020 2020  sion from...    
-0000f980: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-0000f990: 2054 656e 736f 7250 726f 7879 3a20 5465   TensorProxy: Te
-0000f9a0: 6e73 6f72 2077 6974 6820 7468 6520 6261  nsor with the ba
-0000f9b0: 7463 6820 6469 6d65 6e73 696f 6e20 7265  tch dimension re
-0000f9c0: 6d6f 7665 642e 0a20 2020 2022 2222 0a20  moved..    """. 
-0000f9d0: 2020 206e 6577 5f73 6861 7065 203d 2074     new_shape = t
-0000f9e0: 656e 736f 722e 7368 6170 655b 3a62 6174  ensor.shape[:bat
-0000f9f0: 6368 5f64 696d 5d20 2b20 7465 6e73 6f72  ch_dim] + tensor
-0000fa00: 2e73 6861 7065 5b62 6174 6368 5f64 696d  .shape[batch_dim
-0000fa10: 202b 2031 203a 5d0a 2020 2020 7265 7475   + 1 :].    retu
-0000fa20: 726e 2054 656e 736f 7250 726f 7879 286c  rn TensorProxy(l
-0000fa30: 696b 653d 7465 6e73 6f72 2c20 7368 6170  ike=tensor, shap
-0000fa40: 653d 6e65 775f 7368 6170 6529 0a0a 0a23  e=new_shape)...#
-0000fa50: 2054 4f44 4f3a 2069 6e20 4a41 5820 6172   TODO: in JAX ar
-0000fa60: 6773 2c20 696e 5f64 696d 7320 6172 6520  gs, in_dims are 
-0000fa70: 666c 6174 7465 6e65 6420 7468 6520 7361  flattened the sa
-0000fa80: 6d65 2077 6179 0a23 2054 4f44 4f3a 2069  me way.# TODO: i
-0000fa90: 6e20 4a41 5820 6f75 745f 6469 6d73 2061  n JAX out_dims a
-0000faa0: 7265 2066 6c61 7474 656e 6564 2061 7320  re flattened as 
-0000fab0: 7765 6c6c 0a64 6566 205f 766d 6170 5f63  well.def _vmap_c
-0000fac0: 616c 6c5f 6d65 7461 6675 6e63 2864 6574  all_metafunc(det
-0000fad0: 6163 6865 643a 2062 6f6f 6c2c 2061 7267  ached: bool, arg
-0000fae0: 732c 2069 6e5f 6469 6d73 2c20 6f75 745f  s, in_dims, out_
-0000faf0: 6469 6d73 2c20 6178 6973 5f73 697a 652c  dims, axis_size,
-0000fb00: 2066 756e 6374 696f 6e5f 7472 6163 653a   function_trace:
-0000fb10: 2054 7261 6365 2c20 2a2a 6b77 6172 6773   Trace, **kwargs
-0000fb20: 293a 0a20 2020 2022 2222 4d65 7461 6675  ):.    """Metafu
-0000fb30: 6e63 7469 6f6e 2066 6f72 2076 6d61 7020  nction for vmap 
-0000fb40: 6361 6c6c 2e0a 0a20 2020 2041 7267 733a  call...    Args:
-0000fb50: 0a20 2020 2020 2020 2064 6574 6163 6865  .        detache
-0000fb60: 6420 2862 6f6f 6c29 3a20 5768 6574 6865  d (bool): Whethe
-0000fb70: 7220 746f 2064 6574 6163 6820 7468 6520  r to detach the 
-0000fb80: 7472 6163 652e 0a20 2020 2020 2020 2061  trace..        a
-0000fb90: 7267 7320 2854 7570 6c65 5b50 726f 7879  rgs (Tuple[Proxy
-0000fba0: 5d29 3a20 4172 6775 6d65 6e74 7320 746f  ]): Arguments to
-0000fbb0: 2074 6865 2066 756e 6374 696f 6e2e 0a20   the function.. 
-0000fbc0: 2020 2020 2020 2069 6e5f 6469 6d73 2028         in_dims (
-0000fbd0: 5475 706c 655b 696e 745d 293a 2042 6174  Tuple[int]): Bat
-0000fbe0: 6368 2064 696d 656e 7369 6f6e 2066 6f72  ch dimension for
-0000fbf0: 2065 6163 6820 6172 6775 6d65 6e74 2e0a   each argument..
-0000fc00: 2020 2020 2020 2020 6f75 745f 6469 6d73          out_dims
-0000fc10: 2028 5475 706c 655b 696e 745d 293a 2042   (Tuple[int]): B
-0000fc20: 6174 6368 2064 696d 656e 7369 6f6e 2066  atch dimension f
-0000fc30: 6f72 2072 6574 7572 6e20 7661 6c75 6573  or return values
-0000fc40: 2e0a 2020 2020 2020 2020 6675 6e63 7469  ..        functi
-0000fc50: 6f6e 5f74 7261 6365 2028 5472 6163 6529  on_trace (Trace)
-0000fc60: 3a20 5472 6163 6520 746f 2075 7365 2066  : Trace to use f
-0000fc70: 6f72 2074 6865 2066 756e 6374 696f 6e2e  or the function.
-0000fc80: 0a20 2020 2020 2020 206b 7761 7267 733a  .        kwargs:
-0000fc90: 204b 6579 776f 7264 2061 7267 756d 656e   Keyword argumen
-0000fca0: 7473 2e0a 0a20 2020 2052 6169 7365 733a  ts...    Raises:
-0000fcb0: 0a20 2020 2020 2020 2041 7373 6572 7469  .        Asserti
-0000fcc0: 6f6e 4572 726f 723a 2049 6620 7468 6520  onError: If the 
-0000fcd0: 766d 6170 2066 6f72 206b 6579 776f 7264  vmap for keyword
-0000fce0: 2061 7267 756d 656e 7473 2069 7320 6e6f   arguments is no
-0000fcf0: 7420 696d 706c 656d 656e 7465 642e 0a0a  t implemented...
-0000fd00: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0000fd10: 2020 2020 2052 6573 756c 7420 6f66 2074       Result of t
-0000fd20: 6865 2076 6d61 7020 7472 616e 7366 6f72  he vmap transfor
-0000fd30: 6d2e 0a20 2020 2022 2222 0a20 2020 2063  m..    """.    c
-0000fd40: 6f6d 6d6f 6e5f 6465 7669 6365 203d 207b  ommon_device = {
-0000fd50: 782e 6465 7669 6365 2066 6f72 2078 2069  x.device for x i
-0000fd60: 6e20 6172 6773 2069 6620 6973 696e 7374  n args if isinst
-0000fd70: 616e 6365 2878 2c20 5465 6e73 6f72 5072  ance(x, TensorPr
-0000fd80: 6f78 7929 7d0a 2020 2020 6173 7365 7274  oxy)}.    assert
-0000fd90: 206c 656e 2863 6f6d 6d6f 6e5f 6465 7669   len(common_devi
-0000fda0: 6365 2920 3c3d 2031 2c20 2276 6d61 7020  ce) <= 1, "vmap 
-0000fdb0: 666f 7220 6d75 6c74 6970 6c65 2064 6576  for multiple dev
-0000fdc0: 6963 6573 2069 7320 6e6f 7420 696d 706c  ices is not impl
-0000fdd0: 656d 656e 7465 6422 0a20 2020 2028 636f  emented".    (co
-0000fde0: 6d6d 6f6e 5f64 6576 6963 652c 2920 3d20  mmon_device,) = 
-0000fdf0: 636f 6d6d 6f6e 5f64 6576 6963 6520 6966  common_device if
-0000fe00: 206c 656e 2863 6f6d 6d6f 6e5f 6465 7669   len(common_devi
-0000fe10: 6365 2920 3d3d 2031 2065 6c73 6520 2863  ce) == 1 else (c
-0000fe20: 7075 2c29 0a0a 2020 2020 6966 2061 7869  pu,)..    if axi
-0000fe30: 735f 7369 7a65 2069 7320 4e6f 6e65 3a0a  s_size is None:.
-0000fe40: 2020 2020 2020 2020 2861 7869 735f 7369          (axis_si
-0000fe50: 7a65 2c29 203d 207b 782e 7368 6170 655b  ze,) = {x.shape[
-0000fe60: 6178 5d20 666f 7220 782c 2061 7820 696e  ax] for x, ax in
-0000fe70: 207a 6970 2861 7267 732c 2069 6e5f 6469   zip(args, in_di
-0000fe80: 6d73 2920 6966 2061 7820 6973 206e 6f74  ms) if ax is not
-0000fe90: 206e 6f74 5f6d 6170 7065 647d 0a20 2020   not_mapped}.   
-0000fea0: 2069 6e5f 6469 6d73 203d 2069 6e5f 6469   in_dims = in_di
-0000feb0: 6d73 2069 6620 6973 696e 7374 616e 6365  ms if isinstance
-0000fec0: 2869 6e5f 6469 6d73 2c20 5365 7175 656e  (in_dims, Sequen
-0000fed0: 6365 2920 656c 7365 2028 696e 5f64 696d  ce) else (in_dim
-0000fee0: 732c 290a 2020 2020 696e 5f64 696d 7320  s,).    in_dims 
-0000fef0: 3d20 7475 706c 6528 6e6f 745f 6d61 7070  = tuple(not_mapp
-0000ff00: 6564 2069 6620 6973 696e 7374 616e 6365  ed if isinstance
-0000ff10: 2861 2c20 4e75 6d62 6572 2920 656c 7365  (a, Number) else
-0000ff20: 2064 2066 6f72 2061 2c20 6420 696e 2073   d for a, d in s
-0000ff30: 6166 655f 7a69 7028 6172 6773 2c20 696e  afe_zip(args, in
-0000ff40: 5f64 696d 7329 290a 2020 2020 6f75 745f  _dims)).    out_
-0000ff50: 6469 6d73 203d 206f 7574 5f64 696d 7320  dims = out_dims 
-0000ff60: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
-0000ff70: 745f 6469 6d73 2c20 5365 7175 656e 6365  t_dims, Sequence
-0000ff80: 2920 656c 7365 2028 6f75 745f 6469 6d73  ) else (out_dims
-0000ff90: 2c29 0a0a 2020 2020 6374 7820 3d20 6465  ,)..    ctx = de
-0000ffa0: 7461 6368 6564 5f74 7261 6365 2829 2069  tached_trace() i
-0000ffb0: 6620 6465 7461 6368 6564 2065 6c73 6520  f detached else 
-0000ffc0: 6e75 6c6c 636f 6e74 6578 7428 290a 2020  nullcontext().  
-0000ffd0: 2020 7769 7468 2063 7478 3a0a 2020 2020    with ctx:.    
-0000ffe0: 2020 2020 2320 5765 2070 726f 7061 6761      # We propaga
-0000fff0: 7465 2074 6865 2042 6174 6368 5661 6c75  te the BatchValu
-00010000: 6520 7468 726f 7567 6820 7468 6520 7472  e through the tr
-00010010: 6163 652c 2061 6e64 2074 6865 6e20 756e  ace, and then un
-00010020: 7772 6170 2069 7420 6174 2074 6865 2065  wrap it at the e
-00010030: 6e64 0a20 2020 2020 2020 2062 6174 6368  nd.        batch
-00010040: 6564 5f61 7267 7320 3d20 7361 6665 5f6d  ed_args = safe_m
-00010050: 6170 2870 6169 725f 746f 5f62 6174 6368  ap(pair_to_batch
-00010060: 6564 5f76 616c 7565 2c20 7361 6665 5f7a  ed_value, safe_z
-00010070: 6970 2861 7267 732c 2069 6e5f 6469 6d73  ip(args, in_dims
-00010080: 2929 0a20 2020 2020 2020 2072 6573 756c  )).        resul
-00010090: 7420 3d20 6576 616c 5f74 7261 6365 280a  t = eval_trace(.
-000100a0: 2020 2020 2020 2020 2020 2020 6675 6e63              func
-000100b0: 7469 6f6e 5f74 7261 6365 2c20 2a62 6174  tion_trace, *bat
-000100c0: 6368 6564 5f61 7267 732c 2073 796d 626f  ched_args, symbo
-000100d0: 6c5f 6d61 7070 6572 3d70 6172 7469 616c  l_mapper=partial
-000100e0: 2876 6d61 705f 7379 6d62 6f6c 5f6d 6170  (vmap_symbol_map
-000100f0: 7065 722c 2061 7869 735f 7369 7a65 3d61  per, axis_size=a
-00010100: 7869 735f 7369 7a65 292c 202a 2a6b 7761  xis_size), **kwa
-00010110: 7267 730a 2020 2020 2020 2020 290a 2020  rgs.        ).  
-00010120: 2020 2020 2020 2320 556e 7772 6170 7069        # Unwrappi
-00010130: 6e67 2074 6865 2042 6174 6368 6564 5661  ng the BatchedVa
-00010140: 6c75 6527 730a 2020 2020 2020 2020 6966  lue's.        if
-00010150: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
-00010160: 6c74 2c20 5365 7175 656e 6365 293a 0a20  lt, Sequence):. 
-00010170: 2020 2020 2020 2020 2020 2066 6c61 745f             flat_
-00010180: 7265 7375 6c74 2c20 7370 6563 203d 2074  result, spec = t
-00010190: 7265 655f 666c 6174 7465 6e28 7265 7375  ree_flatten(resu
-000101a0: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
-000101b0: 6173 7365 7274 2061 6c6c 2869 7369 6e73  assert all(isins
-000101c0: 7461 6e63 6528 782c 2042 6174 6368 6564  tance(x, Batched
-000101d0: 5661 6c75 6529 2066 6f72 2078 2069 6e20  Value) for x in 
-000101e0: 666c 6174 5f72 6573 756c 7429 0a20 2020  flat_result).   
-000101f0: 2020 2020 2020 2020 206f 7574 732c 2062           outs, b
-00010200: 6469 6d73 203d 2075 6e7a 6970 3228 666c  dims = unzip2(fl
-00010210: 6174 5f72 6573 756c 7429 0a20 2020 2020  at_result).     
-00010220: 2020 2020 2020 2023 2054 4f44 4f3a 2068         # TODO: h
-00010230: 616e 646c 6520 7468 6520 6361 7365 2077  andle the case w
-00010240: 6865 7265 206f 7574 5f64 696d 7320 6973  here out_dims is
-00010250: 2061 2073 696e 676c 6520 7661 6c75 6520   a single value 
-00010260: 6265 7474 6572 0a20 2020 2020 2020 2020  better.         
-00010270: 2020 2069 6620 6c65 6e28 6f75 745f 6469     if len(out_di
-00010280: 6d73 2920 3d3d 2031 3a0a 2020 2020 2020  ms) == 1:.      
-00010290: 2020 2020 2020 2020 2020 6f75 745f 6469            out_di
-000102a0: 6d73 203d 206f 7574 5f64 696d 7320 2a20  ms = out_dims * 
-000102b0: 6c65 6e28 6f75 7473 290a 2020 2020 2020  len(outs).      
-000102c0: 2020 2020 2020 6f75 7473 203d 2073 6166        outs = saf
-000102d0: 655f 6d61 7028 7061 7274 6961 6c28 6d6f  e_map(partial(mo
-000102e0: 7665 5f62 6174 6368 5f64 696d 2c20 6178  ve_batch_dim, ax
-000102f0: 6973 5f73 697a 6529 2c20 6264 696d 732c  is_size), bdims,
-00010300: 206f 7574 5f64 696d 732c 206f 7574 7329   out_dims, outs)
-00010310: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00010320: 7572 6e20 7472 6565 5f75 6e66 6c61 7474  urn tree_unflatt
-00010330: 656e 286f 7574 732c 2073 7065 6329 0a20  en(outs, spec). 
-00010340: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-00010350: 616e 6365 2872 6573 756c 742c 204e 756d  ance(result, Num
-00010360: 6265 7229 2061 6e64 2061 7869 735f 7369  ber) and axis_si
-00010370: 7a65 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ze is not None:.
-00010380: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
-00010390: 444f 3a20 6665 7463 6820 7468 6520 6465  DO: fetch the de
-000103a0: 6661 756c 7420 6465 7669 6365 2066 726f  fault device fro
-000103b0: 6d20 7468 6520 636f 6e74 6578 740a 2020  m the context.  
-000103c0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-000103d0: 203d 2066 756c 6c28 7368 6170 653d 2829   = full(shape=()
-000103e0: 2c20 6669 6c6c 5f76 616c 7565 3d72 6573  , fill_value=res
-000103f0: 756c 742c 2064 6576 6963 653d 636f 6d6d  ult, device=comm
-00010400: 6f6e 5f64 6576 6963 6529 0a20 2020 2020  on_device).     
-00010410: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00010420: 4261 7463 6865 6456 616c 7565 2872 6573  BatchedValue(res
-00010430: 756c 742c 206e 6f74 5f6d 6170 7065 6429  ult, not_mapped)
-00010440: 0a20 2020 2020 2020 2065 6c69 6620 6973  .        elif is
-00010450: 696e 7374 616e 6365 2872 6573 756c 742c  instance(result,
-00010460: 2042 6174 6368 6564 5661 6c75 6529 2061   BatchedValue) a
-00010470: 6e64 2069 7369 6e73 7461 6e63 6528 7265  nd isinstance(re
-00010480: 7375 6c74 2e76 616c 7565 2c20 4e75 6d62  sult.value, Numb
-00010490: 6572 2920 616e 6420 6178 6973 5f73 697a  er) and axis_siz
-000104a0: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
-000104b0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-000104c0: 7420 3d20 4261 7463 6865 6456 616c 7565  t = BatchedValue
-000104d0: 2866 756c 6c28 7368 6170 653d 2829 2c20  (full(shape=(), 
-000104e0: 6669 6c6c 5f76 616c 7565 3d72 6573 756c  fill_value=resul
-000104f0: 742e 7661 6c75 652c 2064 6576 6963 653d  t.value, device=
-00010500: 636f 6d6d 6f6e 5f64 6576 6963 6529 2c20  common_device), 
-00010510: 7265 7375 6c74 2e62 6174 6368 5f64 696d  result.batch_dim
-00010520: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-00010530: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
-00010540: 6c74 2c20 4261 7463 6865 6456 616c 7565  lt, BatchedValue
-00010550: 290a 2020 2020 2020 2020 6f75 7420 3d20  ).        out = 
-00010560: 6d6f 7665 5f62 6174 6368 5f64 696d 2861  move_batch_dim(a
-00010570: 7869 735f 7369 7a65 2c20 7265 7375 6c74  xis_size, result
-00010580: 2e62 6174 6368 5f64 696d 2c20 6f75 745f  .batch_dim, out_
-00010590: 6469 6d73 5b30 5d2c 2072 6573 756c 742e  dims[0], result.
-000105a0: 7661 6c75 6529 0a20 2020 2020 2020 2072  value).        r
-000105b0: 6574 7572 6e20 6f75 740a 0a0a 766d 6170  eturn out...vmap
-000105c0: 5f63 616c 6c20 3d20 5379 6d62 6f6c 2869  _call = Symbol(i
-000105d0: 643d 5472 616e 7366 6f72 6d73 2e56 6d61  d=Transforms.Vma
-000105e0: 704f 702c 206e 616d 653d 2276 6d61 705f  pOp, name="vmap_
-000105f0: 6361 6c6c 222c 206d 6574 613d 7061 7274  call", meta=part
-00010600: 6961 6c28 5f76 6d61 705f 6361 6c6c 5f6d  ial(_vmap_call_m
-00010610: 6574 6166 756e 632c 2046 616c 7365 2929  etafunc, False))
-00010620: 0a0a 0a23 2054 4f44 4f3a 2068 6f77 2073  ...# TODO: how s
-00010630: 686f 756c 6420 7765 2068 616e 646c 6520  hould we handle 
-00010640: 6f75 745f 6469 6d73 2068 6572 653f 0a23  out_dims here?.#
-00010650: 2061 6c74 686f 7567 6820 6865 7265 2077   although here w
-00010660: 6520 6172 6520 6361 6c6c 696e 6720 766d  e are calling vm
-00010670: 6170 206f 6620 6964 656e 7469 7479 2c20  ap of identity, 
-00010680: 736f 2077 6520 7368 6f75 6c64 206b 6e6f  so we should kno
-00010690: 7720 6672 6f6d 2074 6865 2063 616c 6c20  w from the call 
-000106a0: 746f 2076 6d61 700a 2320 5468 6973 2073  to vmap.# This s
-000106b0: 686f 756c 6420 6265 2066 696e 652e 2049  hould be fine. I
-000106c0: 6620 7765 2068 6176 6520 766d 6170 2869  f we have vmap(i
-000106d0: 6465 6e74 6974 7928 6675 6e63 292c 206f  dentity(func), o
-000106e0: 7574 5f64 696d 733d 4e29 2074 6865 6e20  ut_dims=N) then 
-000106f0: 7468 6973 2072 756c 6520 6973 2066 6972  this rule is fir
-00010700: 7374 2075 7365 640a 2320 746f 2067 6574  st used.# to get
-00010710: 2074 6865 2076 6d61 7070 6564 2072 6573   the vmapped res
-00010720: 756c 7420 6f66 2069 6465 6e74 6974 7928  ult of identity(
-00010730: 6675 6e63 2920 696e 2076 6d61 705f 7379  func) in vmap_sy
-00010740: 6d62 6f6c 5f6d 6170 7065 722c 2061 6e64  mbol_mapper, and
-00010750: 206f 7574 5f64 696d 7320 6973 2068 616e   out_dims is han
-00010760: 646c 6564 0a23 2061 6674 6572 2074 6861  dled.# after tha
-00010770: 7420 696e 2074 6865 206f 7574 6572 205f  t in the outer _
-00010780: 766d 6170 5f63 616c 6c5f 6d65 7461 6675  vmap_call_metafu
-00010790: 6e63 2e0a 6465 6620 5f69 6465 6e74 6974  nc..def _identit
-000107a0: 795f 6361 6c6c 5f76 6d61 7028 6178 6973  y_call_vmap(axis
-000107b0: 5f73 697a 652c 202a 6261 7463 6865 645f  _size, *batched_
-000107c0: 6172 6773 2c20 7472 6163 653a 2054 7261  args, trace: Tra
-000107d0: 6365 2c20 2a2a 6b77 6172 6773 293a 0a20  ce, **kwargs):. 
-000107e0: 2020 2061 7267 732c 2069 6e5f 6469 6d73     args, in_dims
-000107f0: 203d 2075 6e7a 6970 3228 6261 7463 6865   = unzip2(batche
-00010800: 645f 6172 6773 290a 2020 2020 6f75 745f  d_args).    out_
-00010810: 6469 6d73 203d 2030 2020 2320 4669 786d  dims = 0  # Fixm
-00010820: 650a 2020 2020 6f75 7473 2c20 6f75 745f  e.    outs, out_
-00010830: 6469 6d73 203d 205f 766d 6170 5f63 616c  dims = _vmap_cal
-00010840: 6c5f 6d65 7461 6675 6e63 2846 616c 7365  l_metafunc(False
-00010850: 2c20 6172 6773 2c20 696e 5f64 696d 732c  , args, in_dims,
-00010860: 206f 7574 5f64 696d 732c 2061 7869 735f   out_dims, axis_
-00010870: 7369 7a65 2c20 6675 6e63 7469 6f6e 5f74  size, function_t
-00010880: 7261 6365 3d74 7261 6365 2c20 2a2a 6b77  race=trace, **kw
-00010890: 6172 6773 290a 2020 2020 6966 2069 7369  args).    if isi
-000108a0: 6e73 7461 6e63 6528 6f75 7473 2c20 5365  nstance(outs, Se
-000108b0: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
-000108c0: 2072 6574 7572 6e20 7361 6665 5f6d 6170   return safe_map
-000108d0: 2870 6169 725f 746f 5f62 6174 6368 6564  (pair_to_batched
-000108e0: 5f76 616c 7565 2c20 7361 6665 5f7a 6970  _value, safe_zip
-000108f0: 286f 7574 732c 206f 7574 5f64 696d 7329  (outs, out_dims)
-00010900: 290a 2020 2020 7265 7475 726e 2042 6174  ).    return Bat
-00010910: 6368 6564 5661 6c75 6528 6f75 7473 2c20  chedValue(outs, 
-00010920: 6f75 745f 6469 6d73 290a 0a0a 766d 6170  out_dims)...vmap
-00010930: 5f69 6d70 6c73 5b54 7261 6e73 666f 726d  _impls[Transform
-00010940: 732e 4964 656e 7469 7479 4f70 5d20 3d20  s.IdentityOp] = 
-00010950: 5f69 6465 6e74 6974 795f 6361 6c6c 5f76  _identity_call_v
-00010960: 6d61 700a 0a0a 6465 6620 5f6a 7670 5f63  map...def _jvp_c
-00010970: 616c 6c5f 766d 6170 2861 7869 735f 7369  all_vmap(axis_si
-00010980: 7a65 2c20 6261 7463 6865 645f 7072 696d  ze, batched_prim
-00010990: 616c 732c 2062 6174 6368 6564 5f74 616e  als, batched_tan
-000109a0: 6765 6e74 732c 202a 2c20 6675 6e63 7469  gents, *, functi
-000109b0: 6f6e 5f74 7261 6365 3a20 5472 6163 652c  on_trace: Trace,
-000109c0: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-000109d0: 7072 696d 616c 732c 2070 7269 6d61 6c73  primals, primals
-000109e0: 5f62 6469 6d73 203d 2073 6166 655f 7a69  _bdims = safe_zi
-000109f0: 7028 2a62 6174 6368 6564 5f70 7269 6d61  p(*batched_prima
-00010a00: 6c73 290a 2020 2020 7461 6e67 656e 7473  ls).    tangents
-00010a10: 2c20 7461 6e67 656e 7473 5f62 6469 6d73  , tangents_bdims
-00010a20: 203d 2073 6166 655f 7a69 7028 2a62 6174   = safe_zip(*bat
-00010a30: 6368 6564 5f74 616e 6765 6e74 7329 0a20  ched_tangents). 
-00010a40: 2020 206a 7670 5f66 756e 6320 3d20 7061     jvp_func = pa
-00010a50: 7274 6961 6c28 5f6a 7670 5f63 616c 6c5f  rtial(_jvp_call_
-00010a60: 6d65 7461 6675 6e63 2c20 4661 6c73 652c  metafunc, False,
-00010a70: 2066 756e 6374 696f 6e5f 7472 6163 653d   function_trace=
-00010a80: 6675 6e63 7469 6f6e 5f74 7261 6365 290a  function_trace).
-00010a90: 2020 2020 766d 6170 7065 645f 6a76 705f      vmapped_jvp_
-00010aa0: 6675 6e63 203d 2076 6d61 7028 6a76 705f  func = vmap(jvp_
-00010ab0: 6675 6e63 2c20 696e 5f64 696d 733d 2870  func, in_dims=(p
-00010ac0: 7269 6d61 6c73 5f62 6469 6d73 2c20 7461  rimals_bdims, ta
-00010ad0: 6e67 656e 7473 5f62 6469 6d73 292c 2061  ngents_bdims), a
-00010ae0: 7869 735f 7369 7a65 3d61 7869 735f 7369  xis_size=axis_si
-00010af0: 7a65 290a 2020 2020 7265 7375 6c74 203d  ze).    result =
-00010b00: 2076 6d61 7070 6564 5f6a 7670 5f66 756e   vmapped_jvp_fun
-00010b10: 6328 7072 696d 616c 732c 2074 616e 6765  c(primals, tange
-00010b20: 6e74 732c 202a 2a6b 7761 7267 7329 0a20  nts, **kwargs). 
-00010b30: 2020 2072 6574 7572 6e20 7472 6565 5f6d     return tree_m
-00010b40: 6170 286c 616d 6264 6120 783a 2042 6174  ap(lambda x: Bat
-00010b50: 6368 6564 5661 6c75 6528 782c 2030 292c  chedValue(x, 0),
-00010b60: 2072 6573 756c 7429 0a0a 0a76 6d61 705f   result)...vmap_
-00010b70: 696d 706c 735b 5472 616e 7366 6f72 6d73  impls[Transforms
-00010b80: 2e4a 7670 4f70 5d20 3d20 5f6a 7670 5f63  .JvpOp] = _jvp_c
-00010b90: 616c 6c5f 766d 6170 0a0a 0a64 6566 2076  all_vmap...def v
-00010ba0: 6d61 7028 6675 6e63 2c20 696e 5f64 696d  map(func, in_dim
-00010bb0: 733d 302c 206f 7574 5f64 696d 733d 302c  s=0, out_dims=0,
-00010bc0: 2061 7869 735f 7369 7a65 3d4e 6f6e 6529   axis_size=None)
-00010bd0: 3a0a 2020 2020 2222 2256 6563 746f 7269  :.    """Vectori
-00010be0: 7a69 6e67 2074 7261 6e73 666f 726d 2066  zing transform f
-00010bf0: 6f72 2061 2054 6875 6e64 6572 2066 756e  or a Thunder fun
-00010c00: 6374 696f 6e2e 0a0a 2020 2020 4172 6773  ction...    Args
-00010c10: 3a0a 2020 2020 2020 2020 6675 6e63 2028  :.        func (
-00010c20: 4361 6c6c 6162 6c65 293a 2041 2054 6875  Callable): A Thu
-00010c30: 6e64 6572 2066 756e 6374 696f 6e20 746f  nder function to
-00010c40: 2062 6520 7472 616e 7366 6f72 6d65 642e   be transformed.
-00010c50: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
-00010c60: 2020 2020 2020 2043 616c 6c61 626c 653a         Callable:
-00010c70: 2041 2076 6d61 7070 6564 2076 6572 7369   A vmapped versi
-00010c80: 6f6e 206f 6620 7468 6520 6675 6e63 7469  on of the functi
-00010c90: 6f6e 2e0a 2020 2020 2222 220a 0a20 2020  on..    """..   
-00010ca0: 2023 2054 4f44 4f3a 2066 6c61 7474 656e   # TODO: flatten
-00010cb0: 0a20 2020 2023 2049 6e20 4a41 5820 666c  .    # In JAX fl
-00010cc0: 6174 7465 6e69 6e67 206f 6620 696e 5f64  attening of in_d
-00010cd0: 696d 7320 6973 2072 6174 6865 7220 636f  ims is rather co
-00010ce0: 6d70 6c69 6361 7465 6420 6265 6361 7573  mplicated becaus
-00010cf0: 6520 6974 2063 616e 206f 7074 696f 6e61  e it can optiona
-00010d00: 6c6c 7920 6265 0a20 2020 2023 2073 7065  lly be.    # spe
-00010d10: 6369 6669 6564 2061 7320 6120 e280 9c70  cified as a ...p
-00010d20: 7265 6669 78e2 809d 2070 7974 7265 652c  refix... pytree,
-00010d30: 206d 6561 6e69 6e67 2074 6861 7420 6120   meaning that a 
-00010d40: 7369 6e67 6c65 206c 6561 6620 7661 6c75  single leaf valu
-00010d50: 6520 6361 6e20 6265 2061 7070 6c69 6564  e can be applied
-00010d60: 0a20 2020 2023 2074 6f20 616e 2065 6e74  .    # to an ent
-00010d70: 6972 6520 7375 622d 7079 7472 6565 2e0a  ire sub-pytree..
-00010d80: 0a20 2020 2064 6566 2066 6c61 7474 656e  .    def flatten
-00010d90: 5f66 756e 635f 666f 725f 766d 6170 2866  _func_for_vmap(f
-00010da0: 756e 632c 2061 7267 732c 206b 7761 7267  unc, args, kwarg
-00010db0: 7329 3a0a 2020 2020 2020 2020 666c 6174  s):.        flat
-00010dc0: 5f61 7267 732c 2073 7065 6320 3d20 7472  _args, spec = tr
-00010dd0: 6565 5f66 6c61 7474 656e 2828 6172 6773  ee_flatten((args
-00010de0: 2c20 6b77 6172 6773 2929 0a0a 2020 2020  , kwargs))..    
-00010df0: 2020 2020 6465 6620 666c 6174 5f66 756e      def flat_fun
-00010e00: 6328 2a66 6c61 745f 6172 6773 293a 0a20  c(*flat_args):. 
-00010e10: 2020 2020 2020 2020 2020 2066 6e5f 6172             fn_ar
-00010e20: 6773 2c20 666e 5f6b 7761 7267 7320 3d20  gs, fn_kwargs = 
-00010e30: 7472 6565 5f75 6e66 6c61 7474 656e 2866  tree_unflatten(f
-00010e40: 6c61 745f 6172 6773 2c20 7370 6563 290a  lat_args, spec).
-00010e50: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00010e60: 726e 2066 756e 6328 2a66 6e5f 6172 6773  rn func(*fn_args
-00010e70: 2c20 2a2a 666e 5f6b 7761 7267 7329 0a0a  , **fn_kwargs)..
-00010e80: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-00010e90: 6c61 745f 6675 6e63 2c20 666c 6174 5f61  lat_func, flat_a
-00010ea0: 7267 732c 2073 7065 630a 0a20 2020 2064  rgs, spec..    d
-00010eb0: 6566 2077 7261 7070 6572 282a 6172 6773  ef wrapper(*args
-00010ec0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-00010ed0: 2020 2020 2066 756e 635f 666c 6174 2c20       func_flat, 
-00010ee0: 6172 6773 5f66 6c61 742c 2061 7267 735f  args_flat, args_
-00010ef0: 7370 6563 203d 2066 6c61 7474 656e 5f66  spec = flatten_f
-00010f00: 756e 635f 666f 725f 766d 6170 2866 756e  unc_for_vmap(fun
-00010f10: 632c 2061 7267 732c 206b 7761 7267 7329  c, args, kwargs)
-00010f20: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-00010f30: 7374 616e 6365 2869 6e5f 6469 6d73 2c20  stance(in_dims, 
-00010f40: 696e 7429 3a0a 2020 2020 2020 2020 2020  int):.          
-00010f50: 2020 696e 5f64 696d 735f 666c 6174 203d    in_dims_flat =
-00010f60: 2028 696e 5f64 696d 732c 2920 2a20 6c65   (in_dims,) * le
-00010f70: 6e28 6172 6773 5f66 6c61 7429 0a20 2020  n(args_flat).   
-00010f80: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00010f90: 2020 2020 2020 2069 6e5f 6469 6d73 5f66         in_dims_f
-00010fa0: 6c61 742c 2069 6e5f 6469 6d73 5f73 7065  lat, in_dims_spe
-00010fb0: 6320 3d20 7472 6565 5f66 6c61 7474 656e  c = tree_flatten
-00010fc0: 2869 6e5f 6469 6d73 290a 2020 2020 2020  (in_dims).      
-00010fd0: 2020 2020 2020 6173 7365 7274 206c 656e        assert len
-00010fe0: 2869 6e5f 6469 6d73 5f66 6c61 7429 203d  (in_dims_flat) =
-00010ff0: 3d20 6c65 6e28 6172 6773 5f66 6c61 7429  = len(args_flat)
-00011000: 2c20 2269 6e5f 6469 6d73 206d 7573 7420  , "in_dims must 
-00011010: 6861 7665 2074 6865 2073 616d 6520 6c65  have the same le
-00011020: 6e67 7468 2061 7320 6172 6773 2c20 6b77  ngth as args, kw
-00011030: 6172 6773 220a 2020 2020 2020 2020 756e  args".        un
-00011040: 6261 7463 6865 645f 6172 6773 5f66 6c61  batched_args_fla
-00011050: 7420 3d20 5b72 656d 6f76 655f 6261 7463  t = [remove_batc
-00011060: 685f 6469 6d28 6172 6729 2069 6620 6973  h_dim(arg) if is
-00011070: 696e 7374 616e 6365 2861 7267 2c20 5465  instance(arg, Te
-00011080: 6e73 6f72 5072 6f78 7929 2065 6c73 6520  nsorProxy) else 
-00011090: 6172 6720 666f 7220 6172 6720 696e 2061  arg for arg in a
-000110a0: 7267 735f 666c 6174 5d0a 2020 2020 2020  rgs_flat].      
-000110b0: 2020 7472 6163 6520 3d20 636f 6e73 7472    trace = constr
-000110c0: 7563 745f 7472 6163 6528 2928 6675 6e63  uct_trace()(func
-000110d0: 5f66 6c61 742c 202a 756e 6261 7463 6865  _flat, *unbatche
-000110e0: 645f 6172 6773 5f66 6c61 7429 0a20 2020  d_args_flat).   
-000110f0: 2020 2020 206f 7574 7320 3d20 766d 6170       outs = vmap
-00011100: 5f63 616c 6c28 6172 6773 5f66 6c61 742c  _call(args_flat,
-00011110: 2069 6e5f 6469 6d73 5f66 6c61 742c 206f   in_dims_flat, o
-00011120: 7574 5f64 696d 732c 2061 7869 735f 7369  ut_dims, axis_si
-00011130: 7a65 3d61 7869 735f 7369 7a65 2c20 6675  ze=axis_size, fu
-00011140: 6e63 7469 6f6e 5f74 7261 6365 3d74 7261  nction_trace=tra
-00011150: 6365 290a 2020 2020 2020 2020 7265 7475  ce).        retu
-00011160: 726e 206f 7574 730a 0a20 2020 2072 6574  rn outs..    ret
-00011170: 7572 6e20 7772 6170 7065 720a 0a0a 2320  urn wrapper...# 
-00011180: 544f 444f 2054 6869 7320 6675 6e63 7469  TODO This functi
-00011190: 6f6e 2063 6f6d 6d65 6e74 6564 206f 7574  on commented out
-000111a0: 2062 6563 6175 7365 2069 7420 6361 6c6c   because it call
-000111b0: 7320 6d61 6b65 5f74 7261 6365 642c 2077  s make_traced, w
-000111c0: 6869 6368 2064 6f65 7320 6e6f 7420 6578  hich does not ex
-000111d0: 6973 740a 2320 6465 6620 766d 6170 5f65  ist.# def vmap_e
-000111e0: 6167 6572 2866 756e 632c 2061 7267 732c  ager(func, args,
-000111f0: 2069 6e5f 6469 6d73 3d30 2c20 6f75 745f   in_dims=0, out_
-00011200: 6469 6d73 3d30 2c20 6178 6973 5f73 697a  dims=0, axis_siz
-00011210: 653d 4e6f 6e65 2c20 6578 6563 7574 6f72  e=None, executor
-00011220: 3d22 746f 7263 6822 293a 0a23 2020 2020  ="torch"):.#    
-00011230: 2022 2222 436f 6d70 7574 6573 2074 6865   """Computes the
-00011240: 2076 6d61 7020 6f66 2061 2054 6875 6e64   vmap of a Thund
-00011250: 6572 2066 756e 6374 696f 6e2e 0a0a 2320  er function...# 
-00011260: 2020 2020 4172 6773 3a0a 2320 2020 2020      Args:.#     
-00011270: 2020 2020 6675 6e63 2028 4361 6c6c 6162      func (Callab
-00011280: 6c65 293a 2041 2054 6875 6e64 6572 2066  le): A Thunder f
-00011290: 756e 6374 696f 6e20 746f 2062 6520 7472  unction to be tr
-000112a0: 616e 7366 6f72 6d65 642e 0a23 2020 2020  ansformed..#    
-000112b0: 2020 2020 2061 7267 7320 285f 7479 7065       args (_type
-000112c0: 5f29 3a20 4172 6773 206f 6620 7468 6520  _): Args of the 
-000112d0: 6675 6e63 7469 6f6e 2e0a 2320 2020 2020  function..#     
-000112e0: 2020 2020 6578 6563 7574 6f72 2028 7374      executor (st
-000112f0: 722c 206f 7074 696f 6e61 6c29 3a20 4578  r, optional): Ex
-00011300: 6563 7574 6f72 2074 6f20 7573 652e 2044  ecutor to use. D
-00011310: 6566 6175 6c74 7320 746f 2022 746f 7263  efaults to "torc
-00011320: 6822 2e0a 0a23 2020 2020 2052 6574 7572  h"...#     Retur
-00011330: 6e73 3a0a 2320 2020 2020 2020 2020 5468  ns:.#         Th
-00011340: 6520 7265 7375 6c74 206f 6620 7468 6520  e result of the 
-00011350: 766d 6170 7065 6420 6675 6e63 7469 6f6e  vmapped function
-00011360: 2e0a 2320 2020 2020 2222 220a 2320 2020  ..#     """.#   
-00011370: 2020 2320 544f 444f 3a20 6669 7820 7468    # TODO: fix th
-00011380: 6973 202d 206e 6f74 2061 6c6c 2061 7267  is - not all arg
-00011390: 7320 6d61 7920 6265 2062 6174 6368 6564  s may be batched
-000113a0: 0a23 2020 2020 2023 2054 4f44 4f3a 2068  .#     # TODO: h
-000113b0: 6572 6520 7765 2061 7373 756d 6520 6261  ere we assume ba
-000113c0: 7463 6820 6178 6973 2069 7320 300a 2320  tch axis is 0.# 
-000113d0: 2020 2020 766d 6170 5f74 7261 6365 203d      vmap_trace =
-000113e0: 206d 616b 655f 7472 6163 6528 0a23 2020   make_trace(.#  
-000113f0: 2020 2020 2020 2076 6d61 7028 6675 6e63         vmap(func
-00011400: 2c20 696e 5f64 696d 733d 696e 5f64 696d  , in_dims=in_dim
-00011410: 732c 206f 7574 5f64 696d 733d 6f75 745f  s, out_dims=out_
-00011420: 6469 6d73 2c20 6178 6973 5f73 697a 653d  dims, axis_size=
-00011430: 6178 6973 5f73 697a 6529 2c20 6578 6563  axis_size), exec
-00011440: 7574 6f72 3d65 7865 6375 746f 722c 0a23  utor=executor,.#
-00011450: 2020 2020 2020 2020 202a 6172 6773 290a           *args).
-00011460: 2320 2020 2020 766d 6170 5f74 7261 6365  #     vmap_trace
-00011470: 6420 3d20 6d61 6b65 5f74 7261 6365 6428  d = make_traced(
-00011480: 7061 7274 6961 6c28 6576 616c 5f74 7261  partial(eval_tra
-00011490: 6365 2c20 766d 6170 5f74 7261 6365 292c  ce, vmap_trace),
-000114a0: 2065 7865 6375 746f 723d 6578 6563 7574   executor=execut
-000114b0: 6f72 290a 2320 2020 2020 7265 7475 726e  or).#     return
-000114c0: 2076 6d61 705f 7472 6163 6564 282a 6172   vmap_traced(*ar
-000114d0: 6773 290a 0a0a 2320 4a56 5020 7472 616e  gs)...# JVP tran
-000114e0: 7366 6f72 6d0a 2320 2d2d 2d2d 2d2d 2d2d  sform.# --------
-000114f0: 2d2d 2d2d 2d0a 0a0a 4064 6174 6163 6c61  -----...@datacla
-00011500: 7373 2866 726f 7a65 6e3d 5472 7565 290a  ss(frozen=True).
-00011510: 636c 6173 7320 4a56 5044 7561 6c3a 0a20  class JVPDual:. 
-00011520: 2020 2022 2222 4475 616c 206e 756d 6265     """Dual numbe
-00011530: 7220 666f 7220 7468 6520 4a56 5020 7472  r for the JVP tr
-00011540: 616e 7366 6f72 6d2e 0a0a 2020 2020 4174  ansform...    At
-00011550: 7472 6962 7574 6573 3a0a 2020 2020 2020  tributes:.      
-00011560: 2020 7072 696d 616c 3a20 5072 696d 616c    primal: Primal
-00011570: 2076 616c 7565 2e0a 2020 2020 2020 2020   value..        
-00011580: 7461 6e67 656e 743a 2054 616e 6765 6e74  tangent: Tangent
-00011590: 2076 616c 7565 2e0a 2020 2020 2222 220a   value..    """.
-000115a0: 0a20 2020 2070 7269 6d61 6c3a 2041 6e79  .    primal: Any
-000115b0: 0a20 2020 2074 616e 6765 6e74 3a20 416e  .    tangent: An
-000115c0: 790a 0a20 2020 2064 6566 205f 5f69 7465  y..    def __ite
-000115d0: 725f 5f28 7365 6c66 293a 0a20 2020 2020  r__(self):.     
-000115e0: 2020 2079 6965 6c64 2073 656c 662e 7072     yield self.pr
-000115f0: 696d 616c 0a20 2020 2020 2020 2079 6965  imal.        yie
-00011600: 6c64 2073 656c 662e 7461 6e67 656e 740a  ld self.tangent.
-00011610: 0a0a 6465 6620 7061 6972 5f74 6f5f 6a76  ..def pair_to_jv
-00011620: 705f 6475 616c 2870 6169 7229 3a0a 2020  p_dual(pair):.  
-00011630: 2020 2222 2243 6f6e 7665 7274 7320 6120    """Converts a 
-00011640: 7061 6972 2074 6f20 6120 4a56 5044 7561  pair to a JVPDua
-00011650: 6c2e 0a0a 2020 2020 4172 6773 3a0a 2020  l...    Args:.  
-00011660: 2020 2020 2020 7061 6972 2028 5365 7175        pair (Sequ
-00011670: 656e 6365 293a 2050 6169 7220 746f 2063  ence): Pair to c
-00011680: 6f6e 7665 7274 2e0a 0a20 2020 2052 6574  onvert...    Ret
-00011690: 7572 6e73 3a0a 2020 2020 2020 2020 4a56  urns:.        JV
-000116a0: 5044 7561 6c3a 204a 5650 4475 616c 2072  PDual: JVPDual r
-000116b0: 6570 7265 7365 6e74 6174 696f 6e20 6f66  epresentation of
-000116c0: 2074 6865 2070 6169 722e 0a20 2020 2022   the pair..    "
-000116d0: 2222 0a20 2020 2069 6620 6973 696e 7374  "".    if isinst
-000116e0: 616e 6365 2870 6169 722c 204a 5650 4475  ance(pair, JVPDu
-000116f0: 616c 293a 0a20 2020 2020 2020 2072 6574  al):.        ret
-00011700: 7572 6e20 7061 6972 0a20 2020 2065 6c73  urn pair.    els
-00011710: 653a 0a20 2020 2020 2020 2061 7373 6572  e:.        asser
-00011720: 7420 6973 696e 7374 616e 6365 2870 6169  t isinstance(pai
-00011730: 722c 2053 6571 7565 6e63 6529 2061 6e64  r, Sequence) and
-00011740: 206c 656e 2870 6169 7229 203d 3d20 320a   len(pair) == 2.
-00011750: 2020 2020 2020 2020 7265 7475 726e 204a          return J
-00011760: 5650 4475 616c 282a 7061 6972 290a 0a0a  VPDual(*pair)...
-00011770: 6465 6620 7369 6e5f 6a76 7028 613a 204a  def sin_jvp(a: J
-00011780: 5650 4475 616c 293a 0a20 2020 2078 2c20  VPDual):.    x, 
-00011790: 7864 203d 2061 0a20 2020 2072 6574 7572  xd = a.    retur
-000117a0: 6e20 4a56 5044 7561 6c28 7072 696d 732e  n JVPDual(prims.
-000117b0: 7369 6e28 7829 2c20 7072 696d 732e 636f  sin(x), prims.co
-000117c0: 7328 7829 202a 2078 6429 0a0a 0a64 6566  s(x) * xd)...def
-000117d0: 206d 756c 5f6a 7670 2861 3a20 4a56 5044   mul_jvp(a: JVPD
-000117e0: 7561 6c2c 2062 3a20 4a56 5044 7561 6c29  ual, b: JVPDual)
-000117f0: 3a0a 2020 2020 782c 2078 6420 3d20 610a  :.    x, xd = a.
-00011800: 2020 2020 792c 2079 6420 3d20 620a 2020      y, yd = b.  
-00011810: 2020 7265 7475 726e 204a 5650 4475 616c    return JVPDual
-00011820: 2878 202a 2079 2c20 7820 2a20 7964 202b  (x * y, x * yd +
-00011830: 2079 202a 2078 6429 0a0a 0a64 6566 2061   y * xd)...def a
-00011840: 6464 5f6a 7670 2861 3a20 4a56 5044 7561  dd_jvp(a: JVPDua
-00011850: 6c2c 2062 3a20 4a56 5044 7561 6c29 3a0a  l, b: JVPDual):.
-00011860: 2020 2020 782c 2078 6420 3d20 610a 2020      x, xd = a.  
-00011870: 2020 792c 2079 6420 3d20 620a 2020 2020    y, yd = b.    
-00011880: 7265 7475 726e 204a 5650 4475 616c 2878  return JVPDual(x
-00011890: 202b 2079 2c20 7864 202b 2079 6429 0a0a   + y, xd + yd)..
-000118a0: 0a64 6566 2062 726f 6164 6361 7374 5f69  .def broadcast_i
-000118b0: 6e5f 6469 6d5f 6a76 7028 613a 204a 5650  n_dim_jvp(a: JVP
-000118c0: 4475 616c 2c20 7368 6170 653a 2074 7570  Dual, shape: tup
-000118d0: 6c65 5b4a 5650 4475 616c 2c20 2e2e 2e5d  le[JVPDual, ...]
-000118e0: 2c20 6272 6f61 6463 6173 745f 6469 6d65  , broadcast_dime
-000118f0: 6e73 696f 6e73 3a20 7475 706c 655b 4a56  nsions: tuple[JV
-00011900: 5044 7561 6c2c 202e 2e2e 5d29 202d 3e20  PDual, ...]) -> 
-00011910: 4a56 5044 7561 6c3a 0a20 2020 2078 2c20  JVPDual:.    x, 
-00011920: 7864 203d 2061 0a20 2020 2023 2054 4f44  xd = a.    # TOD
-00011930: 4f3a 2073 6861 7065 2061 6e64 2062 726f  O: shape and bro
-00011940: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-00011950: 7320 7368 6f75 6c64 2062 6520 7475 706c  s should be tupl
-00011960: 6573 206f 6620 696e 7473 0a20 2020 2023  es of ints.    #
-00011970: 2062 7574 2066 6f72 206e 6f77 2069 7427   but for now it'
-00011980: 7320 6120 7475 706c 6520 6f66 204a 5650  s a tuple of JVP
-00011990: 4475 616c 730a 2020 2020 6966 206c 656e  Duals.    if len
-000119a0: 2873 6861 7065 2920 3e20 3020 616e 6420  (shape) > 0 and 
-000119b0: 6973 696e 7374 616e 6365 2873 6861 7065  isinstance(shape
-000119c0: 5b30 5d2c 204a 5650 4475 616c 293a 0a20  [0], JVPDual):. 
-000119d0: 2020 2020 2020 2073 6861 7065 2c20 5f20         shape, _ 
-000119e0: 3d20 7361 6665 5f7a 6970 282a 7368 6170  = safe_zip(*shap
-000119f0: 6529 0a20 2020 2069 6620 6c65 6e28 6272  e).    if len(br
-00011a00: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
-00011a10: 6e73 2920 3e20 3020 616e 6420 6973 696e  ns) > 0 and isin
-00011a20: 7374 616e 6365 2862 726f 6164 6361 7374  stance(broadcast
-00011a30: 5f64 696d 656e 7369 6f6e 735b 305d 2c20  _dimensions[0], 
-00011a40: 4a56 5044 7561 6c29 3a0a 2020 2020 2020  JVPDual):.      
-00011a50: 2020 6272 6f61 6463 6173 745f 6469 6d65    broadcast_dime
-00011a60: 6e73 696f 6e73 2c20 5f20 3d20 7361 6665  nsions, _ = safe
-00011a70: 5f7a 6970 282a 6272 6f61 6463 6173 745f  _zip(*broadcast_
-00011a80: 6469 6d65 6e73 696f 6e73 290a 2020 2020  dimensions).    
-00011a90: 7265 7475 726e 204a 5650 4475 616c 280a  return JVPDual(.
-00011aa0: 2020 2020 2020 2020 7072 696d 732e 6272          prims.br
-00011ab0: 6f61 6463 6173 745f 696e 5f64 696d 2878  oadcast_in_dim(x
-00011ac0: 2c20 7368 6170 652c 2062 726f 6164 6361  , shape, broadca
-00011ad0: 7374 5f64 696d 656e 7369 6f6e 7329 2c20  st_dimensions), 
-00011ae0: 7072 696d 732e 6272 6f61 6463 6173 745f  prims.broadcast_
-00011af0: 696e 5f64 696d 2878 642c 2073 6861 7065  in_dim(xd, shape
-00011b00: 2c20 6272 6f61 6463 6173 745f 6469 6d65  , broadcast_dime
-00011b10: 6e73 696f 6e73 290a 2020 2020 290a 0a0a  nsions).    )...
-00011b20: 6465 6620 756e 7061 636b 5f73 6571 7565  def unpack_seque
-00011b30: 6e63 655f 6a76 7028 7365 7175 656e 6365  nce_jvp(sequence
-00011b40: 3a20 4a56 5044 7561 6c2c 206c 656e 6774  : JVPDual, lengt
-00011b50: 683a 204a 5650 4475 616c 2920 2d3e 204a  h: JVPDual) -> J
-00011b60: 5650 4475 616c 3a0a 2020 2020 7820 3d20  VPDual:.    x = 
-00011b70: 7472 6565 5f6d 6170 286c 616d 6264 6120  tree_map(lambda 
-00011b80: 783a 2078 2e70 7269 6d61 6c2c 2073 6571  x: x.primal, seq
-00011b90: 7565 6e63 6529 0a20 2020 2078 6420 3d20  uence).    xd = 
-00011ba0: 7472 6565 5f6d 6170 286c 616d 6264 6120  tree_map(lambda 
-00011bb0: 783a 2078 2e74 616e 6765 6e74 2c20 7365  x: x.tangent, se
-00011bc0: 7175 656e 6365 290a 2020 2020 6c65 6e67  quence).    leng
-00011bd0: 7468 2c20 5f20 3d20 6c65 6e67 7468 0a20  th, _ = length. 
-00011be0: 2020 2070 7269 6d61 6c73 203d 2070 7269     primals = pri
-00011bf0: 6d73 2e75 6e70 6163 6b5f 7365 7175 656e  ms.unpack_sequen
-00011c00: 6365 2878 2c20 6c65 6e67 7468 290a 2020  ce(x, length).  
-00011c10: 2020 7461 6e67 656e 7473 203d 2070 7269    tangents = pri
-00011c20: 6d73 2e75 6e70 6163 6b5f 7365 7175 656e  ms.unpack_sequen
-00011c30: 6365 2878 642c 206c 656e 6774 6829 0a20  ce(xd, length). 
-00011c40: 2020 2072 6574 7572 6e20 7361 6665 5f6d     return safe_m
-00011c50: 6170 2870 6169 725f 746f 5f6a 7670 5f64  ap(pair_to_jvp_d
-00011c60: 7561 6c2c 2073 6166 655f 7a69 7028 7072  ual, safe_zip(pr
-00011c70: 696d 616c 732c 2074 616e 6765 6e74 7329  imals, tangents)
-00011c80: 290a 0a0a 6465 6620 756e 7061 636b 5f74  )...def unpack_t
-00011c90: 7269 7669 616c 5f6a 7670 2878 3a20 4a56  rivial_jvp(x: JV
-00011ca0: 5044 7561 6c29 202d 3e20 4a56 5044 7561  PDual) -> JVPDua
-00011cb0: 6c3a 0a20 2020 2072 6574 7572 6e20 780a  l:.    return x.
-00011cc0: 0a0a 6a76 705f 696d 706c 733a 2064 6963  ..jvp_impls: dic
-00011cd0: 745b 7072 696d 732e 5379 6d62 6f6c 2c20  t[prims.Symbol, 
-00011ce0: 4361 6c6c 6162 6c65 5d20 3d20 6469 6374  Callable] = dict
-00011cf0: 2829 0a0a 6a76 705f 696d 706c 735b 7072  ()..jvp_impls[pr
-00011d00: 696d 732e 5072 696d 4944 732e 5349 4e5d  ims.PrimIDs.SIN]
-00011d10: 203d 2073 696e 5f6a 7670 0a6a 7670 5f69   = sin_jvp.jvp_i
-00011d20: 6d70 6c73 5b70 7269 6d73 2e50 7269 6d49  mpls[prims.PrimI
-00011d30: 4473 2e4d 554c 5d20 3d20 6d75 6c5f 6a76  Ds.MUL] = mul_jv
-00011d40: 700a 6a76 705f 696d 706c 735b 7072 696d  p.jvp_impls[prim
-00011d50: 732e 5072 696d 4944 732e 4144 445d 203d  s.PrimIDs.ADD] =
-00011d60: 2061 6464 5f6a 7670 0a6a 7670 5f69 6d70   add_jvp.jvp_imp
-00011d70: 6c73 5b70 7269 6d73 2e50 7269 6d49 4473  ls[prims.PrimIDs
-00011d80: 2e42 524f 4144 4341 5354 5f49 4e5f 4449  .BROADCAST_IN_DI
-00011d90: 4d5d 203d 2062 726f 6164 6361 7374 5f69  M] = broadcast_i
-00011da0: 6e5f 6469 6d5f 6a76 700a 2320 6a76 705f  n_dim_jvp.# jvp_
-00011db0: 696d 706c 735b 7072 696d 732e 5072 696d  impls[prims.Prim
-00011dc0: 4944 732e 554e 5041 434b 5f53 4551 5545  IDs.UNPACK_SEQUE
-00011dd0: 4e43 455d 203d 2075 6e70 6163 6b5f 7365  NCE] = unpack_se
-00011de0: 7175 656e 6365 5f6a 7670 0a23 206a 7670  quence_jvp.# jvp
-00011df0: 5f69 6d70 6c73 5b70 7269 6d73 2e50 7269  _impls[prims.Pri
-00011e00: 6d49 4473 2e55 4e50 4143 4b5f 5452 4956  mIDs.UNPACK_TRIV
-00011e10: 4941 4c5d 203d 2075 6e70 6163 6b5f 7472  IAL] = unpack_tr
-00011e20: 6976 6961 6c5f 6a76 700a 0a0a 6465 6620  ivial_jvp...def 
-00011e30: 6a76 705f 7379 6d62 6f6c 5f6d 6170 7065  jvp_symbol_mappe
-00011e40: 7228 7379 6d62 6f6c 3a20 7072 696d 732e  r(symbol: prims.
-00011e50: 5379 6d62 6f6c 293a 0a20 2020 2022 2222  Symbol):.    """
-00011e60: 4d61 7073 2061 2073 796d 626f 6c20 746f  Maps a symbol to
-00011e70: 2061 204a 5650 2066 756e 6374 696f 6e20   a JVP function 
-00011e80: 7468 6174 2065 7661 6c75 6174 6573 2069  that evaluates i
-00011e90: 742e 0a0a 2020 2020 4172 6773 3a0a 2020  t...    Args:.  
-00011ea0: 2020 2020 2020 7379 6d62 6f6c 2028 7072        symbol (pr
-00011eb0: 696d 732e 5379 6d62 6f6c 293a 2053 796d  ims.Symbol): Sym
-00011ec0: 626f 6c20 746f 2065 7661 6c75 6174 652e  bol to evaluate.
-00011ed0: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
-00011ee0: 2020 2020 2020 4e6f 7449 6d70 6c65 6d65        NotImpleme
-00011ef0: 6e74 6564 4572 726f 723a 2049 6620 7468  ntedError: If th
-00011f00: 6520 4a56 5020 666f 7220 7468 6520 7379  e JVP for the sy
-00011f10: 6d62 6f6c 2069 7320 6e6f 7420 696d 706c  mbol is not impl
-00011f20: 656d 656e 7465 642e 0a0a 2020 2020 5265  emented...    Re
-00011f30: 7475 726e 733a 0a20 2020 2020 2020 2043  turns:.        C
-00011f40: 616c 6c61 626c 653a 204a 5650 2066 756e  allable: JVP fun
-00011f50: 6374 696f 6e20 7468 6174 2065 7661 6c75  ction that evalu
-00011f60: 6174 6573 2074 6865 2073 796d 626f 6c2e  ates the symbol.
-00011f70: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
-00011f80: 6620 7772 6170 5f61 7267 2878 293a 0a20  f wrap_arg(x):. 
-00011f90: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-00011fa0: 616e 6365 2878 2c20 4a56 5044 7561 6c29  ance(x, JVPDual)
-00011fb0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00011fc0: 7475 726e 2078 0a20 2020 2020 2020 2065  turn x.        e
-00011fd0: 6c69 6620 6973 696e 7374 616e 6365 2878  lif isinstance(x
-00011fe0: 2c20 4e75 6d62 6572 293a 0a20 2020 2020  , Number):.     
-00011ff0: 2020 2020 2020 2072 6574 7572 6e20 4a56         return JV
-00012000: 5044 7561 6c28 782c 2074 7970 6528 7829  PDual(x, type(x)
-00012010: 2830 2929 0a20 2020 2020 2020 2065 6c73  (0)).        els
-00012020: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00012030: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00012040: 6622 4a56 5020 7772 6170 5f61 7267 2067  f"JVP wrap_arg g
-00012050: 6f74 2061 6e20 756e 7375 7070 6f72 7465  ot an unsupporte
-00012060: 6420 7479 7065 207b 7479 7065 2878 297d  d type {type(x)}
-00012070: 2229 0a0a 2020 2020 2320 4966 2073 796d  ")..    # If sym
-00012080: 626f 6c2e 6172 6773 2064 6f65 736e 2774  bol.args doesn't
-00012090: 2068 6176 6520 7375 6263 6c61 7373 6573   have subclasses
-000120a0: 206f 6620 5661 7269 6162 6c65 2c20 7468   of Variable, th
-000120b0: 656e 2077 6520 6e65 6564 2074 6f20 7265  en we need to re
-000120c0: 7475 726e 2061 207a 6572 6f20 7461 6e67  turn a zero tang
-000120d0: 656e 740a 2020 2020 2320 544f 444f 3a20  ent.    # TODO: 
-000120e0: 7468 6572 6520 6d61 7920 6265 2061 2062  there may be a b
-000120f0: 6574 7465 7220 7761 7920 746f 2064 6574  etter way to det
-00012100: 6563 7420 636f 6e73 7461 6e74 7320 696e  ect constants in
-00012110: 2074 6865 2074 7261 6365 0a20 2020 2069   the trace.    i
-00012120: 6620 7379 6d62 6f6c 2e61 7265 5f61 6c6c  f symbol.are_all
-00012130: 5f61 7267 735f 636f 6e73 7461 6e74 3a0a  _args_constant:.
-00012140: 0a20 2020 2020 2020 2064 6566 207a 6572  .        def zer
-00012150: 6f73 5f6c 696b 6528 7829 3a0a 2020 2020  os_like(x):.    
-00012160: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00012170: 7461 6e63 6528 782c 2054 656e 736f 7250  tance(x, TensorP
-00012180: 726f 7879 293a 0a20 2020 2020 2020 2020  roxy):.         
-00012190: 2020 2020 2020 2072 6574 7572 6e20 6675         return fu
-000121a0: 6c6c 5f6c 696b 6528 782c 2066 696c 6c5f  ll_like(x, fill_
-000121b0: 7661 6c75 653d 3029 0a20 2020 2020 2020  value=0).       
-000121c0: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-000121d0: 616e 6365 2878 2c20 4e75 6d62 6572 5072  ance(x, NumberPr
-000121e0: 6f78 7929 3a0a 2020 2020 2020 2020 2020  oxy):.          
-000121f0: 2020 2020 2020 7265 7475 726e 2074 7970        return typ
-00012200: 6528 782e 7661 6c75 6529 2830 290a 2020  e(x.value)(0).  
-00012210: 2020 2020 2020 2020 2020 656c 6966 2069            elif i
-00012220: 7369 6e73 7461 6e63 6528 782c 204e 756d  sinstance(x, Num
-00012230: 6265 7229 3a0a 2020 2020 2020 2020 2020  ber):.          
-00012240: 2020 2020 2020 7265 7475 726e 2074 7970        return typ
-00012250: 6528 7829 2830 290a 2020 2020 2020 2020  e(x)(0).        
-00012260: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00012270: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00012280: 5661 6c75 6545 7272 6f72 2866 227a 6572  ValueError(f"zer
-00012290: 6f73 5f6c 696b 6520 696e 7369 6465 204a  os_like inside J
-000122a0: 5650 2067 6f74 2061 6e20 756e 7375 7070  VP got an unsupp
-000122b0: 6f72 7465 6420 7479 7065 207b 7479 7065  orted type {type
-000122c0: 2878 297d 2229 0a0a 2020 2020 2020 2020  (x)}")..        
-000122d0: 6465 6620 6a76 705f 696d 706c 5f63 6f6e  def jvp_impl_con
-000122e0: 7374 2873 796d 626f 6c2c 202a 6172 6773  st(symbol, *args
-000122f0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-00012300: 2020 2020 2020 2020 2070 7269 6d61 6c73           primals
-00012310: 203d 2073 796d 626f 6c5f 746f 5f65 7661   = symbol_to_eva
-00012320: 6c28 7379 6d62 6f6c 2928 2a61 7267 732c  l(symbol)(*args,
-00012330: 202a 2a6b 7761 7267 7329 0a20 2020 2020   **kwargs).     
-00012340: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-00012350: 616e 6365 2870 7269 6d61 6c73 2c20 5365  ance(primals, Se
-00012360: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
-00012370: 2020 2020 2020 2020 2074 616e 6765 6e74           tangent
-00012380: 7320 3d20 7475 706c 6528 7a65 726f 735f  s = tuple(zeros_
-00012390: 6c69 6b65 2870 2920 666f 7220 7020 696e  like(p) for p in
-000123a0: 2070 7269 6d61 6c73 290a 2020 2020 2020   primals).      
-000123b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000123c0: 2073 6166 655f 6d61 7028 7061 6972 5f74   safe_map(pair_t
-000123d0: 6f5f 6a76 705f 6475 616c 2c20 7361 6665  o_jvp_dual, safe
-000123e0: 5f7a 6970 2870 7269 6d61 6c73 2c20 7461  _zip(primals, ta
-000123f0: 6e67 656e 7473 2929 0a20 2020 2020 2020  ngents)).       
-00012400: 2020 2020 2072 6574 7572 6e20 4a56 5044       return JVPD
-00012410: 7561 6c28 7072 696d 616c 732c 207a 6572  ual(primals, zer
-00012420: 6f73 5f6c 696b 6528 7072 696d 616c 7329  os_like(primals)
-00012430: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00012440: 6e20 7061 7274 6961 6c28 6a76 705f 696d  n partial(jvp_im
-00012450: 706c 5f63 6f6e 7374 2c20 7379 6d62 6f6c  pl_const, symbol
-00012460: 290a 0a20 2020 2023 204e 6f72 6d61 6c20  )..    # Normal 
-00012470: 6361 7365 2c20 7765 2068 6176 6520 6120  case, we have a 
-00012480: 7072 6f78 7920 7461 6e67 656e 740a 2020  proxy tangent.  
-00012490: 2020 6a76 705f 696d 706c 203d 206a 7670    jvp_impl = jvp
-000124a0: 5f69 6d70 6c73 2e67 6574 2873 796d 626f  _impls.get(symbo
-000124b0: 6c2e 7379 6d2e 6964 290a 2020 2020 6966  l.sym.id).    if
-000124c0: 206a 7670 5f69 6d70 6c20 6973 204e 6f6e   jvp_impl is Non
-000124d0: 653a 0a20 2020 2020 2020 2072 6169 7365  e:.        raise
-000124e0: 204e 6f74 496d 706c 656d 656e 7465 6445   NotImplementedE
-000124f0: 7272 6f72 2866 224a 5650 2066 6f72 207b  rror(f"JVP for {
-00012500: 7379 6d62 6f6c 2e73 796d 2e69 647d 2069  symbol.sym.id} i
-00012510: 7320 6e6f 7420 696d 706c 656d 656e 7465  s not implemente
-00012520: 6422 290a 0a20 2020 2064 6566 205f 6a76  d")..    def _jv
-00012530: 705f 696d 706c 282a 6172 6773 2c20 2a2a  p_impl(*args, **
-00012540: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-00012550: 2061 7267 7320 3d20 7472 6565 5f6d 6170   args = tree_map
-00012560: 2877 7261 705f 6172 672c 2061 7267 7329  (wrap_arg, args)
-00012570: 0a20 2020 2020 2020 2023 2045 7870 6563  .        # Expec
-00012580: 7469 6e67 204a 5650 4475 616c 7320 7772  ting JVPDuals wr
-00012590: 6170 7069 6e67 2070 6169 7273 206f 6620  apping pairs of 
-000125a0: 7072 696d 616c 7320 616e 6420 7461 6e67  primals and tang
-000125b0: 656e 7473 0a20 2020 2020 2020 2061 7373  ents.        ass
-000125c0: 6572 7420 616c 6c28 6973 696e 7374 616e  ert all(isinstan
-000125d0: 6365 2861 7267 2c20 4a56 5044 7561 6c29  ce(arg, JVPDual)
-000125e0: 2066 6f72 2061 7267 2069 6e20 7472 6565   for arg in tree
-000125f0: 5f66 6c61 7474 656e 2861 7267 7329 5b30  _flatten(args)[0
-00012600: 5d29 0a20 2020 2020 2020 2072 6574 7572  ]).        retur
-00012610: 6e20 6a76 705f 696d 706c 282a 6172 6773  n jvp_impl(*args
-00012620: 2c20 2a2a 6b77 6172 6773 290a 0a20 2020  , **kwargs)..   
-00012630: 2072 6574 7572 6e20 5f6a 7670 5f69 6d70   return _jvp_imp
-00012640: 6c0a 0a0a 6465 6620 5f6a 7670 5f63 616c  l...def _jvp_cal
-00012650: 6c5f 6d65 7461 6675 6e63 2864 6574 6163  l_metafunc(detac
-00012660: 6865 643a 2062 6f6f 6c2c 2070 7269 6d61  hed: bool, prima
-00012670: 6c73 2c20 7461 6e67 656e 7473 2c20 2a2c  ls, tangents, *,
-00012680: 2066 756e 6374 696f 6e5f 7472 6163 653a   function_trace:
-00012690: 2054 7261 6365 2c20 2a2a 6b77 6172 6773   Trace, **kwargs
-000126a0: 293a 0a20 2020 2022 2222 4d65 7461 6675  ):.    """Metafu
-000126b0: 6e63 7469 6f6e 2066 6f72 2074 6865 204a  nction for the J
-000126c0: 5650 2074 7261 6e73 666f 726d 2e0a 0a20  VP transform... 
-000126d0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-000126e0: 2064 6574 6163 6865 6420 2862 6f6f 6c29   detached (bool)
-000126f0: 3a20 5768 6574 6865 7220 746f 2064 6574  : Whether to det
-00012700: 6163 6820 7468 6520 7472 6163 652e 0a20  ach the trace.. 
-00012710: 2020 2020 2020 2070 7269 6d61 6c73 2028         primals (
-00012720: 5475 706c 655b 5072 6f78 795d 293a 2050  Tuple[Proxy]): P
-00012730: 7269 6d61 6c20 7661 6c75 6573 2e0a 2020  rimal values..  
-00012740: 2020 2020 2020 7461 6e67 656e 7473 2028        tangents (
-00012750: 5475 706c 655b 5072 6f78 795d 293a 2054  Tuple[Proxy]): T
-00012760: 616e 6765 6e74 2076 616c 7565 732e 0a20  angent values.. 
-00012770: 2020 2020 2020 2066 756e 6374 696f 6e5f         function_
-00012780: 7472 6163 6520 2854 7261 6365 293a 2054  trace (Trace): T
-00012790: 7261 6365 206f 6620 7468 6520 6675 6e63  race of the func
-000127a0: 7469 6f6e 2074 6f20 6265 2074 7261 6e73  tion to be trans
-000127b0: 666f 726d 6564 2e0a 2020 2020 2020 2020  formed..        
-000127c0: 6b77 6172 6773 3a20 4b65 7977 6f72 6420  kwargs: Keyword 
-000127d0: 6172 6775 6d65 6e74 732e 0a0a 2020 2020  arguments...    
-000127e0: 5261 6973 6573 3a0a 2020 2020 2020 2020  Raises:.        
-000127f0: 4173 7365 7274 696f 6e45 7272 6f72 3a20  AssertionError: 
-00012800: 4966 2074 6865 204a 5650 2066 6f72 206b  If the JVP for k
-00012810: 6579 776f 7264 2061 7267 756d 656e 7473  eyword arguments
-00012820: 2069 7320 6e6f 7420 696d 706c 656d 656e   is not implemen
-00012830: 7465 642e 0a0a 2020 2020 5265 7475 726e  ted...    Return
-00012840: 733a 0a20 2020 2020 2020 2052 6573 756c  s:.        Resul
-00012850: 7420 6f66 2074 6865 204a 5650 2074 7261  t of the JVP tra
-00012860: 6e73 666f 726d 2e0a 2020 2020 2222 220a  nsform..    """.
-00012870: 2020 2020 6173 7365 7274 206c 656e 286b      assert len(k
-00012880: 7761 7267 7329 203d 3d20 302c 2022 4a56  wargs) == 0, "JV
-00012890: 5020 666f 7220 6b77 6172 6773 2069 7320  P for kwargs is 
-000128a0: 6e6f 7420 696d 706c 656d 656e 7465 6422  not implemented"
-000128b0: 0a0a 2020 2020 6374 7820 3d20 6465 7461  ..    ctx = deta
-000128c0: 6368 6564 5f74 7261 6365 2829 2069 6620  ched_trace() if 
-000128d0: 6465 7461 6368 6564 2065 6c73 6520 6e75  detached else nu
-000128e0: 6c6c 636f 6e74 6578 7428 290a 2020 2020  llcontext().    
-000128f0: 7769 7468 2063 7478 3a0a 2020 2020 2020  with ctx:.      
-00012900: 2020 2320 5772 6170 7069 6e67 2074 6865    # Wrapping the
-00012910: 2070 7269 6d61 6c73 2061 6e64 2074 616e   primals and tan
-00012920: 6765 6e74 7320 696e 204a 5650 4475 616c  gents in JVPDual
-00012930: 7320 6973 206e 6f74 2073 7472 6963 746c  s is not strictl
-00012940: 7920 6e65 6365 7373 6172 792c 2062 7574  y necessary, but
-00012950: 2069 7420 6d61 6b65 730a 2020 2020 2020   it makes.      
-00012960: 2020 2320 7468 6520 636f 6465 206d 6f72    # the code mor
-00012970: 6520 7265 6164 6162 6c65 0a20 2020 2020  e readable.     
-00012980: 2020 2023 2057 6520 7072 6f70 6167 6174     # We propagat
-00012990: 6520 7468 6520 4a56 5044 7561 6c73 2074  e the JVPDuals t
-000129a0: 6872 6f75 6768 2074 6865 2074 7261 6365  hrough the trace
-000129b0: 2c20 616e 6420 7468 656e 2075 6e77 7261  , and then unwra
-000129c0: 7020 7468 656d 2061 7420 7468 6520 656e  p them at the en
-000129d0: 640a 2020 2020 2020 2020 7072 696d 616c  d.        primal
-000129e0: 735f 7461 6e67 656e 7473 5f64 7561 6c73  s_tangents_duals
-000129f0: 203d 2073 6166 655f 6d61 7028 7061 6972   = safe_map(pair
-00012a00: 5f74 6f5f 6a76 705f 6475 616c 2c20 7361  _to_jvp_dual, sa
-00012a10: 6665 5f7a 6970 2870 7269 6d61 6c73 2c20  fe_zip(primals, 
-00012a20: 7461 6e67 656e 7473 2929 0a20 2020 2020  tangents)).     
-00012a30: 2020 2072 6573 756c 7420 3d20 6576 616c     result = eval
-00012a40: 5f74 7261 6365 2866 756e 6374 696f 6e5f  _trace(function_
-00012a50: 7472 6163 652c 202a 7072 696d 616c 735f  trace, *primals_
-00012a60: 7461 6e67 656e 7473 5f64 7561 6c73 2c20  tangents_duals, 
-00012a70: 7379 6d62 6f6c 5f6d 6170 7065 723d 6a76  symbol_mapper=jv
-00012a80: 705f 7379 6d62 6f6c 5f6d 6170 7065 7229  p_symbol_mapper)
-00012a90: 0a20 2020 2020 2020 2023 2055 6e77 7261  .        # Unwra
-00012aa0: 7070 696e 6720 7468 6520 4a56 5044 7561  pping the JVPDua
-00012ab0: 6c73 0a20 2020 2020 2020 2069 6620 6973  ls.        if is
-00012ac0: 696e 7374 616e 6365 2872 6573 756c 742c  instance(result,
-00012ad0: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
-00012ae0: 2020 2020 2020 2020 6173 7365 7274 2061          assert a
-00012af0: 6c6c 2869 7369 6e73 7461 6e63 6528 782c  ll(isinstance(x,
-00012b00: 204a 5650 4475 616c 2920 666f 7220 7820   JVPDual) for x 
-00012b10: 696e 2072 6573 756c 7429 0a20 2020 2020  in result).     
-00012b20: 2020 2020 2020 2070 7269 6d61 6c73 2c20         primals, 
-00012b30: 7461 6e67 656e 7473 203d 2075 6e7a 6970  tangents = unzip
-00012b40: 3228 7265 7375 6c74 290a 2020 2020 2020  2(result).      
-00012b50: 2020 2020 2020 7265 7475 726e 2070 7269        return pri
-00012b60: 6d61 6c73 2c20 7461 6e67 656e 7473 0a20  mals, tangents. 
-00012b70: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-00012b80: 696e 7374 616e 6365 2872 6573 756c 742c  instance(result,
-00012b90: 204a 5650 4475 616c 290a 2020 2020 2020   JVPDual).      
-00012ba0: 2020 7265 7475 726e 2072 6573 756c 742e    return result.
-00012bb0: 7072 696d 616c 2c20 7265 7375 6c74 2e74  primal, result.t
-00012bc0: 616e 6765 6e74 0a0a 0a6a 7670 5f63 616c  angent...jvp_cal
-00012bd0: 6c20 3d20 5379 6d62 6f6c 2869 643d 5472  l = Symbol(id=Tr
-00012be0: 616e 7366 6f72 6d73 2e4a 7670 4f70 2c20  ansforms.JvpOp, 
-00012bf0: 6e61 6d65 3d22 6a76 705f 6361 6c6c 222c  name="jvp_call",
-00012c00: 206d 6574 613d 7061 7274 6961 6c28 5f6a   meta=partial(_j
-00012c10: 7670 5f63 616c 6c5f 6d65 7461 6675 6e63  vp_call_metafunc
-00012c20: 2c20 4661 6c73 6529 290a 0a0a 6465 6620  , False))...def 
-00012c30: 5f69 6465 6e74 6974 795f 6361 6c6c 5f6a  _identity_call_j
-00012c40: 7670 282a 6172 6773 3a20 4a56 5044 7561  vp(*args: JVPDua
-00012c50: 6c2c 2074 7261 6365 3a20 5472 6163 652c  l, trace: Trace,
-00012c60: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-00012c70: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
-00012c80: 7320 3d20 756e 7a69 7032 2861 7267 7329  s = unzip2(args)
-00012c90: 0a20 2020 206f 7574 5f70 7269 6d61 6c73  .    out_primals
-00012ca0: 2c20 6f75 745f 7461 6e67 656e 7473 203d  , out_tangents =
-00012cb0: 205f 6a76 705f 6361 6c6c 5f6d 6574 6166   _jvp_call_metaf
-00012cc0: 756e 6328 4661 6c73 652c 2070 7269 6d61  unc(False, prima
-00012cd0: 6c73 2c20 7461 6e67 656e 7473 2c20 7472  ls, tangents, tr
-00012ce0: 6163 652c 202a 2a6b 7761 7267 7329 0a20  ace, **kwargs). 
-00012cf0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00012d00: 286f 7574 5f70 7269 6d61 6c73 2c20 5365  (out_primals, Se
-00012d10: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
-00012d20: 2072 6574 7572 6e20 7361 6665 5f6d 6170   return safe_map
-00012d30: 2870 6169 725f 746f 5f6a 7670 5f64 7561  (pair_to_jvp_dua
-00012d40: 6c2c 2073 6166 655f 7a69 7028 6f75 745f  l, safe_zip(out_
-00012d50: 7072 696d 616c 732c 206f 7574 5f74 616e  primals, out_tan
-00012d60: 6765 6e74 7329 290a 2020 2020 7265 7475  gents)).    retu
-00012d70: 726e 204a 5650 4475 616c 286f 7574 5f70  rn JVPDual(out_p
-00012d80: 7269 6d61 6c73 2c20 6f75 745f 7461 6e67  rimals, out_tang
-00012d90: 656e 7473 290a 0a0a 6a76 705f 696d 706c  ents)...jvp_impl
-00012da0: 735b 5472 616e 7366 6f72 6d73 2e49 6465  s[Transforms.Ide
-00012db0: 6e74 6974 794f 705d 203d 205f 6964 656e  ntityOp] = _iden
-00012dc0: 7469 7479 5f63 616c 6c5f 6a76 700a 0a0a  tity_call_jvp...
-00012dd0: 6465 6620 5f76 6d61 705f 6361 6c6c 5f6a  def _vmap_call_j
-00012de0: 7670 2861 7267 733a 204a 5650 4475 616c  vp(args: JVPDual
-00012df0: 2c20 696e 5f64 696d 732c 206f 7574 5f64  , in_dims, out_d
-00012e00: 696d 732c 2061 7869 735f 7369 7a65 2c20  ims, axis_size, 
-00012e10: 7472 6163 653a 2054 7261 6365 2c20 2a2a  trace: Trace, **
-00012e20: 6b77 6172 6773 293a 0a20 2020 2070 7269  kwargs):.    pri
-00012e30: 6d61 6c73 2c20 7461 6e67 656e 7473 203d  mals, tangents =
-00012e40: 2073 6166 655f 7a69 7028 2a61 7267 7329   safe_zip(*args)
-00012e50: 0a20 2020 2069 6e5f 6469 6d73 2c20 5f20  .    in_dims, _ 
-00012e60: 3d20 7361 6665 5f7a 6970 282a 696e 5f64  = safe_zip(*in_d
-00012e70: 696d 7329 0a20 2020 206f 7574 5f64 696d  ims).    out_dim
-00012e80: 732c 205f 203d 2073 6166 655f 7a69 7028  s, _ = safe_zip(
-00012e90: 2a6f 7574 5f64 696d 7329 0a20 2020 2076  *out_dims).    v
-00012ea0: 6d61 7070 6564 5f74 7261 6365 203d 2063  mapped_trace = c
-00012eb0: 6f6e 7374 7275 6374 5f74 7261 6365 2829  onstruct_trace()
-00012ec0: 280a 2020 2020 2020 2020 766d 6170 2870  (.        vmap(p
-00012ed0: 6172 7469 616c 2865 7661 6c5f 7472 6163  artial(eval_trac
-00012ee0: 652c 2074 7261 6365 292c 2069 6e5f 6469  e, trace), in_di
-00012ef0: 6d73 3d69 6e5f 6469 6d73 2c20 6f75 745f  ms=in_dims, out_
-00012f00: 6469 6d73 3d6f 7574 5f64 696d 732c 2061  dims=out_dims, a
-00012f10: 7869 735f 7369 7a65 3d61 7869 735f 7369  xis_size=axis_si
-00012f20: 7a65 292c 202a 7072 696d 616c 730a 2020  ze), *primals.  
-00012f30: 2020 290a 2020 2020 766d 6170 7065 645f    ).    vmapped_
-00012f40: 6675 6e63 203d 2070 6172 7469 616c 2865  func = partial(e
-00012f50: 7661 6c5f 7472 6163 652c 2076 6d61 7070  val_trace, vmapp
-00012f60: 6564 5f74 7261 6365 290a 2020 2020 6f75  ed_trace).    ou
-00012f70: 745f 7072 696d 616c 732c 206f 7574 5f74  t_primals, out_t
-00012f80: 616e 6765 6e74 7320 3d20 6a76 7028 766d  angents = jvp(vm
-00012f90: 6170 7065 645f 6675 6e63 2928 7072 696d  apped_func)(prim
-00012fa0: 616c 732c 2074 616e 6765 6e74 732c 202a  als, tangents, *
-00012fb0: 2a6b 7761 7267 7329 0a20 2020 2069 6620  *kwargs).    if 
-00012fc0: 6973 696e 7374 616e 6365 286f 7574 5f70  isinstance(out_p
-00012fd0: 7269 6d61 6c73 2c20 5365 7175 656e 6365  rimals, Sequence
-00012fe0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00012ff0: 6e20 7361 6665 5f6d 6170 2870 6169 725f  n safe_map(pair_
-00013000: 746f 5f6a 7670 5f64 7561 6c2c 2073 6166  to_jvp_dual, saf
-00013010: 655f 7a69 7028 6f75 745f 7072 696d 616c  e_zip(out_primal
-00013020: 732c 206f 7574 5f74 616e 6765 6e74 7329  s, out_tangents)
-00013030: 290a 2020 2020 7265 7475 726e 204a 5650  ).    return JVP
-00013040: 4475 616c 286f 7574 5f70 7269 6d61 6c73  Dual(out_primals
-00013050: 2c20 6f75 745f 7461 6e67 656e 7473 290a  , out_tangents).
-00013060: 0a0a 6a76 705f 696d 706c 735b 5472 616e  ..jvp_impls[Tran
-00013070: 7366 6f72 6d73 2e56 6d61 704f 705d 203d  sforms.VmapOp] =
-00013080: 205f 766d 6170 5f63 616c 6c5f 6a76 700a   _vmap_call_jvp.
-00013090: 0a0a 6465 6620 6a76 7028 6675 6e63 293a  ..def jvp(func):
-000130a0: 0a20 2020 2022 2222 4a61 636f 6269 616e  .    """Jacobian
-000130b0: 2d76 6563 746f 7220 7072 6f64 7563 7420  -vector product 
-000130c0: 7472 616e 7366 6f72 6d20 666f 7220 6120  transform for a 
-000130d0: 5468 756e 6465 7220 6675 6e63 7469 6f6e  Thunder function
-000130e0: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
-000130f0: 2020 2020 2066 756e 6320 2843 616c 6c61       func (Calla
-00013100: 626c 6529 3a20 4120 5468 756e 6465 7220  ble): A Thunder 
-00013110: 6675 6e63 7469 6f6e 2074 6f20 6265 2074  function to be t
-00013120: 7261 6e73 666f 726d 6564 2e0a 0a20 2020  ransformed...   
-00013130: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-00013140: 2020 4361 6c6c 6162 6c65 3a20 4120 6675    Callable: A fu
-00013150: 6e63 7469 6f6e 2074 6861 7420 636f 6d70  nction that comp
-00013160: 7574 6573 2074 6865 204a 6163 6f62 6961  utes the Jacobia
-00013170: 6e2d 7665 6374 6f72 2070 726f 6475 6374  n-vector product
-00013180: 0a20 2020 2020 2020 2020 2020 2074 616b  .            tak
-00013190: 696e 6720 7072 696d 616c 7320 616e 6420  ing primals and 
-000131a0: 7461 6e67 656e 7473 2061 7320 6172 6775  tangents as argu
-000131b0: 6d65 6e74 732e 0a20 2020 2022 2222 0a0a  ments..    """..
-000131c0: 2020 2020 6465 6620 7772 6170 7065 7228      def wrapper(
-000131d0: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
-000131e0: 7329 3a0a 2020 2020 2020 2020 7472 6163  s):.        trac
-000131f0: 6520 3d20 636f 6e73 7472 7563 745f 7472  e = construct_tr
-00013200: 6163 6528 2928 6675 6e63 2c20 2a70 7269  ace()(func, *pri
-00013210: 6d61 6c73 290a 2020 2020 2020 2020 7265  mals).        re
-00013220: 7475 726e 206a 7670 5f63 616c 6c28 7072  turn jvp_call(pr
-00013230: 696d 616c 732c 2074 616e 6765 6e74 732c  imals, tangents,
-00013240: 2066 756e 6374 696f 6e5f 7472 6163 653d   function_trace=
-00013250: 7472 6163 6529 0a0a 2020 2020 7265 7475  trace)..    retu
-00013260: 726e 2077 7261 7070 6572 0a0a 0a23 2054  rn wrapper...# T
-00013270: 4f44 4f20 5468 6973 2066 756e 6374 696f  ODO This functio
-00013280: 6e20 636f 6d6d 656e 7465 6420 6f75 7420  n commented out 
-00013290: 6265 6361 7573 6520 6974 2063 616c 6c73  because it calls
-000132a0: 206d 616b 655f 7472 6163 6564 2c20 7768   make_traced, wh
-000132b0: 6963 6820 646f 6573 206e 6f74 2065 7869  ich does not exi
-000132c0: 7374 0a23 2064 6566 206a 7670 5f65 6167  st.# def jvp_eag
-000132d0: 6572 2866 756e 632c 2070 7269 6d61 6c73  er(func, primals
-000132e0: 2c20 7461 6e67 656e 7473 2c20 6578 6563  , tangents, exec
-000132f0: 7574 6f72 3d22 746f 7263 6822 293a 0a23  utor="torch"):.#
-00013300: 2020 2020 2022 2222 436f 6d70 7574 6573       """Computes
-00013310: 2074 6865 204a 6163 6f62 6961 6e2d 7665   the Jacobian-ve
-00013320: 6374 6f72 2070 726f 6475 6374 206f 6620  ctor product of 
-00013330: 6120 5468 756e 6465 7220 6675 6e63 7469  a Thunder functi
-00013340: 6f6e 2e0a 0a23 2020 2020 2041 7267 733a  on...#     Args:
-00013350: 0a23 2020 2020 2020 2020 2066 756e 6320  .#         func 
-00013360: 2843 616c 6c61 626c 6529 3a20 4120 5468  (Callable): A Th
-00013370: 756e 6465 7220 6675 6e63 7469 6f6e 2074  under function t
-00013380: 6f20 6265 2074 7261 6e73 666f 726d 6564  o be transformed
-00013390: 2e0a 2320 2020 2020 2020 2020 7072 696d  ..#         prim
-000133a0: 616c 7320 285f 7479 7065 5f29 3a20 5072  als (_type_): Pr
-000133b0: 696d 616c 7320 6f66 2074 6865 2066 756e  imals of the fun
-000133c0: 6374 696f 6e2e 0a23 2020 2020 2020 2020  ction..#        
-000133d0: 2074 616e 6765 6e74 7320 285f 7479 7065   tangents (_type
-000133e0: 5f29 3a20 5461 6e67 656e 7473 206f 6620  _): Tangents of 
-000133f0: 7468 6520 6675 6e63 7469 6f6e 2e0a 2320  the function..# 
-00013400: 2020 2020 2020 2020 6578 6563 7574 6f72          executor
-00013410: 2028 7374 722c 206f 7074 696f 6e61 6c29   (str, optional)
-00013420: 3a20 4578 6563 7574 6f72 2074 6f20 7573  : Executor to us
-00013430: 652e 2044 6566 6175 6c74 7320 746f 2022  e. Defaults to "
-00013440: 746f 7263 6822 2e0a 0a23 2020 2020 2052  torch"...#     R
-00013450: 6574 7572 6e73 3a0a 2320 2020 2020 2020  eturns:.#       
-00013460: 2020 5468 6520 7265 7375 6c74 206f 6620    The result of 
-00013470: 7468 6520 4a61 636f 6269 616e 2d76 6563  the Jacobian-vec
-00013480: 746f 7220 7072 6f64 7563 742e 0a23 2020  tor product..#  
-00013490: 2020 2022 2222 0a23 2020 2020 2074 7261     """.#     tra
-000134a0: 6365 203d 206d 616b 655f 7472 6163 6528  ce = make_trace(
-000134b0: 6675 6e63 2c20 6578 6563 7574 6f72 3d65  func, executor=e
-000134c0: 7865 6375 746f 722c 202a 7072 696d 616c  xecutor, *primal
-000134d0: 7329 0a0a 2320 2020 2020 6465 6620 6a76  s)..#     def jv
-000134e0: 705f 6675 6e63 282a 7072 696d 616c 735f  p_func(*primals_
-000134f0: 616e 645f 7461 6e67 656e 7473 293a 0a23  and_tangents):.#
-00013500: 2020 2020 2020 2020 205f 7072 696d 616c           _primal
-00013510: 732c 205f 7461 6e67 656e 7473 203d 2070  s, _tangents = p
-00013520: 7269 6d61 6c73 5f61 6e64 5f74 616e 6765  rimals_and_tange
-00013530: 6e74 735b 3a20 6c65 6e28 7072 696d 616c  nts[: len(primal
-00013540: 7329 5d2c 2070 7269 6d61 6c73 5f61 6e64  s)], primals_and
-00013550: 5f74 616e 6765 6e74 735b 6c65 6e28 7072  _tangents[len(pr
-00013560: 696d 616c 7329 203a 5d0a 2320 2020 2020  imals) :].#     
-00013570: 2020 2020 7265 7475 726e 205f 6a76 705f      return _jvp_
-00013580: 6361 6c6c 5f6d 6574 6166 756e 6328 5f70  call_metafunc(_p
-00013590: 7269 6d61 6c73 2c20 5f74 616e 6765 6e74  rimals, _tangent
-000135a0: 732c 2074 7261 6365 2c20 6465 7461 6368  s, trace, detach
-000135b0: 6564 3d46 616c 7365 290a 0a23 2020 2020  ed=False)..#    
-000135c0: 206a 7670 5f74 7261 6365 203d 206d 616b   jvp_trace = mak
-000135d0: 655f 7472 6163 6528 6a76 705f 6675 6e63  e_trace(jvp_func
-000135e0: 2c20 6578 6563 7574 6f72 3d65 7865 6375  , executor=execu
-000135f0: 746f 7229 282a 7072 696d 616c 732c 202a  tor)(*primals, *
-00013600: 7461 6e67 656e 7473 290a 2320 2020 2020  tangents).#     
-00013610: 6a76 705f 7472 6163 6564 203d 206d 616b  jvp_traced = mak
-00013620: 655f 7472 6163 6564 2870 6172 7469 616c  e_traced(partial
-00013630: 2865 7661 6c5f 7472 6163 652c 206a 7670  (eval_trace, jvp
-00013640: 5f74 7261 6365 292c 2065 7865 6375 746f  _trace), executo
-00013650: 723d 6578 6563 7574 6f72 290a 2320 2020  r=executor).#   
-00013660: 2020 7265 7475 726e 206a 7670 5f74 7261    return jvp_tra
-00013670: 6365 6428 2a70 7269 6d61 6c73 2c20 2a74  ced(*primals, *t
-00013680: 616e 6765 6e74 7329 0a0a 0a23 2056 4a50  angents)...# VJP
-00013690: 2074 7261 6e73 666f 726d 0a23 203d 3d3d   transform.# ===
-000136a0: 3d3d 3d3d 3d3d 3d3d 3d3d 0a40 6461 7461  ==========.@data
-000136b0: 636c 6173 7328 6672 6f7a 656e 3d54 7275  class(frozen=Tru
-000136c0: 6529 0a63 6c61 7373 2056 4a50 4475 616c  e).class VJPDual
-000136d0: 3a0a 2020 2020 2222 2241 2070 6169 7220  :.    """A pair 
-000136e0: 6f66 2070 7269 6d61 6c20 616e 6420 7361  of primal and sa
-000136f0: 7665 6420 696e 666f 726d 6174 696f 6e20  ved information 
-00013700: 666f 7220 6261 636b 7761 7264 2028 7265  for backward (re
-00013710: 7369 6475 616c 7329 2e0a 0a20 2020 2041  siduals)...    A
-00013720: 7267 733a 0a20 2020 2020 2020 2070 7269  rgs:.        pri
-00013730: 6d61 6c20 2855 6e69 6f6e 5b50 726f 7879  mal (Union[Proxy
-00013740: 2c20 4e75 6d62 6572 5d29 3a20 5072 696d  , Number]): Prim
-00013750: 616c 2076 616c 7565 2c20 692e 652e 2c20  al value, i.e., 
-00013760: 7468 6520 7661 6c75 6520 6265 696e 6720  the value being 
-00013770: 6469 6666 6572 656e 7469 6174 6564 2e0a  differentiated..
-00013780: 2020 2020 2020 2020 7265 7369 6475 616c          residual
-00013790: 7320 2854 7570 6c65 5b50 726f 7879 2c20  s (Tuple[Proxy, 
-000137a0: 2e2e 2e5d 293a 2052 6573 6964 7561 6c73  ...]): Residuals
-000137b0: 2c20 692e 652e 2c20 7468 6520 7661 6c75  , i.e., the valu
-000137c0: 6573 2074 6861 7420 6172 650a 2020 2020  es that are.    
-000137d0: 2020 2020 2020 2020 7361 7665 6420 666f          saved fo
-000137e0: 7220 7468 6520 6261 636b 7761 7264 2e0a  r the backward..
-000137f0: 0a20 2020 2059 6965 6c64 733a 0a20 2020  .    Yields:.   
-00013800: 2020 2020 2054 7570 6c65 5b56 6172 6961       Tuple[Varia
-00013810: 626c 652c 2054 7570 6c65 5b56 6172 6961  ble, Tuple[Varia
-00013820: 626c 652c 202e 2e2e 5d2c 2043 616c 6c61  ble, ...], Calla
-00013830: 626c 655d 3a20 5072 696d 616c 2061 6e64  ble]: Primal and
-00013840: 2072 6573 6964 7561 6c73 0a20 2020 2022   residuals.    "
-00013850: 2222 0a0a 2020 2020 7072 696d 616c 3a20  ""..    primal: 
-00013860: 5072 6f78 7920 7c20 4e75 6d62 6572 0a20  Proxy | Number. 
-00013870: 2020 2072 6573 6964 7561 6c73 3a20 7475     residuals: tu
-00013880: 706c 655b 5072 6f78 792c 202e 2e2e 5d0a  ple[Proxy, ...].
-00013890: 0a20 2020 2064 6566 205f 5f69 7465 725f  .    def __iter_
-000138a0: 5f28 7365 6c66 293a 0a20 2020 2020 2020  _(self):.       
-000138b0: 2079 6965 6c64 2073 656c 662e 7072 696d   yield self.prim
-000138c0: 616c 0a20 2020 2020 2020 2079 6965 6c64  al.        yield
-000138d0: 2073 656c 662e 7265 7369 6475 616c 730a   self.residuals.
-000138e0: 0a0a 636c 6173 7320 4e6f 5075 6c6c 6261  ..class NoPullba
-000138f0: 636b 3a0a 2020 2020 2222 2241 2064 756d  ck:.    """A dum
-00013900: 6d79 2070 756c 6c62 6163 6b20 6675 6e63  my pullback func
-00013910: 7469 6f6e 2074 6861 7420 7265 7475 726e  tion that return
-00013920: 7320 4e6f 6e65 206f 7220 7261 6973 6573  s None or raises
-00013930: 2061 6e20 6572 726f 722e 2222 220a 0a20   an error.""".. 
-00013940: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00013950: 7365 6c66 2c20 6e75 6d5f 6172 6773 3d30  self, num_args=0
-00013960: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00013970: 6e75 6d5f 6172 6773 203d 206e 756d 5f61  num_args = num_a
-00013980: 7267 730a 0a20 2020 2064 6566 205f 5f63  rgs..    def __c
-00013990: 616c 6c5f 5f28 7365 6c66 2c20 2a61 7267  all__(self, *arg
-000139a0: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
-000139b0: 2020 2020 2020 6966 2073 656c 662e 6e75        if self.nu
-000139c0: 6d5f 6172 6773 203e 2030 3a0a 2020 2020  m_args > 0:.    
-000139d0: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-000139e0: 4e6f 6e65 2c29 202a 2073 656c 662e 6e75  None,) * self.nu
-000139f0: 6d5f 6172 6773 0a20 2020 2020 2020 2072  m_args.        r
-00013a00: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
-00013a10: 7228 2250 756c 6c62 6163 6b20 6361 6c6c  r("Pullback call
-00013a20: 6564 206f 6e20 6120 6e6f 6e2d 6469 6666  ed on a non-diff
-00013a30: 6572 656e 7469 6162 6c65 2073 796d 626f  erentiable symbo
-00013a40: 6c20 6f72 2061 2063 6f6e 7374 616e 742e  l or a constant.
-00013a50: 2229 0a0a 0a63 6c61 7373 205a 6572 6f42  ")...class ZeroB
-00013a60: 6163 6b77 6172 643a 0a20 2020 2022 2222  ackward:.    """
-00013a70: 4120 6865 6c70 6572 2062 6163 6b77 6172  A helper backwar
-00013a80: 6420 6675 6e63 7469 6f6e 2074 6861 7420  d function that 
-00013a90: 7265 7475 726e 7320 7a65 726f 732e 2222  returns zeros.""
-00013aa0: 220a 0a20 2020 2064 6566 205f 5f69 6e69  "..    def __ini
-00013ab0: 745f 5f28 7365 6c66 2c20 6e75 6d5f 6172  t__(self, num_ar
-00013ac0: 6773 293a 0a20 2020 2020 2020 2073 656c  gs):.        sel
-00013ad0: 662e 6e75 6d5f 6172 6773 203d 206e 756d  f.num_args = num
-00013ae0: 5f61 7267 730a 0a20 2020 2064 6566 205f  _args..    def _
-00013af0: 5f63 616c 6c5f 5f28 7365 6c66 2c20 2a61  _call__(self, *a
-00013b00: 7267 732c 202a 2a6b 7761 7267 7329 3a0a  rgs, **kwargs):.
-00013b10: 2020 2020 2020 2020 2320 4173 7375 6d69          # Assumi
-00013b20: 6e67 2074 6861 7420 7468 6520 6669 7273  ng that the firs
-00013b30: 7420 6172 6775 6d65 6e74 7320 6172 6520  t arguments are 
-00013b40: 7468 6520 666f 7277 6172 6420 6172 6775  the forward argu
-00013b50: 6d65 6e74 730a 2020 2020 2020 2020 666f  ments.        fo
-00013b60: 7277 6172 645f 6172 6773 203d 2061 7267  rward_args = arg
-00013b70: 735b 3a20 7365 6c66 2e6e 756d 5f61 7267  s[: self.num_arg
-00013b80: 735d 0a0a 2020 2020 2020 2020 6465 6620  s]..        def 
-00013b90: 7a65 726f 735f 6c69 6b65 2878 293a 0a20  zeros_like(x):. 
-00013ba0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-00013bb0: 696e 7374 616e 6365 2878 2c20 5465 6e73  instance(x, Tens
-00013bc0: 6f72 5072 6f78 7929 3a0a 2020 2020 2020  orProxy):.      
-00013bd0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00013be0: 2066 756c 6c5f 6c69 6b65 2878 2c20 6669   full_like(x, fi
-00013bf0: 6c6c 5f76 616c 7565 3d30 290a 2020 2020  ll_value=0).    
-00013c00: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-00013c10: 6e73 7461 6e63 6528 782c 204e 756d 6265  nstance(x, Numbe
-00013c20: 7250 726f 7879 293a 0a20 2020 2020 2020  rProxy):.       
-00013c30: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00013c40: 7479 7065 2878 2e76 616c 7565 2928 3029  type(x.value)(0)
-00013c50: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00013c60: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
-00013c70: 4e75 6d62 6572 293a 0a20 2020 2020 2020  Number):.       
-00013c80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00013c90: 7479 7065 2878 2928 3029 0a20 2020 2020  type(x)(0).     
-00013ca0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00013cb0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00013cc0: 7365 2056 616c 7565 4572 726f 7228 6622  se ValueError(f"
-00013cd0: 7a65 726f 735f 6c69 6b65 2069 6e73 6964  zeros_like insid
-00013ce0: 6520 5a65 726f 4261 636b 7761 7264 2067  e ZeroBackward g
-00013cf0: 6f74 2061 6e20 756e 7375 7070 6f72 7465  ot an unsupporte
-00013d00: 6420 7479 7065 207b 7479 7065 2878 297d  d type {type(x)}
-00013d10: 2229 0a0a 2020 2020 2020 2020 7265 7475  ")..        retu
-00013d20: 726e 2074 7570 6c65 287a 6572 6f73 5f6c  rn tuple(zeros_l
-00013d30: 696b 6528 6172 6729 2066 6f72 2061 7267  ike(arg) for arg
-00013d40: 2069 6e20 666f 7277 6172 645f 6172 6773   in forward_args
-00013d50: 290a 0a0a 2320 4d61 7070 696e 6720 6672  )...# Mapping fr
-00013d60: 6f6d 2073 796d 626f 6c73 2074 6f20 6175  om symbols to au
-00013d70: 676d 656e 7465 6420 7072 696d 616c 2028  gmented primal (
-00013d80: 666f 7277 6172 6429 2066 756e 6374 696f  forward) functio
-00013d90: 6e73 2075 7365 6420 696e 2056 4a50 0a23  ns used in VJP.#
-00013da0: 2054 6865 2061 7567 6d65 6e74 6564 5f70   The augmented_p
-00013db0: 7269 6d61 6c20 6675 6e63 7469 6f6e 2074  rimal function t
-00013dc0: 616b 6573 2074 6865 2070 7269 6d61 6c20  akes the primal 
-00013dd0: 7661 6c75 6573 2061 6e64 2072 6574 7572  values and retur
-00013de0: 6e73 2074 6865 2070 7269 6d61 6c0a 2320  ns the primal.# 
-00013df0: 7265 7375 6c74 2061 6e64 2074 6865 2072  result and the r
-00013e00: 6573 6964 7561 6c73 2028 7361 7665 6420  esiduals (saved 
-00013e10: 7661 6c75 6573 2066 6f72 2074 6865 2062  values for the b
-00013e20: 6163 6b77 6172 6429 2e0a 6175 676d 656e  ackward)..augmen
-00013e30: 7465 645f 666f 7277 6172 645f 696d 706c  ted_forward_impl
-00013e40: 7320 3d20 7b0a 2020 2020 7072 696d 732e  s = {.    prims.
-00013e50: 5072 696d 4944 732e 4143 4f53 3a20 6c61  PrimIDs.ACOS: la
-00013e60: 6d62 6461 2078 3a20 2870 7269 6d73 2e61  mbda x: (prims.a
-00013e70: 636f 7328 7829 2c20 2878 2c29 292c 0a20  cos(x), (x,)),. 
-00013e80: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00013e90: 2e41 434f 5348 3a20 6c61 6d62 6461 2078  .ACOSH: lambda x
-00013ea0: 3a20 2870 7269 6d73 2e61 636f 7368 2878  : (prims.acosh(x
-00013eb0: 292c 2028 782c 2929 2c0a 2020 2020 7072  ), (x,)),.    pr
-00013ec0: 696d 732e 5072 696d 4944 732e 4153 494e  ims.PrimIDs.ASIN
-00013ed0: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
-00013ee0: 6d73 2e61 7369 6e28 7829 2c20 2878 2c29  ms.asin(x), (x,)
-00013ef0: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
-00013f00: 6d49 4473 2e41 5349 4e48 3a20 6c61 6d62  mIDs.ASINH: lamb
-00013f10: 6461 2078 3a20 2870 7269 6d73 2e61 7369  da x: (prims.asi
-00013f20: 6e68 2878 292c 2028 782c 2929 2c0a 2020  nh(x), (x,)),.  
-00013f30: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00013f40: 4154 414e 3a20 6c61 6d62 6461 2078 3a20  ATAN: lambda x: 
-00013f50: 2870 7269 6d73 2e61 7461 6e28 7829 2c20  (prims.atan(x), 
-00013f60: 2878 2c29 292c 0a20 2020 2070 7269 6d73  (x,)),.    prims
-00013f70: 2e50 7269 6d49 4473 2e41 5441 4e48 3a20  .PrimIDs.ATANH: 
-00013f80: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
-00013f90: 2e61 7461 6e68 2878 292c 2028 782c 2929  .atanh(x), (x,))
-00013fa0: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00013fb0: 4944 732e 4154 414e 323a 206c 616d 6264  IDs.ATAN2: lambd
-00013fc0: 6120 782c 2079 3a20 2870 7269 6d73 2e61  a x, y: (prims.a
-00013fd0: 7461 6e32 2878 2c20 7929 2c20 2878 2c20  tan2(x, y), (x, 
-00013fe0: 7929 292c 0a20 2020 2070 7269 6d73 2e50  y)),.    prims.P
-00013ff0: 7269 6d49 4473 2e43 4f53 483a 206c 616d  rimIDs.COSH: lam
-00014000: 6264 6120 783a 2028 7072 696d 732e 636f  bda x: (prims.co
-00014010: 7368 2878 292c 2028 782c 2929 2c0a 2020  sh(x), (x,)),.  
-00014020: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00014030: 4449 4741 4d4d 413a 206c 616d 6264 6120  DIGAMMA: lambda 
-00014040: 783a 2028 7072 696d 732e 6469 6761 6d6d  x: (prims.digamm
-00014050: 6128 7829 2c20 2878 2c29 292c 0a20 2020  a(x), (x,)),.   
-00014060: 2070 7269 6d73 2e50 7269 6d49 4473 2e45   prims.PrimIDs.E
-00014070: 5246 433a 206c 616d 6264 6120 783a 2028  RFC: lambda x: (
-00014080: 7072 696d 732e 6572 6663 2878 292c 2028  prims.erfc(x), (
-00014090: 782c 2929 2c0a 2020 2020 7072 696d 732e  x,)),.    prims.
-000140a0: 5072 696d 4944 732e 4552 4649 4e56 3a20  PrimIDs.ERFINV: 
-000140b0: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
-000140c0: 2e65 7266 696e 7628 7829 2c20 2870 7269  .erfinv(x), (pri
-000140d0: 6d73 2e65 7266 696e 7628 7829 2c29 292c  ms.erfinv(x),)),
-000140e0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-000140f0: 4473 2e45 5246 4349 4e56 3a20 6c61 6d62  Ds.ERFCINV: lamb
-00014100: 6461 2078 3a20 2870 7269 6d73 2e65 7266  da x: (prims.erf
-00014110: 6369 6e76 2878 292c 2028 7072 696d 732e  cinv(x), (prims.
-00014120: 6572 6663 696e 7628 7829 2c29 292c 0a20  erfcinv(x),)),. 
-00014130: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014140: 2e45 5850 323a 206c 616d 6264 6120 783a  .EXP2: lambda x:
-00014150: 2028 7072 696d 732e 6578 7032 2878 292c   (prims.exp2(x),
-00014160: 2028 7072 696d 732e 6578 7032 2878 292c   (prims.exp2(x),
-00014170: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
-00014180: 696d 4944 732e 4558 504d 313a 206c 616d  imIDs.EXPM1: lam
-00014190: 6264 6120 783a 2028 7072 696d 732e 6578  bda x: (prims.ex
-000141a0: 706d 3128 7829 2c20 2870 7269 6d73 2e65  pm1(x), (prims.e
-000141b0: 7870 6d31 2878 292c 2929 2c0a 2020 2020  xpm1(x),)),.    
-000141c0: 7072 696d 732e 5072 696d 4944 732e 4c47  prims.PrimIDs.LG
-000141d0: 414d 4d41 3a20 6c61 6d62 6461 2078 3a20  AMMA: lambda x: 
-000141e0: 2870 7269 6d73 2e6c 6761 6d6d 6128 7829  (prims.lgamma(x)
-000141f0: 2c20 2878 2c29 292c 0a20 2020 2070 7269  , (x,)),.    pri
-00014200: 6d73 2e50 7269 6d49 4473 2e4e 4454 5249  ms.PrimIDs.NDTRI
-00014210: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
-00014220: 6d73 2e6e 6474 7269 2878 292c 2028 7072  ms.ndtri(x), (pr
-00014230: 696d 732e 6e64 7472 6928 7829 2c29 292c  ims.ndtri(x),)),
-00014240: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-00014250: 4473 2e53 494e 483a 206c 616d 6264 6120  Ds.SINH: lambda 
-00014260: 783a 2028 7072 696d 732e 7369 6e68 2878  x: (prims.sinh(x
-00014270: 292c 2028 782c 2929 2c0a 2020 2020 7072  ), (x,)),.    pr
-00014280: 696d 732e 5072 696d 4944 732e 5351 5254  ims.PrimIDs.SQRT
-00014290: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
-000142a0: 6d73 2e73 7172 7428 7829 2c20 2870 7269  ms.sqrt(x), (pri
-000142b0: 6d73 2e73 7172 7428 7829 2c29 292c 0a20  ms.sqrt(x),)),. 
-000142c0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-000142d0: 2e4e 453a 206c 616d 6264 6120 782c 2079  .NE: lambda x, y
-000142e0: 3a20 2870 7269 6d73 2e6e 6528 782c 2079  : (prims.ne(x, y
-000142f0: 292c 2028 782c 2079 2929 2c0a 2020 2020  ), (x, y)),.    
-00014300: 7072 696d 732e 5072 696d 4944 732e 4754  prims.PrimIDs.GT
-00014310: 3a20 6c61 6d62 6461 2078 2c20 793a 2028  : lambda x, y: (
-00014320: 7072 696d 732e 6774 2878 2c20 7929 2c20  prims.gt(x, y), 
-00014330: 2878 2c20 7929 292c 0a20 2020 2070 7269  (x, y)),.    pri
-00014340: 6d73 2e50 7269 6d49 4473 2e4c 453a 206c  ms.PrimIDs.LE: l
-00014350: 616d 6264 6120 782c 2079 3a20 2870 7269  ambda x, y: (pri
-00014360: 6d73 2e6c 6528 782c 2079 292c 2028 782c  ms.le(x, y), (x,
-00014370: 2079 2929 2c0a 2020 2020 7072 696d 732e   y)),.    prims.
-00014380: 5072 696d 4944 732e 4c4f 4731 303a 206c  PrimIDs.LOG10: l
-00014390: 616d 6264 6120 783a 2028 7072 696d 732e  ambda x: (prims.
-000143a0: 6c6f 6731 3028 7829 2c20 2878 2c29 292c  log10(x), (x,)),
-000143b0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-000143c0: 4473 2e4c 4f47 3150 3a20 6c61 6d62 6461  Ds.LOG1P: lambda
-000143d0: 2078 3a20 2870 7269 6d73 2e6c 6f67 3170   x: (prims.log1p
-000143e0: 2878 292c 2028 782c 2929 2c0a 2020 2020  (x), (x,)),.    
-000143f0: 7072 696d 732e 5072 696d 4944 732e 4c4f  prims.PrimIDs.LO
-00014400: 4732 3a20 6c61 6d62 6461 2078 3a20 2870  G2: lambda x: (p
-00014410: 7269 6d73 2e6c 6f67 3228 7829 2c20 2878  rims.log2(x), (x
-00014420: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
-00014430: 7269 6d49 4473 2e5a 4554 413a 206c 616d  rimIDs.ZETA: lam
-00014440: 6264 6120 782c 2079 3a20 2870 7269 6d73  bda x, y: (prims
-00014450: 2e7a 6574 6128 782c 2079 292c 2028 782c  .zeta(x, y), (x,
-00014460: 2079 2929 2c0a 2020 2020 7072 696d 732e   y)),.    prims.
-00014470: 5072 696d 4944 732e 464d 4f44 3a20 6c61  PrimIDs.FMOD: la
-00014480: 6d62 6461 2078 2c20 793a 2028 7072 696d  mbda x, y: (prim
-00014490: 732e 666d 6f64 2878 2c20 7929 2c20 2878  s.fmod(x, y), (x
-000144a0: 2c20 7929 292c 0a7d 0a0a 0a23 204d 6170  , y)),.}...# Map
-000144b0: 7069 6e67 2066 726f 6d20 7379 6d62 6f6c  ping from symbol
-000144c0: 7320 746f 2062 6163 6b77 6172 6420 6675  s to backward fu
-000144d0: 6e63 7469 6f6e 7320 7573 6564 2069 6e20  nctions used in 
-000144e0: 564a 500a 2320 5468 6520 6261 636b 7761  VJP.# The backwa
-000144f0: 7264 2066 756e 6374 696f 6e20 7461 6b65  rd function take
-00014500: 7320 7468 6520 7265 7369 6475 616c 7320  s the residuals 
-00014510: 616e 6420 636f 7461 6e67 656e 7473 2061  and cotangents a
-00014520: 6e64 2072 6574 7572 6e73 2074 6865 0a23  nd returns the.#
-00014530: 2076 6563 746f 722d 4a61 636f 6269 616e   vector-Jacobian
-00014540: 2070 726f 6475 6374 7320 666f 7220 6561   products for ea
-00014550: 6368 2061 7267 756d 656e 742e 0a62 6163  ch argument..bac
-00014560: 6b77 6172 645f 696d 706c 7320 3d20 7b0a  kward_impls = {.
-00014570: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00014580: 732e 4143 4f53 3a20 6c61 6d62 6461 2078  s.ACOS: lambda x
-00014590: 2c20 673a 202d 6720 2f20 7072 696d 732e  , g: -g / prims.
-000145a0: 7371 7274 2831 2e30 202d 2078 202a 2078  sqrt(1.0 - x * x
-000145b0: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
-000145c0: 6d49 4473 2e41 434f 5348 3a20 6c61 6d62  mIDs.ACOSH: lamb
-000145d0: 6461 2078 2c20 673a 2067 202a 2070 7269  da x, g: g * pri
-000145e0: 6d73 2e72 7371 7274 2878 202a 2078 202d  ms.rsqrt(x * x -
-000145f0: 2031 2e30 292c 0a20 2020 2070 7269 6d73   1.0),.    prims
-00014600: 2e50 7269 6d49 4473 2e41 5349 4e3a 206c  .PrimIDs.ASIN: l
-00014610: 616d 6264 6120 782c 2067 3a20 6720 2f20  ambda x, g: g / 
-00014620: 7072 696d 732e 7371 7274 2831 2e30 202d  prims.sqrt(1.0 -
-00014630: 2078 202a 2078 292c 0a20 2020 2070 7269   x * x),.    pri
-00014640: 6d73 2e50 7269 6d49 4473 2e41 5349 4e48  ms.PrimIDs.ASINH
-00014650: 3a20 6c61 6d62 6461 2078 2c20 673a 2067  : lambda x, g: g
-00014660: 202a 2070 7269 6d73 2e72 7371 7274 2831   * prims.rsqrt(1
-00014670: 2e30 202b 2078 202a 2078 292c 0a20 2020  .0 + x * x),.   
-00014680: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
-00014690: 5441 4e3a 206c 616d 6264 6120 782c 2067  TAN: lambda x, g
-000146a0: 3a20 6720 2f20 2831 2e30 202b 2078 202a  : g / (1.0 + x *
-000146b0: 2078 292c 0a20 2020 2070 7269 6d73 2e50   x),.    prims.P
-000146c0: 7269 6d49 4473 2e41 5441 4e48 3a20 6c61  rimIDs.ATANH: la
-000146d0: 6d62 6461 2078 2c20 673a 2067 202f 2028  mbda x, g: g / (
-000146e0: 312e 3020 2d20 7820 2a20 7829 2c0a 2020  1.0 - x * x),.  
-000146f0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00014700: 434f 5348 3a20 6c61 6d62 6461 2078 2c20  COSH: lambda x, 
-00014710: 673a 2070 7269 6d73 2e6d 756c 2867 2c20  g: prims.mul(g, 
-00014720: 7072 696d 732e 7369 6e68 2878 2929 2c0a  prims.sinh(x)),.
-00014730: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00014740: 732e 4552 4643 3a20 6c61 6d62 6461 2078  s.ERFC: lambda x
-00014750: 2c20 673a 202d 6720 2a20 322e 3020 2f20  , g: -g * 2.0 / 
-00014760: 6d61 7468 2e73 7172 7428 6d61 7468 2e70  math.sqrt(math.p
-00014770: 6929 202a 2070 7269 6d73 2e65 7870 282d  i) * prims.exp(-
-00014780: 7820 2a20 7829 2c0a 2020 2020 7072 696d  x * x),.    prim
-00014790: 732e 5072 696d 4944 732e 4552 4649 4e56  s.PrimIDs.ERFINV
-000147a0: 3a20 6c61 6d62 6461 2072 6573 756c 742c  : lambda result,
-000147b0: 2067 3a20 6720 2a20 302e 3520 2a20 6d61   g: g * 0.5 * ma
-000147c0: 7468 2e73 7172 7428 6d61 7468 2e70 6929  th.sqrt(math.pi)
-000147d0: 202a 2070 7269 6d73 2e65 7870 2872 6573   * prims.exp(res
-000147e0: 756c 742a 2a32 292c 0a20 2020 2070 7269  ult**2),.    pri
-000147f0: 6d73 2e50 7269 6d49 4473 2e45 5246 4349  ms.PrimIDs.ERFCI
-00014800: 4e56 3a20 6c61 6d62 6461 2072 6573 756c  NV: lambda resul
-00014810: 742c 2067 3a20 2d67 202a 2030 2e35 202a  t, g: -g * 0.5 *
-00014820: 206d 6174 682e 7371 7274 286d 6174 682e   math.sqrt(math.
-00014830: 7069 2920 2a20 7072 696d 732e 6578 7028  pi) * prims.exp(
-00014840: 7265 7375 6c74 2a2a 3229 2c0a 2020 2020  result**2),.    
-00014850: 7072 696d 732e 5072 696d 4944 732e 4558  prims.PrimIDs.EX
-00014860: 5032 3a20 6c61 6d62 6461 2072 6573 756c  P2: lambda resul
-00014870: 742c 2067 3a20 6720 2a20 7265 7375 6c74  t, g: g * result
-00014880: 202a 206d 6174 682e 6c6f 6728 322e 3029   * math.log(2.0)
-00014890: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-000148a0: 4944 732e 4558 504d 313a 206c 616d 6264  IDs.EXPM1: lambd
-000148b0: 6120 7265 7375 6c74 2c20 673a 2067 202a  a result, g: g *
-000148c0: 2028 7265 7375 6c74 202b 2031 2e30 292c   (result + 1.0),
-000148d0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-000148e0: 4473 2e4c 4741 4d4d 413a 206c 616d 6264  Ds.LGAMMA: lambd
-000148f0: 6120 782c 2067 3a20 6720 2a20 7072 696d  a x, g: g * prim
-00014900: 732e 6469 6761 6d6d 6128 7829 2c0a 2020  s.digamma(x),.  
-00014910: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00014920: 4e44 5452 493a 206c 616d 6264 6120 7265  NDTRI: lambda re
-00014930: 7375 6c74 2c20 673a 2067 202a 2070 7269  sult, g: g * pri
-00014940: 6d73 2e65 7870 2830 2e35 202a 2072 6573  ms.exp(0.5 * res
-00014950: 756c 742a 2a32 2920 2a20 6d61 7468 2e73  ult**2) * math.s
-00014960: 7172 7428 322e 3020 2a20 6d61 7468 2e70  qrt(2.0 * math.p
-00014970: 6929 2c0a 2020 2020 7072 696d 732e 5072  i),.    prims.Pr
-00014980: 696d 4944 732e 5349 4e48 3a20 6c61 6d62  imIDs.SINH: lamb
-00014990: 6461 2078 2c20 673a 2070 7269 6d73 2e6d  da x, g: prims.m
-000149a0: 756c 2867 2c20 7072 696d 732e 636f 7368  ul(g, prims.cosh
-000149b0: 2878 2929 2c0a 2020 2020 7072 696d 732e  (x)),.    prims.
-000149c0: 5072 696d 4944 732e 5351 5254 3a20 6c61  PrimIDs.SQRT: la
-000149d0: 6d62 6461 2072 6573 756c 742c 2067 3a20  mbda result, g: 
-000149e0: 6720 2f20 2832 2e30 202a 2072 6573 756c  g / (2.0 * resul
-000149f0: 7429 2c0a 2020 2020 7072 696d 732e 5072  t),.    prims.Pr
-00014a00: 696d 4944 732e 4e45 3a20 5a65 726f 4261  imIDs.NE: ZeroBa
-00014a10: 636b 7761 7264 286e 756d 5f61 7267 733d  ckward(num_args=
-00014a20: 3229 2c0a 2020 2020 7072 696d 732e 5072  2),.    prims.Pr
-00014a30: 696d 4944 732e 4754 3a20 5a65 726f 4261  imIDs.GT: ZeroBa
-00014a40: 636b 7761 7264 286e 756d 5f61 7267 733d  ckward(num_args=
-00014a50: 3229 2c0a 2020 2020 7072 696d 732e 5072  2),.    prims.Pr
-00014a60: 696d 4944 732e 4c45 3a20 5a65 726f 4261  imIDs.LE: ZeroBa
-00014a70: 636b 7761 7264 286e 756d 5f61 7267 733d  ckward(num_args=
-00014a80: 3229 2c0a 2020 2020 7072 696d 732e 5072  2),.    prims.Pr
-00014a90: 696d 4944 732e 4c4f 4731 303a 206c 616d  imIDs.LOG10: lam
-00014aa0: 6264 6120 782c 2067 3a20 6720 2f20 2878  bda x, g: g / (x
-00014ab0: 202a 2032 2e33 3032 3538 3530 3932 3939   * 2.30258509299
-00014ac0: 3430 3436 292c 0a20 2020 2070 7269 6d73  4046),.    prims
-00014ad0: 2e50 7269 6d49 4473 2e4c 4f47 3150 3a20  .PrimIDs.LOG1P: 
-00014ae0: 6c61 6d62 6461 2078 2c20 673a 2067 202f  lambda x, g: g /
-00014af0: 2028 7820 2b20 3129 2c0a 2020 2020 7072   (x + 1),.    pr
-00014b00: 696d 732e 5072 696d 4944 732e 4c4f 4732  ims.PrimIDs.LOG2
-00014b10: 3a20 6c61 6d62 6461 2078 2c20 673a 2067  : lambda x, g: g
-00014b20: 202f 2028 7820 2a20 302e 3639 3331 3437   / (x * 0.693147
-00014b30: 3138 3035 3539 3934 3533 292c 0a20 2020  1805599453),.   
-00014b40: 2070 7269 6d73 2e50 7269 6d49 4473 2e46   prims.PrimIDs.F
-00014b50: 4d4f 443a 206c 616d 6264 6120 782c 2079  MOD: lambda x, y
-00014b60: 2c20 673a 2028 672c 202d 6720 2a20 7072  , g: (g, -g * pr
-00014b70: 696d 732e 7472 756e 6328 7820 2f20 7929  ims.trunc(x / y)
-00014b80: 292c 0a7d 0a0a 0a64 6566 2072 6567 6973  ),.}...def regis
-00014b90: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
-00014ba0: 7277 6172 6428 6f70 293a 0a20 2020 2022  rward(op):.    "
-00014bb0: 2222 4465 636f 7261 746f 7220 746f 2072  ""Decorator to r
-00014bc0: 6567 6973 7465 7220 616e 2061 7567 6d65  egister an augme
-00014bd0: 6e74 6564 2066 6f72 7761 7264 2069 6d70  nted forward imp
-00014be0: 6c65 6d65 6e74 6174 696f 6e20 666f 7220  lementation for 
-00014bf0: 6120 7379 6d62 6f6c 2e0a 0a20 2020 2041  a symbol...    A
-00014c00: 7267 733a 0a20 2020 2020 2020 206f 7020  rgs:.        op 
-00014c10: 284f 7073 293a 2053 796d 626f 6c20 666f  (Ops): Symbol fo
-00014c20: 7220 7768 6963 6820 746f 2072 6567 6973  r which to regis
-00014c30: 7465 7220 7468 6520 6175 676d 656e 7465  ter the augmente
-00014c40: 6420 666f 7277 6172 6420 696d 706c 656d  d forward implem
-00014c50: 656e 7461 7469 6f6e 2e0a 0a20 2020 2052  entation...    R
-00014c60: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-00014c70: 4361 6c6c 6162 6c65 3a20 4465 636f 7261  Callable: Decora
-00014c80: 746f 7220 6675 6e63 7469 6f6e 2e0a 2020  tor function..  
-00014c90: 2020 2222 220a 0a20 2020 2064 6566 2064    """..    def d
-00014ca0: 6563 6f72 6174 6f72 2866 756e 6329 3a0a  ecorator(func):.
-00014cb0: 2020 2020 2020 2020 6175 676d 656e 7465          augmente
-00014cc0: 645f 666f 7277 6172 645f 696d 706c 735b  d_forward_impls[
-00014cd0: 6f70 5d20 3d20 6675 6e63 0a20 2020 2020  op] = func.     
-00014ce0: 2020 2072 6574 7572 6e20 6675 6e63 0a0a     return func..
-00014cf0: 2020 2020 7265 7475 726e 2064 6563 6f72      return decor
-00014d00: 6174 6f72 0a0a 0a64 6566 2072 6567 6973  ator...def regis
-00014d10: 7465 725f 6261 636b 7761 7264 286f 7029  ter_backward(op)
-00014d20: 3a0a 2020 2020 2222 2244 6563 6f72 6174  :.    """Decorat
-00014d30: 6f72 2074 6f20 7265 6769 7374 6572 2061  or to register a
-00014d40: 2062 6163 6b77 6172 6420 696d 706c 656d   backward implem
-00014d50: 656e 7461 7469 6f6e 2066 6f72 2061 2073  entation for a s
-00014d60: 796d 626f 6c2e 0a0a 2020 2020 4172 6773  ymbol...    Args
-00014d70: 3a0a 2020 2020 2020 2020 6f70 2028 4f70  :.        op (Op
-00014d80: 7329 3a20 5379 6d62 6f6c 2066 6f72 2077  s): Symbol for w
-00014d90: 6869 6368 2074 6f20 7265 6769 7374 6572  hich to register
-00014da0: 2074 6865 2062 6163 6b77 6172 6420 696d   the backward im
-00014db0: 706c 656d 656e 7461 7469 6f6e 2e0a 0a20  plementation... 
-00014dc0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00014dd0: 2020 2020 4361 6c6c 6162 6c65 3a20 4465      Callable: De
-00014de0: 636f 7261 746f 7220 6675 6e63 7469 6f6e  corator function
-00014df0: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
-00014e00: 6566 2064 6563 6f72 6174 6f72 2866 756e  ef decorator(fun
-00014e10: 6329 3a0a 2020 2020 2020 2020 6261 636b  c):.        back
-00014e20: 7761 7264 5f69 6d70 6c73 5b6f 705d 203d  ward_impls[op] =
-00014e30: 2066 756e 630a 2020 2020 2020 2020 7265   func.        re
-00014e40: 7475 726e 2066 756e 630a 0a20 2020 2072  turn func..    r
-00014e50: 6574 7572 6e20 6465 636f 7261 746f 720a  eturn decorator.
-00014e60: 0a0a 6465 6620 7265 7374 6f72 655f 7265  ..def restore_re
-00014e70: 6475 6365 645f 6469 6d73 2878 2c20 7265  duced_dims(x, re
-00014e80: 6475 6365 645f 6469 6d73 2c20 6f72 6967  duced_dims, orig
-00014e90: 696e 616c 5f73 6861 7065 293a 0a20 2020  inal_shape):.   
-00014ea0: 2022 2222 5265 7374 6f72 6573 2074 6865   """Restores the
-00014eb0: 2072 6564 7563 6564 2064 696d 656e 7369   reduced dimensi
-00014ec0: 6f6e 7320 6f66 2061 2074 656e 736f 722e  ons of a tensor.
-00014ed0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-00014ee0: 2020 2020 7820 2856 6172 6961 626c 6529      x (Variable)
-00014ef0: 3a20 5465 6e73 6f72 2074 6f20 6265 2072  : Tensor to be r
-00014f00: 6573 6861 7065 642e 0a20 2020 2020 2020  eshaped..       
-00014f10: 2072 6564 7563 6564 5f64 696d 7320 2854   reduced_dims (T
-00014f20: 7570 6c65 5b69 6e74 2c20 2e2e 2e5d 293a  uple[int, ...]):
-00014f30: 2054 7570 6c65 206f 6620 7265 6475 6365   Tuple of reduce
-00014f40: 6420 6469 6d65 6e73 696f 6e73 2e0a 2020  d dimensions..  
-00014f50: 2020 2020 2020 6f72 6967 696e 616c 5f73        original_s
-00014f60: 6861 7065 2028 5475 706c 655b 696e 742c  hape (Tuple[int,
-00014f70: 202e 2e2e 5d29 3a20 4f72 6967 696e 616c   ...]): Original
-00014f80: 2073 6861 7065 206f 6620 7468 6520 7465   shape of the te
-00014f90: 6e73 6f72 2e0a 0a20 2020 2052 6574 7572  nsor...    Retur
-00014fa0: 6e73 3a0a 2020 2020 2020 2020 5661 7269  ns:.        Vari
-00014fb0: 6162 6c65 3a20 5465 6e73 6f72 2077 6974  able: Tensor wit
-00014fc0: 6820 7468 6520 7265 6475 6365 6420 6469  h the reduced di
-00014fd0: 6d65 6e73 696f 6e73 2072 6573 746f 7265  mensions restore
-00014fe0: 642e 0a20 2020 2022 2222 0a20 2020 2069  d..    """.    i
-00014ff0: 6620 6f72 6967 696e 616c 5f73 6861 7065  f original_shape
-00015000: 203d 3d20 2829 3a20 2023 2073 6361 6c61   == ():  # scala
-00015010: 720a 2020 2020 2020 2020 7265 7475 726e  r.        return
-00015020: 2078 0a0a 2020 2020 756e 7371 7565 657a   x..    unsqueez
-00015030: 6564 203d 2063 6c61 6e67 2e75 6e73 7175  ed = clang.unsqu
-00015040: 6565 7a65 2878 2c20 7265 6475 6365 645f  eeze(x, reduced_
-00015050: 6469 6d73 290a 2020 2020 7265 7475 726e  dims).    return
-00015060: 2063 6c61 6e67 2e65 7870 616e 6428 756e   clang.expand(un
-00015070: 7371 7565 657a 6564 2c20 6f72 6967 696e  squeezed, origin
-00015080: 616c 5f73 6861 7065 290a 0a0a 4072 6567  al_shape)...@reg
-00015090: 6973 7465 725f 6261 636b 7761 7264 2870  ister_backward(p
-000150a0: 7269 6d73 2e50 7269 6d49 4473 2e5a 4554  rims.PrimIDs.ZET
-000150b0: 4129 0a64 6566 207a 6574 615f 6261 636b  A).def zeta_back
-000150c0: 7761 7264 2878 2c20 792c 2067 293a 0a20  ward(x, y, g):. 
-000150d0: 2020 2023 2054 6865 2064 6572 6976 6174     # The derivat
-000150e0: 6976 6520 7772 7420 7468 6520 6669 7273  ive wrt the firs
-000150f0: 7420 6172 6775 6d65 6e74 2069 7320 6e6f  t argument is no
-00015100: 7420 6578 7072 6573 7369 626c 6520 696e  t expressible in
-00015110: 2074 6572 6d73 206f 6620 7a65 7461 206f   terms of zeta o
-00015120: 720a 2020 2020 2320 6f74 6865 7220 7370  r.    # other sp
-00015130: 6563 6961 6c20 6675 6e63 7469 6f6e 730a  ecial functions.
-00015140: 2020 2020 2320 5468 6572 6566 6f72 652c      # Therefore,
-00015150: 2077 6520 636f 6d70 7574 6520 6f6e 6c79   we compute only
-00015160: 2074 6865 2064 6572 6976 6174 6976 6520   the derivative 
-00015170: 7772 7420 7468 6520 7365 636f 6e64 2061  wrt the second a
-00015180: 7267 756d 656e 740a 2020 2020 6779 203d  rgument.    gy =
-00015190: 2067 202a 202d 7820 2a20 7072 696d 732e   g * -x * prims.
-000151a0: 7a65 7461 2878 202b 2031 2e30 2c20 7929  zeta(x + 1.0, y)
-000151b0: 0a0a 2020 2020 2320 5265 7475 726e 2061  ..    # Return a
-000151c0: 206d 6170 7070 696e 6720 6672 6f6d 2074   mappping from t
-000151d0: 6865 2066 6f72 7761 7264 2061 7267 756d  he forward argum
-000151e0: 656e 7473 2074 6f20 7468 6520 6772 6164  ents to the grad
-000151f0: 6965 6e74 730a 2020 2020 7265 7475 726e  ients.    return
-00015200: 207b 2279 223a 2067 797d 0a0a 0a40 7265   {"y": gy}...@re
-00015210: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
-00015220: 7072 696d 732e 5072 696d 4944 732e 4449  prims.PrimIDs.DI
-00015230: 4741 4d4d 4129 0a64 6566 2064 6967 616d  GAMMA).def digam
-00015240: 6d61 5f62 6163 6b77 6172 6428 613a 2050  ma_backward(a: P
-00015250: 726f 7879 2c20 6729 3a0a 2020 2020 6672  roxy, g):.    fr
-00015260: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
-00015270: 2069 6d70 6f72 7420 706f 6c79 6761 6d6d   import polygamm
-00015280: 610a 0a20 2020 2072 6574 7572 6e20 6720  a..    return g 
-00015290: 2a20 706f 6c79 6761 6d6d 6128 312c 2061  * polygamma(1, a
-000152a0: 290a 0a0a 4072 6567 6973 7465 725f 6175  )...@register_au
-000152b0: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
-000152c0: 2274 6f72 6368 2e70 6f6c 7967 616d 6d61  "torch.polygamma
-000152d0: 2229 0a64 6566 2070 6f6c 7967 616d 6d61  ").def polygamma
-000152e0: 5f61 7567 5f66 7764 286e 3a20 696e 742c  _aug_fwd(n: int,
-000152f0: 2061 3a20 5072 6f78 7929 3a0a 2020 2020   a: Proxy):.    
-00015300: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
-00015310: 6368 2069 6d70 6f72 7420 706f 6c79 6761  ch import polyga
-00015320: 6d6d 610a 0a20 2020 2070 7269 6d61 6c20  mma..    primal 
-00015330: 3d20 706f 6c79 6761 6d6d 6128 6e2c 2061  = polygamma(n, a
-00015340: 290a 2020 2020 7265 7369 6475 616c 7320  ).    residuals 
-00015350: 3d20 286e 2c20 6129 0a20 2020 2072 6574  = (n, a).    ret
-00015360: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
-00015370: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
-00015380: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
-00015390: 6172 6428 2274 6f72 6368 2e70 6f6c 7967  ard("torch.polyg
-000153a0: 616d 6d61 2229 0a64 6566 2070 6f6c 7967  amma").def polyg
-000153b0: 616d 6d61 5f62 6163 6b77 6172 6428 6e3a  amma_backward(n:
-000153c0: 2069 6e74 2c20 613a 2050 726f 7879 2c20   int, a: Proxy, 
-000153d0: 6729 3a0a 2020 2020 6672 6f6d 2074 6875  g):.    from thu
-000153e0: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
-000153f0: 7420 706f 6c79 6761 6d6d 610a 0a20 2020  t polygamma..   
-00015400: 2072 6574 7572 6e20 4e6f 6e65 2c20 6720   return None, g 
-00015410: 2a20 706f 6c79 6761 6d6d 6128 6e20 2b20  * polygamma(n + 
-00015420: 312c 2061 290a 0a0a 4072 6567 6973 7465  1, a)...@registe
-00015430: 725f 6261 636b 7761 7264 2870 7269 6d73  r_backward(prims
-00015440: 2e50 7269 6d49 4473 2e41 5441 4e32 290a  .PrimIDs.ATAN2).
-00015450: 6465 6620 6174 616e 325f 6261 636b 7761  def atan2_backwa
-00015460: 7264 2878 2c20 792c 2067 293a 0a20 2020  rd(x, y, g):.   
-00015470: 2061 6c70 6861 203d 2031 2e30 202f 2028   alpha = 1.0 / (
-00015480: 7820 2a20 7820 2b20 7920 2a20 7929 0a20  x * x + y * y). 
-00015490: 2020 2067 7261 645f 7820 3d20 6720 2a20     grad_x = g * 
-000154a0: 7920 2a20 616c 7068 610a 2020 2020 6772  y * alpha.    gr
-000154b0: 6164 5f79 203d 2067 202a 202d 7820 2a20  ad_y = g * -x * 
-000154c0: 616c 7068 610a 2020 2020 7265 7475 726e  alpha.    return
-000154d0: 2067 7261 645f 782c 2067 7261 645f 790a   grad_x, grad_y.
-000154e0: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
-000154f0: 656e 7465 645f 666f 7277 6172 6428 7072  ented_forward(pr
-00015500: 696d 732e 5072 696d 4944 732e 5641 5229  ims.PrimIDs.VAR)
-00015510: 0a64 6566 2076 6172 5f61 7567 5f66 7764  .def var_aug_fwd
-00015520: 2861 2c20 6469 6d2c 202a 2c20 636f 7272  (a, dim, *, corr
-00015530: 6563 7469 6f6e 293a 0a20 2020 2076 203d  ection):.    v =
-00015540: 2070 7269 6d73 2e76 6172 2861 2c20 6469   prims.var(a, di
-00015550: 6d2c 2063 6f72 7265 6374 696f 6e3d 636f  m, correction=co
-00015560: 7272 6563 7469 6f6e 290a 2020 2020 7265  rrection).    re
-00015570: 7475 726e 2056 4a50 4475 616c 2828 762c  turn VJPDual((v,
-00015580: 292c 2028 612c 2064 696d 2c20 636f 7272  ), (a, dim, corr
-00015590: 6563 7469 6f6e 2c20 7629 290a 0a0a 2320  ection, v))...# 
-000155a0: 544f 444f 3a20 6669 7820 6469 7669 7369  TODO: fix divisi
-000155b0: 6f6e 2062 7920 7a65 726f 2077 6865 6e20  on by zero when 
-000155c0: 6e5f 656c 656d 5f72 6564 7563 6564 203d  n_elem_reduced =
-000155d0: 3d20 3020 6f72 2077 6865 6e20 762e 6e75  = 0 or when v.nu
-000155e0: 6d65 6c20 3d3d 2030 0a23 2062 7920 7265  mel == 0.# by re
-000155f0: 7475 726e 696e 6720 7a65 726f 735f 6c69  turning zeros_li
-00015600: 6b65 2861 2920 6f72 2073 696d 696c 6172  ke(a) or similar
-00015610: 2e0a 2320 544f 444f 3a20 6669 7820 6772  ..# TODO: fix gr
-00015620: 6164 2077 6865 6e20 636f 7272 6563 7469  ad when correcti
-00015630: 6f6e 203e 206e 5f65 6c65 6d5f 7265 6475  on > n_elem_redu
-00015640: 6365 642e 0a40 7265 6769 7374 6572 5f62  ced..@register_b
-00015650: 6163 6b77 6172 6428 7072 696d 732e 5072  ackward(prims.Pr
-00015660: 696d 4944 732e 5641 5229 0a64 6566 2076  imIDs.VAR).def v
-00015670: 6172 5f62 6163 6b77 6172 6428 612c 2064  ar_backward(a, d
-00015680: 696d 2c20 636f 7272 6563 7469 6f6e 2c20  im, correction, 
-00015690: 762c 2067 293a 0a20 2020 206e 5f65 6c65  v, g):.    n_ele
-000156a0: 6d5f 7265 6475 6365 6420 3d20 612e 6e75  m_reduced = a.nu
-000156b0: 6d65 6c20 2f2f 2076 2e6e 756d 656c 2069  mel // v.numel i
-000156c0: 6620 612e 6e75 6d65 6c20 213d 2030 2065  f a.numel != 0 e
-000156d0: 6c73 6520 310a 2020 2020 6e6f 726d 616c  lse 1.    normal
-000156e0: 697a 6174 696f 6e5f 7363 616c 6172 203d  ization_scalar =
-000156f0: 206e 5f65 6c65 6d5f 7265 6475 6365 6420   n_elem_reduced 
-00015700: 2d20 636f 7272 6563 7469 6f6e 0a20 2020  - correction.   
-00015710: 2067 203d 2072 6573 746f 7265 5f72 6564   g = restore_red
-00015720: 7563 6564 5f64 696d 7328 672c 2064 696d  uced_dims(g, dim
-00015730: 2c20 612e 7368 6170 6529 0a20 2020 2069  , a.shape).    i
-00015740: 6620 612e 6474 7970 6520 213d 2076 2e64  f a.dtype != v.d
-00015750: 7479 7065 3a0a 2020 2020 2020 2020 6120  type:.        a 
-00015760: 3d20 7072 696d 732e 636f 6e76 6572 745f  = prims.convert_
-00015770: 656c 656d 656e 745f 7479 7065 2861 2c20  element_type(a, 
-00015780: 762e 6474 7970 6529 0a20 2020 206d 6561  v.dtype).    mea
-00015790: 6e20 3d20 7072 696d 732e 7375 6d28 612c  n = prims.sum(a,
-000157a0: 2064 696d 2920 2f20 6e5f 656c 656d 5f72   dim) / n_elem_r
-000157b0: 6564 7563 6564 0a20 2020 206d 6561 6e20  educed.    mean 
-000157c0: 3d20 7265 7374 6f72 655f 7265 6475 6365  = restore_reduce
-000157d0: 645f 6469 6d73 286d 6561 6e2c 2064 696d  d_dims(mean, dim
-000157e0: 2c20 612e 7368 6170 6529 0a20 2020 2072  , a.shape).    r
-000157f0: 6574 7572 6e20 2832 202a 2067 202a 2028  eturn (2 * g * (
-00015800: 6120 2d20 6d65 616e 2929 202f 206e 6f72  a - mean)) / nor
-00015810: 6d61 6c69 7a61 7469 6f6e 5f73 6361 6c61  malization_scala
-00015820: 720a 0a0a 6465 6620 6e5f 656c 656d 5f72  r...def n_elem_r
-00015830: 6564 7563 6564 2861 5f6e 6469 6d2c 2061  educed(a_ndim, a
-00015840: 5f73 6861 7065 2c20 6469 6d73 293a 0a20  _shape, dims):. 
-00015850: 2020 2064 696d 7320 3d20 7574 696c 732e     dims = utils.
-00015860: 6361 6e6f 6e69 6361 6c69 7a65 5f64 696d  canonicalize_dim
-00015870: 7328 615f 6e64 696d 2c20 6469 6d73 290a  s(a_ndim, dims).
-00015880: 2020 2020 7265 6475 6374 696f 6e5f 7369      reduction_si
-00015890: 7a65 203d 2031 0a20 2020 2066 6f72 2069  ze = 1.    for i
-000158a0: 6478 2c20 7369 7a65 2069 6e20 656e 756d  dx, size in enum
-000158b0: 6572 6174 6528 615f 7368 6170 6529 3a0a  erate(a_shape):.
-000158c0: 2020 2020 2020 2020 6966 2069 6478 2069          if idx i
-000158d0: 6e20 6469 6d73 3a0a 2020 2020 2020 2020  n dims:.        
-000158e0: 2020 2020 7265 6475 6374 696f 6e5f 7369      reduction_si
-000158f0: 7a65 202a 3d20 7369 7a65 0a20 2020 2072  ze *= size.    r
-00015900: 6574 7572 6e20 7265 6475 6374 696f 6e5f  eturn reduction_
-00015910: 7369 7a65 0a0a 0a64 6566 206d 6561 6e5f  size...def mean_
-00015920: 6261 636b 7761 7264 2861 5f6e 6469 6d2c  backward(a_ndim,
-00015930: 2061 5f73 6861 7065 2c20 6469 6d73 2c20   a_shape, dims, 
-00015940: 6772 6164 293a 0a20 2020 206d 6561 6e5f  grad):.    mean_
-00015950: 6c6f 6361 6c5f 6772 6164 203d 2031 2e30  local_grad = 1.0
-00015960: 202f 206e 5f65 6c65 6d5f 7265 6475 6365   / n_elem_reduce
-00015970: 6428 615f 6e64 696d 2c20 615f 7368 6170  d(a_ndim, a_shap
-00015980: 652c 2064 696d 7329 0a20 2020 2072 6574  e, dims).    ret
-00015990: 7572 6e20 7265 7374 6f72 655f 7265 6475  urn restore_redu
-000159a0: 6365 645f 6469 6d73 2867 7261 642c 2064  ced_dims(grad, d
-000159b0: 696d 732c 2061 5f73 6861 7065 2920 2a20  ims, a_shape) * 
-000159c0: 6d65 616e 5f6c 6f63 616c 5f67 7261 640a  mean_local_grad.
-000159d0: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
-000159e0: 656e 7465 645f 666f 7277 6172 6428 7072  ented_forward(pr
-000159f0: 696d 732e 5072 696d 4944 732e 5041 4429  ims.PrimIDs.PAD)
-00015a00: 0a64 6566 2070 6164 5f61 7567 5f66 7764  .def pad_aug_fwd
-00015a10: 2861 2c20 7061 6464 696e 675f 7661 6c75  (a, padding_valu
-00015a20: 652c 2070 6164 6469 6e67 5f63 6f6e 6669  e, padding_confi
-00015a30: 6729 3a0a 2020 2020 7265 7475 726e 2056  g):.    return V
-00015a40: 4a50 4475 616c 2828 7072 696d 732e 7061  JPDual((prims.pa
-00015a50: 6428 612c 2070 6164 6469 6e67 5f76 616c  d(a, padding_val
-00015a60: 7565 2c20 7061 6464 696e 675f 636f 6e66  ue, padding_conf
-00015a70: 6967 292c 292c 2028 612c 2070 6164 6469  ig),), (a, paddi
-00015a80: 6e67 5f63 6f6e 6669 6729 290a 0a0a 4072  ng_config))...@r
-00015a90: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
-00015aa0: 2870 7269 6d73 2e50 7269 6d49 4473 2e50  (prims.PrimIDs.P
-00015ab0: 4144 290a 6465 6620 7061 645f 6261 636b  AD).def pad_back
-00015ac0: 7761 7264 2861 2c20 7061 6464 696e 675f  ward(a, padding_
-00015ad0: 636f 6e66 6967 2c20 6729 3a0a 2020 2020  config, g):.    
-00015ae0: 2320 5368 6f72 7420 6369 7263 7569 7420  # Short circuit 
-00015af0: 6f6e 2065 6d70 7479 2069 6e70 7574 2e0a  on empty input..
-00015b00: 2020 2020 6966 2061 6e79 2864 696d 203d      if any(dim =
-00015b10: 3d20 3020 666f 7220 6469 6d20 696e 2061  = 0 for dim in a
-00015b20: 2e73 6861 7065 293a 0a20 2020 2020 2020  .shape):.       
-00015b30: 2072 6574 7572 6e20 6675 6c6c 5f6c 696b   return full_lik
-00015b40: 6528 612c 2066 696c 6c5f 7661 6c75 653d  e(a, fill_value=
-00015b50: 3029 0a0a 2020 2020 2320 556e 2d70 6164  0)..    # Un-pad
-00015b60: 2062 7920 7061 6464 696e 6720 7769 7468   by padding with
-00015b70: 207a 6572 6f20 7661 6c75 6573 0a20 2020   zero values.   
-00015b80: 207a 6572 6f5f 7061 6464 696e 675f 636f   zero_padding_co
-00015b90: 6e66 6967 203d 205b 282d 6c6f 2c20 2d68  nfig = [(-lo, -h
-00015ba0: 692c 2030 2920 666f 7220 6c6f 2c20 6869  i, 0) for lo, hi
-00015bb0: 2c20 5f20 696e 2070 6164 6469 6e67 5f63  , _ in padding_c
-00015bc0: 6f6e 6669 675d 0a0a 2020 2020 6720 3d20  onfig]..    g = 
-00015bd0: 7072 696d 732e 7061 6428 672c 2030 2e30  prims.pad(g, 0.0
-00015be0: 2c20 7a65 726f 5f70 6164 6469 6e67 5f63  , zero_padding_c
-00015bf0: 6f6e 6669 6729 0a0a 2020 2020 2320 556e  onfig)..    # Un
-00015c00: 2d73 6c69 6365 2062 7920 736c 6963 696e  -slice by slicin
-00015c10: 6720 7769 7468 2061 2073 7472 6964 6520  g with a stride 
-00015c20: 6f66 2076 616c 7565 2028 6469 6c61 7469  of value (dilati
-00015c30: 6f6e 202b 2031 290a 2020 2020 666f 7220  on + 1).    for 
-00015c40: 6469 6d2c 2028 5f2c 205f 2c20 6429 2069  dim, (_, _, d) i
-00015c50: 6e20 656e 756d 6572 6174 6528 7061 6464  n enumerate(padd
-00015c60: 696e 675f 636f 6e66 6967 293a 0a20 2020  ing_config):.   
-00015c70: 2020 2020 2067 203d 2073 6c69 6365 5f69       g = slice_i
-00015c80: 6e5f 6469 6d28 672c 2030 2c20 672e 7368  n_dim(g, 0, g.sh
-00015c90: 6170 655b 6469 6d5d 2c20 7374 7269 6465  ape[dim], stride
-00015ca0: 3d64 202b 2031 2c20 6469 6d3d 6469 6d29  =d + 1, dim=dim)
-00015cb0: 0a0a 2020 2020 7265 7475 726e 2067 0a0a  ..    return g..
-00015cc0: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
-00015cd0: 6e74 6564 5f66 6f72 7761 7264 2870 7269  nted_forward(pri
-00015ce0: 6d73 2e50 7269 6d49 4473 2e50 524f 4429  ms.PrimIDs.PROD)
-00015cf0: 0a64 6566 2070 726f 645f 6175 675f 6677  .def prod_aug_fw
-00015d00: 6428 782c 2064 696d 7329 3a0a 2020 2020  d(x, dims):.    
-00015d10: 2222 2241 7567 6d65 6e74 6564 2070 726f  """Augmented pro
-00015d20: 6420 6f70 6572 6174 696f 6e2e 0a0a 2020  d operation...  
-00015d30: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-00015d40: 7820 2856 6172 6961 626c 6529 3a20 5465  x (Variable): Te
-00015d50: 6e73 6f72 2074 6f20 6265 206d 756c 7469  nsor to be multi
-00015d60: 706c 6965 642e 0a20 2020 2020 2020 2064  plied..        d
-00015d70: 696d 7320 2854 7570 6c65 5b69 6e74 2c20  ims (Tuple[int, 
-00015d80: 2e2e 2e5d 293a 2044 696d 656e 7369 6f6e  ...]): Dimension
-00015d90: 7320 746f 2062 6520 6d75 6c74 6970 6c69  s to be multipli
-00015da0: 6564 2e0a 0a20 2020 2052 6574 7572 6e73  ed...    Returns
-00015db0: 3a0a 2020 2020 2020 2020 564a 5044 7561  :.        VJPDua
-00015dc0: 6c3a 2050 7269 6d61 6c20 616e 6420 7265  l: Primal and re
-00015dd0: 7369 6475 616c 732e 0a20 2020 2022 2222  siduals..    """
-00015de0: 0a20 2020 2070 7269 6d61 6c20 3d20 7072  .    primal = pr
-00015df0: 696d 732e 7072 6f64 2878 2c20 6469 6d73  ims.prod(x, dims
-00015e00: 290a 0a20 2020 2072 6573 6964 7561 6c73  )..    residuals
-00015e10: 203d 2028 0a20 2020 2020 2020 2070 7269   = (.        pri
-00015e20: 6d61 6c2c 0a20 2020 2020 2020 2078 2c0a  mal,.        x,.
-00015e30: 2020 2020 2020 2020 782e 7368 6170 652c          x.shape,
-00015e40: 0a20 2020 2020 2020 2064 696d 732c 0a20  .        dims,. 
-00015e50: 2020 2029 0a20 2020 2072 6574 7572 6e20     ).    return 
-00015e60: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
-00015e70: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
-00015e80: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
-00015e90: 7072 696d 732e 5072 696d 4944 732e 5052  prims.PrimIDs.PR
-00015ea0: 4f44 290a 6465 6620 7072 6f64 5f70 756c  OD).def prod_pul
-00015eb0: 6c62 6163 6b28 7072 696d 616c 2c20 782c  lback(primal, x,
-00015ec0: 2078 5f73 6861 7065 2c20 7265 6475 6365   x_shape, reduce
-00015ed0: 645f 6469 6d73 2c20 6729 3a0a 2020 2020  d_dims, g):.    
-00015ee0: 7265 7475 726e 2070 7269 6d73 2e64 6976  return prims.div
-00015ef0: 2872 6573 746f 7265 5f72 6564 7563 6564  (restore_reduced
-00015f00: 5f64 696d 7328 7072 696d 616c 202a 2067  _dims(primal * g
-00015f10: 2c20 7265 6475 6365 645f 6469 6d73 2c20  , reduced_dims, 
-00015f20: 785f 7368 6170 6529 2c20 7829 0a0a 0a64  x_shape), x)...d
-00015f30: 6566 206b 6565 7064 696d 5f72 6564 7563  ef keepdim_reduc
-00015f40: 7469 6f6e 2872 6564 7563 7469 6f6e 5f66  tion(reduction_f
-00015f50: 6e2c 2078 2c20 6469 6d73 293a 0a20 2020  n, x, dims):.   
-00015f60: 2022 2222 4170 706c 6965 7320 7265 6475   """Applies redu
-00015f70: 6374 696f 6e20 616e 6420 6669 7865 7320  ction and fixes 
-00015f80: 6f75 7470 7574 2074 6f20 636f 6e66 6f72  output to confor
-00015f90: 6d20 746f 206b 6565 7064 696d 3d54 7275  m to keepdim=Tru
-00015fa0: 6522 2222 0a20 2020 206f 7574 203d 2072  e""".    out = r
-00015fb0: 6564 7563 7469 6f6e 5f66 6e28 782c 2064  eduction_fn(x, d
-00015fc0: 696d 7329 0a20 2020 2061 7267 6d61 785f  ims).    argmax_
-00015fd0: 7375 6d5f 6f75 745f 7368 6170 6520 3d20  sum_out_shape = 
-00015fe0: 5b78 2e73 6861 7065 5b69 5d20 6966 2069  [x.shape[i] if i
-00015ff0: 206e 6f74 2069 6e20 6469 6d73 2065 6c73   not in dims els
-00016000: 6520 3120 666f 7220 6920 696e 2072 616e  e 1 for i in ran
-00016010: 6765 2878 2e6e 6469 6d29 5d0a 2020 2020  ge(x.ndim)].    
-00016020: 6272 6f61 6463 6173 745f 6469 6d73 203d  broadcast_dims =
-00016030: 205b 6920 666f 7220 6920 696e 2072 616e   [i for i in ran
-00016040: 6765 2878 2e6e 6469 6d29 2069 6620 6920  ge(x.ndim) if i 
-00016050: 6e6f 7420 696e 2064 696d 735d 0a20 2020  not in dims].   
-00016060: 2072 6574 7572 6e20 7072 696d 732e 6272   return prims.br
-00016070: 6f61 6463 6173 745f 696e 5f64 696d 286f  oadcast_in_dim(o
-00016080: 7574 2c20 6172 676d 6178 5f73 756d 5f6f  ut, argmax_sum_o
-00016090: 7574 5f73 6861 7065 2c20 6272 6f61 6463  ut_shape, broadc
-000160a0: 6173 745f 6469 6d73 290a 0a0a 2320 496e  ast_dims)...# In
-000160b0: 7370 6972 6564 2066 726f 6d20 6874 7470  spired from http
-000160c0: 733a 2f2f 6769 7468 7562 2e63 6f6d 2f48  s://github.com/H
-000160d0: 4950 532f 6175 746f 6772 6164 2f62 6c6f  IPS/autograd/blo
-000160e0: 622f 6d61 7374 6572 2f61 7574 6f67 7261  b/master/autogra
-000160f0: 642f 6e75 6d70 792f 6e75 6d70 795f 766a  d/numpy/numpy_vj
-00016100: 7073 2e70 7923 4c33 3533 0a64 6566 2067  ps.py#L353.def g
-00016110: 7261 645f 6368 6f6f 7365 725f 6261 636b  rad_chooser_back
-00016120: 7761 7264 2870 7269 6d61 6c2c 2078 2c20  ward(primal, x, 
-00016130: 785f 7368 6170 652c 2072 6564 7563 6564  x_shape, reduced
-00016140: 5f64 696d 732c 2067 293a 0a20 2020 2022  _dims, g):.    "
-00016150: 2222 4275 696c 6473 2067 7261 6469 656e  ""Builds gradien
-00016160: 7420 6f66 2066 756e 6374 696f 6e73 2074  t of functions t
-00016170: 6861 7420 6368 6f6f 7365 2061 2073 696e  hat choose a sin
-00016180: 676c 6520 6974 656d 2c20 7375 6368 2061  gle item, such a
-00016190: 7320 6d69 6e20 6f72 206d 6178 2e22 2222  s min or max."""
-000161a0: 0a20 2020 2067 5f72 6570 6561 7465 6420  .    g_repeated 
-000161b0: 3d20 7265 7374 6f72 655f 7265 6475 6365  = restore_reduce
-000161c0: 645f 6469 6d73 2867 2c20 7265 6475 6365  d_dims(g, reduce
-000161d0: 645f 6469 6d73 2c20 785f 7368 6170 6529  d_dims, x_shape)
-000161e0: 0a20 2020 2070 7269 6d61 6c5f 7265 7065  .    primal_repe
-000161f0: 6174 6564 203d 2072 6573 746f 7265 5f72  ated = restore_r
-00016200: 6564 7563 6564 5f64 696d 7328 7072 696d  educed_dims(prim
-00016210: 616c 2c20 7265 6475 6365 645f 6469 6d73  al, reduced_dims
-00016220: 2c20 785f 7368 6170 6529 0a20 2020 2061  , x_shape).    a
-00016230: 7267 6d61 785f 6c6f 6361 7469 6f6e 7320  rgmax_locations 
-00016240: 3d20 7820 3d3d 2070 7269 6d61 6c5f 7265  = x == primal_re
-00016250: 7065 6174 6564 0a20 2020 2061 7267 6d61  peated.    argma
-00016260: 785f 7375 6d20 3d20 6b65 6570 6469 6d5f  x_sum = keepdim_
-00016270: 7265 6475 6374 696f 6e28 7072 696d 732e  reduction(prims.
-00016280: 7375 6d2c 2061 7267 6d61 785f 6c6f 6361  sum, argmax_loca
-00016290: 7469 6f6e 732c 2072 6564 7563 6564 5f64  tions, reduced_d
-000162a0: 696d 7329 0a20 2020 206f 7574 203d 2067  ims).    out = g
-000162b0: 5f72 6570 6561 7465 6420 2a20 6172 676d  _repeated * argm
-000162c0: 6178 5f6c 6f63 6174 696f 6e73 202f 2061  ax_locations / a
-000162d0: 7267 6d61 785f 7375 6d0a 2020 2020 7265  rgmax_sum.    re
-000162e0: 7475 726e 206f 7574 0a0a 0a72 6567 6973  turn out...regis
-000162f0: 7465 725f 6261 636b 7761 7264 2870 7269  ter_backward(pri
-00016300: 6d73 2e50 7269 6d49 4473 2e41 4d49 4e29  ms.PrimIDs.AMIN)
-00016310: 2867 7261 645f 6368 6f6f 7365 725f 6261  (grad_chooser_ba
-00016320: 636b 7761 7264 290a 0a0a 4072 6567 6973  ckward)...@regis
-00016330: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
-00016340: 7277 6172 6428 7072 696d 732e 5072 696d  rward(prims.Prim
-00016350: 4944 732e 414d 494e 290a 6465 6620 616d  IDs.AMIN).def am
-00016360: 696e 5f61 7567 5f66 7764 2878 2c20 6469  in_aug_fwd(x, di
-00016370: 6d73 293a 0a20 2020 2022 2222 4175 676d  ms):.    """Augm
-00016380: 656e 7465 6420 616d 696e 206f 7065 7261  ented amin opera
-00016390: 7469 6f6e 2e0a 2020 2020 4172 6773 3a0a  tion..    Args:.
-000163a0: 2020 2020 2020 2020 7820 2856 6172 6961          x (Varia
-000163b0: 626c 6529 3a20 5465 6e73 6f72 2074 6f20  ble): Tensor to 
-000163c0: 636f 6d70 7574 6520 616d 696e 206f 6e2e  compute amin on.
-000163d0: 0a20 2020 2020 2020 2064 696d 7320 2854  .        dims (T
-000163e0: 7570 6c65 5b69 6e74 2c20 2e2e 2e5d 293a  uple[int, ...]):
-000163f0: 2044 696d 656e 7369 6f6e 7320 746f 2063   Dimensions to c
-00016400: 6f6d 7075 7465 2061 6d69 6e20 6f76 6572  ompute amin over
-00016410: 2e0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
-00016420: 2020 2020 2020 2056 4a50 4475 616c 3a20         VJPDual: 
-00016430: 5072 696d 616c 2061 6e64 2072 6573 6964  Primal and resid
-00016440: 7561 6c73 2e0a 2020 2020 2222 220a 2020  uals..    """.  
-00016450: 2020 7072 696d 616c 203d 2070 7269 6d73    primal = prims
-00016460: 2e61 6d69 6e28 782c 2064 696d 7329 0a0a  .amin(x, dims)..
-00016470: 2020 2020 7265 7369 6475 616c 7320 3d20      residuals = 
-00016480: 280a 2020 2020 2020 2020 7072 696d 616c  (.        primal
-00016490: 2c0a 2020 2020 2020 2020 782c 0a20 2020  ,.        x,.   
-000164a0: 2020 2020 2078 2e73 6861 7065 2c0a 2020       x.shape,.  
-000164b0: 2020 2020 2020 6469 6d73 2c0a 2020 2020        dims,.    
-000164c0: 290a 0a20 2020 2072 6574 7572 6e20 564a  )..    return VJ
-000164d0: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
-000164e0: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
-000164f0: 7374 6572 5f61 7567 6d65 6e74 6564 5f66  ster_augmented_f
-00016500: 6f72 7761 7264 2870 7269 6d73 2e50 7269  orward(prims.Pri
-00016510: 6d49 4473 2e50 4f57 290a 6465 6620 706f  mIDs.POW).def po
-00016520: 775f 6175 675f 6665 6428 782c 2079 293a  w_aug_fed(x, y):
-00016530: 0a20 2020 2022 2222 4175 676d 656e 7465  .    """Augmente
-00016540: 6420 7468 6520 706f 7720 6f70 6572 6174  d the pow operat
-00016550: 696f 6e2e 0a0a 2020 2020 4172 6773 3a0a  ion...    Args:.
-00016560: 2020 2020 2020 2020 7820 2856 6172 6961          x (Varia
-00016570: 626c 6529 3a20 5465 6e73 6f72 2077 6974  ble): Tensor wit
-00016580: 6820 7468 6520 6261 7365 2074 6f20 6265  h the base to be
-00016590: 2065 7870 6f6e 656e 7469 6174 6564 2e0a   exponentiated..
-000165a0: 2020 2020 2020 2020 7920 2856 6172 6961          y (Varia
-000165b0: 626c 6529 3a20 5465 6e73 6f72 2077 6974  ble): Tensor wit
-000165c0: 6820 706f 7765 7220 746f 2072 6169 7365  h power to raise
-000165d0: 2074 6f2e 0a0a 2020 2020 5265 7475 726e   to...    Return
-000165e0: 733a 0a20 2020 2020 2020 2056 4a50 4475  s:.        VJPDu
-000165f0: 616c 3a20 5072 696d 616c 2061 6e64 2072  al: Primal and r
-00016600: 6573 6964 7561 6c73 2e0a 2020 2020 2222  esiduals..    ""
-00016610: 220a 2020 2020 7072 696d 616c 203d 2070  ".    primal = p
-00016620: 7269 6d73 2e70 6f77 2878 2c20 7929 0a20  rims.pow(x, y). 
-00016630: 2020 2072 6573 6964 7561 6c73 203d 2028     residuals = (
-00016640: 7072 696d 616c 2c20 782c 2079 290a 2020  primal, x, y).  
-00016650: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
-00016660: 2870 7269 6d61 6c2c 2072 6573 6964 7561  (primal, residua
-00016670: 6c73 290a 0a0a 4072 6567 6973 7465 725f  ls)...@register_
-00016680: 6261 636b 7761 7264 2870 7269 6d73 2e50  backward(prims.P
-00016690: 7269 6d49 4473 2e50 4f57 290a 6465 6620  rimIDs.POW).def 
-000166a0: 706f 775f 6261 636b 7761 7264 2872 6573  pow_backward(res
-000166b0: 756c 742c 2078 2c20 792c 2067 293a 0a20  ult, x, y, g):. 
-000166c0: 2020 2069 6d70 6f72 7420 7468 756e 6465     import thunde
-000166d0: 722e 636c 616e 6720 6173 2074 6c61 6e67  r.clang as tlang
-000166e0: 0a0a 2020 2020 6772 6573 756c 7420 3d20  ..    gresult = 
-000166f0: 6720 2a20 7265 7375 6c74 2020 2320 7265  g * result  # re
-00016700: 7573 6520 636f 6d6d 6f6e 2066 6163 746f  use common facto
-00016710: 720a 2020 2020 6478 203d 2067 202a 2079  r.    dx = g * y
-00016720: 202a 2078 202a 2a20 2879 202d 2031 290a   * x ** (y - 1).
-00016730: 2020 2020 6479 203d 2067 7265 7375 6c74      dy = gresult
-00016740: 202a 2074 6c61 6e67 2e6c 6f67 2878 290a   * tlang.log(x).
-00016750: 2020 2020 7265 7475 726e 2064 782c 2064      return dx, d
-00016760: 790a 0a0a 4072 6567 6973 7465 725f 6175  y...@register_au
-00016770: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
-00016780: 7072 696d 732e 5072 696d 4944 732e 5441  prims.PrimIDs.TA
-00016790: 4e29 0a64 6566 2074 616e 5f61 7567 5f66  N).def tan_aug_f
-000167a0: 7764 2878 293a 0a20 2020 2022 2222 4175  wd(x):.    """Au
-000167b0: 676d 656e 7465 6420 7461 6e20 6f70 6572  gmented tan oper
-000167c0: 6174 696f 6e2e 0a0a 2020 2020 4172 6773  ation...    Args
-000167d0: 3a0a 2020 2020 2020 2020 7820 2856 6172  :.        x (Var
-000167e0: 6961 626c 6529 3a20 5465 6e73 6f72 2074  iable): Tensor t
-000167f0: 6f20 6265 2070 6173 7365 6420 746f 2074  o be passed to t
-00016800: 616e 2e0a 2020 2020 2222 220a 0a20 2020  an..    """..   
-00016810: 2070 7269 6d61 6c20 3d20 7072 696d 732e   primal = prims.
-00016820: 7461 6e28 7829 0a20 2020 2072 6573 6964  tan(x).    resid
-00016830: 7561 6c73 203d 2028 7072 696d 616c 2c29  uals = (primal,)
-00016840: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
-00016850: 7561 6c28 7072 696d 616c 2c20 7265 7369  ual(primal, resi
-00016860: 6475 616c 7329 0a0a 0a40 7265 6769 7374  duals)...@regist
-00016870: 6572 5f62 6163 6b77 6172 6428 7072 696d  er_backward(prim
-00016880: 732e 5072 696d 4944 732e 5441 4e29 0a64  s.PrimIDs.TAN).d
-00016890: 6566 2074 616e 5f62 6163 6b77 6172 6428  ef tan_backward(
-000168a0: 7265 7375 6c74 2c20 6729 3a0a 2020 2020  result, g):.    
-000168b0: 7265 7475 726e 2067 202a 2028 3120 2b20  return g * (1 + 
-000168c0: 7265 7375 6c74 202a 2072 6573 756c 7429  result * result)
-000168d0: 0a0a 0a23 204e 4f54 453a 204a 6178 2075  ...# NOTE: Jax u
-000168e0: 7365 7320 6e70 2e61 7267 736f 7274 2069  ses np.argsort i
-000168f0: 6e20 6974 7320 7472 616e 7370 6f73 6520  n its transpose 
-00016900: 766a 7020 636f 6d70 7574 6174 696f 6e0a  vjp computation.
-00016910: 6465 6620 5f61 7267 736f 7274 2873 6571  def _argsort(seq
-00016920: 293a 0a20 2020 2072 6574 7572 6e20 736f  ):.    return so
-00016930: 7274 6564 2872 616e 6765 286c 656e 2873  rted(range(len(s
-00016940: 6571 2929 2c20 6b65 793d 7365 712e 5f5f  eq)), key=seq.__
-00016950: 6765 7469 7465 6d5f 5f29 0a0a 0a40 7265  getitem__)...@re
-00016960: 6769 7374 6572 5f61 7567 6d65 6e74 6564  gister_augmented
-00016970: 5f66 6f72 7761 7264 2870 7269 6d73 2e50  _forward(prims.P
-00016980: 7269 6d49 4473 2e44 4556 4943 455f 5055  rimIDs.DEVICE_PU
-00016990: 5429 0a64 6566 2064 6576 6963 655f 7075  T).def device_pu
-000169a0: 745f 6175 675f 6677 6428 613a 2054 656e  t_aug_fwd(a: Ten
-000169b0: 736f 7250 726f 7879 2c20 6465 7669 6365  sorProxy, device
-000169c0: 3a20 4465 7669 6365 2920 2d3e 2054 656e  : Device) -> Ten
-000169d0: 736f 7250 726f 7879 3a0a 2020 2020 7072  sorProxy:.    pr
-000169e0: 696d 616c 203d 2070 7269 6d73 2e64 6576  imal = prims.dev
-000169f0: 6963 655f 7075 7428 612c 2064 6576 6963  ice_put(a, devic
-00016a00: 6529 0a20 2020 2072 6573 6964 7561 6c73  e).    residuals
-00016a10: 203d 2028 612e 6465 7669 6365 2c29 0a20   = (a.device,). 
-00016a20: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
-00016a30: 6c28 7072 696d 616c 2c20 7265 7369 6475  l(primal, residu
-00016a40: 616c 7329 0a0a 0a40 7265 6769 7374 6572  als)...@register
-00016a50: 5f62 6163 6b77 6172 6428 7072 696d 732e  _backward(prims.
-00016a60: 5072 696d 4944 732e 4445 5649 4345 5f50  PrimIDs.DEVICE_P
-00016a70: 5554 290a 6465 6620 6465 7669 6365 5f70  UT).def device_p
-00016a80: 7574 5f62 6163 6b77 6172 6428 6f72 6967  ut_backward(orig
-00016a90: 5f64 6576 6963 652c 2067 293a 0a20 2020  _device, g):.   
-00016aa0: 2072 6574 7572 6e20 7072 696d 732e 6465   return prims.de
-00016ab0: 7669 6365 5f70 7574 2867 2c20 6f72 6967  vice_put(g, orig
-00016ac0: 5f64 6576 6963 6529 2c20 4e6f 6e65 0a0a  _device), None..
-00016ad0: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
-00016ae0: 6e74 6564 5f66 6f72 7761 7264 2870 7269  nted_forward(pri
-00016af0: 6d73 2e50 7269 6d49 4473 2e43 4f4e 564f  ms.PrimIDs.CONVO
-00016b00: 4c55 5449 4f4e 290a 6465 6620 636f 6e76  LUTION).def conv
-00016b10: 6f6c 7574 696f 6e5f 6175 675f 6677 6428  olution_aug_fwd(
-00016b20: 0a20 2020 2061 3a20 5072 6f78 792c 0a20  .    a: Proxy,. 
-00016b30: 2020 2077 6569 6768 742c 0a20 2020 2062     weight,.    b
-00016b40: 6961 732c 0a20 2020 2073 7472 6964 652c  ias,.    stride,
-00016b50: 0a20 2020 2070 6164 6469 6e67 2c0a 2020  .    padding,.  
-00016b60: 2020 6469 6c61 7469 6f6e 2c0a 2020 2020    dilation,.    
-00016b70: 7472 616e 7370 6f73 6564 2c0a 2020 2020  transposed,.    
-00016b80: 6f75 7470 7574 5f70 6164 6469 6e67 2c0a  output_padding,.
-00016b90: 2020 2020 6772 6f75 7073 2c0a 293a 0a20      groups,.):. 
-00016ba0: 2020 2070 7269 6d61 6c20 3d20 636f 6e76     primal = conv
-00016bb0: 6f6c 7574 696f 6e28 612c 2077 6569 6768  olution(a, weigh
-00016bc0: 742c 2062 6961 732c 2073 7472 6964 652c  t, bias, stride,
-00016bd0: 2070 6164 6469 6e67 2c20 6469 6c61 7469   padding, dilati
-00016be0: 6f6e 2c20 7472 616e 7370 6f73 6564 2c20  on, transposed, 
-00016bf0: 6f75 7470 7574 5f70 6164 6469 6e67 2c20  output_padding, 
-00016c00: 6772 6f75 7073 290a 2020 2020 7265 7369  groups).    resi
-00016c10: 6475 616c 7320 3d20 2870 7269 6d61 6c2c  duals = (primal,
-00016c20: 2061 2c20 7765 6967 6874 2c20 6269 6173   a, weight, bias
-00016c30: 2c20 7374 7269 6465 2c20 7061 6464 696e  , stride, paddin
-00016c40: 672c 2064 696c 6174 696f 6e2c 2074 7261  g, dilation, tra
-00016c50: 6e73 706f 7365 642c 206f 7574 7075 745f  nsposed, output_
-00016c60: 7061 6464 696e 672c 2067 726f 7570 7329  padding, groups)
-00016c70: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
-00016c80: 7561 6c28 7072 696d 616c 2c20 7265 7369  ual(primal, resi
-00016c90: 6475 616c 7329 0a0a 0a40 7265 6769 7374  duals)...@regist
-00016ca0: 6572 5f62 6163 6b77 6172 6428 7072 696d  er_backward(prim
-00016cb0: 732e 5072 696d 4944 732e 434f 4e56 4f4c  s.PrimIDs.CONVOL
-00016cc0: 5554 494f 4e29 0a64 6566 2063 6f6e 766f  UTION).def convo
-00016cd0: 6c75 7469 6f6e 5f62 6163 6b77 6172 6428  lution_backward(
-00016ce0: 0a20 2020 206f 7574 7075 743a 2050 726f  .    output: Pro
-00016cf0: 7879 2c0a 2020 2020 696e 7075 743a 2050  xy,.    input: P
-00016d00: 726f 7879 2c0a 2020 2020 7765 6967 6874  roxy,.    weight
-00016d10: 2c0a 2020 2020 6269 6173 2c0a 2020 2020  ,.    bias,.    
-00016d20: 7374 7269 6465 2c0a 2020 2020 7061 6464  stride,.    padd
-00016d30: 696e 672c 0a20 2020 2064 696c 6174 696f  ing,.    dilatio
-00016d40: 6e2c 0a20 2020 2074 7261 6e73 706f 7365  n,.    transpose
-00016d50: 642c 0a20 2020 206f 7574 7075 745f 7061  d,.    output_pa
-00016d60: 6464 696e 672c 0a20 2020 2067 726f 7570  dding,.    group
-00016d70: 732c 0a20 2020 2067 7261 642c 0a29 3a0a  s,.    grad,.):.
-00016d80: 2020 2020 2320 5472 616e 7370 6f73 6564      # Transposed
-00016d90: 2063 6f6e 766f 6c75 7469 6f6e 2069 7320   convolution is 
-00016da0: 6e6f 7420 7375 7070 6f72 7465 6421 0a20  not supported!. 
-00016db0: 2020 2061 7373 6572 7420 7472 616e 7370     assert transp
-00016dc0: 6f73 6564 203d 3d20 300a 0a20 2020 2069  osed == 0..    i
-00016dd0: 6e70 7574 5f67 7261 6420 3d20 4e6f 6e65  nput_grad = None
-00016de0: 0a20 2020 2077 6569 6768 745f 6772 6164  .    weight_grad
-00016df0: 203d 204e 6f6e 650a 2020 2020 6269 6173   = None.    bias
-00016e00: 5f67 7261 6420 3d20 4e6f 6e65 0a0a 2020  _grad = None..  
-00016e10: 2020 2320 5368 6f72 7420 6369 7263 7569    # Short circui
-00016e20: 7420 6f6e 207a 6572 6f2d 6469 6d20 6772  t on zero-dim gr
-00016e30: 6164 0a20 2020 2069 6620 616e 7928 7320  ad.    if any(s 
-00016e40: 3d3d 2030 2066 6f72 2073 2069 6e20 6772  == 0 for s in gr
-00016e50: 6164 2e73 6861 7065 293a 0a20 2020 2020  ad.shape):.     
-00016e60: 2020 2069 6e70 7574 5f67 7261 6420 3d20     input_grad = 
-00016e70: 6675 6c6c 5f6c 696b 6528 696e 7075 742c  full_like(input,
-00016e80: 2066 696c 6c5f 7661 6c75 653d 3029 0a20   fill_value=0). 
-00016e90: 2020 2020 2020 2077 6569 6768 745f 6772         weight_gr
-00016ea0: 6164 203d 2066 756c 6c5f 6c69 6b65 2877  ad = full_like(w
-00016eb0: 6569 6768 742c 2066 696c 6c5f 7661 6c75  eight, fill_valu
-00016ec0: 653d 3029 0a20 2020 2020 2020 2069 6620  e=0).        if 
-00016ed0: 6269 6173 2069 7320 6e6f 7420 4e6f 6e65  bias is not None
-00016ee0: 3a0a 2020 2020 2020 2020 2020 2020 6269  :.            bi
-00016ef0: 6173 5f67 7261 6420 3d20 6675 6c6c 5f6c  as_grad = full_l
-00016f00: 696b 6528 6269 6173 2c20 6669 6c6c 5f76  ike(bias, fill_v
-00016f10: 616c 7565 3d30 290a 2020 2020 2020 2020  alue=0).        
-00016f20: 7265 7475 726e 2028 696e 7075 745f 6772  return (input_gr
-00016f30: 6164 2c20 7765 6967 6874 5f67 7261 642c  ad, weight_grad,
-00016f40: 2062 6961 735f 6772 6164 2920 2b20 2828   bias_grad) + ((
-00016f50: 4e6f 6e65 2c29 202a 2036 290a 0a20 2020  None,) * 6)..   
-00016f60: 2062 6174 6368 2c20 696e 5f63 6861 6e6e   batch, in_chann
-00016f70: 656c 732c 202a 7370 6174 6961 6c5f 6469  els, *spatial_di
-00016f80: 6d73 203d 2069 6e70 7574 2e73 6861 7065  ms = input.shape
-00016f90: 0a20 2020 206f 7574 5f63 6861 6e6e 656c  .    out_channel
-00016fa0: 732c 2067 696e 5f63 6861 6e6e 656c 732c  s, gin_channels,
-00016fb0: 202a 6b65 726e 656c 5f64 696d 7320 3d20   *kernel_dims = 
-00016fc0: 7765 6967 6874 2e73 6861 7065 0a20 2020  weight.shape.   
-00016fd0: 2064 696d 203d 206c 656e 2873 7061 7469   dim = len(spati
-00016fe0: 616c 5f64 696d 7329 0a0a 2020 2020 6465  al_dims)..    de
-00016ff0: 6620 6d61 7962 655f 6578 7061 6e64 5f73  f maybe_expand_s
-00017000: 6571 2873 2c20 6469 6d29 3a0a 2020 2020  eq(s, dim):.    
-00017010: 2020 2020 6966 206c 656e 2873 2920 3d3d      if len(s) ==
-00017020: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-00017030: 7265 7475 726e 2028 735b 305d 2c29 202a  return (s[0],) *
-00017040: 2064 696d 0a20 2020 2020 2020 2065 6c73   dim.        els
-00017050: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00017060: 6574 7572 6e20 730a 0a20 2020 2073 7472  eturn s..    str
-00017070: 6964 6520 3d20 6d61 7962 655f 6578 7061  ide = maybe_expa
-00017080: 6e64 5f73 6571 2873 7472 6964 652c 2064  nd_seq(stride, d
-00017090: 696d 290a 2020 2020 7061 6464 696e 6720  im).    padding 
-000170a0: 3d20 6d61 7962 655f 6578 7061 6e64 5f73  = maybe_expand_s
-000170b0: 6571 2870 6164 6469 6e67 2c20 6469 6d29  eq(padding, dim)
-000170c0: 0a20 2020 2064 696c 6174 696f 6e20 3d20  .    dilation = 
-000170d0: 6d61 7962 655f 6578 7061 6e64 5f73 6571  maybe_expand_seq
-000170e0: 2864 696c 6174 696f 6e2c 2064 696d 290a  (dilation, dim).
-000170f0: 0a20 2020 2064 6566 2063 6f6e 765f 7472  .    def conv_tr
-00017100: 616e 7370 6f73 6528 7429 3a0a 2020 2020  anspose(t):.    
-00017110: 2020 2020 7265 7475 726e 2070 7269 6d73      return prims
-00017120: 2e74 7261 6e73 706f 7365 2874 2c20 2831  .transpose(t, (1
-00017130: 2c20 3029 202b 2074 7570 6c65 2872 616e  , 0) + tuple(ran
-00017140: 6765 2832 2c20 742e 6e64 696d 2929 290a  ge(2, t.ndim))).
-00017150: 0a20 2020 2023 2069 6e70 7574 5f67 7261  .    # input_gra
-00017160: 6420 3d20 7b0a 2020 2020 6465 6620 7472  d = {.    def tr
-00017170: 616e 7370 6f73 655f 616e 645f 666c 6970  anspose_and_flip
-00017180: 5f77 6569 6768 7428 7765 6967 6874 293a  _weight(weight):
-00017190: 0a20 2020 2020 2020 2023 2054 6865 206c  .        # The l
-000171a0: 696e 6573 2062 656c 6f77 2061 7265 2074  ines below are t
-000171b0: 7261 6e73 706f 7369 6e67 2074 6865 2063  ransposing the c
-000171c0: 6861 6e6e 656c 7320 6469 6d73 2e0a 2020  hannels dims..  
-000171d0: 2020 2020 2020 2320 5765 2061 6c73 6f20        # We also 
-000171e0: 6e65 6564 2074 6f20 6578 7472 6163 7420  need to extract 
-000171f0: 7468 6520 6772 6f75 7020 696e 666f 726d  the group inform
-00017200: 6174 696f 6e20 616e 6420 6d65 7267 6520  ation and merge 
-00017210: 6974 0a20 2020 2020 2020 2023 2077 6974  it.        # wit
-00017220: 6820 7468 6520 6469 6d65 6e73 696f 6e20  h the dimension 
-00017230: 636f 7272 6573 706f 6e64 696e 6720 746f  corresponding to
-00017240: 2074 6865 2022 6f75 745f 6368 616e 6e65   the "out_channe
-00017250: 6c73 2220 6469 6d2e 0a20 2020 2020 2020  ls" dim..       
-00017260: 2023 2028 6f75 745f 6368 616e 6e65 6c73   # (out_channels
-00017270: 2c20 6769 6e5f 6368 616e 6e65 6c73 2920  , gin_channels) 
-00017280: 2d3e 2028 6769 6e5f 6368 616e 6e65 6c73  -> (gin_channels
-00017290: 2c20 6f75 745f 6368 616e 6e65 6c73 290a  , out_channels).
-000172a0: 2020 2020 2020 2020 7765 6967 6874 203d          weight =
-000172b0: 2063 6f6e 765f 7472 616e 7370 6f73 6528   conv_transpose(
-000172c0: 7765 6967 6874 290a 2020 2020 2020 2020  weight).        
-000172d0: 2320 5370 6c69 7420 286f 7574 5f63 6861  # Split (out_cha
-000172e0: 6e6e 656c 732c 2920 2d3e 2028 6772 6f75  nnels,) -> (grou
-000172f0: 7073 2c20 6f75 745f 6368 616e 6e65 6c73  ps, out_channels
-00017300: 202f 2f20 6772 6f75 7073 290a 2020 2020   // groups).    
-00017310: 2020 2020 7765 6967 6874 203d 2077 6569      weight = wei
-00017320: 6768 742e 7265 7368 6170 6528 5b67 696e  ght.reshape([gin
-00017330: 5f63 6861 6e6e 656c 732c 2067 726f 7570  _channels, group
-00017340: 732c 206f 7574 5f63 6861 6e6e 656c 7320  s, out_channels 
-00017350: 2f2f 2067 726f 7570 735d 202b 206b 6572  // groups] + ker
-00017360: 6e65 6c5f 6469 6d73 290a 2020 2020 2020  nel_dims).      
-00017370: 2020 2320 4d6f 7669 6e67 2067 726f 7570    # Moving group
-00017380: 7320 746f 2074 6865 206c 6566 742d 6d6f  s to the left-mo
-00017390: 7374 2070 6f73 6974 696f 6e2e 0a20 2020  st position..   
-000173a0: 2020 2020 2023 2028 6769 6e5f 6368 616e       # (gin_chan
-000173b0: 6e65 6c73 2c20 6772 6f75 7073 2c20 6f75  nels, groups, ou
-000173c0: 745f 6368 616e 6e65 6c73 202f 2f20 6772  t_channels // gr
-000173d0: 6f75 7073 2920 2d3e 2028 6772 6f75 7073  oups) -> (groups
-000173e0: 2c20 6769 6e5f 6368 616e 6e65 6c73 2c20  , gin_channels, 
-000173f0: 6f75 745f 6368 616e 6e65 6c73 202f 2f20  out_channels // 
-00017400: 6772 6f75 7073 290a 2020 2020 2020 2020  groups).        
-00017410: 7765 6967 6874 203d 2063 6f6e 765f 7472  weight = conv_tr
-00017420: 616e 7370 6f73 6528 7765 6967 6874 290a  anspose(weight).
-00017430: 2020 2020 2020 2020 2320 5371 7561 7368          # Squash
-00017440: 2028 6772 6f75 7073 2c20 6769 6e5f 6368   (groups, gin_ch
-00017450: 616e 6e65 6c73 2920 2d3e 2028 696e 5f63  annels) -> (in_c
-00017460: 6861 6e6e 656c 7329 0a20 2020 2020 2020  hannels).       
-00017470: 2077 6569 6768 7420 3d20 7765 6967 6874   weight = weight
-00017480: 2e72 6573 6861 7065 285b 696e 5f63 6861  .reshape([in_cha
-00017490: 6e6e 656c 732c 206f 7574 5f63 6861 6e6e  nnels, out_chann
-000174a0: 656c 7320 2f2f 2067 726f 7570 735d 202b  els // groups] +
-000174b0: 206b 6572 6e65 6c5f 6469 6d73 290a 0a20   kernel_dims).. 
-000174c0: 2020 2020 2020 2023 2046 6c69 7020 7370         # Flip sp
-000174d0: 6174 6961 6c20 6469 6d65 6e73 696f 6e73  atial dimensions
-000174e0: 0a20 2020 2020 2020 2077 6569 6768 7420  .        weight 
-000174f0: 3d20 7072 696d 732e 666c 6970 2877 6569  = prims.flip(wei
-00017500: 6768 742c 2074 7570 6c65 2872 616e 6765  ght, tuple(range
-00017510: 2832 2c20 7765 6967 6874 2e6e 6469 6d29  (2, weight.ndim)
-00017520: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
-00017530: 6e20 7765 6967 6874 0a0a 2020 2020 2320  n weight..    # 
-00017540: 5765 206e 6565 6420 746f 2070 6164 2074  We need to pad t
-00017550: 6865 2067 7261 6469 656e 7420 746f 2062  he gradient to b
-00017560: 6520 6162 6c65 2074 6f20 6669 7420 6b65  e able to fit ke
-00017570: 726e 656c 2077 696e 646f 7773 2e0a 2020  rnel windows..  
-00017580: 2020 696e 6974 6961 6c5f 6772 6164 5f70    initial_grad_p
-00017590: 6164 6469 6e67 203d 205b 6420 2a20 286b  adding = [d * (k
-000175a0: 202d 2031 2920 666f 7220 642c 206b 2069   - 1) for d, k i
-000175b0: 6e20 7a69 7028 6469 6c61 7469 6f6e 2c20  n zip(dilation, 
-000175c0: 6b65 726e 656c 5f64 696d 7329 5d0a 0a20  kernel_dims)].. 
-000175d0: 2020 2069 6e70 7574 5f67 7261 6420 3d20     input_grad = 
-000175e0: 636f 6e76 6f6c 7574 696f 6e28 0a20 2020  convolution(.   
-000175f0: 2020 2020 2070 7269 6d73 2e70 6164 280a       prims.pad(.
-00017600: 2020 2020 2020 2020 2020 2020 6772 6164              grad
-00017610: 2c0a 2020 2020 2020 2020 2020 2020 302e  ,.            0.
-00017620: 302c 0a20 2020 2020 2020 2020 2020 2023  0,.            #
-00017630: 2054 6865 2070 6978 6573 2061 7265 2073   The pixes are s
-00017640: 7472 6964 6520 6177 6179 2066 726f 6d20  tride away from 
-00017650: 6561 6368 206f 7468 6572 2069 6e20 7468  each other in th
-00017660: 6520 6f72 6967 696e 616c 2069 6e70 7574  e original input
-00017670: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00017680: 4865 6e63 6520 7765 206e 6565 6420 746f  Hence we need to
-00017690: 2064 696c 6174 6520 7468 6520 6772 6164   dilate the grad
-000176a0: 6965 6e74 2062 7920 6469 6c61 7469 6f6e  ient by dilation
-000176b0: 3d73 7472 6964 6520 2d20 310a 2020 2020  =stride - 1.    
-000176c0: 2020 2020 2020 2020 2320 736f 2074 6861          # so tha
-000176d0: 7420 7468 6572 6520 6172 6520 7374 7269  t there are stri
-000176e0: 6465 202d 2031 207a 6572 6f73 2062 6574  de - 1 zeros bet
-000176f0: 7765 656e 2074 6865 2070 6978 656c 732e  ween the pixels.
-00017700: 0a20 2020 2020 2020 2020 2020 205b 2830  .            [(0
-00017710: 2c20 302c 2030 292c 2028 302c 2030 2c20  , 0, 0), (0, 0, 
-00017720: 3029 5d20 2b20 5b28 302c 2030 2c20 7320  0)] + [(0, 0, s 
-00017730: 2d20 3129 2066 6f72 2073 2069 6e20 7374  - 1) for s in st
-00017740: 7269 6465 5d2c 0a20 2020 2020 2020 2029  ride],.        )
-00017750: 2c0a 2020 2020 2020 2020 7472 616e 7370  ,.        transp
-00017760: 6f73 655f 616e 645f 666c 6970 5f77 6569  ose_and_flip_wei
-00017770: 6768 7428 7765 6967 6874 292c 0a20 2020  ght(weight),.   
-00017780: 2020 2020 204e 6f6e 652c 0a20 2020 2020       None,.     
-00017790: 2020 2023 2053 6574 7469 6e67 2073 7472     # Setting str
-000177a0: 6964 6520 746f 2031 2061 7320 7468 6520  ide to 1 as the 
-000177b0: 6469 7374 616e 6365 2062 6574 7765 656e  distance between
-000177c0: 2070 6978 656c 7320 6973 2074 616b 656e   pixels is taken
-000177d0: 0a20 2020 2020 2020 2023 2063 6172 6520  .        # care 
-000177e0: 6279 2074 6865 2070 6164 2072 6967 6874  by the pad right
-000177f0: 2061 626f 7665 2e0a 2020 2020 2020 2020   above..        
-00017800: 2831 2c29 2c0a 2020 2020 2020 2020 696e  (1,),.        in
-00017810: 6974 6961 6c5f 6772 6164 5f70 6164 6469  itial_grad_paddi
-00017820: 6e67 2c0a 2020 2020 2020 2020 6469 6c61  ng,.        dila
-00017830: 7469 6f6e 2c0a 2020 2020 2020 2020 7472  tion,.        tr
-00017840: 616e 7370 6f73 6564 2c0a 2020 2020 2020  ansposed,.      
-00017850: 2020 6f75 7470 7574 5f70 6164 6469 6e67    output_padding
-00017860: 2c0a 2020 2020 2020 2020 6772 6f75 7073  ,.        groups
-00017870: 2c0a 2020 2020 290a 0a20 2020 2064 6566  ,.    )..    def
-00017880: 2070 6164 5f74 6f5f 696e 7075 7428 6772   pad_to_input(gr
-00017890: 6164 293a 0a20 2020 2020 2020 2023 2057  ad):.        # W
-000178a0: 6520 6e65 6564 2074 6f20 756e 7061 6420  e need to unpad 
-000178b0: 7468 6520 7061 6464 696e 6720 646f 6e65  the padding done
-000178c0: 2074 6f20 7468 6520 696e 7075 7420 7072   to the input pr
-000178d0: 696f 7220 746f 2074 6865 2063 6f6e 766f  ior to the convo
-000178e0: 6c75 7469 6f6e 2e0a 2020 2020 2020 2020  lution..        
-000178f0: 2320 4e6f 7465 2074 6861 7420 6c6f 7720  # Note that low 
-00017900: 616e 6420 6869 6768 2070 6164 6469 6e67  and high padding
-00017910: 2061 7265 206e 6f74 206e 6563 6573 7361   are not necessa
-00017920: 7269 6c79 2065 7175 616c 2c20 736f 2077  rily equal, so w
-00017930: 6520 6361 6e6e 6f74 0a20 2020 2020 2020  e cannot.       
-00017940: 2023 2061 6273 6f72 6220 6974 2069 6e74   # absorb it int
-00017950: 6f20 7468 6520 636f 6e76 6f6c 7574 696f  o the convolutio
-00017960: 6e20 6a75 7374 2079 6574 2c20 756e 6c65  n just yet, unle
-00017970: 7373 2074 6865 2041 5049 2069 7320 6d6f  ss the API is mo
-00017980: 6469 6669 6564 2e0a 2020 2020 2020 2020  dified..        
-00017990: 7061 645f 636f 6e66 6967 203d 205b 2830  pad_config = [(0
-000179a0: 2c20 302c 2030 292c 2028 302c 2030 2c20  , 0, 0), (0, 0, 
-000179b0: 3029 5d0a 2020 2020 2020 2020 666f 7220  0)].        for 
-000179c0: 6f2c 2069 2c20 672c 2070 2069 6e20 7a69  o, i, g, p in zi
-000179d0: 7028 6772 6164 2e73 6861 7065 5b32 3a5d  p(grad.shape[2:]
-000179e0: 2c20 7370 6174 6961 6c5f 6469 6d73 2c20  , spatial_dims, 
-000179f0: 696e 7075 745f 6772 6164 2e73 6861 7065  input_grad.shape
-00017a00: 5b32 3a5d 2c20 7061 6464 696e 6729 3a0a  [2:], padding):.
-00017a10: 2020 2020 2020 2020 2020 2020 6c6f 203d              lo =
-00017a20: 202d 700a 2020 2020 2020 2020 2020 2020   -p.            
-00017a30: 2320 4e6f 7465 2074 6861 7420 2869 202b  # Note that (i +
-00017a40: 2032 202a 2070 2920 6973 2074 6865 2073   2 * p) is the s
-00017a50: 697a 6520 6f66 2074 6865 2070 6164 6465  ize of the padde
-00017a60: 6420 696e 7075 742c 0a20 2020 2020 2020  d input,.       
-00017a70: 2020 2020 2023 2073 6f20 7468 6520 7175       # so the qu
-00017a80: 616e 7469 7479 2028 6920 2b20 3220 2a20  antity (i + 2 * 
-00017a90: 7029 202d 2067 2074 656c 6c73 2075 7320  p) - g tells us 
-00017aa0: 6279 2068 6f77 206d 7563 680a 2020 2020  by how much.    
-00017ab0: 2020 2020 2020 2020 2320 7765 206e 6565          # we nee
-00017ac0: 6420 746f 2070 6164 2074 6865 2067 7261  d to pad the gra
-00017ad0: 6469 656e 7420 736f 2074 6861 7420 7468  dient so that th
-00017ae0: 6520 656c 656d 656e 7473 206f 7574 7369  e elements outsi
-00017af0: 6465 0a20 2020 2020 2020 2020 2020 2023  de.            #
-00017b00: 206f 6620 7468 6520 636f 6e76 6f6c 7574   of the convolut
-00017b10: 696f 6e20 7265 6365 6976 6520 7a65 726f  ion receive zero
-00017b20: 2067 7261 6469 656e 742e 0a20 2020 2020   gradient..     
-00017b30: 2020 2020 2020 2023 2070 2069 7320 6164         # p is ad
-00017b40: 6469 7469 6f6e 616c 6c79 2073 7562 7472  ditionally subtr
-00017b50: 6163 7465 6420 746f 206e 6567 6174 6520  acted to negate 
-00017b60: 7468 6520 696e 7075 7427 7320 7061 640a  the input's pad.
-00017b70: 2020 2020 2020 2020 2020 2020 2320 696e              # in
-00017b80: 2066 6f72 7761 7264 2e0a 2020 2020 2020   forward..      
-00017b90: 2020 2020 2020 6869 203d 2028 6920 2b20        hi = (i + 
-00017ba0: 3220 2a20 7029 202d 2067 202d 2070 0a20  2 * p) - g - p. 
-00017bb0: 2020 2020 2020 2020 2020 2070 6164 5f63             pad_c
-00017bc0: 6f6e 6669 672e 6170 7065 6e64 2828 6c6f  onfig.append((lo
-00017bd0: 2c20 6869 2c20 3029 290a 2020 2020 2020  , hi, 0)).      
-00017be0: 2020 7265 7475 726e 2070 7269 6d73 2e70    return prims.p
-00017bf0: 6164 2867 7261 642c 2030 2e30 2c20 7061  ad(grad, 0.0, pa
-00017c00: 645f 636f 6e66 6967 290a 0a20 2020 2069  d_config)..    i
-00017c10: 6e70 7574 5f67 7261 6420 3d20 7061 645f  nput_grad = pad_
-00017c20: 746f 5f69 6e70 7574 2869 6e70 7574 5f67  to_input(input_g
-00017c30: 7261 6429 0a20 2020 2023 207d 0a0a 2020  rad).    # }..  
-00017c40: 2020 2320 6269 6173 5f67 7261 6420 3d20    # bias_grad = 
-00017c50: 7b0a 2020 2020 6966 2062 6961 7320 6973  {.    if bias is
-00017c60: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00017c70: 2020 2069 6d70 6f72 7420 7468 756e 6465     import thunde
-00017c80: 722e 746f 7263 6820 6173 206c 746f 7263  r.torch as ltorc
-00017c90: 680a 0a20 2020 2020 2020 2062 6961 735f  h..        bias_
-00017ca0: 6772 6164 203d 206c 746f 7263 682e 7375  grad = ltorch.su
-00017cb0: 6d28 6772 6164 2c20 5b64 2066 6f72 2064  m(grad, [d for d
-00017cc0: 2069 6e20 7261 6e67 6528 6772 6164 2e6e   in range(grad.n
-00017cd0: 6469 6d29 2069 6620 6420 213d 2031 5d29  dim) if d != 1])
-00017ce0: 0a20 2020 2023 207d 0a0a 2020 2020 2320  .    # }..    # 
-00017cf0: 7765 6967 6874 2067 7261 6420 3d20 7b0a  weight grad = {.
-00017d00: 2020 2020 6465 6620 7061 645f 7472 616e      def pad_tran
-00017d10: 7370 6f73 655f 616e 645f 7075 7368 5f67  spose_and_push_g
-00017d20: 726f 7570 735f 696e 746f 5f62 6174 6368  roups_into_batch
-00017d30: 6573 2874 293a 0a20 2020 2020 2020 2023  es(t):.        #
-00017d40: 2046 6972 7374 2070 6164 2c2e 2e2e 0a20   First pad,.... 
-00017d50: 2020 2020 2020 2023 2050 6164 2061 7320         # Pad as 
-00017d60: 6e65 6365 7373 6172 7920 736f 2074 6861  necessary so tha
-00017d70: 7420 696e 2063 6f6e 766f 6c75 7469 6f6e  t in convolution
-00017d80: 7320 7765 206e 6576 6572 2061 6476 616e  s we never advan
-00017d90: 6365 0a20 2020 2020 2020 2023 2070 6173  ce.        # pas
-00017da0: 7420 7265 6c65 7661 6e74 2069 6e70 7574  t relevant input
-00017db0: 732e 0a20 2020 2020 2020 2070 6164 5f63  s..        pad_c
-00017dc0: 6f6e 6669 6720 3d20 5b28 302c 2030 2c20  onfig = [(0, 0, 
-00017dd0: 3029 2c20 2830 2c20 302c 2030 295d 0a20  0), (0, 0, 0)]. 
-00017de0: 2020 2020 2020 2066 6f72 206f 2c20 692c         for o, i,
-00017df0: 206b 2c20 702c 2073 2c20 6420 696e 207a   k, p, s, d in z
-00017e00: 6970 2867 7261 642e 7368 6170 655b 323a  ip(grad.shape[2:
-00017e10: 5d2c 2073 7061 7469 616c 5f64 696d 732c  ], spatial_dims,
-00017e20: 206b 6572 6e65 6c5f 6469 6d73 2c20 7061   kernel_dims, pa
-00017e30: 6464 696e 672c 2073 7472 6964 652c 2064  dding, stride, d
-00017e40: 696c 6174 696f 6e29 3a0a 2020 2020 2020  ilation):.      
-00017e50: 2020 2020 2020 2320 5061 6464 696e 6720        # Padding 
-00017e60: 6672 6f6d 2062 656c 6f77 2069 7320 7468  from below is th
-00017e70: 6520 7361 6d65 2e0a 2020 2020 2020 2020  e same..        
-00017e80: 2020 2020 6c6f 203d 2070 0a20 2020 2020      lo = p.     
-00017e90: 2020 2020 2020 2023 2054 6865 7265 2069         # There i
-00017ea0: 7320 616c 7761 7973 2074 6865 206d 6178  s always the max
-00017eb0: 2069 6e64 6578 2069 6478 2069 6e20 7468   index idx in th
-00017ec0: 6520 696e 7075 740a 2020 2020 2020 2020  e input.        
-00017ed0: 2020 2020 2320 7468 6520 7661 6c75 6520      # the value 
-00017ee0: 6f66 2077 6869 6368 2c20 696e 7075 745b  of which, input[
-00017ef0: 6964 785d 2c20 7468 6520 6b65 726e 656c  idx], the kernel
-00017f00: 2074 6f75 6368 6573 2e0a 2020 2020 2020   touches..      
-00017f10: 2020 2020 2020 2320 5468 6520 6b65 726e        # The kern
-00017f20: 656c 2072 6561 6368 2c20 6f72 206b 5f72  el reach, or k_r
-00017f30: 6561 6368 2c20 6973 2065 7861 6374 6c79  each, is exactly
-00017f40: 2069 6478 202b 2031 2e0a 2020 2020 2020   idx + 1..      
-00017f50: 2020 2020 2020 2320 5765 2075 7365 2069        # We use i
-00017f60: 7420 746f 2064 6563 6964 6520 6279 2068  t to decide by h
-00017f70: 6f77 206d 7563 6820 7765 206e 6565 6420  ow much we need 
-00017f80: 746f 2070 6164 2066 726f 6d20 6162 6f76  to pad from abov
-00017f90: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-00017fa0: 6173 2074 6f20 6e6f 7420 6d6f 7665 2070  as to not move p
-00017fb0: 6173 7420 7265 6c65 7661 6e74 2076 616c  ast relevant val
-00017fc0: 7565 732e 0a20 2020 2020 2020 2020 2020  ues..           
-00017fd0: 206b 5f72 6561 6368 203d 2028 6f20 2d20   k_reach = (o - 
-00017fe0: 3129 202a 2073 202b 2064 202a 2028 6b20  1) * s + d * (k 
-00017ff0: 2d20 3129 202b 2031 0a20 2020 2020 2020  - 1) + 1.       
-00018000: 2020 2020 2023 2054 6865 2070 6164 2066       # The pad f
-00018010: 726f 6d20 6162 6f76 6520 6571 7561 6c73  rom above equals
-00018020: 206b 5f72 6561 6368 206d 696e 7573 2074   k_reach minus t
-00018030: 6865 206c 656e 6774 680a 2020 2020 2020  he length.      
-00018040: 2020 2020 2020 2320 6f66 2074 6865 2069        # of the i
-00018050: 6e70 7574 2070 6164 6465 6420 6672 6f6d  nput padded from
-00018060: 2062 656c 6f77 2e0a 2020 2020 2020 2020   below..        
-00018070: 2020 2020 6869 203d 206b 5f72 6561 6368      hi = k_reach
-00018080: 202d 2028 6920 2b20 7029 0a20 2020 2020   - (i + p).     
-00018090: 2020 2020 2020 2070 6164 5f63 6f6e 6669         pad_confi
-000180a0: 672e 6170 7065 6e64 2828 6c6f 2c20 6869  g.append((lo, hi
-000180b0: 2c20 3029 290a 2020 2020 2020 2020 7420  , 0)).        t 
-000180c0: 3d20 7072 696d 732e 7061 6428 742c 2030  = prims.pad(t, 0
-000180d0: 2e30 2c20 7061 645f 636f 6e66 6967 290a  .0, pad_config).
-000180e0: 0a20 2020 2020 2020 205f 2c20 5f2c 202a  .        _, _, *
-000180f0: 745f 7370 6174 6961 6c5f 6469 6d73 203d  t_spatial_dims =
-00018100: 2074 2e73 6861 7065 0a0a 2020 2020 2020   t.shape..      
-00018110: 2020 2320 2e2e 2e20 7468 656e 2064 6f20    # ... then do 
-00018120: 7468 6520 7265 7374 2e0a 2020 2020 2020  the rest..      
-00018130: 2020 2320 742e 7368 6170 6520 3d3d 2028    # t.shape == (
-00018140: 6261 7463 682c 2069 6e5f 6368 616e 6e65  batch, in_channe
-00018150: 6c73 2c20 2e2e 2e29 0a20 2020 2020 2020  ls, ...).       
-00018160: 2023 2054 6865 2072 6573 756c 7420 6f66   # The result of
-00018170: 2074 6869 7320 6675 6e63 7469 6f6e 2068   this function h
-00018180: 6173 2073 6861 7065 0a20 2020 2020 2020  as shape.       
-00018190: 2023 2028 696e 5f63 6861 6e6e 656c 732c   # (in_channels,
-000181a0: 2062 6174 6368 202a 2067 726f 7570 7329   batch * groups)
-000181b0: 0a20 2020 2020 2020 2023 2028 6261 7463  .        # (batc
-000181c0: 682c 2069 6e5f 6368 616e 6e65 6c73 2920  h, in_channels) 
-000181d0: 2d3e 2028 696e 5f63 6861 6e6e 656c 732c  -> (in_channels,
-000181e0: 2062 6174 6368 290a 2020 2020 2020 2020   batch).        
-000181f0: 7420 3d20 636f 6e76 5f74 7261 6e73 706f  t = conv_transpo
-00018200: 7365 2874 290a 2020 2020 2020 2020 2320  se(t).        # 
-00018210: 5370 6c69 7420 2869 6e5f 6368 616e 6e65  Split (in_channe
-00018220: 6c73 2c29 202d 3e20 2867 726f 7570 732c  ls,) -> (groups,
-00018230: 2067 696e 5f63 6861 6e6e 656c 7329 0a20   gin_channels). 
-00018240: 2020 2020 2020 2074 203d 2074 2e72 6573         t = t.res
-00018250: 6861 7065 285b 6772 6f75 7073 2c20 6769  hape([groups, gi
-00018260: 6e5f 6368 616e 6e65 6c73 2c20 6261 7463  n_channels, batc
-00018270: 685d 202b 2074 5f73 7061 7469 616c 5f64  h] + t_spatial_d
-00018280: 696d 7329 0a20 2020 2020 2020 2023 2054  ims).        # T
-00018290: 7261 6e73 706f 7365 2028 6772 6f75 7073  ranspose (groups
-000182a0: 2c20 6769 6e5f 6368 616e 6e65 6c73 2c20  , gin_channels, 
-000182b0: 6261 7463 6829 202d 3e20 2867 696e 5f63  batch) -> (gin_c
-000182c0: 6861 6e6e 656c 732c 2067 726f 7570 732c  hannels, groups,
-000182d0: 2062 6174 6368 290a 2020 2020 2020 2020   batch).        
-000182e0: 7420 3d20 636f 6e76 5f74 7261 6e73 706f  t = conv_transpo
-000182f0: 7365 2874 290a 2020 2020 2020 2020 2320  se(t).        # 
-00018300: 466c 6174 7465 6e20 2867 726f 7570 732c  Flatten (groups,
-00018310: 2062 6174 6368 2920 2d3e 2028 6772 6f75   batch) -> (grou
-00018320: 7073 202a 2062 6174 6368 2c29 0a20 2020  ps * batch,).   
-00018330: 2020 2020 2074 203d 2074 2e72 6573 6861       t = t.resha
-00018340: 7065 285b 6769 6e5f 6368 616e 6e65 6c73  pe([gin_channels
-00018350: 2c20 6772 6f75 7073 202a 2062 6174 6368  , groups * batch
-00018360: 5d20 2b20 745f 7370 6174 6961 6c5f 6469  ] + t_spatial_di
-00018370: 6d73 290a 2020 2020 2020 2020 7265 7475  ms).        retu
-00018380: 726e 2074 0a0a 2020 2020 2320 696e 7075  rn t..    # inpu
-00018390: 7420 7769 6c6c 2068 6176 6520 7368 6170  t will have shap
-000183a0: 6520 2867 696e 5f63 6861 6e6e 656c 732c  e (gin_channels,
-000183b0: 2067 726f 7570 7320 2a20 6261 7463 6829   groups * batch)
-000183c0: 0a20 2020 2069 6e70 7574 203d 2070 6164  .    input = pad
-000183d0: 5f74 7261 6e73 706f 7365 5f61 6e64 5f70  _transpose_and_p
-000183e0: 7573 685f 6772 6f75 7073 5f69 6e74 6f5f  ush_groups_into_
-000183f0: 6261 7463 6865 7328 696e 7075 7429 0a20  batches(input). 
-00018400: 2020 2023 2067 7261 6420 7769 6c6c 2068     # grad will h
-00018410: 6176 6520 7368 6170 6520 286f 7574 5f63  ave shape (out_c
-00018420: 6861 6e6e 656c 732c 2062 6174 6368 290a  hannels, batch).
-00018430: 2020 2020 2320 4e6f 7465 2074 6861 7420      # Note that 
-00018440: 7468 6573 6520 7368 6170 6573 2061 7265  these shapes are
-00018450: 2063 6f6d 7061 7469 626c 6520 666f 7220   compatible for 
-00018460: 6120 6772 6f75 7020 636f 6e76 6f6c 7574  a group convolut
-00018470: 696f 6e2e 0a20 2020 2067 7261 6420 3d20  ion..    grad = 
-00018480: 636f 6e76 5f74 7261 6e73 706f 7365 2867  conv_transpose(g
-00018490: 7261 6429 0a0a 2020 2020 2320 5768 7920  rad)..    # Why 
-000184a0: 646f 2077 6520 666c 6970 2073 7472 6964  do we flip strid
-000184b0: 6520 616e 6420 6469 6c61 7469 6f6e 3f0a  e and dilation?.
-000184c0: 2020 2020 2320 6b65 726e 656c 5b69 5d20      # kernel[i] 
-000184d0: 616e 6420 6b65 726e 656c 5b69 202b 2031  and kernel[i + 1
-000184e0: 5d20 6172 6520 6469 6c61 7469 6f6e 2061  ] are dilation a
-000184f0: 7061 7274 2066 726f 6d20 6561 6368 206f  part from each o
-00018500: 7468 6572 2c0a 2020 2020 2320 736f 2064  ther,.    # so d
-00018510: 696c 6174 696f 6e20 6265 636f 6d65 7320  ilation becomes 
-00018520: 7468 6520 6e65 7720 7374 7269 6465 2e0a  the new stride..
-00018530: 2020 2020 2320 416c 6c20 7468 6520 656c      # All the el
-00018540: 656d 656e 7473 2074 6861 7420 6b65 726e  ements that kern
-00018550: 656c 5b69 5d20 746f 7563 6865 7320 6172  el[i] touches ar
-00018560: 6520 7374 7269 6465 2061 7761 7920 6672  e stride away fr
-00018570: 6f6d 2065 6163 6820 6f74 6865 722c 0a20  om each other,. 
-00018580: 2020 2023 2068 656e 6365 2073 7472 6964     # hence strid
-00018590: 6520 6265 636f 6d65 7320 7468 6520 6e65  e becomes the ne
-000185a0: 7720 6469 6c61 7469 6f6e 2e0a 2020 2020  w dilation..    
-000185b0: 7765 6967 6874 5f67 7261 6420 3d20 636f  weight_grad = co
-000185c0: 6e76 6f6c 7574 696f 6e28 0a20 2020 2020  nvolution(.     
-000185d0: 2020 2069 6e70 7574 2c0a 2020 2020 2020     input,.      
-000185e0: 2020 6772 6164 2c0a 2020 2020 2020 2020    grad,.        
-000185f0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6469  None,.        di
-00018600: 6c61 7469 6f6e 2c20 2023 2073 6574 2073  lation,  # set s
-00018610: 7472 6964 653d 6469 6c61 7469 6f6e 0a20  tride=dilation. 
-00018620: 2020 2020 2020 2028 302c 292c 0a20 2020         (0,),.   
-00018630: 2020 2020 2073 7472 6964 652c 2020 2320       stride,  # 
-00018640: 7365 7420 6469 6c61 7469 6f6e 3d73 7472  set dilation=str
-00018650: 6964 650a 2020 2020 2020 2020 7472 616e  ide.        tran
-00018660: 7370 6f73 6564 2c0a 2020 2020 2020 2020  sposed,.        
-00018670: 6f75 7470 7574 5f70 6164 6469 6e67 2c0a  output_padding,.
-00018680: 2020 2020 2020 2020 6772 6f75 7073 2c0a          groups,.
-00018690: 2020 2020 290a 0a20 2020 2023 2054 6865      )..    # The
-000186a0: 2072 6573 756c 7420 6f66 2074 6865 2063   result of the c
-000186b0: 6f6e 766f 6c75 7469 6f6e 2068 6173 2073  onvolution has s
-000186c0: 6861 7065 2028 6769 6e5f 6368 616e 6e65  hape (gin_channe
-000186d0: 6c73 2c20 6f75 745f 6368 616e 6e65 6c73  ls, out_channels
-000186e0: 292c 0a20 2020 2023 2073 6f20 7472 616e  ),.    # so tran
-000186f0: 7370 6f73 6974 696f 6e20 6973 2072 6571  sposition is req
-00018700: 7569 7265 642e 0a20 2020 2077 6569 6768  uired..    weigh
-00018710: 745f 6772 6164 203d 2063 6f6e 765f 7472  t_grad = conv_tr
-00018720: 616e 7370 6f73 6528 7765 6967 6874 5f67  anspose(weight_g
-00018730: 7261 6429 0a20 2020 2023 207d 0a0a 2020  rad).    # }..  
-00018740: 2020 7265 7475 726e 2028 696e 7075 745f    return (input_
-00018750: 6772 6164 2c20 7765 6967 6874 5f67 7261  grad, weight_gra
-00018760: 642c 2062 6961 735f 6772 6164 290a 0a0a  d, bias_grad)...
-00018770: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
-00018780: 7465 645f 666f 7277 6172 6428 2274 6f72  ted_forward("tor
-00018790: 6368 2e6c 6f67 5f73 6f66 746d 6178 2229  ch.log_softmax")
-000187a0: 0a64 6566 206c 6f67 5f73 6f66 746d 6178  .def log_softmax
-000187b0: 5f61 7567 5f66 7764 2869 6e70 7574 3a20  _aug_fwd(input: 
-000187c0: 5465 6e73 6f72 5072 6f78 792c 2064 696d  TensorProxy, dim
-000187d0: 3a20 696e 742c 202a 2c20 6474 7970 653d  : int, *, dtype=
-000187e0: 4e6f 6e65 2920 2d3e 2056 4a50 4475 616c  None) -> VJPDual
-000187f0: 3a0a 2020 2020 6672 6f6d 2074 6875 6e64  :.    from thund
-00018800: 6572 2e74 6f72 6368 2069 6d70 6f72 7420  er.torch import 
-00018810: 6c6f 675f 736f 6674 6d61 780a 0a20 2020  log_softmax..   
-00018820: 2070 7269 6d61 6c20 3d20 6c6f 675f 736f   primal = log_so
-00018830: 6674 6d61 7828 696e 7075 742c 2064 696d  ftmax(input, dim
-00018840: 3d64 696d 2c20 6474 7970 653d 6474 7970  =dim, dtype=dtyp
-00018850: 6529 0a20 2020 2072 6573 6964 7561 6c73  e).    residuals
-00018860: 203d 2028 7072 696d 616c 2c20 6469 6d2c   = (primal, dim,
-00018870: 2069 6e70 7574 2e64 7479 7065 290a 2020   input.dtype).  
-00018880: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
-00018890: 2870 7269 6d61 6c2c 2072 6573 6964 7561  (primal, residua
-000188a0: 6c73 290a 0a0a 4072 6567 6973 7465 725f  ls)...@register_
-000188b0: 6261 636b 7761 7264 2822 746f 7263 682e  backward("torch.
-000188c0: 6c6f 675f 736f 6674 6d61 7822 290a 6465  log_softmax").de
-000188d0: 6620 6c6f 675f 736f 6674 6d61 785f 6261  f log_softmax_ba
-000188e0: 636b 7761 7264 2870 7269 6d61 6c2c 2064  ckward(primal, d
-000188f0: 696d 2c20 6474 7970 652c 2067 293a 0a20  im, dtype, g):. 
-00018900: 2020 2066 726f 6d20 7468 756e 6465 722e     from thunder.
-00018910: 746f 7263 6820 696d 706f 7274 206c 6f67  torch import log
-00018920: 5f73 6f66 746d 6178 5f62 6163 6b77 6172  _softmax_backwar
-00018930: 640a 0a20 2020 2072 6574 7572 6e20 6c6f  d..    return lo
-00018940: 675f 736f 6674 6d61 785f 6261 636b 7761  g_softmax_backwa
-00018950: 7264 2867 2c20 7072 696d 616c 2c20 6469  rd(g, primal, di
-00018960: 6d2c 2064 7479 7065 290a 0a0a 4072 6567  m, dtype)...@reg
-00018970: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
-00018980: 666f 7277 6172 6428 2274 6f72 6368 2e6e  forward("torch.n
-00018990: 6e2e 6675 6e63 7469 6f6e 616c 2e6e 6c6c  n.functional.nll
-000189a0: 5f6c 6f73 7322 290a 6465 6620 6e6c 6c5f  _loss").def nll_
-000189b0: 6c6f 7373 5f61 7567 5f66 7764 280a 2020  loss_aug_fwd(.  
-000189c0: 2020 696e 7075 743a 2050 726f 7879 2c0a    input: Proxy,.
-000189d0: 2020 2020 7461 7267 6574 3a20 5072 6f78      target: Prox
-000189e0: 792c 0a20 2020 2077 6569 6768 743a 204e  y,.    weight: N
-000189f0: 6f6e 6520 7c20 5072 6f78 792c 0a20 2020  one | Proxy,.   
-00018a00: 2069 676e 6f72 655f 696e 6465 783a 2069   ignore_index: i
-00018a10: 6e74 2c0a 2020 2020 7265 6475 6374 696f  nt,.    reductio
-00018a20: 6e3a 2073 7472 2c0a 2920 2d3e 2056 4a50  n: str,.) -> VJP
-00018a30: 4475 616c 3a0a 2020 2020 6672 6f6d 2074  Dual:.    from t
-00018a40: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
-00018a50: 6f72 7420 5f6e 6c6c 5f6c 6f73 735f 6865  ort _nll_loss_he
-00018a60: 6c70 6572 0a0a 2020 2020 7072 696d 616c  lper..    primal
-00018a70: 2c20 746f 7461 6c5f 7765 6967 6874 203d  , total_weight =
-00018a80: 205f 6e6c 6c5f 6c6f 7373 5f68 656c 7065   _nll_loss_helpe
-00018a90: 7228 0a20 2020 2020 2020 2069 6e70 7574  r(.        input
-00018aa0: 2c0a 2020 2020 2020 2020 7461 7267 6574  ,.        target
-00018ab0: 2c0a 2020 2020 2020 2020 7765 6967 6874  ,.        weight
-00018ac0: 2c0a 2020 2020 2020 2020 6967 6e6f 7265  ,.        ignore
-00018ad0: 5f69 6e64 6578 2c0a 2020 2020 2020 2020  _index,.        
-00018ae0: 7265 6475 6374 696f 6e2c 0a20 2020 2029  reduction,.    )
-00018af0: 0a20 2020 2072 6573 6964 7561 6c73 203d  .    residuals =
-00018b00: 2028 696e 7075 742c 2074 6172 6765 742c   (input, target,
-00018b10: 2077 6569 6768 742c 2072 6564 7563 7469   weight, reducti
-00018b20: 6f6e 2c20 6967 6e6f 7265 5f69 6e64 6578  on, ignore_index
-00018b30: 2c20 746f 7461 6c5f 7765 6967 6874 290a  , total_weight).
-00018b40: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
-00018b50: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
-00018b60: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
-00018b70: 725f 6261 636b 7761 7264 2822 746f 7263  r_backward("torc
-00018b80: 682e 6e6e 2e66 756e 6374 696f 6e61 6c2e  h.nn.functional.
-00018b90: 6e6c 6c5f 6c6f 7373 2229 0a64 6566 206e  nll_loss").def n
-00018ba0: 6c6c 5f6c 6f73 735f 6261 636b 7761 7264  ll_loss_backward
-00018bb0: 2869 6e70 7574 2c20 7461 7267 6574 2c20  (input, target, 
-00018bc0: 7765 6967 6874 2c20 7265 6475 6374 696f  weight, reductio
-00018bd0: 6e2c 2069 676e 6f72 655f 696e 6465 782c  n, ignore_index,
-00018be0: 2074 6f74 616c 5f77 6569 6768 742c 2067   total_weight, g
-00018bf0: 293a 0a20 2020 2066 726f 6d20 7468 756e  ):.    from thun
-00018c00: 6465 722e 746f 7263 6820 696d 706f 7274  der.torch import
-00018c10: 206e 6c6c 5f6c 6f73 735f 6261 636b 7761   nll_loss_backwa
-00018c20: 7264 0a0a 2020 2020 6769 6e70 7574 203d  rd..    ginput =
-00018c30: 206e 6c6c 5f6c 6f73 735f 6261 636b 7761   nll_loss_backwa
-00018c40: 7264 2867 2c20 696e 7075 742c 2074 6172  rd(g, input, tar
-00018c50: 6765 742c 2077 6569 6768 742c 2072 6564  get, weight, red
-00018c60: 7563 7469 6f6e 2c20 6967 6e6f 7265 5f69  uction, ignore_i
-00018c70: 6e64 6578 2c20 746f 7461 6c5f 7765 6967  ndex, total_weig
-00018c80: 6874 290a 2020 2020 7265 7475 726e 2067  ht).    return g
-00018c90: 696e 7075 742c 202a 2828 4e6f 6e65 2c29  input, *((None,)
-00018ca0: 202a 2034 290a 0a0a 4072 6567 6973 7465   * 4)...@registe
-00018cb0: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
-00018cc0: 6172 6428 2274 6f72 6368 2e73 706c 6974  ard("torch.split
-00018cd0: 2229 0a64 6566 2073 706c 6974 5f61 7567  ").def split_aug
-00018ce0: 5f66 7764 2861 3a20 5465 6e73 6f72 5072  _fwd(a: TensorPr
-00018cf0: 6f78 792c 2073 706c 6974 5f73 697a 655f  oxy, split_size_
-00018d00: 6f72 5f73 6563 7469 6f6e 733a 2069 6e74  or_sections: int
-00018d10: 207c 2053 6571 7565 6e63 655b 696e 745d   | Sequence[int]
-00018d20: 2c20 6469 6d3a 2069 6e74 203d 2030 2920  , dim: int = 0) 
-00018d30: 2d3e 2056 4a50 4475 616c 3a0a 2020 2020  -> VJPDual:.    
-00018d40: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
-00018d50: 6368 2069 6d70 6f72 7420 7370 6c69 740a  ch import split.
-00018d60: 0a20 2020 2070 7269 6d61 6c20 3d20 7370  .    primal = sp
-00018d70: 6c69 7428 612c 2073 706c 6974 5f73 697a  lit(a, split_siz
-00018d80: 655f 6f72 5f73 6563 7469 6f6e 732c 2064  e_or_sections, d
-00018d90: 696d 290a 2020 2020 7265 7369 6475 616c  im).    residual
-00018da0: 7320 3d20 2864 696d 2c29 0a20 2020 2072  s = (dim,).    r
-00018db0: 6574 7572 6e20 564a 5044 7561 6c28 7072  eturn VJPDual(pr
-00018dc0: 696d 616c 2c20 7265 7369 6475 616c 7329  imal, residuals)
-00018dd0: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
-00018de0: 6b77 6172 6428 2274 6f72 6368 2e73 706c  kward("torch.spl
-00018df0: 6974 2229 0a64 6566 2073 706c 6974 5f62  it").def split_b
-00018e00: 6163 6b77 6172 6428 6469 6d2c 202a 6772  ackward(dim, *gr
-00018e10: 6164 7329 3a0a 2020 2020 6672 6f6d 2074  ads):.    from t
-00018e20: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
-00018e30: 6f72 7420 6361 740a 0a20 2020 2072 6574  ort cat..    ret
-00018e40: 7572 6e20 6361 7428 6772 6164 732c 2064  urn cat(grads, d
-00018e50: 696d 290a 0a0a 4072 6567 6973 7465 725f  im)...@register_
-00018e60: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-00018e70: 6428 2274 6f72 6368 2e6e 6e2e 6675 6e63  d("torch.nn.func
-00018e80: 7469 6f6e 616c 2e65 6d62 6564 6469 6e67  tional.embedding
-00018e90: 2229 0a64 6566 2065 6d62 6564 6469 6e67  ").def embedding
-00018ea0: 5f61 7567 5f66 7764 280a 2020 2020 613a  _aug_fwd(.    a:
-00018eb0: 2050 726f 7879 2c0a 2020 2020 7765 6967   Proxy,.    weig
-00018ec0: 6874 3a20 5072 6f78 792c 0a20 2020 2070  ht: Proxy,.    p
-00018ed0: 6164 6469 6e67 5f69 6478 3a20 696e 7420  adding_idx: int 
-00018ee0: 7c20 4e6f 6e65 2c0a 2020 2020 6d61 785f  | None,.    max_
-00018ef0: 6e6f 726d 3a20 666c 6f61 7420 7c20 4e6f  norm: float | No
-00018f00: 6e65 2c0a 2020 2020 6e6f 726d 5f74 7970  ne,.    norm_typ
-00018f10: 653a 2066 6c6f 6174 2c0a 2020 2020 7363  e: float,.    sc
-00018f20: 616c 655f 6772 6164 5f62 795f 6672 6571  ale_grad_by_freq
-00018f30: 3a20 626f 6f6c 2c0a 2020 2020 7370 6172  : bool,.    spar
-00018f40: 7365 3a20 626f 6f6c 2c0a 2920 2d3e 2056  se: bool,.) -> V
-00018f50: 4a50 4475 616c 3a0a 2020 2020 6672 6f6d  JPDual:.    from
-00018f60: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
-00018f70: 6d70 6f72 7420 656d 6265 6464 696e 670a  mport embedding.
-00018f80: 0a20 2020 2070 7269 6d61 6c20 3d20 656d  .    primal = em
-00018f90: 6265 6464 696e 6728 0a20 2020 2020 2020  bedding(.       
-00018fa0: 2061 2c0a 2020 2020 2020 2020 7765 6967   a,.        weig
-00018fb0: 6874 2c0a 2020 2020 2020 2020 7061 6464  ht,.        padd
-00018fc0: 696e 675f 6964 783d 7061 6464 696e 675f  ing_idx=padding_
-00018fd0: 6964 782c 0a20 2020 2020 2020 206d 6178  idx,.        max
-00018fe0: 5f6e 6f72 6d3d 6d61 785f 6e6f 726d 2c0a  _norm=max_norm,.
-00018ff0: 2020 2020 2020 2020 6e6f 726d 5f74 7970          norm_typ
-00019000: 653d 6e6f 726d 5f74 7970 652c 0a20 2020  e=norm_type,.   
-00019010: 2020 2020 2073 6361 6c65 5f67 7261 645f       scale_grad_
-00019020: 6279 5f66 7265 713d 7363 616c 655f 6772  by_freq=scale_gr
-00019030: 6164 5f62 795f 6672 6571 2c0a 2020 2020  ad_by_freq,.    
-00019040: 2020 2020 7370 6172 7365 3d73 7061 7273      sparse=spars
-00019050: 652c 0a20 2020 2029 0a20 2020 2072 6573  e,.    ).    res
-00019060: 6964 7561 6c73 203d 2028 612c 2077 6569  iduals = (a, wei
-00019070: 6768 742e 7368 6170 655b 305d 2c20 7061  ght.shape[0], pa
-00019080: 6464 696e 675f 6964 782c 2073 6361 6c65  dding_idx, scale
-00019090: 5f67 7261 645f 6279 5f66 7265 712c 2073  _grad_by_freq, s
-000190a0: 7061 7273 6529 0a20 2020 2072 6574 7572  parse).    retur
-000190b0: 6e20 564a 5044 7561 6c28 7072 696d 616c  n VJPDual(primal
-000190c0: 2c20 7265 7369 6475 616c 7329 0a0a 0a40  , residuals)...@
-000190d0: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
-000190e0: 6428 2274 6f72 6368 2e6e 6e2e 6675 6e63  d("torch.nn.func
-000190f0: 7469 6f6e 616c 2e65 6d62 6564 6469 6e67  tional.embedding
-00019100: 2229 0a64 6566 2065 6d62 6564 6469 6e67  ").def embedding
-00019110: 5f62 6163 6b77 6172 6428 612c 206e 756d  _backward(a, num
-00019120: 5f77 6569 6768 7473 2c20 7061 6464 696e  _weights, paddin
-00019130: 675f 6964 782c 2073 6361 6c65 5f67 7261  g_idx, scale_gra
-00019140: 645f 6279 5f66 7265 712c 2073 7061 7273  d_by_freq, spars
-00019150: 652c 2067 293a 0a20 2020 2066 726f 6d20  e, g):.    from 
-00019160: 7468 756e 6465 722e 746f 7263 6820 696d  thunder.torch im
-00019170: 706f 7274 2065 6d62 6564 6469 6e67 5f62  port embedding_b
-00019180: 6163 6b77 6172 640a 0a20 2020 2070 6164  ackward..    pad
-00019190: 6469 6e67 5f69 6478 203d 202d 3120 6966  ding_idx = -1 if
-000191a0: 2070 6164 6469 6e67 5f69 6478 2069 7320   padding_idx is 
-000191b0: 4e6f 6e65 2065 6c73 6520 7061 6464 696e  None else paddin
-000191c0: 675f 6964 780a 2020 2020 6777 6569 6768  g_idx.    gweigh
-000191d0: 7420 3d20 656d 6265 6464 696e 675f 6261  t = embedding_ba
-000191e0: 636b 7761 7264 2867 2c20 612c 206e 756d  ckward(g, a, num
-000191f0: 5f77 6569 6768 7473 2c20 7061 6464 696e  _weights, paddin
-00019200: 675f 6964 782c 2073 6361 6c65 5f67 7261  g_idx, scale_gra
-00019210: 645f 6279 5f66 7265 712c 2073 7061 7273  d_by_freq, spars
-00019220: 6529 0a20 2020 2072 6574 7572 6e20 6777  e).    return gw
-00019230: 6569 6768 740a 0a0a 4072 6567 6973 7465  eight...@registe
-00019240: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
-00019250: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
-00019260: 732e 4241 5443 485f 4e4f 524d 290a 6465  s.BATCH_NORM).de
-00019270: 6620 6261 7463 685f 6e6f 726d 5f61 7567  f batch_norm_aug
-00019280: 5f66 7764 280a 2020 2020 613a 2054 656e  _fwd(.    a: Ten
-00019290: 736f 7250 726f 7879 2c0a 2020 2020 7765  sorProxy,.    we
-000192a0: 6967 6874 3a20 4e6f 6e65 207c 2054 656e  ight: None | Ten
-000192b0: 736f 7250 726f 7879 2c0a 2020 2020 6269  sorProxy,.    bi
-000192c0: 6173 3a20 4e6f 6e65 207c 2054 656e 736f  as: None | Tenso
-000192d0: 7250 726f 7879 2c0a 2020 2020 7275 6e6e  rProxy,.    runn
-000192e0: 696e 675f 6d65 616e 3a20 4e6f 6e65 207c  ing_mean: None |
-000192f0: 2054 656e 736f 7250 726f 7879 2c0a 2020   TensorProxy,.  
-00019300: 2020 7275 6e6e 696e 675f 7661 723a 204e    running_var: N
-00019310: 6f6e 6520 7c20 5465 6e73 6f72 5072 6f78  one | TensorProx
-00019320: 792c 0a20 2020 2074 7261 696e 696e 673a  y,.    training:
-00019330: 2062 6f6f 6c2c 0a20 2020 206d 6f6d 656e   bool,.    momen
-00019340: 7475 6d3a 204e 756d 6265 722c 0a20 2020  tum: Number,.   
-00019350: 2065 7073 3a20 4e75 6d62 6572 2c0a 2920   eps: Number,.) 
-00019360: 2d3e 2056 4a50 4475 616c 3a0a 2020 2020  -> VJPDual:.    
-00019370: 7072 696d 616c 203d 2070 7269 6d73 2e62  primal = prims.b
-00019380: 6174 6368 5f6e 6f72 6d28 0a20 2020 2020  atch_norm(.     
-00019390: 2020 2061 2c0a 2020 2020 2020 2020 7765     a,.        we
-000193a0: 6967 6874 2c0a 2020 2020 2020 2020 6269  ight,.        bi
-000193b0: 6173 2c0a 2020 2020 2020 2020 7275 6e6e  as,.        runn
-000193c0: 696e 675f 6d65 616e 2c0a 2020 2020 2020  ing_mean,.      
-000193d0: 2020 7275 6e6e 696e 675f 7661 722c 0a20    running_var,. 
-000193e0: 2020 2020 2020 2074 7261 696e 696e 672c         training,
-000193f0: 0a20 2020 2020 2020 206d 6f6d 656e 7475  .        momentu
-00019400: 6d2c 0a20 2020 2020 2020 2065 7073 2c0a  m,.        eps,.
-00019410: 2020 2020 290a 2020 2020 6f75 7470 7574      ).    output
-00019420: 5f6d 6173 6b20 3d20 5b78 2069 7320 6e6f  _mask = [x is no
-00019430: 7420 4e6f 6e65 2066 6f72 2078 2069 6e20  t None for x in 
-00019440: 2861 2c20 7765 6967 6874 2c20 6269 6173  (a, weight, bias
-00019450: 295d 0a20 2020 206f 7574 7075 742c 2073  )].    output, s
-00019460: 6176 655f 6d65 616e 2c20 7361 7665 5f69  ave_mean, save_i
-00019470: 6e76 7374 6420 3d20 7072 696d 616c 0a20  nvstd = primal. 
-00019480: 2020 2072 6573 6964 7561 6c73 203d 2028     residuals = (
-00019490: 612c 2077 6569 6768 742c 2072 756e 6e69  a, weight, runni
-000194a0: 6e67 5f6d 6561 6e2c 2072 756e 6e69 6e67  ng_mean, running
-000194b0: 5f76 6172 2c20 7361 7665 5f6d 6561 6e2c  _var, save_mean,
-000194c0: 2073 6176 655f 696e 7673 7464 2c20 7472   save_invstd, tr
-000194d0: 6169 6e69 6e67 2c20 6570 732c 206f 7574  aining, eps, out
-000194e0: 7075 745f 6d61 736b 290a 2020 2020 7265  put_mask).    re
-000194f0: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
-00019500: 6d61 6c2c 2072 6573 6964 7561 6c73 290a  mal, residuals).
-00019510: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
-00019520: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
-00019530: 4473 2e42 4154 4348 5f4e 4f52 4d29 0a64  Ds.BATCH_NORM).d
-00019540: 6566 2062 6174 6368 5f6e 6f72 6d5f 6261  ef batch_norm_ba
-00019550: 636b 7761 7264 2861 2c20 7765 6967 6874  ckward(a, weight
-00019560: 2c20 7275 6e6e 696e 675f 6d65 616e 2c20  , running_mean, 
-00019570: 7275 6e6e 696e 675f 7661 722c 2073 6176  running_var, sav
-00019580: 655f 6d65 616e 2c20 7361 7665 5f69 6e76  e_mean, save_inv
-00019590: 7374 642c 2074 7261 696e 2c20 6570 732c  std, train, eps,
-000195a0: 206f 7574 7075 745f 6d61 736b 2c20 2a67   output_mask, *g
-000195b0: 7261 6473 293a 0a20 2020 2066 726f 6d20  rads):.    from 
-000195c0: 7468 756e 6465 722e 746f 7263 6820 696d  thunder.torch im
-000195d0: 706f 7274 2062 6174 6368 5f6e 6f72 6d5f  port batch_norm_
-000195e0: 6261 636b 7761 7264 0a0a 2020 2020 7265  backward..    re
-000195f0: 7375 6c74 203d 2062 6174 6368 5f6e 6f72  sult = batch_nor
-00019600: 6d5f 6261 636b 7761 7264 280a 2020 2020  m_backward(.    
-00019610: 2020 2020 6772 6164 735b 305d 2c20 612c      grads[0], a,
-00019620: 2077 6569 6768 742c 2072 756e 6e69 6e67   weight, running
-00019630: 5f6d 6561 6e2c 2072 756e 6e69 6e67 5f76  _mean, running_v
-00019640: 6172 2c20 7361 7665 5f6d 6561 6e2c 2073  ar, save_mean, s
-00019650: 6176 655f 696e 7673 7464 2c20 7472 6169  ave_invstd, trai
-00019660: 6e2c 2065 7073 2c20 6f75 7470 7574 5f6d  n, eps, output_m
-00019670: 6173 6b0a 2020 2020 290a 2020 2020 7265  ask.    ).    re
-00019680: 7475 726e 202a 7265 7375 6c74 2c20 4e6f  turn *result, No
-00019690: 6e65 2c20 4e6f 6e65 0a0a 0a40 7265 6769  ne, None...@regi
-000196a0: 7374 6572 5f61 7567 6d65 6e74 6564 5f66  ster_augmented_f
-000196b0: 6f72 7761 7264 2822 746f 7263 682e 6375  orward("torch.cu
-000196c0: 6d73 756d 2229 0a64 6566 2063 756d 7375  msum").def cumsu
-000196d0: 6d5f 6175 675f 6677 6428 613a 2050 726f  m_aug_fwd(a: Pro
-000196e0: 7879 2c20 6469 6d3a 2069 6e74 2c20 2a2c  xy, dim: int, *,
-000196f0: 2064 7479 7065 3a20 4e6f 6e65 207c 2064   dtype: None | d
-00019700: 7479 7065 732e 6474 7970 6520 3d20 4e6f  types.dtype = No
-00019710: 6e65 2920 2d3e 2056 4a50 4475 616c 3a0a  ne) -> VJPDual:.
-00019720: 2020 2020 6672 6f6d 2074 6875 6e64 6572      from thunder
-00019730: 2e74 6f72 6368 2069 6d70 6f72 7420 6375  .torch import cu
-00019740: 6d73 756d 0a0a 2020 2020 7072 696d 616c  msum..    primal
-00019750: 203d 2063 756d 7375 6d28 612c 2064 696d   = cumsum(a, dim
-00019760: 2c20 6474 7970 653d 6474 7970 6529 0a20  , dtype=dtype). 
-00019770: 2020 2072 6573 6964 7561 6c73 203d 2028     residuals = (
-00019780: 0a20 2020 2020 2020 2061 2e64 7479 7065  .        a.dtype
-00019790: 2c0a 2020 2020 2020 2020 6469 6d2c 0a20  ,.        dim,. 
-000197a0: 2020 2029 0a20 2020 2072 6574 7572 6e20     ).    return 
-000197b0: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
-000197c0: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
-000197d0: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
-000197e0: 2274 6f72 6368 2e63 756d 7375 6d22 290a  "torch.cumsum").
-000197f0: 6465 6620 6375 6d73 756d 5f62 6163 6b77  def cumsum_backw
-00019800: 6172 6428 615f 6474 7970 652c 2064 696d  ard(a_dtype, dim
-00019810: 2c20 6729 3a0a 2020 2020 6720 3d20 672e  , g):.    g = g.
-00019820: 746f 2861 5f64 7479 7065 290a 2020 2020  to(a_dtype).    
-00019830: 6966 2067 2e6e 756d 656c 203c 3d20 3120  if g.numel <= 1 
-00019840: 6f72 2067 2e73 6861 7065 5b64 696d 5d20  or g.shape[dim] 
-00019850: 3d3d 2031 3a0a 2020 2020 2020 2020 7265  == 1:.        re
-00019860: 7475 726e 2067 0a20 2020 2072 6574 7572  turn g.    retur
-00019870: 6e20 672e 666c 6970 2864 696d 292e 6375  n g.flip(dim).cu
-00019880: 6d73 756d 2864 696d 292e 666c 6970 2864  msum(dim).flip(d
-00019890: 696d 290a 0a0a 4072 6567 6973 7465 725f  im)...@register_
-000198a0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-000198b0: 6428 2274 6f72 6368 2e73 6f66 746d 6178  d("torch.softmax
-000198c0: 2229 0a64 6566 2073 6f66 746d 6178 5f61  ").def softmax_a
-000198d0: 7567 5f66 7764 2861 3a20 5072 6f78 792c  ug_fwd(a: Proxy,
-000198e0: 2064 696d 3a20 696e 742c 2064 7479 7065   dim: int, dtype
-000198f0: 3a20 6474 7970 6573 2e64 7479 7065 207c  : dtypes.dtype |
-00019900: 204e 6f6e 6520 3d20 4e6f 6e65 2920 2d3e   None = None) ->
-00019910: 2056 4a50 4475 616c 3a0a 2020 2020 6672   VJPDual:.    fr
-00019920: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
-00019930: 2069 6d70 6f72 7420 736f 6674 6d61 780a   import softmax.
-00019940: 0a20 2020 2070 7269 6d61 6c20 3d20 736f  .    primal = so
-00019950: 6674 6d61 7828 612c 2064 696d 2c20 6474  ftmax(a, dim, dt
-00019960: 7970 653d 6474 7970 6529 0a20 2020 2072  ype=dtype).    r
-00019970: 6573 6964 7561 6c73 203d 2028 7072 696d  esiduals = (prim
-00019980: 616c 2c20 6469 6d29 0a20 2020 2072 6574  al, dim).    ret
-00019990: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
-000199a0: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
-000199b0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
-000199c0: 6172 6428 2274 6f72 6368 2e73 6f66 746d  ard("torch.softm
-000199d0: 6178 2229 0a64 6566 2073 6f66 746d 6178  ax").def softmax
-000199e0: 5f62 6163 6b77 6172 6428 7072 696d 616c  _backward(primal
-000199f0: 2c20 6469 6d2c 2067 293a 0a20 2020 2072  , dim, g):.    r
-00019a00: 6574 7572 6e20 7072 696d 616c 202a 2028  eturn primal * (
-00019a10: 6720 2d20 2870 7269 6d61 6c20 2a20 6729  g - (primal * g)
-00019a20: 2e73 756d 2864 696d 2c20 6b65 6570 6469  .sum(dim, keepdi
-00019a30: 6d3d 5472 7565 2929 0a0a 0a64 6566 2069  m=True))...def i
-00019a40: 7465 725f 626f 756e 645f 7379 6d62 6f6c  ter_bound_symbol
-00019a50: 7328 626f 756e 645f 7379 6d62 6f6c 7329  s(bound_symbols)
-00019a60: 3a0a 2020 2020 2222 2249 7465 7261 7465  :.    """Iterate
-00019a70: 206f 7665 7220 626f 756e 6420 7379 6d62   over bound symb
-00019a80: 6f6c 732c 2073 6b69 7070 696e 6720 7379  ols, skipping sy
-00019a90: 6d62 6f6c 7320 7468 6174 2061 7265 206e  mbols that are n
-00019aa0: 6f74 2073 7570 706f 7274 6564 2062 790a  ot supported by.
-00019ab0: 2020 2020 7468 6520 7472 616e 7366 6f72      the transfor
-00019ac0: 6d73 2069 6e66 7261 7374 7275 6374 7572  ms infrastructur
-00019ad0: 652e 0a0a 2020 2020 4172 6773 3a0a 2020  e...    Args:.  
-00019ae0: 2020 2020 2020 626f 756e 645f 7379 6d62        bound_symb
-00019af0: 6f6c 7320 284c 6973 745b 426f 756e 6453  ols (List[BoundS
-00019b00: 796d 626f 6c5d 293a 204c 6973 7420 6f66  ymbol]): List of
-00019b10: 2062 6f75 6e64 2073 796d 626f 6c73 0a0a   bound symbols..
-00019b20: 2020 2020 5969 656c 6473 3a0a 2020 2020      Yields:.    
-00019b30: 2020 2020 426f 756e 6453 796d 626f 6c3a      BoundSymbol:
-00019b40: 2042 6f75 6e64 2073 796d 626f 6c73 2074   Bound symbols t
-00019b50: 6861 7420 6172 6520 7375 7070 6f72 7465  hat are supporte
-00019b60: 6420 6279 2074 6865 2074 7261 6e73 666f  d by the transfo
-00019b70: 726d 730a 2020 2020 2020 2020 696e 6672  rms.        infr
-00019b80: 6173 7472 7563 7475 7265 0a20 2020 2022  astructure.    "
-00019b90: 2222 0a20 2020 2066 6f72 2073 796d 626f  "".    for symbo
-00019ba0: 6c20 696e 2062 6f75 6e64 5f73 796d 626f  l in bound_symbo
-00019bb0: 6c73 3a0a 2020 2020 2020 2020 6966 2073  ls:.        if s
-00019bc0: 796d 626f 6c2e 7379 6d2e 6964 2069 6e20  ymbol.sym.id in 
-00019bd0: 7472 616e 7366 6f72 6d5f 736b 6970 5f6c  transform_skip_l
-00019be0: 6973 743a 0a20 2020 2020 2020 2020 2020  ist:.           
-00019bf0: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-00019c00: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00019c10: 2020 2020 7969 656c 6420 7379 6d62 6f6c      yield symbol
-00019c20: 0a0a 0a64 6566 2064 6563 6f6e 7374 7275  ...def deconstru
-00019c30: 6374 5f66 6f72 7761 7264 5f65 6e76 5f66  ct_forward_env_f
-00019c40: 6f72 5f62 6163 6b77 6172 6428 7472 6163  or_backward(trac
-00019c50: 652c 2065 6e76 293a 0a20 2020 2023 204e  e, env):.    # N
-00019c60: 6f74 6520 5b53 6176 696e 6720 7468 6520  ote [Saving the 
-00019c70: 666f 7277 6172 6420 656e 7669 726f 6e6d  forward environm
-00019c80: 656e 7420 696e 2074 6865 2062 6163 6b77  ent in the backw
-00019c90: 6172 6420 7275 6c65 5d0a 2020 2020 2320  ard rule].    # 
-00019ca0: 5765 2063 616e 6e6f 7420 7361 7665 2074  We cannot save t
-00019cb0: 6865 2074 7261 6365 206f 626a 6563 7420  he trace object 
-00019cc0: 696e 2074 6865 2072 6573 6964 7561 6c73  in the residuals
-00019cd0: 2062 6563 6175 7365 2065 7865 6375 746f   because executo
-00019ce0: 7273 206d 6179 206e 6f74 0a20 2020 2023  rs may not.    #
-00019cf0: 2062 6520 6162 6c65 2074 6f20 7265 7475   be able to retu
-00019d00: 726e 2069 7420 666f 7220 7468 6520 7370  rn it for the sp
-00019d10: 6c69 7474 6564 2066 6f72 7761 7264 2f62  litted forward/b
-00019d20: 6163 6b77 6172 6420 7061 7373 6573 2e20  ackward passes. 
-00019d30: 496e 7374 6561 642c 2077 650a 2020 2020  Instead, we.    
-00019d40: 2320 7361 7665 2061 7267 7320 616e 6420  # save args and 
-00019d50: 6b77 6172 6773 206f 6620 7468 6520 6f72  kwargs of the or
-00019d60: 6967 696e 616c 2066 756e 6374 696f 6e20  iginal function 
-00019d70: 6361 6c6c 2061 6e64 2072 6563 6f6e 7374  call and reconst
-00019d80: 7275 6374 2074 6865 0a20 2020 2023 2074  ruct the.    # t
-00019d90: 7261 6365 206f 626a 6563 7420 616e 6420  race object and 
-00019da0: 6974 7320 656e 7669 726f 6e6d 656e 7420  its environment 
-00019db0: 6469 6374 2069 6e20 7468 6520 6261 636b  dict in the back
-00019dc0: 7761 7264 2072 756c 652e 2048 6572 6520  ward rule. Here 
-00019dd0: 7765 2072 656c 790a 2020 2020 2320 6f6e  we rely.    # on
-00019de0: 2074 6865 2066 6163 7420 7468 6174 2074   the fact that t
-00019df0: 6865 206f 7264 6572 206f 6620 7468 6520  he order of the 
-00019e00: 7379 6d62 6f6c 7320 696e 2074 6865 2074  symbols in the t
-00019e10: 7261 6365 2069 7320 6465 7465 726d 696e  race is determin
-00019e20: 6973 7469 630a 2020 2020 2320 616e 6420  istic.    # and 
-00019e30: 616c 7761 7973 2074 6865 2073 616d 6520  always the same 
-00019e40: 666f 7220 7468 6520 7361 6d65 2066 756e  for the same fun
-00019e50: 6374 696f 6e20 6361 6c6c 2061 6e64 2074  ction call and t
-00019e60: 6865 2073 616d 6520 7365 7420 6f66 0a20  he same set of. 
-00019e70: 2020 2023 2061 7267 756d 656e 7473 2e20     # arguments. 
-00019e80: 5365 6520 7465 7374 5f67 7261 642e 7079  See test_grad.py
-00019e90: 3a74 6573 745f 746f 7263 685f 6175 746f  :test_torch_auto
-00019ea0: 6772 6164 5f66 756e 6374 696f 6e20 666f  grad_function fo
-00019eb0: 7220 616e 2065 7861 6d70 6c65 0a20 2020  r an example.   
-00019ec0: 2023 2077 6865 7265 2074 6869 7320 6973   # where this is
-00019ed0: 2074 6573 7465 642e 0a20 2020 2062 6f75   tested..    bou
-00019ee0: 6e64 5f73 796d 626f 6c73 203d 2069 7465  nd_symbols = ite
-00019ef0: 725f 626f 756e 645f 7379 6d62 6f6c 7328  r_bound_symbols(
-00019f00: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
-00019f10: 6f6c 7329 0a20 2020 2073 6176 6564 5f66  ols).    saved_f
-00019f20: 6f72 5f62 6163 6b77 6172 6420 3d20 7475  or_backward = tu
-00019f30: 706c 6528 656e 765b 7365 7175 656e 6369  ple(env[sequenci
-00019f40: 6679 2873 796d 626f 6c2e 6f75 7470 7574  fy(symbol.output
-00019f50: 295b 305d 2e6e 616d 655d 2e72 6573 6964  )[0].name].resid
-00019f60: 7561 6c73 2066 6f72 2073 796d 626f 6c20  uals for symbol 
-00019f70: 696e 2062 6f75 6e64 5f73 796d 626f 6c73  in bound_symbols
-00019f80: 290a 2020 2020 7265 7475 726e 2073 6176  ).    return sav
-00019f90: 6564 5f66 6f72 5f62 6163 6b77 6172 640a  ed_for_backward.
-00019fa0: 0a0a 6465 6620 7265 636f 6e73 7472 7563  ..def reconstruc
-00019fb0: 745f 666f 7277 6172 645f 656e 765f 666f  t_forward_env_fo
-00019fc0: 725f 6261 636b 7761 7264 2874 7261 6365  r_backward(trace
-00019fd0: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
-00019fe0: 7761 7264 293a 0a20 2020 2062 6f75 6e64  ward):.    bound
-00019ff0: 5f73 796d 626f 6c73 203d 2069 7465 725f  _symbols = iter_
-0001a000: 626f 756e 645f 7379 6d62 6f6c 7328 7472  bound_symbols(tr
-0001a010: 6163 652e 626f 756e 645f 7379 6d62 6f6c  ace.bound_symbol
-0001a020: 7329 0a0a 2020 2020 7265 636f 6e73 7472  s)..    reconstr
-0001a030: 7563 7465 645f 656e 7620 3d20 7b7d 0a0a  ucted_env = {}..
-0001a040: 2020 2020 666f 7220 6964 782c 2073 796d      for idx, sym
-0001a050: 2069 6e20 656e 756d 6572 6174 6528 626f   in enumerate(bo
-0001a060: 756e 645f 7379 6d62 6f6c 7329 3a0a 2020  und_symbols):.  
-0001a070: 2020 2020 2020 6b20 3d20 7365 7175 656e        k = sequen
-0001a080: 6369 6679 2873 796d 2e6f 7574 7075 7429  cify(sym.output)
-0001a090: 5b30 5d2e 6e61 6d65 0a20 2020 2020 2020  [0].name.       
-0001a0a0: 2076 203d 2056 4a50 4475 616c 284e 6f6e   v = VJPDual(Non
-0001a0b0: 652c 2073 6176 6564 5f66 6f72 5f62 6163  e, saved_for_bac
-0001a0c0: 6b77 6172 645b 6964 785d 290a 2020 2020  kward[idx]).    
-0001a0d0: 2020 2020 7265 636f 6e73 7472 7563 7465      reconstructe
-0001a0e0: 645f 656e 765b 6b5d 203d 2076 0a0a 2020  d_env[k] = v..  
-0001a0f0: 2020 7265 7475 726e 2072 6563 6f6e 7374    return reconst
-0001a100: 7275 6374 6564 5f65 6e76 0a0a 0a64 6566  ructed_env...def
-0001a110: 2064 6563 6f6d 706f 7365 645f 666e 5f61   decomposed_fn_a
-0001a120: 7567 5f66 7764 5f72 756c 6528 2a61 7267  ug_fwd_rule(*arg
-0001a130: 732c 2064 6563 6f6d 706f 7365 645f 666e  s, decomposed_fn
-0001a140: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-0001a150: 2022 2222 4175 676d 656e 7465 6420 666f   """Augmented fo
-0001a160: 7277 6172 6420 7275 6c65 2066 6f72 2063  rward rule for c
-0001a170: 6f6d 706f 7369 7465 2066 756e 6374 696f  omposite functio
-0001a180: 6e73 2069 6d70 6c65 6d65 6e74 6564 2069  ns implemented i
-0001a190: 6e20 7465 726d 7320 6f66 206f 7468 6572  n terms of other
-0001a1a0: 2066 756e 6374 696f 6e73 2074 6861 7420   functions that 
-0001a1b0: 6172 650a 2020 2020 7375 7070 6f73 6564  are.    supposed
-0001a1c0: 2074 6f20 6265 2073 7570 706f 7274 6564   to be supported
-0001a1d0: 2062 7920 7468 6520 564a 5020 696e 6672   by the VJP infr
-0001a1e0: 6173 7472 7563 7475 7265 2e0a 0a20 2020  astructure...   
-0001a1f0: 2041 7267 733a 0a20 2020 2020 2020 2064   Args:.        d
-0001a200: 6563 6f6d 706f 7365 645f 666e 2028 4361  ecomposed_fn (Ca
-0001a210: 6c6c 6162 6c65 293a 2064 6563 6f6d 706f  llable): decompo
-0001a220: 7365 6420 7665 7273 696f 6e20 6f66 2074  sed version of t
-0001a230: 6865 2066 756e 6374 696f 6e0a 0a20 2020  he function..   
-0001a240: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-0001a250: 2020 4361 6c6c 6162 6c65 3a20 4175 676d    Callable: Augm
-0001a260: 656e 7465 6420 666f 7277 6172 6420 7275  ented forward ru
-0001a270: 6c65 2066 6f72 2074 6865 2063 6f6d 706f  le for the compo
-0001a280: 7369 7465 2066 756e 6374 696f 6e0a 2020  site function.  
-0001a290: 2020 2222 220a 2020 2020 7472 6163 6520    """.    trace 
-0001a2a0: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
-0001a2b0: 6528 2928 6465 636f 6d70 6f73 6564 5f66  e()(decomposed_f
-0001a2c0: 6e2c 202a 6172 6773 2c20 2a2a 6b77 6172  n, *args, **kwar
-0001a2d0: 6773 290a 2020 2020 7472 6163 6520 3d20  gs).    trace = 
-0001a2e0: 756e 7772 6170 5f6f 6e65 5f6c 6576 656c  unwrap_one_level
-0001a2f0: 5f6f 665f 7375 6273 796d 626f 6c73 2874  _of_subsymbols(t
-0001a300: 7261 6365 290a 2020 2020 2320 5468 6572  race).    # Ther
-0001a310: 6520 6d61 7920 6265 2061 2064 6561 6420  e may be a dead 
-0001a320: 6e6f 6465 206c 696b 6520 225f 203d 2070  node like "_ = p
-0001a330: 7269 6d73 2e63 6f6e 7665 7274 5f65 6c65  rims.convert_ele
-0001a340: 6d65 6e74 5f74 7970 6528 302c 2066 6c6f  ment_type(0, flo
-0001a350: 6174 2922 0a20 2020 2023 2069 6e20 7468  at)".    # in th
-0001a360: 6520 7472 6163 652e 2057 6520 6e65 6564  e trace. We need
-0001a370: 2074 6f20 7265 6d6f 7665 2069 7420 6265   to remove it be
-0001a380: 666f 7265 2077 6520 6361 6e20 7573 6520  fore we can use 
-0001a390: 7468 6520 7472 6163 6520 666f 720a 2020  the trace for.  
-0001a3a0: 2020 2320 6175 676d 656e 7465 645f 666f    # augmented_fo
-0001a3b0: 7277 6172 645f 7061 7373 2e0a 2020 2020  rward_pass..    
-0001a3c0: 7472 6163 6520 3d20 6463 6528 7472 6163  trace = dce(trac
-0001a3d0: 6529 0a20 2020 2072 6573 756c 742c 2065  e).    result, e
-0001a3e0: 6e76 203d 2061 7567 6d65 6e74 6564 5f66  nv = augmented_f
-0001a3f0: 6f72 7761 7264 5f70 6173 7328 2a61 7267  orward_pass(*arg
-0001a400: 732c 2074 7261 6365 3d74 7261 6365 2c20  s, trace=trace, 
-0001a410: 2a2a 6b77 6172 6773 290a 2020 2020 7361  **kwargs).    sa
-0001a420: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001a430: 203d 2064 6563 6f6e 7374 7275 6374 5f66   = deconstruct_f
-0001a440: 6f72 7761 7264 5f65 6e76 5f66 6f72 5f62  orward_env_for_b
-0001a450: 6163 6b77 6172 6428 7472 6163 652c 2065  ackward(trace, e
-0001a460: 6e76 290a 2020 2020 2320 5374 6174 6963  nv).    # Static
-0001a470: 2063 6163 6869 6e67 2064 6f65 7320 6e6f   caching does no
-0001a480: 7420 7769 7468 2077 6974 6820 6b77 6172  t with with kwar
-0001a490: 6773 2064 6963 7473 2c20 736f 2077 6527  gs dicts, so we'
-0001a4a0: 7265 2063 6f6e 7665 7274 696e 6720 7468  re converting th
-0001a4b0: 656d 0a20 2020 2023 2074 6f20 4e6f 6e65  em.    # to None
-0001a4c0: 2066 6f72 206e 6f77 2077 6865 6e20 706f   for now when po
-0001a4d0: 7373 6962 6c65 2e0a 2020 2020 6b77 6172  ssible..    kwar
-0001a4e0: 6773 203d 204e 6f6e 6520 6966 206e 6f74  gs = None if not
-0001a4f0: 206b 7761 7267 7320 656c 7365 206b 7761   kwargs else kwa
-0001a500: 7267 730a 2020 2020 7265 7369 6475 616c  rgs.    residual
-0001a510: 7320 3d20 2861 7267 732c 206b 7761 7267  s = (args, kwarg
-0001a520: 732c 2073 6176 6564 5f66 6f72 5f62 6163  s, saved_for_bac
-0001a530: 6b77 6172 6429 0a20 2020 2072 6574 7572  kward).    retur
-0001a540: 6e20 564a 5044 7561 6c28 7265 7375 6c74  n VJPDual(result
-0001a550: 2c20 7265 7369 6475 616c 7329 0a0a 0a64  , residuals)...d
-0001a560: 6566 2064 6563 6f6d 706f 7365 645f 666e  ef decomposed_fn
-0001a570: 5f62 6163 6b77 6172 645f 7275 6c65 2864  _backward_rule(d
-0001a580: 6563 6f6d 706f 7365 645f 666e 2c20 6172  ecomposed_fn, ar
-0001a590: 6773 2c20 6b77 6172 6773 2c20 7361 7665  gs, kwargs, save
-0001a5a0: 645f 666f 725f 6261 636b 7761 7264 2c20  d_for_backward, 
-0001a5b0: 2a67 7261 6473 293a 0a20 2020 206b 7761  *grads):.    kwa
-0001a5c0: 7267 7320 3d20 7b7d 2069 6620 6b77 6172  rgs = {} if kwar
-0001a5d0: 6773 2069 7320 4e6f 6e65 2065 6c73 6520  gs is None else 
-0001a5e0: 6b77 6172 6773 0a20 2020 2074 7261 6365  kwargs.    trace
-0001a5f0: 203d 2063 6f6e 7374 7275 6374 5f74 7261   = construct_tra
-0001a600: 6365 2829 2864 6563 6f6d 706f 7365 645f  ce()(decomposed_
-0001a610: 666e 2c20 2a61 7267 732c 202a 2a6b 7761  fn, *args, **kwa
-0001a620: 7267 7329 0a20 2020 2074 7261 6365 203d  rgs).    trace =
-0001a630: 2075 6e77 7261 705f 6f6e 655f 6c65 7665   unwrap_one_leve
-0001a640: 6c5f 6f66 5f73 7562 7379 6d62 6f6c 7328  l_of_subsymbols(
-0001a650: 7472 6163 6529 0a20 2020 2074 7261 6365  trace).    trace
-0001a660: 203d 2064 6365 2874 7261 6365 290a 2020   = dce(trace).  
-0001a670: 2020 2320 626f 756e 645f 7379 6d62 6f6c    # bound_symbol
-0001a680: 7320 3d20 6974 6572 5f62 6f75 6e64 5f73  s = iter_bound_s
-0001a690: 796d 626f 6c73 2874 7261 6365 2e62 6f75  ymbols(trace.bou
-0001a6a0: 6e64 5f73 796d 626f 6c73 290a 2020 2020  nd_symbols).    
-0001a6b0: 2320 7265 636f 6e73 7472 7563 7465 645f  # reconstructed_
-0001a6c0: 656e 7620 3d20 7b0a 2020 2020 2320 2020  env = {.    #   
-0001a6d0: 2020 7365 7175 656e 6369 6679 2873 796d    sequencify(sym
-0001a6e0: 626f 6c2e 6f75 7470 7574 295b 305d 2e6e  bol.output)[0].n
-0001a6f0: 616d 653a 2056 4a50 4475 616c 284e 6f6e  ame: VJPDual(Non
-0001a700: 652c 2073 6176 6564 5f66 6f72 5f62 6163  e, saved_for_bac
-0001a710: 6b77 6172 645b 695d 290a 2020 2020 2320  kward[i]).    # 
-0001a720: 2020 2020 666f 7220 692c 2073 796d 626f      for i, symbo
-0001a730: 6c20 696e 2065 6e75 6d65 7261 7465 2862  l in enumerate(b
-0001a740: 6f75 6e64 5f73 796d 626f 6c73 290a 2020  ound_symbols).  
-0001a750: 2020 2320 7d0a 2020 2020 7265 636f 6e73    # }.    recons
-0001a760: 7472 7563 7465 645f 656e 7620 3d20 7265  tructed_env = re
-0001a770: 636f 6e73 7472 7563 745f 666f 7277 6172  construct_forwar
-0001a780: 645f 656e 765f 666f 725f 6261 636b 7761  d_env_for_backwa
-0001a790: 7264 2874 7261 6365 2c20 7361 7665 645f  rd(trace, saved_
-0001a7a0: 666f 725f 6261 636b 7761 7264 290a 2020  for_backward).  
-0001a7b0: 2020 7265 7375 6c74 203d 2062 6163 6b77    result = backw
-0001a7c0: 6172 645f 7061 7373 2872 6563 6f6e 7374  ard_pass(reconst
-0001a7d0: 7275 6374 6564 5f65 6e76 2c20 7472 6163  ructed_env, trac
-0001a7e0: 652c 2067 7261 6473 290a 2020 2020 6966  e, grads).    if
-0001a7f0: 206c 656e 2861 7267 7329 203d 3d20 313a   len(args) == 1:
-0001a800: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001a810: 7265 7375 6c74 5b30 5d0a 2020 2020 2320  result[0].    # 
-0001a820: 4261 636b 7761 7264 2070 6173 7320 6d69  Backward pass mi
-0001a830: 6768 7420 7265 7475 726e 2061 2064 6963  ght return a dic
-0001a840: 7420 7769 7468 2067 7261 6473 2062 7574  t with grads but
-0001a850: 2063 7572 7265 6e74 2069 6e74 6572 6661   current interfa
-0001a860: 6365 206f 660a 2020 2020 2320 6261 636b  ce of.    # back
-0001a870: 7761 7264 2072 756c 6520 646f 6573 206e  ward rule does n
-0001a880: 6f74 2073 7570 706f 7274 2069 742e 2053  ot support it. S
-0001a890: 6f20 7765 206a 7573 7420 6472 6f70 2069  o we just drop i
-0001a8a0: 7420 666f 7220 6e6f 772e 0a20 2020 2065  t for now..    e
-0001a8b0: 6c69 6620 6973 696e 7374 616e 6365 2872  lif isinstance(r
-0001a8c0: 6573 756c 745b 2d31 5d2c 2064 6963 7429  esult[-1], dict)
-0001a8d0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0001a8e0: 2072 6573 756c 745b 3a2d 315d 0a20 2020   result[:-1].   
-0001a8f0: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
-0001a900: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
-0001a910: 6e74 6564 5f66 6f72 7761 7264 2822 746f  nted_forward("to
-0001a920: 7263 682e 5465 6e73 6f72 2e63 6f6e 7469  rch.Tensor.conti
-0001a930: 6775 6f75 7322 290a 4072 6567 6973 7465  guous").@registe
-0001a940: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
-0001a950: 6172 6428 2274 6f72 6368 2e63 6f6e 7469  ard("torch.conti
-0001a960: 6775 6f75 7322 290a 6465 6620 636f 6e74  guous").def cont
-0001a970: 6967 756f 7573 5f61 7567 5f66 7764 2878  iguous_aug_fwd(x
-0001a980: 3a20 5465 6e73 6f72 5072 6f78 792c 202f  : TensorProxy, /
-0001a990: 2c20 2a2c 206d 656d 6f72 795f 666f 726d  , *, memory_form
-0001a9a0: 6174 3a20 746f 7263 682e 6d65 6d6f 7279  at: torch.memory
-0001a9b0: 5f66 6f72 6d61 7420 3d20 746f 7263 682e  _format = torch.
-0001a9c0: 636f 6e74 6967 756f 7573 5f66 6f72 6d61  contiguous_forma
-0001a9d0: 7429 202d 3e20 564a 5044 7561 6c3a 0a20  t) -> VJPDual:. 
-0001a9e0: 2020 2066 726f 6d20 7468 756e 6465 722e     from thunder.
-0001a9f0: 746f 7263 6820 696d 706f 7274 2063 6f6e  torch import con
-0001aa00: 7469 6775 6f75 730a 0a20 2020 2072 6574  tiguous..    ret
-0001aa10: 7572 6e20 564a 5044 7561 6c28 636f 6e74  urn VJPDual(cont
-0001aa20: 6967 756f 7573 2878 2c20 6d65 6d6f 7279  iguous(x, memory
-0001aa30: 5f66 6f72 6d61 743d 6d65 6d6f 7279 5f66  _format=memory_f
-0001aa40: 6f72 6d61 7429 2c20 7475 706c 6528 2929  ormat), tuple())
-0001aa50: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
-0001aa60: 6b77 6172 6428 2274 6f72 6368 2e54 656e  kward("torch.Ten
-0001aa70: 736f 722e 636f 6e74 6967 756f 7573 2229  sor.contiguous")
-0001aa80: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
-0001aa90: 6172 6428 2274 6f72 6368 2e63 6f6e 7469  ard("torch.conti
-0001aaa0: 6775 6f75 7322 290a 6465 6620 636f 6e74  guous").def cont
-0001aab0: 6967 756f 7573 5f62 6163 6b77 6172 6428  iguous_backward(
-0001aac0: 2a72 6573 6964 7561 6c73 5f61 6e64 5f67  *residuals_and_g
-0001aad0: 7261 6429 202d 3e20 5465 6e73 6f72 5072  rad) -> TensorPr
-0001aae0: 6f78 793a 0a20 2020 2023 2052 6573 6964  oxy:.    # Resid
-0001aaf0: 7561 6c73 2069 7320 6e6f 7420 656d 7074  uals is not empt
-0001ab00: 7920 6265 6361 7573 6520 636f 6e74 6967  y because contig
-0001ab10: 756f 7573 2073 796d 626f 6c20 6861 7320  uous symbol has 
-0001ab20: 7468 6520 7361 6d65 206f 7574 7075 7420  the same output 
-0001ab30: 6173 2069 7473 2069 6e70 7574 0a20 2020  as its input.   
-0001ab40: 2067 203d 2072 6573 6964 7561 6c73 5f61   g = residuals_a
-0001ab50: 6e64 5f67 7261 645b 2d31 5d0a 2020 2020  nd_grad[-1].    
-0001ab60: 7265 7475 726e 2067 0a0a 0a64 6566 2072  return g...def r
-0001ab70: 6563 6970 726f 6361 6c5f 6175 675f 6677  eciprocal_aug_fw
-0001ab80: 6428 613a 2054 656e 736f 7250 726f 7879  d(a: TensorProxy
-0001ab90: 2920 2d3e 2056 4a50 4475 616c 3a0a 2020  ) -> VJPDual:.  
-0001aba0: 2020 7072 696d 616c 203d 2072 6563 6970    primal = recip
-0001abb0: 726f 6361 6c28 6129 0a20 2020 2072 6574  rocal(a).    ret
-0001abc0: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
-0001abd0: 616c 2c20 2870 7269 6d61 6c2c 2929 0a0a  al, (primal,))..
-0001abe0: 0a64 6566 2072 6563 6970 726f 6361 6c5f  .def reciprocal_
-0001abf0: 6261 636b 7761 7264 2870 7269 6d61 6c2c  backward(primal,
-0001ac00: 2067 293a 0a20 2020 2072 6574 7572 6e20   g):.    return 
-0001ac10: 2d67 202a 2070 7269 6d61 6c20 2a20 7072  -g * primal * pr
-0001ac20: 696d 616c 0a0a 0a40 7061 7274 6961 6c28  imal...@partial(
-0001ac30: 7265 6769 7374 6572 5f67 7261 642c 2070  register_grad, p
-0001ac40: 7269 6d73 2e50 7269 6d49 4473 2e52 4543  rims.PrimIDs.REC
-0001ac50: 4950 524f 4341 4c29 0a64 6566 2072 6563  IPROCAL).def rec
-0001ac60: 6970 726f 6361 6c5f 6a6f 696e 745f 666f  iprocal_joint_fo
-0001ac70: 7277 6172 645f 6261 636b 7761 7264 5f72  rward_backward_r
-0001ac80: 756c 6528 613a 2054 656e 736f 7250 726f  ule(a: TensorPro
-0001ac90: 7879 2920 2d3e 2054 656e 736f 7250 726f  xy) -> TensorPro
-0001aca0: 7879 3a0a 2020 2020 7265 7375 6c74 2c20  xy:.    result, 
-0001acb0: 7361 7665 6420 3d20 7265 6369 7072 6f63  saved = reciproc
-0001acc0: 616c 5f61 7567 5f66 7764 2861 290a 2020  al_aug_fwd(a).  
-0001acd0: 2020 6720 3d20 6765 745f 6772 6164 2872    g = get_grad(r
-0001ace0: 6573 756c 7429 0a20 2020 2067 6120 3d20  esult).    ga = 
-0001acf0: 7265 6369 7072 6f63 616c 5f62 6163 6b77  reciprocal_backw
-0001ad00: 6172 6428 2a73 6176 6564 2c20 6729 0a20  ard(*saved, g). 
-0001ad10: 2020 2070 7574 5f67 7261 6428 612c 2067     put_grad(a, g
-0001ad20: 6129 0a20 2020 2072 6574 7572 6e20 7265  a).    return re
-0001ad30: 7375 6c74 0a0a 0a40 7265 6769 7374 6572  sult...@register
-0001ad40: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
-0001ad50: 7264 2822 746f 7263 682e 696e 6465 785f  rd("torch.index_
-0001ad60: 7075 7422 290a 6465 6620 696e 6465 785f  put").def index_
-0001ad70: 7075 745f 6175 675f 6677 6428 0a20 2020  put_aug_fwd(.   
-0001ad80: 2061 3a20 5465 6e73 6f72 5072 6f78 792c   a: TensorProxy,
-0001ad90: 202f 2c20 696e 6469 6365 733a 2053 6571   /, indices: Seq
-0001ada0: 7565 6e63 655b 5465 6e73 6f72 5072 6f78  uence[TensorProx
-0001adb0: 795d 2c20 7661 6c75 6573 3a20 5465 6e73  y], values: Tens
-0001adc0: 6f72 5072 6f78 792c 2061 6363 756d 756c  orProxy, accumul
-0001add0: 6174 653a 2062 6f6f 6c20 3d20 4661 6c73  ate: bool = Fals
-0001ade0: 650a 2920 2d3e 2056 4a50 4475 616c 3a0a  e.) -> VJPDual:.
-0001adf0: 2020 2020 7072 696d 616c 203d 2063 6c61      primal = cla
-0001ae00: 6e67 2e69 6e64 6578 5f70 7574 2861 2c20  ng.index_put(a, 
-0001ae10: 696e 6469 6365 732c 2076 616c 7565 732c  indices, values,
-0001ae20: 2061 6363 756d 756c 6174 6529 0a20 2020   accumulate).   
-0001ae30: 2072 6573 6964 7561 6c73 203d 2028 0a20   residuals = (. 
-0001ae40: 2020 2020 2020 2069 6e64 6963 6573 2c0a         indices,.
-0001ae50: 2020 2020 2020 2020 7661 6c75 6573 2c0a          values,.
-0001ae60: 2020 2020 2020 2020 6163 6375 6d75 6c61          accumula
-0001ae70: 7465 2c0a 2020 2020 290a 2020 2020 7265  te,.    ).    re
-0001ae80: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
-0001ae90: 6d61 6c2c 2072 6573 6964 7561 6c73 290a  mal, residuals).
-0001aea0: 0a0a 6465 6620 7375 6d5f 746f 2861 3a20  ..def sum_to(a: 
-0001aeb0: 5465 6e73 6f72 5072 6f78 792c 2073 6861  TensorProxy, sha
-0001aec0: 7065 3a20 5365 7175 656e 6365 5b69 6e74  pe: Sequence[int
-0001aed0: 5d29 202d 3e20 5465 6e73 6f72 5072 6f78  ]) -> TensorProx
-0001aee0: 793a 0a20 2020 2069 6620 6e6f 7420 7368  y:.    if not sh
-0001aef0: 6170 653a 0a20 2020 2020 2020 2072 6574  ape:.        ret
-0001af00: 7572 6e20 612e 7375 6d28 290a 2020 2020  urn a.sum().    
-0001af10: 6c65 6164 696e 675f 6469 6d73 203d 2061  leading_dims = a
-0001af20: 2e6e 6469 6d20 2d20 6c65 6e28 7368 6170  .ndim - len(shap
-0001af30: 6529 0a20 2020 2072 6564 7563 655f 6469  e).    reduce_di
-0001af40: 6d73 203d 2074 7570 6c65 2872 616e 6765  ms = tuple(range
-0001af50: 286c 6561 6469 6e67 5f64 696d 7329 2920  (leading_dims)) 
-0001af60: 2b20 7475 706c 6528 0a20 2020 2020 2020  + tuple(.       
-0001af70: 2069 2066 6f72 2069 2069 6e20 7261 6e67   i for i in rang
-0001af80: 6528 6c65 6164 696e 675f 6469 6d73 2c20  e(leading_dims, 
-0001af90: 612e 6e64 696d 2920 6966 2073 6861 7065  a.ndim) if shape
-0001afa0: 5b69 202d 206c 6561 6469 6e67 5f64 696d  [i - leading_dim
-0001afb0: 735d 203d 3d20 3120 616e 6420 612e 7368  s] == 1 and a.sh
-0001afc0: 6170 655b 695d 2021 3d20 310a 2020 2020  ape[i] != 1.    
-0001afd0: 290a 2020 2020 6120 3d20 6c74 6f72 6368  ).    a = ltorch
-0001afe0: 2e73 756d 2861 2c20 6469 6d3d 7265 6475  .sum(a, dim=redu
-0001aff0: 6365 5f64 696d 732c 206b 6565 7064 696d  ce_dims, keepdim
-0001b000: 3d54 7275 6529 0a20 2020 2069 6620 6c65  =True).    if le
-0001b010: 6164 696e 675f 6469 6d73 203e 2030 3a0a  ading_dims > 0:.
-0001b020: 2020 2020 2020 2020 7265 7475 726e 206c          return l
-0001b030: 746f 7263 682e 7669 6577 2861 2c20 7368  torch.view(a, sh
-0001b040: 6170 6529 0a20 2020 2072 6574 7572 6e20  ape).    return 
-0001b050: 610a 0a0a 4072 6567 6973 7465 725f 6261  a...@register_ba
-0001b060: 636b 7761 7264 2822 746f 7263 682e 696e  ckward("torch.in
-0001b070: 6465 785f 7075 7422 290a 6465 6620 696e  dex_put").def in
-0001b080: 6465 785f 7075 745f 6261 636b 7761 7264  dex_put_backward
-0001b090: 2869 6e64 6963 6573 3a20 5365 7175 656e  (indices: Sequen
-0001b0a0: 6365 5b54 656e 736f 7250 726f 7879 5d2c  ce[TensorProxy],
-0001b0b0: 2076 616c 7565 733a 2054 656e 736f 7250   values: TensorP
-0001b0c0: 726f 7879 2c20 6163 6375 6d75 6c61 7465  roxy, accumulate
-0001b0d0: 3a20 626f 6f6c 2c20 673a 2054 656e 736f  : bool, g: Tenso
-0001b0e0: 7250 726f 7879 293a 0a20 2020 2067 5f76  rProxy):.    g_v
-0001b0f0: 616c 7565 7320 3d20 675b 696e 6469 6365  alues = g[indice
-0001b100: 735d 0a20 2020 2023 2074 6f72 6368 2068  s].    # torch h
-0001b110: 6173 2065 7874 7261 206c 6f67 6963 2074  as extra logic t
-0001b120: 6f20 6861 6e64 6c65 2074 6865 2065 7870  o handle the exp
-0001b130: 616e 6465 6420 7661 6c75 6573 0a20 2020  anded values.   
-0001b140: 2069 6620 6e6f 7420 7574 696c 732e 7361   if not utils.sa
-0001b150: 6d65 5f73 6861 7065 2867 5f76 616c 7565  me_shape(g_value
-0001b160: 732e 7368 6170 652c 2076 616c 7565 732e  s.shape, values.
-0001b170: 7368 6170 6529 3a0a 2020 2020 2020 2020  shape):.        
-0001b180: 6966 2063 6c61 6e67 2e63 6f6d 7075 7465  if clang.compute
-0001b190: 5f62 726f 6164 6361 7374 5f73 6861 7065  _broadcast_shape
-0001b1a0: 2867 5f76 616c 7565 732e 7368 6170 652c  (g_values.shape,
-0001b1b0: 2076 616c 7565 732e 7368 6170 6529 3a0a   values.shape):.
-0001b1c0: 2020 2020 2020 2020 2020 2020 675f 7661              g_va
-0001b1d0: 6c75 6573 203d 2073 756d 5f74 6f28 675f  lues = sum_to(g_
-0001b1e0: 7661 6c75 6573 2c20 7661 6c75 6573 2e73  values, values.s
-0001b1f0: 6861 7065 290a 2020 2020 6966 2061 6363  hape).    if acc
-0001b200: 756d 756c 6174 653a 0a20 2020 2020 2020  umulate:.       
-0001b210: 2072 6574 7572 6e20 672c 2067 5f76 616c   return g, g_val
-0001b220: 7565 730a 2020 2020 7265 7475 726e 2063  ues.    return c
-0001b230: 6c61 6e67 2e69 6e64 6578 5f70 7574 2867  lang.index_put(g
-0001b240: 2c20 696e 6469 6365 732c 206c 746f 7263  , indices, ltorc
-0001b250: 682e 7a65 726f 735f 6c69 6b65 2876 616c  h.zeros_like(val
-0001b260: 7565 7329 2c20 4661 6c73 6529 2c20 675f  ues), False), g_
-0001b270: 7661 6c75 6573 0a0a 0a64 6566 2075 6e69  values...def uni
-0001b280: 666f 726d 5f61 7567 5f66 7764 2873 6861  form_aug_fwd(sha
-0001b290: 7065 2c20 6d69 6e76 616c 2c20 6d61 7876  pe, minval, maxv
-0001b2a0: 616c 2c20 2a2c 2064 6576 6963 652c 2064  al, *, device, d
-0001b2b0: 7479 7065 293a 0a20 2020 2070 7269 6d61  type):.    prima
-0001b2c0: 6c20 3d20 7072 696d 732e 756e 6966 6f72  l = prims.unifor
-0001b2d0: 6d28 7368 6170 652c 206d 696e 7661 6c2c  m(shape, minval,
-0001b2e0: 206d 6178 7661 6c2c 2064 6576 6963 653d   maxval, device=
-0001b2f0: 6465 7669 6365 2c20 6474 7970 653d 6474  device, dtype=dt
-0001b300: 7970 6529 0a20 2020 2072 6574 7572 6e20  ype).    return 
-0001b310: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
-0001b320: 2870 7269 6d61 6c2c 206d 696e 7661 6c2c  (primal, minval,
-0001b330: 206d 6178 7661 6c29 290a 0a0a 6465 6620   maxval))...def 
-0001b340: 756e 6966 6f72 6d5f 6261 636b 7761 7264  uniform_backward
-0001b350: 2870 7269 6d61 6c2c 206d 696e 7661 6c2c  (primal, minval,
-0001b360: 206d 6178 7661 6c2c 2067 293a 0a20 2020   maxval, g):.   
-0001b370: 2023 2075 6e69 666f 726d 2069 7320 696d   # uniform is im
-0001b380: 706c 656d 656e 7465 6420 6173 2028 6d61  plemented as (ma
-0001b390: 7876 616c 202d 206d 696e 7661 6c29 202a  xval - minval) *
-0001b3a0: 2075 6e69 666f 726d 2873 6861 7065 2c20   uniform(shape, 
-0001b3b0: 302c 2031 2920 2b20 6d69 6e76 616c 0a20  0, 1) + minval. 
-0001b3c0: 2020 2075 6e73 6361 6c65 645f 7072 696d     unscaled_prim
-0001b3d0: 616c 203d 2028 7072 696d 616c 202d 206d  al = (primal - m
-0001b3e0: 696e 7661 6c29 202f 2028 6d61 7876 616c  inval) / (maxval
-0001b3f0: 202d 206d 696e 7661 6c29 0a20 2020 2072   - minval).    r
-0001b400: 6564 7563 655f 616c 6c5f 6469 6d73 203d  educe_all_dims =
-0001b410: 2074 7570 6c65 2872 616e 6765 2867 2e6e   tuple(range(g.n
-0001b420: 6469 6d29 290a 2020 2020 7375 6d20 3d20  dim)).    sum = 
-0001b430: 7061 7274 6961 6c28 7072 696d 732e 7375  partial(prims.su
-0001b440: 6d2c 2064 696d 733d 7265 6475 6365 5f61  m, dims=reduce_a
-0001b450: 6c6c 5f64 696d 7329 0a20 2020 2072 6574  ll_dims).    ret
-0001b460: 7572 6e20 4e6f 6e65 2c20 7375 6d28 6720  urn None, sum(g 
-0001b470: 2a20 2831 202d 2075 6e73 6361 6c65 645f  * (1 - unscaled_
-0001b480: 7072 696d 616c 2929 2c20 7375 6d28 6720  primal)), sum(g 
-0001b490: 2a20 756e 7363 616c 6564 5f70 7269 6d61  * unscaled_prima
-0001b4a0: 6c29 0a0a 0a6e 6f6e 6469 6666 6572 656e  l)...nondifferen
-0001b4b0: 7469 6162 6c65 5f76 6a70 5f73 796d 626f  tiable_vjp_symbo
-0001b4c0: 6c73 203d 2028 7072 696d 732e 5072 696d  ls = (prims.Prim
-0001b4d0: 4944 732e 4249 5457 4953 455f 414e 442c  IDs.BITWISE_AND,
-0001b4e0: 2070 7269 6d73 2e50 7269 6d49 4473 2e53   prims.PrimIDs.S
-0001b4f0: 4947 4e42 4954 2c20 7072 696d 732e 5072  IGNBIT, prims.Pr
-0001b500: 696d 4944 732e 4655 4c4c 290a 0a0a 6465  imIDs.FULL)...de
-0001b510: 6620 6973 5f63 6f6e 7374 616e 745f 666f  f is_constant_fo
-0001b520: 725f 766a 7028 7379 6d62 6f6c 3a20 7072  r_vjp(symbol: pr
-0001b530: 696d 732e 5379 6d62 6f6c 2920 2d3e 2062  ims.Symbol) -> b
-0001b540: 6f6f 6c3a 0a20 2020 2022 2222 4368 6563  ool:.    """Chec
-0001b550: 6b20 6966 2061 2073 796d 626f 6c20 6973  k if a symbol is
-0001b560: 2063 6f6e 7374 616e 7420 666f 7220 7468   constant for th
-0001b570: 6520 564a 5020 7472 616e 7366 6f72 6d2e  e VJP transform.
-0001b580: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-0001b590: 2020 2020 7379 6d62 6f6c 2028 7072 696d      symbol (prim
-0001b5a0: 732e 5379 6d62 6f6c 293a 2053 796d 626f  s.Symbol): Symbo
-0001b5b0: 6c20 746f 2063 6865 636b 2e0a 0a20 2020  l to check...   
-0001b5c0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-0001b5d0: 2020 626f 6f6c 3a20 5472 7565 2069 6620    bool: True if 
-0001b5e0: 7468 6520 7379 6d62 6f6c 2069 7320 636f  the symbol is co
-0001b5f0: 6e73 7461 6e74 2c20 4661 6c73 6520 6f74  nstant, False ot
-0001b600: 6865 7277 6973 652e 0a20 2020 2022 2222  herwise..    """
-0001b610: 0a20 2020 2061 7265 5f61 6c6c 5f61 7267  .    are_all_arg
-0001b620: 735f 6e6f 6e5f 6469 6666 6572 656e 7469  s_non_differenti
-0001b630: 6162 6c65 203d 206e 6f74 2061 6e79 2869  able = not any(i
-0001b640: 7369 6e73 7461 6e63 6528 6172 672c 2028  sinstance(arg, (
-0001b650: 466c 6f61 7450 726f 7879 2c20 5465 6e73  FloatProxy, Tens
-0001b660: 6f72 5072 6f78 7929 2920 666f 7220 6172  orProxy)) for ar
-0001b670: 6720 696e 2073 796d 626f 6c2e 666c 6174  g in symbol.flat
-0001b680: 5f61 7267 7329 0a20 2020 2072 6574 7572  _args).    retur
-0001b690: 6e20 280a 2020 2020 2020 2020 6172 655f  n (.        are_
-0001b6a0: 616c 6c5f 6172 6773 5f6e 6f6e 5f64 6966  all_args_non_dif
-0001b6b0: 6665 7265 6e74 6961 626c 650a 2020 2020  ferentiable.    
-0001b6c0: 2020 2020 6f72 2073 796d 626f 6c2e 6172      or symbol.ar
-0001b6d0: 655f 616c 6c5f 6172 6773 5f63 6f6e 7374  e_all_args_const
-0001b6e0: 616e 740a 2020 2020 2020 2020 6f72 2073  ant.        or s
-0001b6f0: 796d 626f 6c2e 7379 6d2e 6964 2069 6e20  ymbol.sym.id in 
-0001b700: 6e6f 6e64 6966 6665 7265 6e74 6961 626c  nondifferentiabl
-0001b710: 655f 766a 705f 7379 6d62 6f6c 730a 2020  e_vjp_symbols.  
-0001b720: 2020 290a 0a0a 6465 6620 766a 705f 7379    )...def vjp_sy
-0001b730: 6d62 6f6c 5f6d 6170 7065 7228 7379 6d62  mbol_mapper(symb
-0001b740: 6f6c 3a20 7072 696d 732e 5379 6d62 6f6c  ol: prims.Symbol
-0001b750: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
-0001b760: 7329 3a0a 2020 2020 2222 2253 796d 626f  s):.    """Symbo
-0001b770: 6c20 6d61 7070 6572 2066 6f72 2074 6865  l mapper for the
-0001b780: 2056 4a50 2074 7261 6e73 666f 726d 2e0a   VJP transform..
-0001b790: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-0001b7a0: 2020 2073 796d 626f 6c20 2870 7269 6d73     symbol (prims
-0001b7b0: 2e53 796d 626f 6c29 3a20 5379 6d62 6f6c  .Symbol): Symbol
-0001b7c0: 2074 6f20 6265 206d 6170 7065 642e 0a20   to be mapped.. 
-0001b7d0: 2020 2020 2020 2061 7267 7320 2854 7570         args (Tup
-0001b7e0: 6c65 5b56 6172 6961 626c 655d 293a 2041  le[Variable]): A
-0001b7f0: 7267 756d 656e 7473 2074 6f20 7468 6520  rguments to the 
-0001b800: 7379 6d62 6f6c 2e0a 2020 2020 2020 2020  symbol..        
-0001b810: 6b77 6172 6773 2028 4469 6374 5b73 7472  kwargs (Dict[str
-0001b820: 2c20 5661 7269 6162 6c65 5d29 3a20 4b65  , Variable]): Ke
-0001b830: 7977 6f72 6420 6172 6775 6d65 6e74 7320  yword arguments 
-0001b840: 746f 2074 6865 2073 796d 626f 6c2e 0a0a  to the symbol...
-0001b850: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0001b860: 2020 2020 2043 616c 6c61 626c 653a 2041       Callable: A
-0001b870: 2066 756e 6374 696f 6e20 7468 6174 2063   function that c
-0001b880: 6f6d 7075 7465 7320 7468 6520 564a 5020  omputes the VJP 
-0001b890: 6f66 2074 6865 2073 796d 626f 6c2e 0a20  of the symbol.. 
-0001b8a0: 2020 2022 2222 0a20 2020 2023 2043 6f6e     """.    # Con
-0001b8b0: 7374 616e 7420 6361 7365 0a20 2020 2069  stant case.    i
-0001b8c0: 6620 6973 5f63 6f6e 7374 616e 745f 666f  f is_constant_fo
-0001b8d0: 725f 766a 7028 7379 6d62 6f6c 293a 0a0a  r_vjp(symbol):..
-0001b8e0: 2020 2020 2020 2020 6465 6620 766a 705f          def vjp_
-0001b8f0: 696d 706c 5f63 6f6e 7374 2873 796d 626f  impl_const(symbo
-0001b900: 6c2c 202a 6172 6773 2c20 2a2a 6b77 6172  l, *args, **kwar
-0001b910: 6773 293a 0a20 2020 2020 2020 2020 2020  gs):.           
-0001b920: 2061 7267 732c 206b 7761 7267 7320 3d20   args, kwargs = 
-0001b930: 7472 6565 5f6d 6170 286c 616d 6264 6120  tree_map(lambda 
-0001b940: 783a 2078 2e70 7269 6d61 6c20 6966 2069  x: x.primal if i
-0001b950: 7369 6e73 7461 6e63 6528 782c 2056 4a50  sinstance(x, VJP
-0001b960: 4475 616c 2920 656c 7365 2078 2c20 2861  Dual) else x, (a
-0001b970: 7267 732c 206b 7761 7267 7329 290a 2020  rgs, kwargs)).  
-0001b980: 2020 2020 2020 2020 2020 7072 696d 616c            primal
-0001b990: 7320 3d20 7379 6d62 6f6c 5f74 6f5f 6576  s = symbol_to_ev
-0001b9a0: 616c 2873 796d 626f 6c29 282a 6172 6773  al(symbol)(*args
-0001b9b0: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
-0001b9c0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0001b9d0: 7461 6e63 6528 7072 696d 616c 732c 2053  tance(primals, S
-0001b9e0: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
-0001b9f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001ba00: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
-0001ba10: 2078 3a20 564a 5044 7561 6c28 782c 2074   x: VJPDual(x, t
-0001ba20: 7570 6c65 2829 292c 2070 7269 6d61 6c73  uple()), primals
-0001ba30: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-0001ba40: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
-0001ba50: 6d61 6c73 2c20 7475 706c 6528 2929 0a0a  mals, tuple())..
-0001ba60: 2020 2020 2020 2020 7265 7475 726e 2070          return p
-0001ba70: 6172 7469 616c 2876 6a70 5f69 6d70 6c5f  artial(vjp_impl_
-0001ba80: 636f 6e73 742c 2073 796d 626f 6c29 0a0a  const, symbol)..
-0001ba90: 2020 2020 2320 4e6f 726d 616c 2063 6173      # Normal cas
-0001baa0: 652c 2077 6520 6861 7665 2061 2070 726f  e, we have a pro
-0001bab0: 7879 2074 616e 6765 6e74 0a20 2020 2076  xy tangent.    v
-0001bac0: 6a70 5f69 6d70 6c20 3d20 6175 676d 656e  jp_impl = augmen
-0001bad0: 7465 645f 666f 7277 6172 645f 696d 706c  ted_forward_impl
-0001bae0: 732e 6765 7428 7379 6d62 6f6c 2e73 796d  s.get(symbol.sym
-0001baf0: 2e69 6429 0a0a 2020 2020 6966 205f 6765  .id)..    if _ge
-0001bb00: 745f 6772 6164 666e 2873 796d 626f 6c29  t_gradfn(symbol)
-0001bb10: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0001bb20: 2020 2020 2020 766a 705f 696d 706c 2c20        vjp_impl, 
-0001bb30: 6261 636b 7761 7264 5f66 6e20 3d20 6d61  backward_fn = ma
-0001bb40: 6b65 5f61 7567 5f66 6f72 7761 7264 5f61  ke_aug_forward_a
-0001bb50: 6e64 5f62 6163 6b77 6172 6428 7379 6d62  nd_backward(symb
-0001bb60: 6f6c 290a 0a20 2020 2069 6620 766a 705f  ol)..    if vjp_
-0001bb70: 696d 706c 2069 7320 4e6f 6e65 3a0a 2020  impl is None:.  
-0001bb80: 2020 2020 2020 2320 5765 2063 6f75 6c64        # We could
-0001bb90: 206e 6f74 2066 696e 6420 6120 564a 5020   not find a VJP 
-0001bba0: 666f 7220 7468 6973 2073 796d 626f 6c2c  for this symbol,
-0001bbb0: 2073 6f20 7765 2074 7279 2074 6f20 6465   so we try to de
-0001bbc0: 636f 6d70 6f73 6520 6974 0a20 2020 2020  compose it.     
-0001bbd0: 2020 2069 6620 6c65 6e28 7379 6d62 6f6c     if len(symbol
-0001bbe0: 2e73 7562 7379 6d62 6f6c 7329 203e 2030  .subsymbols) > 0
-0001bbf0: 2061 6e64 206e 6f74 2069 7369 6e73 7461   and not isinsta
-0001bc00: 6e63 6528 7379 6d62 6f6c 2e73 796d 2e69  nce(symbol.sym.i
-0001bc10: 642c 2070 7269 6d73 2e50 7269 6d49 4473  d, prims.PrimIDs
-0001bc20: 293a 0a20 2020 2020 2020 2020 2020 2076  ):.            v
-0001bc30: 6a70 5f69 6d70 6c20 3d20 7061 7274 6961  jp_impl = partia
-0001bc40: 6c28 6465 636f 6d70 6f73 6564 5f66 6e5f  l(decomposed_fn_
-0001bc50: 6175 675f 6677 645f 7275 6c65 2c20 6465  aug_fwd_rule, de
-0001bc60: 636f 6d70 6f73 6564 5f66 6e3d 7379 6d62  composed_fn=symb
-0001bc70: 6f6c 2e73 796d 290a 2020 2020 2020 2020  ol.sym).        
-0001bc80: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001bc90: 2020 2320 5765 2063 6f75 6c64 206e 6f74    # We could not
-0001bca0: 2066 696e 6420 6120 564a 5020 666f 7220   find a VJP for 
-0001bcb0: 7468 6973 2073 796d 626f 6c20 616e 6420  this symbol and 
-0001bcc0: 7765 2063 6f75 6c64 206e 6f74 2064 6563  we could not dec
-0001bcd0: 6f6d 706f 7365 2069 740a 2020 2020 2020  ompose it.      
-0001bce0: 2020 2020 2020 2320 4974 2063 6f75 6c64        # It could
-0001bcf0: 2062 6520 6120 746f 7263 682e 6472 6f70   be a torch.drop
-0001bd00: 6f75 7420 7769 7468 2030 2e30 2070 726f  out with 0.0 pro
-0001bd10: 6261 6269 6c69 7479 2c20 736f 2077 6520  bability, so we 
-0001bd20: 736b 6970 2069 740a 2020 2020 2020 2020  skip it.        
-0001bd30: 2020 2020 6966 2073 796d 626f 6c2e 7379      if symbol.sy
-0001bd40: 6d2e 6964 203d 3d20 2274 6f72 6368 2e6e  m.id == "torch.n
-0001bd50: 6e2e 6675 6e63 7469 6f6e 616c 2e64 726f  n.functional.dro
-0001bd60: 706f 7574 223a 0a20 2020 2020 2020 2020  pout":.         
-0001bd70: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
-0001bd80: 6e65 0a20 2020 2020 2020 2020 2020 2070  ne.            p
-0001bd90: 7269 6e74 2866 2256 4a50 2066 6f72 207b  rint(f"VJP for {
-0001bda0: 7379 6d62 6f6c 7d20 6973 206e 6f74 2069  symbol} is not i
-0001bdb0: 6d70 6c65 6d65 6e74 6564 2229 0a20 2020  mplemented").   
-0001bdc0: 2020 2020 2020 2020 2072 6169 7365 204e           raise N
-0001bdd0: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
-0001bde0: 6f72 2866 2256 4a50 2066 6f72 207b 7379  or(f"VJP for {sy
-0001bdf0: 6d62 6f6c 2e73 796d 2e69 647d 2069 7320  mbol.sym.id} is 
-0001be00: 6e6f 7420 696d 706c 656d 656e 7465 6422  not implemented"
-0001be10: 290a 0a20 2020 2064 6566 205f 766a 705f  )..    def _vjp_
-0001be20: 696d 706c 282a 6172 6773 2c20 2a2a 6b77  impl(*args, **kw
-0001be30: 6172 6773 293a 0a20 2020 2020 2020 2070  args):.        p
-0001be40: 7269 6d61 6c73 2c20 6b77 6172 6773 203d  rimals, kwargs =
-0001be50: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
-0001be60: 2078 3a20 782e 7072 696d 616c 2069 6620   x: x.primal if 
-0001be70: 6973 696e 7374 616e 6365 2878 2c20 564a  isinstance(x, VJ
-0001be80: 5044 7561 6c29 2065 6c73 6520 782c 2028  PDual) else x, (
-0001be90: 6172 6773 2c20 6b77 6172 6773 2929 0a20  args, kwargs)). 
-0001bea0: 2020 2020 2020 206f 7574 5f70 7269 6d61         out_prima
-0001beb0: 6c2c 206f 7574 5f72 6573 6964 7561 6c73  l, out_residuals
-0001bec0: 203d 2076 6a70 5f69 6d70 6c28 2a70 7269   = vjp_impl(*pri
-0001bed0: 6d61 6c73 2c20 2a2a 6b77 6172 6773 290a  mals, **kwargs).
-0001bee0: 0a20 2020 2020 2020 2023 2057 6520 6172  .        # We ar
-0001bef0: 6520 7361 7669 6e67 2074 6865 2072 6573  e saving the res
-0001bf00: 6964 7561 6c73 2061 6e64 2070 756c 6c62  iduals and pullb
-0001bf10: 6163 6b20 6f6e 6c79 2069 6e20 7468 6520  ack only in the 
-0001bf20: 6669 7273 7420 6f75 7470 7574 0a20 2020  first output.   
-0001bf30: 2020 2020 2023 2062 6163 6b77 6172 645f       # backward_
-0001bf40: 7061 7373 2074 6865 6e20 7265 7472 6965  pass then retrie
-0001bf50: 7665 7320 7468 6520 7265 7369 6475 616c  ves the residual
-0001bf60: 7320 616e 6420 7075 6c6c 6261 636b 2066  s and pullback f
-0001bf70: 726f 6d20 7468 6520 6669 7273 7420 6f75  rom the first ou
-0001bf80: 7470 7574 0a20 2020 2020 2020 2069 6620  tput.        if 
-0001bf90: 6973 696e 7374 616e 6365 286f 7574 5f70  isinstance(out_p
-0001bfa0: 7269 6d61 6c2c 2053 6571 7565 6e63 6529  rimal, Sequence)
-0001bfb0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0001bfc0: 7475 726e 2028 564a 5044 7561 6c28 6f75  turn (VJPDual(ou
-0001bfd0: 745f 7072 696d 616c 5b30 5d2c 206f 7574  t_primal[0], out
-0001bfe0: 5f72 6573 6964 7561 6c73 292c 202a 2856  _residuals), *(V
-0001bff0: 4a50 4475 616c 286f 2c20 7475 706c 6528  JPDual(o, tuple(
-0001c000: 2929 2066 6f72 206f 2069 6e20 6f75 745f  )) for o in out_
-0001c010: 7072 696d 616c 5b31 3a5d 2929 0a0a 2020  primal[1:]))..  
-0001c020: 2020 2020 2020 7265 7475 726e 2028 564a        return (VJ
-0001c030: 5044 7561 6c28 6f75 745f 7072 696d 616c  PDual(out_primal
-0001c040: 2c20 6f75 745f 7265 7369 6475 616c 7329  , out_residuals)
-0001c050: 2c29 0a0a 2020 2020 7265 7475 726e 205f  ,)..    return _
-0001c060: 766a 705f 696d 706c 0a0a 0a64 6566 2063  vjp_impl...def c
-0001c070: 6865 636b 5f62 7379 6d5f 666f 725f 766a  heck_bsym_for_vj
-0001c080: 7028 6273 796d 293a 0a20 2020 2022 2222  p(bsym):.    """
-0001c090: 0a20 2020 2043 6865 636b 2069 6620 6120  .    Check if a 
-0001c0a0: 626f 756e 6420 7379 6d62 6f6c 2069 7320  bound symbol is 
-0001c0b0: 7375 7070 6f72 7465 6420 6279 2076 6a70  supported by vjp
-0001c0c0: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
-0001c0d0: 2020 2020 2062 7379 6d20 2842 6f75 6e64       bsym (Bound
-0001c0e0: 5379 6d62 6f6c 293a 2054 6865 2062 6f75  Symbol): The bou
-0001c0f0: 6e64 2073 796d 626f 6c20 746f 2063 6865  nd symbol to che
-0001c100: 636b 2e0a 0a20 2020 2052 6574 7572 6e73  ck...    Returns
-0001c110: 3a0a 2020 2020 2020 2020 626f 6f6c 3a20  :.        bool: 
-0001c120: 5472 7565 2069 6620 7468 6520 626f 756e  True if the boun
-0001c130: 6420 7379 6d62 6f6c 2069 7320 7375 7070  d symbol is supp
-0001c140: 6f72 7465 6420 6279 2076 6a70 2c20 4661  orted by vjp, Fa
-0001c150: 6c73 6520 6f74 6865 7277 6973 652e 0a20  lse otherwise.. 
-0001c160: 2020 2022 2222 0a0a 2020 2020 6966 2062     """..    if b
-0001c170: 7379 6d2e 7379 6d2e 6964 2069 6e20 7472  sym.sym.id in tr
-0001c180: 616e 7366 6f72 6d5f 736b 6970 5f6c 6973  ansform_skip_lis
-0001c190: 743a 0a20 2020 2020 2020 2072 6574 7572  t:.        retur
-0001c1a0: 6e20 5472 7565 0a0a 2020 2020 6966 2062  n True..    if b
-0001c1b0: 7379 6d2e 7379 6d2e 6964 2069 6e20 6261  sym.sym.id in ba
-0001c1c0: 636b 7761 7264 5f69 6d70 6c73 2061 6e64  ckward_impls and
-0001c1d0: 2062 7379 6d2e 7379 6d2e 6964 2069 6e20   bsym.sym.id in 
-0001c1e0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-0001c1f0: 645f 696d 706c 733a 0a20 2020 2020 2020  d_impls:.       
-0001c200: 2072 6574 7572 6e20 5472 7565 0a0a 2020   return True..  
-0001c210: 2020 6966 2062 7379 6d2e 7379 6d2e 6964    if bsym.sym.id
-0001c220: 2069 6e20 5f67 7261 645f 666e 5f6d 6170   in _grad_fn_map
-0001c230: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0001c240: 2054 7275 650a 0a20 2020 2023 2057 6520   True..    # We 
-0001c250: 636f 756c 6420 6e6f 7420 6669 6e64 2061  could not find a
-0001c260: 2056 4a50 2066 6f72 2074 6869 7320 7379   VJP for this sy
-0001c270: 6d62 6f6c 2c20 736f 2077 6520 7472 7920  mbol, so we try 
-0001c280: 746f 2064 6563 6f6d 706f 7365 2069 740a  to decompose it.
-0001c290: 2020 2020 2320 696e 746f 2073 7562 2d73      # into sub-s
-0001c2a0: 796d 626f 6c73 2061 6e64 2063 6865 636b  ymbols and check
-0001c2b0: 2069 6620 7468 6579 2061 7265 2073 7570   if they are sup
-0001c2c0: 706f 7274 6564 0a20 2020 2069 6620 6c65  ported.    if le
-0001c2d0: 6e28 6273 796d 2e73 7562 7379 6d62 6f6c  n(bsym.subsymbol
-0001c2e0: 7329 203e 2030 2061 6e64 206e 6f74 2062  s) > 0 and not b
-0001c2f0: 7379 6d2e 7379 6d2e 6973 5f70 7269 6d3a  sym.sym.is_prim:
-0001c300: 0a20 2020 2020 2020 2073 7562 7472 6163  .        subtrac
-0001c310: 6520 3d20 636f 6e73 7472 7563 745f 7472  e = construct_tr
-0001c320: 6163 6528 2928 6273 796d 2e73 796d 2c20  ace()(bsym.sym, 
-0001c330: 2a62 7379 6d2e 6172 6773 2c20 2a2a 6273  *bsym.args, **bs
-0001c340: 796d 2e6b 7761 7267 7329 0a20 2020 2020  ym.kwargs).     
-0001c350: 2020 2073 7562 7472 6163 6520 3d20 756e     subtrace = un
-0001c360: 7772 6170 5f6f 6e65 5f6c 6576 656c 5f6f  wrap_one_level_o
-0001c370: 665f 7375 6273 796d 626f 6c73 2873 7562  f_subsymbols(sub
-0001c380: 7472 6163 6529 0a20 2020 2020 2020 2061  trace).        a
-0001c390: 6c6c 5f73 7570 706f 7274 6564 203d 2061  ll_supported = a
-0001c3a0: 6c6c 2863 6865 636b 5f62 7379 6d5f 666f  ll(check_bsym_fo
-0001c3b0: 725f 766a 7028 7375 6262 7379 6d29 2066  r_vjp(subbsym) f
-0001c3c0: 6f72 2073 7562 6273 796d 2069 6e20 7375  or subbsym in su
-0001c3d0: 6274 7261 6365 2e62 6f75 6e64 5f73 796d  btrace.bound_sym
-0001c3e0: 626f 6c73 290a 2020 2020 2020 2020 7265  bols).        re
-0001c3f0: 7475 726e 2061 6c6c 5f73 7570 706f 7274  turn all_support
-0001c400: 6564 0a0a 2020 2020 7265 7475 726e 2046  ed..    return F
-0001c410: 616c 7365 0a0a 0a64 6566 2061 7567 6d65  alse...def augme
-0001c420: 6e74 6564 5f66 6f72 7761 7264 5f70 6173  nted_forward_pas
-0001c430: 7328 2a61 7267 732c 2074 7261 6365 3a20  s(*args, trace: 
-0001c440: 5472 6163 652c 202a 2a6b 7761 7267 7329  Trace, **kwargs)
-0001c450: 3a0a 2020 2020 2222 2241 7567 6d65 6e74  :.    """Augment
-0001c460: 6564 2066 6f72 7761 7264 2070 6173 7320  ed forward pass 
-0001c470: 666f 7220 7468 6520 564a 5020 7472 616e  for the VJP tran
-0001c480: 7366 6f72 6d2e 0a0a 2020 2020 5468 6520  sform...    The 
-0001c490: 6175 676d 656e 7465 6420 666f 7277 6172  augmented forwar
-0001c4a0: 6420 7061 7373 2069 7320 6120 666f 7277  d pass is a forw
-0001c4b0: 6172 6420 7061 7373 2074 6861 7420 7265  ard pass that re
-0001c4c0: 7475 726e 7320 7468 6520 7265 7369 6475  turns the residu
-0001c4d0: 616c 730a 2020 2020 6f66 2074 6865 2066  als.    of the f
-0001c4e0: 6f72 7761 7264 2070 6173 732e 0a20 2020  orward pass..   
-0001c4f0: 2054 6865 7365 2072 6573 6964 7561 6c73   These residuals
-0001c500: 2061 7265 2075 7365 6420 696e 2074 6865   are used in the
-0001c510: 2062 6163 6b77 6172 6420 7061 7373 2074   backward pass t
-0001c520: 6f20 636f 6d70 7574 6520 7468 6520 564a  o compute the VJ
-0001c530: 5020 616e 6420 7468 6579 0a20 2020 2061  P and they.    a
-0001c540: 7265 2072 6563 6f72 6465 6420 696e 2074  re recorded in t
-0001c550: 6865 2065 6e76 6972 6f6e 6d65 6e74 2064  he environment d
-0001c560: 6963 7469 6f6e 6172 7920 666f 7220 6561  ictionary for ea
-0001c570: 6368 2076 6172 6961 626c 652e 0a0a 2020  ch variable...  
-0001c580: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-0001c590: 6172 6773 2028 5475 706c 655b 5661 7269  args (Tuple[Vari
-0001c5a0: 6162 6c65 5d29 3a20 4172 6775 6d65 6e74  able]): Argument
-0001c5b0: 7320 746f 2074 6865 2066 756e 6374 696f  s to the functio
-0001c5c0: 6e2e 0a20 2020 2020 2020 2074 7261 6365  n..        trace
-0001c5d0: 2028 5472 6163 6529 3a20 5472 6163 6520   (Trace): Trace 
-0001c5e0: 6f66 2074 6865 2066 756e 6374 696f 6e2e  of the function.
-0001c5f0: 0a20 2020 2020 2020 206b 7761 7267 7320  .        kwargs 
-0001c600: 2844 6963 745b 7374 722c 2056 6172 6961  (Dict[str, Varia
-0001c610: 626c 655d 293a 204b 6579 776f 7264 2061  ble]): Keyword a
-0001c620: 7267 756d 656e 7473 2074 6f20 7468 6520  rguments to the 
-0001c630: 6675 6e63 7469 6f6e 2e0a 0a20 2020 2052  function...    R
-0001c640: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-0001c650: 5475 706c 655b 416e 792c 2044 6963 745b  Tuple[Any, Dict[
-0001c660: 7374 722c 2041 6e79 5d5d 3a20 5475 706c  str, Any]]: Tupl
-0001c670: 6520 6f66 2074 6865 2070 7269 6d61 6c20  e of the primal 
-0001c680: 6f75 7470 7574 7320 616e 6420 7468 6520  outputs and the 
-0001c690: 656e 7669 726f 6e6d 656e 742e 0a20 2020  environment..   
-0001c6a0: 2022 2222 0a20 2020 2061 7267 732c 206b   """.    args, k
-0001c6b0: 7761 7267 7320 3d20 7472 6565 5f6d 6170  wargs = tree_map
-0001c6c0: 286c 616d 6264 6120 783a 2056 4a50 4475  (lambda x: VJPDu
-0001c6d0: 616c 2878 2c20 7475 706c 6528 2929 2c20  al(x, tuple()), 
-0001c6e0: 2861 7267 732c 206b 7761 7267 7329 290a  (args, kwargs)).
-0001c6f0: 2020 2020 7265 7375 6c74 2c20 656e 7620      result, env 
-0001c700: 3d20 6576 616c 5f74 7261 6365 280a 2020  = eval_trace(.  
-0001c710: 2020 2020 2020 7472 6163 652c 0a20 2020        trace,.   
-0001c720: 2020 2020 202a 6172 6773 2c0a 2020 2020       *args,.    
-0001c730: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
-0001c740: 2020 2020 2020 7769 7468 5f65 6e76 3d54        with_env=T
-0001c750: 7275 652c 0a20 2020 2020 2020 2073 796d  rue,.        sym
-0001c760: 626f 6c5f 6d61 7070 6572 3d76 6a70 5f73  bol_mapper=vjp_s
-0001c770: 796d 626f 6c5f 6d61 7070 6572 2c0a 2020  ymbol_mapper,.  
-0001c780: 2020 290a 2020 2020 7265 7375 6c74 203d    ).    result =
-0001c790: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
-0001c7a0: 2078 3a20 782e 7072 696d 616c 2069 6620   x: x.primal if 
-0001c7b0: 6973 696e 7374 616e 6365 2878 2c20 564a  isinstance(x, VJ
-0001c7c0: 5044 7561 6c29 2065 6c73 6520 782c 2072  PDual) else x, r
-0001c7d0: 6573 756c 7429 0a20 2020 2072 6574 7572  esult).    retur
-0001c7e0: 6e20 7265 7375 6c74 2c20 656e 760a 0a0a  n result, env...
-0001c7f0: 2320 544f 444f 3a20 496e 7374 6561 6420  # TODO: Instead 
-0001c800: 6f66 2075 7369 6e67 2074 6865 2065 6e76  of using the env
-0001c810: 6972 6f6e 6d65 6e74 2064 6963 7469 6f6e  ironment diction
-0001c820: 6172 792c 2077 6520 636f 756c 6420 7573  ary, we could us
-0001c830: 6520 7468 6520 7472 6163 650a 2320 7379  e the trace.# sy
-0001c840: 6d62 6f6c 7320 6f72 6465 7220 2874 6861  mbols order (tha
-0001c850: 7420 7368 6f75 6c64 2062 6520 6465 7465  t should be dete
-0001c860: 726d 696e 6973 7469 6329 2074 6f20 7265  rministic) to re
-0001c870: 7472 6965 7665 2074 6865 2072 6573 6964  trieve the resid
-0001c880: 7561 6c73 206e 6565 6465 640a 2320 666f  uals needed.# fo
-0001c890: 7220 7468 6520 6261 636b 7761 7264 2070  r the backward p
-0001c8a0: 6173 732e 0a64 6566 2062 6163 6b77 6172  ass..def backwar
-0001c8b0: 645f 7061 7373 2866 6f72 7761 7264 5f65  d_pass(forward_e
-0001c8c0: 6e76 2c20 7472 6163 652c 2069 6e69 745f  nv, trace, init_
-0001c8d0: 636f 7461 6e67 656e 7473 293a 0a20 2020  cotangents):.   
-0001c8e0: 2022 2222 4261 636b 7761 7264 2070 6173   """Backward pas
-0001c8f0: 7320 666f 7220 7468 6520 564a 5020 7472  s for the VJP tr
-0001c900: 616e 7366 6f72 6d2e 0a0a 2020 2020 5468  ansform...    Th
-0001c910: 6520 6261 636b 7761 7264 2070 6173 7320  e backward pass 
-0001c920: 6973 2061 2072 6576 6572 7365 206d 6f64  is a reverse mod
-0001c930: 6520 6175 746f 6d61 7469 6320 6469 6666  e automatic diff
-0001c940: 6572 656e 7469 6174 696f 6e20 7061 7373  erentiation pass
-0001c950: 2074 6861 740a 2020 2020 636f 6d70 7574   that.    comput
-0001c960: 6573 2074 6865 2076 6563 746f 722d 4a61  es the vector-Ja
-0001c970: 636f 6269 616e 2070 726f 6475 6374 2028  cobian product (
-0001c980: 564a 5029 206f 6620 7468 6520 6675 6e63  VJP) of the func
-0001c990: 7469 6f6e 2e0a 0a20 2020 2041 7267 733a  tion...    Args:
-0001c9a0: 0a20 2020 2020 2020 2066 6f72 7761 7264  .        forward
-0001c9b0: 5f65 6e76 2028 4469 6374 5b73 7472 2c20  _env (Dict[str, 
-0001c9c0: 416e 795d 293a 2045 6e76 6972 6f6e 6d65  Any]): Environme
-0001c9d0: 6e74 206f 6620 7468 6520 666f 7277 6172  nt of the forwar
-0001c9e0: 6420 7061 7373 2e0a 2020 2020 2020 2020  d pass..        
-0001c9f0: 7472 6163 6520 2854 7261 6365 293a 2054  trace (Trace): T
-0001ca00: 7261 6365 206f 6620 7468 6520 6675 6e63  race of the func
-0001ca10: 7469 6f6e 2e0a 2020 2020 2020 2020 696e  tion..        in
-0001ca20: 6974 5f63 6f74 616e 6765 6e74 7320 2854  it_cotangents (T
-0001ca30: 7570 6c65 5b56 6172 6961 626c 655d 293a  uple[Variable]):
-0001ca40: 2049 6e69 7469 616c 2063 6f74 616e 6765   Initial cotange
-0001ca50: 6e74 732e 0a0a 2020 2020 5265 7475 726e  nts...    Return
-0001ca60: 733a 0a20 2020 2020 2020 2054 7570 6c65  s:.        Tuple
-0001ca70: 5b50 726f 7879 2c20 2e2e 2e5d 3a20 5475  [Proxy, ...]: Tu
-0001ca80: 706c 6520 6f66 2074 6865 2072 6573 756c  ple of the resul
-0001ca90: 7473 206f 6620 7468 6520 6261 636b 7761  ts of the backwa
-0001caa0: 7264 2070 6173 7320 666f 7220 6561 6368  rd pass for each
-0001cab0: 2069 6e70 7574 2e0a 2020 2020 2222 220a   input..    """.
-0001cac0: 2020 2020 656e 7620 3d20 7b7d 0a0a 2020      env = {}..  
-0001cad0: 2020 6465 6620 6765 745f 6772 6164 2878    def get_grad(x
-0001cae0: 3a20 5661 7269 6162 6c65 293a 0a20 2020  : Variable):.   
-0001caf0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-0001cb00: 6365 2878 2c20 5661 7269 6162 6c65 293a  ce(x, Variable):
-0001cb10: 0a20 2020 2020 2020 2020 2020 2023 2052  .            # R
-0001cb20: 6574 7572 6e20 4e6f 6e65 2069 6620 7468  eturn None if th
-0001cb30: 6520 7661 7269 6162 6c65 2077 6173 206e  e variable was n
-0001cb40: 6f74 2075 7365 6420 696e 2074 6865 2063  ot used in the c
-0001cb50: 6f6d 7075 7461 7469 6f6e 2061 6e64 0a20  omputation and. 
-0001cb60: 2020 2020 2020 2020 2020 2023 2068 656e             # hen
-0001cb70: 6365 206e 6f74 2069 6e20 7468 6520 656e  ce not in the en
-0001cb80: 760a 2020 2020 2020 2020 2020 2020 7265  v.            re
-0001cb90: 7475 726e 2065 6e76 2e67 6574 2878 2e6e  turn env.get(x.n
-0001cba0: 616d 652c 204e 6f6e 6529 0a20 2020 2020  ame, None).     
-0001cbb0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001cbc0: 2020 2020 2072 6574 7572 6e20 780a 0a20       return x.. 
-0001cbd0: 2020 2064 6566 2070 7574 5f67 7261 6428     def put_grad(
-0001cbe0: 763a 2056 6172 6961 626c 652c 2076 616c  v: Variable, val
-0001cbf0: 3a20 416e 7929 202d 3e20 4e6f 6e65 3a0a  : Any) -> None:.
-0001cc00: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0001cc10: 7461 6e63 6528 762c 2056 6172 6961 626c  tance(v, Variabl
-0001cc20: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0001cc30: 6966 2076 2e6e 616d 6520 696e 2065 6e76  if v.name in env
-0001cc40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001cc50: 2020 6966 2076 616c 2069 7320 4e6f 6e65    if val is None
-0001cc60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001cc70: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-0001cc80: 2020 2020 2020 2020 2020 2020 2023 2041               # A
-0001cc90: 6363 756d 756c 6174 6520 636f 7461 6e67  ccumulate cotang
-0001cca0: 656e 7473 0a20 2020 2020 2020 2020 2020  ents.           
-0001ccb0: 2020 2020 2065 6e76 5b76 2e6e 616d 655d       env[v.name]
-0001ccc0: 203d 2063 6c61 6e67 2e61 6464 2865 6e76   = clang.add(env
-0001ccd0: 5b76 2e6e 616d 655d 2c20 7661 6c29 2069  [v.name], val) i
-0001cce0: 6620 656e 765b 762e 6e61 6d65 5d20 6973  f env[v.name] is
-0001ccf0: 206e 6f74 204e 6f6e 6520 656c 7365 2076   not None else v
-0001cd00: 616c 0a20 2020 2020 2020 2020 2020 2020  al.             
-0001cd10: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-0001cd20: 2020 2020 2020 656e 765b 762e 6e61 6d65        env[v.name
-0001cd30: 5d20 3d20 7661 6c0a 2020 2020 2020 2020  ] = val.        
-0001cd40: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-0001cd50: 762c 2053 6571 7565 6e63 6529 2061 6e64  v, Sequence) and
-0001cd60: 2061 6c6c 2869 7369 6e73 7461 6e63 6528   all(isinstance(
-0001cd70: 782c 2069 6e74 2920 666f 7220 7820 696e  x, int) for x in
-0001cd80: 2076 293a 0a20 2020 2020 2020 2020 2020   v):.           
-0001cd90: 2023 2054 4f44 4f3a 2072 656d 6f76 6520   # TODO: remove 
-0001cda0: 7768 656e 2077 6520 6d6f 7665 2064 696d  when we move dim
-0001cdb0: 7320 746f 206b 7761 7267 730a 2020 2020  s to kwargs.    
-0001cdc0: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-0001cdd0: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-0001cde0: 616e 6365 2876 2c20 7374 7229 3a0a 2020  ance(v, str):.  
-0001cdf0: 2020 2020 2020 2020 2020 656e 765b 765d            env[v]
-0001ce00: 203d 2076 616c 0a20 2020 2020 2020 2065   = val.        e
-0001ce10: 6c69 6620 6973 696e 7374 616e 6365 2876  lif isinstance(v
-0001ce20: 2c20 5365 7175 656e 6365 2920 616e 6420  , Sequence) and 
-0001ce30: 7661 6c20 6973 204e 6f6e 653a 0a20 2020  val is None:.   
-0001ce40: 2020 2020 2020 2020 2023 2062 726f 6164           # broad
-0001ce50: 6361 7374 204e 6f6e 6520 746f 2074 6865  cast None to the
-0001ce60: 2072 6967 6874 2073 6861 7065 0a20 2020   right shape.   
-0001ce70: 2020 2020 2020 2020 2073 6166 655f 6d61           safe_ma
-0001ce80: 7028 7075 745f 6772 6164 2c20 762c 205b  p(put_grad, v, [
-0001ce90: 4e6f 6e65 5d20 2a20 6c65 6e28 7629 290a  None] * len(v)).
-0001cea0: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-0001ceb0: 6e73 7461 6e63 6528 762c 2053 6571 7565  nstance(v, Seque
-0001cec0: 6e63 6529 2061 6e64 2069 7369 6e73 7461  nce) and isinsta
-0001ced0: 6e63 6528 7661 6c2c 2053 6571 7565 6e63  nce(val, Sequenc
-0001cee0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0001cef0: 7361 6665 5f6d 6170 5f66 6c61 7428 7075  safe_map_flat(pu
-0001cf00: 745f 6772 6164 2c20 762c 2076 616c 290a  t_grad, v, val).
-0001cf10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001cf20: 2020 2020 2020 2020 2020 2320 536b 6970            # Skip
-0001cf30: 2077 7269 7469 6e67 2074 6f20 636f 6e73   writing to cons
-0001cf40: 7461 6e74 730a 2020 2020 2020 2020 2020  tants.          
-0001cf50: 2020 7061 7373 0a0a 2020 2020 6966 2069    pass..    if i
-0001cf60: 7369 6e73 7461 6e63 6528 696e 6974 5f63  sinstance(init_c
-0001cf70: 6f74 616e 6765 6e74 732c 2053 6571 7565  otangents, Seque
-0001cf80: 6e63 6529 2061 6e64 206c 656e 2869 6e69  nce) and len(ini
-0001cf90: 745f 636f 7461 6e67 656e 7473 2920 3d3d  t_cotangents) ==
-0001cfa0: 2031 2061 6e64 206e 6f74 2069 7369 6e73   1 and not isins
-0001cfb0: 7461 6e63 6528 7472 6163 652e 6f75 7470  tance(trace.outp
-0001cfc0: 7574 2c20 5365 7175 656e 6365 293a 0a20  ut, Sequence):. 
-0001cfd0: 2020 2020 2020 2069 6e69 745f 636f 7461         init_cota
-0001cfe0: 6e67 656e 7473 203d 2069 6e69 745f 636f  ngents = init_co
-0001cff0: 7461 6e67 656e 7473 5b30 5d0a 2020 2020  tangents[0].    
-0001d000: 7361 6665 5f6d 6170 5f66 6c61 7428 7075  safe_map_flat(pu
-0001d010: 745f 6772 6164 2c20 7472 6163 652e 6f75  t_grad, trace.ou
-0001d020: 7470 7574 2c20 696e 6974 5f63 6f74 616e  tput, init_cotan
-0001d030: 6765 6e74 7329 0a0a 2020 2020 666f 7220  gents)..    for 
-0001d040: 7379 6d62 6f6c 2069 6e20 7265 7665 7273  symbol in revers
-0001d050: 6564 2874 7261 6365 2e62 6f75 6e64 5f73  ed(trace.bound_s
-0001d060: 796d 626f 6c73 293a 0a20 2020 2020 2020  ymbols):.       
-0001d070: 2069 6620 7379 6d62 6f6c 2e73 796d 2e69   if symbol.sym.i
-0001d080: 6420 696e 2074 7261 6e73 666f 726d 5f73  d in transform_s
-0001d090: 6b69 705f 6c69 7374 3a0a 2020 2020 2020  kip_list:.      
-0001d0a0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-0001d0b0: 2020 2020 2020 2073 796d 626f 6c5f 6f75         symbol_ou
-0001d0c0: 7470 7574 203d 2073 6571 7565 6e63 6966  tput = sequencif
-0001d0d0: 7928 7379 6d62 6f6c 2e6f 7574 7075 7429  y(symbol.output)
-0001d0e0: 0a0a 2020 2020 2020 2020 636f 7461 6e67  ..        cotang
-0001d0f0: 656e 7473 203d 2074 7265 655f 6d61 7028  ents = tree_map(
-0001d100: 6765 745f 6772 6164 2c20 7379 6d62 6f6c  get_grad, symbol
-0001d110: 5f6f 7574 7075 7429 0a20 2020 2020 2020  _output).       
-0001d120: 2023 2048 6176 696e 6720 6120 7369 6e67   # Having a sing
-0001d130: 6c65 2063 6f74 616e 6765 6e74 2069 7320  le cotangent is 
-0001d140: 6120 636f 6d6d 6f6e 2063 6173 652c 2073  a common case, s
-0001d150: 6f20 7765 2066 6c61 7474 656e 2069 740a  o we flatten it.
-0001d160: 2020 2020 2020 2020 2320 4f74 6865 7277          # Otherw
-0001d170: 6973 652c 2077 6520 7769 6c6c 206e 6565  ise, we will nee
-0001d180: 6420 746f 2072 6577 7269 7465 2074 6865  d to rewrite the
-0001d190: 2070 756c 6c62 6163 6b20 6675 6e63 7469   pullback functi
-0001d1a0: 6f6e 730a 2020 2020 2020 2020 636f 7461  ons.        cota
-0001d1b0: 6e67 656e 7473 203d 2074 7265 655f 666c  ngents = tree_fl
-0001d1c0: 6174 7465 6e28 636f 7461 6e67 656e 7473  atten(cotangents
-0001d1d0: 295b 305d 0a20 2020 2020 2020 2072 6573  )[0].        res
-0001d1e0: 6964 7561 6c73 203d 2066 6f72 7761 7264  iduals = forward
-0001d1f0: 5f65 6e76 5b73 796d 626f 6c5f 6f75 7470  _env[symbol_outp
-0001d200: 7574 5b30 5d2e 6e61 6d65 5d2e 7265 7369  ut[0].name].resi
-0001d210: 6475 616c 730a 2020 2020 2020 2020 6966  duals.        if
-0001d220: 2069 735f 636f 6e73 7461 6e74 5f66 6f72   is_constant_for
-0001d230: 5f76 6a70 2873 796d 626f 6c29 3a0a 2020  _vjp(symbol):.  
-0001d240: 2020 2020 2020 2020 2020 2320 5765 2063            # We c
-0001d250: 616e 2073 6b69 7020 7468 6520 7075 6c6c  an skip the pull
-0001d260: 6261 636b 2069 6620 616c 6c20 7468 6520  back if all the 
-0001d270: 6172 6775 6d65 6e74 7320 6172 6520 636f  arguments are co
-0001d280: 6e73 7461 6e74 0a20 2020 2020 2020 2020  nstant.         
-0001d290: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
-0001d2a0: 2020 2020 2069 6620 616c 6c28 636f 7461       if all(cota
-0001d2b0: 6e67 656e 7420 6973 204e 6f6e 6520 666f  ngent is None fo
-0001d2c0: 7220 636f 7461 6e67 656e 7420 696e 2063  r cotangent in c
-0001d2d0: 6f74 616e 6765 6e74 7329 3a0a 2020 2020  otangents):.    
-0001d2e0: 2020 2020 2020 2020 2320 5765 2063 616e          # We can
-0001d2f0: 2073 6b69 7020 7468 6520 7075 6c6c 6261   skip the pullba
-0001d300: 636b 2069 6620 7468 6520 636f 7461 6e67  ck if the cotang
-0001d310: 656e 7420 6973 204e 6f6e 650a 2020 2020  ent is None.    
-0001d320: 2020 2020 2020 2020 7361 6665 5f6d 6170          safe_map
-0001d330: 2870 7574 5f67 7261 642c 2073 796d 626f  (put_grad, symbo
-0001d340: 6c2e 6172 6773 2c20 284e 6f6e 652c 2920  l.args, (None,) 
-0001d350: 2a20 6c65 6e28 7379 6d62 6f6c 2e61 7267  * len(symbol.arg
-0001d360: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-0001d370: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
-0001d380: 2020 6966 2073 796d 626f 6c2e 7379 6d2e    if symbol.sym.
-0001d390: 6964 203d 3d20 2274 6f72 6368 2e6e 6e2e  id == "torch.nn.
-0001d3a0: 6675 6e63 7469 6f6e 616c 2e64 726f 706f  functional.dropo
-0001d3b0: 7574 2220 616e 6420 6e6f 7420 7379 6d62  ut" and not symb
-0001d3c0: 6f6c 2e73 7562 7379 6d62 6f6c 733a 0a20  ol.subsymbols:. 
-0001d3d0: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
-0001d3e0: 6361 6e20 736b 6970 2074 6865 2070 756c  can skip the pul
-0001d3f0: 6c62 6163 6b20 6966 2074 6865 2064 726f  lback if the dro
-0001d400: 706f 7574 2070 726f 6261 6269 6c69 7479  pout probability
-0001d410: 2069 7320 302e 300a 2020 2020 2020 2020   is 0.0.        
-0001d420: 2020 2020 2320 4173 7375 6d69 6e67 2074      # Assuming t
-0001d430: 6861 7420 7468 6520 6472 6f70 6f75 7420  hat the dropout 
-0001d440: 7379 6d62 6f6c 2068 6173 2074 6865 2073  symbol has the s
-0001d450: 616d 6520 6f75 7470 7574 2061 6e64 2061  ame output and a
-0001d460: 7267 756d 656e 740a 2020 2020 2020 2020  rgument.        
-0001d470: 2020 2020 6173 7365 7274 2073 796d 626f      assert symbo
-0001d480: 6c2e 6f75 7470 7574 2e6e 616d 6520 3d3d  l.output.name ==
-0001d490: 2073 796d 626f 6c2e 6172 6773 5b30 5d2e   symbol.args[0].
-0001d4a0: 6e61 6d65 2c20 2244 726f 706f 7574 2073  name, "Dropout s
-0001d4b0: 796d 626f 6c20 6861 7320 6120 6469 6666  ymbol has a diff
-0001d4c0: 6572 656e 7420 6f75 7470 7574 2061 6e64  erent output and
-0001d4d0: 2061 7267 756d 656e 7422 0a20 2020 2020   argument".     
-0001d4e0: 2020 2020 2020 2069 6620 7379 6d62 6f6c         if symbol
-0001d4f0: 2e61 7267 735b 315d 203d 3d20 302e 3020  .args[1] == 0.0 
-0001d500: 6f72 2073 796d 626f 6c2e 6172 6773 5b32  or symbol.args[2
-0001d510: 5d20 6973 2046 616c 7365 3a0a 2020 2020  ] is False:.    
-0001d520: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0001d530: 696e 7565 0a0a 2020 2020 2020 2020 6261  inue..        ba
-0001d540: 636b 7761 7264 203d 2062 6163 6b77 6172  ckward = backwar
-0001d550: 645f 696d 706c 732e 6765 7428 7379 6d62  d_impls.get(symb
-0001d560: 6f6c 2e73 796d 2e69 6429 0a20 2020 2020  ol.sym.id).     
-0001d570: 2020 2061 7567 5f66 6f72 7761 7264 203d     aug_forward =
-0001d580: 2061 7567 6d65 6e74 6564 5f66 6f72 7761   augmented_forwa
-0001d590: 7264 5f69 6d70 6c73 2e67 6574 2873 796d  rd_impls.get(sym
-0001d5a0: 626f 6c2e 7379 6d2e 6964 290a 0a20 2020  bol.sym.id)..   
-0001d5b0: 2020 2020 2069 6620 5f67 6574 5f67 7261       if _get_gra
-0001d5c0: 6466 6e28 7379 6d62 6f6c 2920 6973 206e  dfn(symbol) is n
-0001d5d0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0001d5e0: 2020 2020 2061 7567 5f66 6f72 7761 7264       aug_forward
-0001d5f0: 2c20 6261 636b 7761 7264 203d 206d 616b  , backward = mak
-0001d600: 655f 6175 675f 666f 7277 6172 645f 616e  e_aug_forward_an
-0001d610: 645f 6261 636b 7761 7264 2873 796d 626f  d_backward(symbo
-0001d620: 6c29 0a0a 2020 2020 2020 2020 6966 2062  l)..        if b
-0001d630: 6163 6b77 6172 6420 6973 204e 6f6e 653a  ackward is None:
-0001d640: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001d650: 6c65 6e28 7379 6d62 6f6c 2e73 7562 7379  len(symbol.subsy
-0001d660: 6d62 6f6c 7329 203e 2030 2061 6e64 206e  mbols) > 0 and n
-0001d670: 6f74 2069 7369 6e73 7461 6e63 6528 7379  ot isinstance(sy
-0001d680: 6d62 6f6c 2e73 796d 2e69 642c 2070 7269  mbol.sym.id, pri
-0001d690: 6d73 2e50 7269 6d49 4473 293a 0a20 2020  ms.PrimIDs):.   
-0001d6a0: 2020 2020 2020 2020 2020 2020 2023 2057               # W
-0001d6b0: 6520 636f 756c 6420 6e6f 7420 6669 6e64  e could not find
-0001d6c0: 2061 2062 6163 6b77 6172 6420 666f 7220   a backward for 
-0001d6d0: 7468 6973 2073 796d 626f 6c2c 2073 6f20  this symbol, so 
-0001d6e0: 7765 2074 7279 2074 6f20 6465 636f 6d70  we try to decomp
-0001d6f0: 6f73 6520 6974 0a20 2020 2020 2020 2020  ose it.         
-0001d700: 2020 2020 2020 2062 6163 6b77 6172 6420         backward 
-0001d710: 3d20 7061 7274 6961 6c28 6465 636f 6d70  = partial(decomp
-0001d720: 6f73 6564 5f66 6e5f 6261 636b 7761 7264  osed_fn_backward
-0001d730: 5f72 756c 652c 2073 796d 626f 6c2e 7379  _rule, symbol.sy
-0001d740: 6d29 0a20 2020 2020 2020 2020 2020 2065  m).            e
-0001d750: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0001d760: 2020 2020 2023 2057 6520 636f 756c 6420       # We could 
-0001d770: 6e6f 7420 6669 6e64 2061 2062 6163 6b77  not find a backw
-0001d780: 6172 6420 666f 7220 7468 6973 2073 796d  ard for this sym
-0001d790: 626f 6c20 616e 6420 7765 2063 6f75 6c64  bol and we could
-0001d7a0: 206e 6f74 2064 6563 6f6d 706f 7365 2069   not decompose i
-0001d7b0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-0001d7c0: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
-0001d7d0: 6d65 6e74 6564 4572 726f 7228 6622 4261  mentedError(f"Ba
-0001d7e0: 636b 7761 7264 2066 6f72 207b 7379 6d62  ckward for {symb
-0001d7f0: 6f6c 2e73 796d 2e69 647d 2069 7320 6e6f  ol.sym.id} is no
-0001d800: 7420 696d 706c 656d 656e 7465 6422 290a  t implemented").
-0001d810: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
-0001d820: 3d20 6261 636b 7761 7264 282a 7265 7369  = backward(*resi
-0001d830: 6475 616c 732c 202a 636f 7461 6e67 656e  duals, *cotangen
-0001d840: 7473 290a 2020 2020 2020 2020 6966 2069  ts).        if i
-0001d850: 7369 6e73 7461 6e63 6528 7265 7375 6c74  sinstance(result
-0001d860: 2c20 6469 6374 293a 0a20 2020 2020 2020  , dict):.       
-0001d870: 2020 2020 2023 2049 6620 7468 6520 6261       # If the ba
-0001d880: 636b 7761 7264 2072 6574 7572 6e73 2061  ckward returns a
-0001d890: 2064 6963 742c 2077 6520 6173 7375 6d65   dict, we assume
-0001d8a0: 2074 6861 7420 6974 2069 7320 6120 6469   that it is a di
-0001d8b0: 6374 206f 660a 2020 2020 2020 2020 2020  ct of.          
-0001d8c0: 2020 2320 666f 7277 6172 6420 6172 6775    # forward argu
-0001d8d0: 6d65 6e74 7320 746f 2074 6865 2063 6f72  ments to the cor
-0001d8e0: 7265 7370 6f6e 6469 6e67 0a20 2020 2020  responding.     
-0001d8f0: 2020 2020 2020 2023 2067 7261 6469 656e         # gradien
-0001d900: 7473 2f63 6f74 616e 6765 6e74 732f 6164  ts/cotangents/ad
-0001d910: 6a6f 696e 7473 2f73 656e 7369 7469 7669  joints/sensitivi
-0001d920: 7469 6573 2e0a 2020 2020 2020 2020 2020  ties..          
-0001d930: 2020 7573 6564 5f6e 616d 6573 203d 2073    used_names = s
-0001d940: 6574 2829 0a20 2020 2020 2020 2020 2020  et().           
-0001d950: 2066 6f72 2069 2c20 286b 2c20 7629 2069   for i, (k, v) i
-0001d960: 6e20 656e 756d 6572 6174 6528 696e 7370  n enumerate(insp
-0001d970: 6563 742e 7369 676e 6174 7572 6528 6175  ect.signature(au
-0001d980: 675f 666f 7277 6172 6429 2e70 6172 616d  g_forward).param
-0001d990: 6574 6572 732e 6974 656d 7328 2929 3a0a  eters.items()):.
-0001d9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d9b0: 6966 2076 2e6b 696e 6420 696e 2028 696e  if v.kind in (in
-0001d9c0: 7370 6563 742e 5061 7261 6d65 7465 722e  spect.Parameter.
-0001d9d0: 504f 5349 5449 4f4e 414c 5f4f 4e4c 592c  POSITIONAL_ONLY,
-0001d9e0: 2069 6e73 7065 6374 2e50 6172 616d 6574   inspect.Paramet
-0001d9f0: 6572 2e50 4f53 4954 494f 4e41 4c5f 4f52  er.POSITIONAL_OR
-0001da00: 5f4b 4559 574f 5244 293a 0a20 2020 2020  _KEYWORD):.     
-0001da10: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0001da20: 7574 5f67 7261 6428 7379 6d62 6f6c 2e61  ut_grad(symbol.a
-0001da30: 7267 735b 695d 2c20 7265 7375 6c74 2e67  rgs[i], result.g
-0001da40: 6574 286b 2c20 4e6f 6e65 2929 0a20 2020  et(k, None)).   
-0001da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001da60: 2075 7365 645f 6e61 6d65 732e 6164 6428   used_names.add(
-0001da70: 6b29 0a0a 2020 2020 2020 2020 2020 2020  k)..            
-0001da80: 2320 466f 7220 6465 7665 6c6f 7065 7220  # For developer 
-0001da90: 636f 6e76 656e 6965 6e63 652c 2077 6520  convenience, we 
-0001daa0: 616c 6c6f 7720 7573 696e 6720 7468 6520  allow using the 
-0001dab0: 6e61 6d65 2066 726f 6d20 7468 650a 2020  name from the.  
-0001dac0: 2020 2020 2020 2020 2020 2320 666f 7277            # forw
-0001dad0: 6172 6420 6d65 7461 2069 6e20 6164 6469  ard meta in addi
-0001dae0: 7469 6f6e 2074 6f20 7468 6520 6e61 6d65  tion to the name
-0001daf0: 2066 726f 6d20 7468 6520 6175 676d 656e   from the augmen
-0001db00: 7465 6420 666f 7277 6172 640a 2020 2020  ted forward.    
-0001db10: 2020 2020 2020 2020 2320 7369 676e 6174          # signat
-0001db20: 7572 652e 0a20 2020 2020 2020 2020 2020  ure..           
-0001db30: 2023 2049 6620 626f 7468 206e 616d 6573   # If both names
-0001db40: 2061 7265 2075 7365 642c 2074 6865 206f   are used, the o
-0001db50: 6e65 2066 726f 6d20 7468 6520 666f 7277  ne from the forw
-0001db60: 6172 6420 6d65 7461 2074 616b 6573 0a20  ard meta takes. 
-0001db70: 2020 2020 2020 2020 2020 2023 2070 7265             # pre
-0001db80: 6365 6465 6e63 652e 0a20 2020 2020 2020  cedence..       
-0001db90: 2020 2020 2066 6f72 2069 2c20 286b 2c20       for i, (k, 
-0001dba0: 7629 2069 6e20 656e 756d 6572 6174 6528  v) in enumerate(
-0001dbb0: 696e 7370 6563 742e 7369 676e 6174 7572  inspect.signatur
-0001dbc0: 6528 7379 6d62 6f6c 2e73 796d 2e6d 6574  e(symbol.sym.met
-0001dbd0: 6129 2e70 6172 616d 6574 6572 732e 6974  a).parameters.it
-0001dbe0: 656d 7328 2929 3a0a 2020 2020 2020 2020  ems()):.        
-0001dbf0: 2020 2020 2020 2020 6966 2076 2e6b 696e          if v.kin
-0001dc00: 6420 696e 2028 696e 7370 6563 742e 5061  d in (inspect.Pa
-0001dc10: 7261 6d65 7465 722e 504f 5349 5449 4f4e  rameter.POSITION
-0001dc20: 414c 5f4f 4e4c 592c 2069 6e73 7065 6374  AL_ONLY, inspect
-0001dc30: 2e50 6172 616d 6574 6572 2e50 4f53 4954  .Parameter.POSIT
-0001dc40: 494f 4e41 4c5f 4f52 5f4b 4559 574f 5244  IONAL_OR_KEYWORD
-0001dc50: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001dc60: 2020 2020 2020 2069 6620 6b20 6e6f 7420         if k not 
-0001dc70: 696e 2075 7365 645f 6e61 6d65 733a 0a20  in used_names:. 
-0001dc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dc90: 2020 2020 2020 2070 7574 5f67 7261 6428         put_grad(
-0001dca0: 7379 6d62 6f6c 2e61 7267 735b 695d 2c20  symbol.args[i], 
-0001dcb0: 7265 7375 6c74 2e67 6574 286b 2c20 4e6f  result.get(k, No
-0001dcc0: 6e65 2929 0a20 2020 2020 2020 2020 2020  ne)).           
-0001dcd0: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
-0001dce0: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
-0001dcf0: 616e 6365 2872 6573 756c 742c 2053 6571  ance(result, Seq
-0001dd00: 7565 6e63 6529 3a0a 2020 2020 2020 2020  uence):.        
-0001dd10: 2020 2020 7265 7375 6c74 203d 2028 7265      result = (re
-0001dd20: 7375 6c74 2c29 0a0a 2020 2020 2020 2020  sult,)..        
-0001dd30: 6465 6620 6973 5f64 6966 6665 7265 6e74  def is_different
-0001dd40: 6961 626c 6528 6172 6729 3a0a 2020 2020  iable(arg):.    
-0001dd50: 2020 2020 2020 2020 6d61 7463 6820 6172          match ar
-0001dd60: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
-0001dd70: 2020 2063 6173 6520 5465 6e73 6f72 5072     case TensorPr
-0001dd80: 6f78 7928 293a 0a20 2020 2020 2020 2020  oxy():.         
-0001dd90: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001dda0: 6e20 6474 7970 6573 2e69 735f 696e 6578  n dtypes.is_inex
-0001ddb0: 6163 745f 6474 7970 6528 6172 672e 6474  act_dtype(arg.dt
-0001ddc0: 7970 6529 0a20 2020 2020 2020 2020 2020  ype).           
-0001ddd0: 2020 2020 2063 6173 6520 5365 7175 656e       case Sequen
-0001dde0: 6365 2829 3a0a 2020 2020 2020 2020 2020  ce():.          
-0001ddf0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001de00: 2061 7267 2061 6e64 2061 6c6c 2869 7369   arg and all(isi
-0001de10: 6e73 7461 6e63 6528 782c 2054 656e 736f  nstance(x, Tenso
-0001de20: 7250 726f 7879 2920 616e 6420 6474 7970  rProxy) and dtyp
-0001de30: 6573 2e69 735f 696e 6578 6163 745f 6474  es.is_inexact_dt
-0001de40: 7970 6528 782e 6474 7970 6529 2066 6f72  ype(x.dtype) for
-0001de50: 2078 2069 6e20 6172 6729 0a20 2020 2020   x in arg).     
-0001de60: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-0001de70: 5f3a 0a20 2020 2020 2020 2020 2020 2020  _:.             
-0001de80: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
-0001de90: 6c73 650a 0a20 2020 2020 2020 2069 6620  lse..        if 
-0001dea0: 6c65 6e28 7379 6d62 6f6c 2e61 7267 7329  len(symbol.args)
-0001deb0: 2021 3d20 286f 7269 675f 7265 735f 6c65   != (orig_res_le
-0001dec0: 6e20 3a3d 206c 656e 2872 6573 756c 7429  n := len(result)
-0001ded0: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-0001dee0: 6865 636b 280a 2020 2020 2020 2020 2020  heck(.          
-0001def0: 2020 2020 2020 6f72 6967 5f72 6573 5f6c        orig_res_l
-0001df00: 656e 203c 3d20 6c65 6e28 7379 6d62 6f6c  en <= len(symbol
-0001df10: 2e61 7267 7329 2c0a 2020 2020 2020 2020  .args),.        
-0001df20: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
-0001df30: 6622 4261 636b 7761 7264 2066 6f72 207b  f"Backward for {
-0001df40: 7379 6d62 6f6c 2e73 796d 2e69 647d 2072  symbol.sym.id} r
-0001df50: 6574 7572 6e65 6420 7b6f 7269 675f 7265  eturned {orig_re
-0001df60: 735f 6c65 6e7d 2076 616c 7565 732c 2022  s_len} values, "
-0001df70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001df80: 202b 2066 2262 7574 2065 7870 6563 7465   + f"but expecte
-0001df90: 6420 6174 206d 6f73 7420 7b6c 656e 2873  d at most {len(s
-0001dfa0: 796d 626f 6c2e 6172 6773 297d 222c 0a20  ymbol.args)}",. 
-0001dfb0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0001dfc0: 2020 2020 2020 2020 2023 2041 7373 756d           # Assum
-0001dfd0: 696e 6720 7468 6174 2074 6865 206e 6f6e  ing that the non
-0001dfe0: 2d64 6966 6665 7265 6e74 6961 626c 6520  -differentiable 
-0001dff0: 6172 6775 6d65 6e74 7320 7765 7265 2064  arguments were d
-0001e000: 726f 7070 6564 2066 726f 6d0a 2020 2020  ropped from.    
-0001e010: 2020 2020 2020 2020 2320 7468 6520 6261          # the ba
-0001e020: 636b 7761 7264 2066 756e 6374 696f 6e2c  ckward function,
-0001e030: 2077 6520 6172 6520 676f 696e 6720 746f   we are going to
-0001e040: 2061 7070 656e 6420 4e6f 6e65 2074 6f20   append None to 
-0001e050: 7468 6520 7265 7375 6c74 0a20 2020 2020  the result.     
-0001e060: 2020 2020 2020 2023 2074 6f20 6d61 7463         # to matc
-0001e070: 6820 7468 6520 6e75 6d62 6572 206f 6620  h the number of 
-0001e080: 6172 6775 6d65 6e74 732e 2041 6c74 6572  arguments. Alter
-0001e090: 6e61 7469 7665 6c79 2c20 7765 2063 6f75  natively, we cou
-0001e0a0: 6c64 206a 7573 740a 2020 2020 2020 2020  ld just.        
-0001e0b0: 2020 2020 2320 6861 7665 2061 2066 6f72      # have a for
-0001e0c0: 2d6c 6f6f 7020 7769 7468 2061 2063 6f6e  -loop with a con
-0001e0d0: 6469 7469 6f6e 616c 2077 6865 6e20 7772  ditional when wr
-0001e0e0: 6974 696e 6720 746f 2074 6865 0a20 2020  iting to the.   
-0001e0f0: 2020 2020 2020 2020 2023 2065 6e76 6972           # envir
-0001e100: 6f6e 6d65 6e74 2e0a 0a20 2020 2020 2020  onment...       
-0001e110: 2020 2020 2069 7465 725f 7265 7375 6c74       iter_result
-0001e120: 203d 2069 7465 7228 7265 7375 6c74 290a   = iter(result).
-0001e130: 2020 2020 2020 2020 2020 2020 6e5f 6469              n_di
-0001e140: 6666 6572 656e 7469 6162 6c65 5f61 7267  fferentiable_arg
-0001e150: 7320 3d20 7375 6d28 626f 6f6c 2869 735f  s = sum(bool(is_
-0001e160: 6469 6666 6572 656e 7469 6162 6c65 2861  differentiable(a
-0001e170: 7267 2929 2066 6f72 2061 7267 2069 6e20  rg)) for arg in 
-0001e180: 7379 6d62 6f6c 2e61 7267 7329 0a20 2020  symbol.args).   
-0001e190: 2020 2020 2020 2020 2063 6865 636b 280a           check(.
-0001e1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e1b0: 6e5f 6469 6666 6572 656e 7469 6162 6c65  n_differentiable
-0001e1c0: 5f61 7267 7320 3c3d 206f 7269 675f 7265  _args <= orig_re
-0001e1d0: 735f 6c65 6e2c 0a20 2020 2020 2020 2020  s_len,.         
-0001e1e0: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
-0001e1f0: 2242 6163 6b77 6172 6420 666f 7220 7b73  "Backward for {s
-0001e200: 796d 626f 6c2e 7379 6d2e 6964 7d20 7265  ymbol.sym.id} re
-0001e210: 7475 726e 6564 207b 6f72 6967 5f72 6573  turned {orig_res
-0001e220: 5f6c 656e 7d20 7661 6c75 6528 7329 2c20  _len} value(s), 
-0001e230: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0001e240: 2020 2b20 6622 6275 7420 6578 7065 6374    + f"but expect
-0001e250: 6564 207b 6e5f 6469 6666 6572 656e 7469  ed {n_differenti
-0001e260: 6162 6c65 5f61 7267 737d 222c 0a20 2020  able_args}",.   
-0001e270: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0001e280: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-0001e290: 2074 7570 6c65 286e 6578 7428 6974 6572   tuple(next(iter
-0001e2a0: 5f72 6573 756c 7429 2069 6620 6973 5f64  _result) if is_d
-0001e2b0: 6966 6665 7265 6e74 6961 626c 6528 6172  ifferentiable(ar
-0001e2c0: 6729 2065 6c73 6520 4e6f 6e65 2066 6f72  g) else None for
-0001e2d0: 2061 7267 2069 6e20 7379 6d62 6f6c 2e61   arg in symbol.a
-0001e2e0: 7267 7329 0a0a 2020 2020 2020 2020 2320  rgs)..        # 
-0001e2f0: 5365 6520 2242 6163 6b77 6172 6420 696d  See "Backward im
-0001e300: 706c 2066 6f72 206f 7073 206f 6620 7468  pl for ops of th
-0001e310: 6520 7479 7065 2053 6571 7565 6e63 655b  e type Sequence[
-0001e320: 5465 6e73 6f72 5072 6f78 795d 2c20 2e2e  TensorProxy], ..
-0001e330: 2e20 2d3e 202e 2e2e 2072 6573 756c 7473  . -> ... results
-0001e340: 2069 6e20 4e6f 6e65 2067 7261 6473 2e22   in None grads."
-0001e350: 0a20 2020 2020 2020 2023 2054 6869 7320  .        # This 
-0001e360: 6973 2061 2074 656d 706f 7261 7279 2077  is a temporary w
-0001e370: 6f72 6b61 726f 756e 642e 0a20 2020 2020  orkaround..     
-0001e380: 2020 2069 6620 7379 6d62 6f6c 2e73 796d     if symbol.sym
-0001e390: 2e69 6420 696e 2028 7072 696d 732e 5072  .id in (prims.Pr
-0001e3a0: 696d 4944 732e 4341 542c 2022 746f 7263  imIDs.CAT, "torc
-0001e3b0: 682e 6361 7422 2c20 2274 6f72 6368 2e73  h.cat", "torch.s
-0001e3c0: 7461 636b 2229 3a0a 2020 2020 2020 2020  tack"):.        
-0001e3d0: 2020 2020 7361 6665 5f6d 6170 5f66 6c61      safe_map_fla
-0001e3e0: 7428 7075 745f 6772 6164 2c20 7379 6d62  t(put_grad, symb
-0001e3f0: 6f6c 2e61 7267 732c 2072 6573 756c 7429  ol.args, result)
-0001e400: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0001e410: 2020 2020 2020 2020 2020 2073 6166 655f             safe_
-0001e420: 6d61 7028 7075 745f 6772 6164 2c20 7379  map(put_grad, sy
-0001e430: 6d62 6f6c 2e61 7267 732c 2072 6573 756c  mbol.args, resul
-0001e440: 7429 0a0a 2020 2020 6465 6620 6765 745f  t)..    def get_
-0001e450: 696e 6578 6163 745f 6474 7970 655f 6f72  inexact_dtype_or
-0001e460: 5f6e 6f6e 6528 7829 3a0a 2020 2020 2020  _none(x):.      
-0001e470: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-0001e480: 782c 2028 5465 6e73 6f72 5072 6f78 792c  x, (TensorProxy,
-0001e490: 2046 7574 7572 6554 656e 736f 7250 726f   FutureTensorPro
-0001e4a0: 7879 2929 2061 6e64 2064 7479 7065 732e  xy)) and dtypes.
-0001e4b0: 6973 5f69 6e65 7861 6374 5f64 7479 7065  is_inexact_dtype
-0001e4c0: 2878 2e64 7479 7065 293a 0a20 2020 2020  (x.dtype):.     
-0001e4d0: 2020 2020 2020 2072 6574 7572 6e20 780a         return x.
-0001e4e0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001e4f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001e500: 204e 6f6e 650a 0a20 2020 2067 6172 6773   None..    gargs
-0001e510: 203d 2074 7265 655f 6d61 7028 6765 745f   = tree_map(get_
-0001e520: 6772 6164 2c20 7475 706c 6528 7472 6163  grad, tuple(trac
-0001e530: 652e 6172 6773 2929 0a20 2020 2067 6b77  e.args)).    gkw
-0001e540: 6172 6773 203d 2074 7265 655f 6d61 7028  args = tree_map(
-0001e550: 6765 745f 6772 6164 2c20 7472 6163 652e  get_grad, trace.
-0001e560: 6b77 6172 6773 290a 2020 2020 676b 7761  kwargs).    gkwa
-0001e570: 7267 7320 3d20 7b6b 3a20 7620 666f 7220  rgs = {k: v for 
-0001e580: 6b2c 2076 2069 6e20 676b 7761 7267 732e  k, v in gkwargs.
-0001e590: 6974 656d 7328 2920 6966 2076 2069 7320  items() if v is 
-0001e5a0: 6e6f 7420 4e6f 6e65 7d0a 2020 2020 6761  not None}.    ga
-0001e5b0: 7267 732c 2067 6b77 6172 6773 203d 2074  rgs, gkwargs = t
-0001e5c0: 7265 655f 6d61 7028 6765 745f 696e 6578  ree_map(get_inex
-0001e5d0: 6163 745f 6474 7970 655f 6f72 5f6e 6f6e  act_dtype_or_non
-0001e5e0: 652c 2028 6761 7267 732c 2067 6b77 6172  e, (gargs, gkwar
-0001e5f0: 6773 2929 0a20 2020 2072 6574 7572 6e20  gs)).    return 
-0001e600: 6761 7267 7320 2b20 2867 6b77 6172 6773  gargs + (gkwargs
-0001e610: 2c29 2069 6620 6c65 6e28 676b 7761 7267  ,) if len(gkwarg
-0001e620: 7329 2021 3d20 3020 656c 7365 2067 6172  s) != 0 else gar
-0001e630: 6773 0a0a 0a64 6566 2076 6a70 5f63 616c  gs...def vjp_cal
-0001e640: 6c5f 6d65 7461 6675 6e63 2864 6574 6163  l_metafunc(detac
-0001e650: 6865 643a 2062 6f6f 6c2c 2070 7269 6d61  hed: bool, prima
-0001e660: 6c73 2c20 636f 7461 6e67 656e 7473 2c20  ls, cotangents, 
-0001e670: 7472 6163 653a 2054 7261 6365 2c20 2a2a  trace: Trace, **
-0001e680: 6b77 6172 6773 293a 0a20 2020 2023 2041  kwargs):.    # A
-0001e690: 7373 756d 696e 6720 7072 696d 616c 7320  ssuming primals 
-0001e6a0: 6973 2066 6c61 740a 0a20 2020 2069 6620  is flat..    if 
-0001e6b0: 6e6f 7420 6973 696e 7374 616e 6365 2870  not isinstance(p
-0001e6c0: 7269 6d61 6c73 2c20 5365 7175 656e 6365  rimals, Sequence
-0001e6d0: 293a 0a20 2020 2020 2020 2070 7269 6d61  ):.        prima
-0001e6e0: 6c73 203d 2028 7072 696d 616c 732c 290a  ls = (primals,).
-0001e6f0: 0a20 2020 2063 7478 203d 2064 6574 6163  .    ctx = detac
-0001e700: 6865 645f 7472 6163 6528 2920 6966 2064  hed_trace() if d
-0001e710: 6574 6163 6865 6420 656c 7365 206e 756c  etached else nul
-0001e720: 6c63 6f6e 7465 7874 2829 0a20 2020 2077  lcontext().    w
-0001e730: 6974 6820 6374 783a 0a20 2020 2020 2020  ith ctx:.       
-0001e740: 2072 6573 756c 742c 2065 6e76 203d 2061   result, env = a
-0001e750: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
-0001e760: 5f70 6173 7328 2a70 7269 6d61 6c73 2c20  _pass(*primals, 
-0001e770: 7472 6163 653d 7472 6163 652c 202a 2a6b  trace=trace, **k
-0001e780: 7761 7267 7329 0a20 2020 2020 2020 2063  wargs).        c
-0001e790: 6865 636b 280a 2020 2020 2020 2020 2020  heck(.          
-0001e7a0: 2020 6c65 6e28 7265 7375 6c74 2920 3d3d    len(result) ==
-0001e7b0: 206c 656e 2863 6f74 616e 6765 6e74 7329   len(cotangents)
-0001e7c0: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
-0001e7d0: 6573 756c 742c 2053 6571 7565 6e63 6529  esult, Sequence)
-0001e7e0: 2065 6c73 6520 5472 7565 2c0a 2020 2020   else True,.    
-0001e7f0: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
-0001e800: 6622 4578 7065 6374 6564 2063 6f74 616e  f"Expected cotan
-0001e810: 6765 6e74 7320 746f 2062 6520 6120 7365  gents to be a se
-0001e820: 7175 656e 6365 206f 6620 6c65 6e67 7468  quence of length
-0001e830: 207b 6c65 6e28 7265 7375 6c74 297d 2c20   {len(result)}, 
-0001e840: 676f 7420 6120 7365 7175 656e 6365 206f  got a sequence o
-0001e850: 6620 6c65 6e67 7468 207b 6c65 6e28 636f  f length {len(co
-0001e860: 7461 6e67 656e 7473 297d 222c 0a20 2020  tangents)}",.   
-0001e870: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-0001e880: 6574 7572 6e20 7265 7375 6c74 2c20 6261  eturn result, ba
-0001e890: 636b 7761 7264 5f70 6173 7328 656e 762c  ckward_pass(env,
-0001e8a0: 2074 7261 6365 2c20 636f 7461 6e67 656e   trace, cotangen
-0001e8b0: 7473 290a 0a0a 2320 544f 444f 3a20 4361  ts)...# TODO: Ca
-0001e8c0: 6e27 7420 7573 6520 6120 5379 6d62 6f6c  n't use a Symbol
-0001e8d0: 2068 6572 6520 6265 6361 7573 6520 6d69   here because mi
-0001e8e0: 7865 6420 6578 6563 7574 6f72 2073 7962  xed executor syb
-0001e8f0: 7379 6d62 6f6c 7320 7365 656d 2074 6f20  symbols seem to 
-0001e900: 6265 0a23 2075 6e73 7570 706f 7274 6564  be.# unsupported
-0001e910: 2e20 5365 6520 6973 7375 6520 2243 6f75  . See issue "Cou
-0001e920: 6c64 206e 6f74 2066 696e 6420 616e 2065  ld not find an e
-0001e930: 7865 6375 746f 7220 666f 7220 626f 756e  xecutor for boun
-0001e940: 6420 7379 6d62 6f6c 2077 6865 6e20 6974  d symbol when it
-0001e950: 7320 7375 6273 796d 626f 6c73 0a23 2061  s subsymbols.# a
-0001e960: 7265 206e 6f74 2066 756c 6c79 2073 7570  re not fully sup
-0001e970: 706f 7274 6564 2062 7920 6120 7369 6e67  ported by a sing
-0001e980: 6c65 2065 7865 6375 746f 7222 0a76 6a70  le executor".vjp
-0001e990: 5f63 616c 6c20 3d20 7061 7274 6961 6c28  _call = partial(
-0001e9a0: 0a20 2020 2076 6a70 5f63 616c 6c5f 6d65  .    vjp_call_me
-0001e9b0: 7461 6675 6e63 2c20 4661 6c73 650a 2920  tafunc, False.) 
-0001e9c0: 2023 2053 796d 626f 6c28 6964 3d54 7261   # Symbol(id=Tra
-0001e9d0: 6e73 666f 726d 732e 566a 704f 702c 206e  nsforms.VjpOp, n
-0001e9e0: 616d 653d 2276 6a70 5f63 616c 6c22 2c20  ame="vjp_call", 
-0001e9f0: 6d65 7461 3d70 6172 7469 616c 2876 6a70  meta=partial(vjp
-0001ea00: 5f63 616c 6c5f 6d65 7461 6675 6e63 2c20  _call_metafunc, 
-0001ea10: 4661 6c73 6529 290a 0a0a 6465 6620 766a  False))...def vj
-0001ea20: 7028 6675 6e63 293a 0a20 2020 2022 2222  p(func):.    """
-0001ea30: 436f 6d70 7574 6573 2074 6865 2056 4a50  Computes the VJP
-0001ea40: 206f 6620 6120 6675 6e63 7469 6f6e 2e0a   of a function..
-0001ea50: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-0001ea60: 2020 2066 756e 6320 2843 616c 6c61 626c     func (Callabl
-0001ea70: 6529 3a20 4675 6e63 7469 6f6e 2074 6f20  e): Function to 
-0001ea80: 6265 2064 6966 6665 7265 6e74 6961 7465  be differentiate
-0001ea90: 642e 0a20 2020 2022 2222 0a0a 2020 2020  d..    """..    
-0001eaa0: 6465 6620 5f76 6a70 2870 7269 6d61 6c73  def _vjp(primals
-0001eab0: 2c20 636f 7461 6e67 656e 7473 2c20 2a2a  , cotangents, **
-0001eac0: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-0001ead0: 2066 6c61 745f 6675 6e63 2c20 666c 6174   flat_func, flat
-0001eae0: 5f61 7267 732c 2073 7065 6320 3d20 666c  _args, spec = fl
-0001eaf0: 6174 7465 6e5f 6675 6e63 2866 756e 632c  atten_func(func,
-0001eb00: 2070 7269 6d61 6c73 2c20 6b77 6172 6773   primals, kwargs
-0001eb10: 290a 2020 2020 2020 2020 7472 6163 6520  ).        trace 
-0001eb20: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
-0001eb30: 6528 2928 666c 6174 5f66 756e 632c 202a  e()(flat_func, *
-0001eb40: 666c 6174 5f61 7267 7329 0a20 2020 2020  flat_args).     
-0001eb50: 2020 2072 6573 756c 742c 2076 6a70 5f72     result, vjp_r
-0001eb60: 6573 756c 7420 3d20 766a 705f 6361 6c6c  esult = vjp_call
-0001eb70: 2866 6c61 745f 6172 6773 2c20 636f 7461  (flat_args, cota
-0001eb80: 6e67 656e 7473 2c20 7472 6163 653d 7472  ngents, trace=tr
-0001eb90: 6163 6529 0a20 2020 2020 2020 2067 7072  ace).        gpr
-0001eba0: 696d 616c 732c 2067 6b77 6172 6773 203d  imals, gkwargs =
-0001ebb0: 2074 7265 655f 756e 666c 6174 7465 6e28   tree_unflatten(
-0001ebc0: 766a 705f 7265 7375 6c74 2c20 7370 6563  vjp_result, spec
-0001ebd0: 290a 2020 2020 2020 2020 6772 6164 7320  ).        grads 
-0001ebe0: 3d20 6770 7269 6d61 6c73 202b 2028 676b  = gprimals + (gk
-0001ebf0: 7761 7267 732c 2920 6966 206c 656e 2867  wargs,) if len(g
-0001ec00: 6b77 6172 6773 2920 213d 2030 2065 6c73  kwargs) != 0 els
-0001ec10: 6520 6770 7269 6d61 6c73 0a20 2020 2020  e gprimals.     
-0001ec20: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-0001ec30: 2c20 6772 6164 730a 0a20 2020 2072 6574  , grads..    ret
-0001ec40: 7572 6e20 5f76 6a70 0a0a 0a64 6566 2076  urn _vjp...def v
-0001ec50: 616c 7565 5f61 6e64 5f67 7261 6428 6675  alue_and_grad(fu
-0001ec60: 6e63 293a 0a20 2020 2022 2222 436f 6d70  nc):.    """Comp
-0001ec70: 7574 6573 2074 6865 2076 616c 7565 2061  utes the value a
-0001ec80: 6e64 2067 7261 6469 656e 7420 6f66 2061  nd gradient of a
-0001ec90: 2066 756e 6374 696f 6e2e 0a0a 2020 2020   function...    
-0001eca0: 5468 6973 2069 7320 6120 636f 6e76 656e  This is a conven
-0001ecb0: 6965 6e63 6520 6675 6e63 7469 6f6e 2074  ience function t
-0001ecc0: 6861 7420 636f 6d62 696e 6573 2074 6865  hat combines the
-0001ecd0: 2066 756e 6374 696f 6e61 6c69 7479 206f   functionality o
-0001ece0: 660a 2020 2020 6076 6a70 5f63 616c 6c60  f.    `vjp_call`
-0001ecf0: 2077 6974 6820 696d 706c 6963 6974 2069   with implicit i
-0001ed00: 6e69 7469 616c 697a 6174 696f 6e20 6f66  nitialization of
-0001ed10: 2074 6865 2063 6f74 616e 6765 6e74 2074   the cotangent t
-0001ed20: 6f20 312e 0a0a 2020 2020 4172 6773 3a0a  o 1...    Args:.
-0001ed30: 2020 2020 2020 2020 6675 6e63 2028 4361          func (Ca
-0001ed40: 6c6c 6162 6c65 293a 2046 756e 6374 696f  llable): Functio
-0001ed50: 6e20 746f 2062 6520 6469 6666 6572 656e  n to be differen
-0001ed60: 7469 6174 6564 2e0a 2020 2020 2222 220a  tiated..    """.
-0001ed70: 0a20 2020 2064 6566 206f 6e65 735f 6c69  .    def ones_li
-0001ed80: 6b65 2878 293a 0a20 2020 2020 2020 2069  ke(x):.        i
-0001ed90: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
-0001eda0: 5465 6e73 6f72 5072 6f78 7929 3a0a 2020  TensorProxy):.  
-0001edb0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001edc0: 2066 756c 6c5f 6c69 6b65 2878 2c20 6669   full_like(x, fi
-0001edd0: 6c6c 5f76 616c 7565 3d31 290a 2020 2020  ll_value=1).    
-0001ede0: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-0001edf0: 6e63 6528 782c 204e 756d 6265 7250 726f  nce(x, NumberPro
-0001ee00: 7879 293a 0a20 2020 2020 2020 2020 2020  xy):.           
-0001ee10: 2072 6574 7572 6e20 7479 7065 2878 2e76   return type(x.v
-0001ee20: 616c 7565 2928 3129 0a20 2020 2020 2020  alue)(1).       
-0001ee30: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001ee40: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0001ee50: 726f 7228 6622 6f6e 6573 5f6c 696b 6520  ror(f"ones_like 
-0001ee60: 696e 7369 6465 2076 616c 7565 5f61 6e64  inside value_and
-0001ee70: 5f67 7261 6420 676f 7420 616e 2075 6e73  _grad got an uns
-0001ee80: 7570 706f 7274 6564 2074 7970 6520 7b74  upported type {t
-0001ee90: 7970 6528 7829 7d22 290a 0a20 2020 2064  ype(x)}")..    d
-0001eea0: 6566 205f 7661 6c75 655f 616e 645f 6772  ef _value_and_gr
-0001eeb0: 6164 282a 6172 6773 2c20 2a2a 6b77 6172  ad(*args, **kwar
-0001eec0: 6773 293a 0a20 2020 2020 2020 2074 7261  gs):.        tra
-0001eed0: 6365 203d 2063 6f6e 7374 7275 6374 5f74  ce = construct_t
-0001eee0: 7261 6365 2829 2866 756e 632c 202a 6172  race()(func, *ar
-0001eef0: 6773 2c20 2a2a 6b77 6172 6773 290a 2020  gs, **kwargs).  
-0001ef00: 2020 2020 2020 636f 7461 6e67 656e 7473        cotangents
-0001ef10: 203d 2074 7265 655f 6d61 7028 6c61 6d62   = tree_map(lamb
-0001ef20: 6461 2076 3a20 6f6e 6573 5f6c 696b 6528  da v: ones_like(
-0001ef30: 7629 2c20 7472 6163 652e 6f75 7470 7574  v), trace.output
-0001ef40: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0001ef50: 2076 6a70 2866 756e 6329 2861 7267 732c   vjp(func)(args,
-0001ef60: 2063 6f74 616e 6765 6e74 732c 202a 2a6b   cotangents, **k
-0001ef70: 7761 7267 7329 0a0a 2020 2020 7265 7475  wargs)..    retu
-0001ef80: 726e 205f 7661 6c75 655f 616e 645f 6772  rn _value_and_gr
-0001ef90: 6164 0a0a 0a46 6f72 7761 7264 4261 636b  ad...ForwardBack
-0001efa0: 7761 7264 5472 6163 6573 203d 206e 616d  wardTraces = nam
-0001efb0: 6564 7475 706c 6528 2246 6f72 7761 7264  edtuple("Forward
-0001efc0: 4261 636b 7761 7264 5472 6163 6573 222c  BackwardTraces",
-0001efd0: 205b 2266 6f72 7761 7264 5f74 7261 6365   ["forward_trace
-0001efe0: 222c 2022 6261 636b 7761 7264 5f74 7261  ", "backward_tra
-0001eff0: 6365 225d 290a 0a0a 6465 6620 5f73 706c  ce"])...def _spl
-0001f000: 6974 5f73 6176 6564 5f66 6f72 5f62 6163  it_saved_for_bac
-0001f010: 6b77 6172 645f 696e 746f 5f74 656e 736f  kward_into_tenso
-0001f020: 7273 5f61 6e64 5f6f 7468 6572 280a 2020  rs_and_other(.  
-0001f030: 2020 7361 7665 645f 666f 725f 6261 636b    saved_for_back
-0001f040: 7761 7264 3a20 5365 7175 656e 6365 5b56  ward: Sequence[V
-0001f050: 6172 6961 626c 655d 2c0a 2920 2d3e 2074  ariable],.) -> t
-0001f060: 7570 6c65 5b53 6571 7565 6e63 655b 5661  uple[Sequence[Va
-0001f070: 7269 6162 6c65 5d2c 2053 6571 7565 6e63  riable], Sequenc
-0001f080: 655b 5661 7269 6162 6c65 5d5d 3a0a 2020  e[Variable]]:.  
-0001f090: 2020 2222 2253 706c 6974 7320 7361 7665    """Splits save
-0001f0a0: 645f 666f 725f 6261 636b 7761 7264 2069  d_for_backward i
-0001f0b0: 6e74 6f20 7465 6e73 6f72 7320 616e 6420  nto tensors and 
-0001f0c0: 6f74 6865 722e 0a0a 2020 2020 4172 6773  other...    Args
-0001f0d0: 3a0a 2020 2020 2020 2020 7361 7665 645f  :.        saved_
-0001f0e0: 666f 725f 6261 636b 7761 7264 2028 5365  for_backward (Se
-0001f0f0: 7175 656e 6365 5b56 6172 6961 626c 655d  quence[Variable]
-0001f100: 293a 2053 6176 6564 5f66 6f72 5f62 6163  ): Saved_for_bac
-0001f110: 6b77 6172 6420 746f 2073 706c 6974 2e0a  kward to split..
-0001f120: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-0001f130: 2020 2020 2020 7475 706c 655b 5365 7175        tuple[Sequ
-0001f140: 656e 6365 5b56 6172 6961 626c 655d 2c20  ence[Variable], 
-0001f150: 5365 7175 656e 6365 5b56 6172 6961 626c  Sequence[Variabl
-0001f160: 655d 5d3a 2054 7570 6c65 206f 6620 7465  e]]: Tuple of te
-0001f170: 6e73 6f72 7320 616e 6420 6f74 6865 722e  nsors and other.
-0001f180: 0a20 2020 2022 2222 0a20 2020 2069 735f  .    """.    is_
-0001f190: 7465 6e73 6f72 203d 206c 616d 6264 6120  tensor = lambda 
-0001f1a0: 783a 2069 7369 6e73 7461 6e63 6528 782c  x: isinstance(x,
-0001f1b0: 2054 656e 736f 7250 726f 7879 290a 2020   TensorProxy).  
-0001f1c0: 2020 6f74 6865 722c 2074 656e 736f 7273    other, tensors
-0001f1d0: 203d 2075 7469 6c73 2e70 6172 7469 7469   = utils.partiti
-0001f1e0: 6f6e 2869 735f 7465 6e73 6f72 2c20 7361  on(is_tensor, sa
-0001f1f0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001f200: 290a 2020 2020 7265 7475 726e 2074 7570  ).    return tup
-0001f210: 6c65 2874 656e 736f 7273 292c 2074 7570  le(tensors), tup
-0001f220: 6c65 286f 7468 6572 290a 0a0a 6465 6620  le(other)...def 
-0001f230: 5f75 7064 6174 655f 666f 7277 6172 645f  _update_forward_
-0001f240: 7769 7468 5f6e 6577 5f73 6176 6564 5f66  with_new_saved_f
-0001f250: 6f72 5f62 6163 6b77 6172 6428 666f 7277  or_backward(forw
-0001f260: 6172 645f 7472 6163 653a 2054 7261 6365  ard_trace: Trace
-0001f270: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
-0001f280: 7761 7264 3a20 5365 7175 656e 6365 5b56  ward: Sequence[V
-0001f290: 6172 6961 626c 655d 2920 2d3e 204e 6f6e  ariable]) -> Non
-0001f2a0: 653a 0a20 2020 2022 2222 5570 6461 7465  e:.    """Update
-0001f2b0: 7320 7468 6520 666f 7277 6172 6420 7472  s the forward tr
-0001f2c0: 6163 6520 7769 7468 206e 6577 2073 6176  ace with new sav
-0001f2d0: 6564 5f66 6f72 5f62 6163 6b77 6172 642e  ed_for_backward.
-0001f2e0: 0a0a 2020 2020 5468 6973 2069 7320 6e65  ..    This is ne
-0001f2f0: 6365 7373 6172 7920 6265 6361 7573 6520  cessary because 
-0001f300: 7468 6520 7570 6461 7465 6420 7361 7665  the updated save
-0001f310: 645f 666f 725f 6261 636b 7761 7264 2069  d_for_backward i
-0001f320: 7320 6e6f 7420 6176 6169 6c61 626c 650a  s not available.
-0001f330: 2020 2020 7768 656e 2074 6865 2066 6f72      when the for
-0001f340: 7761 7264 2061 6e64 2062 6163 6b77 6172  ward and backwar
-0001f350: 6420 7472 6163 6573 2061 7265 2063 6f6e  d traces are con
-0001f360: 7374 7275 6374 6564 2e0a 0a20 2020 2041  structed...    A
-0001f370: 7267 733a 0a20 2020 2020 2020 2066 6f72  rgs:.        for
-0001f380: 7761 7264 5f74 7261 6365 2028 5472 6163  ward_trace (Trac
-0001f390: 6529 3a20 466f 7277 6172 6420 7472 6163  e): Forward trac
-0001f3a0: 6520 746f 2075 7064 6174 652e 0a20 2020  e to update..   
-0001f3b0: 2020 2020 2073 6176 6564 5f66 6f72 5f62       saved_for_b
-0001f3c0: 6163 6b77 6172 6420 2853 6571 7565 6e63  ackward (Sequenc
-0001f3d0: 655b 5661 7269 6162 6c65 5d29 3a20 5361  e[Variable]): Sa
-0001f3e0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001f3f0: 2074 6f20 7573 6520 746f 0a20 2020 2020   to use to.     
-0001f400: 2020 2020 2020 2075 7064 6174 6520 7468         update th
-0001f410: 6520 666f 7277 6172 6420 7472 6163 652e  e forward trace.
-0001f420: 0a20 2020 2022 2222 0a20 2020 2073 6176  .    """.    sav
-0001f430: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
-0001f440: 3d20 7472 6565 5f6d 6170 286c 616d 6264  = tree_map(lambd
-0001f450: 6120 783a 2078 2e76 616c 7565 2069 6620  a x: x.value if 
-0001f460: 6973 696e 7374 616e 6365 2878 2c20 4e75  isinstance(x, Nu
-0001f470: 6d62 6572 5072 6f78 7929 2065 6c73 6520  mberProxy) else 
-0001f480: 782c 2073 6176 6564 5f66 6f72 5f62 6163  x, saved_for_bac
-0001f490: 6b77 6172 6429 0a20 2020 2073 6176 6564  kward).    saved
-0001f4a0: 5f74 656e 736f 7273 2c20 7361 7665 645f  _tensors, saved_
-0001f4b0: 6f74 6865 7220 3d20 5f73 706c 6974 5f73  other = _split_s
-0001f4c0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001f4d0: 645f 696e 746f 5f74 656e 736f 7273 5f61  d_into_tensors_a
-0001f4e0: 6e64 5f6f 7468 6572 2873 6176 6564 5f66  nd_other(saved_f
-0001f4f0: 6f72 5f62 6163 6b77 6172 6429 0a20 2020  or_backward).   
-0001f500: 2061 7373 6572 7420 666f 7277 6172 645f   assert forward_
-0001f510: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
-0001f520: 6f6c 735b 2d31 5d2e 7379 6d2e 6964 203d  ols[-1].sym.id =
-0001f530: 3d20 7072 696d 732e 5072 696d 4944 732e  = prims.PrimIDs.
-0001f540: 5245 5455 524e 0a20 2020 206e 6577 5f72  RETURN.    new_r
-0001f550: 6574 7572 6e20 3d20 2866 6f72 7761 7264  eturn = (forward
-0001f560: 5f74 7261 6365 2e6f 7574 7075 745b 305d  _trace.output[0]
-0001f570: 2c20 2873 6176 6564 5f74 656e 736f 7273  , (saved_tensors
-0001f580: 2c20 7361 7665 645f 6f74 6865 7229 290a  , saved_other)).
-0001f590: 2020 2020 666f 7277 6172 645f 7472 6163      forward_trac
-0001f5a0: 652e 626f 756e 645f 7379 6d62 6f6c 735b  e.bound_symbols[
-0001f5b0: 2d31 5d20 3d20 7265 706c 6163 6528 666f  -1] = replace(fo
-0001f5c0: 7277 6172 645f 7472 6163 652e 626f 756e  rward_trace.boun
-0001f5d0: 645f 7379 6d62 6f6c 735b 2d31 5d2c 2061  d_symbols[-1], a
-0001f5e0: 7267 733d 6e65 775f 7265 7475 726e 290a  rgs=new_return).
-0001f5f0: 0a0a 6465 6620 5f75 7064 6174 655f 6261  ..def _update_ba
-0001f600: 636b 7761 7264 5f77 6974 685f 6e65 775f  ckward_with_new_
-0001f610: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-0001f620: 7264 2862 6163 6b77 6172 645f 7472 6163  rd(backward_trac
-0001f630: 653a 2054 7261 6365 2c20 7361 7665 645f  e: Trace, saved_
-0001f640: 666f 725f 6261 636b 7761 7264 3a20 5365  for_backward: Se
-0001f650: 7175 656e 6365 5b56 6172 6961 626c 655d  quence[Variable]
-0001f660: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
-0001f670: 2222 5570 6461 7465 7320 7468 6520 6261  ""Updates the ba
-0001f680: 636b 7761 7264 2074 7261 6365 2077 6974  ckward trace wit
-0001f690: 6820 6e65 7720 7361 7665 645f 666f 725f  h new saved_for_
-0001f6a0: 6261 636b 7761 7264 2e0a 0a20 2020 2054  backward...    T
-0001f6b0: 6869 7320 6973 206e 6563 6573 7361 7279  his is necessary
-0001f6c0: 2062 6563 6175 7365 2074 6865 2075 7064   because the upd
-0001f6d0: 6174 6564 2073 6176 6564 5f66 6f72 5f62  ated saved_for_b
-0001f6e0: 6163 6b77 6172 6420 6973 0a20 2020 206e  ackward is.    n
-0001f6f0: 6f74 2061 7661 696c 6162 6c65 2077 6865  ot available whe
-0001f700: 6e20 7468 6520 6261 636b 7761 7264 2074  n the backward t
-0001f710: 7261 6365 2069 7320 636f 6e73 7472 7563  race is construc
-0001f720: 7465 642e 0a0a 2020 2020 4172 6773 3a0a  ted...    Args:.
-0001f730: 2020 2020 2020 2020 6261 636b 7761 7264          backward
-0001f740: 5f74 7261 6365 2028 5472 6163 6529 3a20  _trace (Trace): 
-0001f750: 4261 636b 7761 7264 2074 7261 6365 2074  Backward trace t
-0001f760: 6f20 7570 6461 7465 2e0a 2020 2020 2020  o update..      
-0001f770: 2020 7361 7665 645f 666f 725f 6261 636b    saved_for_back
-0001f780: 7761 7264 2028 5365 7175 656e 6365 5b56  ward (Sequence[V
-0001f790: 6172 6961 626c 655d 293a 2053 6176 6564  ariable]): Saved
-0001f7a0: 5f66 6f72 5f62 6163 6b77 6172 6420 746f  _for_backward to
-0001f7b0: 2075 7365 2074 6f0a 2020 2020 2020 2020   use to.        
-0001f7c0: 2020 2020 7570 6461 7465 2074 6865 2062      update the b
-0001f7d0: 6163 6b77 6172 6420 7472 6163 652e 0a20  ackward trace.. 
-0001f7e0: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
-0001f7f0: 756e 7061 636b 696e 675f 666e 2873 6176  unpacking_fn(sav
-0001f800: 6564 5f66 6f72 5f62 6163 6b77 6172 642c  ed_for_backward,
-0001f810: 2063 6f74 616e 6765 6e74 7329 3a0a 2020   cotangents):.  
-0001f820: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
-0001f830: 636f 7461 6e67 656e 7473 203d 2062 6163  cotangents = bac
-0001f840: 6b77 6172 645f 7472 6163 652e 6172 6773  kward_trace.args
-0001f850: 5b31 5d0a 2020 2020 7361 7665 645f 7465  [1].    saved_te
-0001f860: 6e73 6f72 732c 2073 6176 6564 5f6f 7468  nsors, saved_oth
-0001f870: 6572 203d 205f 7370 6c69 745f 7361 7665  er = _split_save
-0001f880: 645f 666f 725f 6261 636b 7761 7264 5f69  d_for_backward_i
-0001f890: 6e74 6f5f 7465 6e73 6f72 735f 616e 645f  nto_tensors_and_
-0001f8a0: 6f74 6865 7228 7361 7665 645f 666f 725f  other(saved_for_
-0001f8b0: 6261 636b 7761 7264 290a 2020 2020 756e  backward).    un
-0001f8c0: 7061 636b 696e 675f 7472 6163 6520 3d20  packing_trace = 
-0001f8d0: 636f 6e73 7472 7563 745f 7472 6163 6528  construct_trace(
-0001f8e0: 7265 6e61 6d65 5f70 726f 7869 6573 3d46  rename_proxies=F
-0001f8f0: 616c 7365 2c20 7573 655f 6463 653d 4661  alse, use_dce=Fa
-0001f900: 6c73 6529 280a 2020 2020 2020 2020 756e  lse)(.        un
-0001f910: 7061 636b 696e 675f 666e 2c20 2873 6176  packing_fn, (sav
-0001f920: 6564 5f74 656e 736f 7273 2c20 7361 7665  ed_tensors, save
-0001f930: 645f 6f74 6865 7229 2c20 636f 7461 6e67  d_other), cotang
-0001f940: 656e 7473 0a20 2020 2029 0a20 2020 2061  ents.    ).    a
-0001f950: 7373 6572 7420 756e 7061 636b 696e 675f  ssert unpacking_
-0001f960: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
-0001f970: 6f6c 735b 2d31 5d2e 7379 6d2e 6964 203d  ols[-1].sym.id =
-0001f980: 3d20 7072 696d 732e 5072 696d 4944 732e  = prims.PrimIDs.
-0001f990: 5245 5455 524e 0a0a 2020 2020 6261 636b  RETURN..    back
-0001f9a0: 7761 7264 5f74 7261 6365 2e61 7267 7320  ward_trace.args 
-0001f9b0: 3d20 756e 7061 636b 696e 675f 7472 6163  = unpacking_trac
-0001f9c0: 652e 6172 6773 0a20 2020 2062 6163 6b77  e.args.    backw
-0001f9d0: 6172 645f 7472 6163 655f 6273 796d 735f  ard_trace_bsyms_
-0001f9e0: 7769 7468 6f75 745f 756e 7061 636b 696e  without_unpackin
-0001f9f0: 6720 3d20 280a 2020 2020 2020 2020 6273  g = (.        bs
-0001fa00: 796d 0a20 2020 2020 2020 2066 6f72 2062  ym.        for b
-0001fa10: 7379 6d20 696e 2062 6163 6b77 6172 645f  sym in backward_
-0001fa20: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
-0001fa30: 6f6c 730a 2020 2020 2020 2020 6966 2062  ols.        if b
-0001fa40: 7379 6d2e 7379 6d2e 6964 0a20 2020 2020  sym.sym.id.     
-0001fa50: 2020 206e 6f74 2069 6e20 280a 2020 2020     not in (.    
-0001fa60: 2020 2020 2020 2020 7072 696d 732e 5072          prims.Pr
-0001fa70: 696d 4944 732e 554e 5041 434b 5f45 4d50  imIDs.UNPACK_EMP
-0001fa80: 5459 5f44 4943 542c 0a20 2020 2020 2020  TY_DICT,.       
-0001fa90: 2020 2020 2070 7269 6d73 2e50 7269 6d49       prims.PrimI
-0001faa0: 4473 2e55 4e50 4143 4b5f 4b45 592c 0a20  Ds.UNPACK_KEY,. 
-0001fab0: 2020 2020 2020 2020 2020 2070 7269 6d73             prims
-0001fac0: 2e50 7269 6d49 4473 2e55 4e50 4143 4b5f  .PrimIDs.UNPACK_
-0001fad0: 5345 5155 454e 4345 2c0a 2020 2020 2020  SEQUENCE,.      
-0001fae0: 2020 2020 2020 7072 696d 732e 5072 696d        prims.Prim
-0001faf0: 4944 732e 554e 5041 434b 5f54 5249 5649  IDs.UNPACK_TRIVI
-0001fb00: 414c 2c0a 2020 2020 2020 2020 290a 2020  AL,.        ).  
-0001fb10: 2020 290a 2020 2020 6261 636b 7761 7264    ).    backward
-0001fb20: 5f74 7261 6365 2e62 6f75 6e64 5f73 796d  _trace.bound_sym
-0001fb30: 626f 6c73 203d 206c 6973 7428 282a 756e  bols = list((*un
-0001fb40: 7061 636b 696e 675f 7472 6163 652e 626f  packing_trace.bo
-0001fb50: 756e 645f 7379 6d62 6f6c 735b 3a2d 315d  und_symbols[:-1]
-0001fb60: 2c20 2a62 6163 6b77 6172 645f 7472 6163  , *backward_trac
-0001fb70: 655f 6273 796d 735f 7769 7468 6f75 745f  e_bsyms_without_
-0001fb80: 756e 7061 636b 696e 6729 290a 0a0a 2320  unpacking))...# 
-0001fb90: 4e4f 5445 3a20 5265 7475 726e 696e 6720  NOTE: Returning 
-0001fba0: 6e61 6d65 6474 7570 6c65 7320 6672 6f6d  namedtuples from
-0001fbb0: 2063 6f6d 7069 6c65 6420 6675 6e63 7469   compiled functi
-0001fbc0: 6f6e 7320 646f 6573 6e27 7420 776f 726b  ons doesn't work
-0001fbd0: 2e20 5365 653a 0a23 2022 416c 6c6f 7720  . See:.# "Allow 
-0001fbe0: 7265 7475 726e 696e 6720 6e61 6d65 6474  returning namedt
-0001fbf0: 7570 6c65 7320 6672 6f6d 2063 6f6d 7069  uples from compi
-0001fc00: 6c65 6420 6675 6e63 7469 6f6e 7322 0a23  led functions".#
-0001fc10: 204e 6f74 6520 5b47 7261 6420 666f 7277   Note [Grad forw
-0001fc20: 6172 6420 6f75 7470 7574 2073 7065 635d  ard output spec]
-0001fc30: 0a23 2049 6620 6974 2064 6964 2077 6f72  .# If it did wor
-0001fc40: 6b20 6974 2077 6f75 6c64 2062 6520 6e69  k it would be ni
-0001fc50: 6365 2074 6f20 7573 6520 7468 6973 206e  ce to use this n
-0001fc60: 616d 6564 7475 706c 650a 2320 696e 7374  amedtuple.# inst
-0001fc70: 6561 6420 6f66 2074 6865 2070 6c61 696e  ead of the plain
-0001fc80: 2074 7570 6c65 206f 7220 6469 6374 2074   tuple or dict t
-0001fc90: 6861 7420 7765 2772 6520 7573 696e 6720  hat we're using 
-0001fca0: 6e6f 772e 0a54 6f72 6368 4175 746f 6772  now..TorchAutogr
-0001fcb0: 6164 466f 7277 6172 6444 6174 6120 3d20  adForwardData = 
-0001fcc0: 6e61 6d65 6474 7570 6c65 280a 2020 2020  namedtuple(.    
-0001fcd0: 2254 6f72 6368 4175 746f 6772 6164 466f  "TorchAutogradFo
-0001fce0: 7277 6172 6444 6174 6122 2c0a 2020 2020  rwardData",.    
-0001fcf0: 5b22 6f75 7470 7574 222c 2022 666c 6174  ["output", "flat
-0001fd00: 5f61 7267 7322 2c20 2266 6c61 745f 6f75  _args", "flat_ou
-0001fd10: 7470 7574 225d 2c0a 290a 0a0a 6465 6620  tput"],.)...def 
-0001fd20: 666f 7277 6172 645f 616e 645f 6261 636b  forward_and_back
-0001fd30: 7761 7264 5f66 726f 6d5f 7472 6163 6528  ward_from_trace(
-0001fd40: 7472 6163 653a 2054 7261 6365 2c20 746f  trace: Trace, to
-0001fd50: 7263 685f 6175 746f 6772 6164 3d46 616c  rch_autograd=Fal
-0001fd60: 7365 2920 2d3e 2046 6f72 7761 7264 4261  se) -> ForwardBa
-0001fd70: 636b 7761 7264 5472 6163 6573 3a0a 2020  ckwardTraces:.  
-0001fd80: 2020 2222 2247 656e 6572 6174 6573 2074    """Generates t
-0001fd90: 6865 2066 6f72 7761 7264 2061 6e64 2062  he forward and b
-0001fda0: 6163 6b77 6172 6420 7061 7373 6573 2066  ackward passes f
-0001fdb0: 726f 6d20 6120 7472 6163 652e 0a0a 2020  rom a trace...  
-0001fdc0: 2020 5468 6973 2069 7320 6120 636f 6e76    This is a conv
-0001fdd0: 656e 6965 6e63 6520 6675 6e63 7469 6f6e  enience function
-0001fde0: 2074 6861 7420 636f 6d62 696e 6573 2074   that combines t
-0001fdf0: 6865 2066 756e 6374 696f 6e61 6c69 7479  he functionality
-0001fe00: 206f 660a 2020 2020 6061 7567 6d65 6e74   of.    `augment
-0001fe10: 6564 5f66 6f72 7761 7264 5f70 6173 7360  ed_forward_pass`
-0001fe20: 2061 6e64 2060 6261 636b 7761 7264 5f70   and `backward_p
-0001fe30: 6173 7360 2e20 5468 6520 6d61 696e 2064  ass`. The main d
-0001fe40: 6966 6665 7265 6e63 6520 6973 2074 6861  ifference is tha
-0001fe50: 740a 2020 2020 7468 6973 2066 756e 6374  t.    this funct
-0001fe60: 696f 6e20 646f 6573 206e 6f74 2072 6571  ion does not req
-0001fe70: 7569 7265 2074 6865 2075 7365 7220 746f  uire the user to
-0001fe80: 2070 726f 7669 6465 206e 6577 2069 6e70   provide new inp
-0001fe90: 7574 7320 666f 7220 7468 650a 2020 2020  uts for the.    
-0001fea0: 7472 6163 6520 6576 616c 7561 7469 6f6e  trace evaluation
-0001feb0: 2e20 496e 7374 6561 6420 6974 2075 7365  . Instead it use
-0001fec0: 7320 7468 6520 696e 7075 7473 2074 6861  s the inputs tha
-0001fed0: 7420 7765 7265 2075 7365 6420 746f 2063  t were used to c
-0001fee0: 6f6e 7374 7275 6374 0a20 2020 2074 6865  onstruct.    the
-0001fef0: 2074 7261 6365 2e0a 0a20 2020 2041 7267   trace...    Arg
-0001ff00: 733a 0a20 2020 2020 2020 2074 7261 6365  s:.        trace
-0001ff10: 2028 5472 6163 6529 3a20 5472 6163 6520   (Trace): Trace 
-0001ff20: 746f 2067 656e 6572 6174 6520 7468 6520  to generate the 
-0001ff30: 666f 7277 6172 6420 616e 6420 6261 636b  forward and back
-0001ff40: 7761 7264 2070 6173 7365 7320 6672 6f6d  ward passes from
-0001ff50: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-0001ff60: 2020 2020 2020 2020 466f 7277 6172 6442          ForwardB
-0001ff70: 6163 6b77 6172 6454 7261 6365 733a 2041  ackwardTraces: A
-0001ff80: 206e 616d 6564 2074 7570 6c65 2063 6f6e   named tuple con
-0001ff90: 7461 696e 696e 6720 7468 6520 666f 7277  taining the forw
-0001ffa0: 6172 6420 616e 6420 6261 636b 7761 7264  ard and backward
-0001ffb0: 0a20 2020 2020 2020 2020 2020 2074 7261  .            tra
-0001ffc0: 6365 732e 0a0a 2020 2020 4578 616d 706c  ces...    Exampl
-0001ffd0: 653a 0a20 2020 2020 2020 203e 3e3e 2069  e:.        >>> i
-0001ffe0: 6d70 6f72 7420 746f 7263 680a 2020 2020  mport torch.    
-0001fff0: 2020 2020 3e3e 3e20 6672 6f6d 2074 6875      >>> from thu
-00020000: 6e64 6572 2069 6d70 6f72 7420 636f 6d70  nder import comp
-00020010: 696c 652c 206c 6173 745f 7472 6163 6573  ile, last_traces
-00020020: 0a20 2020 2020 2020 203e 3e3e 2066 726f  .        >>> fro
-00020030: 6d20 7468 756e 6465 722e 636f 7265 2e74  m thunder.core.t
-00020040: 7261 6e73 666f 726d 7320 696d 706f 7274  ransforms import
-00020050: 2066 6f72 7761 7264 5f61 6e64 5f62 6163   forward_and_bac
-00020060: 6b77 6172 645f 6672 6f6d 5f74 7261 6365  kward_from_trace
-00020070: 0a20 2020 2020 2020 203e 3e3e 2064 6566  .        >>> def
-00020080: 2066 2878 293a 0a20 2020 2020 2020 202e   f(x):.        .
-00020090: 2e2e 2020 2020 2072 6574 7572 6e20 746f  ..     return to
-000200a0: 7263 682e 7369 6e28 7829 0a20 2020 2020  rch.sin(x).     
-000200b0: 2020 203e 3e3e 2078 203d 2074 6f72 6368     >>> x = torch
-000200c0: 2e74 656e 736f 7228 332e 3029 0a20 2020  .tensor(3.0).   
-000200d0: 2020 2020 203e 3e3e 2063 6620 3d20 636f       >>> cf = co
-000200e0: 6d70 696c 6528 6629 0a20 2020 2020 2020  mpile(f).       
-000200f0: 203e 3e3e 206f 7574 203d 2063 6628 7829   >>> out = cf(x)
-00020100: 0a20 2020 2020 2020 203e 3e3e 2074 7261  .        >>> tra
-00020110: 6365 203d 206c 6173 745f 7472 6163 6573  ce = last_traces
-00020120: 2863 6629 5b30 5d0a 2020 2020 2020 2020  (cf)[0].        
-00020130: 3e3e 3e20 666f 7277 6172 645f 616e 645f  >>> forward_and_
-00020140: 6261 636b 7761 7264 5f66 726f 6d5f 7472  backward_from_tr
-00020150: 6163 6528 7472 6163 6529 0a20 2020 2020  ace(trace).     
-00020160: 2020 202e 2e2e 2046 6f72 7761 7264 4261     ... ForwardBa
-00020170: 636b 7761 7264 5472 6163 6573 280a 2020  ckwardTraces(.  
-00020180: 2020 2020 2020 2e2e 2e20 666f 7277 6172        ... forwar
-00020190: 645f 7472 6163 653d 2320 696d 706f 7274  d_trace=# import
-000201a0: 2074 6875 6e64 6572 2061 7320 7468 756e   thunder as thun
-000201b0: 6465 720a 2020 2020 2020 2020 2e2e 2e20  der.        ... 
-000201c0: 2320 696d 706f 7274 2074 6875 6e64 6572  # import thunder
-000201d0: 2e63 6f72 652e 7072 696d 7320 6173 2070  .core.prims as p
-000201e0: 7269 6d73 0a20 2020 2020 2020 202e 2e2e  rims.        ...
-000201f0: 2069 6d70 6f72 7420 746f 7263 680a 2020   import torch.  
-00020200: 2020 2020 2020 2e2e 2e0a 2020 2020 2020        ....      
-00020210: 2020 2e2e 2e20 4074 6f72 6368 2e6e 6f5f    ... @torch.no_
-00020220: 6772 6164 2829 0a20 2020 2020 2020 202e  grad().        .
-00020230: 2e2e 2064 6566 2061 7567 6d65 6e74 6564  .. def augmented
-00020240: 5f66 6f72 7761 7264 5f66 6e28 2a61 7267  _forward_fn(*arg
-00020250: 7329 3a0a 2020 2020 2020 2020 2e2e 2e20  s):.        ... 
-00020260: 2020 2320 6172 6773 3a20 2243 6f6c 6c65    # args: "Colle
-00020270: 6374 696f 6e22 203d 2020 2874 302c 2920  ction" =  (t0,) 
-00020280: 2028 7472 6976 6961 6c20 756e 7061 636b   (trivial unpack
-00020290: 290a 2020 2020 2020 2020 2e2e 2e20 2020  ).        ...   
-000202a0: 7430 2c20 5c0a 2020 2020 2020 2020 2e2e  t0, \.        ..
-000202b0: 2e20 2020 3d20 6172 6773 0a20 2020 2020  .   = args.     
-000202c0: 2020 202e 2e2e 2020 2074 3120 3d20 7072     ...   t1 = pr
-000202d0: 696d 732e 7369 6e28 7430 2920 2023 2074  ims.sin(t0)  # t
-000202e0: 313a 2022 6370 7520 6633 325b 5d22 0a20  1: "cpu f32[]". 
-000202f0: 2020 2020 2020 202e 2e2e 2020 2072 6574         ...   ret
-00020300: 7572 6e20 7431 2c20 2874 302c 292c 0a20  urn t1, (t0,),. 
-00020310: 2020 2020 2020 202e 2e2e 2062 6163 6b77         ... backw
-00020320: 6172 645f 7472 6163 653d 2320 696d 706f  ard_trace=# impo
-00020330: 7274 2074 6875 6e64 6572 2061 7320 7468  rt thunder as th
-00020340: 756e 6465 720a 2020 2020 2020 2020 2e2e  under.        ..
-00020350: 2e20 2320 696d 706f 7274 2074 6875 6e64  . # import thund
-00020360: 6572 2e63 6f72 652e 7072 696d 7320 6173  er.core.prims as
-00020370: 2070 7269 6d73 0a20 2020 2020 2020 202e   prims.        .
-00020380: 2e2e 2069 6d70 6f72 7420 746f 7263 680a  .. import torch.
-00020390: 2020 2020 2020 2020 2e2e 2e0a 2020 2020          ....    
-000203a0: 2020 2020 2e2e 2e20 4074 6f72 6368 2e6e      ... @torch.n
-000203b0: 6f5f 6772 6164 2829 0a20 2020 2020 2020  o_grad().       
-000203c0: 202e 2e2e 2064 6566 2062 6163 6b77 6172   ... def backwar
-000203d0: 645f 666e 2873 6176 6564 5f66 6f72 5f62  d_fn(saved_for_b
-000203e0: 6163 6b77 6172 642c 2063 6f74 616e 6765  ackward, cotange
-000203f0: 6e74 7329 3a0a 2020 2020 2020 2020 2e2e  nts):.        ..
-00020400: 2e20 2020 2320 7361 7665 645f 666f 725f  .   # saved_for_
-00020410: 6261 636b 7761 7264 3a20 2243 6f6c 6c65  backward: "Colle
-00020420: 6374 696f 6e22 203d 2020 2874 302c 2920  ction" =  (t0,) 
-00020430: 2028 7472 6976 6961 6c20 756e 7061 636b   (trivial unpack
-00020440: 290a 2020 2020 2020 2020 2e2e 2e20 2020  ).        ...   
-00020450: 2320 636f 7461 6e67 656e 7473 3a20 2263  # cotangents: "c
-00020460: 7075 2066 3332 5b5d 2220 3d20 2063 6f74  pu f32[]" =  cot
-00020470: 616e 6765 6e74 7320 2028 7472 6976 6961  angents  (trivia
-00020480: 6c20 756e 7061 636b 290a 2020 2020 2020  l unpack).      
-00020490: 2020 2e2e 2e20 2020 7430 2c20 5c0a 2020    ...   t0, \.  
-000204a0: 2020 2020 2020 2e2e 2e20 2020 3d20 7361        ...   = sa
-000204b0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-000204c0: 0a20 2020 2020 2020 202e 2e2e 2020 2074  .        ...   t
-000204d0: 3120 3d20 7072 696d 732e 636f 7328 7430  1 = prims.cos(t0
-000204e0: 2920 2023 2074 313a 2022 6370 7520 6633  )  # t1: "cpu f3
-000204f0: 325b 5d22 0a20 2020 2020 2020 202e 2e2e  2[]".        ...
-00020500: 2020 2074 3220 3d20 7072 696d 732e 6d75     t2 = prims.mu
-00020510: 6c28 636f 7461 6e67 656e 7473 2c20 7431  l(cotangents, t1
-00020520: 2920 2023 2074 323a 2022 6370 7520 6633  )  # t2: "cpu f3
-00020530: 325b 5d22 0a20 2020 2020 2020 202e 2e2e  2[]".        ...
-00020540: 2020 2072 6574 7572 6e20 2874 322c 2929     return (t2,))
-00020550: 0a20 2020 2022 2222 0a0a 2020 2020 6f75  .    """..    ou
-00020560: 7470 7574 5f73 7065 6320 3d20 4e6f 6e65  tput_spec = None
-00020570: 0a0a 2020 2020 6465 6620 6175 676d 656e  ..    def augmen
-00020580: 7465 645f 666f 7277 6172 645f 666e 282a  ted_forward_fn(*
-00020590: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
-000205a0: 0a20 2020 2020 2020 2072 6573 756c 742c  .        result,
-000205b0: 2065 6e76 203d 2061 7567 6d65 6e74 6564   env = augmented
-000205c0: 5f66 6f72 7761 7264 5f70 6173 7328 2a61  _forward_pass(*a
-000205d0: 7267 732c 2074 7261 6365 3d74 7261 6365  rgs, trace=trace
-000205e0: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
-000205f0: 2020 2020 7361 7665 645f 666f 725f 6261      saved_for_ba
-00020600: 636b 7761 7264 203d 2064 6563 6f6e 7374  ckward = deconst
-00020610: 7275 6374 5f66 6f72 7761 7264 5f65 6e76  ruct_forward_env
-00020620: 5f66 6f72 5f62 6163 6b77 6172 6428 7472  _for_backward(tr
-00020630: 6163 652c 2065 6e76 290a 2020 2020 2020  ace, env).      
-00020640: 2020 6966 2074 6f72 6368 5f61 7574 6f67    if torch_autog
-00020650: 7261 643a 0a20 2020 2020 2020 2020 2020  rad:.           
-00020660: 206e 6f6e 6c6f 6361 6c20 6f75 7470 7574   nonlocal output
-00020670: 5f73 7065 630a 2020 2020 2020 2020 2020  _spec.          
-00020680: 2020 666c 6174 5f61 7267 732c 205f 203d    flat_args, _ =
-00020690: 2074 7265 655f 666c 6174 7465 6e28 2861   tree_flatten((a
-000206a0: 7267 732c 206b 7761 7267 7329 290a 2020  rgs, kwargs)).  
-000206b0: 2020 2020 2020 2020 2020 666c 6174 5f6f            flat_o
-000206c0: 7574 7075 742c 206f 7574 7075 745f 7370  utput, output_sp
-000206d0: 6563 203d 2074 7265 655f 666c 6174 7465  ec = tree_flatte
-000206e0: 6e28 7265 7375 6c74 290a 2020 2020 2020  n(result).      
-000206f0: 2020 2020 2020 666c 6174 5f6f 7574 7075        flat_outpu
-00020700: 7420 3d20 7475 706c 6528 666c 6174 5f6f  t = tuple(flat_o
-00020710: 7574 7075 7429 0a20 2020 2020 2020 2020  utput).         
-00020720: 2020 2023 2053 6565 204e 6f74 6520 5b47     # See Note [G
-00020730: 7261 6420 666f 7277 6172 6420 6f75 7470  rad forward outp
-00020740: 7574 2073 7065 635d 0a20 2020 2020 2020  ut spec].       
-00020750: 2020 2020 2066 6f72 5f61 7574 6f67 7261       for_autogra
-00020760: 6420 3d20 546f 7263 6841 7574 6f67 7261  d = TorchAutogra
-00020770: 6446 6f72 7761 7264 4461 7461 280a 2020  dForwardData(.  
-00020780: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00020790: 7375 6c74 2c0a 2020 2020 2020 2020 2020  sult,.          
-000207a0: 2020 2020 2020 666c 6174 5f61 7267 732c        flat_args,
-000207b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000207c0: 2066 6c61 745f 6f75 7470 7574 2c0a 2020   flat_output,.  
-000207d0: 2020 2020 2020 2020 2020 292e 5f61 7364            )._asd
-000207e0: 6963 7428 290a 2020 2020 2020 2020 2020  ict().          
-000207f0: 2020 7265 7475 726e 2028 666f 725f 6175    return (for_au
-00020800: 746f 6772 6164 2c20 7361 7665 645f 666f  tograd, saved_fo
-00020810: 725f 6261 636b 7761 7264 290a 2020 2020  r_backward).    
-00020820: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-00020830: 742c 2073 6176 6564 5f66 6f72 5f62 6163  t, saved_for_bac
-00020840: 6b77 6172 640a 0a20 2020 2023 2043 6f70  kward..    # Cop
-00020850: 7920 7468 6520 7369 676e 6174 7572 6520  y the signature 
-00020860: 6f66 2074 6865 206f 7269 6769 6e61 6c20  of the original 
-00020870: 6675 6e63 7469 6f6e 2073 6f20 7468 6174  function so that
-00020880: 2074 6865 2061 7267 756d 656e 7473 2061   the arguments a
-00020890: 7265 0a20 2020 2023 206e 616d 6564 2063  re.    # named c
-000208a0: 6f72 7265 6374 6c79 2069 6e20 7468 6520  orrectly in the 
-000208b0: 6175 676d 656e 7465 6420 666f 7277 6172  augmented forwar
-000208c0: 6420 7061 7373 2069 6e73 7465 6164 206f  d pass instead o
-000208d0: 6620 6265 696e 6720 6e61 6d65 640a 2020  f being named.  
-000208e0: 2020 2320 2261 7267 7322 2061 6e64 2022    # "args" and "
-000208f0: 6b77 6172 6773 222e 0a20 2020 2061 7567  kwargs"..    aug
-00020900: 6d65 6e74 6564 5f66 6f72 7761 7264 5f66  mented_forward_f
-00020910: 6e2e 5f5f 7369 676e 6174 7572 655f 5f20  n.__signature__ 
-00020920: 3d20 696e 7370 6563 742e 7369 676e 6174  = inspect.signat
-00020930: 7572 6528 7472 6163 652e 666e 206f 7220  ure(trace.fn or 
-00020940: 7472 6163 652e 7079 7468 6f6e 5f63 616c  trace.python_cal
-00020950: 6c61 626c 6528 2929 0a0a 2020 2020 6465  lable())..    de
-00020960: 6620 6f6e 6573 5f6c 696b 6528 7829 3a0a  f ones_like(x):.
-00020970: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00020980: 7461 6e63 6528 782c 2054 656e 736f 7250  tance(x, TensorP
-00020990: 726f 7879 293a 0a20 2020 2020 2020 2020  roxy):.         
-000209a0: 2020 2072 6574 7572 6e20 6675 6c6c 5f6c     return full_l
-000209b0: 696b 6528 782c 2066 696c 6c5f 7661 6c75  ike(x, fill_valu
-000209c0: 653d 3129 0a20 2020 2020 2020 2065 6c69  e=1).        eli
-000209d0: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
-000209e0: 4e75 6d62 6572 5072 6f78 7929 3a0a 2020  NumberProxy):.  
-000209f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00020a00: 2074 7970 6528 782e 7661 6c75 6529 2831   type(x.value)(1
-00020a10: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00020a20: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00020a30: 726e 204e 6f6e 650a 0a20 2020 2066 6f72  rn None..    for
-00020a40: 7761 7264 5f74 7261 6365 203d 2063 6f6e  ward_trace = con
-00020a50: 7374 7275 6374 5f74 7261 6365 2829 2861  struct_trace()(a
-00020a60: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
-00020a70: 5f66 6e2c 202a 7472 6163 652e 6172 6773  _fn, *trace.args
-00020a80: 2c20 2a2a 7472 6163 652e 6b77 6172 6773  , **trace.kwargs
-00020a90: 290a 2020 2020 2320 5765 2073 6574 2066  ).    # We set f
-00020aa0: 6f72 7761 7264 2074 7261 6365 2074 6f20  orward trace to 
-00020ab0: 636f 6e73 7472 7563 7420 7072 6f78 6965  construct proxie
-00020ac0: 7320 6265 6361 7573 6520 7765 206e 6565  s because we nee
-00020ad0: 6420 7468 6573 6520 7072 6f78 6965 7320  d these proxies 
-00020ae0: 746f 0a20 2020 2023 2068 6176 6520 6469  to.    # have di
-00020af0: 6666 6572 656e 7420 6e61 6d65 7320 7468  fferent names th
-00020b00: 616e 2074 6865 206f 6e65 7320 696e 2074  an the ones in t
-00020b10: 6865 2066 6f72 7761 7264 2074 7261 6365  he forward trace
-00020b20: 2e0a 2020 2020 7472 793a 0a20 2020 2020  ..    try:.     
-00020b30: 2020 2074 7261 6365 6374 785f 746f 6b65     tracectx_toke
-00020b40: 6e20 3d20 7365 745f 7472 6163 6563 7478  n = set_tracectx
-00020b50: 2866 6f72 7761 7264 5f74 7261 6365 290a  (forward_trace).
-00020b60: 2020 2020 2020 2020 2320 5765 2064 6f6e          # We don
-00020b70: 2774 2077 616e 7420 746f 2072 6563 6f72  't want to recor
-00020b80: 6420 7468 6f73 6520 6f6e 6573 5f6c 696b  d those ones_lik
-00020b90: 6520 6361 6c6c 7320 696e 2074 6865 2066  e calls in the f
-00020ba0: 6f72 7761 7264 2074 7261 6365 2e0a 2020  orward trace..  
-00020bb0: 2020 2020 2020 7769 7468 2064 6574 6163        with detac
-00020bc0: 6865 645f 7472 6163 6528 293a 0a20 2020  hed_trace():.   
-00020bd0: 2020 2020 2020 2020 2069 6620 746f 7263           if torc
-00020be0: 685f 6175 746f 6772 6164 3a0a 2020 2020  h_autograd:.    
-00020bf0: 2020 2020 2020 2020 2020 2020 2320 4974              # It
-00020c00: 2773 2061 7373 756d 6564 2074 6861 7420  's assumed that 
-00020c10: 666f 7277 6172 645f 7472 6163 652e 6f75  forward_trace.ou
-00020c20: 7470 7574 5b30 5d20 6973 2061 2064 6963  tput[0] is a dic
-00020c30: 7420 6672 6f6d 2054 6f72 6368 4175 746f  t from TorchAuto
-00020c40: 6772 6164 466f 7277 6172 6444 6174 610a  gradForwardData.
-00020c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020c60: 666c 6174 5f6f 7574 7075 7420 3d20 666f  flat_output = fo
-00020c70: 7277 6172 645f 7472 6163 652e 6f75 7470  rward_trace.outp
-00020c80: 7574 5b30 5d5b 2266 6c61 745f 6f75 7470  ut[0]["flat_outp
-00020c90: 7574 225d 0a20 2020 2020 2020 2020 2020  ut"].           
-00020ca0: 2020 2020 2063 6f74 616e 6765 6e74 7320       cotangents 
-00020cb0: 3d20 7574 696c 732e 7365 7175 656e 6369  = utils.sequenci
-00020cc0: 6679 2874 7265 655f 6d61 7028 6c61 6d62  fy(tree_map(lamb
-00020cd0: 6461 2076 3a20 6f6e 6573 5f6c 696b 6528  da v: ones_like(
-00020ce0: 7629 2c20 666c 6174 5f6f 7574 7075 7429  v), flat_output)
-00020cf0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00020d00: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00020d10: 2020 2020 636f 7461 6e67 656e 7473 203d      cotangents =
-00020d20: 2075 7469 6c73 2e73 6571 7565 6e63 6966   utils.sequencif
-00020d30: 7928 7472 6565 5f6d 6170 286c 616d 6264  y(tree_map(lambd
-00020d40: 6120 763a 206f 6e65 735f 6c69 6b65 2876  a v: ones_like(v
-00020d50: 292c 2074 7261 6365 2e6f 7574 7075 7429  ), trace.output)
-00020d60: 290a 2020 2020 6669 6e61 6c6c 793a 0a20  ).    finally:. 
-00020d70: 2020 2020 2020 2072 6573 6574 5f74 7261         reset_tra
-00020d80: 6365 6374 7828 7472 6163 6563 7478 5f74  cectx(tracectx_t
-00020d90: 6f6b 656e 290a 0a20 2020 2064 6566 2062  oken)..    def b
-00020da0: 6163 6b77 6172 645f 666e 2873 6176 6564  ackward_fn(saved
-00020db0: 5f66 6f72 5f62 6163 6b77 6172 642c 2063  _for_backward, c
-00020dc0: 6f74 616e 6765 6e74 7329 3a0a 2020 2020  otangents):.    
-00020dd0: 2020 2020 656e 7620 3d20 7265 636f 6e73      env = recons
-00020de0: 7472 7563 745f 666f 7277 6172 645f 656e  truct_forward_en
-00020df0: 765f 666f 725f 6261 636b 7761 7264 2874  v_for_backward(t
-00020e00: 7261 6365 2c20 7361 7665 645f 666f 725f  race, saved_for_
-00020e10: 6261 636b 7761 7264 290a 2020 2020 2020  backward).      
-00020e20: 2020 6966 2074 6f72 6368 5f61 7574 6f67    if torch_autog
-00020e30: 7261 643a 0a20 2020 2020 2020 2020 2020  rad:.           
-00020e40: 2063 6f74 616e 6765 6e74 7320 3d20 7472   cotangents = tr
-00020e50: 6565 5f75 6e66 6c61 7474 656e 2863 6f74  ee_unflatten(cot
-00020e60: 616e 6765 6e74 732c 206f 7574 7075 745f  angents, output_
-00020e70: 7370 6563 290a 2020 2020 2020 2020 6f75  spec).        ou
-00020e80: 7420 3d20 6261 636b 7761 7264 5f70 6173  t = backward_pas
-00020e90: 7328 656e 762c 2074 7261 6365 2c20 636f  s(env, trace, co
-00020ea0: 7461 6e67 656e 7473 290a 2020 2020 2020  tangents).      
-00020eb0: 2020 6966 2074 6f72 6368 5f61 7574 6f67    if torch_autog
-00020ec0: 7261 643a 0a20 2020 2020 2020 2020 2020  rad:.           
-00020ed0: 2067 6b77 6172 6773 203d 206f 7574 5b2d   gkwargs = out[-
-00020ee0: 315d 2069 6620 6973 696e 7374 616e 6365  1] if isinstance
-00020ef0: 286f 7574 5b2d 315d 2c20 6469 6374 2920  (out[-1], dict) 
-00020f00: 656c 7365 207b 7d0a 2020 2020 2020 2020  else {}.        
-00020f10: 2020 2020 6761 7267 7320 3d20 6f75 745b      gargs = out[
-00020f20: 3a2d 315d 2069 6620 6973 696e 7374 616e  :-1] if isinstan
-00020f30: 6365 286f 7574 5b2d 315d 2c20 6469 6374  ce(out[-1], dict
-00020f40: 2920 656c 7365 206f 7574 0a20 2020 2020  ) else out.     
-00020f50: 2020 2020 2020 2067 6b77 6172 6773 203d         gkwargs =
-00020f60: 207b 6b3a 2067 6b77 6172 6773 2e67 6574   {k: gkwargs.get
-00020f70: 286b 2c20 4e6f 6e65 2920 666f 7220 6b20  (k, None) for k 
-00020f80: 696e 2074 7261 6365 2e6b 7761 7267 737d  in trace.kwargs}
-00020f90: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-00020fa0: 203d 2028 2a67 6172 6773 2c20 676b 7761   = (*gargs, gkwa
-00020fb0: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
-00020fc0: 206f 7574 203d 2074 7265 655f 666c 6174   out = tree_flat
-00020fd0: 7465 6e28 6f75 7429 5b30 5d0a 2020 2020  ten(out)[0].    
-00020fe0: 2020 2020 7265 7475 726e 206f 7574 0a0a      return out..
-00020ff0: 2020 2020 7361 7665 645f 666f 725f 6261      saved_for_ba
-00021000: 636b 7761 7264 203d 2066 6f72 7761 7264  ckward = forward
-00021010: 5f74 7261 6365 2e6f 7574 7075 745b 315d  _trace.output[1]
-00021020: 0a20 2020 2062 6163 6b77 6172 645f 7472  .    backward_tr
-00021030: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
-00021040: 7472 6163 6528 7265 6e61 6d65 5f70 726f  trace(rename_pro
-00021050: 7869 6573 3d46 616c 7365 2928 6261 636b  xies=False)(back
-00021060: 7761 7264 5f66 6e2c 2073 6176 6564 5f66  ward_fn, saved_f
-00021070: 6f72 5f62 6163 6b77 6172 642c 2063 6f74  or_backward, cot
-00021080: 616e 6765 6e74 7329 0a0a 2020 2020 2320  angents)..    # 
-00021090: 5765 2061 7265 2064 6f6e 6520 7769 7468  We are done with
-000210a0: 2063 6f6e 7374 7275 6374 696e 6720 7468   constructing th
-000210b0: 6520 666f 7277 6172 6420 616e 6420 6261  e forward and ba
-000210c0: 636b 7761 7264 2070 6173 7365 7320 6174  ckward passes at
-000210d0: 2074 6869 730a 2020 2020 2320 7374 6167   this.    # stag
-000210e0: 652e 2054 6865 2066 6f6c 6c6f 7769 6e67  e. The following
-000210f0: 2069 7320 6e6f 7420 7374 7269 6374 6c79   is not strictly
-00021100: 206e 6563 6573 7361 7279 2c20 6275 7420   necessary, but 
-00021110: 6974 2773 2067 6f6f 6420 746f 2066 696c  it's good to fil
-00021120: 7465 720a 2020 2020 2320 6f75 7420 7468  ter.    # out th
-00021130: 6520 756e 7573 6564 2065 6c65 6d65 6e74  e unused element
-00021140: 7320 6f66 2074 6865 2073 6176 6564 5f66  s of the saved_f
-00021150: 6f72 5f62 6163 6b77 6172 6420 616e 6420  or_backward and 
-00021160: 666c 6174 7465 6e20 6974 2066 6f72 206d  flatten it for m
-00021170: 6f72 650a 2020 2020 2320 636f 6d70 6163  ore.    # compac
-00021180: 7420 6261 636b 7761 7264 2074 7261 6365  t backward trace
-00021190: 2e0a 0a20 2020 2023 204e 6f77 2077 6520  ...    # Now we 
-000211a0: 6361 6e20 6465 7465 726d 696e 6520 6578  can determine ex
-000211b0: 6163 746c 7920 7768 6174 2773 2075 7365  actly what's use
-000211c0: 6420 696e 2074 6865 2062 6163 6b77 6172  d in the backwar
-000211d0: 6420 7061 7373 2066 726f 6d20 7468 650a  d pass from the.
-000211e0: 2020 2020 2320 7361 7665 645f 666f 725f      # saved_for_
-000211f0: 6261 636b 7761 7264 2e20 5765 2063 616e  backward. We can
-00021200: 2066 6c61 7474 656e 2061 6e64 2066 696c   flatten and fil
-00021210: 7465 7220 7468 6520 7361 7665 645f 666f  ter the saved_fo
-00021220: 725f 6261 636b 7761 7264 0a20 2020 2063  r_backward.    c
-00021230: 6f6e 7375 6d65 7273 203d 2075 7469 6c73  onsumers = utils
-00021240: 2e63 6f6e 7375 6d65 7273 2862 6163 6b77  .consumers(backw
-00021250: 6172 645f 7472 6163 6529 0a0a 2020 2020  ard_trace)..    
-00021260: 2320 466f 7277 6172 6427 7320 616e 6420  # Forward's and 
-00021270: 6261 636b 7761 7264 2773 2022 7361 7665  backward's "save
-00021280: 645f 666f 725f 6261 636b 7761 7264 2220  d_for_backward" 
-00021290: 6172 6520 6e6f 7420 6e65 6365 7373 6172  are not necessar
-000212a0: 696c 7920 7468 6520 7361 6d65 0a20 2020  ily the same.   
-000212b0: 2023 2061 7320 7468 6520 7361 7665 645f   # as the saved_
-000212c0: 666f 725f 6261 636b 7761 7264 2c20 6265  for_backward, be
-000212d0: 6361 7573 6520 736f 6d65 206f 7220 616c  cause some or al
-000212e0: 6c20 656c 656d 656e 7473 206f 6620 7468  l elements of th
-000212f0: 650a 2020 2020 2320 7361 7665 645f 666f  e.    # saved_fo
-00021300: 725f 6261 636b 7761 7264 2072 6573 756c  r_backward resul
-00021310: 7473 206d 6967 6874 2062 6520 7265 2d70  ts might be re-p
-00021320: 726f 7869 6669 6564 2e0a 2020 2020 6277  roxified..    bw
-00021330: 5f66 6c61 745f 7361 7665 645f 666f 725f  _flat_saved_for_
-00021340: 6261 636b 7761 7264 2c20 7370 6563 203d  backward, spec =
-00021350: 2074 7265 655f 666c 6174 7465 6e28 6261   tree_flatten(ba
-00021360: 636b 7761 7264 5f74 7261 6365 2e61 7267  ckward_trace.arg
-00021370: 735b 305d 290a 2020 2020 6677 5f66 6c61  s[0]).    fw_fla
-00021380: 745f 7361 7665 645f 666f 725f 6261 636b  t_saved_for_back
-00021390: 7761 7264 2c20 5f20 3d20 7472 6565 5f66  ward, _ = tree_f
-000213a0: 6c61 7474 656e 2866 6f72 7761 7264 5f74  latten(forward_t
-000213b0: 7261 6365 2e6f 7574 7075 745b 315d 290a  race.output[1]).
-000213c0: 2020 2020 7573 6564 5f6d 6173 6b20 3d20      used_mask = 
-000213d0: 6c69 7374 286c 656e 2863 6f6e 7375 6d65  list(len(consume
-000213e0: 7273 2e67 6574 2878 2c20 2829 2929 203e  rs.get(x, ())) >
-000213f0: 2030 2066 6f72 2078 2069 6e20 6277 5f66   0 for x in bw_f
-00021400: 6c61 745f 7361 7665 645f 666f 725f 6261  lat_saved_for_ba
-00021410: 636b 7761 7264 290a 0a20 2020 2023 2044  ckward)..    # D
-00021420: 6f6e 2774 2075 7365 2074 6865 2073 616d  on't use the sam
-00021430: 6520 7661 7269 6162 6c65 2074 7769 6365  e variable twice
-00021440: 2069 6e20 7468 6520 6261 636b 7761 7264   in the backward
-00021450: 2070 6173 730a 2020 2020 7365 656e 203d   pass.    seen =
-00021460: 2073 6574 2829 0a20 2020 2066 726f 6d20   set().    from 
-00021470: 7468 756e 6465 722e 636f 7265 2e70 726f  thunder.core.pro
-00021480: 7869 6573 2069 6d70 6f72 7420 5661 7269  xies import Vari
-00021490: 6162 6c65 0a0a 2020 2020 666f 7220 692c  able..    for i,
-000214a0: 2078 2069 6e20 656e 756d 6572 6174 6528   x in enumerate(
-000214b0: 6677 5f66 6c61 745f 7361 7665 645f 666f  fw_flat_saved_fo
-000214c0: 725f 6261 636b 7761 7264 293a 0a20 2020  r_backward):.   
-000214d0: 2020 2020 2078 203d 2076 6172 6961 626c       x = variabl
-000214e0: 6569 6679 2878 290a 2020 2020 2020 2020  eify(x).        
-000214f0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-00021500: 6528 782c 2056 6172 6961 626c 6529 3a0a  e(x, Variable):.
-00021510: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00021520: 696e 7565 0a20 2020 2020 2020 2069 6620  inue.        if 
-00021530: 7820 696e 2073 6565 6e3a 0a20 2020 2020  x in seen:.     
-00021540: 2020 2020 2020 2075 7365 645f 6d61 736b         used_mask
-00021550: 5b69 5d20 3d20 4661 6c73 650a 2020 2020  [i] = False.    
-00021560: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00021570: 2020 2020 2020 7365 656e 2e61 6464 2878        seen.add(x
-00021580: 290a 0a20 2020 206f 6e6c 795f 7573 6564  )..    only_used
-00021590: 5f66 775f 7361 7665 645f 666f 725f 6261  _fw_saved_for_ba
-000215a0: 636b 7761 7264 203d 2074 7570 6c65 2863  ckward = tuple(c
-000215b0: 6f6d 7072 6573 7328 6677 5f66 6c61 745f  ompress(fw_flat_
-000215c0: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-000215d0: 7264 2c20 7573 6564 5f6d 6173 6b29 290a  rd, used_mask)).
-000215e0: 2020 2020 6f6e 6c79 5f75 7365 645f 6277      only_used_bw
-000215f0: 5f73 6176 6564 5f66 6f72 5f62 6163 6b77  _saved_for_backw
-00021600: 6172 6420 3d20 7475 706c 6528 636f 6d70  ard = tuple(comp
-00021610: 7265 7373 2862 775f 666c 6174 5f73 6176  ress(bw_flat_sav
-00021620: 6564 5f66 6f72 5f62 6163 6b77 6172 642c  ed_for_backward,
-00021630: 2075 7365 645f 6d61 736b 2929 0a0a 2020   used_mask))..  
-00021640: 2020 2320 5765 206e 6565 6420 746f 2075    # We need to u
-00021650: 7064 6174 6520 7468 6520 7472 6163 6573  pdate the traces
-00021660: 2077 6974 6820 7468 6520 6e65 7720 7361   with the new sa
-00021670: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-00021680: 0a20 2020 205f 7570 6461 7465 5f66 6f72  .    _update_for
-00021690: 7761 7264 5f77 6974 685f 6e65 775f 7361  ward_with_new_sa
-000216a0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-000216b0: 2866 6f72 7761 7264 5f74 7261 6365 2c20  (forward_trace, 
-000216c0: 6f6e 6c79 5f75 7365 645f 6677 5f73 6176  only_used_fw_sav
-000216d0: 6564 5f66 6f72 5f62 6163 6b77 6172 6429  ed_for_backward)
-000216e0: 0a20 2020 205f 7570 6461 7465 5f62 6163  .    _update_bac
-000216f0: 6b77 6172 645f 7769 7468 5f6e 6577 5f73  kward_with_new_s
-00021700: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-00021710: 6428 6261 636b 7761 7264 5f74 7261 6365  d(backward_trace
-00021720: 2c20 6f6e 6c79 5f75 7365 645f 6277 5f73  , only_used_bw_s
-00021730: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-00021740: 6429 0a20 2020 2066 6f72 7761 7264 5f74  d).    forward_t
-00021750: 7261 6365 2e73 6574 5f70 726f 7665 6e61  race.set_provena
-00021760: 6e63 6528 5472 6163 6550 726f 7665 6e61  nce(TraceProvena
-00021770: 6e63 6528 2241 7567 6d65 6e74 6564 2066  nce("Augmented f
-00021780: 6f72 7761 7264 2070 6173 7322 2929 0a20  orward pass")). 
-00021790: 2020 2062 6163 6b77 6172 645f 7472 6163     backward_trac
-000217a0: 652e 7365 745f 7072 6f76 656e 616e 6365  e.set_provenance
-000217b0: 2854 7261 6365 5072 6f76 656e 616e 6365  (TraceProvenance
-000217c0: 2822 4261 636b 7761 7264 2070 6173 7322  ("Backward pass"
-000217d0: 2929 0a20 2020 2072 6574 7572 6e20 466f  )).    return Fo
-000217e0: 7277 6172 6442 6163 6b77 6172 6454 7261  rwardBackwardTra
-000217f0: 6365 7328 666f 7277 6172 645f 7472 6163  ces(forward_trac
-00021800: 652c 2062 6163 6b77 6172 645f 7472 6163  e, backward_trac
-00021810: 6529 0a0a 0a23 2064 6f20 7765 2068 6170  e)...# do we hap
-00021820: 7065 6e20 746f 2077 616e 7420 746f 2072  pen to want to r
-00021830: 6567 6973 7465 7220 606c 746f 7263 6860  egister `ltorch`
-00021840: 206f 7073 2073 7563 6820 6173 2060 6c74   ops such as `lt
-00021850: 6f72 6368 2e6c 6179 6572 5f6e 6f72 6d60  orch.layer_norm`
-00021860: 2061 7320 7765 6c6c 3f0a 6175 746f 6361   as well?.autoca
-00021870: 7374 5f69 6d70 6c73 3a20 6469 6374 5b70  st_impls: dict[p
-00021880: 7269 6d73 2e50 7269 6d49 4473 2c20 4361  rims.PrimIDs, Ca
-00021890: 6c6c 6162 6c65 5d20 3d20 7b7d 0a0a 0a64  llable] = {}...d
-000218a0: 6566 2072 6567 6973 7465 725f 6175 746f  ef register_auto
-000218b0: 6361 7374 5f72 756c 6528 6f70 293a 0a20  cast_rule(op):. 
-000218c0: 2020 2064 6566 2064 6563 6f72 6174 6f72     def decorator
-000218d0: 2866 756e 6329 3a0a 2020 2020 2020 2020  (func):.        
-000218e0: 6175 746f 6361 7374 5f69 6d70 6c73 5b6f  autocast_impls[o
-000218f0: 705d 203d 2066 756e 630a 2020 2020 2020  p] = func.      
-00021900: 2020 7265 7475 726e 2066 756e 630a 0a20    return func.. 
-00021910: 2020 2072 6574 7572 6e20 6465 636f 7261     return decora
-00021920: 746f 720a 0a0a 6465 6620 6d61 7962 655f  tor...def maybe_
-00021930: 646f 776e 6361 7374 5f74 6f28 6474 7970  downcast_to(dtyp
-00021940: 652c 2061 7267 7329 3a0a 2020 2020 616c  e, args):.    al
-00021950: 6c6f 7765 645f 646f 776e 6361 7374 5f74  lowed_downcast_t
-00021960: 7970 6573 203d 2028 6474 7970 6573 2e66  ypes = (dtypes.f
-00021970: 6c6f 6174 3136 2c20 6474 7970 6573 2e62  loat16, dtypes.b
-00021980: 666c 6f61 7431 362c 2064 7479 7065 732e  float16, dtypes.
-00021990: 666c 6f61 7433 3229 0a0a 2020 2020 6465  float32)..    de
-000219a0: 6620 6d61 705f 666e 2861 293a 0a20 2020  f map_fn(a):.   
-000219b0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-000219c0: 6365 2861 2c20 5465 6e73 6f72 5072 6f78  ce(a, TensorProx
-000219d0: 7929 2061 6e64 2061 2e64 7479 7065 2069  y) and a.dtype i
-000219e0: 6e20 616c 6c6f 7765 645f 646f 776e 6361  n allowed_downca
-000219f0: 7374 5f74 7970 6573 3a0a 2020 2020 2020  st_types:.      
-00021a00: 2020 2020 2020 7265 7475 726e 206d 6179        return may
-00021a10: 6265 5f63 6f6e 7665 7274 5f74 6f5f 6474  be_convert_to_dt
-00021a20: 7970 6528 612c 2064 7479 7065 290a 2020  ype(a, dtype).  
-00021a30: 2020 2020 2020 7265 7475 726e 2061 0a0a        return a..
-00021a40: 2020 2020 7265 7475 726e 2074 7265 655f      return tree_
-00021a50: 6d61 7028 6d61 705f 666e 2c20 6172 6773  map(map_fn, args
-00021a60: 290a 0a0a 4072 6567 6973 7465 725f 6175  )...@register_au
-00021a70: 746f 6361 7374 5f72 756c 6528 2274 6f72  tocast_rule("tor
-00021a80: 6368 2e6d 6174 6d75 6c22 290a 4072 6567  ch.matmul").@reg
-00021a90: 6973 7465 725f 6175 746f 6361 7374 5f72  ister_autocast_r
-00021aa0: 756c 6528 7072 696d 732e 5072 696d 4944  ule(prims.PrimID
-00021ab0: 732e 4d41 544d 554c 290a 6465 6620 6175  s.MATMUL).def au
-00021ac0: 746f 6361 7374 5f6d 6174 6d75 6c5f 7275  tocast_matmul_ru
-00021ad0: 6c65 2861 2c20 622c 2064 7479 7065 293a  le(a, b, dtype):
-00021ae0: 0a20 2020 2022 2222 4175 746f 6361 7374  .    """Autocast
-00021af0: 2072 756c 6520 666f 7220 6d61 746d 756c   rule for matmul
-00021b00: 2222 220a 2020 2020 7265 7475 726e 2070  """.    return p
-00021b10: 7269 6d73 2e6d 6174 6d75 6c28 2a28 6d61  rims.matmul(*(ma
-00021b20: 7962 655f 646f 776e 6361 7374 5f74 6f28  ybe_downcast_to(
-00021b30: 6474 7970 652c 2028 612c 2062 2929 2929  dtype, (a, b))))
-00021b40: 0a0a 0a40 7265 6769 7374 6572 5f61 7574  ...@register_aut
-00021b50: 6f63 6173 745f 7275 6c65 2822 746f 7263  ocast_rule("torc
-00021b60: 682e 6e6e 2e66 756e 6374 696f 6e61 6c2e  h.nn.functional.
-00021b70: 6c69 6e65 6172 2229 0a40 7265 6769 7374  linear").@regist
-00021b80: 6572 5f61 7574 6f63 6173 745f 7275 6c65  er_autocast_rule
-00021b90: 2870 7269 6d73 2e50 7269 6d49 4473 2e4c  (prims.PrimIDs.L
-00021ba0: 494e 4541 5229 0a64 6566 2061 7574 6f63  INEAR).def autoc
-00021bb0: 6173 745f 6c69 6e65 6172 5f72 756c 6528  ast_linear_rule(
-00021bc0: 612c 2077 2c20 6269 6173 2c20 6474 7970  a, w, bias, dtyp
-00021bd0: 6529 3a0a 2020 2020 6966 2062 6961 7320  e):.    if bias 
-00021be0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00021bf0: 2023 2044 6f6e 2774 2070 6173 7320 6062   # Don't pass `b
-00021c00: 6961 7360 2074 6f20 6d61 7962 655f 646f  ias` to maybe_do
-00021c10: 776e 6361 7374 5f74 6f2e 0a20 2020 2020  wncast_to..     
-00021c20: 2020 2064 6f77 6e63 6173 745f 6172 6773     downcast_args
-00021c30: 203d 206d 6179 6265 5f64 6f77 6e63 6173   = maybe_downcas
-00021c40: 745f 746f 2864 7479 7065 2c20 2861 2c20  t_to(dtype, (a, 
-00021c50: 7729 2920 2b20 2862 6961 732c 290a 2020  w)) + (bias,).  
-00021c60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00021c70: 646f 776e 6361 7374 5f61 7267 7320 3d20  downcast_args = 
-00021c80: 6d61 7962 655f 646f 776e 6361 7374 5f74  maybe_downcast_t
-00021c90: 6f28 6474 7970 652c 2028 612c 2077 2c20  o(dtype, (a, w, 
-00021ca0: 6269 6173 2929 0a0a 2020 2020 7265 7475  bias))..    retu
-00021cb0: 726e 2070 7269 6d73 2e6c 696e 6561 7228  rn prims.linear(
-00021cc0: 2a64 6f77 6e63 6173 745f 6172 6773 290a  *downcast_args).
-00021cd0: 0a0a 4072 6567 6973 7465 725f 6175 746f  ..@register_auto
-00021ce0: 6361 7374 5f72 756c 6528 2274 6f72 6368  cast_rule("torch
-00021cf0: 2e6e 6e2e 6675 6e63 7469 6f6e 616c 2e73  .nn.functional.s
-00021d00: 6361 6c65 645f 646f 745f 7072 6f64 7563  caled_dot_produc
-00021d10: 745f 6174 7465 6e74 696f 6e22 290a 6465  t_attention").de
-00021d20: 6620 6175 746f 6361 7374 5f73 6361 6c65  f autocast_scale
-00021d30: 645f 646f 745f 7072 6f64 7563 745f 6174  d_dot_product_at
-00021d40: 7465 6e74 696f 6e28 0a20 2020 2071 7565  tention(.    que
-00021d50: 7279 2c0a 2020 2020 6b65 792c 0a20 2020  ry,.    key,.   
-00021d60: 2076 616c 7565 2c0a 2020 2020 6174 746e   value,.    attn
-00021d70: 5f6d 6173 6b2c 0a20 2020 2064 726f 706f  _mask,.    dropo
-00021d80: 7574 5f70 2c0a 2020 2020 6973 5f63 6175  ut_p,.    is_cau
-00021d90: 7361 6c2c 0a20 2020 202a 2c0a 2020 2020  sal,.    *,.    
-00021da0: 6474 7970 652c 0a20 2020 2073 6361 6c65  dtype,.    scale
-00021db0: 2c0a 293a 0a20 2020 2066 726f 6d20 7468  ,.):.    from th
-00021dc0: 756e 6465 722e 746f 7263 6820 696d 706f  under.torch impo
-00021dd0: 7274 2073 6361 6c65 645f 646f 745f 7072  rt scaled_dot_pr
-00021de0: 6f64 7563 745f 6174 7465 6e74 696f 6e0a  oduct_attention.
-00021df0: 0a20 2020 2071 2c20 6b2c 2076 203d 206d  .    q, k, v = m
-00021e00: 6179 6265 5f64 6f77 6e63 6173 745f 746f  aybe_downcast_to
-00021e10: 2864 7479 7065 2c20 2871 7565 7279 2c20  (dtype, (query, 
-00021e20: 6b65 792c 2076 616c 7565 2929 0a20 2020  key, value)).   
-00021e30: 2072 6574 7572 6e20 7363 616c 6564 5f64   return scaled_d
-00021e40: 6f74 5f70 726f 6475 6374 5f61 7474 656e  ot_product_atten
-00021e50: 7469 6f6e 2871 2c20 6b2c 2076 2c20 6174  tion(q, k, v, at
-00021e60: 746e 5f6d 6173 6b2c 2064 726f 706f 7574  tn_mask, dropout
-00021e70: 5f70 2c20 6973 5f63 6175 7361 6c2c 2073  _p, is_causal, s
-00021e80: 6361 6c65 3d73 6361 6c65 290a 0a0a 6465  cale=scale)...de
-00021e90: 6620 6175 746f 6361 7374 5f73 796d 626f  f autocast_symbo
-00021ea0: 6c5f 6d61 7070 6572 2862 6f75 6e64 5f73  l_mapper(bound_s
-00021eb0: 796d 626f 6c3a 2042 6f75 6e64 5379 6d62  ymbol: BoundSymb
-00021ec0: 6f6c 496e 7465 7266 6163 652c 2064 7479  olInterface, dty
-00021ed0: 7065 3a20 6474 7970 6573 2e64 7479 7065  pe: dtypes.dtype
-00021ee0: 293a 0a20 2020 2022 2222 5265 7475 726e  ):.    """Return
-00021ef0: 2074 6865 2063 616c 6c61 626c 6520 696d   the callable im
-00021f00: 706c 656d 656e 7469 6e67 2074 6865 2061  plementing the a
-00021f10: 7574 6f63 6173 7420 7275 6c65 2066 6f72  utocast rule for
-00021f20: 2074 6865 2073 796d 626f 6c2e 0a0a 2020   the symbol...  
-00021f30: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-00021f40: 626f 756e 645f 7379 6d62 6f6c 3a20 4d61  bound_symbol: Ma
-00021f50: 7070 6564 2074 6f20 6974 7320 6175 746f  pped to its auto
-00021f60: 6361 7374 2072 756c 652e 0a0a 2020 2020  cast rule...    
-00021f70: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-00021f80: 2043 616c 6c61 626c 653a 2054 6865 2063   Callable: The c
-00021f90: 616c 6c61 626c 6520 696d 706c 656d 656e  allable implemen
-00021fa0: 7469 6e67 2074 6865 2061 7574 6f63 6173  ting the autocas
-00021fb0: 7420 7275 6c65 2066 6f72 2074 6865 2073  t rule for the s
-00021fc0: 796d 626f 6c2e 0a20 2020 2022 2222 0a20  ymbol..    """. 
-00021fd0: 2020 2061 7574 6f63 6173 745f 696d 706c     autocast_impl
-00021fe0: 3a20 4361 6c6c 6162 6c65 207c 204e 6f6e  : Callable | Non
-00021ff0: 6520 3d20 6175 746f 6361 7374 5f69 6d70  e = autocast_imp
-00022000: 6c73 2e67 6574 2862 6f75 6e64 5f73 796d  ls.get(bound_sym
-00022010: 626f 6c2e 7379 6d2e 6964 290a 2020 2020  bol.sym.id).    
-00022020: 7265 7475 726e 2062 6f75 6e64 5f73 796d  return bound_sym
-00022030: 626f 6c2e 7379 6d20 6966 2061 7574 6f63  bol.sym if autoc
-00022040: 6173 745f 696d 706c 2069 7320 4e6f 6e65  ast_impl is None
-00022050: 2065 6c73 6520 7061 7274 6961 6c28 6175   else partial(au
-00022060: 746f 6361 7374 5f69 6d70 6c2c 2064 7479  tocast_impl, dty
-00022070: 7065 3d64 7479 7065 290a 0a0a 6465 6620  pe=dtype)...def 
-00022080: 6175 746f 6361 7374 2866 756e 633a 2043  autocast(func: C
-00022090: 616c 6c61 626c 652c 2064 7479 7065 3a20  allable, dtype: 
-000220a0: 6474 7970 6573 2e64 7479 7065 293a 0a20  dtypes.dtype):. 
-000220b0: 2020 2022 2222 5472 616e 7366 6f72 6d73     """Transforms
-000220c0: 2061 2066 756e 6374 696f 6e20 746f 2061   a function to a
-000220d0: 7574 6f63 6173 7420 6365 7274 6169 6e20  utocast certain 
-000220e0: 6f70 6572 6174 696f 6e73 2e0a 0a20 2020  operations...   
-000220f0: 2041 7267 733a 0a20 2020 2020 2020 2066   Args:.        f
-00022100: 756e 633a 2054 6865 2066 756e 6374 696f  unc: The functio
-00022110: 6e20 746f 2062 6520 7472 616e 7366 6f72  n to be transfor
-00022120: 6d65 642e 0a20 2020 2020 2020 2064 7479  med..        dty
-00022130: 7065 3a20 5468 6520 6461 7461 2074 7970  pe: The data typ
-00022140: 6520 746f 2077 6869 6368 2061 7267 756d  e to which argum
-00022150: 656e 7473 206f 6620 7468 6520 6675 6e63  ents of the func
-00022160: 7469 6f6e 206f 7220 7375 6220 6675 6e63  tion or sub func
-00022170: 7469 6f6e 7320 636f 756c 6420 6765 7420  tions could get 
-00022180: 6361 7374 2069 660a 2020 2020 2020 2020  cast if.        
-00022190: 2020 2020 7468 6579 2061 7265 2060 6474      they are `dt
-000221a0: 7970 6573 2e66 6c6f 6174 3332 602e 0a0a  ypes.float32`...
-000221b0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-000221c0: 2020 2020 2043 616c 6c61 626c 653a 2054       Callable: T
-000221d0: 6865 2074 7261 6e73 666f 726d 6564 2066  he transformed f
-000221e0: 756e 6374 696f 6e0a 2020 2020 2222 220a  unction.    """.
-000221f0: 0a20 2020 2069 6620 6e6f 7420 6973 696e  .    if not isin
-00022200: 7374 616e 6365 2864 7479 7065 2c20 6474  stance(dtype, dt
-00022210: 7970 6573 2e64 7479 7065 293a 0a20 2020  ypes.dtype):.   
-00022220: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00022230: 4572 726f 7228 6622 6064 7479 7065 6020  Error(f"`dtype` 
-00022240: 6973 2065 7870 6563 7465 6420 746f 2062  is expected to b
-00022250: 6520 6074 6875 6e64 6572 2e64 7479 7065  e `thunder.dtype
-00022260: 2e64 7479 7065 6020 6275 7420 7b74 7970  .dtype` but {typ
-00022270: 6528 6474 7970 6529 7d22 290a 2020 2020  e(dtype)}").    
-00022280: 6966 2064 7479 7065 206e 6f74 2069 6e20  if dtype not in 
-00022290: 7b64 7479 7065 732e 666c 6f61 7431 362c  {dtypes.float16,
-000222a0: 2064 7479 7065 732e 6266 6c6f 6174 3136   dtypes.bfloat16
-000222b0: 7d3a 0a20 2020 2020 2020 2072 6169 7365  }:.        raise
-000222c0: 2056 616c 7565 4572 726f 7228 6622 6064   ValueError(f"`d
-000222d0: 7479 7065 6020 6973 2065 7870 6563 7465  type` is expecte
-000222e0: 6420 746f 2062 6520 6569 7468 6572 2060  d to be either `
-000222f0: 7468 756e 6465 722e 666c 6f61 7431 3660  thunder.float16`
-00022300: 206f 7220 6074 6875 6e64 6572 2e62 666c   or `thunder.bfl
-00022310: 6f61 7431 3660 2c20 6275 7420 7b64 7479  oat16`, but {dty
-00022320: 7065 7d22 290a 0a20 2020 2040 7772 6170  pe}")..    @wrap
-00022330: 7328 6675 6e63 290a 2020 2020 6465 6620  s(func).    def 
-00022340: 7772 6170 7065 7228 2a61 7267 732c 202a  wrapper(*args, *
-00022350: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-00022360: 2020 7472 6163 6520 3d20 636f 6e73 7472    trace = constr
-00022370: 7563 745f 7472 6163 6528 2928 6675 6e63  uct_trace()(func
-00022380: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
-00022390: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
-000223a0: 6e20 6576 616c 5f74 7261 6365 2874 7261  n eval_trace(tra
-000223b0: 6365 2c20 2a61 7267 732c 202a 2a6b 7761  ce, *args, **kwa
-000223c0: 7267 732c 2073 796d 626f 6c5f 6d61 7070  rgs, symbol_mapp
-000223d0: 6572 3d70 6172 7469 616c 2861 7574 6f63  er=partial(autoc
-000223e0: 6173 745f 7379 6d62 6f6c 5f6d 6170 7065  ast_symbol_mappe
-000223f0: 722c 2064 7479 7065 3d64 7479 7065 2929  r, dtype=dtype))
-00022400: 0a0a 2020 2020 7265 7475 726e 2077 7261  ..    return wra
-00022410: 7070 6572 0a                             pper.
+0000afd0: 7072 696d 616c 735f 746f 5f67 696e 7075  primals_to_ginpu
+0000afe0: 745f 6d61 705b 7670 7269 6d61 6c5d 203d  t_map[vprimal] =
+0000aff0: 2067 7261 640a 2020 2020 2020 2020 2020   grad.          
+0000b000: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000b010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b020: 2020 2020 2020 2020 6163 6375 6d20 3d20          accum = 
+0000b030: 6163 6375 6d20 2b20 6772 6164 0a20 2020  accum + grad.   
+0000b040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b050: 2020 2020 2070 7269 6d61 6c73 5f74 6f5f       primals_to_
+0000b060: 6769 6e70 7574 5f6d 6170 5b76 7072 696d  ginput_map[vprim
+0000b070: 616c 5d20 3d20 6163 6375 6d0a 0a20 2020  al] = accum..   
+0000b080: 2020 2020 2020 2020 2023 2048 616e 646c           # Handl
+0000b090: 6573 2067 6574 5f67 7261 6420 6f70 6572  es get_grad oper
+0000b0a0: 6174 696f 6e73 0a0a 2020 2020 2020 2020  ations..        
+0000b0b0: 2020 2020 2320 5265 7365 7473 2074 6865      # Resets the
+0000b0c0: 2073 7761 706d 6170 2066 6f72 2067 7261   swapmap for gra
+0000b0d0: 6473 0a20 2020 2020 2020 2020 2020 2073  ds.            s
+0000b0e0: 7761 706d 6170 3a20 6469 6374 5b56 6172  wapmap: dict[Var
+0000b0f0: 6961 626c 652c 2050 726f 7879 5d20 3d20  iable, Proxy] = 
+0000b100: 7b7d 0a0a 2020 2020 2020 2020 2020 2020  {}..            
+0000b110: 666f 7220 6273 796d 2069 6e20 6772 6164  for bsym in grad
+0000b120: 7472 632e 626f 756e 645f 7379 6d62 6f6c  trc.bound_symbol
+0000b130: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000b140: 2020 2069 643a 2048 6173 6861 626c 6520     id: Hashable 
+0000b150: 3d20 6273 796d 2e73 796d 2e69 640a 2020  = bsym.sym.id.  
+0000b160: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000b170: 2069 6420 6973 2070 6964 732e 4745 545f   id is pids.GET_
+0000b180: 4752 4144 3a0a 2020 2020 2020 2020 2020  GRAD:.          
+0000b190: 2020 2020 2020 2020 2020 7072 696d 616c            primal
+0000b1a0: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
+0000b1b0: 7250 726f 7879 0a20 2020 2020 2020 2020  rProxy.         
+0000b1c0: 2020 2020 2020 2020 2020 2028 7072 696d             (prim
+0000b1d0: 616c 2c29 203d 2062 7379 6d2e 666c 6174  al,) = bsym.flat
+0000b1e0: 5f61 7267 730a 2020 2020 2020 2020 2020  _args.          
+0000b1f0: 2020 2020 2020 2020 2020 6772 6164 3a20            grad: 
+0000b200: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
+0000b210: 726f 7879 203d 2062 7379 6d2e 6f75 7470  roxy = bsym.outp
+0000b220: 7574 0a0a 2020 2020 2020 2020 2020 2020  ut..            
+0000b230: 2020 2020 2020 2020 7670 7269 6d61 6c3a          vprimal:
+0000b240: 2056 6172 6961 626c 650a 2020 2020 2020   Variable.      
+0000b250: 2020 2020 2020 2020 2020 2020 2020 7667                vg
+0000b260: 7261 643a 2056 6172 6961 626c 650a 2020  rad: Variable.  
+0000b270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b280: 2020 7670 7269 6d61 6c2c 2076 6772 6164    vprimal, vgrad
+0000b290: 203d 2076 6172 6961 626c 6569 6679 2870   = variableify(p
+0000b2a0: 7269 6d61 6c29 2c20 7661 7269 6162 6c65  rimal), variable
+0000b2b0: 6966 7928 6772 6164 290a 0a20 2020 2020  ify(grad)..     
+0000b2c0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000b2d0: 6374 7561 6c5f 6772 6164 3a20 4e6f 6e65  ctual_grad: None
+0000b2e0: 207c 2054 656e 736f 7250 726f 7879 203d   | TensorProxy =
+0000b2f0: 2070 7269 6d61 6c73 5f74 6f5f 6769 6e70   primals_to_ginp
+0000b300: 7574 5f6d 6170 2e67 6574 2876 7072 696d  ut_map.get(vprim
+0000b310: 616c 2c20 4e6f 6e65 290a 0a20 2020 2020  al, None)..     
+0000b320: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000b330: 204e 4f54 4520 4966 2061 6374 7561 6c5f   NOTE If actual_
+0000b340: 6772 6164 2069 7320 4e6f 6e65 2074 6865  grad is None the
+0000b350: 6e20 7468 6572 6527 7320 6120 6765 745f  n there's a get_
+0000b360: 6772 6164 2829 2072 6571 7565 7374 2066  grad() request f
+0000b370: 6f72 2061 2074 656e 736f 7220 7768 6963  or a tensor whic
+0000b380: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
+0000b390: 2020 2020 2020 2320 2020 6861 7320 6e6f        #   has no
+0000b3a0: 2070 7574 5f67 7261 6428 292c 2073 6f20   put_grad(), so 
+0000b3b0: 7765 2072 6574 7572 6e20 7a65 726f 7320  we return zeros 
+0000b3c0: 666f 7220 7468 6520 6772 6164 0a20 2020  for the grad.   
+0000b3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3e0: 2023 2054 4f44 4f20 5265 7669 7369 7420   # TODO Revisit 
+0000b3f0: 7468 6973 202d 2d20 6361 6e20 7765 2072  this -- can we r
+0000b400: 656d 6f76 6520 7468 6573 6520 636f 6d70  emove these comp
+0000b410: 7574 6174 696f 6e73 2c20 6f72 2075 7365  utations, or use
+0000b420: 2061 2073 7065 6369 616c 205a 6572 6f54   a special ZeroT
+0000b430: 656e 736f 720a 2020 2020 2020 2020 2020  ensor.          
+0000b440: 2020 2020 2020 2020 2020 2320 2020 746f            #   to
+0000b450: 2073 696d 706c 6966 7920 7468 656d 3f0a   simplify them?.
+0000b460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b470: 2020 2020 6966 2061 6374 7561 6c5f 6772      if actual_gr
+0000b480: 6164 2069 7320 4e6f 6e65 3a0a 2020 2020  ad is None:.    
+0000b490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b4a0: 2020 2020 6163 7475 616c 5f67 7261 6420      actual_grad 
+0000b4b0: 3d20 6c74 6f72 6368 2e7a 6572 6f73 5f6c  = ltorch.zeros_l
+0000b4c0: 696b 6528 7072 696d 616c 290a 2020 2020  ike(primal).    
+0000b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b4e0: 2020 2020 7072 696d 616c 735f 746f 5f67      primals_to_g
+0000b4f0: 696e 7075 745f 6d61 705b 7670 7269 6d61  input_map[vprima
+0000b500: 6c5d 203d 2061 6374 7561 6c5f 6772 6164  l] = actual_grad
+0000b510: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000b520: 2020 2020 2020 2320 5570 6461 7465 7320        # Updates 
+0000b530: 7468 6520 6772 6164 2061 6c69 6173 206d  the grad alias m
+0000b540: 6170 0a20 2020 2020 2020 2020 2020 2020  ap.             
+0000b550: 2020 2020 2020 2076 6163 7475 616c 5f67         vactual_g
+0000b560: 7261 643a 2056 6172 6961 626c 6520 3d20  rad: Variable = 
+0000b570: 7661 7269 6162 6c65 6966 7928 6163 7475  variableify(actu
+0000b580: 616c 5f67 7261 6429 0a20 2020 2020 2020  al_grad).       
+0000b590: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000b5a0: 7661 6374 7561 6c5f 6772 6164 2021 3d20  vactual_grad != 
+0000b5b0: 7667 7261 643a 0a20 2020 2020 2020 2020  vgrad:.         
+0000b5c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000b5d0: 7761 706d 6170 5b76 6772 6164 5d20 3d20  wapmap[vgrad] = 
+0000b5e0: 6163 7475 616c 5f67 7261 640a 0a20 2020  actual_grad..   
+0000b5f0: 2020 2020 2066 696e 616c 6c79 3a0a 2020       finally:.  
+0000b600: 2020 2020 2020 2020 2020 2320 5265 7374            # Rest
+0000b610: 6f72 6573 2073 636f 7065 0a20 2020 2020  ores scope.     
+0000b620: 2020 2020 2020 2072 6573 6574 5f74 7261         reset_tra
+0000b630: 6365 6374 7828 7472 6163 6563 7478 5f74  cectx(tracectx_t
+0000b640: 6f6b 290a 0a20 2020 2020 2020 2023 2046  ok)..        # F
+0000b650: 696c 7465 7273 2070 7574 5f67 7261 6420  ilters put_grad 
+0000b660: 616e 6420 6765 745f 6772 6164 206f 7065  and get_grad ope
+0000b670: 7261 7469 6f6e 7320 616e 6420 6170 706c  rations and appl
+0000b680: 6965 7320 7468 6520 7377 6170 6d61 700a  ies the swapmap.
+0000b690: 2020 2020 2020 2020 6465 6620 5f66 696c          def _fil
+0000b6a0: 7465 7228 6273 796d 3a20 426f 756e 6453  ter(bsym: BoundS
+0000b6b0: 796d 626f 6c29 202d 3e20 626f 6f6c 3a0a  ymbol) -> bool:.
+0000b6c0: 2020 2020 2020 2020 2020 2020 6964 3a20              id: 
+0000b6d0: 4861 7368 6162 6c65 203d 2062 7379 6d2e  Hashable = bsym.
+0000b6e0: 7379 6d2e 6964 0a20 2020 2020 2020 2020  sym.id.         
+0000b6f0: 2020 2072 6574 7572 6e20 6964 2069 6e20     return id in 
+0000b700: 2870 6964 732e 5055 545f 4752 4144 2c20  (pids.PUT_GRAD, 
+0000b710: 7069 6473 2e47 4554 5f47 5241 4429 0a0a  pids.GET_GRAD)..
+0000b720: 2020 2020 2020 2020 6772 6164 7472 632e          gradtrc.
+0000b730: 626f 756e 645f 7379 6d62 6f6c 7320 3d20  bound_symbols = 
+0000b740: 5b0a 2020 2020 2020 2020 2020 2020 6273  [.            bs
+0000b750: 796d 2e66 726f 6d5f 6273 796d 5f73 7761  ym.from_bsym_swa
+0000b760: 705f 7072 6f78 6965 7328 7377 6170 6d61  p_proxies(swapma
+0000b770: 7029 2066 6f72 2062 7379 6d20 696e 2067  p) for bsym in g
+0000b780: 7261 6474 7263 2e62 6f75 6e64 5f73 796d  radtrc.bound_sym
+0000b790: 626f 6c73 2069 6620 6e6f 7420 5f66 696c  bols if not _fil
+0000b7a0: 7465 7228 6273 796d 290a 2020 2020 2020  ter(bsym).      
+0000b7b0: 2020 5d0a 0a20 2020 2020 2020 2023 2053    ]..        # S
+0000b7c0: 5445 5020 464f 5552 202d 2d2d 204f 7264  TEP FOUR --- Ord
+0000b7d0: 6572 7320 7468 6520 6f70 6572 6174 696f  ers the operatio
+0000b7e0: 6e73 0a20 2020 2020 2020 2023 2054 4f44  ns.        # TOD
+0000b7f0: 4f20 436f 6e73 6964 6572 2061 6c74 6572  O Consider alter
+0000b800: 6e61 7469 7665 2073 6368 6564 756c 696e  native schedulin
+0000b810: 6720 616c 676f 7269 7468 6d73 2c20 6d61  g algorithms, ma
+0000b820: 7962 6520 6279 2075 7369 6e67 2067 7261  ybe by using gra
+0000b830: 7068 2066 6561 7475 7265 730a 2020 2020  ph features.    
+0000b840: 2020 2020 2320 2020 536f 6d65 2069 6465      #   Some ide
+0000b850: 6173 2061 7265 206c 6f6f 6b69 6e67 2061  as are looking a
+0000b860: 7420 6d65 6d6f 7279 2d73 6176 696e 6720  t memory-saving 
+0000b870: 6e6f 6465 732c 2061 6e64 206e 6f64 6573  nodes, and nodes
+0000b880: 2077 6974 6820 6120 6869 6768 2069 6e2d   with a high in-
+0000b890: 6465 6772 6565 206f 7220 6869 6768 206f  degree or high o
+0000b8a0: 7574 2d64 6567 7265 650a 0a20 2020 2020  ut-degree..     
+0000b8b0: 2020 2023 2043 7265 6174 6573 2061 6e20     # Creates an 
+0000b8c0: 696e 6974 6961 6c20 7661 6c69 6420 6f72  initial valid or
+0000b8d0: 6465 7269 6e67 2074 6f20 4443 452c 2073  dering to DCE, s
+0000b8e0: 6f20 7468 6174 2061 6464 6974 696f 6e61  o that additiona
+0000b8f0: 6c20 6f72 6465 7269 6e67 2061 6e61 6c79  l ordering analy
+0000b900: 7369 7320 646f 6573 6e27 7420 6e65 6564  sis doesn't need
+0000b910: 2074 6f20 636f 6e73 6964 6572 2061 6c6c   to consider all
+0000b920: 2073 796d 626f 6c73 0a20 2020 2020 2020   symbols.       
+0000b930: 2072 6f6f 7473 2c20 6c65 6176 6573 203d   roots, leaves =
+0000b940: 2062 7379 6d5f 6c69 7374 5f74 6f5f 6461   bsym_list_to_da
+0000b950: 6728 6772 6164 7472 632e 626f 756e 645f  g(gradtrc.bound_
+0000b960: 7379 6d62 6f6c 7329 0a20 2020 2020 2020  symbols).       
+0000b970: 206f 7264 6572 6564 5f62 7379 6d73 203d   ordered_bsyms =
+0000b980: 2074 6f70 6f73 6f72 745f 6273 796d 5f64   toposort_bsym_d
+0000b990: 6167 2872 6f6f 7473 2c20 544f 504f 534f  ag(roots, TOPOSO
+0000b9a0: 5254 5f4f 5244 4552 2e54 4f50 5f44 4f57  RT_ORDER.TOP_DOW
+0000b9b0: 4e29 0a20 2020 2020 2020 2067 7261 6474  N).        gradt
+0000b9c0: 7263 2e62 6f75 6e64 5f73 796d 626f 6c73  rc.bound_symbols
+0000b9d0: 203d 206f 7264 6572 6564 5f62 7379 6d73   = ordered_bsyms
+0000b9e0: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
+0000b9f0: 203d 2064 6365 2867 7261 6474 7263 290a   = dce(gradtrc).
+0000ba00: 0a20 2020 2020 2020 2023 2049 6465 6e74  .        # Ident
+0000ba10: 6966 6965 7320 7468 6520 6f72 6465 7220  ifies the order 
+0000ba20: 6f66 2042 6f75 6e64 5379 6d62 6f6c 7320  of BoundSymbols 
+0000ba30: 7573 696e 6720 6120 2244 4653 2061 6e64  using a "DFS and
+0000ba40: 2063 6861 696e 2220 616c 676f 7269 7468   chain" algorith
+0000ba50: 6d0a 2020 2020 2020 2020 2320 544f 444f  m.        # TODO
+0000ba60: 2045 6c61 626f 7261 7465 206f 6e20 7468   Elaborate on th
+0000ba70: 6973 2061 6c67 6f72 6974 686d 2061 6e64  is algorithm and
+0000ba80: 2074 6865 2069 6d70 6c65 6d65 6e74 6174   the implementat
+0000ba90: 696f 6e0a 2020 2020 2020 2020 726f 6f74  ion.        root
+0000baa0: 732c 206c 6561 7665 7320 3d20 6273 796d  s, leaves = bsym
+0000bab0: 5f6c 6973 745f 746f 5f64 6167 2867 7261  _list_to_dag(gra
+0000bac0: 6474 7263 2e62 6f75 6e64 5f73 796d 626f  dtrc.bound_symbo
+0000bad0: 6c73 290a 2020 2020 2020 2020 6368 6563  ls).        chec
+0000bae0: 6b28 0a20 2020 2020 2020 2020 2020 206c  k(.            l
+0000baf0: 656e 286c 6561 7665 7329 203d 3d20 312c  en(leaves) == 1,
+0000bb00: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
+0000bb10: 6264 613a 2066 2245 7870 6563 7465 6420  bda: f"Expected 
+0000bb20: 6f6e 6c79 206f 6e65 206c 6561 6620 6e6f  only one leaf no
+0000bb30: 6465 2077 6865 6e20 736f 7274 696e 6720  de when sorting 
+0000bb40: 666f 7220 6772 6164 2c20 666f 756e 6420  for grad, found 
+0000bb50: 7468 6572 6520 7765 7265 207b 6c65 6e28  there were {len(
+0000bb60: 6c65 6176 6573 297d 206c 6561 7665 7322  leaves)} leaves"
+0000bb70: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+0000bb80: 2020 2020 286c 6561 662c 2920 3d20 6c65      (leaf,) = le
+0000bb90: 6176 6573 0a0a 2020 2020 2020 2020 2320  aves..        # 
+0000bba0: 436f 6d70 7574 6573 2074 6865 2074 656e  Computes the ten
+0000bbb0: 736f 7220 6d65 6d6f 7279 2075 7365 6420  sor memory used 
+0000bbc0: 6279 2074 6865 2067 6976 656e 2070 7974  by the given pyt
+0000bbd0: 7265 650a 2020 2020 2020 2020 6465 6620  ree.        def 
+0000bbe0: 6d65 6d6f 7279 5f75 7365 6428 7079 7472  memory_used(pytr
+0000bbf0: 6565 2920 2d3e 2069 6e74 3a0a 2020 2020  ee) -> int:.    
+0000bc00: 2020 2020 2020 2020 6d65 6d6f 7279 5f75          memory_u
+0000bc10: 7365 3a20 696e 7420 3d20 300a 0a20 2020  se: int = 0..   
+0000bc20: 2020 2020 2020 2020 2064 6566 2063 6f75           def cou
+0000bc30: 6e74 5f6d 656d 6f72 795f 7573 6528 7829  nt_memory_use(x)
+0000bc40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000bc50: 2020 6e6f 6e6c 6f63 616c 206d 656d 6f72    nonlocal memor
+0000bc60: 795f 7573 650a 2020 2020 2020 2020 2020  y_use.          
+0000bc70: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+0000bc80: 6e63 6528 782c 2054 656e 736f 7250 726f  nce(x, TensorPro
+0000bc90: 7879 293a 0a20 2020 2020 2020 2020 2020  xy):.           
+0000bca0: 2020 2020 2020 2020 206d 656d 6f72 795f           memory_
+0000bcb0: 7573 6520 2b3d 2078 2e64 7479 7065 2e5f  use += x.dtype._
+0000bcc0: 6279 7465 7320 2a20 782e 6e75 6d65 6c0a  bytes * x.numel.
+0000bcd0: 0a20 2020 2020 2020 2020 2020 2074 7265  .            tre
+0000bce0: 655f 6d61 7028 636f 756e 745f 6d65 6d6f  e_map(count_memo
+0000bcf0: 7279 5f75 7365 2c20 7079 7472 6565 290a  ry_use, pytree).
+0000bd00: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000bd10: 726e 206d 656d 6f72 795f 7573 650a 0a20  rn memory_use.. 
+0000bd20: 2020 2020 2020 2023 2054 7275 6520 7768         # True wh
+0000bd30: 656e 2061 206e 6f64 6520 6973 2061 2022  en a node is a "
+0000bd40: 6c69 6e6b 2220 2d2d 2061 206e 6f64 6520  link" -- a node 
+0000bd50: 7769 7468 206f 6e6c 7920 6f6e 6520 6368  with only one ch
+0000bd60: 696c 6420 616e 6420 6174 206d 6f73 7420  ild and at most 
+0000bd70: 6f6e 6520 7061 7265 6e74 0a20 2020 2020  one parent.     
+0000bd80: 2020 2023 2020 2043 6f6e 6365 7074 7561     #   Conceptua
+0000bd90: 6c6c 7920 7468 6520 6e6f 6465 2069 7320  lly the node is 
+0000bda0: 6120 226c 696e 6b22 2069 6e20 6120 6368  a "link" in a ch
+0000bdb0: 6169 6e20 6f66 206e 6f64 6573 206c 696b  ain of nodes lik
+0000bdc0: 6520 4120 2d3e 2042 202d 3e20 430a 2020  e A -> B -> C.  
+0000bdd0: 2020 2020 2020 6465 6620 6973 5f6c 696e        def is_lin
+0000bde0: 6b28 6e3a 204e 6f64 6529 202d 3e20 626f  k(n: Node) -> bo
+0000bdf0: 6f6c 3a0a 2020 2020 2020 2020 2020 2020  ol:.            
+0000be00: 5f69 735f 6c69 6e6b 203d 206c 656e 286e  _is_link = len(n
+0000be10: 2e63 6869 6c64 7265 6e29 203d 3d20 3120  .children) == 1 
+0000be20: 616e 6420 6c65 6e28 6e2e 7061 7265 6e74  and len(n.parent
+0000be30: 7329 203c 3d20 310a 2020 2020 2020 2020  s) <= 1.        
+0000be40: 2020 2020 7265 7475 726e 205f 6973 5f6c      return _is_l
+0000be50: 696e 6b0a 0a20 2020 2020 2020 2063 6f75  ink..        cou
+0000be60: 6e74 6572 3a20 696e 7420 3d20 300a 0a20  nter: int = 0.. 
+0000be70: 2020 2020 2020 2064 6566 205f 6368 6169         def _chai
+0000be80: 6e28 633a 206c 6973 745b 4e6f 6465 5d2c  n(c: list[Node],
+0000be90: 2065 6e64 3a20 4e6f 6465 2920 2d3e 206c   end: Node) -> l
+0000bea0: 6973 745b 4e6f 6465 5d3a 0a20 2020 2020  ist[Node]:.     
+0000beb0: 2020 2020 2020 206e 6f6e 6c6f 6361 6c20         nonlocal 
+0000bec0: 636f 756e 7465 720a 0a20 2020 2020 2020  counter..       
+0000bed0: 2020 2020 2023 2054 4f44 4f20 4578 7065       # TODO Expe
+0000bee0: 7269 6d65 6e74 2077 6974 6820 6e6f 7420  riment with not 
+0000bef0: 616c 7761 7973 2066 7573 696e 6720 7468  always fusing th
+0000bf00: 6973 2069 6e74 6f20 7468 6520 636f 6e73  is into the cons
+0000bf10: 756d 6572 202d 2d20 7468 6572 6520 636f  umer -- there co
+0000bf20: 756c 6420 6265 2061 6e0a 2020 2020 2020  uld be an.      
+0000bf30: 2020 2020 2020 2320 2020 696e 7465 7265        #   intere
+0000bf40: 7374 696e 6720 6d69 6e63 7574 0a20 2020  sting mincut.   
+0000bf50: 2020 2020 2020 2020 2023 204e 4f54 4520           # NOTE 
+0000bf60: 496e 2074 6869 7320 6361 7365 2074 6865  In this case the
+0000bf70: 2063 6861 696e 2063 616e 6e6f 7420 6265   chain cannot be
+0000bf80: 2065 7874 656e 6465 642c 2061 6e64 2069   extended, and i
+0000bf90: 7473 206f 7269 6769 6e20 6973 2069 6e70  ts origin is inp
+0000bfa0: 7574 2074 6f20 7468 6520 6675 6e63 7469  ut to the functi
+0000bfb0: 6f6e 0a20 2020 2020 2020 2020 2020 2023  on.            #
+0000bfc0: 2020 2073 6f20 7468 6973 206a 7573 7420     so this just 
+0000bfd0: 6675 7365 7320 6974 2069 6e74 6f20 7468  fuses it into th
+0000bfe0: 6520 636f 6e73 756d 6572 0a20 2020 2020  e consumer.     
+0000bff0: 2020 2020 2020 2069 6620 6c65 6e28 656e         if len(en
+0000c000: 642e 7061 7265 6e74 7329 203d 3d20 303a  d.parents) == 0:
+0000c010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c020: 2066 6f72 206e 2069 6e20 633a 0a20 2020   for n in c:.   
+0000c030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c040: 206e 2e6e 756d 6265 7220 3d20 636f 756e   n.number = coun
+0000c050: 7465 720a 2020 2020 2020 2020 2020 2020  ter.            
+0000c060: 2020 2020 2020 2020 636f 756e 7465 7220          counter 
+0000c070: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+0000c080: 2020 2020 2072 6574 7572 6e20 5b5d 0a0a       return []..
+0000c090: 2020 2020 2020 2020 2020 2020 2320 4e4f              # NO
+0000c0a0: 5445 206c 656e 2865 6e64 2e70 6172 656e  TE len(end.paren
+0000c0b0: 7473 2920 3d3d 2031 206f 6e20 7468 6973  ts) == 1 on this
+0000c0c0: 2070 6174 680a 2020 2020 2020 2020 2020   path.          
+0000c0d0: 2020 2870 6172 656e 742c 2920 3d20 656e    (parent,) = en
+0000c0e0: 642e 7061 7265 6e74 730a 0a20 2020 2020  d.parents..     
+0000c0f0: 2020 2020 2020 2023 2045 7874 656e 6473         # Extends
+0000c100: 2074 6865 2063 6861 696e 2069 6620 7468   the chain if th
+0000c110: 6520 7061 7265 6e74 2069 7320 6120 6c69  e parent is a li
+0000c120: 6e6b 0a20 2020 2020 2020 2020 2020 2069  nk.            i
+0000c130: 6620 6973 5f6c 696e 6b28 7061 7265 6e74  f is_link(parent
+0000c140: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000c150: 2020 2063 2e61 7070 656e 6428 7061 7265     c.append(pare
+0000c160: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
+0000c170: 2020 2020 7265 7475 726e 205f 6368 6169      return _chai
+0000c180: 6e28 632c 2070 6172 656e 7429 0a0a 2020  n(c, parent)..  
+0000c190: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
+0000c1a0: 2049 6e20 7468 6973 2063 6173 6520 7468   In this case th
+0000c1b0: 6520 6368 6169 6e20 6861 7320 6120 7061  e chain has a pa
+0000c1c0: 7265 6e74 2074 6861 7420 6973 206e 6f74  rent that is not
+0000c1d0: 2061 206c 696e 6b0a 2020 2020 2020 2020   a link.        
+0000c1e0: 2020 2020 2320 4669 6e64 7320 7468 6520      # Finds the 
+0000c1f0: 6d69 6e63 7574 0a20 2020 2020 2020 2020  mincut.         
+0000c200: 2020 206d 696e 6375 745f 6964 783a 2069     mincut_idx: i
+0000c210: 6e74 203d 206c 656e 2863 290a 2020 2020  nt = len(c).    
+0000c220: 2020 2020 2020 2020 6d69 6e5f 6d65 6d6f          min_memo
+0000c230: 7279 5f75 7361 6765 3a20 696e 7420 3d20  ry_usage: int = 
+0000c240: 6d65 6d6f 7279 5f75 7365 6428 7061 7265  memory_used(pare
+0000c250: 6e74 2e62 7379 6d2e 6f75 7470 7574 290a  nt.bsym.output).
+0000c260: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0000c270: 2069 6478 2c20 6e20 696e 2065 6e75 6d65   idx, n in enume
+0000c280: 7261 7465 2863 293a 0a20 2020 2020 2020  rate(c):.       
+0000c290: 2020 2020 2020 2020 206d 656d 203d 206d           mem = m
+0000c2a0: 656d 6f72 795f 7573 6564 286e 2e62 7379  emory_used(n.bsy
+0000c2b0: 6d2e 6f75 7470 7574 290a 2020 2020 2020  m.output).      
+0000c2c0: 2020 2020 2020 2020 2020 6966 206d 656d            if mem
+0000c2d0: 203c 206d 696e 5f6d 656d 6f72 795f 7573   < min_memory_us
+0000c2e0: 6167 653a 0a20 2020 2020 2020 2020 2020  age:.           
+0000c2f0: 2020 2020 2020 2020 206d 696e 6375 745f           mincut_
+0000c300: 6964 7820 3d20 6964 780a 2020 2020 2020  idx = idx.      
+0000c310: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
+0000c320: 6e5f 6d65 6d6f 7279 5f75 7361 6765 203d  n_memory_usage =
+0000c330: 206d 656d 0a0a 2020 2020 2020 2020 2020   mem..          
+0000c340: 2020 666f 7220 6964 782c 206e 2069 6e20    for idx, n in 
+0000c350: 656e 756d 6572 6174 6528 6329 3a0a 2020  enumerate(c):.  
+0000c360: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000c370: 2069 6478 203c 206d 696e 6375 745f 6964   idx < mincut_id
+0000c380: 783a 0a20 2020 2020 2020 2020 2020 2020  x:.             
+0000c390: 2020 2020 2020 206e 2e6e 756d 6265 7220         n.number 
+0000c3a0: 3d20 636f 756e 7465 720a 2020 2020 2020  = counter.      
+0000c3b0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0000c3c0: 756e 7465 7220 2b3d 2031 0a0a 2020 2020  unter += 1..    
+0000c3d0: 2020 2020 2020 2020 2320 5265 7475 726e          # Return
+0000c3e0: 7320 7468 6520 7072 6f64 7563 6572 2d73  s the producer-s
+0000c3f0: 6964 6520 6368 6169 6e20 6375 7420 6966  ide chain cut if
+0000c400: 2069 7420 6578 6973 7473 0a20 2020 2020   it exists.     
+0000c410: 2020 2020 2020 2069 6620 6d69 6e63 7574         if mincut
+0000c420: 5f69 6478 203c 206c 656e 2863 293a 0a20  _idx < len(c):. 
+0000c430: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000c440: 6574 7572 6e20 5b63 5b6d 696e 6375 745f  eturn [c[mincut_
+0000c450: 6964 785d 5d0a 2020 2020 2020 2020 2020  idx]].          
+0000c460: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000c470: 2020 2020 2020 2020 6173 7365 7274 206d          assert m
+0000c480: 696e 6375 745f 6964 7820 3d3d 206c 656e  incut_idx == len
+0000c490: 2863 290a 2020 2020 2020 2020 2020 2020  (c).            
+0000c4a0: 2020 2020 7265 7475 726e 2065 6e64 2e70      return end.p
+0000c4b0: 6172 656e 7473 0a0a 2020 2020 2020 2020  arents..        
+0000c4c0: 6465 6620 6368 6169 6e5f 6f75 7428 6e3a  def chain_out(n:
+0000c4d0: 204e 6f64 652c 2073 7461 636b 3a20 6c69   Node, stack: li
+0000c4e0: 7374 5b4e 6f64 655d 2920 2d3e 204e 6f6e  st[Node]) -> Non
+0000c4f0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+0000c500: 2053 686f 7274 2d63 6972 6375 6974 7320   Short-circuits 
+0000c510: 6966 2074 6865 206f 7269 6769 6e61 6c20  if the original 
+0000c520: 6e6f 6465 206e 2063 616e 6e6f 7420 6265  node n cannot be
+0000c530: 2070 6172 7420 6f66 2061 2063 6861 696e   part of a chain
+0000c540: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000c550: 6e6f 7420 6973 5f6c 696e 6b28 6e29 3a0a  not is_link(n):.
+0000c560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c570: 7374 6163 6b2e 6170 7065 6e64 286e 290a  stack.append(n).
+0000c580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c590: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+0000c5a0: 2020 2020 2320 4e4f 5445 2069 735f 6c69      # NOTE is_li
+0000c5b0: 6e6b 286e 2920 3d3d 2054 7275 650a 2020  nk(n) == True.  
+0000c5c0: 2020 2020 2020 2020 2020 706f 7374 5f63            post_c
+0000c5d0: 6861 696e 3a20 6c69 7374 5b4e 6f64 655d  hain: list[Node]
+0000c5e0: 203d 205f 6368 6169 6e28 5b6e 5d2c 206e   = _chain([n], n
+0000c5f0: 290a 0a20 2020 2020 2020 2020 2020 2066  )..            f
+0000c600: 6f72 2070 6320 696e 2070 6f73 745f 6368  or pc in post_ch
+0000c610: 6169 6e3a 0a20 2020 2020 2020 2020 2020  ain:.           
+0000c620: 2020 2020 2073 7461 636b 2e61 7070 656e       stack.appen
+0000c630: 6428 7063 290a 0a20 2020 2020 2020 2073  d(pc)..        s
+0000c640: 7461 636b 3a20 6c69 7374 5b4e 6f64 655d  tack: list[Node]
+0000c650: 203d 205b 6c65 6166 5d0a 2020 2020 2020   = [leaf].      
+0000c660: 2020 7768 696c 6520 6c65 6e28 7374 6163    while len(stac
+0000c670: 6b29 203e 2030 3a0a 2020 2020 2020 2020  k) > 0:.        
+0000c680: 2020 2020 6e3a 204e 6f64 6520 3d20 7374      n: Node = st
+0000c690: 6163 6b2e 706f 7028 290a 0a20 2020 2020  ack.pop()..     
+0000c6a0: 2020 2020 2020 2069 6620 6e2e 6e75 6d62         if n.numb
+0000c6b0: 6572 2069 7320 6e6f 7420 4e6f 6e65 3a0a  er is not None:.
+0000c6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6d0: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
+0000c6e0: 2020 2020 2020 6e2e 6e75 6d62 6572 203d        n.number =
+0000c6f0: 2063 6f75 6e74 6572 0a20 2020 2020 2020   counter.       
+0000c700: 2020 2020 2063 6f75 6e74 6572 202b 3d20       counter += 
+0000c710: 310a 0a20 2020 2020 2020 2020 2020 2066  1..            f
+0000c720: 6f72 2070 2069 6e20 6e2e 7061 7265 6e74  or p in n.parent
+0000c730: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000c740: 2020 2063 6861 696e 5f6f 7574 2870 2c20     chain_out(p, 
+0000c750: 7374 6163 6b29 0a0a 2020 2020 2020 2020  stack)..        
+0000c760: 6465 6620 5f73 656c 6563 746f 7228 656c  def _selector(el
+0000c770: 6967 6962 6c65 5f6e 6f64 6573 3a20 6c69  igible_nodes: li
+0000c780: 7374 5b4e 6f64 655d 2920 2d3e 2069 6e74  st[Node]) -> int
+0000c790: 3a0a 2020 2020 2020 2020 2020 2020 6d69  :.            mi
+0000c7a0: 6e5f 6964 783a 2069 6e74 203d 2030 0a20  n_idx: int = 0. 
+0000c7b0: 2020 2020 2020 2020 2020 206d 696e 5f6e             min_n
+0000c7c0: 756d 6265 723a 2069 6e74 203d 2065 6c69  umber: int = eli
+0000c7d0: 6769 626c 655f 6e6f 6465 735b 305d 2e6e  gible_nodes[0].n
+0000c7e0: 756d 6265 720a 0a20 2020 2020 2020 2020  umber..         
+0000c7f0: 2020 2023 204e 4f54 4520 416c 7468 6f75     # NOTE Althou
+0000c800: 6768 2077 6527 7665 2061 6c72 6561 6479  gh we've already
+0000c810: 2070 726f 6365 7373 6564 2074 6865 2066   processed the f
+0000c820: 6972 7374 2065 6c65 6d65 6e74 2068 6572  irst element her
+0000c830: 652c 2074 6869 7320 7374 696c 6c0a 2020  e, this still.  
+0000c840: 2020 2020 2020 2020 2020 2320 2020 656e            #   en
+0000c850: 756d 6572 6174 6573 2074 6865 2065 6e74  umerates the ent
+0000c860: 6972 6520 6c69 7374 2063 2074 6f20 616c  ire list c to al
+0000c870: 6967 6e20 7468 6520 656e 756d 6572 6174  ign the enumerat
+0000c880: 696f 6e20 6964 7820 7072 6f70 6572 6c79  ion idx properly
+0000c890: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0000c8a0: 2069 6478 2c20 6e20 696e 2065 6e75 6d65   idx, n in enume
+0000c8b0: 7261 7465 2865 6c69 6769 626c 655f 6e6f  rate(eligible_no
+0000c8c0: 6465 7329 3a0a 2020 2020 2020 2020 2020  des):.          
+0000c8d0: 2020 2020 2020 6368 6563 6b28 6e2e 6e75        check(n.nu
+0000c8e0: 6d62 6572 2069 7320 6e6f 7420 4e6f 6e65  mber is not None
+0000c8f0: 2c20 6c61 6d62 6461 3a20 6622 4578 7065  , lambda: f"Expe
+0000c900: 6374 6564 2065 6163 6820 6e6f 6465 2074  cted each node t
+0000c910: 6f20 6265 206e 756d 6265 7265 642c 2062  o be numbered, b
+0000c920: 7574 207b 6e7d 2077 6173 206e 6f74 2229  ut {n} was not")
+0000c930: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000c940: 2020 6966 206e 2e6e 756d 6265 7220 3c20    if n.number < 
+0000c950: 6d69 6e5f 6e75 6d62 6572 3a0a 2020 2020  min_number:.    
+0000c960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c970: 6d69 6e5f 6964 7820 3d20 6964 780a 2020  min_idx = idx.  
+0000c980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c990: 2020 6d69 6e5f 6e75 6d62 6572 203d 206e    min_number = n
+0000c9a0: 2e6e 756d 6265 720a 0a20 2020 2020 2020  .number..       
+0000c9b0: 2020 2020 2072 6574 7572 6e20 6d69 6e5f       return min_
+0000c9c0: 6964 780a 0a20 2020 2020 2020 2073 6f72  idx..        sor
+0000c9d0: 7465 645f 6273 796d 7320 3d20 746f 706f  ted_bsyms = topo
+0000c9e0: 736f 7274 5f62 7379 6d5f 6461 6728 6c65  sort_bsym_dag(le
+0000c9f0: 6176 6573 2c20 746f 706f 736f 7274 5f6f  aves, toposort_o
+0000ca00: 7264 6572 3d54 4f50 4f53 4f52 545f 4f52  rder=TOPOSORT_OR
+0000ca10: 4445 522e 424f 5454 4f4d 5f55 502c 2073  DER.BOTTOM_UP, s
+0000ca20: 656c 6563 746f 723d 5f73 656c 6563 746f  elector=_selecto
+0000ca30: 7229 0a20 2020 2020 2020 2067 7261 6474  r).        gradt
+0000ca40: 7263 2e62 6f75 6e64 5f73 796d 626f 6c73  rc.bound_symbols
+0000ca50: 203d 2073 6f72 7465 645f 6273 796d 730a   = sorted_bsyms.
+0000ca60: 2020 2020 2020 2020 6772 6164 7472 6320          gradtrc 
+0000ca70: 3d20 6463 6528 6772 6164 7472 6329 0a0a  = dce(gradtrc)..
+0000ca80: 2020 2020 2020 2020 2320 544f 444f 2043          # TODO C
+0000ca90: 6f6e 7369 6465 7220 686f 7720 746f 2068  onsider how to h
+0000caa0: 616e 646c 6520 6772 6164 2077 2e72 2e74  andle grad w.r.t
+0000cab0: 2e20 6f6e 6c79 2073 6f6d 6520 6f75 7470  . only some outp
+0000cac0: 7574 7320 2d2d 2073 686f 756c 6420 616c  uts -- should al
+0000cad0: 6c20 6772 6164 0a20 2020 2020 2020 2023  l grad.        #
+0000cae0: 2020 206f 7065 7261 7469 6f6e 7320 7573     operations us
+0000caf0: 696e 6720 7468 6520 6f74 6865 7220 6f75  ing the other ou
+0000cb00: 7470 7574 2062 6520 7265 6d6f 7665 643f  tput be removed?
+0000cb10: 2057 6861 7420 6b69 6e64 206f 6620 6173   What kind of as
+0000cb20: 7375 6d70 7469 6f6e 2064 6f65 7320 7468  sumption does th
+0000cb30: 6174 0a20 2020 2020 2020 2023 2020 206d  at.        #   m
+0000cb40: 616b 6520 6162 6f75 7420 7468 6520 6772  ake about the gr
+0000cb50: 6164 2073 7472 7563 7475 7265 3f20 5072  ad structure? Pr
+0000cb60: 6f62 6162 6c79 2073 6f6d 6520 6b69 6e64  obably some kind
+0000cb70: 206f 6620 696e 6465 7065 6e64 656e 6365   of independence
+0000cb80: 2061 7373 756d 7074 696f 6e3f 2041 7265   assumption? Are
+0000cb90: 0a20 2020 2020 2020 2023 2020 2074 6865  .        #   the
+0000cba0: 7265 2070 7261 6374 6963 616c 2065 7861  re practical exa
+0000cbb0: 6d70 6c65 7320 7768 6572 6520 7468 6174  mples where that
+0000cbc0: 2773 2061 6e20 6973 7375 653f 0a0a 2020  's an issue?..  
+0000cbd0: 2020 2020 2020 656e 645f 7469 6d65 5f6e        end_time_n
+0000cbe0: 7320 3d20 7469 6d65 2e74 696d 655f 6e73  s = time.time_ns
+0000cbf0: 2829 0a20 2020 2020 2020 2065 6c61 7073  ().        elaps
+0000cc00: 6564 5f74 696d 655f 6e73 203d 2065 6e64  ed_time_ns = end
+0000cc10: 5f74 696d 655f 6e73 202d 2073 7461 7274  _time_ns - start
+0000cc20: 5f74 696d 655f 6e73 0a20 2020 2020 2020  _time_ns.       
+0000cc30: 2065 6c61 7073 6564 5f74 696d 655f 6d69   elapsed_time_mi
+0000cc40: 6c6c 6973 203d 2065 6c61 7073 6564 5f74  llis = elapsed_t
+0000cc50: 696d 655f 6e73 202f 2f20 3130 3030 3030  ime_ns // 100000
+0000cc60: 300a 2020 2020 2020 2020 6772 6164 7472  0.        gradtr
+0000cc70: 632e 7365 745f 7072 6f76 656e 616e 6365  c.set_provenance
+0000cc80: 2854 7261 6365 5072 6f76 656e 616e 6365  (TraceProvenance
+0000cc90: 2866 2247 7261 6420 2874 6f6f 6b20 7b65  (f"Grad (took {e
+0000cca0: 6c61 7073 6564 5f74 696d 655f 6d69 6c6c  lapsed_time_mill
+0000ccb0: 6973 7d20 6d69 6c6c 6973 6563 6f6e 6473  is} milliseconds
+0000ccc0: 2922 2929 0a0a 2020 2020 2020 2020 7265  )"))..        re
+0000ccd0: 7475 726e 2067 7261 6474 7263 0a0a 2020  turn gradtrc..  
+0000cce0: 2020 2320 4e4f 5445 2054 6869 7320 6973    # NOTE This is
+0000ccf0: 2061 206b 6c75 6467 6520 746f 2069 6e64   a kludge to ind
+0000cd00: 6963 6174 6520 7468 6174 2077 6520 7368  icate that we sh
+0000cd10: 6f75 6c64 6e27 7420 7573 6520 5079 546f  ouldn't use PyTo
+0000cd20: 7263 6827 7320 6175 746f 6772 6164 2062  rch's autograd b
+0000cd30: 6563 6175 7365 0a20 2020 2023 2020 2077  ecause.    #   w
+0000cd40: 6527 7265 2075 7369 6e67 206f 7572 206f  e're using our o
+0000cd50: 776e 2061 7574 6f67 7261 6420 7472 616e  wn autograd tran
+0000cd60: 7366 6f72 6d0a 2020 2020 6366 6e2e 5f75  sform.    cfn._u
+0000cd70: 7369 6e67 5f67 7261 645f 7472 616e 7366  sing_grad_transf
+0000cd80: 6f72 6d20 3d20 5472 7565 0a0a 2020 2020  orm = True..    
+0000cd90: 7265 7475 726e 2061 6464 5f74 7261 6e73  return add_trans
+0000cda0: 666f 726d 2863 666e 2c20 5f67 7261 645f  form(cfn, _grad_
+0000cdb0: 7472 616e 7366 6f72 6d29 0a0a 0a64 6566  transform)...def
+0000cdc0: 2067 7261 645f 7631 280a 2020 2020 6366   grad_v1(.    cf
+0000cdd0: 6e2c 0a29 202d 3e20 4361 6c6c 6162 6c65  n,.) -> Callable
+0000cde0: 3a0a 2020 2020 6465 6620 6772 6164 2866  :.    def grad(f
+0000cdf0: 756e 6329 3a0a 2020 2020 2020 2020 6465  unc):.        de
+0000ce00: 6620 6772 6164 5f66 756e 6328 2a61 7267  f grad_func(*arg
+0000ce10: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
+0000ce20: 2020 2020 2020 2020 2020 5f2c 2067 7261            _, gra
+0000ce30: 6473 203d 2076 616c 7565 5f61 6e64 5f67  ds = value_and_g
+0000ce40: 7261 6428 6675 6e63 2928 2a61 7267 732c  rad(func)(*args,
+0000ce50: 202a 2a6b 7761 7267 7329 0a20 2020 2020   **kwargs).     
+0000ce60: 2020 2020 2020 2067 7261 6473 203d 205b         grads = [
+0000ce70: 6720 666f 7220 6720 696e 2067 7261 6473  g for g in grads
+0000ce80: 2069 6620 6720 6973 206e 6f74 204e 6f6e   if g is not Non
+0000ce90: 655d 0a20 2020 2020 2020 2020 2020 2072  e].            r
+0000cea0: 6574 7572 6e20 6772 6164 730a 0a20 2020  eturn grads..   
+0000ceb0: 2020 2020 2072 6574 7572 6e20 6772 6164       return grad
+0000cec0: 5f66 756e 630a 0a20 2020 2064 6566 205f  _func..    def _
+0000ced0: 6772 6164 5f74 7261 6e73 666f 726d 2874  grad_transform(t
+0000cee0: 7263 3a20 5472 6163 652c 202a 2c20 6578  rc: Trace, *, ex
+0000cef0: 6563 7574 6f72 735f 6c69 7374 3a20 5365  ecutors_list: Se
+0000cf00: 7175 656e 6365 5b41 6e79 5d29 202d 3e20  quence[Any]) -> 
+0000cf10: 5472 6163 653a 0a20 2020 2020 2020 2067  Trace:.        g
+0000cf20: 7261 6474 7263 203d 2063 6f6e 7374 7275  radtrc = constru
+0000cf30: 6374 5f74 7261 6365 2829 2867 7261 6428  ct_trace()(grad(
+0000cf40: 7472 632e 7079 7468 6f6e 5f63 616c 6c61  trc.python_calla
+0000cf50: 626c 6528 2929 2c20 2a74 7263 2e61 7267  ble()), *trc.arg
+0000cf60: 732c 202a 2a74 7263 2e6b 7761 7267 7329  s, **trc.kwargs)
+0000cf70: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000cf80: 6772 6164 7472 630a 0a20 2020 2063 666e  gradtrc..    cfn
+0000cf90: 2e5f 7573 696e 675f 6772 6164 5f74 7261  ._using_grad_tra
+0000cfa0: 6e73 666f 726d 203d 2054 7275 650a 2020  nsform = True.  
+0000cfb0: 2020 7265 7475 726e 2061 6464 5f74 7261    return add_tra
+0000cfc0: 6e73 666f 726d 2863 666e 2c20 5f67 7261  nsform(cfn, _gra
+0000cfd0: 645f 7472 616e 7366 6f72 6d29 0a0a 0a63  d_transform)...c
+0000cfe0: 6c61 7373 2054 7261 6e73 666f 726d 7328  lass Transforms(
+0000cff0: 456e 756d 293a 0a20 2020 2049 6465 6e74  Enum):.    Ident
+0000d000: 6974 794f 7020 3d20 6175 746f 2829 0a20  ityOp = auto(). 
+0000d010: 2020 2056 6d61 704f 7020 3d20 6175 746f     VmapOp = auto
+0000d020: 2829 0a20 2020 204a 7670 4f70 203d 2061  ().    JvpOp = a
+0000d030: 7574 6f28 290a 2020 2020 566a 704f 7020  uto().    VjpOp 
+0000d040: 3d20 6175 746f 2829 0a0a 0a40 6c72 755f  = auto()...@lru_
+0000d050: 6361 6368 6528 6d61 7873 697a 653d 4e6f  cache(maxsize=No
+0000d060: 6e65 290a 6465 6620 7379 6d62 6f6c 5f74  ne).def symbol_t
+0000d070: 6f5f 6576 616c 2862 6f75 6e64 5f73 796d  o_eval(bound_sym
+0000d080: 626f 6c29 3a0a 2020 2020 2222 224d 6170  bol):.    """Map
+0000d090: 2061 2042 6f75 6e64 5379 6d62 6f6c 2074   a BoundSymbol t
+0000d0a0: 6f20 6120 6675 6e63 7469 6f6e 2074 6861  o a function tha
+0000d0b0: 7420 6576 616c 7561 7465 7320 6974 2e0a  t evaluates it..
+0000d0c0: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+0000d0d0: 2020 2062 6f75 6e64 5f73 796d 626f 6c3a     bound_symbol:
+0000d0e0: 2042 6f75 6e64 5379 6d62 6f6c 2074 6f20   BoundSymbol to 
+0000d0f0: 6d61 700a 2020 2020 2222 220a 2020 2020  map.    """.    
+0000d100: 2320 5379 6d62 6f6c 2069 7320 6361 6c6c  # Symbol is call
+0000d110: 6162 6c65 0a20 2020 2072 6574 7572 6e20  able.    return 
+0000d120: 626f 756e 645f 7379 6d62 6f6c 2e73 796d  bound_symbol.sym
+0000d130: 0a0a 0a23 2054 4f44 4f3a 2043 7572 7265  ...# TODO: Curre
+0000d140: 6e74 6c79 2077 6520 7573 6520 7472 6163  ntly we use trac
+0000d150: 652e 6172 6773 2061 6e64 2074 7261 6365  e.args and trace
+0000d160: 2e6b 7761 7267 7320 746f 2067 6574 2074  .kwargs to get t
+0000d170: 6865 2061 7267 756d 656e 7473 0a23 204d  he arguments.# M
+0000d180: 6179 6265 2077 6520 7368 6f75 6c64 2075  aybe we should u
+0000d190: 7365 2074 6865 7365 2069 6e73 7465 6164  se these instead
+0000d1a0: 0a74 7261 6e73 666f 726d 5f73 6b69 705f  .transform_skip_
+0000d1b0: 6c69 7374 203d 2028 0a20 2020 2070 7269  list = (.    pri
+0000d1c0: 6d73 2e50 7269 6d49 4473 2e55 4e50 4143  ms.PrimIDs.UNPAC
+0000d1d0: 4b5f 454d 5054 595f 4449 4354 2c0a 2020  K_EMPTY_DICT,.  
+0000d1e0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+0000d1f0: 554e 5041 434b 5f4b 4559 2c0a 2020 2020  UNPACK_KEY,.    
+0000d200: 7072 696d 732e 5072 696d 4944 732e 554e  prims.PrimIDs.UN
+0000d210: 5041 434b 5f53 4551 5545 4e43 452c 0a20  PACK_SEQUENCE,. 
+0000d220: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+0000d230: 2e55 4e50 4143 4b5f 5452 4956 4941 4c2c  .UNPACK_TRIVIAL,
+0000d240: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+0000d250: 4473 2e52 4554 5552 4e2c 0a29 0a0a 0a64  Ds.RETURN,.)...d
+0000d260: 6566 2065 7661 6c5f 7472 6163 6528 7472  ef eval_trace(tr
+0000d270: 6163 652c 202a 6172 6773 2c20 7379 6d62  ace, *args, symb
+0000d280: 6f6c 5f6d 6170 7065 723d 7379 6d62 6f6c  ol_mapper=symbol
+0000d290: 5f74 6f5f 6576 616c 2c20 7769 7468 5f65  _to_eval, with_e
+0000d2a0: 6e76 3d46 616c 7365 2c20 2a2a 6b77 6172  nv=False, **kwar
+0000d2b0: 6773 293a 0a20 2020 2022 2222 4576 616c  gs):.    """Eval
+0000d2c0: 7561 7465 2061 2074 7261 6365 2e0a 0a20  uate a trace... 
+0000d2d0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0000d2e0: 2074 7261 6365 3a20 7472 6163 6520 746f   trace: trace to
+0000d2f0: 2065 7661 6c75 6174 650a 2020 2020 2020   evaluate.      
+0000d300: 2020 2a61 7267 733a 2061 7267 756d 656e    *args: argumen
+0000d310: 7473 2074 6f20 6576 616c 7561 7465 2074  ts to evaluate t
+0000d320: 6865 2074 7261 6365 2077 6974 680a 2020  he trace with.  
+0000d330: 2020 2020 2020 7379 6d62 6f6c 5f6d 6170        symbol_map
+0000d340: 7065 723a 2066 756e 6374 696f 6e20 7468  per: function th
+0000d350: 6174 206d 6170 7320 6120 7379 6d62 6f6c  at maps a symbol
+0000d360: 2074 6f20 6120 6675 6e63 7469 6f6e 2074   to a function t
+0000d370: 6861 7420 6576 616c 7561 7465 7320 6974  hat evaluates it
+0000d380: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+0000d390: 733a 206b 6579 776f 7264 2061 7267 756d  s: keyword argum
+0000d3a0: 656e 7473 2074 6f20 6576 616c 7561 7465  ents to evaluate
+0000d3b0: 2074 6865 2074 7261 6365 2077 6974 680a   the trace with.
+0000d3c0: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+0000d3d0: 2020 2020 2020 7265 7375 6c74 206f 6620        result of 
+0000d3e0: 6576 616c 7561 7469 6e67 2074 6865 2074  evaluating the t
+0000d3f0: 7261 6365 0a20 2020 2022 2222 0a20 2020  race.    """.   
+0000d400: 2065 6e76 203d 207b 7d0a 0a20 2020 2064   env = {}..    d
+0000d410: 6566 2072 6561 6428 783a 2056 6172 6961  ef read(x: Varia
+0000d420: 626c 6529 3a0a 2020 2020 2020 2020 6966  ble):.        if
+0000d430: 2069 7369 6e73 7461 6e63 6528 782c 2056   isinstance(x, V
+0000d440: 6172 6961 626c 6529 3a0a 2020 2020 2020  ariable):.      
+0000d450: 2020 2020 2020 7265 7475 726e 2065 6e76        return env
+0000d460: 5b78 2e6e 616d 655d 0a20 2020 2020 2020  [x.name].       
+0000d470: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000d480: 2020 2072 6574 7572 6e20 780a 0a20 2020     return x..   
+0000d490: 2064 6566 2077 7269 7465 2876 3a20 5661   def write(v: Va
+0000d4a0: 7269 6162 6c65 2c20 7661 6c3a 2041 6e79  riable, val: Any
+0000d4b0: 2c20 616c 6c6f 775f 6475 706c 6963 6174  , allow_duplicat
+0000d4c0: 6573 3d46 616c 7365 2920 2d3e 204e 6f6e  es=False) -> Non
+0000d4d0: 653a 0a20 2020 2020 2020 2069 6620 6e6f  e:.        if no
+0000d4e0: 7420 6973 696e 7374 616e 6365 2876 2c20  t isinstance(v, 
+0000d4f0: 5661 7269 6162 6c65 293a 0a20 2020 2020  Variable):.     
+0000d500: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+0000d510: 2020 2020 2020 2320 4475 706c 6963 6174        # Duplicat
+0000d520: 6573 2061 7265 2061 6c6c 6f77 6564 2061  es are allowed a
+0000d530: 6e64 206f 7665 7277 7269 7474 656e 0a20  nd overwritten. 
+0000d540: 2020 2020 2020 2069 6620 762e 6e61 6d65         if v.name
+0000d550: 2069 6e20 656e 763a 0a20 2020 2020 2020   in env:.       
+0000d560: 2020 2020 2069 6620 616c 6c6f 775f 6475       if allow_du
+0000d570: 706c 6963 6174 6573 3a0a 2020 2020 2020  plicates:.      
+0000d580: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000d590: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000d5a0: 7365 2056 616c 7565 4572 726f 7228 6622  se ValueError(f"
+0000d5b0: 5661 7269 6162 6c65 207b 762e 6e61 6d65  Variable {v.name
+0000d5c0: 7d20 6973 2062 6569 6e67 206f 7665 7277  } is being overw
+0000d5d0: 7269 7474 656e 2074 6869 7320 6973 206e  ritten this is n
+0000d5e0: 6f74 2061 6c6c 6f77 6564 2229 0a20 2020  ot allowed").   
+0000d5f0: 2020 2020 2065 6e76 5b76 2e6e 616d 655d       env[v.name]
+0000d600: 203d 2076 616c 0a0a 2020 2020 7361 6665   = val..    safe
+0000d610: 5f6d 6170 5f66 6c61 7428 7772 6974 652c  _map_flat(write,
+0000d620: 206c 6973 7428 7472 6163 652e 6172 6773   list(trace.args
+0000d630: 292c 206c 6973 7428 6172 6773 2929 0a20  ), list(args)). 
+0000d640: 2020 2073 6166 655f 6d61 705f 666c 6174     safe_map_flat
+0000d650: 2877 7269 7465 2c20 6c69 7374 2874 7261  (write, list(tra
+0000d660: 6365 2e6b 7761 7267 732e 7661 6c75 6573  ce.kwargs.values
+0000d670: 2829 292c 206c 6973 7428 6b77 6172 6773  ()), list(kwargs
+0000d680: 2e76 616c 7565 7328 2929 290a 0a20 2020  .values()))..   
+0000d690: 2066 6f72 2073 796d 626f 6c20 696e 2074   for symbol in t
+0000d6a0: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
+0000d6b0: 6c73 3a0a 2020 2020 2020 2020 6966 2073  ls:.        if s
+0000d6c0: 796d 626f 6c2e 7379 6d2e 6964 2069 6e20  ymbol.sym.id in 
+0000d6d0: 7472 616e 7366 6f72 6d5f 736b 6970 5f6c  transform_skip_l
+0000d6e0: 6973 743a 0a20 2020 2020 2020 2020 2020  ist:.           
+0000d6f0: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
+0000d700: 2020 6172 6773 203d 2074 7265 655f 6d61    args = tree_ma
+0000d710: 7028 7265 6164 2c20 7379 6d62 6f6c 2e61  p(read, symbol.a
+0000d720: 7267 7329 0a20 2020 2020 2020 206b 7761  rgs).        kwa
+0000d730: 7267 7320 3d20 7472 6565 5f6d 6170 2872  rgs = tree_map(r
+0000d740: 6561 642c 2073 796d 626f 6c2e 6b77 6172  ead, symbol.kwar
+0000d750: 6773 290a 2020 2020 2020 2020 7072 696d  gs).        prim
+0000d760: 5f66 756e 6320 3d20 7379 6d62 6f6c 5f6d  _func = symbol_m
+0000d770: 6170 7065 7228 7379 6d62 6f6c 290a 2020  apper(symbol).  
+0000d780: 2020 2020 2020 6966 2070 7269 6d5f 6675        if prim_fu
+0000d790: 6e63 2069 7320 4e6f 6e65 3a0a 2020 2020  nc is None:.    
+0000d7a0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+0000d7b0: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
+0000d7c0: 3d20 7072 696d 5f66 756e 6328 2a61 7267  = prim_func(*arg
+0000d7d0: 732c 202a 2a6b 7761 7267 7329 0a20 2020  s, **kwargs).   
+0000d7e0: 2020 2020 2073 6166 655f 6d61 705f 666c       safe_map_fl
+0000d7f0: 6174 2877 7269 7465 2c20 6c69 7374 2873  at(write, list(s
+0000d800: 6571 7565 6e63 6966 7928 7379 6d62 6f6c  equencify(symbol
+0000d810: 2e6f 7574 7075 7429 292c 206c 6973 7428  .output)), list(
+0000d820: 7365 7175 656e 6369 6679 2872 6573 756c  sequencify(resul
+0000d830: 7429 2929 0a0a 2020 2020 6966 2077 6974  t)))..    if wit
+0000d840: 685f 656e 763a 0a20 2020 2020 2020 2072  h_env:.        r
+0000d850: 6574 7572 6e20 7472 6565 5f6d 6170 2872  eturn tree_map(r
+0000d860: 6561 642c 2074 7261 6365 2e6f 7574 7075  ead, trace.outpu
+0000d870: 7429 2c20 656e 760a 0a20 2020 2072 6574  t), env..    ret
+0000d880: 7572 6e20 7472 6565 5f6d 6170 2872 6561  urn tree_map(rea
+0000d890: 642c 2074 7261 6365 2e6f 7574 7075 7429  d, trace.output)
+0000d8a0: 0a0a 0a64 6566 205f 6964 656e 7469 7479  ...def _identity
+0000d8b0: 5f63 616c 6c5f 6d65 7461 6675 6e63 282a  _call_metafunc(*
+0000d8c0: 6172 6773 2c20 7472 6163 653a 2054 7261  args, trace: Tra
+0000d8d0: 6365 2c20 2a2a 6b77 6172 6773 293a 0a20  ce, **kwargs):. 
+0000d8e0: 2020 2077 6974 6820 6465 7461 6368 6564     with detached
+0000d8f0: 5f74 7261 6365 2829 3a0a 2020 2020 2020  _trace():.      
+0000d900: 2020 7265 7475 726e 2065 7661 6c5f 7472    return eval_tr
+0000d910: 6163 6528 7472 6163 652c 202a 6172 6773  ace(trace, *args
+0000d920: 2c20 2a2a 6b77 6172 6773 290a 0a0a 6964  , **kwargs)...id
+0000d930: 656e 7469 7479 5f63 616c 6c20 3d20 5379  entity_call = Sy
+0000d940: 6d62 6f6c 2869 643d 5472 616e 7366 6f72  mbol(id=Transfor
+0000d950: 6d73 2e49 6465 6e74 6974 794f 702c 206e  ms.IdentityOp, n
+0000d960: 616d 653d 2269 6465 6e74 6974 795f 6361  ame="identity_ca
+0000d970: 6c6c 222c 206d 6574 613d 5f69 6465 6e74  ll", meta=_ident
+0000d980: 6974 795f 6361 6c6c 5f6d 6574 6166 756e  ity_call_metafun
+0000d990: 6329 0a0a 0a64 6566 2069 6465 6e74 6974  c)...def identit
+0000d9a0: 7928 6675 6e63 293a 0a20 2020 2022 2222  y(func):.    """
+0000d9b0: 4964 656e 7469 7479 2074 7261 6e73 666f  Identity transfo
+0000d9c0: 726d 2066 6f72 2061 2054 6875 6e64 6572  rm for a Thunder
+0000d9d0: 2066 756e 6374 696f 6e2e 0a0a 2020 2020   function...    
+0000d9e0: 4172 6773 3a0a 2020 2020 2020 2020 6675  Args:.        fu
+0000d9f0: 6e63 2028 4361 6c6c 6162 6c65 293a 2041  nc (Callable): A
+0000da00: 2054 6875 6e64 6572 2066 756e 6374 696f   Thunder functio
+0000da10: 6e20 746f 2062 6520 7472 616e 7366 6f72  n to be transfor
+0000da20: 6d65 642e 0a20 2020 2022 2222 0a0a 2020  med..    """..  
+0000da30: 2020 6465 6620 7772 6170 7065 7228 2a61    def wrapper(*a
+0000da40: 7267 732c 202a 2a6b 7761 7267 7329 3a0a  rgs, **kwargs):.
+0000da50: 2020 2020 2020 2020 7472 6163 6520 3d20          trace = 
+0000da60: 636f 6e73 7472 7563 745f 7472 6163 6528  construct_trace(
+0000da70: 2928 6675 6e63 2c20 2a61 7267 732c 202a  )(func, *args, *
+0000da80: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
+0000da90: 2072 6574 7572 6e20 6964 656e 7469 7479   return identity
+0000daa0: 5f63 616c 6c28 2a61 7267 732c 202a 2a6b  _call(*args, **k
+0000dab0: 7761 7267 732c 2074 7261 6365 3d74 7261  wargs, trace=tra
+0000dac0: 6365 290a 0a20 2020 2072 6574 7572 6e20  ce)..    return 
+0000dad0: 7772 6170 7065 720a 0a0a 6465 6620 5f69  wrapper...def _i
+0000dae0: 6465 6e74 6974 795f 6361 6c6c 5f70 7974  dentity_call_pyt
+0000daf0: 6f72 6368 282a 6172 6773 2c20 7472 6163  orch(*args, trac
+0000db00: 653a 2054 7261 6365 2c20 2a2a 6b77 6172  e: Trace, **kwar
+0000db10: 6773 293a 0a20 2020 2069 6d70 6f72 7420  gs):.    import 
+0000db20: 746f 7263 680a 0a20 2020 2064 6566 2073  torch..    def s
+0000db30: 796d 626f 6c5f 6d61 7070 6572 286f 7029  ymbol_mapper(op)
+0000db40: 3a0a 2020 2020 2020 2020 6966 206f 702e  :.        if op.
+0000db50: 6f70 203d 3d20 5472 616e 7366 6f72 6d73  op == Transforms
+0000db60: 2e49 6465 6e74 6974 794f 703a 0a20 2020  .IdentityOp:.   
+0000db70: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000db80: 5f69 6465 6e74 6974 795f 6361 6c6c 5f70  _identity_call_p
+0000db90: 7974 6f72 6368 0a0a 2020 2020 2020 2020  ytorch..        
+0000dba0: 746f 7263 685f 6f70 203d 206f 7073 5f74  torch_op = ops_t
+0000dbb0: 6f5f 746f 7263 685f 6f70 735f 6d61 705b  o_torch_ops_map[
+0000dbc0: 6f70 2e6f 705d 0a20 2020 2020 2020 2069  op.op].        i
+0000dbd0: 6620 6973 696e 7374 616e 6365 2874 6f72  f isinstance(tor
+0000dbe0: 6368 5f6f 702c 2073 7472 293a 0a20 2020  ch_op, str):.   
+0000dbf0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000dc00: 6765 7461 7474 7228 746f 7263 682c 2074  getattr(torch, t
+0000dc10: 6f72 6368 5f6f 702e 7374 7269 7028 2270  orch_op.strip("p
+0000dc20: 7974 6f72 6368 2e22 2929 0a20 2020 2020  ytorch.")).     
+0000dc30: 2020 2072 6574 7572 6e20 746f 7263 685f     return torch_
+0000dc40: 6f70 0a0a 2020 2020 7769 7468 2064 6574  op..    with det
+0000dc50: 6163 6865 645f 7472 6163 6528 293a 0a20  ached_trace():. 
+0000dc60: 2020 2020 2020 2072 6574 7572 6e20 6576         return ev
+0000dc70: 616c 5f74 7261 6365 2874 7261 6365 2c20  al_trace(trace, 
+0000dc80: 2a61 7267 732c 202a 2a6b 7761 7267 732c  *args, **kwargs,
+0000dc90: 2073 796d 626f 6c5f 6d61 7070 6572 3d73   symbol_mapper=s
+0000dca0: 796d 626f 6c5f 6d61 7070 6572 290a 0a0a  ymbol_mapper)...
+0000dcb0: 2320 5265 6769 7374 6572 2074 6865 2069  # Register the i
+0000dcc0: 6465 6e74 6974 7920 6361 6c6c 2066 6f72  dentity call for
+0000dcd0: 2050 7954 6f72 6368 2065 7865 6375 746f   PyTorch executo
+0000dce0: 722e 0a23 206f 7073 5f74 6f5f 746f 7263  r..# ops_to_torc
+0000dcf0: 685f 6f70 735f 6d61 705b 5472 616e 7366  h_ops_map[Transf
+0000dd00: 6f72 6d73 2e49 6465 6e74 6974 794f 705d  orms.IdentityOp]
+0000dd10: 203d 205f 6964 656e 7469 7479 5f63 616c   = _identity_cal
+0000dd20: 6c5f 7079 746f 7263 680a 0a0a 2320 564d  l_pytorch...# VM
+0000dd30: 4150 2074 7261 6e73 666f 726d 0a23 202d  AP transform.# -
+0000dd40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a 0a63  ------------...c
+0000dd50: 6c61 7373 204e 6f74 4d61 7070 6564 3a0a  lass NotMapped:.
+0000dd60: 2020 2020 2222 2252 6570 7265 7365 6e74      """Represent
+0000dd70: 7320 6120 6e6f 6e2d 6261 7463 6865 6420  s a non-batched 
+0000dd80: 6469 6d65 6e73 696f 6e2e 2222 220a 0a20  dimension.""".. 
+0000dd90: 2020 2064 6566 205f 5f72 6570 725f 5f28     def __repr__(
+0000dda0: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
+0000ddb0: 6574 7572 6e20 226e 6f74 5f6d 6170 7065  eturn "not_mappe
+0000ddc0: 6422 0a0a 0a40 6461 7461 636c 6173 7328  d"...@dataclass(
+0000ddd0: 6672 6f7a 656e 3d54 7275 6529 0a63 6c61  frozen=True).cla
+0000dde0: 7373 2042 6174 6368 6564 5661 6c75 653a  ss BatchedValue:
+0000ddf0: 0a20 2020 2022 2222 4261 7463 6865 6420  .    """Batched 
+0000de00: 7661 6c75 6520 666f 7220 7468 6520 766d  value for the vm
+0000de10: 6170 2074 7261 6e73 666f 726d 2e0a 0a20  ap transform... 
+0000de20: 2020 2041 7474 7269 6275 7465 733a 0a20     Attributes:. 
+0000de30: 2020 2020 2020 2076 616c 7565 3a20 4261         value: Ba
+0000de40: 7463 6865 6420 7661 6c75 652e 0a20 2020  tched value..   
+0000de50: 2020 2020 2062 6174 6368 5f64 696d 3a20       batch_dim: 
+0000de60: 4261 7463 6869 6e67 2064 696d 656e 7369  Batching dimensi
+0000de70: 6f6e 206f 7220 6e6f 745f 6d61 7070 6564  on or not_mapped
+0000de80: 0a20 2020 2022 2222 0a0a 2020 2020 7661  .    """..    va
+0000de90: 6c75 653a 2041 6e79 0a20 2020 2062 6174  lue: Any.    bat
+0000dea0: 6368 5f64 696d 3a20 696e 7420 7c20 4e6f  ch_dim: int | No
+0000deb0: 744d 6170 7065 640a 0a20 2020 2064 6566  tMapped..    def
+0000dec0: 205f 5f69 7465 725f 5f28 7365 6c66 293a   __iter__(self):
+0000ded0: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
+0000dee0: 656c 662e 7661 6c75 650a 2020 2020 2020  elf.value.      
+0000def0: 2020 7969 656c 6420 7365 6c66 2e62 6174    yield self.bat
+0000df00: 6368 5f64 696d 0a0a 0a64 6566 2070 6169  ch_dim...def pai
+0000df10: 725f 746f 5f62 6174 6368 6564 5f76 616c  r_to_batched_val
+0000df20: 7565 2870 6169 7229 3a0a 2020 2020 2222  ue(pair):.    ""
+0000df30: 2243 6f6e 7665 7274 7320 6120 7061 6972  "Converts a pair
+0000df40: 2074 6f20 6120 4261 7463 6865 6456 616c   to a BatchedVal
+0000df50: 7565 2e0a 0a20 2020 2041 7267 733a 0a20  ue...    Args:. 
+0000df60: 2020 2020 2020 2070 6169 7220 2853 6571         pair (Seq
+0000df70: 7565 6e63 6529 3a20 5061 6972 2074 6f20  uence): Pair to 
+0000df80: 636f 6e76 6572 742e 0a0a 2020 2020 5265  convert...    Re
+0000df90: 7475 726e 733a 0a20 2020 2020 2020 2042  turns:.        B
+0000dfa0: 6174 6368 6564 5661 6c75 653a 2042 6174  atchedValue: Bat
+0000dfb0: 6368 6564 5661 6c75 6520 7265 7072 6573  chedValue repres
+0000dfc0: 656e 7461 7469 6f6e 206f 6620 7468 6520  entation of the 
+0000dfd0: 7061 6972 2e0a 2020 2020 2222 220a 2020  pair..    """.  
+0000dfe0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0000dff0: 7061 6972 2c20 4261 7463 6865 6456 616c  pair, BatchedVal
+0000e000: 7565 293a 0a20 2020 2020 2020 2072 6574  ue):.        ret
+0000e010: 7572 6e20 7061 6972 0a20 2020 2065 6c73  urn pair.    els
+0000e020: 653a 0a20 2020 2020 2020 2061 7373 6572  e:.        asser
+0000e030: 7420 6973 696e 7374 616e 6365 2870 6169  t isinstance(pai
+0000e040: 722c 2053 6571 7565 6e63 6529 2061 6e64  r, Sequence) and
+0000e050: 206c 656e 2870 6169 7229 203d 3d20 320a   len(pair) == 2.
+0000e060: 2020 2020 2020 2020 7265 7475 726e 2042          return B
+0000e070: 6174 6368 6564 5661 6c75 6528 2a70 6169  atchedValue(*pai
+0000e080: 7229 0a0a 0a64 6566 2076 6563 746f 7269  r)...def vectori
+0000e090: 7a65 645f 6261 7463 6865 7228 7072 696d  zed_batcher(prim
+0000e0a0: 2c20 6178 6973 5f73 697a 652c 2062 6174  , axis_size, bat
+0000e0b0: 6368 6564 5f76 616c 7565 732c 202a 2a6b  ched_values, **k
+0000e0c0: 7761 7267 7329 3a0a 2020 2020 6261 7463  wargs):.    batc
+0000e0d0: 685f 6469 6d20 3d20 6261 7463 6865 645f  h_dim = batched_
+0000e0e0: 7661 6c75 6573 5b30 5d2e 6261 7463 685f  values[0].batch_
+0000e0f0: 6469 6d0a 2020 2020 6173 7365 7274 2061  dim.    assert a
+0000e100: 6c6c 280a 2020 2020 2020 2020 6261 7463  ll(.        batc
+0000e110: 685f 6469 6d20 3d3d 2062 762e 6261 7463  h_dim == bv.batc
+0000e120: 685f 6469 6d20 666f 7220 6276 2069 6e20  h_dim for bv in 
+0000e130: 6261 7463 6865 645f 7661 6c75 6573 5b31  batched_values[1
+0000e140: 3a5d 0a20 2020 2029 2c20 6622 6076 6563  :].    ), f"`vec
+0000e150: 746f 7269 7a65 645f 6261 7463 6865 7260  torized_batcher`
+0000e160: 2067 6f74 2064 6966 6665 7265 6e74 2062   got different b
+0000e170: 6174 6368 6564 2064 696d 656e 7369 6f6e  atched dimension
+0000e180: 7320 7b5b 6276 2e62 6174 6368 5f64 696d  s {[bv.batch_dim
+0000e190: 2066 6f72 2062 7620 696e 2062 6174 6368   for bv in batch
+0000e1a0: 6564 5f76 616c 7565 735d 7d22 0a20 2020  ed_values]}".   
+0000e1b0: 2072 6574 7572 6e20 4261 7463 6865 6456   return BatchedV
+0000e1c0: 616c 7565 2870 7269 6d28 2a5b 6276 2e76  alue(prim(*[bv.v
+0000e1d0: 616c 7565 2066 6f72 2062 7620 696e 2062  alue for bv in b
+0000e1e0: 6174 6368 6564 5f76 616c 7565 735d 2c20  atched_values], 
+0000e1f0: 2a2a 6b77 6172 6773 292c 2062 6174 6368  **kwargs), batch
+0000e200: 5f64 696d 290a 0a0a 6e6f 745f 6d61 7070  _dim)...not_mapp
+0000e210: 6564 203d 204e 6f74 4d61 7070 6564 2829  ed = NotMapped()
+0000e220: 0a0a 0a64 6566 206d 6f76 6564 696d 2878  ...def movedim(x
+0000e230: 2c20 7372 633a 2069 6e74 2c20 6473 743a  , src: int, dst:
+0000e240: 2069 6e74 293a 0a20 2020 2070 6572 6d20   int):.    perm 
+0000e250: 3d20 5b69 2066 6f72 2069 2069 6e20 7261  = [i for i in ra
+0000e260: 6e67 6528 782e 6e64 696d 2920 6966 2069  nge(x.ndim) if i
+0000e270: 2021 3d20 7372 635d 0a20 2020 2070 6572   != src].    per
+0000e280: 6d2e 696e 7365 7274 2864 7374 2c20 7372  m.insert(dst, sr
+0000e290: 6329 0a20 2020 2072 6574 7572 6e20 7072  c).    return pr
+0000e2a0: 696d 732e 7472 616e 7370 6f73 6528 782c  ims.transpose(x,
+0000e2b0: 2074 7570 6c65 2870 6572 6d29 290a 0a0a   tuple(perm))...
+0000e2c0: 6465 6620 6d6f 7665 5f62 6174 6368 5f64  def move_batch_d
+0000e2d0: 696d 2861 7869 735f 7369 7a65 2c20 7372  im(axis_size, sr
+0000e2e0: 632c 2064 7374 2c20 7829 3a0a 2020 2020  c, dst, x):.    
+0000e2f0: 6966 2073 7263 2069 7320 6e6f 745f 6d61  if src is not_ma
+0000e300: 7070 6564 3a0a 2020 2020 2020 2020 6966  pped:.        if
+0000e310: 2069 7369 6e73 7461 6e63 6528 782c 204e   isinstance(x, N
+0000e320: 756d 6265 7229 3a0a 2020 2020 2020 2020  umber):.        
+0000e330: 2020 2020 7265 7475 726e 2078 0a20 2020      return x.   
+0000e340: 2020 2020 2074 6172 6765 745f 7368 6170       target_shap
+0000e350: 6520 3d20 6c69 7374 2878 2e73 6861 7065  e = list(x.shape
+0000e360: 290a 2020 2020 2020 2020 7461 7267 6574  ).        target
+0000e370: 5f73 6861 7065 2e69 6e73 6572 7428 6473  _shape.insert(ds
+0000e380: 742c 2061 7869 735f 7369 7a65 290a 2020  t, axis_size).  
+0000e390: 2020 2020 2020 6263 6173 745f 6469 6d73        bcast_dims
+0000e3a0: 203d 206c 6973 7428 7261 6e67 6528 6c65   = list(range(le
+0000e3b0: 6e28 7461 7267 6574 5f73 6861 7065 2929  n(target_shape))
+0000e3c0: 290a 2020 2020 2020 2020 6263 6173 745f  ).        bcast_
+0000e3d0: 6469 6d73 2e70 6f70 2864 7374 290a 2020  dims.pop(dst).  
+0000e3e0: 2020 2020 2020 7265 7475 726e 2070 7269        return pri
+0000e3f0: 6d73 2e62 726f 6164 6361 7374 5f69 6e5f  ms.broadcast_in_
+0000e400: 6469 6d28 782c 2074 6172 6765 745f 7368  dim(x, target_sh
+0000e410: 6170 652c 2062 6361 7374 5f64 696d 7329  ape, bcast_dims)
+0000e420: 0a20 2020 2065 6c69 6620 7372 6320 3d3d  .    elif src ==
+0000e430: 2064 7374 3a0a 2020 2020 2020 2020 7265   dst:.        re
+0000e440: 7475 726e 2078 0a20 2020 2065 6c73 653a  turn x.    else:
+0000e450: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000e460: 6d6f 7665 6469 6d28 782c 2073 7263 2c20  movedim(x, src, 
+0000e470: 6473 7429 0a0a 0a64 6566 2062 696e 6172  dst)...def binar
+0000e480: 795f 6f70 5f62 6174 6368 696e 675f 7275  y_op_batching_ru
+0000e490: 6c65 286f 703a 2070 7269 6d73 2e50 7269  le(op: prims.Pri
+0000e4a0: 6d49 4473 2c20 6178 6973 5f73 697a 653a  mIDs, axis_size:
+0000e4b0: 2069 6e74 2c20 7661 6c73 5f69 6e3a 2042   int, vals_in: B
+0000e4c0: 6174 6368 6564 5661 6c75 6529 3a0a 2020  atchedValue):.  
+0000e4d0: 2020 2828 782c 2078 5f62 6469 6d29 2c20    ((x, x_bdim), 
+0000e4e0: 2879 2c20 795f 6264 696d 2929 203d 2076  (y, y_bdim)) = v
+0000e4f0: 616c 735f 696e 0a20 2020 2069 6620 785f  als_in.    if x_
+0000e500: 6264 696d 2021 3d20 795f 6264 696d 3a0a  bdim != y_bdim:.
+0000e510: 2020 2020 2020 2020 6966 2078 5f62 6469          if x_bdi
+0000e520: 6d20 6973 206e 6f74 5f6d 6170 7065 643a  m is not_mapped:
+0000e530: 0a20 2020 2020 2020 2020 2020 2078 203d  .            x =
+0000e540: 206d 6f76 655f 6261 7463 685f 6469 6d28   move_batch_dim(
+0000e550: 6178 6973 5f73 697a 652c 2078 5f62 6469  axis_size, x_bdi
+0000e560: 6d2c 2079 5f62 6469 6d2c 2078 290a 2020  m, y_bdim, x).  
+0000e570: 2020 2020 2020 2020 2020 785f 6264 696d            x_bdim
+0000e580: 203d 2079 5f62 6469 6d0a 2020 2020 2020   = y_bdim.      
+0000e590: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000e5a0: 2020 2020 7920 3d20 6d6f 7665 5f62 6174      y = move_bat
+0000e5b0: 6368 5f64 696d 2861 7869 735f 7369 7a65  ch_dim(axis_size
+0000e5c0: 2c20 795f 6264 696d 2c20 785f 6264 696d  , y_bdim, x_bdim
+0000e5d0: 2c20 7929 0a20 2020 2072 6574 7572 6e20  , y).    return 
+0000e5e0: 4261 7463 6865 6456 616c 7565 286f 7028  BatchedValue(op(
+0000e5f0: 782c 2079 292c 2078 5f62 6469 6d29 0a0a  x, y), x_bdim)..
+0000e600: 0a64 6566 2073 696e 5f76 6d61 7028 6178  .def sin_vmap(ax
+0000e610: 6973 5f73 697a 653a 2069 6e74 2c20 613a  is_size: int, a:
+0000e620: 2042 6174 6368 6564 5661 6c75 6529 202d   BatchedValue) -
+0000e630: 3e20 4261 7463 6865 6456 616c 7565 3a0a  > BatchedValue:.
+0000e640: 2020 2020 7265 7475 726e 2076 6563 746f      return vecto
+0000e650: 7269 7a65 645f 6261 7463 6865 7228 7072  rized_batcher(pr
+0000e660: 696d 732e 7369 6e2c 2061 7869 735f 7369  ims.sin, axis_si
+0000e670: 7a65 2c20 2861 2c29 290a 0a0a 6465 6620  ze, (a,))...def 
+0000e680: 636f 735f 766d 6170 2861 7869 735f 7369  cos_vmap(axis_si
+0000e690: 7a65 3a20 696e 742c 2061 3a20 4261 7463  ze: int, a: Batc
+0000e6a0: 6865 6456 616c 7565 2920 2d3e 2042 6174  hedValue) -> Bat
+0000e6b0: 6368 6564 5661 6c75 653a 0a20 2020 2072  chedValue:.    r
+0000e6c0: 6574 7572 6e20 7665 6374 6f72 697a 6564  eturn vectorized
+0000e6d0: 5f62 6174 6368 6572 2870 7269 6d73 2e63  _batcher(prims.c
+0000e6e0: 6f73 2c20 6178 6973 5f73 697a 652c 2028  os, axis_size, (
+0000e6f0: 612c 2929 0a0a 0a64 6566 206d 756c 5f76  a,))...def mul_v
+0000e700: 6d61 7028 6178 6973 5f73 697a 653a 2069  map(axis_size: i
+0000e710: 6e74 2c20 613a 2042 6174 6368 6564 5661  nt, a: BatchedVa
+0000e720: 6c75 652c 2062 3a20 4261 7463 6865 6456  lue, b: BatchedV
+0000e730: 616c 7565 2920 2d3e 2042 6174 6368 6564  alue) -> Batched
+0000e740: 5661 6c75 653a 0a20 2020 2072 6574 7572  Value:.    retur
+0000e750: 6e20 6269 6e61 7279 5f6f 705f 6261 7463  n binary_op_batc
+0000e760: 6869 6e67 5f72 756c 6528 7072 696d 732e  hing_rule(prims.
+0000e770: 6d75 6c2c 2061 7869 735f 7369 7a65 2c20  mul, axis_size, 
+0000e780: 2861 2c20 6229 290a 0a0a 6465 6620 6164  (a, b))...def ad
+0000e790: 645f 766d 6170 2861 7869 735f 7369 7a65  d_vmap(axis_size
+0000e7a0: 3a20 696e 742c 2061 3a20 4261 7463 6865  : int, a: Batche
+0000e7b0: 6456 616c 7565 2c20 623a 2042 6174 6368  dValue, b: Batch
+0000e7c0: 6564 5661 6c75 6529 202d 3e20 4261 7463  edValue) -> Batc
+0000e7d0: 6865 6456 616c 7565 3a0a 2020 2020 7265  hedValue:.    re
+0000e7e0: 7475 726e 2062 696e 6172 795f 6f70 5f62  turn binary_op_b
+0000e7f0: 6174 6368 696e 675f 7275 6c65 2870 7269  atching_rule(pri
+0000e800: 6d73 2e61 6464 2c20 6178 6973 5f73 697a  ms.add, axis_siz
+0000e810: 652c 2028 612c 2062 2929 0a0a 0a64 6566  e, (a, b))...def
+0000e820: 2073 756d 5f76 6d61 7028 6178 6973 5f73   sum_vmap(axis_s
+0000e830: 697a 653a 2069 6e74 2c20 613a 2042 6174  ize: int, a: Bat
+0000e840: 6368 6564 5661 6c75 652c 2064 696d 733a  chedValue, dims:
+0000e850: 2053 6571 7565 6e63 655b 696e 745d 2c20   Sequence[int], 
+0000e860: 2a2a 6b77 6172 6773 2920 2d3e 2042 6174  **kwargs) -> Bat
+0000e870: 6368 6564 5661 6c75 653a 0a20 2020 2062  chedValue:.    b
+0000e880: 6469 6d20 3d20 612e 6261 7463 685f 6469  dim = a.batch_di
+0000e890: 6d0a 2020 2020 2320 544f 444f 3a20 7265  m.    # TODO: re
+0000e8a0: 6d6f 7665 2074 6869 7320 7768 656e 2064  move this when d
+0000e8b0: 696d 7320 6265 636f 6d65 7320 6120 6d61  ims becomes a ma
+0000e8c0: 6e64 6174 6f72 7920 6b77 6172 670a 2020  ndatory kwarg.  
+0000e8d0: 2020 6966 206c 656e 2864 696d 7329 203e    if len(dims) >
+0000e8e0: 2030 3a0a 2020 2020 2020 2020 6469 6d73   0:.        dims
+0000e8f0: 2c20 5f20 3d20 7361 6665 5f7a 6970 282a  , _ = safe_zip(*
+0000e900: 6469 6d73 290a 2020 2020 6469 6d73 5f62  dims).    dims_b
+0000e910: 6566 6f72 6520 3d20 7475 706c 6528 656c  efore = tuple(el
+0000e920: 2066 6f72 2065 6c20 696e 2064 696d 7320   for el in dims 
+0000e930: 6966 2065 6c20 3c20 6264 696d 290a 2020  if el < bdim).  
+0000e940: 2020 6469 6d73 5f61 6674 6572 203d 2074    dims_after = t
+0000e950: 7570 6c65 2865 6c20 2b20 3120 666f 7220  uple(el + 1 for 
+0000e960: 656c 2069 6e20 6469 6d73 2069 6620 656c  el in dims if el
+0000e970: 203e 3d20 6264 696d 290a 2020 2020 6261   >= bdim).    ba
+0000e980: 7463 6865 645f 6469 6d73 203d 2064 696d  tched_dims = dim
+0000e990: 735f 6265 666f 7265 202b 2064 696d 735f  s_before + dims_
+0000e9a0: 6166 7465 720a 2020 2020 7265 7475 726e  after.    return
+0000e9b0: 2076 6563 746f 7269 7a65 645f 6261 7463   vectorized_batc
+0000e9c0: 6865 7228 7072 696d 732e 7375 6d2c 2061  her(prims.sum, a
+0000e9d0: 7869 735f 7369 7a65 2c20 2861 2c29 2c20  xis_size, (a,), 
+0000e9e0: 6469 6d73 3d62 6174 6368 6564 5f64 696d  dims=batched_dim
+0000e9f0: 732c 202a 2a6b 7761 7267 7329 0a0a 0a23  s, **kwargs)...#
+0000ea00: 2054 4f44 4f3a 2050 6c65 6173 6520 7465   TODO: Please te
+0000ea10: 7374 2074 6869 7320 6578 7465 6e73 6976  st this extensiv
+0000ea20: 656c 790a 6465 6620 6272 6f61 6463 6173  ely.def broadcas
+0000ea30: 745f 696e 5f64 696d 5f76 6d61 7028 0a20  t_in_dim_vmap(. 
+0000ea40: 2020 2061 7869 735f 7369 7a65 3a20 696e     axis_size: in
+0000ea50: 742c 2061 3a20 4261 7463 6865 6456 616c  t, a: BatchedVal
+0000ea60: 7565 2c20 7368 6170 653a 2053 6571 7565  ue, shape: Seque
+0000ea70: 6e63 655b 4261 7463 6865 6456 616c 7565  nce[BatchedValue
+0000ea80: 5d2c 2062 726f 6164 6361 7374 5f64 696d  ], broadcast_dim
+0000ea90: 656e 7369 6f6e 733a 2053 6571 7565 6e63  ensions: Sequenc
+0000eaa0: 655b 4261 7463 6865 6456 616c 7565 5d0a  e[BatchedValue].
+0000eab0: 2920 2d3e 2042 6174 6368 6564 5661 6c75  ) -> BatchedValu
+0000eac0: 653a 0a20 2020 2062 6469 6d20 3d20 612e  e:.    bdim = a.
+0000ead0: 6261 7463 685f 6469 6d0a 2020 2020 2320  batch_dim.    # 
+0000eae0: 544f 444f 3a20 7265 6d6f 7665 2074 6869  TODO: remove thi
+0000eaf0: 7320 7768 656e 2073 6861 7065 2061 6e64  s when shape and
+0000eb00: 2062 726f 6164 6361 7374 5f64 696d 656e   broadcast_dimen
+0000eb10: 7369 6f6e 7320 6265 636f 6d65 206d 616e  sions become man
+0000eb20: 6461 746f 7279 206b 7761 7267 730a 2020  datory kwargs.  
+0000eb30: 2020 7368 6170 652c 205f 203d 2073 6166    shape, _ = saf
+0000eb40: 655f 7a69 7028 2a73 6861 7065 290a 2020  e_zip(*shape).  
+0000eb50: 2020 6966 206c 656e 2862 726f 6164 6361    if len(broadca
+0000eb60: 7374 5f64 696d 656e 7369 6f6e 7329 203e  st_dimensions) >
+0000eb70: 2030 3a0a 2020 2020 2020 2020 6272 6f61   0:.        broa
+0000eb80: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
+0000eb90: 2c20 5f20 3d20 7361 6665 5f7a 6970 282a  , _ = safe_zip(*
+0000eba0: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
+0000ebb0: 696f 6e73 290a 2020 2020 6966 2062 6469  ions).    if bdi
+0000ebc0: 6d20 6973 206e 6f74 5f6d 6170 7065 643a  m is not_mapped:
+0000ebd0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000ebe0: 4261 7463 6865 6456 616c 7565 2870 7269  BatchedValue(pri
+0000ebf0: 6d73 2e62 726f 6164 6361 7374 5f69 6e5f  ms.broadcast_in_
+0000ec00: 6469 6d28 612e 7661 6c75 652c 2073 6861  dim(a.value, sha
+0000ec10: 7065 2c20 6272 6f61 6463 6173 745f 6469  pe, broadcast_di
+0000ec20: 6d65 6e73 696f 6e73 292c 2062 6469 6d29  mensions), bdim)
+0000ec30: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0000ec40: 2020 206e 6577 5f62 6469 6d20 3d20 6264     new_bdim = bd
+0000ec50: 696d 202b 2073 756d 2831 2066 6f72 2064  im + sum(1 for d
+0000ec60: 696d 2069 6e20 6272 6f61 6463 6173 745f  im in broadcast_
+0000ec70: 6469 6d65 6e73 696f 6e73 2069 6620 6469  dimensions if di
+0000ec80: 6d20 3c20 6264 696d 290a 2020 2020 2020  m < bdim).      
+0000ec90: 2020 6e65 775f 7368 6170 6520 3d20 6c69    new_shape = li
+0000eca0: 7374 2873 6861 7065 290a 2020 2020 2020  st(shape).      
+0000ecb0: 2020 6e65 775f 7368 6170 652e 696e 7365    new_shape.inse
+0000ecc0: 7274 286e 6577 5f62 6469 6d2c 2061 7869  rt(new_bdim, axi
+0000ecd0: 735f 7369 7a65 290a 2020 2020 2020 2020  s_size).        
+0000ece0: 6e65 775f 6272 6f61 6463 6173 745f 6469  new_broadcast_di
+0000ecf0: 6d65 6e73 696f 6e73 203d 2028 302c 2920  mensions = (0,) 
+0000ed00: 2b20 7475 706c 6528 6469 6d20 2b20 3120  + tuple(dim + 1 
+0000ed10: 6966 2064 696d 203e 3d20 6264 696d 2065  if dim >= bdim e
+0000ed20: 6c73 6520 6469 6d20 666f 7220 6469 6d20  lse dim for dim 
+0000ed30: 696e 2062 726f 6164 6361 7374 5f64 696d  in broadcast_dim
+0000ed40: 656e 7369 6f6e 7329 0a20 2020 2020 2020  ensions).       
+0000ed50: 2069 6620 6272 6f61 6463 6173 745f 6469   if broadcast_di
+0000ed60: 6d65 6e73 696f 6e73 203d 3d20 2829 3a0a  mensions == ():.
+0000ed70: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
+0000ed80: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
+0000ed90: 696f 6e73 203d 2028 290a 2020 2020 2020  ions = ().      
+0000eda0: 2020 7265 7475 726e 2042 6174 6368 6564    return Batched
+0000edb0: 5661 6c75 6528 7072 696d 732e 6272 6f61  Value(prims.broa
+0000edc0: 6463 6173 745f 696e 5f64 696d 2861 2e76  dcast_in_dim(a.v
+0000edd0: 616c 7565 2c20 6e65 775f 7368 6170 652c  alue, new_shape,
+0000ede0: 206e 6577 5f62 726f 6164 6361 7374 5f64   new_broadcast_d
+0000edf0: 696d 656e 7369 6f6e 7329 2c20 6e65 775f  imensions), new_
+0000ee00: 6264 696d 290a 0a0a 766d 6170 5f69 6d70  bdim)...vmap_imp
+0000ee10: 6c73 3a20 6469 6374 5b70 7269 6d73 2e53  ls: dict[prims.S
+0000ee20: 796d 626f 6c2c 2043 616c 6c61 626c 655d  ymbol, Callable]
+0000ee30: 203d 2064 6963 7428 290a 0a0a 6465 6620   = dict()...def 
+0000ee40: 756e 7772 6170 5f6f 6e65 5f6c 6576 656c  unwrap_one_level
+0000ee50: 5f6f 665f 7375 6273 796d 626f 6c73 2874  _of_subsymbols(t
+0000ee60: 7261 6365 293a 0a20 2020 206e 6577 5f73  race):.    new_s
+0000ee70: 796d 626f 6c73 5f69 7465 7220 3d20 280a  ymbols_iter = (.
+0000ee80: 2020 2020 2020 2020 626f 756e 645f 7379          bound_sy
+0000ee90: 6d62 6f6c 2e73 7562 7379 6d62 6f6c 7320  mbol.subsymbols 
+0000eea0: 6966 206c 656e 2862 6f75 6e64 5f73 796d  if len(bound_sym
+0000eeb0: 626f 6c2e 7375 6273 796d 626f 6c73 2920  bol.subsymbols) 
+0000eec0: 3e20 3020 656c 7365 205b 626f 756e 645f  > 0 else [bound_
+0000eed0: 7379 6d62 6f6c 5d0a 2020 2020 2020 2020  symbol].        
+0000eee0: 666f 7220 626f 756e 645f 7379 6d62 6f6c  for bound_symbol
+0000eef0: 2069 6e20 7472 6163 652e 626f 756e 645f   in trace.bound_
+0000ef00: 7379 6d62 6f6c 730a 2020 2020 290a 2020  symbols.    ).  
+0000ef10: 2020 6e65 775f 7379 6d62 6f6c 7320 3d20    new_symbols = 
+0000ef20: 6c69 7374 2863 6861 696e 2e66 726f 6d5f  list(chain.from_
+0000ef30: 6974 6572 6162 6c65 286e 6577 5f73 796d  iterable(new_sym
+0000ef40: 626f 6c73 5f69 7465 7229 290a 2020 2020  bols_iter)).    
+0000ef50: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
+0000ef60: 6f6c 7320 3d20 6e65 775f 7379 6d62 6f6c  ols = new_symbol
+0000ef70: 730a 2020 2020 7265 7475 726e 2074 7261  s.    return tra
+0000ef80: 6365 0a0a 0a64 6566 2064 6563 6f6d 706f  ce...def decompo
+0000ef90: 7365 645f 666e 5f76 6d61 705f 7275 6c65  sed_fn_vmap_rule
+0000efa0: 2861 7869 735f 7369 7a65 2c20 2a61 7267  (axis_size, *arg
+0000efb0: 732c 2066 6e2c 202a 2a6b 7761 7267 7329  s, fn, **kwargs)
+0000efc0: 3a0a 2020 2020 6172 6773 2c20 696e 5f64  :.    args, in_d
+0000efd0: 696d 7320 3d20 756e 7a69 7032 2861 7267  ims = unzip2(arg
+0000efe0: 7329 0a20 2020 2075 6e62 6174 6368 6564  s).    unbatched
+0000eff0: 5f61 7267 7320 3d20 7472 6565 5f6d 6170  _args = tree_map
+0000f000: 286c 616d 6264 6120 783a 2072 656d 6f76  (lambda x: remov
+0000f010: 655f 6261 7463 685f 6469 6d28 7829 2069  e_batch_dim(x) i
+0000f020: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+0000f030: 5465 6e73 6f72 5072 6f78 7929 2065 6c73  TensorProxy) els
+0000f040: 6520 782c 2061 7267 7329 0a20 2020 2074  e x, args).    t
+0000f050: 7261 6365 203d 2063 6f6e 7374 7275 6374  race = construct
+0000f060: 5f74 7261 6365 2829 2866 6e2c 202a 756e  _trace()(fn, *un
+0000f070: 6261 7463 6865 645f 6172 6773 2c20 2a2a  batched_args, **
+0000f080: 6b77 6172 6773 290a 2020 2020 7472 6163  kwargs).    trac
+0000f090: 6520 3d20 756e 7772 6170 5f6f 6e65 5f6c  e = unwrap_one_l
+0000f0a0: 6576 656c 5f6f 665f 7375 6273 796d 626f  evel_of_subsymbo
+0000f0b0: 6c73 2874 7261 6365 290a 2020 2020 6f75  ls(trace).    ou
+0000f0c0: 7473 203d 205f 766d 6170 5f63 616c 6c5f  ts = _vmap_call_
+0000f0d0: 6d65 7461 6675 6e63 2846 616c 7365 2c20  metafunc(False, 
+0000f0e0: 6172 6773 2c20 696e 5f64 696d 732c 2030  args, in_dims, 0
+0000f0f0: 2c20 6178 6973 5f73 697a 652c 2066 756e  , axis_size, fun
+0000f100: 6374 696f 6e5f 7472 6163 653d 7472 6163  ction_trace=trac
+0000f110: 652c 202a 2a6b 7761 7267 7329 0a20 2020  e, **kwargs).   
+0000f120: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
+0000f130: 7574 732c 2053 6571 7565 6e63 6529 3a0a  uts, Sequence):.
+0000f140: 2020 2020 2020 2020 6f75 745f 6469 6d73          out_dims
+0000f150: 203d 2028 302c 2920 2a20 6c65 6e28 6f75   = (0,) * len(ou
+0000f160: 7473 290a 2020 2020 2020 2020 7265 7475  ts).        retu
+0000f170: 726e 2073 6166 655f 6d61 7028 7061 6972  rn safe_map(pair
+0000f180: 5f74 6f5f 6261 7463 6865 645f 7661 6c75  _to_batched_valu
+0000f190: 652c 2073 6166 655f 7a69 7028 6f75 7473  e, safe_zip(outs
+0000f1a0: 2c20 6f75 745f 6469 6d73 2929 0a20 2020  , out_dims)).   
+0000f1b0: 2072 6574 7572 6e20 4261 7463 6865 6456   return BatchedV
+0000f1c0: 616c 7565 286f 7574 732c 2030 290a 0a0a  alue(outs, 0)...
+0000f1d0: 766d 6170 5f69 6d70 6c73 5b70 7269 6d73  vmap_impls[prims
+0000f1e0: 2e50 7269 6d49 4473 2e53 494e 5d20 3d20  .PrimIDs.SIN] = 
+0000f1f0: 7369 6e5f 766d 6170 0a76 6d61 705f 696d  sin_vmap.vmap_im
+0000f200: 706c 735b 7072 696d 732e 5072 696d 4944  pls[prims.PrimID
+0000f210: 732e 434f 535d 203d 2063 6f73 5f76 6d61  s.COS] = cos_vma
+0000f220: 700a 766d 6170 5f69 6d70 6c73 5b70 7269  p.vmap_impls[pri
+0000f230: 6d73 2e50 7269 6d49 4473 2e4d 554c 5d20  ms.PrimIDs.MUL] 
+0000f240: 3d20 6d75 6c5f 766d 6170 0a76 6d61 705f  = mul_vmap.vmap_
+0000f250: 696d 706c 735b 7072 696d 732e 5072 696d  impls[prims.Prim
+0000f260: 4944 732e 4144 445d 203d 2061 6464 5f76  IDs.ADD] = add_v
+0000f270: 6d61 700a 766d 6170 5f69 6d70 6c73 5b70  map.vmap_impls[p
+0000f280: 7269 6d73 2e50 7269 6d49 4473 2e53 554d  rims.PrimIDs.SUM
+0000f290: 5d20 3d20 7375 6d5f 766d 6170 0a76 6d61  ] = sum_vmap.vma
+0000f2a0: 705f 696d 706c 735b 7072 696d 732e 5072  p_impls[prims.Pr
+0000f2b0: 696d 4944 732e 4252 4f41 4443 4153 545f  imIDs.BROADCAST_
+0000f2c0: 494e 5f44 494d 5d20 3d20 6272 6f61 6463  IN_DIM] = broadc
+0000f2d0: 6173 745f 696e 5f64 696d 5f76 6d61 700a  ast_in_dim_vmap.
+0000f2e0: 0a0a 6465 6620 766d 6170 5f73 796d 626f  ..def vmap_symbo
+0000f2f0: 6c5f 6d61 7070 6572 2873 796d 626f 6c3a  l_mapper(symbol:
+0000f300: 2070 7269 6d73 2e53 796d 626f 6c2c 202a   prims.Symbol, *
+0000f310: 2c20 6178 6973 5f73 697a 653a 2069 6e74  , axis_size: int
+0000f320: 293a 0a20 2020 2022 2222 4d61 7073 2061  ):.    """Maps a
+0000f330: 2073 796d 626f 6c20 746f 2061 2076 6d61   symbol to a vma
+0000f340: 7020 6675 6e63 7469 6f6e 2074 6861 7420  p function that 
+0000f350: 6576 616c 7561 7465 7320 6974 2e0a 0a20  evaluates it... 
+0000f360: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0000f370: 2073 796d 626f 6c20 2870 7269 6d73 2e53   symbol (prims.S
+0000f380: 796d 626f 6c29 3a20 5379 6d62 6f6c 2074  ymbol): Symbol t
+0000f390: 6f20 6576 616c 7561 7465 2e0a 0a20 2020  o evaluate...   
+0000f3a0: 2052 6169 7365 733a 0a20 2020 2020 2020   Raises:.       
+0000f3b0: 204e 6f74 496d 706c 656d 656e 7465 6445   NotImplementedE
+0000f3c0: 7272 6f72 3a20 4966 2074 6865 2076 6d61  rror: If the vma
+0000f3d0: 7020 666f 7220 7468 6520 7379 6d62 6f6c  p for the symbol
+0000f3e0: 2069 7320 6e6f 7420 696d 706c 656d 656e   is not implemen
+0000f3f0: 7465 642e 0a0a 2020 2020 5265 7475 726e  ted...    Return
+0000f400: 733a 0a20 2020 2020 2020 2043 616c 6c61  s:.        Calla
+0000f410: 626c 653a 2076 6d61 7020 6675 6e63 7469  ble: vmap functi
+0000f420: 6f6e 2074 6861 7420 6576 616c 7561 7465  on that evaluate
+0000f430: 7320 7468 6520 7379 6d62 6f6c 2e0a 2020  s the symbol..  
+0000f440: 2020 2222 220a 0a20 2020 2064 6566 2077    """..    def w
+0000f450: 7261 705f 6172 6728 7829 3a0a 2020 2020  rap_arg(x):.    
+0000f460: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0000f470: 6528 782c 2042 6174 6368 6564 5661 6c75  e(x, BatchedValu
+0000f480: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0000f490: 7265 7475 726e 2078 0a20 2020 2020 2020  return x.       
+0000f4a0: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+0000f4b0: 2878 2c20 4e75 6d62 6572 293a 0a20 2020  (x, Number):.   
+0000f4c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000f4d0: 4261 7463 6865 6456 616c 7565 2878 2c20  BatchedValue(x, 
+0000f4e0: 6e6f 745f 6d61 7070 6564 290a 2020 2020  not_mapped).    
+0000f4f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000f500: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+0000f510: 6545 7272 6f72 2866 2276 6d61 7020 7772  eError(f"vmap wr
+0000f520: 6170 5f61 7267 2067 6f74 2061 6e20 756e  ap_arg got an un
+0000f530: 7375 7070 6f72 7465 6420 7479 7065 207b  supported type {
+0000f540: 7479 7065 2878 297d 2229 0a0a 2020 2020  type(x)}")..    
+0000f550: 6966 2073 796d 626f 6c2e 6172 655f 616c  if symbol.are_al
+0000f560: 6c5f 6172 6773 5f63 6f6e 7374 616e 743a  l_args_constant:
+0000f570: 0a0a 2020 2020 2020 2020 6465 6620 5f76  ..        def _v
+0000f580: 6d61 705f 696d 706c 5f63 6f6e 7374 2873  map_impl_const(s
+0000f590: 796d 626f 6c2c 202a 6172 6773 2c20 2a2a  ymbol, *args, **
+0000f5a0: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+0000f5b0: 2020 2020 206f 7574 203d 2073 796d 626f       out = symbo
+0000f5c0: 6c5f 746f 5f65 7661 6c28 7379 6d62 6f6c  l_to_eval(symbol
+0000f5d0: 2928 2a61 7267 732c 202a 2a6b 7761 7267  )(*args, **kwarg
+0000f5e0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
+0000f5f0: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
+0000f600: 742c 2053 6571 7565 6e63 6529 3a0a 2020  t, Sequence):.  
+0000f610: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000f620: 7475 726e 2073 6166 655f 6d61 7028 7061  turn safe_map(pa
+0000f630: 6972 5f74 6f5f 6261 7463 6865 645f 7661  ir_to_batched_va
+0000f640: 6c75 652c 2073 6166 655f 7a69 7028 6172  lue, safe_zip(ar
+0000f650: 6773 2c20 5b6e 6f74 5f6d 6170 7065 645d  gs, [not_mapped]
+0000f660: 202a 206c 656e 286f 7574 2929 290a 0a20   * len(out))).. 
+0000f670: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000f680: 6e20 4261 7463 6865 6456 616c 7565 286f  n BatchedValue(o
+0000f690: 7574 2c20 6e6f 745f 6d61 7070 6564 290a  ut, not_mapped).
+0000f6a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000f6b0: 7061 7274 6961 6c28 5f76 6d61 705f 696d  partial(_vmap_im
+0000f6c0: 706c 5f63 6f6e 7374 2c20 7379 6d62 6f6c  pl_const, symbol
+0000f6d0: 290a 0a20 2020 2076 6d61 705f 696d 706c  )..    vmap_impl
+0000f6e0: 203d 2076 6d61 705f 696d 706c 732e 6765   = vmap_impls.ge
+0000f6f0: 7428 7379 6d62 6f6c 2e73 796d 2e69 6429  t(symbol.sym.id)
+0000f700: 0a20 2020 2069 6620 766d 6170 5f69 6d70  .    if vmap_imp
+0000f710: 6c20 6973 204e 6f6e 653a 0a20 2020 2020  l is None:.     
+0000f720: 2020 2069 6620 6c65 6e28 7379 6d62 6f6c     if len(symbol
+0000f730: 2e73 7562 7379 6d62 6f6c 7329 203e 2030  .subsymbols) > 0
+0000f740: 3a0a 2020 2020 2020 2020 2020 2020 766d  :.            vm
+0000f750: 6170 5f69 6d70 6c20 3d20 7061 7274 6961  ap_impl = partia
+0000f760: 6c28 6465 636f 6d70 6f73 6564 5f66 6e5f  l(decomposed_fn_
+0000f770: 766d 6170 5f72 756c 652c 2066 6e3d 7379  vmap_rule, fn=sy
+0000f780: 6d62 6f6c 2e73 796d 290a 2020 2020 2020  mbol.sym).      
+0000f790: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000f7a0: 2020 2020 7261 6973 6520 4e6f 7449 6d70      raise NotImp
+0000f7b0: 6c65 6d65 6e74 6564 4572 726f 7228 6622  lementedError(f"
+0000f7c0: 766d 6170 2066 6f72 207b 7379 6d62 6f6c  vmap for {symbol
+0000f7d0: 2e73 796d 2e69 647d 2069 7320 6e6f 7420  .sym.id} is not 
+0000f7e0: 696d 706c 656d 656e 7465 6422 290a 0a20  implemented").. 
+0000f7f0: 2020 2064 6566 205f 766d 6170 5f69 6d70     def _vmap_imp
+0000f800: 6c28 2a61 7267 732c 202a 2a6b 7761 7267  l(*args, **kwarg
+0000f810: 7329 3a0a 2020 2020 2020 2020 6172 6773  s):.        args
+0000f820: 203d 2074 7265 655f 6d61 7028 7772 6170   = tree_map(wrap
+0000f830: 5f61 7267 2c20 6172 6773 290a 2020 2020  _arg, args).    
+0000f840: 2020 2020 6173 7365 7274 2061 6c6c 2869      assert all(i
+0000f850: 7369 6e73 7461 6e63 6528 6172 672c 2042  sinstance(arg, B
+0000f860: 6174 6368 6564 5661 6c75 6529 2066 6f72  atchedValue) for
+0000f870: 2061 7267 2069 6e20 7472 6565 5f66 6c61   arg in tree_fla
+0000f880: 7474 656e 2861 7267 7329 5b30 5d29 0a20  tten(args)[0]). 
+0000f890: 2020 2020 2020 2072 6574 7572 6e20 766d         return vm
+0000f8a0: 6170 5f69 6d70 6c28 6178 6973 5f73 697a  ap_impl(axis_siz
+0000f8b0: 652c 202a 6172 6773 2c20 2a2a 6b77 6172  e, *args, **kwar
+0000f8c0: 6773 290a 0a20 2020 2072 6574 7572 6e20  gs)..    return 
+0000f8d0: 5f76 6d61 705f 696d 706c 0a0a 0a64 6566  _vmap_impl...def
+0000f8e0: 2072 656d 6f76 655f 6261 7463 685f 6469   remove_batch_di
+0000f8f0: 6d28 7465 6e73 6f72 3a20 5465 6e73 6f72  m(tensor: Tensor
+0000f900: 5072 6f78 792c 2062 6174 6368 5f64 696d  Proxy, batch_dim
+0000f910: 3a20 696e 7420 3d20 3029 202d 3e20 5465  : int = 0) -> Te
+0000f920: 6e73 6f72 5072 6f78 793a 0a20 2020 2022  nsorProxy:.    "
+0000f930: 2222 5265 6d6f 7665 7320 7468 6520 6261  ""Removes the ba
+0000f940: 7463 6820 6469 6d65 6e73 696f 6e20 6672  tch dimension fr
+0000f950: 6f6d 2061 2074 656e 736f 722e 0a0a 2020  om a tensor...  
+0000f960: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0000f970: 7465 6e73 6f72 2028 5465 6e73 6f72 5072  tensor (TensorPr
+0000f980: 6f78 7929 3a20 5465 6e73 6f72 2074 6f20  oxy): Tensor to 
+0000f990: 7265 6d6f 7665 2074 6865 2062 6174 6368  remove the batch
+0000f9a0: 2064 696d 656e 7369 6f6e 2066 726f 6d2e   dimension from.
+0000f9b0: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+0000f9c0: 2020 2020 2020 2054 656e 736f 7250 726f         TensorPro
+0000f9d0: 7879 3a20 5465 6e73 6f72 2077 6974 6820  xy: Tensor with 
+0000f9e0: 7468 6520 6261 7463 6820 6469 6d65 6e73  the batch dimens
+0000f9f0: 696f 6e20 7265 6d6f 7665 642e 0a20 2020  ion removed..   
+0000fa00: 2022 2222 0a20 2020 206e 6577 5f73 6861   """.    new_sha
+0000fa10: 7065 203d 2074 656e 736f 722e 7368 6170  pe = tensor.shap
+0000fa20: 655b 3a62 6174 6368 5f64 696d 5d20 2b20  e[:batch_dim] + 
+0000fa30: 7465 6e73 6f72 2e73 6861 7065 5b62 6174  tensor.shape[bat
+0000fa40: 6368 5f64 696d 202b 2031 203a 5d0a 2020  ch_dim + 1 :].  
+0000fa50: 2020 7265 7475 726e 2054 656e 736f 7250    return TensorP
+0000fa60: 726f 7879 286c 696b 653d 7465 6e73 6f72  roxy(like=tensor
+0000fa70: 2c20 7368 6170 653d 6e65 775f 7368 6170  , shape=new_shap
+0000fa80: 6529 0a0a 0a23 2054 4f44 4f3a 2069 6e20  e)...# TODO: in 
+0000fa90: 4a41 5820 6172 6773 2c20 696e 5f64 696d  JAX args, in_dim
+0000faa0: 7320 6172 6520 666c 6174 7465 6e65 6420  s are flattened 
+0000fab0: 7468 6520 7361 6d65 2077 6179 0a23 2054  the same way.# T
+0000fac0: 4f44 4f3a 2069 6e20 4a41 5820 6f75 745f  ODO: in JAX out_
+0000fad0: 6469 6d73 2061 7265 2066 6c61 7474 656e  dims are flatten
+0000fae0: 6564 2061 7320 7765 6c6c 0a64 6566 205f  ed as well.def _
+0000faf0: 766d 6170 5f63 616c 6c5f 6d65 7461 6675  vmap_call_metafu
+0000fb00: 6e63 2864 6574 6163 6865 643a 2062 6f6f  nc(detached: boo
+0000fb10: 6c2c 2061 7267 732c 2069 6e5f 6469 6d73  l, args, in_dims
+0000fb20: 2c20 6f75 745f 6469 6d73 2c20 6178 6973  , out_dims, axis
+0000fb30: 5f73 697a 652c 2066 756e 6374 696f 6e5f  _size, function_
+0000fb40: 7472 6163 653a 2054 7261 6365 2c20 2a2a  trace: Trace, **
+0000fb50: 6b77 6172 6773 293a 0a20 2020 2022 2222  kwargs):.    """
+0000fb60: 4d65 7461 6675 6e63 7469 6f6e 2066 6f72  Metafunction for
+0000fb70: 2076 6d61 7020 6361 6c6c 2e0a 0a20 2020   vmap call...   
+0000fb80: 2041 7267 733a 0a20 2020 2020 2020 2064   Args:.        d
+0000fb90: 6574 6163 6865 6420 2862 6f6f 6c29 3a20  etached (bool): 
+0000fba0: 5768 6574 6865 7220 746f 2064 6574 6163  Whether to detac
+0000fbb0: 6820 7468 6520 7472 6163 652e 0a20 2020  h the trace..   
+0000fbc0: 2020 2020 2061 7267 7320 2854 7570 6c65       args (Tuple
+0000fbd0: 5b50 726f 7879 5d29 3a20 4172 6775 6d65  [Proxy]): Argume
+0000fbe0: 6e74 7320 746f 2074 6865 2066 756e 6374  nts to the funct
+0000fbf0: 696f 6e2e 0a20 2020 2020 2020 2069 6e5f  ion..        in_
+0000fc00: 6469 6d73 2028 5475 706c 655b 696e 745d  dims (Tuple[int]
+0000fc10: 293a 2042 6174 6368 2064 696d 656e 7369  ): Batch dimensi
+0000fc20: 6f6e 2066 6f72 2065 6163 6820 6172 6775  on for each argu
+0000fc30: 6d65 6e74 2e0a 2020 2020 2020 2020 6f75  ment..        ou
+0000fc40: 745f 6469 6d73 2028 5475 706c 655b 696e  t_dims (Tuple[in
+0000fc50: 745d 293a 2042 6174 6368 2064 696d 656e  t]): Batch dimen
+0000fc60: 7369 6f6e 2066 6f72 2072 6574 7572 6e20  sion for return 
+0000fc70: 7661 6c75 6573 2e0a 2020 2020 2020 2020  values..        
+0000fc80: 6675 6e63 7469 6f6e 5f74 7261 6365 2028  function_trace (
+0000fc90: 5472 6163 6529 3a20 5472 6163 6520 746f  Trace): Trace to
+0000fca0: 2075 7365 2066 6f72 2074 6865 2066 756e   use for the fun
+0000fcb0: 6374 696f 6e2e 0a20 2020 2020 2020 206b  ction..        k
+0000fcc0: 7761 7267 733a 204b 6579 776f 7264 2061  wargs: Keyword a
+0000fcd0: 7267 756d 656e 7473 2e0a 0a20 2020 2052  rguments...    R
+0000fce0: 6169 7365 733a 0a20 2020 2020 2020 2041  aises:.        A
+0000fcf0: 7373 6572 7469 6f6e 4572 726f 723a 2049  ssertionError: I
+0000fd00: 6620 7468 6520 766d 6170 2066 6f72 206b  f the vmap for k
+0000fd10: 6579 776f 7264 2061 7267 756d 656e 7473  eyword arguments
+0000fd20: 2069 7320 6e6f 7420 696d 706c 656d 656e   is not implemen
+0000fd30: 7465 642e 0a0a 2020 2020 5265 7475 726e  ted...    Return
+0000fd40: 733a 0a20 2020 2020 2020 2052 6573 756c  s:.        Resul
+0000fd50: 7420 6f66 2074 6865 2076 6d61 7020 7472  t of the vmap tr
+0000fd60: 616e 7366 6f72 6d2e 0a20 2020 2022 2222  ansform..    """
+0000fd70: 0a20 2020 2063 6f6d 6d6f 6e5f 6465 7669  .    common_devi
+0000fd80: 6365 203d 207b 782e 6465 7669 6365 2066  ce = {x.device f
+0000fd90: 6f72 2078 2069 6e20 6172 6773 2069 6620  or x in args if 
+0000fda0: 6973 696e 7374 616e 6365 2878 2c20 5465  isinstance(x, Te
+0000fdb0: 6e73 6f72 5072 6f78 7929 7d0a 2020 2020  nsorProxy)}.    
+0000fdc0: 6173 7365 7274 206c 656e 2863 6f6d 6d6f  assert len(commo
+0000fdd0: 6e5f 6465 7669 6365 2920 3c3d 2031 2c20  n_device) <= 1, 
+0000fde0: 2276 6d61 7020 666f 7220 6d75 6c74 6970  "vmap for multip
+0000fdf0: 6c65 2064 6576 6963 6573 2069 7320 6e6f  le devices is no
+0000fe00: 7420 696d 706c 656d 656e 7465 6422 0a20  t implemented". 
+0000fe10: 2020 2028 636f 6d6d 6f6e 5f64 6576 6963     (common_devic
+0000fe20: 652c 2920 3d20 636f 6d6d 6f6e 5f64 6576  e,) = common_dev
+0000fe30: 6963 6520 6966 206c 656e 2863 6f6d 6d6f  ice if len(commo
+0000fe40: 6e5f 6465 7669 6365 2920 3d3d 2031 2065  n_device) == 1 e
+0000fe50: 6c73 6520 2863 7075 2c29 0a0a 2020 2020  lse (cpu,)..    
+0000fe60: 6966 2061 7869 735f 7369 7a65 2069 7320  if axis_size is 
+0000fe70: 4e6f 6e65 3a0a 2020 2020 2020 2020 2861  None:.        (a
+0000fe80: 7869 735f 7369 7a65 2c29 203d 207b 782e  xis_size,) = {x.
+0000fe90: 7368 6170 655b 6178 5d20 666f 7220 782c  shape[ax] for x,
+0000fea0: 2061 7820 696e 207a 6970 2861 7267 732c   ax in zip(args,
+0000feb0: 2069 6e5f 6469 6d73 2920 6966 2061 7820   in_dims) if ax 
+0000fec0: 6973 206e 6f74 206e 6f74 5f6d 6170 7065  is not not_mappe
+0000fed0: 647d 0a20 2020 2069 6e5f 6469 6d73 203d  d}.    in_dims =
+0000fee0: 2069 6e5f 6469 6d73 2069 6620 6973 696e   in_dims if isin
+0000fef0: 7374 616e 6365 2869 6e5f 6469 6d73 2c20  stance(in_dims, 
+0000ff00: 5365 7175 656e 6365 2920 656c 7365 2028  Sequence) else (
+0000ff10: 696e 5f64 696d 732c 290a 2020 2020 696e  in_dims,).    in
+0000ff20: 5f64 696d 7320 3d20 7475 706c 6528 6e6f  _dims = tuple(no
+0000ff30: 745f 6d61 7070 6564 2069 6620 6973 696e  t_mapped if isin
+0000ff40: 7374 616e 6365 2861 2c20 4e75 6d62 6572  stance(a, Number
+0000ff50: 2920 656c 7365 2064 2066 6f72 2061 2c20  ) else d for a, 
+0000ff60: 6420 696e 2073 6166 655f 7a69 7028 6172  d in safe_zip(ar
+0000ff70: 6773 2c20 696e 5f64 696d 7329 290a 2020  gs, in_dims)).  
+0000ff80: 2020 6f75 745f 6469 6d73 203d 206f 7574    out_dims = out
+0000ff90: 5f64 696d 7320 6966 2069 7369 6e73 7461  _dims if isinsta
+0000ffa0: 6e63 6528 6f75 745f 6469 6d73 2c20 5365  nce(out_dims, Se
+0000ffb0: 7175 656e 6365 2920 656c 7365 2028 6f75  quence) else (ou
+0000ffc0: 745f 6469 6d73 2c29 0a0a 2020 2020 6374  t_dims,)..    ct
+0000ffd0: 7820 3d20 6465 7461 6368 6564 5f74 7261  x = detached_tra
+0000ffe0: 6365 2829 2069 6620 6465 7461 6368 6564  ce() if detached
+0000fff0: 2065 6c73 6520 6e75 6c6c 636f 6e74 6578   else nullcontex
+00010000: 7428 290a 2020 2020 7769 7468 2063 7478  t().    with ctx
+00010010: 3a0a 2020 2020 2020 2020 2320 5765 2070  :.        # We p
+00010020: 726f 7061 6761 7465 2074 6865 2042 6174  ropagate the Bat
+00010030: 6368 5661 6c75 6520 7468 726f 7567 6820  chValue through 
+00010040: 7468 6520 7472 6163 652c 2061 6e64 2074  the trace, and t
+00010050: 6865 6e20 756e 7772 6170 2069 7420 6174  hen unwrap it at
+00010060: 2074 6865 2065 6e64 0a20 2020 2020 2020   the end.       
+00010070: 2062 6174 6368 6564 5f61 7267 7320 3d20   batched_args = 
+00010080: 7361 6665 5f6d 6170 2870 6169 725f 746f  safe_map(pair_to
+00010090: 5f62 6174 6368 6564 5f76 616c 7565 2c20  _batched_value, 
+000100a0: 7361 6665 5f7a 6970 2861 7267 732c 2069  safe_zip(args, i
+000100b0: 6e5f 6469 6d73 2929 0a20 2020 2020 2020  n_dims)).       
+000100c0: 2072 6573 756c 7420 3d20 6576 616c 5f74   result = eval_t
+000100d0: 7261 6365 280a 2020 2020 2020 2020 2020  race(.          
+000100e0: 2020 6675 6e63 7469 6f6e 5f74 7261 6365    function_trace
+000100f0: 2c20 2a62 6174 6368 6564 5f61 7267 732c  , *batched_args,
+00010100: 2073 796d 626f 6c5f 6d61 7070 6572 3d70   symbol_mapper=p
+00010110: 6172 7469 616c 2876 6d61 705f 7379 6d62  artial(vmap_symb
+00010120: 6f6c 5f6d 6170 7065 722c 2061 7869 735f  ol_mapper, axis_
+00010130: 7369 7a65 3d61 7869 735f 7369 7a65 292c  size=axis_size),
+00010140: 202a 2a6b 7761 7267 730a 2020 2020 2020   **kwargs.      
+00010150: 2020 290a 2020 2020 2020 2020 2320 556e    ).        # Un
+00010160: 7772 6170 7069 6e67 2074 6865 2042 6174  wrapping the Bat
+00010170: 6368 6564 5661 6c75 6527 730a 2020 2020  chedValue's.    
+00010180: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00010190: 6528 7265 7375 6c74 2c20 5365 7175 656e  e(result, Sequen
+000101a0: 6365 293a 0a20 2020 2020 2020 2020 2020  ce):.           
+000101b0: 2066 6c61 745f 7265 7375 6c74 2c20 7370   flat_result, sp
+000101c0: 6563 203d 2074 7265 655f 666c 6174 7465  ec = tree_flatte
+000101d0: 6e28 7265 7375 6c74 290a 2020 2020 2020  n(result).      
+000101e0: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
+000101f0: 2869 7369 6e73 7461 6e63 6528 782c 2042  (isinstance(x, B
+00010200: 6174 6368 6564 5661 6c75 6529 2066 6f72  atchedValue) for
+00010210: 2078 2069 6e20 666c 6174 5f72 6573 756c   x in flat_resul
+00010220: 7429 0a20 2020 2020 2020 2020 2020 206f  t).            o
+00010230: 7574 732c 2062 6469 6d73 203d 2075 6e7a  uts, bdims = unz
+00010240: 6970 3228 666c 6174 5f72 6573 756c 7429  ip2(flat_result)
+00010250: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00010260: 4f44 4f3a 2068 616e 646c 6520 7468 6520  ODO: handle the 
+00010270: 6361 7365 2077 6865 7265 206f 7574 5f64  case where out_d
+00010280: 696d 7320 6973 2061 2073 696e 676c 6520  ims is a single 
+00010290: 7661 6c75 6520 6265 7474 6572 0a20 2020  value better.   
+000102a0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+000102b0: 6f75 745f 6469 6d73 2920 3d3d 2031 3a0a  out_dims) == 1:.
+000102c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000102d0: 6f75 745f 6469 6d73 203d 206f 7574 5f64  out_dims = out_d
+000102e0: 696d 7320 2a20 6c65 6e28 6f75 7473 290a  ims * len(outs).
+000102f0: 2020 2020 2020 2020 2020 2020 6f75 7473              outs
+00010300: 203d 2073 6166 655f 6d61 7028 7061 7274   = safe_map(part
+00010310: 6961 6c28 6d6f 7665 5f62 6174 6368 5f64  ial(move_batch_d
+00010320: 696d 2c20 6178 6973 5f73 697a 6529 2c20  im, axis_size), 
+00010330: 6264 696d 732c 206f 7574 5f64 696d 732c  bdims, out_dims,
+00010340: 206f 7574 7329 0a20 2020 2020 2020 2020   outs).         
+00010350: 2020 2072 6574 7572 6e20 7472 6565 5f75     return tree_u
+00010360: 6e66 6c61 7474 656e 286f 7574 732c 2073  nflatten(outs, s
+00010370: 7065 6329 0a20 2020 2020 2020 2069 6620  pec).        if 
+00010380: 6973 696e 7374 616e 6365 2872 6573 756c  isinstance(resul
+00010390: 742c 204e 756d 6265 7229 2061 6e64 2061  t, Number) and a
+000103a0: 7869 735f 7369 7a65 2069 7320 6e6f 7420  xis_size is not 
+000103b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000103c0: 2020 2320 544f 444f 3a20 6665 7463 6820    # TODO: fetch 
+000103d0: 7468 6520 6465 6661 756c 7420 6465 7669  the default devi
+000103e0: 6365 2066 726f 6d20 7468 6520 636f 6e74  ce from the cont
+000103f0: 6578 740a 2020 2020 2020 2020 2020 2020  ext.            
+00010400: 7265 7375 6c74 203d 2066 756c 6c28 7368  result = full(sh
+00010410: 6170 653d 2829 2c20 6669 6c6c 5f76 616c  ape=(), fill_val
+00010420: 7565 3d72 6573 756c 742c 2064 6576 6963  ue=result, devic
+00010430: 653d 636f 6d6d 6f6e 5f64 6576 6963 6529  e=common_device)
+00010440: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00010450: 756c 7420 3d20 4261 7463 6865 6456 616c  ult = BatchedVal
+00010460: 7565 2872 6573 756c 742c 206e 6f74 5f6d  ue(result, not_m
+00010470: 6170 7065 6429 0a20 2020 2020 2020 2065  apped).        e
+00010480: 6c69 6620 6973 696e 7374 616e 6365 2872  lif isinstance(r
+00010490: 6573 756c 742c 2042 6174 6368 6564 5661  esult, BatchedVa
+000104a0: 6c75 6529 2061 6e64 2069 7369 6e73 7461  lue) and isinsta
+000104b0: 6e63 6528 7265 7375 6c74 2e76 616c 7565  nce(result.value
+000104c0: 2c20 4e75 6d62 6572 2920 616e 6420 6178  , Number) and ax
+000104d0: 6973 5f73 697a 6520 6973 206e 6f74 204e  is_size is not N
+000104e0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000104f0: 2072 6573 756c 7420 3d20 4261 7463 6865   result = Batche
+00010500: 6456 616c 7565 2866 756c 6c28 7368 6170  dValue(full(shap
+00010510: 653d 2829 2c20 6669 6c6c 5f76 616c 7565  e=(), fill_value
+00010520: 3d72 6573 756c 742e 7661 6c75 652c 2064  =result.value, d
+00010530: 6576 6963 653d 636f 6d6d 6f6e 5f64 6576  evice=common_dev
+00010540: 6963 6529 2c20 7265 7375 6c74 2e62 6174  ice), result.bat
+00010550: 6368 5f64 696d 290a 2020 2020 2020 2020  ch_dim).        
+00010560: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+00010570: 6528 7265 7375 6c74 2c20 4261 7463 6865  e(result, Batche
+00010580: 6456 616c 7565 290a 2020 2020 2020 2020  dValue).        
+00010590: 6f75 7420 3d20 6d6f 7665 5f62 6174 6368  out = move_batch
+000105a0: 5f64 696d 2861 7869 735f 7369 7a65 2c20  _dim(axis_size, 
+000105b0: 7265 7375 6c74 2e62 6174 6368 5f64 696d  result.batch_dim
+000105c0: 2c20 6f75 745f 6469 6d73 5b30 5d2c 2072  , out_dims[0], r
+000105d0: 6573 756c 742e 7661 6c75 6529 0a20 2020  esult.value).   
+000105e0: 2020 2020 2072 6574 7572 6e20 6f75 740a       return out.
+000105f0: 0a0a 766d 6170 5f63 616c 6c20 3d20 5379  ..vmap_call = Sy
+00010600: 6d62 6f6c 2869 643d 5472 616e 7366 6f72  mbol(id=Transfor
+00010610: 6d73 2e56 6d61 704f 702c 206e 616d 653d  ms.VmapOp, name=
+00010620: 2276 6d61 705f 6361 6c6c 222c 206d 6574  "vmap_call", met
+00010630: 613d 7061 7274 6961 6c28 5f76 6d61 705f  a=partial(_vmap_
+00010640: 6361 6c6c 5f6d 6574 6166 756e 632c 2046  call_metafunc, F
+00010650: 616c 7365 2929 0a0a 0a23 2054 4f44 4f3a  alse))...# TODO:
+00010660: 2068 6f77 2073 686f 756c 6420 7765 2068   how should we h
+00010670: 616e 646c 6520 6f75 745f 6469 6d73 2068  andle out_dims h
+00010680: 6572 653f 0a23 2061 6c74 686f 7567 6820  ere?.# although 
+00010690: 6865 7265 2077 6520 6172 6520 6361 6c6c  here we are call
+000106a0: 696e 6720 766d 6170 206f 6620 6964 656e  ing vmap of iden
+000106b0: 7469 7479 2c20 736f 2077 6520 7368 6f75  tity, so we shou
+000106c0: 6c64 206b 6e6f 7720 6672 6f6d 2074 6865  ld know from the
+000106d0: 2063 616c 6c20 746f 2076 6d61 700a 2320   call to vmap.# 
+000106e0: 5468 6973 2073 686f 756c 6420 6265 2066  This should be f
+000106f0: 696e 652e 2049 6620 7765 2068 6176 6520  ine. If we have 
+00010700: 766d 6170 2869 6465 6e74 6974 7928 6675  vmap(identity(fu
+00010710: 6e63 292c 206f 7574 5f64 696d 733d 4e29  nc), out_dims=N)
+00010720: 2074 6865 6e20 7468 6973 2072 756c 6520   then this rule 
+00010730: 6973 2066 6972 7374 2075 7365 640a 2320  is first used.# 
+00010740: 746f 2067 6574 2074 6865 2076 6d61 7070  to get the vmapp
+00010750: 6564 2072 6573 756c 7420 6f66 2069 6465  ed result of ide
+00010760: 6e74 6974 7928 6675 6e63 2920 696e 2076  ntity(func) in v
+00010770: 6d61 705f 7379 6d62 6f6c 5f6d 6170 7065  map_symbol_mappe
+00010780: 722c 2061 6e64 206f 7574 5f64 696d 7320  r, and out_dims 
+00010790: 6973 2068 616e 646c 6564 0a23 2061 6674  is handled.# aft
+000107a0: 6572 2074 6861 7420 696e 2074 6865 206f  er that in the o
+000107b0: 7574 6572 205f 766d 6170 5f63 616c 6c5f  uter _vmap_call_
+000107c0: 6d65 7461 6675 6e63 2e0a 6465 6620 5f69  metafunc..def _i
+000107d0: 6465 6e74 6974 795f 6361 6c6c 5f76 6d61  dentity_call_vma
+000107e0: 7028 6178 6973 5f73 697a 652c 202a 6261  p(axis_size, *ba
+000107f0: 7463 6865 645f 6172 6773 2c20 7472 6163  tched_args, trac
+00010800: 653a 2054 7261 6365 2c20 2a2a 6b77 6172  e: Trace, **kwar
+00010810: 6773 293a 0a20 2020 2061 7267 732c 2069  gs):.    args, i
+00010820: 6e5f 6469 6d73 203d 2075 6e7a 6970 3228  n_dims = unzip2(
+00010830: 6261 7463 6865 645f 6172 6773 290a 2020  batched_args).  
+00010840: 2020 6f75 745f 6469 6d73 203d 2030 2020    out_dims = 0  
+00010850: 2320 4669 786d 650a 2020 2020 6f75 7473  # Fixme.    outs
+00010860: 2c20 6f75 745f 6469 6d73 203d 205f 766d  , out_dims = _vm
+00010870: 6170 5f63 616c 6c5f 6d65 7461 6675 6e63  ap_call_metafunc
+00010880: 2846 616c 7365 2c20 6172 6773 2c20 696e  (False, args, in
+00010890: 5f64 696d 732c 206f 7574 5f64 696d 732c  _dims, out_dims,
+000108a0: 2061 7869 735f 7369 7a65 2c20 6675 6e63   axis_size, func
+000108b0: 7469 6f6e 5f74 7261 6365 3d74 7261 6365  tion_trace=trace
+000108c0: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
+000108d0: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
+000108e0: 7473 2c20 5365 7175 656e 6365 293a 0a20  ts, Sequence):. 
+000108f0: 2020 2020 2020 2072 6574 7572 6e20 7361         return sa
+00010900: 6665 5f6d 6170 2870 6169 725f 746f 5f62  fe_map(pair_to_b
+00010910: 6174 6368 6564 5f76 616c 7565 2c20 7361  atched_value, sa
+00010920: 6665 5f7a 6970 286f 7574 732c 206f 7574  fe_zip(outs, out
+00010930: 5f64 696d 7329 290a 2020 2020 7265 7475  _dims)).    retu
+00010940: 726e 2042 6174 6368 6564 5661 6c75 6528  rn BatchedValue(
+00010950: 6f75 7473 2c20 6f75 745f 6469 6d73 290a  outs, out_dims).
+00010960: 0a0a 766d 6170 5f69 6d70 6c73 5b54 7261  ..vmap_impls[Tra
+00010970: 6e73 666f 726d 732e 4964 656e 7469 7479  nsforms.Identity
+00010980: 4f70 5d20 3d20 5f69 6465 6e74 6974 795f  Op] = _identity_
+00010990: 6361 6c6c 5f76 6d61 700a 0a0a 6465 6620  call_vmap...def 
+000109a0: 5f6a 7670 5f63 616c 6c5f 766d 6170 2861  _jvp_call_vmap(a
+000109b0: 7869 735f 7369 7a65 2c20 6261 7463 6865  xis_size, batche
+000109c0: 645f 7072 696d 616c 732c 2062 6174 6368  d_primals, batch
+000109d0: 6564 5f74 616e 6765 6e74 732c 202a 2c20  ed_tangents, *, 
+000109e0: 6675 6e63 7469 6f6e 5f74 7261 6365 3a20  function_trace: 
+000109f0: 5472 6163 652c 202a 2a6b 7761 7267 7329  Trace, **kwargs)
+00010a00: 3a0a 2020 2020 7072 696d 616c 732c 2070  :.    primals, p
+00010a10: 7269 6d61 6c73 5f62 6469 6d73 203d 2073  rimals_bdims = s
+00010a20: 6166 655f 7a69 7028 2a62 6174 6368 6564  afe_zip(*batched
+00010a30: 5f70 7269 6d61 6c73 290a 2020 2020 7461  _primals).    ta
+00010a40: 6e67 656e 7473 2c20 7461 6e67 656e 7473  ngents, tangents
+00010a50: 5f62 6469 6d73 203d 2073 6166 655f 7a69  _bdims = safe_zi
+00010a60: 7028 2a62 6174 6368 6564 5f74 616e 6765  p(*batched_tange
+00010a70: 6e74 7329 0a20 2020 206a 7670 5f66 756e  nts).    jvp_fun
+00010a80: 6320 3d20 7061 7274 6961 6c28 5f6a 7670  c = partial(_jvp
+00010a90: 5f63 616c 6c5f 6d65 7461 6675 6e63 2c20  _call_metafunc, 
+00010aa0: 4661 6c73 652c 2066 756e 6374 696f 6e5f  False, function_
+00010ab0: 7472 6163 653d 6675 6e63 7469 6f6e 5f74  trace=function_t
+00010ac0: 7261 6365 290a 2020 2020 766d 6170 7065  race).    vmappe
+00010ad0: 645f 6a76 705f 6675 6e63 203d 2076 6d61  d_jvp_func = vma
+00010ae0: 7028 6a76 705f 6675 6e63 2c20 696e 5f64  p(jvp_func, in_d
+00010af0: 696d 733d 2870 7269 6d61 6c73 5f62 6469  ims=(primals_bdi
+00010b00: 6d73 2c20 7461 6e67 656e 7473 5f62 6469  ms, tangents_bdi
+00010b10: 6d73 292c 2061 7869 735f 7369 7a65 3d61  ms), axis_size=a
+00010b20: 7869 735f 7369 7a65 290a 2020 2020 7265  xis_size).    re
+00010b30: 7375 6c74 203d 2076 6d61 7070 6564 5f6a  sult = vmapped_j
+00010b40: 7670 5f66 756e 6328 7072 696d 616c 732c  vp_func(primals,
+00010b50: 2074 616e 6765 6e74 732c 202a 2a6b 7761   tangents, **kwa
+00010b60: 7267 7329 0a20 2020 2072 6574 7572 6e20  rgs).    return 
+00010b70: 7472 6565 5f6d 6170 286c 616d 6264 6120  tree_map(lambda 
+00010b80: 783a 2042 6174 6368 6564 5661 6c75 6528  x: BatchedValue(
+00010b90: 782c 2030 292c 2072 6573 756c 7429 0a0a  x, 0), result)..
+00010ba0: 0a76 6d61 705f 696d 706c 735b 5472 616e  .vmap_impls[Tran
+00010bb0: 7366 6f72 6d73 2e4a 7670 4f70 5d20 3d20  sforms.JvpOp] = 
+00010bc0: 5f6a 7670 5f63 616c 6c5f 766d 6170 0a0a  _jvp_call_vmap..
+00010bd0: 0a64 6566 2076 6d61 7028 6675 6e63 2c20  .def vmap(func, 
+00010be0: 696e 5f64 696d 733d 302c 206f 7574 5f64  in_dims=0, out_d
+00010bf0: 696d 733d 302c 2061 7869 735f 7369 7a65  ims=0, axis_size
+00010c00: 3d4e 6f6e 6529 3a0a 2020 2020 2222 2256  =None):.    """V
+00010c10: 6563 746f 7269 7a69 6e67 2074 7261 6e73  ectorizing trans
+00010c20: 666f 726d 2066 6f72 2061 2054 6875 6e64  form for a Thund
+00010c30: 6572 2066 756e 6374 696f 6e2e 0a0a 2020  er function...  
+00010c40: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00010c50: 6675 6e63 2028 4361 6c6c 6162 6c65 293a  func (Callable):
+00010c60: 2041 2054 6875 6e64 6572 2066 756e 6374   A Thunder funct
+00010c70: 696f 6e20 746f 2062 6520 7472 616e 7366  ion to be transf
+00010c80: 6f72 6d65 642e 0a0a 2020 2020 5265 7475  ormed...    Retu
+00010c90: 726e 733a 0a20 2020 2020 2020 2043 616c  rns:.        Cal
+00010ca0: 6c61 626c 653a 2041 2076 6d61 7070 6564  lable: A vmapped
+00010cb0: 2076 6572 7369 6f6e 206f 6620 7468 6520   version of the 
+00010cc0: 6675 6e63 7469 6f6e 2e0a 2020 2020 2222  function..    ""
+00010cd0: 220a 0a20 2020 2023 2054 4f44 4f3a 2066  "..    # TODO: f
+00010ce0: 6c61 7474 656e 0a20 2020 2023 2049 6e20  latten.    # In 
+00010cf0: 4a41 5820 666c 6174 7465 6e69 6e67 206f  JAX flattening o
+00010d00: 6620 696e 5f64 696d 7320 6973 2072 6174  f in_dims is rat
+00010d10: 6865 7220 636f 6d70 6c69 6361 7465 6420  her complicated 
+00010d20: 6265 6361 7573 6520 6974 2063 616e 206f  because it can o
+00010d30: 7074 696f 6e61 6c6c 7920 6265 0a20 2020  ptionally be.   
+00010d40: 2023 2073 7065 6369 6669 6564 2061 7320   # specified as 
+00010d50: 6120 e280 9c70 7265 6669 78e2 809d 2070  a ...prefix... p
+00010d60: 7974 7265 652c 206d 6561 6e69 6e67 2074  ytree, meaning t
+00010d70: 6861 7420 6120 7369 6e67 6c65 206c 6561  hat a single lea
+00010d80: 6620 7661 6c75 6520 6361 6e20 6265 2061  f value can be a
+00010d90: 7070 6c69 6564 0a20 2020 2023 2074 6f20  pplied.    # to 
+00010da0: 616e 2065 6e74 6972 6520 7375 622d 7079  an entire sub-py
+00010db0: 7472 6565 2e0a 0a20 2020 2064 6566 2066  tree...    def f
+00010dc0: 6c61 7474 656e 5f66 756e 635f 666f 725f  latten_func_for_
+00010dd0: 766d 6170 2866 756e 632c 2061 7267 732c  vmap(func, args,
+00010de0: 206b 7761 7267 7329 3a0a 2020 2020 2020   kwargs):.      
+00010df0: 2020 666c 6174 5f61 7267 732c 2073 7065    flat_args, spe
+00010e00: 6320 3d20 7472 6565 5f66 6c61 7474 656e  c = tree_flatten
+00010e10: 2828 6172 6773 2c20 6b77 6172 6773 2929  ((args, kwargs))
+00010e20: 0a0a 2020 2020 2020 2020 6465 6620 666c  ..        def fl
+00010e30: 6174 5f66 756e 6328 2a66 6c61 745f 6172  at_func(*flat_ar
+00010e40: 6773 293a 0a20 2020 2020 2020 2020 2020  gs):.           
+00010e50: 2066 6e5f 6172 6773 2c20 666e 5f6b 7761   fn_args, fn_kwa
+00010e60: 7267 7320 3d20 7472 6565 5f75 6e66 6c61  rgs = tree_unfla
+00010e70: 7474 656e 2866 6c61 745f 6172 6773 2c20  tten(flat_args, 
+00010e80: 7370 6563 290a 2020 2020 2020 2020 2020  spec).          
+00010e90: 2020 7265 7475 726e 2066 756e 6328 2a66    return func(*f
+00010ea0: 6e5f 6172 6773 2c20 2a2a 666e 5f6b 7761  n_args, **fn_kwa
+00010eb0: 7267 7329 0a0a 2020 2020 2020 2020 7265  rgs)..        re
+00010ec0: 7475 726e 2066 6c61 745f 6675 6e63 2c20  turn flat_func, 
+00010ed0: 666c 6174 5f61 7267 732c 2073 7065 630a  flat_args, spec.
+00010ee0: 0a20 2020 2064 6566 2077 7261 7070 6572  .    def wrapper
+00010ef0: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
+00010f00: 293a 0a20 2020 2020 2020 2066 756e 635f  ):.        func_
+00010f10: 666c 6174 2c20 6172 6773 5f66 6c61 742c  flat, args_flat,
+00010f20: 2061 7267 735f 7370 6563 203d 2066 6c61   args_spec = fla
+00010f30: 7474 656e 5f66 756e 635f 666f 725f 766d  tten_func_for_vm
+00010f40: 6170 2866 756e 632c 2061 7267 732c 206b  ap(func, args, k
+00010f50: 7761 7267 7329 0a20 2020 2020 2020 2069  wargs).        i
+00010f60: 6620 6973 696e 7374 616e 6365 2869 6e5f  f isinstance(in_
+00010f70: 6469 6d73 2c20 696e 7429 3a0a 2020 2020  dims, int):.    
+00010f80: 2020 2020 2020 2020 696e 5f64 696d 735f          in_dims_
+00010f90: 666c 6174 203d 2028 696e 5f64 696d 732c  flat = (in_dims,
+00010fa0: 2920 2a20 6c65 6e28 6172 6773 5f66 6c61  ) * len(args_fla
+00010fb0: 7429 0a20 2020 2020 2020 2065 6c73 653a  t).        else:
+00010fc0: 0a20 2020 2020 2020 2020 2020 2069 6e5f  .            in_
+00010fd0: 6469 6d73 5f66 6c61 742c 2069 6e5f 6469  dims_flat, in_di
+00010fe0: 6d73 5f73 7065 6320 3d20 7472 6565 5f66  ms_spec = tree_f
+00010ff0: 6c61 7474 656e 2869 6e5f 6469 6d73 290a  latten(in_dims).
+00011000: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00011010: 7274 206c 656e 2869 6e5f 6469 6d73 5f66  rt len(in_dims_f
+00011020: 6c61 7429 203d 3d20 6c65 6e28 6172 6773  lat) == len(args
+00011030: 5f66 6c61 7429 2c20 2269 6e5f 6469 6d73  _flat), "in_dims
+00011040: 206d 7573 7420 6861 7665 2074 6865 2073   must have the s
+00011050: 616d 6520 6c65 6e67 7468 2061 7320 6172  ame length as ar
+00011060: 6773 2c20 6b77 6172 6773 220a 2020 2020  gs, kwargs".    
+00011070: 2020 2020 756e 6261 7463 6865 645f 6172      unbatched_ar
+00011080: 6773 5f66 6c61 7420 3d20 5b72 656d 6f76  gs_flat = [remov
+00011090: 655f 6261 7463 685f 6469 6d28 6172 6729  e_batch_dim(arg)
+000110a0: 2069 6620 6973 696e 7374 616e 6365 2861   if isinstance(a
+000110b0: 7267 2c20 5465 6e73 6f72 5072 6f78 7929  rg, TensorProxy)
+000110c0: 2065 6c73 6520 6172 6720 666f 7220 6172   else arg for ar
+000110d0: 6720 696e 2061 7267 735f 666c 6174 5d0a  g in args_flat].
+000110e0: 2020 2020 2020 2020 7472 6163 6520 3d20          trace = 
+000110f0: 636f 6e73 7472 7563 745f 7472 6163 6528  construct_trace(
+00011100: 2928 6675 6e63 5f66 6c61 742c 202a 756e  )(func_flat, *un
+00011110: 6261 7463 6865 645f 6172 6773 5f66 6c61  batched_args_fla
+00011120: 7429 0a20 2020 2020 2020 206f 7574 7320  t).        outs 
+00011130: 3d20 766d 6170 5f63 616c 6c28 6172 6773  = vmap_call(args
+00011140: 5f66 6c61 742c 2069 6e5f 6469 6d73 5f66  _flat, in_dims_f
+00011150: 6c61 742c 206f 7574 5f64 696d 732c 2061  lat, out_dims, a
+00011160: 7869 735f 7369 7a65 3d61 7869 735f 7369  xis_size=axis_si
+00011170: 7a65 2c20 6675 6e63 7469 6f6e 5f74 7261  ze, function_tra
+00011180: 6365 3d74 7261 6365 290a 2020 2020 2020  ce=trace).      
+00011190: 2020 7265 7475 726e 206f 7574 730a 0a20    return outs.. 
+000111a0: 2020 2072 6574 7572 6e20 7772 6170 7065     return wrappe
+000111b0: 720a 0a0a 2320 544f 444f 2054 6869 7320  r...# TODO This 
+000111c0: 6675 6e63 7469 6f6e 2063 6f6d 6d65 6e74  function comment
+000111d0: 6564 206f 7574 2062 6563 6175 7365 2069  ed out because i
+000111e0: 7420 6361 6c6c 7320 6d61 6b65 5f74 7261  t calls make_tra
+000111f0: 6365 642c 2077 6869 6368 2064 6f65 7320  ced, which does 
+00011200: 6e6f 7420 6578 6973 740a 2320 6465 6620  not exist.# def 
+00011210: 766d 6170 5f65 6167 6572 2866 756e 632c  vmap_eager(func,
+00011220: 2061 7267 732c 2069 6e5f 6469 6d73 3d30   args, in_dims=0
+00011230: 2c20 6f75 745f 6469 6d73 3d30 2c20 6178  , out_dims=0, ax
+00011240: 6973 5f73 697a 653d 4e6f 6e65 2c20 6578  is_size=None, ex
+00011250: 6563 7574 6f72 3d22 746f 7263 6822 293a  ecutor="torch"):
+00011260: 0a23 2020 2020 2022 2222 436f 6d70 7574  .#     """Comput
+00011270: 6573 2074 6865 2076 6d61 7020 6f66 2061  es the vmap of a
+00011280: 2054 6875 6e64 6572 2066 756e 6374 696f   Thunder functio
+00011290: 6e2e 0a0a 2320 2020 2020 4172 6773 3a0a  n...#     Args:.
+000112a0: 2320 2020 2020 2020 2020 6675 6e63 2028  #         func (
+000112b0: 4361 6c6c 6162 6c65 293a 2041 2054 6875  Callable): A Thu
+000112c0: 6e64 6572 2066 756e 6374 696f 6e20 746f  nder function to
+000112d0: 2062 6520 7472 616e 7366 6f72 6d65 642e   be transformed.
+000112e0: 0a23 2020 2020 2020 2020 2061 7267 7320  .#         args 
+000112f0: 285f 7479 7065 5f29 3a20 4172 6773 206f  (_type_): Args o
+00011300: 6620 7468 6520 6675 6e63 7469 6f6e 2e0a  f the function..
+00011310: 2320 2020 2020 2020 2020 6578 6563 7574  #         execut
+00011320: 6f72 2028 7374 722c 206f 7074 696f 6e61  or (str, optiona
+00011330: 6c29 3a20 4578 6563 7574 6f72 2074 6f20  l): Executor to 
+00011340: 7573 652e 2044 6566 6175 6c74 7320 746f  use. Defaults to
+00011350: 2022 746f 7263 6822 2e0a 0a23 2020 2020   "torch"...#    
+00011360: 2052 6574 7572 6e73 3a0a 2320 2020 2020   Returns:.#     
+00011370: 2020 2020 5468 6520 7265 7375 6c74 206f      The result o
+00011380: 6620 7468 6520 766d 6170 7065 6420 6675  f the vmapped fu
+00011390: 6e63 7469 6f6e 2e0a 2320 2020 2020 2222  nction..#     ""
+000113a0: 220a 2320 2020 2020 2320 544f 444f 3a20  ".#     # TODO: 
+000113b0: 6669 7820 7468 6973 202d 206e 6f74 2061  fix this - not a
+000113c0: 6c6c 2061 7267 7320 6d61 7920 6265 2062  ll args may be b
+000113d0: 6174 6368 6564 0a23 2020 2020 2023 2054  atched.#     # T
+000113e0: 4f44 4f3a 2068 6572 6520 7765 2061 7373  ODO: here we ass
+000113f0: 756d 6520 6261 7463 6820 6178 6973 2069  ume batch axis i
+00011400: 7320 300a 2320 2020 2020 766d 6170 5f74  s 0.#     vmap_t
+00011410: 7261 6365 203d 206d 616b 655f 7472 6163  race = make_trac
+00011420: 6528 0a23 2020 2020 2020 2020 2076 6d61  e(.#         vma
+00011430: 7028 6675 6e63 2c20 696e 5f64 696d 733d  p(func, in_dims=
+00011440: 696e 5f64 696d 732c 206f 7574 5f64 696d  in_dims, out_dim
+00011450: 733d 6f75 745f 6469 6d73 2c20 6178 6973  s=out_dims, axis
+00011460: 5f73 697a 653d 6178 6973 5f73 697a 6529  _size=axis_size)
+00011470: 2c20 6578 6563 7574 6f72 3d65 7865 6375  , executor=execu
+00011480: 746f 722c 0a23 2020 2020 2020 2020 202a  tor,.#         *
+00011490: 6172 6773 290a 2320 2020 2020 766d 6170  args).#     vmap
+000114a0: 5f74 7261 6365 6420 3d20 6d61 6b65 5f74  _traced = make_t
+000114b0: 7261 6365 6428 7061 7274 6961 6c28 6576  raced(partial(ev
+000114c0: 616c 5f74 7261 6365 2c20 766d 6170 5f74  al_trace, vmap_t
+000114d0: 7261 6365 292c 2065 7865 6375 746f 723d  race), executor=
+000114e0: 6578 6563 7574 6f72 290a 2320 2020 2020  executor).#     
+000114f0: 7265 7475 726e 2076 6d61 705f 7472 6163  return vmap_trac
+00011500: 6564 282a 6172 6773 290a 0a0a 2320 4a56  ed(*args)...# JV
+00011510: 5020 7472 616e 7366 6f72 6d0a 2320 2d2d  P transform.# --
+00011520: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 0a0a 4064  -----------...@d
+00011530: 6174 6163 6c61 7373 2866 726f 7a65 6e3d  ataclass(frozen=
+00011540: 5472 7565 290a 636c 6173 7320 4a56 5044  True).class JVPD
+00011550: 7561 6c3a 0a20 2020 2022 2222 4475 616c  ual:.    """Dual
+00011560: 206e 756d 6265 7220 666f 7220 7468 6520   number for the 
+00011570: 4a56 5020 7472 616e 7366 6f72 6d2e 0a0a  JVP transform...
+00011580: 2020 2020 4174 7472 6962 7574 6573 3a0a      Attributes:.
+00011590: 2020 2020 2020 2020 7072 696d 616c 3a20          primal: 
+000115a0: 5072 696d 616c 2076 616c 7565 2e0a 2020  Primal value..  
+000115b0: 2020 2020 2020 7461 6e67 656e 743a 2054        tangent: T
+000115c0: 616e 6765 6e74 2076 616c 7565 2e0a 2020  angent value..  
+000115d0: 2020 2222 220a 0a20 2020 2070 7269 6d61    """..    prima
+000115e0: 6c3a 2041 6e79 0a20 2020 2074 616e 6765  l: Any.    tange
+000115f0: 6e74 3a20 416e 790a 0a20 2020 2064 6566  nt: Any..    def
+00011600: 205f 5f69 7465 725f 5f28 7365 6c66 293a   __iter__(self):
+00011610: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
+00011620: 656c 662e 7072 696d 616c 0a20 2020 2020  elf.primal.     
+00011630: 2020 2079 6965 6c64 2073 656c 662e 7461     yield self.ta
+00011640: 6e67 656e 740a 0a0a 6465 6620 7061 6972  ngent...def pair
+00011650: 5f74 6f5f 6a76 705f 6475 616c 2870 6169  _to_jvp_dual(pai
+00011660: 7229 3a0a 2020 2020 2222 2243 6f6e 7665  r):.    """Conve
+00011670: 7274 7320 6120 7061 6972 2074 6f20 6120  rts a pair to a 
+00011680: 4a56 5044 7561 6c2e 0a0a 2020 2020 4172  JVPDual...    Ar
+00011690: 6773 3a0a 2020 2020 2020 2020 7061 6972  gs:.        pair
+000116a0: 2028 5365 7175 656e 6365 293a 2050 6169   (Sequence): Pai
+000116b0: 7220 746f 2063 6f6e 7665 7274 2e0a 0a20  r to convert... 
+000116c0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+000116d0: 2020 2020 4a56 5044 7561 6c3a 204a 5650      JVPDual: JVP
+000116e0: 4475 616c 2072 6570 7265 7365 6e74 6174  Dual representat
+000116f0: 696f 6e20 6f66 2074 6865 2070 6169 722e  ion of the pair.
+00011700: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
+00011710: 6973 696e 7374 616e 6365 2870 6169 722c  isinstance(pair,
+00011720: 204a 5650 4475 616c 293a 0a20 2020 2020   JVPDual):.     
+00011730: 2020 2072 6574 7572 6e20 7061 6972 0a20     return pair. 
+00011740: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00011750: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+00011760: 6365 2870 6169 722c 2053 6571 7565 6e63  ce(pair, Sequenc
+00011770: 6529 2061 6e64 206c 656e 2870 6169 7229  e) and len(pair)
+00011780: 203d 3d20 320a 2020 2020 2020 2020 7265   == 2.        re
+00011790: 7475 726e 204a 5650 4475 616c 282a 7061  turn JVPDual(*pa
+000117a0: 6972 290a 0a0a 6465 6620 7369 6e5f 6a76  ir)...def sin_jv
+000117b0: 7028 613a 204a 5650 4475 616c 293a 0a20  p(a: JVPDual):. 
+000117c0: 2020 2078 2c20 7864 203d 2061 0a20 2020     x, xd = a.   
+000117d0: 2072 6574 7572 6e20 4a56 5044 7561 6c28   return JVPDual(
+000117e0: 7072 696d 732e 7369 6e28 7829 2c20 7072  prims.sin(x), pr
+000117f0: 696d 732e 636f 7328 7829 202a 2078 6429  ims.cos(x) * xd)
+00011800: 0a0a 0a64 6566 206d 756c 5f6a 7670 2861  ...def mul_jvp(a
+00011810: 3a20 4a56 5044 7561 6c2c 2062 3a20 4a56  : JVPDual, b: JV
+00011820: 5044 7561 6c29 3a0a 2020 2020 782c 2078  PDual):.    x, x
+00011830: 6420 3d20 610a 2020 2020 792c 2079 6420  d = a.    y, yd 
+00011840: 3d20 620a 2020 2020 7265 7475 726e 204a  = b.    return J
+00011850: 5650 4475 616c 2878 202a 2079 2c20 7820  VPDual(x * y, x 
+00011860: 2a20 7964 202b 2079 202a 2078 6429 0a0a  * yd + y * xd)..
+00011870: 0a64 6566 2061 6464 5f6a 7670 2861 3a20  .def add_jvp(a: 
+00011880: 4a56 5044 7561 6c2c 2062 3a20 4a56 5044  JVPDual, b: JVPD
+00011890: 7561 6c29 3a0a 2020 2020 782c 2078 6420  ual):.    x, xd 
+000118a0: 3d20 610a 2020 2020 792c 2079 6420 3d20  = a.    y, yd = 
+000118b0: 620a 2020 2020 7265 7475 726e 204a 5650  b.    return JVP
+000118c0: 4475 616c 2878 202b 2079 2c20 7864 202b  Dual(x + y, xd +
+000118d0: 2079 6429 0a0a 0a64 6566 2062 726f 6164   yd)...def broad
+000118e0: 6361 7374 5f69 6e5f 6469 6d5f 6a76 7028  cast_in_dim_jvp(
+000118f0: 613a 204a 5650 4475 616c 2c20 7368 6170  a: JVPDual, shap
+00011900: 653a 2074 7570 6c65 5b4a 5650 4475 616c  e: tuple[JVPDual
+00011910: 2c20 2e2e 2e5d 2c20 6272 6f61 6463 6173  , ...], broadcas
+00011920: 745f 6469 6d65 6e73 696f 6e73 3a20 7475  t_dimensions: tu
+00011930: 706c 655b 4a56 5044 7561 6c2c 202e 2e2e  ple[JVPDual, ...
+00011940: 5d29 202d 3e20 4a56 5044 7561 6c3a 0a20  ]) -> JVPDual:. 
+00011950: 2020 2078 2c20 7864 203d 2061 0a20 2020     x, xd = a.   
+00011960: 2023 2054 4f44 4f3a 2073 6861 7065 2061   # TODO: shape a
+00011970: 6e64 2062 726f 6164 6361 7374 5f64 696d  nd broadcast_dim
+00011980: 656e 7369 6f6e 7320 7368 6f75 6c64 2062  ensions should b
+00011990: 6520 7475 706c 6573 206f 6620 696e 7473  e tuples of ints
+000119a0: 0a20 2020 2023 2062 7574 2066 6f72 206e  .    # but for n
+000119b0: 6f77 2069 7427 7320 6120 7475 706c 6520  ow it's a tuple 
+000119c0: 6f66 204a 5650 4475 616c 730a 2020 2020  of JVPDuals.    
+000119d0: 6966 206c 656e 2873 6861 7065 2920 3e20  if len(shape) > 
+000119e0: 3020 616e 6420 6973 696e 7374 616e 6365  0 and isinstance
+000119f0: 2873 6861 7065 5b30 5d2c 204a 5650 4475  (shape[0], JVPDu
+00011a00: 616c 293a 0a20 2020 2020 2020 2073 6861  al):.        sha
+00011a10: 7065 2c20 5f20 3d20 7361 6665 5f7a 6970  pe, _ = safe_zip
+00011a20: 282a 7368 6170 6529 0a20 2020 2069 6620  (*shape).    if 
+00011a30: 6c65 6e28 6272 6f61 6463 6173 745f 6469  len(broadcast_di
+00011a40: 6d65 6e73 696f 6e73 2920 3e20 3020 616e  mensions) > 0 an
+00011a50: 6420 6973 696e 7374 616e 6365 2862 726f  d isinstance(bro
+00011a60: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
+00011a70: 735b 305d 2c20 4a56 5044 7561 6c29 3a0a  s[0], JVPDual):.
+00011a80: 2020 2020 2020 2020 6272 6f61 6463 6173          broadcas
+00011a90: 745f 6469 6d65 6e73 696f 6e73 2c20 5f20  t_dimensions, _ 
+00011aa0: 3d20 7361 6665 5f7a 6970 282a 6272 6f61  = safe_zip(*broa
+00011ab0: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
+00011ac0: 290a 2020 2020 7265 7475 726e 204a 5650  ).    return JVP
+00011ad0: 4475 616c 280a 2020 2020 2020 2020 7072  Dual(.        pr
+00011ae0: 696d 732e 6272 6f61 6463 6173 745f 696e  ims.broadcast_in
+00011af0: 5f64 696d 2878 2c20 7368 6170 652c 2062  _dim(x, shape, b
+00011b00: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
+00011b10: 6f6e 7329 2c20 7072 696d 732e 6272 6f61  ons), prims.broa
+00011b20: 6463 6173 745f 696e 5f64 696d 2878 642c  dcast_in_dim(xd,
+00011b30: 2073 6861 7065 2c20 6272 6f61 6463 6173   shape, broadcas
+00011b40: 745f 6469 6d65 6e73 696f 6e73 290a 2020  t_dimensions).  
+00011b50: 2020 290a 0a0a 6465 6620 756e 7061 636b    )...def unpack
+00011b60: 5f73 6571 7565 6e63 655f 6a76 7028 7365  _sequence_jvp(se
+00011b70: 7175 656e 6365 3a20 4a56 5044 7561 6c2c  quence: JVPDual,
+00011b80: 206c 656e 6774 683a 204a 5650 4475 616c   length: JVPDual
+00011b90: 2920 2d3e 204a 5650 4475 616c 3a0a 2020  ) -> JVPDual:.  
+00011ba0: 2020 7820 3d20 7472 6565 5f6d 6170 286c    x = tree_map(l
+00011bb0: 616d 6264 6120 783a 2078 2e70 7269 6d61  ambda x: x.prima
+00011bc0: 6c2c 2073 6571 7565 6e63 6529 0a20 2020  l, sequence).   
+00011bd0: 2078 6420 3d20 7472 6565 5f6d 6170 286c   xd = tree_map(l
+00011be0: 616d 6264 6120 783a 2078 2e74 616e 6765  ambda x: x.tange
+00011bf0: 6e74 2c20 7365 7175 656e 6365 290a 2020  nt, sequence).  
+00011c00: 2020 6c65 6e67 7468 2c20 5f20 3d20 6c65    length, _ = le
+00011c10: 6e67 7468 0a20 2020 2070 7269 6d61 6c73  ngth.    primals
+00011c20: 203d 2070 7269 6d73 2e75 6e70 6163 6b5f   = prims.unpack_
+00011c30: 7365 7175 656e 6365 2878 2c20 6c65 6e67  sequence(x, leng
+00011c40: 7468 290a 2020 2020 7461 6e67 656e 7473  th).    tangents
+00011c50: 203d 2070 7269 6d73 2e75 6e70 6163 6b5f   = prims.unpack_
+00011c60: 7365 7175 656e 6365 2878 642c 206c 656e  sequence(xd, len
+00011c70: 6774 6829 0a20 2020 2072 6574 7572 6e20  gth).    return 
+00011c80: 7361 6665 5f6d 6170 2870 6169 725f 746f  safe_map(pair_to
+00011c90: 5f6a 7670 5f64 7561 6c2c 2073 6166 655f  _jvp_dual, safe_
+00011ca0: 7a69 7028 7072 696d 616c 732c 2074 616e  zip(primals, tan
+00011cb0: 6765 6e74 7329 290a 0a0a 6465 6620 756e  gents))...def un
+00011cc0: 7061 636b 5f74 7269 7669 616c 5f6a 7670  pack_trivial_jvp
+00011cd0: 2878 3a20 4a56 5044 7561 6c29 202d 3e20  (x: JVPDual) -> 
+00011ce0: 4a56 5044 7561 6c3a 0a20 2020 2072 6574  JVPDual:.    ret
+00011cf0: 7572 6e20 780a 0a0a 6a76 705f 696d 706c  urn x...jvp_impl
+00011d00: 733a 2064 6963 745b 7072 696d 732e 5379  s: dict[prims.Sy
+00011d10: 6d62 6f6c 2c20 4361 6c6c 6162 6c65 5d20  mbol, Callable] 
+00011d20: 3d20 6469 6374 2829 0a0a 6a76 705f 696d  = dict()..jvp_im
+00011d30: 706c 735b 7072 696d 732e 5072 696d 4944  pls[prims.PrimID
+00011d40: 732e 5349 4e5d 203d 2073 696e 5f6a 7670  s.SIN] = sin_jvp
+00011d50: 0a6a 7670 5f69 6d70 6c73 5b70 7269 6d73  .jvp_impls[prims
+00011d60: 2e50 7269 6d49 4473 2e4d 554c 5d20 3d20  .PrimIDs.MUL] = 
+00011d70: 6d75 6c5f 6a76 700a 6a76 705f 696d 706c  mul_jvp.jvp_impl
+00011d80: 735b 7072 696d 732e 5072 696d 4944 732e  s[prims.PrimIDs.
+00011d90: 4144 445d 203d 2061 6464 5f6a 7670 0a6a  ADD] = add_jvp.j
+00011da0: 7670 5f69 6d70 6c73 5b70 7269 6d73 2e50  vp_impls[prims.P
+00011db0: 7269 6d49 4473 2e42 524f 4144 4341 5354  rimIDs.BROADCAST
+00011dc0: 5f49 4e5f 4449 4d5d 203d 2062 726f 6164  _IN_DIM] = broad
+00011dd0: 6361 7374 5f69 6e5f 6469 6d5f 6a76 700a  cast_in_dim_jvp.
+00011de0: 2320 6a76 705f 696d 706c 735b 7072 696d  # jvp_impls[prim
+00011df0: 732e 5072 696d 4944 732e 554e 5041 434b  s.PrimIDs.UNPACK
+00011e00: 5f53 4551 5545 4e43 455d 203d 2075 6e70  _SEQUENCE] = unp
+00011e10: 6163 6b5f 7365 7175 656e 6365 5f6a 7670  ack_sequence_jvp
+00011e20: 0a23 206a 7670 5f69 6d70 6c73 5b70 7269  .# jvp_impls[pri
+00011e30: 6d73 2e50 7269 6d49 4473 2e55 4e50 4143  ms.PrimIDs.UNPAC
+00011e40: 4b5f 5452 4956 4941 4c5d 203d 2075 6e70  K_TRIVIAL] = unp
+00011e50: 6163 6b5f 7472 6976 6961 6c5f 6a76 700a  ack_trivial_jvp.
+00011e60: 0a0a 6465 6620 6a76 705f 7379 6d62 6f6c  ..def jvp_symbol
+00011e70: 5f6d 6170 7065 7228 7379 6d62 6f6c 3a20  _mapper(symbol: 
+00011e80: 7072 696d 732e 5379 6d62 6f6c 293a 0a20  prims.Symbol):. 
+00011e90: 2020 2022 2222 4d61 7073 2061 2073 796d     """Maps a sym
+00011ea0: 626f 6c20 746f 2061 204a 5650 2066 756e  bol to a JVP fun
+00011eb0: 6374 696f 6e20 7468 6174 2065 7661 6c75  ction that evalu
+00011ec0: 6174 6573 2069 742e 0a0a 2020 2020 4172  ates it...    Ar
+00011ed0: 6773 3a0a 2020 2020 2020 2020 7379 6d62  gs:.        symb
+00011ee0: 6f6c 2028 7072 696d 732e 5379 6d62 6f6c  ol (prims.Symbol
+00011ef0: 293a 2053 796d 626f 6c20 746f 2065 7661  ): Symbol to eva
+00011f00: 6c75 6174 652e 0a0a 2020 2020 5261 6973  luate...    Rais
+00011f10: 6573 3a0a 2020 2020 2020 2020 4e6f 7449  es:.        NotI
+00011f20: 6d70 6c65 6d65 6e74 6564 4572 726f 723a  mplementedError:
+00011f30: 2049 6620 7468 6520 4a56 5020 666f 7220   If the JVP for 
+00011f40: 7468 6520 7379 6d62 6f6c 2069 7320 6e6f  the symbol is no
+00011f50: 7420 696d 706c 656d 656e 7465 642e 0a0a  t implemented...
+00011f60: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+00011f70: 2020 2020 2043 616c 6c61 626c 653a 204a       Callable: J
+00011f80: 5650 2066 756e 6374 696f 6e20 7468 6174  VP function that
+00011f90: 2065 7661 6c75 6174 6573 2074 6865 2073   evaluates the s
+00011fa0: 796d 626f 6c2e 0a20 2020 2022 2222 0a0a  ymbol..    """..
+00011fb0: 2020 2020 6465 6620 7772 6170 5f61 7267      def wrap_arg
+00011fc0: 2878 293a 0a20 2020 2020 2020 2069 6620  (x):.        if 
+00011fd0: 6973 696e 7374 616e 6365 2878 2c20 4a56  isinstance(x, JV
+00011fe0: 5044 7561 6c29 3a0a 2020 2020 2020 2020  PDual):.        
+00011ff0: 2020 2020 7265 7475 726e 2078 0a20 2020      return x.   
+00012000: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
+00012010: 616e 6365 2878 2c20 4e75 6d62 6572 293a  ance(x, Number):
+00012020: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00012030: 7572 6e20 4a56 5044 7561 6c28 782c 2074  urn JVPDual(x, t
+00012040: 7970 6528 7829 2830 2929 0a20 2020 2020  ype(x)(0)).     
+00012050: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00012060: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00012070: 4572 726f 7228 6622 4a56 5020 7772 6170  Error(f"JVP wrap
+00012080: 5f61 7267 2067 6f74 2061 6e20 756e 7375  _arg got an unsu
+00012090: 7070 6f72 7465 6420 7479 7065 207b 7479  pported type {ty
+000120a0: 7065 2878 297d 2229 0a0a 2020 2020 2320  pe(x)}")..    # 
+000120b0: 4966 2073 796d 626f 6c2e 6172 6773 2064  If symbol.args d
+000120c0: 6f65 736e 2774 2068 6176 6520 7375 6263  oesn't have subc
+000120d0: 6c61 7373 6573 206f 6620 5661 7269 6162  lasses of Variab
+000120e0: 6c65 2c20 7468 656e 2077 6520 6e65 6564  le, then we need
+000120f0: 2074 6f20 7265 7475 726e 2061 207a 6572   to return a zer
+00012100: 6f20 7461 6e67 656e 740a 2020 2020 2320  o tangent.    # 
+00012110: 544f 444f 3a20 7468 6572 6520 6d61 7920  TODO: there may 
+00012120: 6265 2061 2062 6574 7465 7220 7761 7920  be a better way 
+00012130: 746f 2064 6574 6563 7420 636f 6e73 7461  to detect consta
+00012140: 6e74 7320 696e 2074 6865 2074 7261 6365  nts in the trace
+00012150: 0a20 2020 2069 6620 7379 6d62 6f6c 2e61  .    if symbol.a
+00012160: 7265 5f61 6c6c 5f61 7267 735f 636f 6e73  re_all_args_cons
+00012170: 7461 6e74 3a0a 0a20 2020 2020 2020 2064  tant:..        d
+00012180: 6566 207a 6572 6f73 5f6c 696b 6528 7829  ef zeros_like(x)
+00012190: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+000121a0: 2069 7369 6e73 7461 6e63 6528 782c 2054   isinstance(x, T
+000121b0: 656e 736f 7250 726f 7879 293a 0a20 2020  ensorProxy):.   
+000121c0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+000121d0: 7572 6e20 6675 6c6c 5f6c 696b 6528 782c  urn full_like(x,
+000121e0: 2066 696c 6c5f 7661 6c75 653d 3029 0a20   fill_value=0). 
+000121f0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00012200: 6973 696e 7374 616e 6365 2878 2c20 4e75  isinstance(x, Nu
+00012210: 6d62 6572 5072 6f78 7929 3a0a 2020 2020  mberProxy):.    
+00012220: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00012230: 726e 2074 7970 6528 782e 7661 6c75 6529  rn type(x.value)
+00012240: 2830 290a 2020 2020 2020 2020 2020 2020  (0).            
+00012250: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+00012260: 782c 204e 756d 6265 7229 3a0a 2020 2020  x, Number):.    
+00012270: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00012280: 726e 2074 7970 6528 7829 2830 290a 2020  rn type(x)(0).  
+00012290: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000122a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122b0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+000122c0: 2866 227a 6572 6f73 5f6c 696b 6520 696e  (f"zeros_like in
+000122d0: 7369 6465 204a 5650 2067 6f74 2061 6e20  side JVP got an 
+000122e0: 756e 7375 7070 6f72 7465 6420 7479 7065  unsupported type
+000122f0: 207b 7479 7065 2878 297d 2229 0a0a 2020   {type(x)}")..  
+00012300: 2020 2020 2020 6465 6620 6a76 705f 696d        def jvp_im
+00012310: 706c 5f63 6f6e 7374 2873 796d 626f 6c2c  pl_const(symbol,
+00012320: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
+00012330: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
+00012340: 7269 6d61 6c73 203d 2073 796d 626f 6c5f  rimals = symbol_
+00012350: 746f 5f65 7661 6c28 7379 6d62 6f6c 2928  to_eval(symbol)(
+00012360: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+00012370: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00012380: 6973 696e 7374 616e 6365 2870 7269 6d61  isinstance(prima
+00012390: 6c73 2c20 5365 7175 656e 6365 293a 0a20  ls, Sequence):. 
+000123a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000123b0: 616e 6765 6e74 7320 3d20 7475 706c 6528  angents = tuple(
+000123c0: 7a65 726f 735f 6c69 6b65 2870 2920 666f  zeros_like(p) fo
+000123d0: 7220 7020 696e 2070 7269 6d61 6c73 290a  r p in primals).
+000123e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000123f0: 7265 7475 726e 2073 6166 655f 6d61 7028  return safe_map(
+00012400: 7061 6972 5f74 6f5f 6a76 705f 6475 616c  pair_to_jvp_dual
+00012410: 2c20 7361 6665 5f7a 6970 2870 7269 6d61  , safe_zip(prima
+00012420: 6c73 2c20 7461 6e67 656e 7473 2929 0a20  ls, tangents)). 
+00012430: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00012440: 6e20 4a56 5044 7561 6c28 7072 696d 616c  n JVPDual(primal
+00012450: 732c 207a 6572 6f73 5f6c 696b 6528 7072  s, zeros_like(pr
+00012460: 696d 616c 7329 290a 0a20 2020 2020 2020  imals))..       
+00012470: 2072 6574 7572 6e20 7061 7274 6961 6c28   return partial(
+00012480: 6a76 705f 696d 706c 5f63 6f6e 7374 2c20  jvp_impl_const, 
+00012490: 7379 6d62 6f6c 290a 0a20 2020 2023 204e  symbol)..    # N
+000124a0: 6f72 6d61 6c20 6361 7365 2c20 7765 2068  ormal case, we h
+000124b0: 6176 6520 6120 7072 6f78 7920 7461 6e67  ave a proxy tang
+000124c0: 656e 740a 2020 2020 6a76 705f 696d 706c  ent.    jvp_impl
+000124d0: 203d 206a 7670 5f69 6d70 6c73 2e67 6574   = jvp_impls.get
+000124e0: 2873 796d 626f 6c2e 7379 6d2e 6964 290a  (symbol.sym.id).
+000124f0: 2020 2020 6966 206a 7670 5f69 6d70 6c20      if jvp_impl 
+00012500: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00012510: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
+00012520: 656e 7465 6445 7272 6f72 2866 224a 5650  entedError(f"JVP
+00012530: 2066 6f72 207b 7379 6d62 6f6c 2e73 796d   for {symbol.sym
+00012540: 2e69 647d 2069 7320 6e6f 7420 696d 706c  .id} is not impl
+00012550: 656d 656e 7465 6422 290a 0a20 2020 2064  emented")..    d
+00012560: 6566 205f 6a76 705f 696d 706c 282a 6172  ef _jvp_impl(*ar
+00012570: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+00012580: 2020 2020 2020 2061 7267 7320 3d20 7472         args = tr
+00012590: 6565 5f6d 6170 2877 7261 705f 6172 672c  ee_map(wrap_arg,
+000125a0: 2061 7267 7329 0a20 2020 2020 2020 2023   args).        #
+000125b0: 2045 7870 6563 7469 6e67 204a 5650 4475   Expecting JVPDu
+000125c0: 616c 7320 7772 6170 7069 6e67 2070 6169  als wrapping pai
+000125d0: 7273 206f 6620 7072 696d 616c 7320 616e  rs of primals an
+000125e0: 6420 7461 6e67 656e 7473 0a20 2020 2020  d tangents.     
+000125f0: 2020 2061 7373 6572 7420 616c 6c28 6973     assert all(is
+00012600: 696e 7374 616e 6365 2861 7267 2c20 4a56  instance(arg, JV
+00012610: 5044 7561 6c29 2066 6f72 2061 7267 2069  PDual) for arg i
+00012620: 6e20 7472 6565 5f66 6c61 7474 656e 2861  n tree_flatten(a
+00012630: 7267 7329 5b30 5d29 0a20 2020 2020 2020  rgs)[0]).       
+00012640: 2072 6574 7572 6e20 6a76 705f 696d 706c   return jvp_impl
+00012650: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
+00012660: 290a 0a20 2020 2072 6574 7572 6e20 5f6a  )..    return _j
+00012670: 7670 5f69 6d70 6c0a 0a0a 6465 6620 5f6a  vp_impl...def _j
+00012680: 7670 5f63 616c 6c5f 6d65 7461 6675 6e63  vp_call_metafunc
+00012690: 2864 6574 6163 6865 643a 2062 6f6f 6c2c  (detached: bool,
+000126a0: 2070 7269 6d61 6c73 2c20 7461 6e67 656e   primals, tangen
+000126b0: 7473 2c20 2a2c 2066 756e 6374 696f 6e5f  ts, *, function_
+000126c0: 7472 6163 653a 2054 7261 6365 2c20 2a2a  trace: Trace, **
+000126d0: 6b77 6172 6773 293a 0a20 2020 2022 2222  kwargs):.    """
+000126e0: 4d65 7461 6675 6e63 7469 6f6e 2066 6f72  Metafunction for
+000126f0: 2074 6865 204a 5650 2074 7261 6e73 666f   the JVP transfo
+00012700: 726d 2e0a 0a20 2020 2041 7267 733a 0a20  rm...    Args:. 
+00012710: 2020 2020 2020 2064 6574 6163 6865 6420         detached 
+00012720: 2862 6f6f 6c29 3a20 5768 6574 6865 7220  (bool): Whether 
+00012730: 746f 2064 6574 6163 6820 7468 6520 7472  to detach the tr
+00012740: 6163 652e 0a20 2020 2020 2020 2070 7269  ace..        pri
+00012750: 6d61 6c73 2028 5475 706c 655b 5072 6f78  mals (Tuple[Prox
+00012760: 795d 293a 2050 7269 6d61 6c20 7661 6c75  y]): Primal valu
+00012770: 6573 2e0a 2020 2020 2020 2020 7461 6e67  es..        tang
+00012780: 656e 7473 2028 5475 706c 655b 5072 6f78  ents (Tuple[Prox
+00012790: 795d 293a 2054 616e 6765 6e74 2076 616c  y]): Tangent val
+000127a0: 7565 732e 0a20 2020 2020 2020 2066 756e  ues..        fun
+000127b0: 6374 696f 6e5f 7472 6163 6520 2854 7261  ction_trace (Tra
+000127c0: 6365 293a 2054 7261 6365 206f 6620 7468  ce): Trace of th
+000127d0: 6520 6675 6e63 7469 6f6e 2074 6f20 6265  e function to be
+000127e0: 2074 7261 6e73 666f 726d 6564 2e0a 2020   transformed..  
+000127f0: 2020 2020 2020 6b77 6172 6773 3a20 4b65        kwargs: Ke
+00012800: 7977 6f72 6420 6172 6775 6d65 6e74 732e  yword arguments.
+00012810: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
+00012820: 2020 2020 2020 4173 7365 7274 696f 6e45        AssertionE
+00012830: 7272 6f72 3a20 4966 2074 6865 204a 5650  rror: If the JVP
+00012840: 2066 6f72 206b 6579 776f 7264 2061 7267   for keyword arg
+00012850: 756d 656e 7473 2069 7320 6e6f 7420 696d  uments is not im
+00012860: 706c 656d 656e 7465 642e 0a0a 2020 2020  plemented...    
+00012870: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+00012880: 2052 6573 756c 7420 6f66 2074 6865 204a   Result of the J
+00012890: 5650 2074 7261 6e73 666f 726d 2e0a 2020  VP transform..  
+000128a0: 2020 2222 220a 2020 2020 6173 7365 7274    """.    assert
+000128b0: 206c 656e 286b 7761 7267 7329 203d 3d20   len(kwargs) == 
+000128c0: 302c 2022 4a56 5020 666f 7220 6b77 6172  0, "JVP for kwar
+000128d0: 6773 2069 7320 6e6f 7420 696d 706c 656d  gs is not implem
+000128e0: 656e 7465 6422 0a0a 2020 2020 6374 7820  ented"..    ctx 
+000128f0: 3d20 6465 7461 6368 6564 5f74 7261 6365  = detached_trace
+00012900: 2829 2069 6620 6465 7461 6368 6564 2065  () if detached e
+00012910: 6c73 6520 6e75 6c6c 636f 6e74 6578 7428  lse nullcontext(
+00012920: 290a 2020 2020 7769 7468 2063 7478 3a0a  ).    with ctx:.
+00012930: 2020 2020 2020 2020 2320 5772 6170 7069          # Wrappi
+00012940: 6e67 2074 6865 2070 7269 6d61 6c73 2061  ng the primals a
+00012950: 6e64 2074 616e 6765 6e74 7320 696e 204a  nd tangents in J
+00012960: 5650 4475 616c 7320 6973 206e 6f74 2073  VPDuals is not s
+00012970: 7472 6963 746c 7920 6e65 6365 7373 6172  trictly necessar
+00012980: 792c 2062 7574 2069 7420 6d61 6b65 730a  y, but it makes.
+00012990: 2020 2020 2020 2020 2320 7468 6520 636f          # the co
+000129a0: 6465 206d 6f72 6520 7265 6164 6162 6c65  de more readable
+000129b0: 0a20 2020 2020 2020 2023 2057 6520 7072  .        # We pr
+000129c0: 6f70 6167 6174 6520 7468 6520 4a56 5044  opagate the JVPD
+000129d0: 7561 6c73 2074 6872 6f75 6768 2074 6865  uals through the
+000129e0: 2074 7261 6365 2c20 616e 6420 7468 656e   trace, and then
+000129f0: 2075 6e77 7261 7020 7468 656d 2061 7420   unwrap them at 
+00012a00: 7468 6520 656e 640a 2020 2020 2020 2020  the end.        
+00012a10: 7072 696d 616c 735f 7461 6e67 656e 7473  primals_tangents
+00012a20: 5f64 7561 6c73 203d 2073 6166 655f 6d61  _duals = safe_ma
+00012a30: 7028 7061 6972 5f74 6f5f 6a76 705f 6475  p(pair_to_jvp_du
+00012a40: 616c 2c20 7361 6665 5f7a 6970 2870 7269  al, safe_zip(pri
+00012a50: 6d61 6c73 2c20 7461 6e67 656e 7473 2929  mals, tangents))
+00012a60: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
+00012a70: 3d20 6576 616c 5f74 7261 6365 2866 756e  = eval_trace(fun
+00012a80: 6374 696f 6e5f 7472 6163 652c 202a 7072  ction_trace, *pr
+00012a90: 696d 616c 735f 7461 6e67 656e 7473 5f64  imals_tangents_d
+00012aa0: 7561 6c73 2c20 7379 6d62 6f6c 5f6d 6170  uals, symbol_map
+00012ab0: 7065 723d 6a76 705f 7379 6d62 6f6c 5f6d  per=jvp_symbol_m
+00012ac0: 6170 7065 7229 0a20 2020 2020 2020 2023  apper).        #
+00012ad0: 2055 6e77 7261 7070 696e 6720 7468 6520   Unwrapping the 
+00012ae0: 4a56 5044 7561 6c73 0a20 2020 2020 2020  JVPDuals.       
+00012af0: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
+00012b00: 6573 756c 742c 2053 6571 7565 6e63 6529  esult, Sequence)
+00012b10: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+00012b20: 7365 7274 2061 6c6c 2869 7369 6e73 7461  sert all(isinsta
+00012b30: 6e63 6528 782c 204a 5650 4475 616c 2920  nce(x, JVPDual) 
+00012b40: 666f 7220 7820 696e 2072 6573 756c 7429  for x in result)
+00012b50: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+00012b60: 6d61 6c73 2c20 7461 6e67 656e 7473 203d  mals, tangents =
+00012b70: 2075 6e7a 6970 3228 7265 7375 6c74 290a   unzip2(result).
+00012b80: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00012b90: 726e 2070 7269 6d61 6c73 2c20 7461 6e67  rn primals, tang
+00012ba0: 656e 7473 0a20 2020 2020 2020 2061 7373  ents.        ass
+00012bb0: 6572 7420 6973 696e 7374 616e 6365 2872  ert isinstance(r
+00012bc0: 6573 756c 742c 204a 5650 4475 616c 290a  esult, JVPDual).
+00012bd0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+00012be0: 6573 756c 742e 7072 696d 616c 2c20 7265  esult.primal, re
+00012bf0: 7375 6c74 2e74 616e 6765 6e74 0a0a 0a6a  sult.tangent...j
+00012c00: 7670 5f63 616c 6c20 3d20 5379 6d62 6f6c  vp_call = Symbol
+00012c10: 2869 643d 5472 616e 7366 6f72 6d73 2e4a  (id=Transforms.J
+00012c20: 7670 4f70 2c20 6e61 6d65 3d22 6a76 705f  vpOp, name="jvp_
+00012c30: 6361 6c6c 222c 206d 6574 613d 7061 7274  call", meta=part
+00012c40: 6961 6c28 5f6a 7670 5f63 616c 6c5f 6d65  ial(_jvp_call_me
+00012c50: 7461 6675 6e63 2c20 4661 6c73 6529 290a  tafunc, False)).
+00012c60: 0a0a 6465 6620 5f69 6465 6e74 6974 795f  ..def _identity_
+00012c70: 6361 6c6c 5f6a 7670 282a 6172 6773 3a20  call_jvp(*args: 
+00012c80: 4a56 5044 7561 6c2c 2074 7261 6365 3a20  JVPDual, trace: 
+00012c90: 5472 6163 652c 202a 2a6b 7761 7267 7329  Trace, **kwargs)
+00012ca0: 3a0a 2020 2020 7072 696d 616c 732c 2074  :.    primals, t
+00012cb0: 616e 6765 6e74 7320 3d20 756e 7a69 7032  angents = unzip2
+00012cc0: 2861 7267 7329 0a20 2020 206f 7574 5f70  (args).    out_p
+00012cd0: 7269 6d61 6c73 2c20 6f75 745f 7461 6e67  rimals, out_tang
+00012ce0: 656e 7473 203d 205f 6a76 705f 6361 6c6c  ents = _jvp_call
+00012cf0: 5f6d 6574 6166 756e 6328 4661 6c73 652c  _metafunc(False,
+00012d00: 2070 7269 6d61 6c73 2c20 7461 6e67 656e   primals, tangen
+00012d10: 7473 2c20 7472 6163 652c 202a 2a6b 7761  ts, trace, **kwa
+00012d20: 7267 7329 0a20 2020 2069 6620 6973 696e  rgs).    if isin
+00012d30: 7374 616e 6365 286f 7574 5f70 7269 6d61  stance(out_prima
+00012d40: 6c73 2c20 5365 7175 656e 6365 293a 0a20  ls, Sequence):. 
+00012d50: 2020 2020 2020 2072 6574 7572 6e20 7361         return sa
+00012d60: 6665 5f6d 6170 2870 6169 725f 746f 5f6a  fe_map(pair_to_j
+00012d70: 7670 5f64 7561 6c2c 2073 6166 655f 7a69  vp_dual, safe_zi
+00012d80: 7028 6f75 745f 7072 696d 616c 732c 206f  p(out_primals, o
+00012d90: 7574 5f74 616e 6765 6e74 7329 290a 2020  ut_tangents)).  
+00012da0: 2020 7265 7475 726e 204a 5650 4475 616c    return JVPDual
+00012db0: 286f 7574 5f70 7269 6d61 6c73 2c20 6f75  (out_primals, ou
+00012dc0: 745f 7461 6e67 656e 7473 290a 0a0a 6a76  t_tangents)...jv
+00012dd0: 705f 696d 706c 735b 5472 616e 7366 6f72  p_impls[Transfor
+00012de0: 6d73 2e49 6465 6e74 6974 794f 705d 203d  ms.IdentityOp] =
+00012df0: 205f 6964 656e 7469 7479 5f63 616c 6c5f   _identity_call_
+00012e00: 6a76 700a 0a0a 6465 6620 5f76 6d61 705f  jvp...def _vmap_
+00012e10: 6361 6c6c 5f6a 7670 2861 7267 733a 204a  call_jvp(args: J
+00012e20: 5650 4475 616c 2c20 696e 5f64 696d 732c  VPDual, in_dims,
+00012e30: 206f 7574 5f64 696d 732c 2061 7869 735f   out_dims, axis_
+00012e40: 7369 7a65 2c20 7472 6163 653a 2054 7261  size, trace: Tra
+00012e50: 6365 2c20 2a2a 6b77 6172 6773 293a 0a20  ce, **kwargs):. 
+00012e60: 2020 2070 7269 6d61 6c73 2c20 7461 6e67     primals, tang
+00012e70: 656e 7473 203d 2073 6166 655f 7a69 7028  ents = safe_zip(
+00012e80: 2a61 7267 7329 0a20 2020 2069 6e5f 6469  *args).    in_di
+00012e90: 6d73 2c20 5f20 3d20 7361 6665 5f7a 6970  ms, _ = safe_zip
+00012ea0: 282a 696e 5f64 696d 7329 0a20 2020 206f  (*in_dims).    o
+00012eb0: 7574 5f64 696d 732c 205f 203d 2073 6166  ut_dims, _ = saf
+00012ec0: 655f 7a69 7028 2a6f 7574 5f64 696d 7329  e_zip(*out_dims)
+00012ed0: 0a20 2020 2076 6d61 7070 6564 5f74 7261  .    vmapped_tra
+00012ee0: 6365 203d 2063 6f6e 7374 7275 6374 5f74  ce = construct_t
+00012ef0: 7261 6365 2829 280a 2020 2020 2020 2020  race()(.        
+00012f00: 766d 6170 2870 6172 7469 616c 2865 7661  vmap(partial(eva
+00012f10: 6c5f 7472 6163 652c 2074 7261 6365 292c  l_trace, trace),
+00012f20: 2069 6e5f 6469 6d73 3d69 6e5f 6469 6d73   in_dims=in_dims
+00012f30: 2c20 6f75 745f 6469 6d73 3d6f 7574 5f64  , out_dims=out_d
+00012f40: 696d 732c 2061 7869 735f 7369 7a65 3d61  ims, axis_size=a
+00012f50: 7869 735f 7369 7a65 292c 202a 7072 696d  xis_size), *prim
+00012f60: 616c 730a 2020 2020 290a 2020 2020 766d  als.    ).    vm
+00012f70: 6170 7065 645f 6675 6e63 203d 2070 6172  apped_func = par
+00012f80: 7469 616c 2865 7661 6c5f 7472 6163 652c  tial(eval_trace,
+00012f90: 2076 6d61 7070 6564 5f74 7261 6365 290a   vmapped_trace).
+00012fa0: 2020 2020 6f75 745f 7072 696d 616c 732c      out_primals,
+00012fb0: 206f 7574 5f74 616e 6765 6e74 7320 3d20   out_tangents = 
+00012fc0: 6a76 7028 766d 6170 7065 645f 6675 6e63  jvp(vmapped_func
+00012fd0: 2928 7072 696d 616c 732c 2074 616e 6765  )(primals, tange
+00012fe0: 6e74 732c 202a 2a6b 7761 7267 7329 0a20  nts, **kwargs). 
+00012ff0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00013000: 286f 7574 5f70 7269 6d61 6c73 2c20 5365  (out_primals, Se
+00013010: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
+00013020: 2072 6574 7572 6e20 7361 6665 5f6d 6170   return safe_map
+00013030: 2870 6169 725f 746f 5f6a 7670 5f64 7561  (pair_to_jvp_dua
+00013040: 6c2c 2073 6166 655f 7a69 7028 6f75 745f  l, safe_zip(out_
+00013050: 7072 696d 616c 732c 206f 7574 5f74 616e  primals, out_tan
+00013060: 6765 6e74 7329 290a 2020 2020 7265 7475  gents)).    retu
+00013070: 726e 204a 5650 4475 616c 286f 7574 5f70  rn JVPDual(out_p
+00013080: 7269 6d61 6c73 2c20 6f75 745f 7461 6e67  rimals, out_tang
+00013090: 656e 7473 290a 0a0a 6a76 705f 696d 706c  ents)...jvp_impl
+000130a0: 735b 5472 616e 7366 6f72 6d73 2e56 6d61  s[Transforms.Vma
+000130b0: 704f 705d 203d 205f 766d 6170 5f63 616c  pOp] = _vmap_cal
+000130c0: 6c5f 6a76 700a 0a0a 6465 6620 6a76 7028  l_jvp...def jvp(
+000130d0: 6675 6e63 293a 0a20 2020 2022 2222 4a61  func):.    """Ja
+000130e0: 636f 6269 616e 2d76 6563 746f 7220 7072  cobian-vector pr
+000130f0: 6f64 7563 7420 7472 616e 7366 6f72 6d20  oduct transform 
+00013100: 666f 7220 6120 5468 756e 6465 7220 6675  for a Thunder fu
+00013110: 6e63 7469 6f6e 2e0a 0a20 2020 2041 7267  nction...    Arg
+00013120: 733a 0a20 2020 2020 2020 2066 756e 6320  s:.        func 
+00013130: 2843 616c 6c61 626c 6529 3a20 4120 5468  (Callable): A Th
+00013140: 756e 6465 7220 6675 6e63 7469 6f6e 2074  under function t
+00013150: 6f20 6265 2074 7261 6e73 666f 726d 6564  o be transformed
+00013160: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+00013170: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
+00013180: 3a20 4120 6675 6e63 7469 6f6e 2074 6861  : A function tha
+00013190: 7420 636f 6d70 7574 6573 2074 6865 204a  t computes the J
+000131a0: 6163 6f62 6961 6e2d 7665 6374 6f72 2070  acobian-vector p
+000131b0: 726f 6475 6374 0a20 2020 2020 2020 2020  roduct.         
+000131c0: 2020 2074 616b 696e 6720 7072 696d 616c     taking primal
+000131d0: 7320 616e 6420 7461 6e67 656e 7473 2061  s and tangents a
+000131e0: 7320 6172 6775 6d65 6e74 732e 0a20 2020  s arguments..   
+000131f0: 2022 2222 0a0a 2020 2020 6465 6620 7772   """..    def wr
+00013200: 6170 7065 7228 7072 696d 616c 732c 2074  apper(primals, t
+00013210: 616e 6765 6e74 7329 3a0a 2020 2020 2020  angents):.      
+00013220: 2020 7472 6163 6520 3d20 636f 6e73 7472    trace = constr
+00013230: 7563 745f 7472 6163 6528 2928 6675 6e63  uct_trace()(func
+00013240: 2c20 2a70 7269 6d61 6c73 290a 2020 2020  , *primals).    
+00013250: 2020 2020 7265 7475 726e 206a 7670 5f63      return jvp_c
+00013260: 616c 6c28 7072 696d 616c 732c 2074 616e  all(primals, tan
+00013270: 6765 6e74 732c 2066 756e 6374 696f 6e5f  gents, function_
+00013280: 7472 6163 653d 7472 6163 6529 0a0a 2020  trace=trace)..  
+00013290: 2020 7265 7475 726e 2077 7261 7070 6572    return wrapper
+000132a0: 0a0a 0a23 2054 4f44 4f20 5468 6973 2066  ...# TODO This f
+000132b0: 756e 6374 696f 6e20 636f 6d6d 656e 7465  unction commente
+000132c0: 6420 6f75 7420 6265 6361 7573 6520 6974  d out because it
+000132d0: 2063 616c 6c73 206d 616b 655f 7472 6163   calls make_trac
+000132e0: 6564 2c20 7768 6963 6820 646f 6573 206e  ed, which does n
+000132f0: 6f74 2065 7869 7374 0a23 2064 6566 206a  ot exist.# def j
+00013300: 7670 5f65 6167 6572 2866 756e 632c 2070  vp_eager(func, p
+00013310: 7269 6d61 6c73 2c20 7461 6e67 656e 7473  rimals, tangents
+00013320: 2c20 6578 6563 7574 6f72 3d22 746f 7263  , executor="torc
+00013330: 6822 293a 0a23 2020 2020 2022 2222 436f  h"):.#     """Co
+00013340: 6d70 7574 6573 2074 6865 204a 6163 6f62  mputes the Jacob
+00013350: 6961 6e2d 7665 6374 6f72 2070 726f 6475  ian-vector produ
+00013360: 6374 206f 6620 6120 5468 756e 6465 7220  ct of a Thunder 
+00013370: 6675 6e63 7469 6f6e 2e0a 0a23 2020 2020  function...#    
+00013380: 2041 7267 733a 0a23 2020 2020 2020 2020   Args:.#        
+00013390: 2066 756e 6320 2843 616c 6c61 626c 6529   func (Callable)
+000133a0: 3a20 4120 5468 756e 6465 7220 6675 6e63  : A Thunder func
+000133b0: 7469 6f6e 2074 6f20 6265 2074 7261 6e73  tion to be trans
+000133c0: 666f 726d 6564 2e0a 2320 2020 2020 2020  formed..#       
+000133d0: 2020 7072 696d 616c 7320 285f 7479 7065    primals (_type
+000133e0: 5f29 3a20 5072 696d 616c 7320 6f66 2074  _): Primals of t
+000133f0: 6865 2066 756e 6374 696f 6e2e 0a23 2020  he function..#  
+00013400: 2020 2020 2020 2074 616e 6765 6e74 7320         tangents 
+00013410: 285f 7479 7065 5f29 3a20 5461 6e67 656e  (_type_): Tangen
+00013420: 7473 206f 6620 7468 6520 6675 6e63 7469  ts of the functi
+00013430: 6f6e 2e0a 2320 2020 2020 2020 2020 6578  on..#         ex
+00013440: 6563 7574 6f72 2028 7374 722c 206f 7074  ecutor (str, opt
+00013450: 696f 6e61 6c29 3a20 4578 6563 7574 6f72  ional): Executor
+00013460: 2074 6f20 7573 652e 2044 6566 6175 6c74   to use. Default
+00013470: 7320 746f 2022 746f 7263 6822 2e0a 0a23  s to "torch"...#
+00013480: 2020 2020 2052 6574 7572 6e73 3a0a 2320       Returns:.# 
+00013490: 2020 2020 2020 2020 5468 6520 7265 7375          The resu
+000134a0: 6c74 206f 6620 7468 6520 4a61 636f 6269  lt of the Jacobi
+000134b0: 616e 2d76 6563 746f 7220 7072 6f64 7563  an-vector produc
+000134c0: 742e 0a23 2020 2020 2022 2222 0a23 2020  t..#     """.#  
+000134d0: 2020 2074 7261 6365 203d 206d 616b 655f     trace = make_
+000134e0: 7472 6163 6528 6675 6e63 2c20 6578 6563  trace(func, exec
+000134f0: 7574 6f72 3d65 7865 6375 746f 722c 202a  utor=executor, *
+00013500: 7072 696d 616c 7329 0a0a 2320 2020 2020  primals)..#     
+00013510: 6465 6620 6a76 705f 6675 6e63 282a 7072  def jvp_func(*pr
+00013520: 696d 616c 735f 616e 645f 7461 6e67 656e  imals_and_tangen
+00013530: 7473 293a 0a23 2020 2020 2020 2020 205f  ts):.#         _
+00013540: 7072 696d 616c 732c 205f 7461 6e67 656e  primals, _tangen
+00013550: 7473 203d 2070 7269 6d61 6c73 5f61 6e64  ts = primals_and
+00013560: 5f74 616e 6765 6e74 735b 3a20 6c65 6e28  _tangents[: len(
+00013570: 7072 696d 616c 7329 5d2c 2070 7269 6d61  primals)], prima
+00013580: 6c73 5f61 6e64 5f74 616e 6765 6e74 735b  ls_and_tangents[
+00013590: 6c65 6e28 7072 696d 616c 7329 203a 5d0a  len(primals) :].
+000135a0: 2320 2020 2020 2020 2020 7265 7475 726e  #         return
+000135b0: 205f 6a76 705f 6361 6c6c 5f6d 6574 6166   _jvp_call_metaf
+000135c0: 756e 6328 5f70 7269 6d61 6c73 2c20 5f74  unc(_primals, _t
+000135d0: 616e 6765 6e74 732c 2074 7261 6365 2c20  angents, trace, 
+000135e0: 6465 7461 6368 6564 3d46 616c 7365 290a  detached=False).
+000135f0: 0a23 2020 2020 206a 7670 5f74 7261 6365  .#     jvp_trace
+00013600: 203d 206d 616b 655f 7472 6163 6528 6a76   = make_trace(jv
+00013610: 705f 6675 6e63 2c20 6578 6563 7574 6f72  p_func, executor
+00013620: 3d65 7865 6375 746f 7229 282a 7072 696d  =executor)(*prim
+00013630: 616c 732c 202a 7461 6e67 656e 7473 290a  als, *tangents).
+00013640: 2320 2020 2020 6a76 705f 7472 6163 6564  #     jvp_traced
+00013650: 203d 206d 616b 655f 7472 6163 6564 2870   = make_traced(p
+00013660: 6172 7469 616c 2865 7661 6c5f 7472 6163  artial(eval_trac
+00013670: 652c 206a 7670 5f74 7261 6365 292c 2065  e, jvp_trace), e
+00013680: 7865 6375 746f 723d 6578 6563 7574 6f72  xecutor=executor
+00013690: 290a 2320 2020 2020 7265 7475 726e 206a  ).#     return j
+000136a0: 7670 5f74 7261 6365 6428 2a70 7269 6d61  vp_traced(*prima
+000136b0: 6c73 2c20 2a74 616e 6765 6e74 7329 0a0a  ls, *tangents)..
+000136c0: 0a23 2056 4a50 2074 7261 6e73 666f 726d  .# VJP transform
+000136d0: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
+000136e0: 0a40 6461 7461 636c 6173 7328 6672 6f7a  .@dataclass(froz
+000136f0: 656e 3d54 7275 6529 0a63 6c61 7373 2056  en=True).class V
+00013700: 4a50 4475 616c 3a0a 2020 2020 2222 2241  JPDual:.    """A
+00013710: 2070 6169 7220 6f66 2070 7269 6d61 6c20   pair of primal 
+00013720: 616e 6420 7361 7665 6420 696e 666f 726d  and saved inform
+00013730: 6174 696f 6e20 666f 7220 6261 636b 7761  ation for backwa
+00013740: 7264 2028 7265 7369 6475 616c 7329 2e0a  rd (residuals)..
+00013750: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+00013760: 2020 2070 7269 6d61 6c20 2855 6e69 6f6e     primal (Union
+00013770: 5b50 726f 7879 2c20 4e75 6d62 6572 5d29  [Proxy, Number])
+00013780: 3a20 5072 696d 616c 2076 616c 7565 2c20  : Primal value, 
+00013790: 692e 652e 2c20 7468 6520 7661 6c75 6520  i.e., the value 
+000137a0: 6265 696e 6720 6469 6666 6572 656e 7469  being differenti
+000137b0: 6174 6564 2e0a 2020 2020 2020 2020 7265  ated..        re
+000137c0: 7369 6475 616c 7320 2854 7570 6c65 5b50  siduals (Tuple[P
+000137d0: 726f 7879 2c20 2e2e 2e5d 293a 2052 6573  roxy, ...]): Res
+000137e0: 6964 7561 6c73 2c20 692e 652e 2c20 7468  iduals, i.e., th
+000137f0: 6520 7661 6c75 6573 2074 6861 7420 6172  e values that ar
+00013800: 650a 2020 2020 2020 2020 2020 2020 7361  e.            sa
+00013810: 7665 6420 666f 7220 7468 6520 6261 636b  ved for the back
+00013820: 7761 7264 2e0a 0a20 2020 2059 6965 6c64  ward...    Yield
+00013830: 733a 0a20 2020 2020 2020 2054 7570 6c65  s:.        Tuple
+00013840: 5b56 6172 6961 626c 652c 2054 7570 6c65  [Variable, Tuple
+00013850: 5b56 6172 6961 626c 652c 202e 2e2e 5d2c  [Variable, ...],
+00013860: 2043 616c 6c61 626c 655d 3a20 5072 696d   Callable]: Prim
+00013870: 616c 2061 6e64 2072 6573 6964 7561 6c73  al and residuals
+00013880: 0a20 2020 2022 2222 0a0a 2020 2020 7072  .    """..    pr
+00013890: 696d 616c 3a20 5072 6f78 7920 7c20 4e75  imal: Proxy | Nu
+000138a0: 6d62 6572 0a20 2020 2072 6573 6964 7561  mber.    residua
+000138b0: 6c73 3a20 7475 706c 655b 5072 6f78 792c  ls: tuple[Proxy,
+000138c0: 202e 2e2e 5d0a 0a20 2020 2064 6566 205f   ...]..    def _
+000138d0: 5f69 7465 725f 5f28 7365 6c66 293a 0a20  _iter__(self):. 
+000138e0: 2020 2020 2020 2079 6965 6c64 2073 656c         yield sel
+000138f0: 662e 7072 696d 616c 0a20 2020 2020 2020  f.primal.       
+00013900: 2079 6965 6c64 2073 656c 662e 7265 7369   yield self.resi
+00013910: 6475 616c 730a 0a0a 636c 6173 7320 4e6f  duals...class No
+00013920: 5075 6c6c 6261 636b 3a0a 2020 2020 2222  Pullback:.    ""
+00013930: 2241 2064 756d 6d79 2070 756c 6c62 6163  "A dummy pullbac
+00013940: 6b20 6675 6e63 7469 6f6e 2074 6861 7420  k function that 
+00013950: 7265 7475 726e 7320 4e6f 6e65 206f 7220  returns None or 
+00013960: 7261 6973 6573 2061 6e20 6572 726f 722e  raises an error.
+00013970: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
+00013980: 6e69 745f 5f28 7365 6c66 2c20 6e75 6d5f  nit__(self, num_
+00013990: 6172 6773 3d30 293a 0a20 2020 2020 2020  args=0):.       
+000139a0: 2073 656c 662e 6e75 6d5f 6172 6773 203d   self.num_args =
+000139b0: 206e 756d 5f61 7267 730a 0a20 2020 2064   num_args..    d
+000139c0: 6566 205f 5f63 616c 6c5f 5f28 7365 6c66  ef __call__(self
+000139d0: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
+000139e0: 7329 3a0a 2020 2020 2020 2020 6966 2073  s):.        if s
+000139f0: 656c 662e 6e75 6d5f 6172 6773 203e 2030  elf.num_args > 0
+00013a00: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00013a10: 7475 726e 2028 4e6f 6e65 2c29 202a 2073  turn (None,) * s
+00013a20: 656c 662e 6e75 6d5f 6172 6773 0a20 2020  elf.num_args.   
+00013a30: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
+00013a40: 6d65 4572 726f 7228 2250 756c 6c62 6163  meError("Pullbac
+00013a50: 6b20 6361 6c6c 6564 206f 6e20 6120 6e6f  k called on a no
+00013a60: 6e2d 6469 6666 6572 656e 7469 6162 6c65  n-differentiable
+00013a70: 2073 796d 626f 6c20 6f72 2061 2063 6f6e   symbol or a con
+00013a80: 7374 616e 742e 2229 0a0a 0a63 6c61 7373  stant.")...class
+00013a90: 205a 6572 6f42 6163 6b77 6172 643a 0a20   ZeroBackward:. 
+00013aa0: 2020 2022 2222 4120 6865 6c70 6572 2062     """A helper b
+00013ab0: 6163 6b77 6172 6420 6675 6e63 7469 6f6e  ackward function
+00013ac0: 2074 6861 7420 7265 7475 726e 7320 7a65   that returns ze
+00013ad0: 726f 732e 2222 220a 0a20 2020 2064 6566  ros."""..    def
+00013ae0: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00013af0: 6e75 6d5f 6172 6773 293a 0a20 2020 2020  num_args):.     
+00013b00: 2020 2073 656c 662e 6e75 6d5f 6172 6773     self.num_args
+00013b10: 203d 206e 756d 5f61 7267 730a 0a20 2020   = num_args..   
+00013b20: 2064 6566 205f 5f63 616c 6c5f 5f28 7365   def __call__(se
+00013b30: 6c66 2c20 2a61 7267 732c 202a 2a6b 7761  lf, *args, **kwa
+00013b40: 7267 7329 3a0a 2020 2020 2020 2020 2320  rgs):.        # 
+00013b50: 4173 7375 6d69 6e67 2074 6861 7420 7468  Assuming that th
+00013b60: 6520 6669 7273 7420 6172 6775 6d65 6e74  e first argument
+00013b70: 7320 6172 6520 7468 6520 666f 7277 6172  s are the forwar
+00013b80: 6420 6172 6775 6d65 6e74 730a 2020 2020  d arguments.    
+00013b90: 2020 2020 666f 7277 6172 645f 6172 6773      forward_args
+00013ba0: 203d 2061 7267 735b 3a20 7365 6c66 2e6e   = args[: self.n
+00013bb0: 756d 5f61 7267 735d 0a0a 2020 2020 2020  um_args]..      
+00013bc0: 2020 6465 6620 7a65 726f 735f 6c69 6b65    def zeros_like
+00013bd0: 2878 293a 0a20 2020 2020 2020 2020 2020  (x):.           
+00013be0: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
+00013bf0: 2c20 5465 6e73 6f72 5072 6f78 7929 3a0a  , TensorProxy):.
+00013c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013c10: 7265 7475 726e 2066 756c 6c5f 6c69 6b65  return full_like
+00013c20: 2878 2c20 6669 6c6c 5f76 616c 7565 3d30  (x, fill_value=0
+00013c30: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00013c40: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
+00013c50: 204e 756d 6265 7250 726f 7879 293a 0a20   NumberProxy):. 
+00013c60: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00013c70: 6574 7572 6e20 7479 7065 2878 2e76 616c  eturn type(x.val
+00013c80: 7565 2928 3029 0a20 2020 2020 2020 2020  ue)(0).         
+00013c90: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+00013ca0: 6365 2878 2c20 4e75 6d62 6572 293a 0a20  ce(x, Number):. 
+00013cb0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00013cc0: 6574 7572 6e20 7479 7065 2878 2928 3029  eturn type(x)(0)
+00013cd0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00013ce0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00013cf0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00013d00: 726f 7228 6622 7a65 726f 735f 6c69 6b65  ror(f"zeros_like
+00013d10: 2069 6e73 6964 6520 5a65 726f 4261 636b   inside ZeroBack
+00013d20: 7761 7264 2067 6f74 2061 6e20 756e 7375  ward got an unsu
+00013d30: 7070 6f72 7465 6420 7479 7065 207b 7479  pported type {ty
+00013d40: 7065 2878 297d 2229 0a0a 2020 2020 2020  pe(x)}")..      
+00013d50: 2020 7265 7475 726e 2074 7570 6c65 287a    return tuple(z
+00013d60: 6572 6f73 5f6c 696b 6528 6172 6729 2066  eros_like(arg) f
+00013d70: 6f72 2061 7267 2069 6e20 666f 7277 6172  or arg in forwar
+00013d80: 645f 6172 6773 290a 0a0a 2320 4d61 7070  d_args)...# Mapp
+00013d90: 696e 6720 6672 6f6d 2073 796d 626f 6c73  ing from symbols
+00013da0: 2074 6f20 6175 676d 656e 7465 6420 7072   to augmented pr
+00013db0: 696d 616c 2028 666f 7277 6172 6429 2066  imal (forward) f
+00013dc0: 756e 6374 696f 6e73 2075 7365 6420 696e  unctions used in
+00013dd0: 2056 4a50 0a23 2054 6865 2061 7567 6d65   VJP.# The augme
+00013de0: 6e74 6564 5f70 7269 6d61 6c20 6675 6e63  nted_primal func
+00013df0: 7469 6f6e 2074 616b 6573 2074 6865 2070  tion takes the p
+00013e00: 7269 6d61 6c20 7661 6c75 6573 2061 6e64  rimal values and
+00013e10: 2072 6574 7572 6e73 2074 6865 2070 7269   returns the pri
+00013e20: 6d61 6c0a 2320 7265 7375 6c74 2061 6e64  mal.# result and
+00013e30: 2074 6865 2072 6573 6964 7561 6c73 2028   the residuals (
+00013e40: 7361 7665 6420 7661 6c75 6573 2066 6f72  saved values for
+00013e50: 2074 6865 2062 6163 6b77 6172 6429 2e0a   the backward)..
+00013e60: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+00013e70: 645f 696d 706c 7320 3d20 7b0a 2020 2020  d_impls = {.    
+00013e80: 7072 696d 732e 5072 696d 4944 732e 4143  prims.PrimIDs.AC
+00013e90: 4f53 3a20 6c61 6d62 6461 2078 3a20 2870  OS: lambda x: (p
+00013ea0: 7269 6d73 2e61 636f 7328 7829 2c20 2878  rims.acos(x), (x
+00013eb0: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
+00013ec0: 7269 6d49 4473 2e41 434f 5348 3a20 6c61  rimIDs.ACOSH: la
+00013ed0: 6d62 6461 2078 3a20 2870 7269 6d73 2e61  mbda x: (prims.a
+00013ee0: 636f 7368 2878 292c 2028 782c 2929 2c0a  cosh(x), (x,)),.
+00013ef0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00013f00: 732e 4153 494e 3a20 6c61 6d62 6461 2078  s.ASIN: lambda x
+00013f10: 3a20 2870 7269 6d73 2e61 7369 6e28 7829  : (prims.asin(x)
+00013f20: 2c20 2878 2c29 292c 0a20 2020 2070 7269  , (x,)),.    pri
+00013f30: 6d73 2e50 7269 6d49 4473 2e41 5349 4e48  ms.PrimIDs.ASINH
+00013f40: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
+00013f50: 6d73 2e61 7369 6e68 2878 292c 2028 782c  ms.asinh(x), (x,
+00013f60: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
+00013f70: 696d 4944 732e 4154 414e 3a20 6c61 6d62  imIDs.ATAN: lamb
+00013f80: 6461 2078 3a20 2870 7269 6d73 2e61 7461  da x: (prims.ata
+00013f90: 6e28 7829 2c20 2878 2c29 292c 0a20 2020  n(x), (x,)),.   
+00013fa0: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
+00013fb0: 5441 4e48 3a20 6c61 6d62 6461 2078 3a20  TANH: lambda x: 
+00013fc0: 2870 7269 6d73 2e61 7461 6e68 2878 292c  (prims.atanh(x),
+00013fd0: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
+00013fe0: 732e 5072 696d 4944 732e 4154 414e 323a  s.PrimIDs.ATAN2:
+00013ff0: 206c 616d 6264 6120 782c 2079 3a20 2870   lambda x, y: (p
+00014000: 7269 6d73 2e61 7461 6e32 2878 2c20 7929  rims.atan2(x, y)
+00014010: 2c20 2878 2c20 7929 292c 0a20 2020 2070  , (x, y)),.    p
+00014020: 7269 6d73 2e50 7269 6d49 4473 2e43 4f53  rims.PrimIDs.COS
+00014030: 483a 206c 616d 6264 6120 783a 2028 7072  H: lambda x: (pr
+00014040: 696d 732e 636f 7368 2878 292c 2028 782c  ims.cosh(x), (x,
+00014050: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
+00014060: 696d 4944 732e 4449 4741 4d4d 413a 206c  imIDs.DIGAMMA: l
+00014070: 616d 6264 6120 783a 2028 7072 696d 732e  ambda x: (prims.
+00014080: 6469 6761 6d6d 6128 7829 2c20 2878 2c29  digamma(x), (x,)
+00014090: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+000140a0: 6d49 4473 2e45 5246 433a 206c 616d 6264  mIDs.ERFC: lambd
+000140b0: 6120 783a 2028 7072 696d 732e 6572 6663  a x: (prims.erfc
+000140c0: 2878 292c 2028 782c 2929 2c0a 2020 2020  (x), (x,)),.    
+000140d0: 7072 696d 732e 5072 696d 4944 732e 4552  prims.PrimIDs.ER
+000140e0: 4649 4e56 3a20 6c61 6d62 6461 2078 3a20  FINV: lambda x: 
+000140f0: 2870 7269 6d73 2e65 7266 696e 7628 7829  (prims.erfinv(x)
+00014100: 2c20 2870 7269 6d73 2e65 7266 696e 7628  , (prims.erfinv(
+00014110: 7829 2c29 292c 0a20 2020 2070 7269 6d73  x),)),.    prims
+00014120: 2e50 7269 6d49 4473 2e45 5246 4349 4e56  .PrimIDs.ERFCINV
+00014130: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
+00014140: 6d73 2e65 7266 6369 6e76 2878 292c 2028  ms.erfcinv(x), (
+00014150: 7072 696d 732e 6572 6663 696e 7628 7829  prims.erfcinv(x)
+00014160: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
+00014170: 7269 6d49 4473 2e45 5850 323a 206c 616d  rimIDs.EXP2: lam
+00014180: 6264 6120 783a 2028 7072 696d 732e 6578  bda x: (prims.ex
+00014190: 7032 2878 292c 2028 7072 696d 732e 6578  p2(x), (prims.ex
+000141a0: 7032 2878 292c 2929 2c0a 2020 2020 7072  p2(x),)),.    pr
+000141b0: 696d 732e 5072 696d 4944 732e 4558 504d  ims.PrimIDs.EXPM
+000141c0: 313a 206c 616d 6264 6120 783a 2028 7072  1: lambda x: (pr
+000141d0: 696d 732e 6578 706d 3128 7829 2c20 2870  ims.expm1(x), (p
+000141e0: 7269 6d73 2e65 7870 6d31 2878 292c 2929  rims.expm1(x),))
+000141f0: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00014200: 4944 732e 4c47 414d 4d41 3a20 6c61 6d62  IDs.LGAMMA: lamb
+00014210: 6461 2078 3a20 2870 7269 6d73 2e6c 6761  da x: (prims.lga
+00014220: 6d6d 6128 7829 2c20 2878 2c29 292c 0a20  mma(x), (x,)),. 
+00014230: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00014240: 2e4e 4454 5249 3a20 6c61 6d62 6461 2078  .NDTRI: lambda x
+00014250: 3a20 2870 7269 6d73 2e6e 6474 7269 2878  : (prims.ndtri(x
+00014260: 292c 2028 7072 696d 732e 6e64 7472 6928  ), (prims.ndtri(
+00014270: 7829 2c29 292c 0a20 2020 2070 7269 6d73  x),)),.    prims
+00014280: 2e50 7269 6d49 4473 2e53 494e 483a 206c  .PrimIDs.SINH: l
+00014290: 616d 6264 6120 783a 2028 7072 696d 732e  ambda x: (prims.
+000142a0: 7369 6e68 2878 292c 2028 782c 2929 2c0a  sinh(x), (x,)),.
+000142b0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+000142c0: 732e 5351 5254 3a20 6c61 6d62 6461 2078  s.SQRT: lambda x
+000142d0: 3a20 2870 7269 6d73 2e73 7172 7428 7829  : (prims.sqrt(x)
+000142e0: 2c20 2870 7269 6d73 2e73 7172 7428 7829  , (prims.sqrt(x)
+000142f0: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
+00014300: 7269 6d49 4473 2e4e 453a 206c 616d 6264  rimIDs.NE: lambd
+00014310: 6120 782c 2079 3a20 2870 7269 6d73 2e6e  a x, y: (prims.n
+00014320: 6528 782c 2079 292c 2028 782c 2079 2929  e(x, y), (x, y))
+00014330: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00014340: 4944 732e 4754 3a20 6c61 6d62 6461 2078  IDs.GT: lambda x
+00014350: 2c20 793a 2028 7072 696d 732e 6774 2878  , y: (prims.gt(x
+00014360: 2c20 7929 2c20 2878 2c20 7929 292c 0a20  , y), (x, y)),. 
+00014370: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00014380: 2e4c 453a 206c 616d 6264 6120 782c 2079  .LE: lambda x, y
+00014390: 3a20 2870 7269 6d73 2e6c 6528 782c 2079  : (prims.le(x, y
+000143a0: 292c 2028 782c 2079 2929 2c0a 2020 2020  ), (x, y)),.    
+000143b0: 7072 696d 732e 5072 696d 4944 732e 4c4f  prims.PrimIDs.LO
+000143c0: 4731 303a 206c 616d 6264 6120 783a 2028  G10: lambda x: (
+000143d0: 7072 696d 732e 6c6f 6731 3028 7829 2c20  prims.log10(x), 
+000143e0: 2878 2c29 292c 0a20 2020 2070 7269 6d73  (x,)),.    prims
+000143f0: 2e50 7269 6d49 4473 2e4c 4f47 3150 3a20  .PrimIDs.LOG1P: 
+00014400: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
+00014410: 2e6c 6f67 3170 2878 292c 2028 782c 2929  .log1p(x), (x,))
+00014420: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00014430: 4944 732e 4c4f 4732 3a20 6c61 6d62 6461  IDs.LOG2: lambda
+00014440: 2078 3a20 2870 7269 6d73 2e6c 6f67 3228   x: (prims.log2(
+00014450: 7829 2c20 2878 2c29 292c 0a20 2020 2070  x), (x,)),.    p
+00014460: 7269 6d73 2e50 7269 6d49 4473 2e5a 4554  rims.PrimIDs.ZET
+00014470: 413a 206c 616d 6264 6120 782c 2079 3a20  A: lambda x, y: 
+00014480: 2870 7269 6d73 2e7a 6574 6128 782c 2079  (prims.zeta(x, y
+00014490: 292c 2028 782c 2079 2929 2c0a 2020 2020  ), (x, y)),.    
+000144a0: 7072 696d 732e 5072 696d 4944 732e 464d  prims.PrimIDs.FM
+000144b0: 4f44 3a20 6c61 6d62 6461 2078 2c20 793a  OD: lambda x, y:
+000144c0: 2028 7072 696d 732e 666d 6f64 2878 2c20   (prims.fmod(x, 
+000144d0: 7929 2c20 2878 2c20 7929 292c 0a20 2020  y), (x, y)),.   
+000144e0: 2070 7269 6d73 2e50 7269 6d49 4473 2e43   prims.PrimIDs.C
+000144f0: 4f50 595f 3a20 6c61 6d62 6461 2078 2c20  OPY_: lambda x, 
+00014500: 793a 2028 7072 696d 732e 636f 7079 5f28  y: (prims.copy_(
+00014510: 782c 2079 292c 2074 7570 6c65 2829 292c  x, y), tuple()),
+00014520: 0a7d 0a0a 0a23 204d 6170 7069 6e67 2066  .}...# Mapping f
+00014530: 726f 6d20 7379 6d62 6f6c 7320 746f 2062  rom symbols to b
+00014540: 6163 6b77 6172 6420 6675 6e63 7469 6f6e  ackward function
+00014550: 7320 7573 6564 2069 6e20 564a 500a 2320  s used in VJP.# 
+00014560: 5468 6520 6261 636b 7761 7264 2066 756e  The backward fun
+00014570: 6374 696f 6e20 7461 6b65 7320 7468 6520  ction takes the 
+00014580: 7265 7369 6475 616c 7320 616e 6420 636f  residuals and co
+00014590: 7461 6e67 656e 7473 2061 6e64 2072 6574  tangents and ret
+000145a0: 7572 6e73 2074 6865 0a23 2076 6563 746f  urns the.# vecto
+000145b0: 722d 4a61 636f 6269 616e 2070 726f 6475  r-Jacobian produ
+000145c0: 6374 7320 666f 7220 6561 6368 2061 7267  cts for each arg
+000145d0: 756d 656e 742e 0a62 6163 6b77 6172 645f  ument..backward_
+000145e0: 696d 706c 7320 3d20 7b0a 2020 2020 7072  impls = {.    pr
+000145f0: 696d 732e 5072 696d 4944 732e 4143 4f53  ims.PrimIDs.ACOS
+00014600: 3a20 6c61 6d62 6461 2078 2c20 673a 202d  : lambda x, g: -
+00014610: 6720 2f20 7072 696d 732e 7371 7274 2831  g / prims.sqrt(1
+00014620: 2e30 202d 2078 202a 2078 292c 0a20 2020  .0 - x * x),.   
+00014630: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
+00014640: 434f 5348 3a20 6c61 6d62 6461 2078 2c20  COSH: lambda x, 
+00014650: 673a 2067 202a 2070 7269 6d73 2e72 7371  g: g * prims.rsq
+00014660: 7274 2878 202a 2078 202d 2031 2e30 292c  rt(x * x - 1.0),
+00014670: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+00014680: 4473 2e41 5349 4e3a 206c 616d 6264 6120  Ds.ASIN: lambda 
+00014690: 782c 2067 3a20 6720 2f20 7072 696d 732e  x, g: g / prims.
+000146a0: 7371 7274 2831 2e30 202d 2078 202a 2078  sqrt(1.0 - x * x
+000146b0: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+000146c0: 6d49 4473 2e41 5349 4e48 3a20 6c61 6d62  mIDs.ASINH: lamb
+000146d0: 6461 2078 2c20 673a 2067 202a 2070 7269  da x, g: g * pri
+000146e0: 6d73 2e72 7371 7274 2831 2e30 202b 2078  ms.rsqrt(1.0 + x
+000146f0: 202a 2078 292c 0a20 2020 2070 7269 6d73   * x),.    prims
+00014700: 2e50 7269 6d49 4473 2e41 5441 4e3a 206c  .PrimIDs.ATAN: l
+00014710: 616d 6264 6120 782c 2067 3a20 6720 2f20  ambda x, g: g / 
+00014720: 2831 2e30 202b 2078 202a 2078 292c 0a20  (1.0 + x * x),. 
+00014730: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00014740: 2e41 5441 4e48 3a20 6c61 6d62 6461 2078  .ATANH: lambda x
+00014750: 2c20 673a 2067 202f 2028 312e 3020 2d20  , g: g / (1.0 - 
+00014760: 7820 2a20 7829 2c0a 2020 2020 7072 696d  x * x),.    prim
+00014770: 732e 5072 696d 4944 732e 434f 5348 3a20  s.PrimIDs.COSH: 
+00014780: 6c61 6d62 6461 2078 2c20 673a 2070 7269  lambda x, g: pri
+00014790: 6d73 2e6d 756c 2867 2c20 7072 696d 732e  ms.mul(g, prims.
+000147a0: 7369 6e68 2878 2929 2c0a 2020 2020 7072  sinh(x)),.    pr
+000147b0: 696d 732e 5072 696d 4944 732e 4552 4643  ims.PrimIDs.ERFC
+000147c0: 3a20 6c61 6d62 6461 2078 2c20 673a 202d  : lambda x, g: -
+000147d0: 6720 2a20 322e 3020 2f20 6d61 7468 2e73  g * 2.0 / math.s
+000147e0: 7172 7428 6d61 7468 2e70 6929 202a 2070  qrt(math.pi) * p
+000147f0: 7269 6d73 2e65 7870 282d 7820 2a20 7829  rims.exp(-x * x)
+00014800: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00014810: 4944 732e 4552 4649 4e56 3a20 6c61 6d62  IDs.ERFINV: lamb
+00014820: 6461 2072 6573 756c 742c 2067 3a20 6720  da result, g: g 
+00014830: 2a20 302e 3520 2a20 6d61 7468 2e73 7172  * 0.5 * math.sqr
+00014840: 7428 6d61 7468 2e70 6929 202a 2070 7269  t(math.pi) * pri
+00014850: 6d73 2e65 7870 2872 6573 756c 742a 2a32  ms.exp(result**2
+00014860: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00014870: 6d49 4473 2e45 5246 4349 4e56 3a20 6c61  mIDs.ERFCINV: la
+00014880: 6d62 6461 2072 6573 756c 742c 2067 3a20  mbda result, g: 
+00014890: 2d67 202a 2030 2e35 202a 206d 6174 682e  -g * 0.5 * math.
+000148a0: 7371 7274 286d 6174 682e 7069 2920 2a20  sqrt(math.pi) * 
+000148b0: 7072 696d 732e 6578 7028 7265 7375 6c74  prims.exp(result
+000148c0: 2a2a 3229 2c0a 2020 2020 7072 696d 732e  **2),.    prims.
+000148d0: 5072 696d 4944 732e 4558 5032 3a20 6c61  PrimIDs.EXP2: la
+000148e0: 6d62 6461 2072 6573 756c 742c 2067 3a20  mbda result, g: 
+000148f0: 6720 2a20 7265 7375 6c74 202a 206d 6174  g * result * mat
+00014900: 682e 6c6f 6728 322e 3029 2c0a 2020 2020  h.log(2.0),.    
+00014910: 7072 696d 732e 5072 696d 4944 732e 4558  prims.PrimIDs.EX
+00014920: 504d 313a 206c 616d 6264 6120 7265 7375  PM1: lambda resu
+00014930: 6c74 2c20 673a 2067 202a 2028 7265 7375  lt, g: g * (resu
+00014940: 6c74 202b 2031 2e30 292c 0a20 2020 2070  lt + 1.0),.    p
+00014950: 7269 6d73 2e50 7269 6d49 4473 2e4c 4741  rims.PrimIDs.LGA
+00014960: 4d4d 413a 206c 616d 6264 6120 782c 2067  MMA: lambda x, g
+00014970: 3a20 6720 2a20 7072 696d 732e 6469 6761  : g * prims.diga
+00014980: 6d6d 6128 7829 2c0a 2020 2020 7072 696d  mma(x),.    prim
+00014990: 732e 5072 696d 4944 732e 4e44 5452 493a  s.PrimIDs.NDTRI:
+000149a0: 206c 616d 6264 6120 7265 7375 6c74 2c20   lambda result, 
+000149b0: 673a 2067 202a 2070 7269 6d73 2e65 7870  g: g * prims.exp
+000149c0: 2830 2e35 202a 2072 6573 756c 742a 2a32  (0.5 * result**2
+000149d0: 2920 2a20 6d61 7468 2e73 7172 7428 322e  ) * math.sqrt(2.
+000149e0: 3020 2a20 6d61 7468 2e70 6929 2c0a 2020  0 * math.pi),.  
+000149f0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00014a00: 5349 4e48 3a20 6c61 6d62 6461 2078 2c20  SINH: lambda x, 
+00014a10: 673a 2070 7269 6d73 2e6d 756c 2867 2c20  g: prims.mul(g, 
+00014a20: 7072 696d 732e 636f 7368 2878 2929 2c0a  prims.cosh(x)),.
+00014a30: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00014a40: 732e 5351 5254 3a20 6c61 6d62 6461 2072  s.SQRT: lambda r
+00014a50: 6573 756c 742c 2067 3a20 6720 2f20 2832  esult, g: g / (2
+00014a60: 2e30 202a 2072 6573 756c 7429 2c0a 2020  .0 * result),.  
+00014a70: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00014a80: 4e45 3a20 5a65 726f 4261 636b 7761 7264  NE: ZeroBackward
+00014a90: 286e 756d 5f61 7267 733d 3229 2c0a 2020  (num_args=2),.  
+00014aa0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00014ab0: 4754 3a20 5a65 726f 4261 636b 7761 7264  GT: ZeroBackward
+00014ac0: 286e 756d 5f61 7267 733d 3229 2c0a 2020  (num_args=2),.  
+00014ad0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00014ae0: 4c45 3a20 5a65 726f 4261 636b 7761 7264  LE: ZeroBackward
+00014af0: 286e 756d 5f61 7267 733d 3229 2c0a 2020  (num_args=2),.  
+00014b00: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00014b10: 4c4f 4731 303a 206c 616d 6264 6120 782c  LOG10: lambda x,
+00014b20: 2067 3a20 6720 2f20 2878 202a 2032 2e33   g: g / (x * 2.3
+00014b30: 3032 3538 3530 3932 3939 3430 3436 292c  02585092994046),
+00014b40: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+00014b50: 4473 2e4c 4f47 3150 3a20 6c61 6d62 6461  Ds.LOG1P: lambda
+00014b60: 2078 2c20 673a 2067 202f 2028 7820 2b20   x, g: g / (x + 
+00014b70: 3129 2c0a 2020 2020 7072 696d 732e 5072  1),.    prims.Pr
+00014b80: 696d 4944 732e 4c4f 4732 3a20 6c61 6d62  imIDs.LOG2: lamb
+00014b90: 6461 2078 2c20 673a 2067 202f 2028 7820  da x, g: g / (x 
+00014ba0: 2a20 302e 3639 3331 3437 3138 3035 3539  * 0.693147180559
+00014bb0: 3934 3533 292c 0a20 2020 2070 7269 6d73  9453),.    prims
+00014bc0: 2e50 7269 6d49 4473 2e46 4d4f 443a 206c  .PrimIDs.FMOD: l
+00014bd0: 616d 6264 6120 782c 2079 2c20 673a 2028  ambda x, y, g: (
+00014be0: 672c 202d 6720 2a20 7072 696d 732e 7472  g, -g * prims.tr
+00014bf0: 756e 6328 7820 2f20 7929 292c 0a20 2020  unc(x / y)),.   
+00014c00: 2023 2054 6865 2063 6f70 7920 7368 6f75   # The copy shou
+00014c10: 6c64 206e 6f74 2062 6520 6469 6666 6572  ld not be differ
+00014c20: 656e 7469 6162 6c65 2e20 5765 2072 6574  entiable. We ret
+00014c30: 7572 6e20 4e6f 6e65 2074 6f20 656e 6162  urn None to enab
+00014c40: 6c65 2074 6865 2067 656e 6572 6174 696f  le the generatio
+00014c50: 6e20 6f66 2074 6865 2062 6163 6b77 6172  n of the backwar
+00014c60: 6420 6772 6170 6820 7468 726f 7567 6820  d graph through 
+00014c70: 7468 656d 2e0a 2020 2020 7072 696d 732e  them..    prims.
+00014c80: 5072 696d 4944 732e 434f 5059 5f3a 206c  PrimIDs.COPY_: l
+00014c90: 616d 6264 6120 673a 2028 4e6f 6e65 2c20  ambda g: (None, 
+00014ca0: 4e6f 6e65 292c 0a7d 0a0a 0a64 6566 2072  None),.}...def r
+00014cb0: 6567 6973 7465 725f 6175 676d 656e 7465  egister_augmente
+00014cc0: 645f 666f 7277 6172 6428 6f70 293a 0a20  d_forward(op):. 
+00014cd0: 2020 2022 2222 4465 636f 7261 746f 7220     """Decorator 
+00014ce0: 746f 2072 6567 6973 7465 7220 616e 2061  to register an a
+00014cf0: 7567 6d65 6e74 6564 2066 6f72 7761 7264  ugmented forward
+00014d00: 2069 6d70 6c65 6d65 6e74 6174 696f 6e20   implementation 
+00014d10: 666f 7220 6120 7379 6d62 6f6c 2e0a 0a20  for a symbol... 
+00014d20: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+00014d30: 206f 7020 284f 7073 293a 2053 796d 626f   op (Ops): Symbo
+00014d40: 6c20 666f 7220 7768 6963 6820 746f 2072  l for which to r
+00014d50: 6567 6973 7465 7220 7468 6520 6175 676d  egister the augm
+00014d60: 656e 7465 6420 666f 7277 6172 6420 696d  ented forward im
+00014d70: 706c 656d 656e 7461 7469 6f6e 2e0a 0a20  plementation... 
+00014d80: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+00014d90: 2020 2020 4361 6c6c 6162 6c65 3a20 4465      Callable: De
+00014da0: 636f 7261 746f 7220 6675 6e63 7469 6f6e  corator function
+00014db0: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
+00014dc0: 6566 2064 6563 6f72 6174 6f72 2866 756e  ef decorator(fun
+00014dd0: 6329 3a0a 2020 2020 2020 2020 6175 676d  c):.        augm
+00014de0: 656e 7465 645f 666f 7277 6172 645f 696d  ented_forward_im
+00014df0: 706c 735b 6f70 5d20 3d20 6675 6e63 0a20  pls[op] = func. 
+00014e00: 2020 2020 2020 2072 6574 7572 6e20 6675         return fu
+00014e10: 6e63 0a0a 2020 2020 7265 7475 726e 2064  nc..    return d
+00014e20: 6563 6f72 6174 6f72 0a0a 0a64 6566 2072  ecorator...def r
+00014e30: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
+00014e40: 286f 7029 3a0a 2020 2020 2222 2244 6563  (op):.    """Dec
+00014e50: 6f72 6174 6f72 2074 6f20 7265 6769 7374  orator to regist
+00014e60: 6572 2061 2062 6163 6b77 6172 6420 696d  er a backward im
+00014e70: 706c 656d 656e 7461 7469 6f6e 2066 6f72  plementation for
+00014e80: 2061 2073 796d 626f 6c2e 0a0a 2020 2020   a symbol...    
+00014e90: 4172 6773 3a0a 2020 2020 2020 2020 6f70  Args:.        op
+00014ea0: 2028 4f70 7329 3a20 5379 6d62 6f6c 2066   (Ops): Symbol f
+00014eb0: 6f72 2077 6869 6368 2074 6f20 7265 6769  or which to regi
+00014ec0: 7374 6572 2074 6865 2062 6163 6b77 6172  ster the backwar
+00014ed0: 6420 696d 706c 656d 656e 7461 7469 6f6e  d implementation
+00014ee0: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+00014ef0: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
+00014f00: 3a20 4465 636f 7261 746f 7220 6675 6e63  : Decorator func
+00014f10: 7469 6f6e 2e0a 2020 2020 2222 220a 0a20  tion..    """.. 
+00014f20: 2020 2064 6566 2064 6563 6f72 6174 6f72     def decorator
+00014f30: 2866 756e 6329 3a0a 2020 2020 2020 2020  (func):.        
+00014f40: 6261 636b 7761 7264 5f69 6d70 6c73 5b6f  backward_impls[o
+00014f50: 705d 203d 2066 756e 630a 2020 2020 2020  p] = func.      
+00014f60: 2020 7265 7475 726e 2066 756e 630a 0a20    return func.. 
+00014f70: 2020 2072 6574 7572 6e20 6465 636f 7261     return decora
+00014f80: 746f 720a 0a0a 6465 6620 7265 7374 6f72  tor...def restor
+00014f90: 655f 7265 6475 6365 645f 6469 6d73 2878  e_reduced_dims(x
+00014fa0: 2c20 7265 6475 6365 645f 6469 6d73 2c20  , reduced_dims, 
+00014fb0: 6f72 6967 696e 616c 5f73 6861 7065 293a  original_shape):
+00014fc0: 0a20 2020 2022 2222 5265 7374 6f72 6573  .    """Restores
+00014fd0: 2074 6865 2072 6564 7563 6564 2064 696d   the reduced dim
+00014fe0: 656e 7369 6f6e 7320 6f66 2061 2074 656e  ensions of a ten
+00014ff0: 736f 722e 0a0a 2020 2020 4172 6773 3a0a  sor...    Args:.
+00015000: 2020 2020 2020 2020 7820 2856 6172 6961          x (Varia
+00015010: 626c 6529 3a20 5465 6e73 6f72 2074 6f20  ble): Tensor to 
+00015020: 6265 2072 6573 6861 7065 642e 0a20 2020  be reshaped..   
+00015030: 2020 2020 2072 6564 7563 6564 5f64 696d       reduced_dim
+00015040: 7320 2854 7570 6c65 5b69 6e74 2c20 2e2e  s (Tuple[int, ..
+00015050: 2e5d 293a 2054 7570 6c65 206f 6620 7265  .]): Tuple of re
+00015060: 6475 6365 6420 6469 6d65 6e73 696f 6e73  duced dimensions
+00015070: 2e0a 2020 2020 2020 2020 6f72 6967 696e  ..        origin
+00015080: 616c 5f73 6861 7065 2028 5475 706c 655b  al_shape (Tuple[
+00015090: 696e 742c 202e 2e2e 5d29 3a20 4f72 6967  int, ...]): Orig
+000150a0: 696e 616c 2073 6861 7065 206f 6620 7468  inal shape of th
+000150b0: 6520 7465 6e73 6f72 2e0a 0a20 2020 2052  e tensor...    R
+000150c0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+000150d0: 5661 7269 6162 6c65 3a20 5465 6e73 6f72  Variable: Tensor
+000150e0: 2077 6974 6820 7468 6520 7265 6475 6365   with the reduce
+000150f0: 6420 6469 6d65 6e73 696f 6e73 2072 6573  d dimensions res
+00015100: 746f 7265 642e 0a20 2020 2022 2222 0a20  tored..    """. 
+00015110: 2020 2069 6620 6f72 6967 696e 616c 5f73     if original_s
+00015120: 6861 7065 203d 3d20 2829 3a20 2023 2073  hape == ():  # s
+00015130: 6361 6c61 720a 2020 2020 2020 2020 7265  calar.        re
+00015140: 7475 726e 2078 0a0a 2020 2020 756e 7371  turn x..    unsq
+00015150: 7565 657a 6564 203d 2063 6c61 6e67 2e75  ueezed = clang.u
+00015160: 6e73 7175 6565 7a65 2878 2c20 7265 6475  nsqueeze(x, redu
+00015170: 6365 645f 6469 6d73 290a 2020 2020 7265  ced_dims).    re
+00015180: 7475 726e 2063 6c61 6e67 2e65 7870 616e  turn clang.expan
+00015190: 6428 756e 7371 7565 657a 6564 2c20 6f72  d(unsqueezed, or
+000151a0: 6967 696e 616c 5f73 6861 7065 290a 0a0a  iginal_shape)...
+000151b0: 4072 6567 6973 7465 725f 6261 636b 7761  @register_backwa
+000151c0: 7264 2870 7269 6d73 2e50 7269 6d49 4473  rd(prims.PrimIDs
+000151d0: 2e5a 4554 4129 0a64 6566 207a 6574 615f  .ZETA).def zeta_
+000151e0: 6261 636b 7761 7264 2878 2c20 792c 2067  backward(x, y, g
+000151f0: 293a 0a20 2020 2023 2054 6865 2064 6572  ):.    # The der
+00015200: 6976 6174 6976 6520 7772 7420 7468 6520  ivative wrt the 
+00015210: 6669 7273 7420 6172 6775 6d65 6e74 2069  first argument i
+00015220: 7320 6e6f 7420 6578 7072 6573 7369 626c  s not expressibl
+00015230: 6520 696e 2074 6572 6d73 206f 6620 7a65  e in terms of ze
+00015240: 7461 206f 720a 2020 2020 2320 6f74 6865  ta or.    # othe
+00015250: 7220 7370 6563 6961 6c20 6675 6e63 7469  r special functi
+00015260: 6f6e 730a 2020 2020 2320 5468 6572 6566  ons.    # Theref
+00015270: 6f72 652c 2077 6520 636f 6d70 7574 6520  ore, we compute 
+00015280: 6f6e 6c79 2074 6865 2064 6572 6976 6174  only the derivat
+00015290: 6976 6520 7772 7420 7468 6520 7365 636f  ive wrt the seco
+000152a0: 6e64 2061 7267 756d 656e 740a 2020 2020  nd argument.    
+000152b0: 6779 203d 2067 202a 202d 7820 2a20 7072  gy = g * -x * pr
+000152c0: 696d 732e 7a65 7461 2878 202b 2031 2e30  ims.zeta(x + 1.0
+000152d0: 2c20 7929 0a0a 2020 2020 2320 5265 7475  , y)..    # Retu
+000152e0: 726e 2061 206d 6170 7070 696e 6720 6672  rn a mappping fr
+000152f0: 6f6d 2074 6865 2066 6f72 7761 7264 2061  om the forward a
+00015300: 7267 756d 656e 7473 2074 6f20 7468 6520  rguments to the 
+00015310: 6772 6164 6965 6e74 730a 2020 2020 7265  gradients.    re
+00015320: 7475 726e 207b 2279 223a 2067 797d 0a0a  turn {"y": gy}..
+00015330: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
+00015340: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
+00015350: 732e 4449 4741 4d4d 4129 0a64 6566 2064  s.DIGAMMA).def d
+00015360: 6967 616d 6d61 5f62 6163 6b77 6172 6428  igamma_backward(
+00015370: 613a 2050 726f 7879 2c20 6729 3a0a 2020  a: Proxy, g):.  
+00015380: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
+00015390: 6f72 6368 2069 6d70 6f72 7420 706f 6c79  orch import poly
+000153a0: 6761 6d6d 610a 0a20 2020 2072 6574 7572  gamma..    retur
+000153b0: 6e20 6720 2a20 706f 6c79 6761 6d6d 6128  n g * polygamma(
+000153c0: 312c 2061 290a 0a0a 4072 6567 6973 7465  1, a)...@registe
+000153d0: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
+000153e0: 6172 6428 2274 6f72 6368 2e70 6f6c 7967  ard("torch.polyg
+000153f0: 616d 6d61 2229 0a64 6566 2070 6f6c 7967  amma").def polyg
+00015400: 616d 6d61 5f61 7567 5f66 7764 286e 3a20  amma_aug_fwd(n: 
+00015410: 696e 742c 2061 3a20 5072 6f78 7929 3a0a  int, a: Proxy):.
+00015420: 2020 2020 6672 6f6d 2074 6875 6e64 6572      from thunder
+00015430: 2e74 6f72 6368 2069 6d70 6f72 7420 706f  .torch import po
+00015440: 6c79 6761 6d6d 610a 0a20 2020 2070 7269  lygamma..    pri
+00015450: 6d61 6c20 3d20 706f 6c79 6761 6d6d 6128  mal = polygamma(
+00015460: 6e2c 2061 290a 2020 2020 7265 7369 6475  n, a).    residu
+00015470: 616c 7320 3d20 286e 2c20 6129 0a20 2020  als = (n, a).   
+00015480: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
+00015490: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
+000154a0: 7329 0a0a 0a40 7265 6769 7374 6572 5f62  s)...@register_b
+000154b0: 6163 6b77 6172 6428 2274 6f72 6368 2e70  ackward("torch.p
+000154c0: 6f6c 7967 616d 6d61 2229 0a64 6566 2070  olygamma").def p
+000154d0: 6f6c 7967 616d 6d61 5f62 6163 6b77 6172  olygamma_backwar
+000154e0: 6428 6e3a 2069 6e74 2c20 613a 2050 726f  d(n: int, a: Pro
+000154f0: 7879 2c20 6729 3a0a 2020 2020 6672 6f6d  xy, g):.    from
+00015500: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
+00015510: 6d70 6f72 7420 706f 6c79 6761 6d6d 610a  mport polygamma.
+00015520: 0a20 2020 2072 6574 7572 6e20 4e6f 6e65  .    return None
+00015530: 2c20 6720 2a20 706f 6c79 6761 6d6d 6128  , g * polygamma(
+00015540: 6e20 2b20 312c 2061 290a 0a0a 4072 6567  n + 1, a)...@reg
+00015550: 6973 7465 725f 6261 636b 7761 7264 2870  ister_backward(p
+00015560: 7269 6d73 2e50 7269 6d49 4473 2e41 5441  rims.PrimIDs.ATA
+00015570: 4e32 290a 6465 6620 6174 616e 325f 6261  N2).def atan2_ba
+00015580: 636b 7761 7264 2878 2c20 792c 2067 293a  ckward(x, y, g):
+00015590: 0a20 2020 2061 6c70 6861 203d 2031 2e30  .    alpha = 1.0
+000155a0: 202f 2028 7820 2a20 7820 2b20 7920 2a20   / (x * x + y * 
+000155b0: 7929 0a20 2020 2067 7261 645f 7820 3d20  y).    grad_x = 
+000155c0: 6720 2a20 7920 2a20 616c 7068 610a 2020  g * y * alpha.  
+000155d0: 2020 6772 6164 5f79 203d 2067 202a 202d    grad_y = g * -
+000155e0: 7820 2a20 616c 7068 610a 2020 2020 7265  x * alpha.    re
+000155f0: 7475 726e 2067 7261 645f 782c 2067 7261  turn grad_x, gra
+00015600: 645f 790a 0a0a 4072 6567 6973 7465 725f  d_y...@register_
+00015610: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+00015620: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
+00015630: 5641 5229 0a64 6566 2076 6172 5f61 7567  VAR).def var_aug
+00015640: 5f66 7764 2861 2c20 6469 6d2c 202a 2c20  _fwd(a, dim, *, 
+00015650: 636f 7272 6563 7469 6f6e 293a 0a20 2020  correction):.   
+00015660: 2076 203d 2070 7269 6d73 2e76 6172 2861   v = prims.var(a
+00015670: 2c20 6469 6d2c 2063 6f72 7265 6374 696f  , dim, correctio
+00015680: 6e3d 636f 7272 6563 7469 6f6e 290a 2020  n=correction).  
+00015690: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
+000156a0: 2828 762c 292c 2028 612c 2064 696d 2c20  ((v,), (a, dim, 
+000156b0: 636f 7272 6563 7469 6f6e 2c20 7629 290a  correction, v)).
+000156c0: 0a0a 2320 544f 444f 3a20 6669 7820 6469  ..# TODO: fix di
+000156d0: 7669 7369 6f6e 2062 7920 7a65 726f 2077  vision by zero w
+000156e0: 6865 6e20 6e5f 656c 656d 5f72 6564 7563  hen n_elem_reduc
+000156f0: 6564 203d 3d20 3020 6f72 2077 6865 6e20  ed == 0 or when 
+00015700: 762e 6e75 6d65 6c20 3d3d 2030 0a23 2062  v.numel == 0.# b
+00015710: 7920 7265 7475 726e 696e 6720 7a65 726f  y returning zero
+00015720: 735f 6c69 6b65 2861 2920 6f72 2073 696d  s_like(a) or sim
+00015730: 696c 6172 2e0a 2320 544f 444f 3a20 6669  ilar..# TODO: fi
+00015740: 7820 6772 6164 2077 6865 6e20 636f 7272  x grad when corr
+00015750: 6563 7469 6f6e 203e 206e 5f65 6c65 6d5f  ection > n_elem_
+00015760: 7265 6475 6365 642e 0a40 7265 6769 7374  reduced..@regist
+00015770: 6572 5f62 6163 6b77 6172 6428 7072 696d  er_backward(prim
+00015780: 732e 5072 696d 4944 732e 5641 5229 0a64  s.PrimIDs.VAR).d
+00015790: 6566 2076 6172 5f62 6163 6b77 6172 6428  ef var_backward(
+000157a0: 612c 2064 696d 2c20 636f 7272 6563 7469  a, dim, correcti
+000157b0: 6f6e 2c20 762c 2067 293a 0a20 2020 206e  on, v, g):.    n
+000157c0: 5f65 6c65 6d5f 7265 6475 6365 6420 3d20  _elem_reduced = 
+000157d0: 612e 6e75 6d65 6c20 2f2f 2076 2e6e 756d  a.numel // v.num
+000157e0: 656c 2069 6620 612e 6e75 6d65 6c20 213d  el if a.numel !=
+000157f0: 2030 2065 6c73 6520 310a 2020 2020 6e6f   0 else 1.    no
+00015800: 726d 616c 697a 6174 696f 6e5f 7363 616c  rmalization_scal
+00015810: 6172 203d 206e 5f65 6c65 6d5f 7265 6475  ar = n_elem_redu
+00015820: 6365 6420 2d20 636f 7272 6563 7469 6f6e  ced - correction
+00015830: 0a20 2020 2067 203d 2072 6573 746f 7265  .    g = restore
+00015840: 5f72 6564 7563 6564 5f64 696d 7328 672c  _reduced_dims(g,
+00015850: 2064 696d 2c20 612e 7368 6170 6529 0a20   dim, a.shape). 
+00015860: 2020 2069 6620 612e 6474 7970 6520 213d     if a.dtype !=
+00015870: 2076 2e64 7479 7065 3a0a 2020 2020 2020   v.dtype:.      
+00015880: 2020 6120 3d20 7072 696d 732e 636f 6e76    a = prims.conv
+00015890: 6572 745f 656c 656d 656e 745f 7479 7065  ert_element_type
+000158a0: 2861 2c20 762e 6474 7970 6529 0a20 2020  (a, v.dtype).   
+000158b0: 206d 6561 6e20 3d20 7072 696d 732e 7375   mean = prims.su
+000158c0: 6d28 612c 2064 696d 2920 2f20 6e5f 656c  m(a, dim) / n_el
+000158d0: 656d 5f72 6564 7563 6564 0a20 2020 206d  em_reduced.    m
+000158e0: 6561 6e20 3d20 7265 7374 6f72 655f 7265  ean = restore_re
+000158f0: 6475 6365 645f 6469 6d73 286d 6561 6e2c  duced_dims(mean,
+00015900: 2064 696d 2c20 612e 7368 6170 6529 0a20   dim, a.shape). 
+00015910: 2020 2072 6574 7572 6e20 2832 202a 2067     return (2 * g
+00015920: 202a 2028 6120 2d20 6d65 616e 2929 202f   * (a - mean)) /
+00015930: 206e 6f72 6d61 6c69 7a61 7469 6f6e 5f73   normalization_s
+00015940: 6361 6c61 720a 0a0a 6465 6620 6e5f 656c  calar...def n_el
+00015950: 656d 5f72 6564 7563 6564 2861 5f6e 6469  em_reduced(a_ndi
+00015960: 6d2c 2061 5f73 6861 7065 2c20 6469 6d73  m, a_shape, dims
+00015970: 293a 0a20 2020 2064 696d 7320 3d20 7574  ):.    dims = ut
+00015980: 696c 732e 6361 6e6f 6e69 6361 6c69 7a65  ils.canonicalize
+00015990: 5f64 696d 7328 615f 6e64 696d 2c20 6469  _dims(a_ndim, di
+000159a0: 6d73 290a 2020 2020 7265 6475 6374 696f  ms).    reductio
+000159b0: 6e5f 7369 7a65 203d 2031 0a20 2020 2066  n_size = 1.    f
+000159c0: 6f72 2069 6478 2c20 7369 7a65 2069 6e20  or idx, size in 
+000159d0: 656e 756d 6572 6174 6528 615f 7368 6170  enumerate(a_shap
+000159e0: 6529 3a0a 2020 2020 2020 2020 6966 2069  e):.        if i
+000159f0: 6478 2069 6e20 6469 6d73 3a0a 2020 2020  dx in dims:.    
+00015a00: 2020 2020 2020 2020 7265 6475 6374 696f          reductio
+00015a10: 6e5f 7369 7a65 202a 3d20 7369 7a65 0a20  n_size *= size. 
+00015a20: 2020 2072 6574 7572 6e20 7265 6475 6374     return reduct
+00015a30: 696f 6e5f 7369 7a65 0a0a 0a64 6566 206d  ion_size...def m
+00015a40: 6561 6e5f 6261 636b 7761 7264 2861 5f6e  ean_backward(a_n
+00015a50: 6469 6d2c 2061 5f73 6861 7065 2c20 6469  dim, a_shape, di
+00015a60: 6d73 2c20 6772 6164 293a 0a20 2020 206d  ms, grad):.    m
+00015a70: 6561 6e5f 6c6f 6361 6c5f 6772 6164 203d  ean_local_grad =
+00015a80: 2031 2e30 202f 206e 5f65 6c65 6d5f 7265   1.0 / n_elem_re
+00015a90: 6475 6365 6428 615f 6e64 696d 2c20 615f  duced(a_ndim, a_
+00015aa0: 7368 6170 652c 2064 696d 7329 0a20 2020  shape, dims).   
+00015ab0: 2072 6574 7572 6e20 7265 7374 6f72 655f   return restore_
+00015ac0: 7265 6475 6365 645f 6469 6d73 2867 7261  reduced_dims(gra
+00015ad0: 642c 2064 696d 732c 2061 5f73 6861 7065  d, dims, a_shape
+00015ae0: 2920 2a20 6d65 616e 5f6c 6f63 616c 5f67  ) * mean_local_g
+00015af0: 7261 640a 0a0a 4072 6567 6973 7465 725f  rad...@register_
+00015b00: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+00015b10: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
+00015b20: 5041 4429 0a64 6566 2070 6164 5f61 7567  PAD).def pad_aug
+00015b30: 5f66 7764 2861 2c20 7061 6464 696e 675f  _fwd(a, padding_
+00015b40: 7661 6c75 652c 2070 6164 6469 6e67 5f63  value, padding_c
+00015b50: 6f6e 6669 6729 3a0a 2020 2020 7265 7475  onfig):.    retu
+00015b60: 726e 2056 4a50 4475 616c 2828 7072 696d  rn VJPDual((prim
+00015b70: 732e 7061 6428 612c 2070 6164 6469 6e67  s.pad(a, padding
+00015b80: 5f76 616c 7565 2c20 7061 6464 696e 675f  _value, padding_
+00015b90: 636f 6e66 6967 292c 292c 2028 612c 2070  config),), (a, p
+00015ba0: 6164 6469 6e67 5f63 6f6e 6669 6729 290a  adding_config)).
+00015bb0: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
+00015bc0: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
+00015bd0: 4473 2e50 4144 290a 6465 6620 7061 645f  Ds.PAD).def pad_
+00015be0: 6261 636b 7761 7264 2861 2c20 7061 6464  backward(a, padd
+00015bf0: 696e 675f 636f 6e66 6967 2c20 6729 3a0a  ing_config, g):.
+00015c00: 2020 2020 2320 5368 6f72 7420 6369 7263      # Short circ
+00015c10: 7569 7420 6f6e 2065 6d70 7479 2069 6e70  uit on empty inp
+00015c20: 7574 2e0a 2020 2020 6966 2061 6e79 2864  ut..    if any(d
+00015c30: 696d 203d 3d20 3020 666f 7220 6469 6d20  im == 0 for dim 
+00015c40: 696e 2061 2e73 6861 7065 293a 0a20 2020  in a.shape):.   
+00015c50: 2020 2020 2072 6574 7572 6e20 6675 6c6c       return full
+00015c60: 5f6c 696b 6528 612c 2066 696c 6c5f 7661  _like(a, fill_va
+00015c70: 6c75 653d 3029 0a0a 2020 2020 2320 556e  lue=0)..    # Un
+00015c80: 2d70 6164 2062 7920 7061 6464 696e 6720  -pad by padding 
+00015c90: 7769 7468 207a 6572 6f20 7661 6c75 6573  with zero values
+00015ca0: 0a20 2020 207a 6572 6f5f 7061 6464 696e  .    zero_paddin
+00015cb0: 675f 636f 6e66 6967 203d 205b 282d 6c6f  g_config = [(-lo
+00015cc0: 2c20 2d68 692c 2030 2920 666f 7220 6c6f  , -hi, 0) for lo
+00015cd0: 2c20 6869 2c20 5f20 696e 2070 6164 6469  , hi, _ in paddi
+00015ce0: 6e67 5f63 6f6e 6669 675d 0a0a 2020 2020  ng_config]..    
+00015cf0: 6720 3d20 7072 696d 732e 7061 6428 672c  g = prims.pad(g,
+00015d00: 2030 2e30 2c20 7a65 726f 5f70 6164 6469   0.0, zero_paddi
+00015d10: 6e67 5f63 6f6e 6669 6729 0a0a 2020 2020  ng_config)..    
+00015d20: 2320 556e 2d73 6c69 6365 2062 7920 736c  # Un-slice by sl
+00015d30: 6963 696e 6720 7769 7468 2061 2073 7472  icing with a str
+00015d40: 6964 6520 6f66 2076 616c 7565 2028 6469  ide of value (di
+00015d50: 6c61 7469 6f6e 202b 2031 290a 2020 2020  lation + 1).    
+00015d60: 666f 7220 6469 6d2c 2028 5f2c 205f 2c20  for dim, (_, _, 
+00015d70: 6429 2069 6e20 656e 756d 6572 6174 6528  d) in enumerate(
+00015d80: 7061 6464 696e 675f 636f 6e66 6967 293a  padding_config):
+00015d90: 0a20 2020 2020 2020 2067 203d 2073 6c69  .        g = sli
+00015da0: 6365 5f69 6e5f 6469 6d28 672c 2030 2c20  ce_in_dim(g, 0, 
+00015db0: 672e 7368 6170 655b 6469 6d5d 2c20 7374  g.shape[dim], st
+00015dc0: 7269 6465 3d64 202b 2031 2c20 6469 6d3d  ride=d + 1, dim=
+00015dd0: 6469 6d29 0a0a 2020 2020 7265 7475 726e  dim)..    return
+00015de0: 2067 0a0a 0a40 7265 6769 7374 6572 5f61   g...@register_a
+00015df0: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+00015e00: 2870 7269 6d73 2e50 7269 6d49 4473 2e50  (prims.PrimIDs.P
+00015e10: 524f 4429 0a64 6566 2070 726f 645f 6175  ROD).def prod_au
+00015e20: 675f 6677 6428 782c 2064 696d 7329 3a0a  g_fwd(x, dims):.
+00015e30: 2020 2020 2222 2241 7567 6d65 6e74 6564      """Augmented
+00015e40: 2070 726f 6420 6f70 6572 6174 696f 6e2e   prod operation.
+00015e50: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+00015e60: 2020 2020 7820 2856 6172 6961 626c 6529      x (Variable)
+00015e70: 3a20 5465 6e73 6f72 2074 6f20 6265 206d  : Tensor to be m
+00015e80: 756c 7469 706c 6965 642e 0a20 2020 2020  ultiplied..     
+00015e90: 2020 2064 696d 7320 2854 7570 6c65 5b69     dims (Tuple[i
+00015ea0: 6e74 2c20 2e2e 2e5d 293a 2044 696d 656e  nt, ...]): Dimen
+00015eb0: 7369 6f6e 7320 746f 2062 6520 6d75 6c74  sions to be mult
+00015ec0: 6970 6c69 6564 2e0a 0a20 2020 2052 6574  iplied...    Ret
+00015ed0: 7572 6e73 3a0a 2020 2020 2020 2020 564a  urns:.        VJ
+00015ee0: 5044 7561 6c3a 2050 7269 6d61 6c20 616e  PDual: Primal an
+00015ef0: 6420 7265 7369 6475 616c 732e 0a20 2020  d residuals..   
+00015f00: 2022 2222 0a20 2020 2070 7269 6d61 6c20   """.    primal 
+00015f10: 3d20 7072 696d 732e 7072 6f64 2878 2c20  = prims.prod(x, 
+00015f20: 6469 6d73 290a 0a20 2020 2072 6573 6964  dims)..    resid
+00015f30: 7561 6c73 203d 2028 0a20 2020 2020 2020  uals = (.       
+00015f40: 2070 7269 6d61 6c2c 0a20 2020 2020 2020   primal,.       
+00015f50: 2078 2c0a 2020 2020 2020 2020 782e 7368   x,.        x.sh
+00015f60: 6170 652c 0a20 2020 2020 2020 2064 696d  ape,.        dim
+00015f70: 732c 0a20 2020 2029 0a20 2020 2072 6574  s,.    ).    ret
+00015f80: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
+00015f90: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
+00015fa0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
+00015fb0: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
+00015fc0: 732e 5052 4f44 290a 6465 6620 7072 6f64  s.PROD).def prod
+00015fd0: 5f70 756c 6c62 6163 6b28 7072 696d 616c  _pullback(primal
+00015fe0: 2c20 782c 2078 5f73 6861 7065 2c20 7265  , x, x_shape, re
+00015ff0: 6475 6365 645f 6469 6d73 2c20 6729 3a0a  duced_dims, g):.
+00016000: 2020 2020 7265 7475 726e 2070 7269 6d73      return prims
+00016010: 2e64 6976 2872 6573 746f 7265 5f72 6564  .div(restore_red
+00016020: 7563 6564 5f64 696d 7328 7072 696d 616c  uced_dims(primal
+00016030: 202a 2067 2c20 7265 6475 6365 645f 6469   * g, reduced_di
+00016040: 6d73 2c20 785f 7368 6170 6529 2c20 7829  ms, x_shape), x)
+00016050: 0a0a 0a64 6566 206b 6565 7064 696d 5f72  ...def keepdim_r
+00016060: 6564 7563 7469 6f6e 2872 6564 7563 7469  eduction(reducti
+00016070: 6f6e 5f66 6e2c 2078 2c20 6469 6d73 293a  on_fn, x, dims):
+00016080: 0a20 2020 2022 2222 4170 706c 6965 7320  .    """Applies 
+00016090: 7265 6475 6374 696f 6e20 616e 6420 6669  reduction and fi
+000160a0: 7865 7320 6f75 7470 7574 2074 6f20 636f  xes output to co
+000160b0: 6e66 6f72 6d20 746f 206b 6565 7064 696d  nform to keepdim
+000160c0: 3d54 7275 6522 2222 0a20 2020 206f 7574  =True""".    out
+000160d0: 203d 2072 6564 7563 7469 6f6e 5f66 6e28   = reduction_fn(
+000160e0: 782c 2064 696d 7329 0a20 2020 2061 7267  x, dims).    arg
+000160f0: 6d61 785f 7375 6d5f 6f75 745f 7368 6170  max_sum_out_shap
+00016100: 6520 3d20 5b78 2e73 6861 7065 5b69 5d20  e = [x.shape[i] 
+00016110: 6966 2069 206e 6f74 2069 6e20 6469 6d73  if i not in dims
+00016120: 2065 6c73 6520 3120 666f 7220 6920 696e   else 1 for i in
+00016130: 2072 616e 6765 2878 2e6e 6469 6d29 5d0a   range(x.ndim)].
+00016140: 2020 2020 6272 6f61 6463 6173 745f 6469      broadcast_di
+00016150: 6d73 203d 205b 6920 666f 7220 6920 696e  ms = [i for i in
+00016160: 2072 616e 6765 2878 2e6e 6469 6d29 2069   range(x.ndim) i
+00016170: 6620 6920 6e6f 7420 696e 2064 696d 735d  f i not in dims]
+00016180: 0a20 2020 2072 6574 7572 6e20 7072 696d  .    return prim
+00016190: 732e 6272 6f61 6463 6173 745f 696e 5f64  s.broadcast_in_d
+000161a0: 696d 286f 7574 2c20 6172 676d 6178 5f73  im(out, argmax_s
+000161b0: 756d 5f6f 7574 5f73 6861 7065 2c20 6272  um_out_shape, br
+000161c0: 6f61 6463 6173 745f 6469 6d73 290a 0a0a  oadcast_dims)...
+000161d0: 2320 496e 7370 6972 6564 2066 726f 6d20  # Inspired from 
+000161e0: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
+000161f0: 6f6d 2f48 4950 532f 6175 746f 6772 6164  om/HIPS/autograd
+00016200: 2f62 6c6f 622f 6d61 7374 6572 2f61 7574  /blob/master/aut
+00016210: 6f67 7261 642f 6e75 6d70 792f 6e75 6d70  ograd/numpy/nump
+00016220: 795f 766a 7073 2e70 7923 4c33 3533 0a64  y_vjps.py#L353.d
+00016230: 6566 2067 7261 645f 6368 6f6f 7365 725f  ef grad_chooser_
+00016240: 6261 636b 7761 7264 2870 7269 6d61 6c2c  backward(primal,
+00016250: 2078 2c20 785f 7368 6170 652c 2072 6564   x, x_shape, red
+00016260: 7563 6564 5f64 696d 732c 2067 293a 0a20  uced_dims, g):. 
+00016270: 2020 2022 2222 4275 696c 6473 2067 7261     """Builds gra
+00016280: 6469 656e 7420 6f66 2066 756e 6374 696f  dient of functio
+00016290: 6e73 2074 6861 7420 6368 6f6f 7365 2061  ns that choose a
+000162a0: 2073 696e 676c 6520 6974 656d 2c20 7375   single item, su
+000162b0: 6368 2061 7320 6d69 6e20 6f72 206d 6178  ch as min or max
+000162c0: 2e22 2222 0a20 2020 2067 5f72 6570 6561  .""".    g_repea
+000162d0: 7465 6420 3d20 7265 7374 6f72 655f 7265  ted = restore_re
+000162e0: 6475 6365 645f 6469 6d73 2867 2c20 7265  duced_dims(g, re
+000162f0: 6475 6365 645f 6469 6d73 2c20 785f 7368  duced_dims, x_sh
+00016300: 6170 6529 0a20 2020 2070 7269 6d61 6c5f  ape).    primal_
+00016310: 7265 7065 6174 6564 203d 2072 6573 746f  repeated = resto
+00016320: 7265 5f72 6564 7563 6564 5f64 696d 7328  re_reduced_dims(
+00016330: 7072 696d 616c 2c20 7265 6475 6365 645f  primal, reduced_
+00016340: 6469 6d73 2c20 785f 7368 6170 6529 0a20  dims, x_shape). 
+00016350: 2020 2061 7267 6d61 785f 6c6f 6361 7469     argmax_locati
+00016360: 6f6e 7320 3d20 7820 3d3d 2070 7269 6d61  ons = x == prima
+00016370: 6c5f 7265 7065 6174 6564 0a20 2020 2061  l_repeated.    a
+00016380: 7267 6d61 785f 7375 6d20 3d20 6b65 6570  rgmax_sum = keep
+00016390: 6469 6d5f 7265 6475 6374 696f 6e28 7072  dim_reduction(pr
+000163a0: 696d 732e 7375 6d2c 2061 7267 6d61 785f  ims.sum, argmax_
+000163b0: 6c6f 6361 7469 6f6e 732c 2072 6564 7563  locations, reduc
+000163c0: 6564 5f64 696d 7329 0a20 2020 206f 7574  ed_dims).    out
+000163d0: 203d 2067 5f72 6570 6561 7465 6420 2a20   = g_repeated * 
+000163e0: 6172 676d 6178 5f6c 6f63 6174 696f 6e73  argmax_locations
+000163f0: 202f 2061 7267 6d61 785f 7375 6d0a 2020   / argmax_sum.  
+00016400: 2020 7265 7475 726e 206f 7574 0a0a 0a72    return out...r
+00016410: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
+00016420: 2870 7269 6d73 2e50 7269 6d49 4473 2e41  (prims.PrimIDs.A
+00016430: 4d49 4e29 2867 7261 645f 6368 6f6f 7365  MIN)(grad_choose
+00016440: 725f 6261 636b 7761 7264 290a 0a0a 4072  r_backward)...@r
+00016450: 6567 6973 7465 725f 6175 676d 656e 7465  egister_augmente
+00016460: 645f 666f 7277 6172 6428 7072 696d 732e  d_forward(prims.
+00016470: 5072 696d 4944 732e 414d 494e 290a 6465  PrimIDs.AMIN).de
+00016480: 6620 616d 696e 5f61 7567 5f66 7764 2878  f amin_aug_fwd(x
+00016490: 2c20 6469 6d73 293a 0a20 2020 2022 2222  , dims):.    """
+000164a0: 4175 676d 656e 7465 6420 616d 696e 206f  Augmented amin o
+000164b0: 7065 7261 7469 6f6e 2e0a 2020 2020 4172  peration..    Ar
+000164c0: 6773 3a0a 2020 2020 2020 2020 7820 2856  gs:.        x (V
+000164d0: 6172 6961 626c 6529 3a20 5465 6e73 6f72  ariable): Tensor
+000164e0: 2074 6f20 636f 6d70 7574 6520 616d 696e   to compute amin
+000164f0: 206f 6e2e 0a20 2020 2020 2020 2064 696d   on..        dim
+00016500: 7320 2854 7570 6c65 5b69 6e74 2c20 2e2e  s (Tuple[int, ..
+00016510: 2e5d 293a 2044 696d 656e 7369 6f6e 7320  .]): Dimensions 
+00016520: 746f 2063 6f6d 7075 7465 2061 6d69 6e20  to compute amin 
+00016530: 6f76 6572 2e0a 2020 2020 5265 7475 726e  over..    Return
+00016540: 733a 0a20 2020 2020 2020 2056 4a50 4475  s:.        VJPDu
+00016550: 616c 3a20 5072 696d 616c 2061 6e64 2072  al: Primal and r
+00016560: 6573 6964 7561 6c73 2e0a 2020 2020 2222  esiduals..    ""
+00016570: 220a 2020 2020 7072 696d 616c 203d 2070  ".    primal = p
+00016580: 7269 6d73 2e61 6d69 6e28 782c 2064 696d  rims.amin(x, dim
+00016590: 7329 0a0a 2020 2020 7265 7369 6475 616c  s)..    residual
+000165a0: 7320 3d20 280a 2020 2020 2020 2020 7072  s = (.        pr
+000165b0: 696d 616c 2c0a 2020 2020 2020 2020 782c  imal,.        x,
+000165c0: 0a20 2020 2020 2020 2078 2e73 6861 7065  .        x.shape
+000165d0: 2c0a 2020 2020 2020 2020 6469 6d73 2c0a  ,.        dims,.
+000165e0: 2020 2020 290a 0a20 2020 2072 6574 7572      )..    retur
+000165f0: 6e20 564a 5044 7561 6c28 7072 696d 616c  n VJPDual(primal
+00016600: 2c20 7265 7369 6475 616c 7329 0a0a 0a40  , residuals)...@
+00016610: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
+00016620: 6564 5f66 6f72 7761 7264 2870 7269 6d73  ed_forward(prims
+00016630: 2e50 7269 6d49 4473 2e50 4f57 290a 6465  .PrimIDs.POW).de
+00016640: 6620 706f 775f 6175 675f 6665 6428 782c  f pow_aug_fed(x,
+00016650: 2079 293a 0a20 2020 2022 2222 4175 676d   y):.    """Augm
+00016660: 656e 7465 6420 7468 6520 706f 7720 6f70  ented the pow op
+00016670: 6572 6174 696f 6e2e 0a0a 2020 2020 4172  eration...    Ar
+00016680: 6773 3a0a 2020 2020 2020 2020 7820 2856  gs:.        x (V
+00016690: 6172 6961 626c 6529 3a20 5465 6e73 6f72  ariable): Tensor
+000166a0: 2077 6974 6820 7468 6520 6261 7365 2074   with the base t
+000166b0: 6f20 6265 2065 7870 6f6e 656e 7469 6174  o be exponentiat
+000166c0: 6564 2e0a 2020 2020 2020 2020 7920 2856  ed..        y (V
+000166d0: 6172 6961 626c 6529 3a20 5465 6e73 6f72  ariable): Tensor
+000166e0: 2077 6974 6820 706f 7765 7220 746f 2072   with power to r
+000166f0: 6169 7365 2074 6f2e 0a0a 2020 2020 5265  aise to...    Re
+00016700: 7475 726e 733a 0a20 2020 2020 2020 2056  turns:.        V
+00016710: 4a50 4475 616c 3a20 5072 696d 616c 2061  JPDual: Primal a
+00016720: 6e64 2072 6573 6964 7561 6c73 2e0a 2020  nd residuals..  
+00016730: 2020 2222 220a 2020 2020 7072 696d 616c    """.    primal
+00016740: 203d 2070 7269 6d73 2e70 6f77 2878 2c20   = prims.pow(x, 
+00016750: 7929 0a20 2020 2072 6573 6964 7561 6c73  y).    residuals
+00016760: 203d 2028 7072 696d 616c 2c20 782c 2079   = (primal, x, y
+00016770: 290a 2020 2020 7265 7475 726e 2056 4a50  ).    return VJP
+00016780: 4475 616c 2870 7269 6d61 6c2c 2072 6573  Dual(primal, res
+00016790: 6964 7561 6c73 290a 0a0a 4072 6567 6973  iduals)...@regis
+000167a0: 7465 725f 6261 636b 7761 7264 2870 7269  ter_backward(pri
+000167b0: 6d73 2e50 7269 6d49 4473 2e50 4f57 290a  ms.PrimIDs.POW).
+000167c0: 6465 6620 706f 775f 6261 636b 7761 7264  def pow_backward
+000167d0: 2872 6573 756c 742c 2078 2c20 792c 2067  (result, x, y, g
+000167e0: 293a 0a20 2020 2069 6d70 6f72 7420 7468  ):.    import th
+000167f0: 756e 6465 722e 636c 616e 6720 6173 2074  under.clang as t
+00016800: 6c61 6e67 0a0a 2020 2020 6772 6573 756c  lang..    gresul
+00016810: 7420 3d20 6720 2a20 7265 7375 6c74 2020  t = g * result  
+00016820: 2320 7265 7573 6520 636f 6d6d 6f6e 2066  # reuse common f
+00016830: 6163 746f 720a 2020 2020 6478 203d 2067  actor.    dx = g
+00016840: 202a 2079 202a 2078 202a 2a20 2879 202d   * y * x ** (y -
+00016850: 2031 290a 2020 2020 6479 203d 2067 7265   1).    dy = gre
+00016860: 7375 6c74 202a 2074 6c61 6e67 2e6c 6f67  sult * tlang.log
+00016870: 2878 290a 2020 2020 7265 7475 726e 2064  (x).    return d
+00016880: 782c 2064 790a 0a0a 4072 6567 6973 7465  x, dy...@registe
+00016890: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
+000168a0: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
+000168b0: 732e 5441 4e29 0a64 6566 2074 616e 5f61  s.TAN).def tan_a
+000168c0: 7567 5f66 7764 2878 293a 0a20 2020 2022  ug_fwd(x):.    "
+000168d0: 2222 4175 676d 656e 7465 6420 7461 6e20  ""Augmented tan 
+000168e0: 6f70 6572 6174 696f 6e2e 0a0a 2020 2020  operation...    
+000168f0: 4172 6773 3a0a 2020 2020 2020 2020 7820  Args:.        x 
+00016900: 2856 6172 6961 626c 6529 3a20 5465 6e73  (Variable): Tens
+00016910: 6f72 2074 6f20 6265 2070 6173 7365 6420  or to be passed 
+00016920: 746f 2074 616e 2e0a 2020 2020 2222 220a  to tan..    """.
+00016930: 0a20 2020 2070 7269 6d61 6c20 3d20 7072  .    primal = pr
+00016940: 696d 732e 7461 6e28 7829 0a20 2020 2072  ims.tan(x).    r
+00016950: 6573 6964 7561 6c73 203d 2028 7072 696d  esiduals = (prim
+00016960: 616c 2c29 0a20 2020 2072 6574 7572 6e20  al,).    return 
+00016970: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
+00016980: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
+00016990: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
+000169a0: 7072 696d 732e 5072 696d 4944 732e 5441  prims.PrimIDs.TA
+000169b0: 4e29 0a64 6566 2074 616e 5f62 6163 6b77  N).def tan_backw
+000169c0: 6172 6428 7265 7375 6c74 2c20 6729 3a0a  ard(result, g):.
+000169d0: 2020 2020 7265 7475 726e 2067 202a 2028      return g * (
+000169e0: 3120 2b20 7265 7375 6c74 202a 2072 6573  1 + result * res
+000169f0: 756c 7429 0a0a 0a23 204e 4f54 453a 204a  ult)...# NOTE: J
+00016a00: 6178 2075 7365 7320 6e70 2e61 7267 736f  ax uses np.argso
+00016a10: 7274 2069 6e20 6974 7320 7472 616e 7370  rt in its transp
+00016a20: 6f73 6520 766a 7020 636f 6d70 7574 6174  ose vjp computat
+00016a30: 696f 6e0a 6465 6620 5f61 7267 736f 7274  ion.def _argsort
+00016a40: 2873 6571 293a 0a20 2020 2072 6574 7572  (seq):.    retur
+00016a50: 6e20 736f 7274 6564 2872 616e 6765 286c  n sorted(range(l
+00016a60: 656e 2873 6571 2929 2c20 6b65 793d 7365  en(seq)), key=se
+00016a70: 712e 5f5f 6765 7469 7465 6d5f 5f29 0a0a  q.__getitem__)..
+00016a80: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
+00016a90: 6e74 6564 5f66 6f72 7761 7264 2870 7269  nted_forward(pri
+00016aa0: 6d73 2e50 7269 6d49 4473 2e44 4556 4943  ms.PrimIDs.DEVIC
+00016ab0: 455f 5055 5429 0a64 6566 2064 6576 6963  E_PUT).def devic
+00016ac0: 655f 7075 745f 6175 675f 6677 6428 613a  e_put_aug_fwd(a:
+00016ad0: 2054 656e 736f 7250 726f 7879 2c20 6465   TensorProxy, de
+00016ae0: 7669 6365 3a20 4465 7669 6365 2920 2d3e  vice: Device) ->
+00016af0: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
+00016b00: 2020 7072 696d 616c 203d 2070 7269 6d73    primal = prims
+00016b10: 2e64 6576 6963 655f 7075 7428 612c 2064  .device_put(a, d
+00016b20: 6576 6963 6529 0a20 2020 2072 6573 6964  evice).    resid
+00016b30: 7561 6c73 203d 2028 612e 6465 7669 6365  uals = (a.device
+00016b40: 2c29 0a20 2020 2072 6574 7572 6e20 564a  ,).    return VJ
+00016b50: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
+00016b60: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
+00016b70: 7374 6572 5f62 6163 6b77 6172 6428 7072  ster_backward(pr
+00016b80: 696d 732e 5072 696d 4944 732e 4445 5649  ims.PrimIDs.DEVI
+00016b90: 4345 5f50 5554 290a 6465 6620 6465 7669  CE_PUT).def devi
+00016ba0: 6365 5f70 7574 5f62 6163 6b77 6172 6428  ce_put_backward(
+00016bb0: 6f72 6967 5f64 6576 6963 652c 2067 293a  orig_device, g):
+00016bc0: 0a20 2020 2072 6574 7572 6e20 7072 696d  .    return prim
+00016bd0: 732e 6465 7669 6365 5f70 7574 2867 2c20  s.device_put(g, 
+00016be0: 6f72 6967 5f64 6576 6963 6529 2c20 4e6f  orig_device), No
+00016bf0: 6e65 0a0a 0a40 7265 6769 7374 6572 5f61  ne...@register_a
+00016c00: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+00016c10: 2870 7269 6d73 2e50 7269 6d49 4473 2e43  (prims.PrimIDs.C
+00016c20: 4f4e 564f 4c55 5449 4f4e 290a 6465 6620  ONVOLUTION).def 
+00016c30: 636f 6e76 6f6c 7574 696f 6e5f 6175 675f  convolution_aug_
+00016c40: 6677 6428 0a20 2020 2061 3a20 5072 6f78  fwd(.    a: Prox
+00016c50: 792c 0a20 2020 2077 6569 6768 742c 0a20  y,.    weight,. 
+00016c60: 2020 2062 6961 732c 0a20 2020 2073 7472     bias,.    str
+00016c70: 6964 652c 0a20 2020 2070 6164 6469 6e67  ide,.    padding
+00016c80: 2c0a 2020 2020 6469 6c61 7469 6f6e 2c0a  ,.    dilation,.
+00016c90: 2020 2020 7472 616e 7370 6f73 6564 2c0a      transposed,.
+00016ca0: 2020 2020 6f75 7470 7574 5f70 6164 6469      output_paddi
+00016cb0: 6e67 2c0a 2020 2020 6772 6f75 7073 2c0a  ng,.    groups,.
+00016cc0: 293a 0a20 2020 2070 7269 6d61 6c20 3d20  ):.    primal = 
+00016cd0: 636f 6e76 6f6c 7574 696f 6e28 612c 2077  convolution(a, w
+00016ce0: 6569 6768 742c 2062 6961 732c 2073 7472  eight, bias, str
+00016cf0: 6964 652c 2070 6164 6469 6e67 2c20 6469  ide, padding, di
+00016d00: 6c61 7469 6f6e 2c20 7472 616e 7370 6f73  lation, transpos
+00016d10: 6564 2c20 6f75 7470 7574 5f70 6164 6469  ed, output_paddi
+00016d20: 6e67 2c20 6772 6f75 7073 290a 2020 2020  ng, groups).    
+00016d30: 7265 7369 6475 616c 7320 3d20 2870 7269  residuals = (pri
+00016d40: 6d61 6c2c 2061 2c20 7765 6967 6874 2c20  mal, a, weight, 
+00016d50: 6269 6173 2c20 7374 7269 6465 2c20 7061  bias, stride, pa
+00016d60: 6464 696e 672c 2064 696c 6174 696f 6e2c  dding, dilation,
+00016d70: 2074 7261 6e73 706f 7365 642c 206f 7574   transposed, out
+00016d80: 7075 745f 7061 6464 696e 672c 2067 726f  put_padding, gro
+00016d90: 7570 7329 0a20 2020 2072 6574 7572 6e20  ups).    return 
+00016da0: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
+00016db0: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
+00016dc0: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
+00016dd0: 7072 696d 732e 5072 696d 4944 732e 434f  prims.PrimIDs.CO
+00016de0: 4e56 4f4c 5554 494f 4e29 0a64 6566 2063  NVOLUTION).def c
+00016df0: 6f6e 766f 6c75 7469 6f6e 5f62 6163 6b77  onvolution_backw
+00016e00: 6172 6428 0a20 2020 206f 7574 7075 743a  ard(.    output:
+00016e10: 2050 726f 7879 2c0a 2020 2020 696e 7075   Proxy,.    inpu
+00016e20: 743a 2050 726f 7879 2c0a 2020 2020 7765  t: Proxy,.    we
+00016e30: 6967 6874 2c0a 2020 2020 6269 6173 2c0a  ight,.    bias,.
+00016e40: 2020 2020 7374 7269 6465 2c0a 2020 2020      stride,.    
+00016e50: 7061 6464 696e 672c 0a20 2020 2064 696c  padding,.    dil
+00016e60: 6174 696f 6e2c 0a20 2020 2074 7261 6e73  ation,.    trans
+00016e70: 706f 7365 642c 0a20 2020 206f 7574 7075  posed,.    outpu
+00016e80: 745f 7061 6464 696e 672c 0a20 2020 2067  t_padding,.    g
+00016e90: 726f 7570 732c 0a20 2020 2067 7261 642c  roups,.    grad,
+00016ea0: 0a29 3a0a 2020 2020 2320 5472 616e 7370  .):.    # Transp
+00016eb0: 6f73 6564 2063 6f6e 766f 6c75 7469 6f6e  osed convolution
+00016ec0: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
+00016ed0: 6421 0a20 2020 2061 7373 6572 7420 7472  d!.    assert tr
+00016ee0: 616e 7370 6f73 6564 203d 3d20 300a 0a20  ansposed == 0.. 
+00016ef0: 2020 2069 6e70 7574 5f67 7261 6420 3d20     input_grad = 
+00016f00: 4e6f 6e65 0a20 2020 2077 6569 6768 745f  None.    weight_
+00016f10: 6772 6164 203d 204e 6f6e 650a 2020 2020  grad = None.    
+00016f20: 6269 6173 5f67 7261 6420 3d20 4e6f 6e65  bias_grad = None
+00016f30: 0a0a 2020 2020 2320 5368 6f72 7420 6369  ..    # Short ci
+00016f40: 7263 7569 7420 6f6e 207a 6572 6f2d 6469  rcuit on zero-di
+00016f50: 6d20 6772 6164 0a20 2020 2069 6620 616e  m grad.    if an
+00016f60: 7928 7320 3d3d 2030 2066 6f72 2073 2069  y(s == 0 for s i
+00016f70: 6e20 6772 6164 2e73 6861 7065 293a 0a20  n grad.shape):. 
+00016f80: 2020 2020 2020 2069 6e70 7574 5f67 7261         input_gra
+00016f90: 6420 3d20 6675 6c6c 5f6c 696b 6528 696e  d = full_like(in
+00016fa0: 7075 742c 2066 696c 6c5f 7661 6c75 653d  put, fill_value=
+00016fb0: 3029 0a20 2020 2020 2020 2077 6569 6768  0).        weigh
+00016fc0: 745f 6772 6164 203d 2066 756c 6c5f 6c69  t_grad = full_li
+00016fd0: 6b65 2877 6569 6768 742c 2066 696c 6c5f  ke(weight, fill_
+00016fe0: 7661 6c75 653d 3029 0a20 2020 2020 2020  value=0).       
+00016ff0: 2069 6620 6269 6173 2069 7320 6e6f 7420   if bias is not 
+00017000: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00017010: 2020 6269 6173 5f67 7261 6420 3d20 6675    bias_grad = fu
+00017020: 6c6c 5f6c 696b 6528 6269 6173 2c20 6669  ll_like(bias, fi
+00017030: 6c6c 5f76 616c 7565 3d30 290a 2020 2020  ll_value=0).    
+00017040: 2020 2020 7265 7475 726e 2028 696e 7075      return (inpu
+00017050: 745f 6772 6164 2c20 7765 6967 6874 5f67  t_grad, weight_g
+00017060: 7261 642c 2062 6961 735f 6772 6164 2920  rad, bias_grad) 
+00017070: 2b20 2828 4e6f 6e65 2c29 202a 2036 290a  + ((None,) * 6).
+00017080: 0a20 2020 2062 6174 6368 2c20 696e 5f63  .    batch, in_c
+00017090: 6861 6e6e 656c 732c 202a 7370 6174 6961  hannels, *spatia
+000170a0: 6c5f 6469 6d73 203d 2069 6e70 7574 2e73  l_dims = input.s
+000170b0: 6861 7065 0a20 2020 206f 7574 5f63 6861  hape.    out_cha
+000170c0: 6e6e 656c 732c 2067 696e 5f63 6861 6e6e  nnels, gin_chann
+000170d0: 656c 732c 202a 6b65 726e 656c 5f64 696d  els, *kernel_dim
+000170e0: 7320 3d20 7765 6967 6874 2e73 6861 7065  s = weight.shape
+000170f0: 0a20 2020 2064 696d 203d 206c 656e 2873  .    dim = len(s
+00017100: 7061 7469 616c 5f64 696d 7329 0a0a 2020  patial_dims)..  
+00017110: 2020 6465 6620 6d61 7962 655f 6578 7061    def maybe_expa
+00017120: 6e64 5f73 6571 2873 2c20 6469 6d29 3a0a  nd_seq(s, dim):.
+00017130: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
+00017140: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
+00017150: 2020 2020 7265 7475 726e 2028 735b 305d      return (s[0]
+00017160: 2c29 202a 2064 696d 0a20 2020 2020 2020  ,) * dim.       
+00017170: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00017180: 2020 2072 6574 7572 6e20 730a 0a20 2020     return s..   
+00017190: 2073 7472 6964 6520 3d20 6d61 7962 655f   stride = maybe_
+000171a0: 6578 7061 6e64 5f73 6571 2873 7472 6964  expand_seq(strid
+000171b0: 652c 2064 696d 290a 2020 2020 7061 6464  e, dim).    padd
+000171c0: 696e 6720 3d20 6d61 7962 655f 6578 7061  ing = maybe_expa
+000171d0: 6e64 5f73 6571 2870 6164 6469 6e67 2c20  nd_seq(padding, 
+000171e0: 6469 6d29 0a20 2020 2064 696c 6174 696f  dim).    dilatio
+000171f0: 6e20 3d20 6d61 7962 655f 6578 7061 6e64  n = maybe_expand
+00017200: 5f73 6571 2864 696c 6174 696f 6e2c 2064  _seq(dilation, d
+00017210: 696d 290a 0a20 2020 2064 6566 2063 6f6e  im)..    def con
+00017220: 765f 7472 616e 7370 6f73 6528 7429 3a0a  v_transpose(t):.
+00017230: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+00017240: 7269 6d73 2e74 7261 6e73 706f 7365 2874  rims.transpose(t
+00017250: 2c20 2831 2c20 3029 202b 2074 7570 6c65  , (1, 0) + tuple
+00017260: 2872 616e 6765 2832 2c20 742e 6e64 696d  (range(2, t.ndim
+00017270: 2929 290a 0a20 2020 2023 2069 6e70 7574  )))..    # input
+00017280: 5f67 7261 6420 3d20 7b0a 2020 2020 6465  _grad = {.    de
+00017290: 6620 7472 616e 7370 6f73 655f 616e 645f  f transpose_and_
+000172a0: 666c 6970 5f77 6569 6768 7428 7765 6967  flip_weight(weig
+000172b0: 6874 293a 0a20 2020 2020 2020 2023 2054  ht):.        # T
+000172c0: 6865 206c 696e 6573 2062 656c 6f77 2061  he lines below a
+000172d0: 7265 2074 7261 6e73 706f 7369 6e67 2074  re transposing t
+000172e0: 6865 2063 6861 6e6e 656c 7320 6469 6d73  he channels dims
+000172f0: 2e0a 2020 2020 2020 2020 2320 5765 2061  ..        # We a
+00017300: 6c73 6f20 6e65 6564 2074 6f20 6578 7472  lso need to extr
+00017310: 6163 7420 7468 6520 6772 6f75 7020 696e  act the group in
+00017320: 666f 726d 6174 696f 6e20 616e 6420 6d65  formation and me
+00017330: 7267 6520 6974 0a20 2020 2020 2020 2023  rge it.        #
+00017340: 2077 6974 6820 7468 6520 6469 6d65 6e73   with the dimens
+00017350: 696f 6e20 636f 7272 6573 706f 6e64 696e  ion correspondin
+00017360: 6720 746f 2074 6865 2022 6f75 745f 6368  g to the "out_ch
+00017370: 616e 6e65 6c73 2220 6469 6d2e 0a20 2020  annels" dim..   
+00017380: 2020 2020 2023 2028 6f75 745f 6368 616e       # (out_chan
+00017390: 6e65 6c73 2c20 6769 6e5f 6368 616e 6e65  nels, gin_channe
+000173a0: 6c73 2920 2d3e 2028 6769 6e5f 6368 616e  ls) -> (gin_chan
+000173b0: 6e65 6c73 2c20 6f75 745f 6368 616e 6e65  nels, out_channe
+000173c0: 6c73 290a 2020 2020 2020 2020 7765 6967  ls).        weig
+000173d0: 6874 203d 2063 6f6e 765f 7472 616e 7370  ht = conv_transp
+000173e0: 6f73 6528 7765 6967 6874 290a 2020 2020  ose(weight).    
+000173f0: 2020 2020 2320 5370 6c69 7420 286f 7574      # Split (out
+00017400: 5f63 6861 6e6e 656c 732c 2920 2d3e 2028  _channels,) -> (
+00017410: 6772 6f75 7073 2c20 6f75 745f 6368 616e  groups, out_chan
+00017420: 6e65 6c73 202f 2f20 6772 6f75 7073 290a  nels // groups).
+00017430: 2020 2020 2020 2020 7765 6967 6874 203d          weight =
+00017440: 2077 6569 6768 742e 7265 7368 6170 6528   weight.reshape(
+00017450: 5b67 696e 5f63 6861 6e6e 656c 732c 2067  [gin_channels, g
+00017460: 726f 7570 732c 206f 7574 5f63 6861 6e6e  roups, out_chann
+00017470: 656c 7320 2f2f 2067 726f 7570 735d 202b  els // groups] +
+00017480: 206b 6572 6e65 6c5f 6469 6d73 290a 2020   kernel_dims).  
+00017490: 2020 2020 2020 2320 4d6f 7669 6e67 2067        # Moving g
+000174a0: 726f 7570 7320 746f 2074 6865 206c 6566  roups to the lef
+000174b0: 742d 6d6f 7374 2070 6f73 6974 696f 6e2e  t-most position.
+000174c0: 0a20 2020 2020 2020 2023 2028 6769 6e5f  .        # (gin_
+000174d0: 6368 616e 6e65 6c73 2c20 6772 6f75 7073  channels, groups
+000174e0: 2c20 6f75 745f 6368 616e 6e65 6c73 202f  , out_channels /
+000174f0: 2f20 6772 6f75 7073 2920 2d3e 2028 6772  / groups) -> (gr
+00017500: 6f75 7073 2c20 6769 6e5f 6368 616e 6e65  oups, gin_channe
+00017510: 6c73 2c20 6f75 745f 6368 616e 6e65 6c73  ls, out_channels
+00017520: 202f 2f20 6772 6f75 7073 290a 2020 2020   // groups).    
+00017530: 2020 2020 7765 6967 6874 203d 2063 6f6e      weight = con
+00017540: 765f 7472 616e 7370 6f73 6528 7765 6967  v_transpose(weig
+00017550: 6874 290a 2020 2020 2020 2020 2320 5371  ht).        # Sq
+00017560: 7561 7368 2028 6772 6f75 7073 2c20 6769  uash (groups, gi
+00017570: 6e5f 6368 616e 6e65 6c73 2920 2d3e 2028  n_channels) -> (
+00017580: 696e 5f63 6861 6e6e 656c 7329 0a20 2020  in_channels).   
+00017590: 2020 2020 2077 6569 6768 7420 3d20 7765       weight = we
+000175a0: 6967 6874 2e72 6573 6861 7065 285b 696e  ight.reshape([in
+000175b0: 5f63 6861 6e6e 656c 732c 206f 7574 5f63  _channels, out_c
+000175c0: 6861 6e6e 656c 7320 2f2f 2067 726f 7570  hannels // group
+000175d0: 735d 202b 206b 6572 6e65 6c5f 6469 6d73  s] + kernel_dims
+000175e0: 290a 0a20 2020 2020 2020 2023 2046 6c69  )..        # Fli
+000175f0: 7020 7370 6174 6961 6c20 6469 6d65 6e73  p spatial dimens
+00017600: 696f 6e73 0a20 2020 2020 2020 2077 6569  ions.        wei
+00017610: 6768 7420 3d20 7072 696d 732e 666c 6970  ght = prims.flip
+00017620: 2877 6569 6768 742c 2074 7570 6c65 2872  (weight, tuple(r
+00017630: 616e 6765 2832 2c20 7765 6967 6874 2e6e  ange(2, weight.n
+00017640: 6469 6d29 2929 0a20 2020 2020 2020 2072  dim))).        r
+00017650: 6574 7572 6e20 7765 6967 6874 0a0a 2020  eturn weight..  
+00017660: 2020 2320 5765 206e 6565 6420 746f 2070    # We need to p
+00017670: 6164 2074 6865 2067 7261 6469 656e 7420  ad the gradient 
+00017680: 746f 2062 6520 6162 6c65 2074 6f20 6669  to be able to fi
+00017690: 7420 6b65 726e 656c 2077 696e 646f 7773  t kernel windows
+000176a0: 2e0a 2020 2020 696e 6974 6961 6c5f 6772  ..    initial_gr
+000176b0: 6164 5f70 6164 6469 6e67 203d 205b 6420  ad_padding = [d 
+000176c0: 2a20 286b 202d 2031 2920 666f 7220 642c  * (k - 1) for d,
+000176d0: 206b 2069 6e20 7a69 7028 6469 6c61 7469   k in zip(dilati
+000176e0: 6f6e 2c20 6b65 726e 656c 5f64 696d 7329  on, kernel_dims)
+000176f0: 5d0a 0a20 2020 2069 6e70 7574 5f67 7261  ]..    input_gra
+00017700: 6420 3d20 636f 6e76 6f6c 7574 696f 6e28  d = convolution(
+00017710: 0a20 2020 2020 2020 2070 7269 6d73 2e70  .        prims.p
+00017720: 6164 280a 2020 2020 2020 2020 2020 2020  ad(.            
+00017730: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
+00017740: 2020 302e 302c 0a20 2020 2020 2020 2020    0.0,.         
+00017750: 2020 2023 2054 6865 2070 6978 6573 2061     # The pixes a
+00017760: 7265 2073 7472 6964 6520 6177 6179 2066  re stride away f
+00017770: 726f 6d20 6561 6368 206f 7468 6572 2069  rom each other i
+00017780: 6e20 7468 6520 6f72 6967 696e 616c 2069  n the original i
+00017790: 6e70 7574 2e0a 2020 2020 2020 2020 2020  nput..          
+000177a0: 2020 2320 4865 6e63 6520 7765 206e 6565    # Hence we nee
+000177b0: 6420 746f 2064 696c 6174 6520 7468 6520  d to dilate the 
+000177c0: 6772 6164 6965 6e74 2062 7920 6469 6c61  gradient by dila
+000177d0: 7469 6f6e 3d73 7472 6964 6520 2d20 310a  tion=stride - 1.
+000177e0: 2020 2020 2020 2020 2020 2020 2320 736f              # so
+000177f0: 2074 6861 7420 7468 6572 6520 6172 6520   that there are 
+00017800: 7374 7269 6465 202d 2031 207a 6572 6f73  stride - 1 zeros
+00017810: 2062 6574 7765 656e 2074 6865 2070 6978   between the pix
+00017820: 656c 732e 0a20 2020 2020 2020 2020 2020  els..           
+00017830: 205b 2830 2c20 302c 2030 292c 2028 302c   [(0, 0, 0), (0,
+00017840: 2030 2c20 3029 5d20 2b20 5b28 302c 2030   0, 0)] + [(0, 0
+00017850: 2c20 7320 2d20 3129 2066 6f72 2073 2069  , s - 1) for s i
+00017860: 6e20 7374 7269 6465 5d2c 0a20 2020 2020  n stride],.     
+00017870: 2020 2029 2c0a 2020 2020 2020 2020 7472     ),.        tr
+00017880: 616e 7370 6f73 655f 616e 645f 666c 6970  anspose_and_flip
+00017890: 5f77 6569 6768 7428 7765 6967 6874 292c  _weight(weight),
+000178a0: 0a20 2020 2020 2020 204e 6f6e 652c 0a20  .        None,. 
+000178b0: 2020 2020 2020 2023 2053 6574 7469 6e67         # Setting
+000178c0: 2073 7472 6964 6520 746f 2031 2061 7320   stride to 1 as 
+000178d0: 7468 6520 6469 7374 616e 6365 2062 6574  the distance bet
+000178e0: 7765 656e 2070 6978 656c 7320 6973 2074  ween pixels is t
+000178f0: 616b 656e 0a20 2020 2020 2020 2023 2063  aken.        # c
+00017900: 6172 6520 6279 2074 6865 2070 6164 2072  are by the pad r
+00017910: 6967 6874 2061 626f 7665 2e0a 2020 2020  ight above..    
+00017920: 2020 2020 2831 2c29 2c0a 2020 2020 2020      (1,),.      
+00017930: 2020 696e 6974 6961 6c5f 6772 6164 5f70    initial_grad_p
+00017940: 6164 6469 6e67 2c0a 2020 2020 2020 2020  adding,.        
+00017950: 6469 6c61 7469 6f6e 2c0a 2020 2020 2020  dilation,.      
+00017960: 2020 7472 616e 7370 6f73 6564 2c0a 2020    transposed,.  
+00017970: 2020 2020 2020 6f75 7470 7574 5f70 6164        output_pad
+00017980: 6469 6e67 2c0a 2020 2020 2020 2020 6772  ding,.        gr
+00017990: 6f75 7073 2c0a 2020 2020 290a 0a20 2020  oups,.    )..   
+000179a0: 2064 6566 2070 6164 5f74 6f5f 696e 7075   def pad_to_inpu
+000179b0: 7428 6772 6164 293a 0a20 2020 2020 2020  t(grad):.       
+000179c0: 2023 2057 6520 6e65 6564 2074 6f20 756e   # We need to un
+000179d0: 7061 6420 7468 6520 7061 6464 696e 6720  pad the padding 
+000179e0: 646f 6e65 2074 6f20 7468 6520 696e 7075  done to the inpu
+000179f0: 7420 7072 696f 7220 746f 2074 6865 2063  t prior to the c
+00017a00: 6f6e 766f 6c75 7469 6f6e 2e0a 2020 2020  onvolution..    
+00017a10: 2020 2020 2320 4e6f 7465 2074 6861 7420      # Note that 
+00017a20: 6c6f 7720 616e 6420 6869 6768 2070 6164  low and high pad
+00017a30: 6469 6e67 2061 7265 206e 6f74 206e 6563  ding are not nec
+00017a40: 6573 7361 7269 6c79 2065 7175 616c 2c20  essarily equal, 
+00017a50: 736f 2077 6520 6361 6e6e 6f74 0a20 2020  so we cannot.   
+00017a60: 2020 2020 2023 2061 6273 6f72 6220 6974       # absorb it
+00017a70: 2069 6e74 6f20 7468 6520 636f 6e76 6f6c   into the convol
+00017a80: 7574 696f 6e20 6a75 7374 2079 6574 2c20  ution just yet, 
+00017a90: 756e 6c65 7373 2074 6865 2041 5049 2069  unless the API i
+00017aa0: 7320 6d6f 6469 6669 6564 2e0a 2020 2020  s modified..    
+00017ab0: 2020 2020 7061 645f 636f 6e66 6967 203d      pad_config =
+00017ac0: 205b 2830 2c20 302c 2030 292c 2028 302c   [(0, 0, 0), (0,
+00017ad0: 2030 2c20 3029 5d0a 2020 2020 2020 2020   0, 0)].        
+00017ae0: 666f 7220 6f2c 2069 2c20 672c 2070 2069  for o, i, g, p i
+00017af0: 6e20 7a69 7028 6772 6164 2e73 6861 7065  n zip(grad.shape
+00017b00: 5b32 3a5d 2c20 7370 6174 6961 6c5f 6469  [2:], spatial_di
+00017b10: 6d73 2c20 696e 7075 745f 6772 6164 2e73  ms, input_grad.s
+00017b20: 6861 7065 5b32 3a5d 2c20 7061 6464 696e  hape[2:], paddin
+00017b30: 6729 3a0a 2020 2020 2020 2020 2020 2020  g):.            
+00017b40: 6c6f 203d 202d 700a 2020 2020 2020 2020  lo = -p.        
+00017b50: 2020 2020 2320 4e6f 7465 2074 6861 7420      # Note that 
+00017b60: 2869 202b 2032 202a 2070 2920 6973 2074  (i + 2 * p) is t
+00017b70: 6865 2073 697a 6520 6f66 2074 6865 2070  he size of the p
+00017b80: 6164 6465 6420 696e 7075 742c 0a20 2020  added input,.   
+00017b90: 2020 2020 2020 2020 2023 2073 6f20 7468           # so th
+00017ba0: 6520 7175 616e 7469 7479 2028 6920 2b20  e quantity (i + 
+00017bb0: 3220 2a20 7029 202d 2067 2074 656c 6c73  2 * p) - g tells
+00017bc0: 2075 7320 6279 2068 6f77 206d 7563 680a   us by how much.
+00017bd0: 2020 2020 2020 2020 2020 2020 2320 7765              # we
+00017be0: 206e 6565 6420 746f 2070 6164 2074 6865   need to pad the
+00017bf0: 2067 7261 6469 656e 7420 736f 2074 6861   gradient so tha
+00017c00: 7420 7468 6520 656c 656d 656e 7473 206f  t the elements o
+00017c10: 7574 7369 6465 0a20 2020 2020 2020 2020  utside.         
+00017c20: 2020 2023 206f 6620 7468 6520 636f 6e76     # of the conv
+00017c30: 6f6c 7574 696f 6e20 7265 6365 6976 6520  olution receive 
+00017c40: 7a65 726f 2067 7261 6469 656e 742e 0a20  zero gradient.. 
+00017c50: 2020 2020 2020 2020 2020 2023 2070 2069             # p i
+00017c60: 7320 6164 6469 7469 6f6e 616c 6c79 2073  s additionally s
+00017c70: 7562 7472 6163 7465 6420 746f 206e 6567  ubtracted to neg
+00017c80: 6174 6520 7468 6520 696e 7075 7427 7320  ate the input's 
+00017c90: 7061 640a 2020 2020 2020 2020 2020 2020  pad.            
+00017ca0: 2320 696e 2066 6f72 7761 7264 2e0a 2020  # in forward..  
+00017cb0: 2020 2020 2020 2020 2020 6869 203d 2028            hi = (
+00017cc0: 6920 2b20 3220 2a20 7029 202d 2067 202d  i + 2 * p) - g -
+00017cd0: 2070 0a20 2020 2020 2020 2020 2020 2070   p.            p
+00017ce0: 6164 5f63 6f6e 6669 672e 6170 7065 6e64  ad_config.append
+00017cf0: 2828 6c6f 2c20 6869 2c20 3029 290a 2020  ((lo, hi, 0)).  
+00017d00: 2020 2020 2020 7265 7475 726e 2070 7269        return pri
+00017d10: 6d73 2e70 6164 2867 7261 642c 2030 2e30  ms.pad(grad, 0.0
+00017d20: 2c20 7061 645f 636f 6e66 6967 290a 0a20  , pad_config).. 
+00017d30: 2020 2069 6e70 7574 5f67 7261 6420 3d20     input_grad = 
+00017d40: 7061 645f 746f 5f69 6e70 7574 2869 6e70  pad_to_input(inp
+00017d50: 7574 5f67 7261 6429 0a20 2020 2023 207d  ut_grad).    # }
+00017d60: 0a0a 2020 2020 2320 6269 6173 5f67 7261  ..    # bias_gra
+00017d70: 6420 3d20 7b0a 2020 2020 6966 2062 6961  d = {.    if bia
+00017d80: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+00017d90: 2020 2020 2020 2069 6d70 6f72 7420 7468         import th
+00017da0: 756e 6465 722e 746f 7263 6820 6173 206c  under.torch as l
+00017db0: 746f 7263 680a 0a20 2020 2020 2020 2062  torch..        b
+00017dc0: 6961 735f 6772 6164 203d 206c 746f 7263  ias_grad = ltorc
+00017dd0: 682e 7375 6d28 6772 6164 2c20 5b64 2066  h.sum(grad, [d f
+00017de0: 6f72 2064 2069 6e20 7261 6e67 6528 6772  or d in range(gr
+00017df0: 6164 2e6e 6469 6d29 2069 6620 6420 213d  ad.ndim) if d !=
+00017e00: 2031 5d29 0a20 2020 2023 207d 0a0a 2020   1]).    # }..  
+00017e10: 2020 2320 7765 6967 6874 2067 7261 6420    # weight grad 
+00017e20: 3d20 7b0a 2020 2020 6465 6620 7061 645f  = {.    def pad_
+00017e30: 7472 616e 7370 6f73 655f 616e 645f 7075  transpose_and_pu
+00017e40: 7368 5f67 726f 7570 735f 696e 746f 5f62  sh_groups_into_b
+00017e50: 6174 6368 6573 2874 293a 0a20 2020 2020  atches(t):.     
+00017e60: 2020 2023 2046 6972 7374 2070 6164 2c2e     # First pad,.
+00017e70: 2e2e 0a20 2020 2020 2020 2023 2050 6164  ...        # Pad
+00017e80: 2061 7320 6e65 6365 7373 6172 7920 736f   as necessary so
+00017e90: 2074 6861 7420 696e 2063 6f6e 766f 6c75   that in convolu
+00017ea0: 7469 6f6e 7320 7765 206e 6576 6572 2061  tions we never a
+00017eb0: 6476 616e 6365 0a20 2020 2020 2020 2023  dvance.        #
+00017ec0: 2070 6173 7420 7265 6c65 7661 6e74 2069   past relevant i
+00017ed0: 6e70 7574 732e 0a20 2020 2020 2020 2070  nputs..        p
+00017ee0: 6164 5f63 6f6e 6669 6720 3d20 5b28 302c  ad_config = [(0,
+00017ef0: 2030 2c20 3029 2c20 2830 2c20 302c 2030   0, 0), (0, 0, 0
+00017f00: 295d 0a20 2020 2020 2020 2066 6f72 206f  )].        for o
+00017f10: 2c20 692c 206b 2c20 702c 2073 2c20 6420  , i, k, p, s, d 
+00017f20: 696e 207a 6970 2867 7261 642e 7368 6170  in zip(grad.shap
+00017f30: 655b 323a 5d2c 2073 7061 7469 616c 5f64  e[2:], spatial_d
+00017f40: 696d 732c 206b 6572 6e65 6c5f 6469 6d73  ims, kernel_dims
+00017f50: 2c20 7061 6464 696e 672c 2073 7472 6964  , padding, strid
+00017f60: 652c 2064 696c 6174 696f 6e29 3a0a 2020  e, dilation):.  
+00017f70: 2020 2020 2020 2020 2020 2320 5061 6464            # Padd
+00017f80: 696e 6720 6672 6f6d 2062 656c 6f77 2069  ing from below i
+00017f90: 7320 7468 6520 7361 6d65 2e0a 2020 2020  s the same..    
+00017fa0: 2020 2020 2020 2020 6c6f 203d 2070 0a20          lo = p. 
+00017fb0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+00017fc0: 7265 2069 7320 616c 7761 7973 2074 6865  re is always the
+00017fd0: 206d 6178 2069 6e64 6578 2069 6478 2069   max index idx i
+00017fe0: 6e20 7468 6520 696e 7075 740a 2020 2020  n the input.    
+00017ff0: 2020 2020 2020 2020 2320 7468 6520 7661          # the va
+00018000: 6c75 6520 6f66 2077 6869 6368 2c20 696e  lue of which, in
+00018010: 7075 745b 6964 785d 2c20 7468 6520 6b65  put[idx], the ke
+00018020: 726e 656c 2074 6f75 6368 6573 2e0a 2020  rnel touches..  
+00018030: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
+00018040: 6b65 726e 656c 2072 6561 6368 2c20 6f72  kernel reach, or
+00018050: 206b 5f72 6561 6368 2c20 6973 2065 7861   k_reach, is exa
+00018060: 6374 6c79 2069 6478 202b 2031 2e0a 2020  ctly idx + 1..  
+00018070: 2020 2020 2020 2020 2020 2320 5765 2075            # We u
+00018080: 7365 2069 7420 746f 2064 6563 6964 6520  se it to decide 
+00018090: 6279 2068 6f77 206d 7563 6820 7765 206e  by how much we n
+000180a0: 6565 6420 746f 2070 6164 2066 726f 6d20  eed to pad from 
+000180b0: 6162 6f76 650a 2020 2020 2020 2020 2020  above.          
+000180c0: 2020 2320 6173 2074 6f20 6e6f 7420 6d6f    # as to not mo
+000180d0: 7665 2070 6173 7420 7265 6c65 7661 6e74  ve past relevant
+000180e0: 2076 616c 7565 732e 0a20 2020 2020 2020   values..       
+000180f0: 2020 2020 206b 5f72 6561 6368 203d 2028       k_reach = (
+00018100: 6f20 2d20 3129 202a 2073 202b 2064 202a  o - 1) * s + d *
+00018110: 2028 6b20 2d20 3129 202b 2031 0a20 2020   (k - 1) + 1.   
+00018120: 2020 2020 2020 2020 2023 2054 6865 2070           # The p
+00018130: 6164 2066 726f 6d20 6162 6f76 6520 6571  ad from above eq
+00018140: 7561 6c73 206b 5f72 6561 6368 206d 696e  uals k_reach min
+00018150: 7573 2074 6865 206c 656e 6774 680a 2020  us the length.  
+00018160: 2020 2020 2020 2020 2020 2320 6f66 2074            # of t
+00018170: 6865 2069 6e70 7574 2070 6164 6465 6420  he input padded 
+00018180: 6672 6f6d 2062 656c 6f77 2e0a 2020 2020  from below..    
+00018190: 2020 2020 2020 2020 6869 203d 206b 5f72          hi = k_r
+000181a0: 6561 6368 202d 2028 6920 2b20 7029 0a20  each - (i + p). 
+000181b0: 2020 2020 2020 2020 2020 2070 6164 5f63             pad_c
+000181c0: 6f6e 6669 672e 6170 7065 6e64 2828 6c6f  onfig.append((lo
+000181d0: 2c20 6869 2c20 3029 290a 2020 2020 2020  , hi, 0)).      
+000181e0: 2020 7420 3d20 7072 696d 732e 7061 6428    t = prims.pad(
+000181f0: 742c 2030 2e30 2c20 7061 645f 636f 6e66  t, 0.0, pad_conf
+00018200: 6967 290a 0a20 2020 2020 2020 205f 2c20  ig)..        _, 
+00018210: 5f2c 202a 745f 7370 6174 6961 6c5f 6469  _, *t_spatial_di
+00018220: 6d73 203d 2074 2e73 6861 7065 0a0a 2020  ms = t.shape..  
+00018230: 2020 2020 2020 2320 2e2e 2e20 7468 656e        # ... then
+00018240: 2064 6f20 7468 6520 7265 7374 2e0a 2020   do the rest..  
+00018250: 2020 2020 2020 2320 742e 7368 6170 6520        # t.shape 
+00018260: 3d3d 2028 6261 7463 682c 2069 6e5f 6368  == (batch, in_ch
+00018270: 616e 6e65 6c73 2c20 2e2e 2e29 0a20 2020  annels, ...).   
+00018280: 2020 2020 2023 2054 6865 2072 6573 756c       # The resul
+00018290: 7420 6f66 2074 6869 7320 6675 6e63 7469  t of this functi
+000182a0: 6f6e 2068 6173 2073 6861 7065 0a20 2020  on has shape.   
+000182b0: 2020 2020 2023 2028 696e 5f63 6861 6e6e       # (in_chann
+000182c0: 656c 732c 2062 6174 6368 202a 2067 726f  els, batch * gro
+000182d0: 7570 7329 0a20 2020 2020 2020 2023 2028  ups).        # (
+000182e0: 6261 7463 682c 2069 6e5f 6368 616e 6e65  batch, in_channe
+000182f0: 6c73 2920 2d3e 2028 696e 5f63 6861 6e6e  ls) -> (in_chann
+00018300: 656c 732c 2062 6174 6368 290a 2020 2020  els, batch).    
+00018310: 2020 2020 7420 3d20 636f 6e76 5f74 7261      t = conv_tra
+00018320: 6e73 706f 7365 2874 290a 2020 2020 2020  nspose(t).      
+00018330: 2020 2320 5370 6c69 7420 2869 6e5f 6368    # Split (in_ch
+00018340: 616e 6e65 6c73 2c29 202d 3e20 2867 726f  annels,) -> (gro
+00018350: 7570 732c 2067 696e 5f63 6861 6e6e 656c  ups, gin_channel
+00018360: 7329 0a20 2020 2020 2020 2074 203d 2074  s).        t = t
+00018370: 2e72 6573 6861 7065 285b 6772 6f75 7073  .reshape([groups
+00018380: 2c20 6769 6e5f 6368 616e 6e65 6c73 2c20  , gin_channels, 
+00018390: 6261 7463 685d 202b 2074 5f73 7061 7469  batch] + t_spati
+000183a0: 616c 5f64 696d 7329 0a20 2020 2020 2020  al_dims).       
+000183b0: 2023 2054 7261 6e73 706f 7365 2028 6772   # Transpose (gr
+000183c0: 6f75 7073 2c20 6769 6e5f 6368 616e 6e65  oups, gin_channe
+000183d0: 6c73 2c20 6261 7463 6829 202d 3e20 2867  ls, batch) -> (g
+000183e0: 696e 5f63 6861 6e6e 656c 732c 2067 726f  in_channels, gro
+000183f0: 7570 732c 2062 6174 6368 290a 2020 2020  ups, batch).    
+00018400: 2020 2020 7420 3d20 636f 6e76 5f74 7261      t = conv_tra
+00018410: 6e73 706f 7365 2874 290a 2020 2020 2020  nspose(t).      
+00018420: 2020 2320 466c 6174 7465 6e20 2867 726f    # Flatten (gro
+00018430: 7570 732c 2062 6174 6368 2920 2d3e 2028  ups, batch) -> (
+00018440: 6772 6f75 7073 202a 2062 6174 6368 2c29  groups * batch,)
+00018450: 0a20 2020 2020 2020 2074 203d 2074 2e72  .        t = t.r
+00018460: 6573 6861 7065 285b 6769 6e5f 6368 616e  eshape([gin_chan
+00018470: 6e65 6c73 2c20 6772 6f75 7073 202a 2062  nels, groups * b
+00018480: 6174 6368 5d20 2b20 745f 7370 6174 6961  atch] + t_spatia
+00018490: 6c5f 6469 6d73 290a 2020 2020 2020 2020  l_dims).        
+000184a0: 7265 7475 726e 2074 0a0a 2020 2020 2320  return t..    # 
+000184b0: 696e 7075 7420 7769 6c6c 2068 6176 6520  input will have 
+000184c0: 7368 6170 6520 2867 696e 5f63 6861 6e6e  shape (gin_chann
+000184d0: 656c 732c 2067 726f 7570 7320 2a20 6261  els, groups * ba
+000184e0: 7463 6829 0a20 2020 2069 6e70 7574 203d  tch).    input =
+000184f0: 2070 6164 5f74 7261 6e73 706f 7365 5f61   pad_transpose_a
+00018500: 6e64 5f70 7573 685f 6772 6f75 7073 5f69  nd_push_groups_i
+00018510: 6e74 6f5f 6261 7463 6865 7328 696e 7075  nto_batches(inpu
+00018520: 7429 0a20 2020 2023 2067 7261 6420 7769  t).    # grad wi
+00018530: 6c6c 2068 6176 6520 7368 6170 6520 286f  ll have shape (o
+00018540: 7574 5f63 6861 6e6e 656c 732c 2062 6174  ut_channels, bat
+00018550: 6368 290a 2020 2020 2320 4e6f 7465 2074  ch).    # Note t
+00018560: 6861 7420 7468 6573 6520 7368 6170 6573  hat these shapes
+00018570: 2061 7265 2063 6f6d 7061 7469 626c 6520   are compatible 
+00018580: 666f 7220 6120 6772 6f75 7020 636f 6e76  for a group conv
+00018590: 6f6c 7574 696f 6e2e 0a20 2020 2067 7261  olution..    gra
+000185a0: 6420 3d20 636f 6e76 5f74 7261 6e73 706f  d = conv_transpo
+000185b0: 7365 2867 7261 6429 0a0a 2020 2020 2320  se(grad)..    # 
+000185c0: 5768 7920 646f 2077 6520 666c 6970 2073  Why do we flip s
+000185d0: 7472 6964 6520 616e 6420 6469 6c61 7469  tride and dilati
+000185e0: 6f6e 3f0a 2020 2020 2320 6b65 726e 656c  on?.    # kernel
+000185f0: 5b69 5d20 616e 6420 6b65 726e 656c 5b69  [i] and kernel[i
+00018600: 202b 2031 5d20 6172 6520 6469 6c61 7469   + 1] are dilati
+00018610: 6f6e 2061 7061 7274 2066 726f 6d20 6561  on apart from ea
+00018620: 6368 206f 7468 6572 2c0a 2020 2020 2320  ch other,.    # 
+00018630: 736f 2064 696c 6174 696f 6e20 6265 636f  so dilation beco
+00018640: 6d65 7320 7468 6520 6e65 7720 7374 7269  mes the new stri
+00018650: 6465 2e0a 2020 2020 2320 416c 6c20 7468  de..    # All th
+00018660: 6520 656c 656d 656e 7473 2074 6861 7420  e elements that 
+00018670: 6b65 726e 656c 5b69 5d20 746f 7563 6865  kernel[i] touche
+00018680: 7320 6172 6520 7374 7269 6465 2061 7761  s are stride awa
+00018690: 7920 6672 6f6d 2065 6163 6820 6f74 6865  y from each othe
+000186a0: 722c 0a20 2020 2023 2068 656e 6365 2073  r,.    # hence s
+000186b0: 7472 6964 6520 6265 636f 6d65 7320 7468  tride becomes th
+000186c0: 6520 6e65 7720 6469 6c61 7469 6f6e 2e0a  e new dilation..
+000186d0: 2020 2020 7765 6967 6874 5f67 7261 6420      weight_grad 
+000186e0: 3d20 636f 6e76 6f6c 7574 696f 6e28 0a20  = convolution(. 
+000186f0: 2020 2020 2020 2069 6e70 7574 2c0a 2020         input,.  
+00018700: 2020 2020 2020 6772 6164 2c0a 2020 2020        grad,.    
+00018710: 2020 2020 4e6f 6e65 2c0a 2020 2020 2020      None,.      
+00018720: 2020 6469 6c61 7469 6f6e 2c20 2023 2073    dilation,  # s
+00018730: 6574 2073 7472 6964 653d 6469 6c61 7469  et stride=dilati
+00018740: 6f6e 0a20 2020 2020 2020 2028 302c 292c  on.        (0,),
+00018750: 0a20 2020 2020 2020 2073 7472 6964 652c  .        stride,
+00018760: 2020 2320 7365 7420 6469 6c61 7469 6f6e    # set dilation
+00018770: 3d73 7472 6964 650a 2020 2020 2020 2020  =stride.        
+00018780: 7472 616e 7370 6f73 6564 2c0a 2020 2020  transposed,.    
+00018790: 2020 2020 6f75 7470 7574 5f70 6164 6469      output_paddi
+000187a0: 6e67 2c0a 2020 2020 2020 2020 6772 6f75  ng,.        grou
+000187b0: 7073 2c0a 2020 2020 290a 0a20 2020 2023  ps,.    )..    #
+000187c0: 2054 6865 2072 6573 756c 7420 6f66 2074   The result of t
+000187d0: 6865 2063 6f6e 766f 6c75 7469 6f6e 2068  he convolution h
+000187e0: 6173 2073 6861 7065 2028 6769 6e5f 6368  as shape (gin_ch
+000187f0: 616e 6e65 6c73 2c20 6f75 745f 6368 616e  annels, out_chan
+00018800: 6e65 6c73 292c 0a20 2020 2023 2073 6f20  nels),.    # so 
+00018810: 7472 616e 7370 6f73 6974 696f 6e20 6973  transposition is
+00018820: 2072 6571 7569 7265 642e 0a20 2020 2077   required..    w
+00018830: 6569 6768 745f 6772 6164 203d 2063 6f6e  eight_grad = con
+00018840: 765f 7472 616e 7370 6f73 6528 7765 6967  v_transpose(weig
+00018850: 6874 5f67 7261 6429 0a20 2020 2023 207d  ht_grad).    # }
+00018860: 0a0a 2020 2020 7265 7475 726e 2028 696e  ..    return (in
+00018870: 7075 745f 6772 6164 2c20 7765 6967 6874  put_grad, weight
+00018880: 5f67 7261 642c 2062 6961 735f 6772 6164  _grad, bias_grad
+00018890: 290a 0a0a 4072 6567 6973 7465 725f 6175  )...@register_au
+000188a0: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
+000188b0: 2274 6f72 6368 2e6c 6f67 5f73 6f66 746d  "torch.log_softm
+000188c0: 6178 2229 0a64 6566 206c 6f67 5f73 6f66  ax").def log_sof
+000188d0: 746d 6178 5f61 7567 5f66 7764 2869 6e70  tmax_aug_fwd(inp
+000188e0: 7574 3a20 5465 6e73 6f72 5072 6f78 792c  ut: TensorProxy,
+000188f0: 2064 696d 3a20 696e 742c 202a 2c20 6474   dim: int, *, dt
+00018900: 7970 653d 4e6f 6e65 2920 2d3e 2056 4a50  ype=None) -> VJP
+00018910: 4475 616c 3a0a 2020 2020 6672 6f6d 2074  Dual:.    from t
+00018920: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
+00018930: 6f72 7420 6c6f 675f 736f 6674 6d61 780a  ort log_softmax.
+00018940: 0a20 2020 2070 7269 6d61 6c20 3d20 6c6f  .    primal = lo
+00018950: 675f 736f 6674 6d61 7828 696e 7075 742c  g_softmax(input,
+00018960: 2064 696d 3d64 696d 2c20 6474 7970 653d   dim=dim, dtype=
+00018970: 6474 7970 6529 0a20 2020 2072 6573 6964  dtype).    resid
+00018980: 7561 6c73 203d 2028 7072 696d 616c 2c20  uals = (primal, 
+00018990: 6469 6d2c 2069 6e70 7574 2e64 7479 7065  dim, input.dtype
+000189a0: 290a 2020 2020 7265 7475 726e 2056 4a50  ).    return VJP
+000189b0: 4475 616c 2870 7269 6d61 6c2c 2072 6573  Dual(primal, res
+000189c0: 6964 7561 6c73 290a 0a0a 4072 6567 6973  iduals)...@regis
+000189d0: 7465 725f 6261 636b 7761 7264 2822 746f  ter_backward("to
+000189e0: 7263 682e 6c6f 675f 736f 6674 6d61 7822  rch.log_softmax"
+000189f0: 290a 6465 6620 6c6f 675f 736f 6674 6d61  ).def log_softma
+00018a00: 785f 6261 636b 7761 7264 2870 7269 6d61  x_backward(prima
+00018a10: 6c2c 2064 696d 2c20 6474 7970 652c 2067  l, dim, dtype, g
+00018a20: 293a 0a20 2020 2066 726f 6d20 7468 756e  ):.    from thun
+00018a30: 6465 722e 746f 7263 6820 696d 706f 7274  der.torch import
+00018a40: 206c 6f67 5f73 6f66 746d 6178 5f62 6163   log_softmax_bac
+00018a50: 6b77 6172 640a 0a20 2020 2072 6574 7572  kward..    retur
+00018a60: 6e20 6c6f 675f 736f 6674 6d61 785f 6261  n log_softmax_ba
+00018a70: 636b 7761 7264 2867 2c20 7072 696d 616c  ckward(g, primal
+00018a80: 2c20 6469 6d2c 2064 7479 7065 290a 0a0a  , dim, dtype)...
+00018a90: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
+00018aa0: 7465 645f 666f 7277 6172 6428 2274 6f72  ted_forward("tor
+00018ab0: 6368 2e6e 6e2e 6675 6e63 7469 6f6e 616c  ch.nn.functional
+00018ac0: 2e6e 6c6c 5f6c 6f73 7322 290a 6465 6620  .nll_loss").def 
+00018ad0: 6e6c 6c5f 6c6f 7373 5f61 7567 5f66 7764  nll_loss_aug_fwd
+00018ae0: 280a 2020 2020 696e 7075 743a 2050 726f  (.    input: Pro
+00018af0: 7879 2c0a 2020 2020 7461 7267 6574 3a20  xy,.    target: 
+00018b00: 5072 6f78 792c 0a20 2020 2077 6569 6768  Proxy,.    weigh
+00018b10: 743a 204e 6f6e 6520 7c20 5072 6f78 792c  t: None | Proxy,
+00018b20: 0a20 2020 2069 676e 6f72 655f 696e 6465  .    ignore_inde
+00018b30: 783a 2069 6e74 2c0a 2020 2020 7265 6475  x: int,.    redu
+00018b40: 6374 696f 6e3a 2073 7472 2c0a 2920 2d3e  ction: str,.) ->
+00018b50: 2056 4a50 4475 616c 3a0a 2020 2020 6672   VJPDual:.    fr
+00018b60: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
+00018b70: 2069 6d70 6f72 7420 5f6e 6c6c 5f6c 6f73   import _nll_los
+00018b80: 735f 6865 6c70 6572 0a0a 2020 2020 7072  s_helper..    pr
+00018b90: 696d 616c 2c20 746f 7461 6c5f 7765 6967  imal, total_weig
+00018ba0: 6874 203d 205f 6e6c 6c5f 6c6f 7373 5f68  ht = _nll_loss_h
+00018bb0: 656c 7065 7228 0a20 2020 2020 2020 2069  elper(.        i
+00018bc0: 6e70 7574 2c0a 2020 2020 2020 2020 7461  nput,.        ta
+00018bd0: 7267 6574 2c0a 2020 2020 2020 2020 7765  rget,.        we
+00018be0: 6967 6874 2c0a 2020 2020 2020 2020 6967  ight,.        ig
+00018bf0: 6e6f 7265 5f69 6e64 6578 2c0a 2020 2020  nore_index,.    
+00018c00: 2020 2020 7265 6475 6374 696f 6e2c 0a20      reduction,. 
+00018c10: 2020 2029 0a20 2020 2072 6573 6964 7561     ).    residua
+00018c20: 6c73 203d 2028 696e 7075 742c 2074 6172  ls = (input, tar
+00018c30: 6765 742c 2077 6569 6768 742c 2072 6564  get, weight, red
+00018c40: 7563 7469 6f6e 2c20 6967 6e6f 7265 5f69  uction, ignore_i
+00018c50: 6e64 6578 2c20 746f 7461 6c5f 7765 6967  ndex, total_weig
+00018c60: 6874 290a 2020 2020 7265 7475 726e 2056  ht).    return V
+00018c70: 4a50 4475 616c 2870 7269 6d61 6c2c 2072  JPDual(primal, r
+00018c80: 6573 6964 7561 6c73 290a 0a0a 4072 6567  esiduals)...@reg
+00018c90: 6973 7465 725f 6261 636b 7761 7264 2822  ister_backward("
+00018ca0: 746f 7263 682e 6e6e 2e66 756e 6374 696f  torch.nn.functio
+00018cb0: 6e61 6c2e 6e6c 6c5f 6c6f 7373 2229 0a64  nal.nll_loss").d
+00018cc0: 6566 206e 6c6c 5f6c 6f73 735f 6261 636b  ef nll_loss_back
+00018cd0: 7761 7264 2869 6e70 7574 2c20 7461 7267  ward(input, targ
+00018ce0: 6574 2c20 7765 6967 6874 2c20 7265 6475  et, weight, redu
+00018cf0: 6374 696f 6e2c 2069 676e 6f72 655f 696e  ction, ignore_in
+00018d00: 6465 782c 2074 6f74 616c 5f77 6569 6768  dex, total_weigh
+00018d10: 742c 2067 293a 0a20 2020 2066 726f 6d20  t, g):.    from 
+00018d20: 7468 756e 6465 722e 746f 7263 6820 696d  thunder.torch im
+00018d30: 706f 7274 206e 6c6c 5f6c 6f73 735f 6261  port nll_loss_ba
+00018d40: 636b 7761 7264 0a0a 2020 2020 6769 6e70  ckward..    ginp
+00018d50: 7574 203d 206e 6c6c 5f6c 6f73 735f 6261  ut = nll_loss_ba
+00018d60: 636b 7761 7264 2867 2c20 696e 7075 742c  ckward(g, input,
+00018d70: 2074 6172 6765 742c 2077 6569 6768 742c   target, weight,
+00018d80: 2072 6564 7563 7469 6f6e 2c20 6967 6e6f   reduction, igno
+00018d90: 7265 5f69 6e64 6578 2c20 746f 7461 6c5f  re_index, total_
+00018da0: 7765 6967 6874 290a 2020 2020 7265 7475  weight).    retu
+00018db0: 726e 2067 696e 7075 742c 202a 2828 4e6f  rn ginput, *((No
+00018dc0: 6e65 2c29 202a 2034 290a 0a0a 4072 6567  ne,) * 4)...@reg
+00018dd0: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
+00018de0: 666f 7277 6172 6428 2274 6f72 6368 2e73  forward("torch.s
+00018df0: 706c 6974 2229 0a64 6566 2073 706c 6974  plit").def split
+00018e00: 5f61 7567 5f66 7764 2861 3a20 5465 6e73  _aug_fwd(a: Tens
+00018e10: 6f72 5072 6f78 792c 2073 706c 6974 5f73  orProxy, split_s
+00018e20: 697a 655f 6f72 5f73 6563 7469 6f6e 733a  ize_or_sections:
+00018e30: 2069 6e74 207c 2053 6571 7565 6e63 655b   int | Sequence[
+00018e40: 696e 745d 2c20 6469 6d3a 2069 6e74 203d  int], dim: int =
+00018e50: 2030 2920 2d3e 2056 4a50 4475 616c 3a0a   0) -> VJPDual:.
+00018e60: 2020 2020 6672 6f6d 2074 6875 6e64 6572      from thunder
+00018e70: 2e74 6f72 6368 2069 6d70 6f72 7420 7370  .torch import sp
+00018e80: 6c69 740a 0a20 2020 2070 7269 6d61 6c20  lit..    primal 
+00018e90: 3d20 7370 6c69 7428 612c 2073 706c 6974  = split(a, split
+00018ea0: 5f73 697a 655f 6f72 5f73 6563 7469 6f6e  _size_or_section
+00018eb0: 732c 2064 696d 290a 2020 2020 7265 7369  s, dim).    resi
+00018ec0: 6475 616c 7320 3d20 2864 696d 2c29 0a20  duals = (dim,). 
+00018ed0: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
+00018ee0: 6c28 7072 696d 616c 2c20 7265 7369 6475  l(primal, residu
+00018ef0: 616c 7329 0a0a 0a40 7265 6769 7374 6572  als)...@register
+00018f00: 5f62 6163 6b77 6172 6428 2274 6f72 6368  _backward("torch
+00018f10: 2e73 706c 6974 2229 0a64 6566 2073 706c  .split").def spl
+00018f20: 6974 5f62 6163 6b77 6172 6428 6469 6d2c  it_backward(dim,
+00018f30: 202a 6772 6164 7329 3a0a 2020 2020 6672   *grads):.    fr
+00018f40: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
+00018f50: 2069 6d70 6f72 7420 6361 740a 0a20 2020   import cat..   
+00018f60: 2072 6574 7572 6e20 6361 7428 6772 6164   return cat(grad
+00018f70: 732c 2064 696d 290a 0a0a 4072 6567 6973  s, dim)...@regis
+00018f80: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
+00018f90: 7277 6172 6428 2274 6f72 6368 2e6e 6e2e  rward("torch.nn.
+00018fa0: 6675 6e63 7469 6f6e 616c 2e65 6d62 6564  functional.embed
+00018fb0: 6469 6e67 2229 0a64 6566 2065 6d62 6564  ding").def embed
+00018fc0: 6469 6e67 5f61 7567 5f66 7764 280a 2020  ding_aug_fwd(.  
+00018fd0: 2020 613a 2050 726f 7879 2c0a 2020 2020    a: Proxy,.    
+00018fe0: 7765 6967 6874 3a20 5072 6f78 792c 0a20  weight: Proxy,. 
+00018ff0: 2020 2070 6164 6469 6e67 5f69 6478 3a20     padding_idx: 
+00019000: 696e 7420 7c20 4e6f 6e65 2c0a 2020 2020  int | None,.    
+00019010: 6d61 785f 6e6f 726d 3a20 666c 6f61 7420  max_norm: float 
+00019020: 7c20 4e6f 6e65 2c0a 2020 2020 6e6f 726d  | None,.    norm
+00019030: 5f74 7970 653a 2066 6c6f 6174 2c0a 2020  _type: float,.  
+00019040: 2020 7363 616c 655f 6772 6164 5f62 795f    scale_grad_by_
+00019050: 6672 6571 3a20 626f 6f6c 2c0a 2020 2020  freq: bool,.    
+00019060: 7370 6172 7365 3a20 626f 6f6c 2c0a 2920  sparse: bool,.) 
+00019070: 2d3e 2056 4a50 4475 616c 3a0a 2020 2020  -> VJPDual:.    
+00019080: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
+00019090: 6368 2069 6d70 6f72 7420 656d 6265 6464  ch import embedd
+000190a0: 696e 670a 0a20 2020 2070 7269 6d61 6c20  ing..    primal 
+000190b0: 3d20 656d 6265 6464 696e 6728 0a20 2020  = embedding(.   
+000190c0: 2020 2020 2061 2c0a 2020 2020 2020 2020       a,.        
+000190d0: 7765 6967 6874 2c0a 2020 2020 2020 2020  weight,.        
+000190e0: 7061 6464 696e 675f 6964 783d 7061 6464  padding_idx=padd
+000190f0: 696e 675f 6964 782c 0a20 2020 2020 2020  ing_idx,.       
+00019100: 206d 6178 5f6e 6f72 6d3d 6d61 785f 6e6f   max_norm=max_no
+00019110: 726d 2c0a 2020 2020 2020 2020 6e6f 726d  rm,.        norm
+00019120: 5f74 7970 653d 6e6f 726d 5f74 7970 652c  _type=norm_type,
+00019130: 0a20 2020 2020 2020 2073 6361 6c65 5f67  .        scale_g
+00019140: 7261 645f 6279 5f66 7265 713d 7363 616c  rad_by_freq=scal
+00019150: 655f 6772 6164 5f62 795f 6672 6571 2c0a  e_grad_by_freq,.
+00019160: 2020 2020 2020 2020 7370 6172 7365 3d73          sparse=s
+00019170: 7061 7273 652c 0a20 2020 2029 0a20 2020  parse,.    ).   
+00019180: 2072 6573 6964 7561 6c73 203d 2028 612c   residuals = (a,
+00019190: 2077 6569 6768 742e 7368 6170 655b 305d   weight.shape[0]
+000191a0: 2c20 7061 6464 696e 675f 6964 782c 2073  , padding_idx, s
+000191b0: 6361 6c65 5f67 7261 645f 6279 5f66 7265  cale_grad_by_fre
+000191c0: 712c 2073 7061 7273 6529 0a20 2020 2072  q, sparse).    r
+000191d0: 6574 7572 6e20 564a 5044 7561 6c28 7072  eturn VJPDual(pr
+000191e0: 696d 616c 2c20 7265 7369 6475 616c 7329  imal, residuals)
+000191f0: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
+00019200: 6b77 6172 6428 2274 6f72 6368 2e6e 6e2e  kward("torch.nn.
+00019210: 6675 6e63 7469 6f6e 616c 2e65 6d62 6564  functional.embed
+00019220: 6469 6e67 2229 0a64 6566 2065 6d62 6564  ding").def embed
+00019230: 6469 6e67 5f62 6163 6b77 6172 6428 612c  ding_backward(a,
+00019240: 206e 756d 5f77 6569 6768 7473 2c20 7061   num_weights, pa
+00019250: 6464 696e 675f 6964 782c 2073 6361 6c65  dding_idx, scale
+00019260: 5f67 7261 645f 6279 5f66 7265 712c 2073  _grad_by_freq, s
+00019270: 7061 7273 652c 2067 293a 0a20 2020 2066  parse, g):.    f
+00019280: 726f 6d20 7468 756e 6465 722e 746f 7263  rom thunder.torc
+00019290: 6820 696d 706f 7274 2065 6d62 6564 6469  h import embeddi
+000192a0: 6e67 5f62 6163 6b77 6172 640a 0a20 2020  ng_backward..   
+000192b0: 2070 6164 6469 6e67 5f69 6478 203d 202d   padding_idx = -
+000192c0: 3120 6966 2070 6164 6469 6e67 5f69 6478  1 if padding_idx
+000192d0: 2069 7320 4e6f 6e65 2065 6c73 6520 7061   is None else pa
+000192e0: 6464 696e 675f 6964 780a 2020 2020 6777  dding_idx.    gw
+000192f0: 6569 6768 7420 3d20 656d 6265 6464 696e  eight = embeddin
+00019300: 675f 6261 636b 7761 7264 2867 2c20 612c  g_backward(g, a,
+00019310: 206e 756d 5f77 6569 6768 7473 2c20 7061   num_weights, pa
+00019320: 6464 696e 675f 6964 782c 2073 6361 6c65  dding_idx, scale
+00019330: 5f67 7261 645f 6279 5f66 7265 712c 2073  _grad_by_freq, s
+00019340: 7061 7273 6529 0a20 2020 2072 6574 7572  parse).    retur
+00019350: 6e20 6777 6569 6768 740a 0a0a 4072 6567  n gweight...@reg
+00019360: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
+00019370: 666f 7277 6172 6428 7072 696d 732e 5072  forward(prims.Pr
+00019380: 696d 4944 732e 4241 5443 485f 4e4f 524d  imIDs.BATCH_NORM
+00019390: 290a 6465 6620 6261 7463 685f 6e6f 726d  ).def batch_norm
+000193a0: 5f61 7567 5f66 7764 280a 2020 2020 613a  _aug_fwd(.    a:
+000193b0: 2054 656e 736f 7250 726f 7879 2c0a 2020   TensorProxy,.  
+000193c0: 2020 7765 6967 6874 3a20 4e6f 6e65 207c    weight: None |
+000193d0: 2054 656e 736f 7250 726f 7879 2c0a 2020   TensorProxy,.  
+000193e0: 2020 6269 6173 3a20 4e6f 6e65 207c 2054    bias: None | T
+000193f0: 656e 736f 7250 726f 7879 2c0a 2020 2020  ensorProxy,.    
+00019400: 7275 6e6e 696e 675f 6d65 616e 3a20 4e6f  running_mean: No
+00019410: 6e65 207c 2054 656e 736f 7250 726f 7879  ne | TensorProxy
+00019420: 2c0a 2020 2020 7275 6e6e 696e 675f 7661  ,.    running_va
+00019430: 723a 204e 6f6e 6520 7c20 5465 6e73 6f72  r: None | Tensor
+00019440: 5072 6f78 792c 0a20 2020 2074 7261 696e  Proxy,.    train
+00019450: 696e 673a 2062 6f6f 6c2c 0a20 2020 206d  ing: bool,.    m
+00019460: 6f6d 656e 7475 6d3a 204e 756d 6265 722c  omentum: Number,
+00019470: 0a20 2020 2065 7073 3a20 4e75 6d62 6572  .    eps: Number
+00019480: 2c0a 2920 2d3e 2056 4a50 4475 616c 3a0a  ,.) -> VJPDual:.
+00019490: 2020 2020 7072 696d 616c 203d 2070 7269      primal = pri
+000194a0: 6d73 2e62 6174 6368 5f6e 6f72 6d28 0a20  ms.batch_norm(. 
+000194b0: 2020 2020 2020 2061 2c0a 2020 2020 2020         a,.      
+000194c0: 2020 7765 6967 6874 2c0a 2020 2020 2020    weight,.      
+000194d0: 2020 6269 6173 2c0a 2020 2020 2020 2020    bias,.        
+000194e0: 7275 6e6e 696e 675f 6d65 616e 2c0a 2020  running_mean,.  
+000194f0: 2020 2020 2020 7275 6e6e 696e 675f 7661        running_va
+00019500: 722c 0a20 2020 2020 2020 2074 7261 696e  r,.        train
+00019510: 696e 672c 0a20 2020 2020 2020 206d 6f6d  ing,.        mom
+00019520: 656e 7475 6d2c 0a20 2020 2020 2020 2065  entum,.        e
+00019530: 7073 2c0a 2020 2020 290a 2020 2020 6f75  ps,.    ).    ou
+00019540: 7470 7574 5f6d 6173 6b20 3d20 5b78 2069  tput_mask = [x i
+00019550: 7320 6e6f 7420 4e6f 6e65 2066 6f72 2078  s not None for x
+00019560: 2069 6e20 2861 2c20 7765 6967 6874 2c20   in (a, weight, 
+00019570: 6269 6173 295d 0a20 2020 206f 7574 7075  bias)].    outpu
+00019580: 742c 2073 6176 655f 6d65 616e 2c20 7361  t, save_mean, sa
+00019590: 7665 5f69 6e76 7374 6420 3d20 7072 696d  ve_invstd = prim
+000195a0: 616c 0a20 2020 2072 6573 6964 7561 6c73  al.    residuals
+000195b0: 203d 2028 612c 2077 6569 6768 742c 2072   = (a, weight, r
+000195c0: 756e 6e69 6e67 5f6d 6561 6e2c 2072 756e  unning_mean, run
+000195d0: 6e69 6e67 5f76 6172 2c20 7361 7665 5f6d  ning_var, save_m
+000195e0: 6561 6e2c 2073 6176 655f 696e 7673 7464  ean, save_invstd
+000195f0: 2c20 7472 6169 6e69 6e67 2c20 6570 732c  , training, eps,
+00019600: 206f 7574 7075 745f 6d61 736b 290a 2020   output_mask).  
+00019610: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
+00019620: 2870 7269 6d61 6c2c 2072 6573 6964 7561  (primal, residua
+00019630: 6c73 290a 0a0a 4072 6567 6973 7465 725f  ls)...@register_
+00019640: 6261 636b 7761 7264 2870 7269 6d73 2e50  backward(prims.P
+00019650: 7269 6d49 4473 2e42 4154 4348 5f4e 4f52  rimIDs.BATCH_NOR
+00019660: 4d29 0a64 6566 2062 6174 6368 5f6e 6f72  M).def batch_nor
+00019670: 6d5f 6261 636b 7761 7264 2861 2c20 7765  m_backward(a, we
+00019680: 6967 6874 2c20 7275 6e6e 696e 675f 6d65  ight, running_me
+00019690: 616e 2c20 7275 6e6e 696e 675f 7661 722c  an, running_var,
+000196a0: 2073 6176 655f 6d65 616e 2c20 7361 7665   save_mean, save
+000196b0: 5f69 6e76 7374 642c 2074 7261 696e 2c20  _invstd, train, 
+000196c0: 6570 732c 206f 7574 7075 745f 6d61 736b  eps, output_mask
+000196d0: 2c20 2a67 7261 6473 293a 0a20 2020 2066  , *grads):.    f
+000196e0: 726f 6d20 7468 756e 6465 722e 746f 7263  rom thunder.torc
+000196f0: 6820 696d 706f 7274 2062 6174 6368 5f6e  h import batch_n
+00019700: 6f72 6d5f 6261 636b 7761 7264 0a0a 2020  orm_backward..  
+00019710: 2020 7265 7375 6c74 203d 2062 6174 6368    result = batch
+00019720: 5f6e 6f72 6d5f 6261 636b 7761 7264 280a  _norm_backward(.
+00019730: 2020 2020 2020 2020 6772 6164 735b 305d          grads[0]
+00019740: 2c20 612c 2077 6569 6768 742c 2072 756e  , a, weight, run
+00019750: 6e69 6e67 5f6d 6561 6e2c 2072 756e 6e69  ning_mean, runni
+00019760: 6e67 5f76 6172 2c20 7361 7665 5f6d 6561  ng_var, save_mea
+00019770: 6e2c 2073 6176 655f 696e 7673 7464 2c20  n, save_invstd, 
+00019780: 7472 6169 6e2c 2065 7073 2c20 6f75 7470  train, eps, outp
+00019790: 7574 5f6d 6173 6b0a 2020 2020 290a 2020  ut_mask.    ).  
+000197a0: 2020 7265 7475 726e 202a 7265 7375 6c74    return *result
+000197b0: 2c20 4e6f 6e65 2c20 4e6f 6e65 0a0a 0a40  , None, None...@
+000197c0: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
+000197d0: 6564 5f66 6f72 7761 7264 2822 746f 7263  ed_forward("torc
+000197e0: 682e 6375 6d73 756d 2229 0a64 6566 2063  h.cumsum").def c
+000197f0: 756d 7375 6d5f 6175 675f 6677 6428 613a  umsum_aug_fwd(a:
+00019800: 2050 726f 7879 2c20 6469 6d3a 2069 6e74   Proxy, dim: int
+00019810: 2c20 2a2c 2064 7479 7065 3a20 4e6f 6e65  , *, dtype: None
+00019820: 207c 2064 7479 7065 732e 6474 7970 6520   | dtypes.dtype 
+00019830: 3d20 4e6f 6e65 2920 2d3e 2056 4a50 4475  = None) -> VJPDu
+00019840: 616c 3a0a 2020 2020 6672 6f6d 2074 6875  al:.    from thu
+00019850: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
+00019860: 7420 6375 6d73 756d 0a0a 2020 2020 7072  t cumsum..    pr
+00019870: 696d 616c 203d 2063 756d 7375 6d28 612c  imal = cumsum(a,
+00019880: 2064 696d 2c20 6474 7970 653d 6474 7970   dim, dtype=dtyp
+00019890: 6529 0a20 2020 2072 6573 6964 7561 6c73  e).    residuals
+000198a0: 203d 2028 0a20 2020 2020 2020 2061 2e64   = (.        a.d
+000198b0: 7479 7065 2c0a 2020 2020 2020 2020 6469  type,.        di
+000198c0: 6d2c 0a20 2020 2029 0a20 2020 2072 6574  m,.    ).    ret
+000198d0: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
+000198e0: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
+000198f0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
+00019900: 6172 6428 2274 6f72 6368 2e63 756d 7375  ard("torch.cumsu
+00019910: 6d22 290a 6465 6620 6375 6d73 756d 5f62  m").def cumsum_b
+00019920: 6163 6b77 6172 6428 615f 6474 7970 652c  ackward(a_dtype,
+00019930: 2064 696d 2c20 6729 3a0a 2020 2020 6720   dim, g):.    g 
+00019940: 3d20 672e 746f 2861 5f64 7479 7065 290a  = g.to(a_dtype).
+00019950: 2020 2020 6966 2067 2e6e 756d 656c 203c      if g.numel <
+00019960: 3d20 3120 6f72 2067 2e73 6861 7065 5b64  = 1 or g.shape[d
+00019970: 696d 5d20 3d3d 2031 3a0a 2020 2020 2020  im] == 1:.      
+00019980: 2020 7265 7475 726e 2067 0a20 2020 2072    return g.    r
+00019990: 6574 7572 6e20 672e 666c 6970 2864 696d  eturn g.flip(dim
+000199a0: 292e 6375 6d73 756d 2864 696d 292e 666c  ).cumsum(dim).fl
+000199b0: 6970 2864 696d 290a 0a0a 4072 6567 6973  ip(dim)...@regis
+000199c0: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
+000199d0: 7277 6172 6428 2274 6f72 6368 2e73 6f66  rward("torch.sof
+000199e0: 746d 6178 2229 0a64 6566 2073 6f66 746d  tmax").def softm
+000199f0: 6178 5f61 7567 5f66 7764 2861 3a20 5072  ax_aug_fwd(a: Pr
+00019a00: 6f78 792c 2064 696d 3a20 696e 742c 2064  oxy, dim: int, d
+00019a10: 7479 7065 3a20 6474 7970 6573 2e64 7479  type: dtypes.dty
+00019a20: 7065 207c 204e 6f6e 6520 3d20 4e6f 6e65  pe | None = None
+00019a30: 2920 2d3e 2056 4a50 4475 616c 3a0a 2020  ) -> VJPDual:.  
+00019a40: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
+00019a50: 6f72 6368 2069 6d70 6f72 7420 736f 6674  orch import soft
+00019a60: 6d61 780a 0a20 2020 2070 7269 6d61 6c20  max..    primal 
+00019a70: 3d20 736f 6674 6d61 7828 612c 2064 696d  = softmax(a, dim
+00019a80: 2c20 6474 7970 653d 6474 7970 6529 0a20  , dtype=dtype). 
+00019a90: 2020 2072 6573 6964 7561 6c73 203d 2028     residuals = (
+00019aa0: 7072 696d 616c 2c20 6469 6d29 0a20 2020  primal, dim).   
+00019ab0: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
+00019ac0: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
+00019ad0: 7329 0a0a 0a40 7265 6769 7374 6572 5f62  s)...@register_b
+00019ae0: 6163 6b77 6172 6428 2274 6f72 6368 2e73  ackward("torch.s
+00019af0: 6f66 746d 6178 2229 0a64 6566 2073 6f66  oftmax").def sof
+00019b00: 746d 6178 5f62 6163 6b77 6172 6428 7072  tmax_backward(pr
+00019b10: 696d 616c 2c20 6469 6d2c 2067 293a 0a20  imal, dim, g):. 
+00019b20: 2020 2072 6574 7572 6e20 7072 696d 616c     return primal
+00019b30: 202a 2028 6720 2d20 2870 7269 6d61 6c20   * (g - (primal 
+00019b40: 2a20 6729 2e73 756d 2864 696d 2c20 6b65  * g).sum(dim, ke
+00019b50: 6570 6469 6d3d 5472 7565 2929 0a0a 0a64  epdim=True))...d
+00019b60: 6566 2069 7465 725f 626f 756e 645f 7379  ef iter_bound_sy
+00019b70: 6d62 6f6c 7328 626f 756e 645f 7379 6d62  mbols(bound_symb
+00019b80: 6f6c 7329 3a0a 2020 2020 2222 2249 7465  ols):.    """Ite
+00019b90: 7261 7465 206f 7665 7220 626f 756e 6420  rate over bound 
+00019ba0: 7379 6d62 6f6c 732c 2073 6b69 7070 696e  symbols, skippin
+00019bb0: 6720 7379 6d62 6f6c 7320 7468 6174 2061  g symbols that a
+00019bc0: 7265 206e 6f74 2073 7570 706f 7274 6564  re not supported
+00019bd0: 2062 790a 2020 2020 7468 6520 7472 616e   by.    the tran
+00019be0: 7366 6f72 6d73 2069 6e66 7261 7374 7275  sforms infrastru
+00019bf0: 6374 7572 652e 0a0a 2020 2020 4172 6773  cture...    Args
+00019c00: 3a0a 2020 2020 2020 2020 626f 756e 645f  :.        bound_
+00019c10: 7379 6d62 6f6c 7320 284c 6973 745b 426f  symbols (List[Bo
+00019c20: 756e 6453 796d 626f 6c5d 293a 204c 6973  undSymbol]): Lis
+00019c30: 7420 6f66 2062 6f75 6e64 2073 796d 626f  t of bound symbo
+00019c40: 6c73 0a0a 2020 2020 5969 656c 6473 3a0a  ls..    Yields:.
+00019c50: 2020 2020 2020 2020 426f 756e 6453 796d          BoundSym
+00019c60: 626f 6c3a 2042 6f75 6e64 2073 796d 626f  bol: Bound symbo
+00019c70: 6c73 2074 6861 7420 6172 6520 7375 7070  ls that are supp
+00019c80: 6f72 7465 6420 6279 2074 6865 2074 7261  orted by the tra
+00019c90: 6e73 666f 726d 730a 2020 2020 2020 2020  nsforms.        
+00019ca0: 696e 6672 6173 7472 7563 7475 7265 0a20  infrastructure. 
+00019cb0: 2020 2022 2222 0a20 2020 2066 6f72 2073     """.    for s
+00019cc0: 796d 626f 6c20 696e 2062 6f75 6e64 5f73  ymbol in bound_s
+00019cd0: 796d 626f 6c73 3a0a 2020 2020 2020 2020  ymbols:.        
+00019ce0: 6966 2073 796d 626f 6c2e 7379 6d2e 6964  if symbol.sym.id
+00019cf0: 2069 6e20 7472 616e 7366 6f72 6d5f 736b   in transform_sk
+00019d00: 6970 5f6c 6973 743a 0a20 2020 2020 2020  ip_list:.       
+00019d10: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+00019d20: 2020 2020 2020 656c 6966 2073 796d 626f        elif symbo
+00019d30: 6c2e 6f75 7470 7574 2069 7320 4e6f 6e65  l.output is None
+00019d40: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+00019d50: 6e74 696e 7565 0a20 2020 2020 2020 2065  ntinue.        e
+00019d60: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00019d70: 2079 6965 6c64 2073 796d 626f 6c0a 0a0a   yield symbol...
+00019d80: 6465 6620 6465 636f 6e73 7472 7563 745f  def deconstruct_
+00019d90: 666f 7277 6172 645f 656e 765f 666f 725f  forward_env_for_
+00019da0: 6261 636b 7761 7264 2874 7261 6365 2c20  backward(trace, 
+00019db0: 656e 7629 3a0a 2020 2020 2320 4e6f 7465  env):.    # Note
+00019dc0: 205b 5361 7669 6e67 2074 6865 2066 6f72   [Saving the for
+00019dd0: 7761 7264 2065 6e76 6972 6f6e 6d65 6e74  ward environment
+00019de0: 2069 6e20 7468 6520 6261 636b 7761 7264   in the backward
+00019df0: 2072 756c 655d 0a20 2020 2023 2057 6520   rule].    # We 
+00019e00: 6361 6e6e 6f74 2073 6176 6520 7468 6520  cannot save the 
+00019e10: 7472 6163 6520 6f62 6a65 6374 2069 6e20  trace object in 
+00019e20: 7468 6520 7265 7369 6475 616c 7320 6265  the residuals be
+00019e30: 6361 7573 6520 6578 6563 7574 6f72 7320  cause executors 
+00019e40: 6d61 7920 6e6f 740a 2020 2020 2320 6265  may not.    # be
+00019e50: 2061 626c 6520 746f 2072 6574 7572 6e20   able to return 
+00019e60: 6974 2066 6f72 2074 6865 2073 706c 6974  it for the split
+00019e70: 7465 6420 666f 7277 6172 642f 6261 636b  ted forward/back
+00019e80: 7761 7264 2070 6173 7365 732e 2049 6e73  ward passes. Ins
+00019e90: 7465 6164 2c20 7765 0a20 2020 2023 2073  tead, we.    # s
+00019ea0: 6176 6520 6172 6773 2061 6e64 206b 7761  ave args and kwa
+00019eb0: 7267 7320 6f66 2074 6865 206f 7269 6769  rgs of the origi
+00019ec0: 6e61 6c20 6675 6e63 7469 6f6e 2063 616c  nal function cal
+00019ed0: 6c20 616e 6420 7265 636f 6e73 7472 7563  l and reconstruc
+00019ee0: 7420 7468 650a 2020 2020 2320 7472 6163  t the.    # trac
+00019ef0: 6520 6f62 6a65 6374 2061 6e64 2069 7473  e object and its
+00019f00: 2065 6e76 6972 6f6e 6d65 6e74 2064 6963   environment dic
+00019f10: 7420 696e 2074 6865 2062 6163 6b77 6172  t in the backwar
+00019f20: 6420 7275 6c65 2e20 4865 7265 2077 6520  d rule. Here we 
+00019f30: 7265 6c79 0a20 2020 2023 206f 6e20 7468  rely.    # on th
+00019f40: 6520 6661 6374 2074 6861 7420 7468 6520  e fact that the 
+00019f50: 6f72 6465 7220 6f66 2074 6865 2073 796d  order of the sym
+00019f60: 626f 6c73 2069 6e20 7468 6520 7472 6163  bols in the trac
+00019f70: 6520 6973 2064 6574 6572 6d69 6e69 7374  e is determinist
+00019f80: 6963 0a20 2020 2023 2061 6e64 2061 6c77  ic.    # and alw
+00019f90: 6179 7320 7468 6520 7361 6d65 2066 6f72  ays the same for
+00019fa0: 2074 6865 2073 616d 6520 6675 6e63 7469   the same functi
+00019fb0: 6f6e 2063 616c 6c20 616e 6420 7468 6520  on call and the 
+00019fc0: 7361 6d65 2073 6574 206f 660a 2020 2020  same set of.    
+00019fd0: 2320 6172 6775 6d65 6e74 732e 2053 6565  # arguments. See
+00019fe0: 2074 6573 745f 6772 6164 2e70 793a 7465   test_grad.py:te
+00019ff0: 7374 5f74 6f72 6368 5f61 7574 6f67 7261  st_torch_autogra
+0001a000: 645f 6675 6e63 7469 6f6e 2066 6f72 2061  d_function for a
+0001a010: 6e20 6578 616d 706c 650a 2020 2020 2320  n example.    # 
+0001a020: 7768 6572 6520 7468 6973 2069 7320 7465  where this is te
+0001a030: 7374 6564 2e0a 2020 2020 626f 756e 645f  sted..    bound_
+0001a040: 7379 6d62 6f6c 7320 3d20 6974 6572 5f62  symbols = iter_b
+0001a050: 6f75 6e64 5f73 796d 626f 6c73 2874 7261  ound_symbols(tra
+0001a060: 6365 2e62 6f75 6e64 5f73 796d 626f 6c73  ce.bound_symbols
+0001a070: 290a 2020 2020 7361 7665 645f 666f 725f  ).    saved_for_
+0001a080: 6261 636b 7761 7264 203d 2074 7570 6c65  backward = tuple
+0001a090: 2865 6e76 5b73 6571 7565 6e63 6966 7928  (env[sequencify(
+0001a0a0: 7379 6d62 6f6c 2e6f 7574 7075 7429 5b30  symbol.output)[0
+0001a0b0: 5d2e 6e61 6d65 5d2e 7265 7369 6475 616c  ].name].residual
+0001a0c0: 7320 666f 7220 7379 6d62 6f6c 2069 6e20  s for symbol in 
+0001a0d0: 626f 756e 645f 7379 6d62 6f6c 7329 0a20  bound_symbols). 
+0001a0e0: 2020 2072 6574 7572 6e20 7361 7665 645f     return saved_
+0001a0f0: 666f 725f 6261 636b 7761 7264 0a0a 0a64  for_backward...d
+0001a100: 6566 2072 6563 6f6e 7374 7275 6374 5f66  ef reconstruct_f
+0001a110: 6f72 7761 7264 5f65 6e76 5f66 6f72 5f62  orward_env_for_b
+0001a120: 6163 6b77 6172 6428 7472 6163 652c 2073  ackward(trace, s
+0001a130: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001a140: 6429 3a0a 2020 2020 626f 756e 645f 7379  d):.    bound_sy
+0001a150: 6d62 6f6c 7320 3d20 6974 6572 5f62 6f75  mbols = iter_bou
+0001a160: 6e64 5f73 796d 626f 6c73 2874 7261 6365  nd_symbols(trace
+0001a170: 2e62 6f75 6e64 5f73 796d 626f 6c73 290a  .bound_symbols).
+0001a180: 0a20 2020 2072 6563 6f6e 7374 7275 6374  .    reconstruct
+0001a190: 6564 5f65 6e76 203d 207b 7d0a 0a20 2020  ed_env = {}..   
+0001a1a0: 2066 6f72 2069 6478 2c20 7379 6d20 696e   for idx, sym in
+0001a1b0: 2065 6e75 6d65 7261 7465 2862 6f75 6e64   enumerate(bound
+0001a1c0: 5f73 796d 626f 6c73 293a 0a20 2020 2020  _symbols):.     
+0001a1d0: 2020 206b 203d 2073 6571 7565 6e63 6966     k = sequencif
+0001a1e0: 7928 7379 6d2e 6f75 7470 7574 295b 305d  y(sym.output)[0]
+0001a1f0: 2e6e 616d 650a 2020 2020 2020 2020 7620  .name.        v 
+0001a200: 3d20 564a 5044 7561 6c28 4e6f 6e65 2c20  = VJPDual(None, 
+0001a210: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+0001a220: 7264 5b69 6478 5d29 0a20 2020 2020 2020  rd[idx]).       
+0001a230: 2072 6563 6f6e 7374 7275 6374 6564 5f65   reconstructed_e
+0001a240: 6e76 5b6b 5d20 3d20 760a 0a20 2020 2072  nv[k] = v..    r
+0001a250: 6574 7572 6e20 7265 636f 6e73 7472 7563  eturn reconstruc
+0001a260: 7465 645f 656e 760a 0a0a 6465 6620 6465  ted_env...def de
+0001a270: 636f 6d70 6f73 6564 5f66 6e5f 6175 675f  composed_fn_aug_
+0001a280: 6677 645f 7275 6c65 282a 6172 6773 2c20  fwd_rule(*args, 
+0001a290: 6465 636f 6d70 6f73 6564 5f66 6e2c 202a  decomposed_fn, *
+0001a2a0: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
+0001a2b0: 2241 7567 6d65 6e74 6564 2066 6f72 7761  "Augmented forwa
+0001a2c0: 7264 2072 756c 6520 666f 7220 636f 6d70  rd rule for comp
+0001a2d0: 6f73 6974 6520 6675 6e63 7469 6f6e 7320  osite functions 
+0001a2e0: 696d 706c 656d 656e 7465 6420 696e 2074  implemented in t
+0001a2f0: 6572 6d73 206f 6620 6f74 6865 7220 6675  erms of other fu
+0001a300: 6e63 7469 6f6e 7320 7468 6174 2061 7265  nctions that are
+0001a310: 0a20 2020 2073 7570 706f 7365 6420 746f  .    supposed to
+0001a320: 2062 6520 7375 7070 6f72 7465 6420 6279   be supported by
+0001a330: 2074 6865 2056 4a50 2069 6e66 7261 7374   the VJP infrast
+0001a340: 7275 6374 7572 652e 0a0a 2020 2020 4172  ructure...    Ar
+0001a350: 6773 3a0a 2020 2020 2020 2020 6465 636f  gs:.        deco
+0001a360: 6d70 6f73 6564 5f66 6e20 2843 616c 6c61  mposed_fn (Calla
+0001a370: 626c 6529 3a20 6465 636f 6d70 6f73 6564  ble): decomposed
+0001a380: 2076 6572 7369 6f6e 206f 6620 7468 6520   version of the 
+0001a390: 6675 6e63 7469 6f6e 0a0a 2020 2020 5265  function..    Re
+0001a3a0: 7475 726e 733a 0a20 2020 2020 2020 2043  turns:.        C
+0001a3b0: 616c 6c61 626c 653a 2041 7567 6d65 6e74  allable: Augment
+0001a3c0: 6564 2066 6f72 7761 7264 2072 756c 6520  ed forward rule 
+0001a3d0: 666f 7220 7468 6520 636f 6d70 6f73 6974  for the composit
+0001a3e0: 6520 6675 6e63 7469 6f6e 0a20 2020 2022  e function.    "
+0001a3f0: 2222 0a20 2020 2074 7261 6365 203d 2063  "".    trace = c
+0001a400: 6f6e 7374 7275 6374 5f74 7261 6365 2829  onstruct_trace()
+0001a410: 2864 6563 6f6d 706f 7365 645f 666e 2c20  (decomposed_fn, 
+0001a420: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+0001a430: 0a20 2020 2074 7261 6365 203d 2075 6e77  .    trace = unw
+0001a440: 7261 705f 6f6e 655f 6c65 7665 6c5f 6f66  rap_one_level_of
+0001a450: 5f73 7562 7379 6d62 6f6c 7328 7472 6163  _subsymbols(trac
+0001a460: 6529 0a20 2020 2023 2054 6865 7265 206d  e).    # There m
+0001a470: 6179 2062 6520 6120 6465 6164 206e 6f64  ay be a dead nod
+0001a480: 6520 6c69 6b65 2022 5f20 3d20 7072 696d  e like "_ = prim
+0001a490: 732e 636f 6e76 6572 745f 656c 656d 656e  s.convert_elemen
+0001a4a0: 745f 7479 7065 2830 2c20 666c 6f61 7429  t_type(0, float)
+0001a4b0: 220a 2020 2020 2320 696e 2074 6865 2074  ".    # in the t
+0001a4c0: 7261 6365 2e20 5765 206e 6565 6420 746f  race. We need to
+0001a4d0: 2072 656d 6f76 6520 6974 2062 6566 6f72   remove it befor
+0001a4e0: 6520 7765 2063 616e 2075 7365 2074 6865  e we can use the
+0001a4f0: 2074 7261 6365 2066 6f72 0a20 2020 2023   trace for.    #
+0001a500: 2061 7567 6d65 6e74 6564 5f66 6f72 7761   augmented_forwa
+0001a510: 7264 5f70 6173 732e 0a20 2020 2074 7261  rd_pass..    tra
+0001a520: 6365 203d 2064 6365 2874 7261 6365 290a  ce = dce(trace).
+0001a530: 2020 2020 7265 7375 6c74 2c20 656e 7620      result, env 
+0001a540: 3d20 6175 676d 656e 7465 645f 666f 7277  = augmented_forw
+0001a550: 6172 645f 7061 7373 282a 6172 6773 2c20  ard_pass(*args, 
+0001a560: 7472 6163 653d 7472 6163 652c 202a 2a6b  trace=trace, **k
+0001a570: 7761 7267 7329 0a20 2020 2073 6176 6564  wargs).    saved
+0001a580: 5f66 6f72 5f62 6163 6b77 6172 6420 3d20  _for_backward = 
+0001a590: 6465 636f 6e73 7472 7563 745f 666f 7277  deconstruct_forw
+0001a5a0: 6172 645f 656e 765f 666f 725f 6261 636b  ard_env_for_back
+0001a5b0: 7761 7264 2874 7261 6365 2c20 656e 7629  ward(trace, env)
+0001a5c0: 0a20 2020 2023 2053 7461 7469 6320 6361  .    # Static ca
+0001a5d0: 6368 696e 6720 646f 6573 206e 6f74 2077  ching does not w
+0001a5e0: 6974 6820 7769 7468 206b 7761 7267 7320  ith with kwargs 
+0001a5f0: 6469 6374 732c 2073 6f20 7765 2772 6520  dicts, so we're 
+0001a600: 636f 6e76 6572 7469 6e67 2074 6865 6d0a  converting them.
+0001a610: 2020 2020 2320 746f 204e 6f6e 6520 666f      # to None fo
+0001a620: 7220 6e6f 7720 7768 656e 2070 6f73 7369  r now when possi
+0001a630: 626c 652e 0a20 2020 206b 7761 7267 7320  ble..    kwargs 
+0001a640: 3d20 4e6f 6e65 2069 6620 6e6f 7420 6b77  = None if not kw
+0001a650: 6172 6773 2065 6c73 6520 6b77 6172 6773  args else kwargs
+0001a660: 0a20 2020 2072 6573 6964 7561 6c73 203d  .    residuals =
+0001a670: 2028 6172 6773 2c20 6b77 6172 6773 2c20   (args, kwargs, 
+0001a680: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+0001a690: 7264 290a 2020 2020 7265 7475 726e 2056  rd).    return V
+0001a6a0: 4a50 4475 616c 2872 6573 756c 742c 2072  JPDual(result, r
+0001a6b0: 6573 6964 7561 6c73 290a 0a0a 6465 6620  esiduals)...def 
+0001a6c0: 6465 636f 6d70 6f73 6564 5f66 6e5f 6261  decomposed_fn_ba
+0001a6d0: 636b 7761 7264 5f72 756c 6528 6465 636f  ckward_rule(deco
+0001a6e0: 6d70 6f73 6564 5f66 6e2c 2061 7267 732c  mposed_fn, args,
+0001a6f0: 206b 7761 7267 732c 2073 6176 6564 5f66   kwargs, saved_f
+0001a700: 6f72 5f62 6163 6b77 6172 642c 202a 6772  or_backward, *gr
+0001a710: 6164 7329 3a0a 2020 2020 6b77 6172 6773  ads):.    kwargs
+0001a720: 203d 207b 7d20 6966 206b 7761 7267 7320   = {} if kwargs 
+0001a730: 6973 204e 6f6e 6520 656c 7365 206b 7761  is None else kwa
+0001a740: 7267 730a 2020 2020 7472 6163 6520 3d20  rgs.    trace = 
+0001a750: 636f 6e73 7472 7563 745f 7472 6163 6528  construct_trace(
+0001a760: 2928 6465 636f 6d70 6f73 6564 5f66 6e2c  )(decomposed_fn,
+0001a770: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
+0001a780: 290a 2020 2020 7472 6163 6520 3d20 756e  ).    trace = un
+0001a790: 7772 6170 5f6f 6e65 5f6c 6576 656c 5f6f  wrap_one_level_o
+0001a7a0: 665f 7375 6273 796d 626f 6c73 2874 7261  f_subsymbols(tra
+0001a7b0: 6365 290a 2020 2020 7472 6163 6520 3d20  ce).    trace = 
+0001a7c0: 6463 6528 7472 6163 6529 0a20 2020 2023  dce(trace).    #
+0001a7d0: 2062 6f75 6e64 5f73 796d 626f 6c73 203d   bound_symbols =
+0001a7e0: 2069 7465 725f 626f 756e 645f 7379 6d62   iter_bound_symb
+0001a7f0: 6f6c 7328 7472 6163 652e 626f 756e 645f  ols(trace.bound_
+0001a800: 7379 6d62 6f6c 7329 0a20 2020 2023 2072  symbols).    # r
+0001a810: 6563 6f6e 7374 7275 6374 6564 5f65 6e76  econstructed_env
+0001a820: 203d 207b 0a20 2020 2023 2020 2020 2073   = {.    #     s
+0001a830: 6571 7565 6e63 6966 7928 7379 6d62 6f6c  equencify(symbol
+0001a840: 2e6f 7574 7075 7429 5b30 5d2e 6e61 6d65  .output)[0].name
+0001a850: 3a20 564a 5044 7561 6c28 4e6f 6e65 2c20  : VJPDual(None, 
+0001a860: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+0001a870: 7264 5b69 5d29 0a20 2020 2023 2020 2020  rd[i]).    #    
+0001a880: 2066 6f72 2069 2c20 7379 6d62 6f6c 2069   for i, symbol i
+0001a890: 6e20 656e 756d 6572 6174 6528 626f 756e  n enumerate(boun
+0001a8a0: 645f 7379 6d62 6f6c 7329 0a20 2020 2023  d_symbols).    #
+0001a8b0: 207d 0a20 2020 2072 6563 6f6e 7374 7275   }.    reconstru
+0001a8c0: 6374 6564 5f65 6e76 203d 2072 6563 6f6e  cted_env = recon
+0001a8d0: 7374 7275 6374 5f66 6f72 7761 7264 5f65  struct_forward_e
+0001a8e0: 6e76 5f66 6f72 5f62 6163 6b77 6172 6428  nv_for_backward(
+0001a8f0: 7472 6163 652c 2073 6176 6564 5f66 6f72  trace, saved_for
+0001a900: 5f62 6163 6b77 6172 6429 0a20 2020 2072  _backward).    r
+0001a910: 6573 756c 7420 3d20 6261 636b 7761 7264  esult = backward
+0001a920: 5f70 6173 7328 7265 636f 6e73 7472 7563  _pass(reconstruc
+0001a930: 7465 645f 656e 762c 2074 7261 6365 2c20  ted_env, trace, 
+0001a940: 6772 6164 7329 0a20 2020 2069 6620 6c65  grads).    if le
+0001a950: 6e28 6172 6773 2920 3d3d 2031 3a0a 2020  n(args) == 1:.  
+0001a960: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+0001a970: 756c 745b 305d 0a20 2020 2023 2042 6163  ult[0].    # Bac
+0001a980: 6b77 6172 6420 7061 7373 206d 6967 6874  kward pass might
+0001a990: 2072 6574 7572 6e20 6120 6469 6374 2077   return a dict w
+0001a9a0: 6974 6820 6772 6164 7320 6275 7420 6375  ith grads but cu
+0001a9b0: 7272 656e 7420 696e 7465 7266 6163 6520  rrent interface 
+0001a9c0: 6f66 0a20 2020 2023 2062 6163 6b77 6172  of.    # backwar
+0001a9d0: 6420 7275 6c65 2064 6f65 7320 6e6f 7420  d rule does not 
+0001a9e0: 7375 7070 6f72 7420 6974 2e20 536f 2077  support it. So w
+0001a9f0: 6520 6a75 7374 2064 726f 7020 6974 2066  e just drop it f
+0001aa00: 6f72 206e 6f77 2e0a 2020 2020 656c 6966  or now..    elif
+0001aa10: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
+0001aa20: 6c74 5b2d 315d 2c20 6469 6374 293a 0a20  lt[-1], dict):. 
+0001aa30: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+0001aa40: 7375 6c74 5b3a 2d31 5d0a 2020 2020 7265  sult[:-1].    re
+0001aa50: 7475 726e 2072 6573 756c 740a 0a0a 4072  turn result...@r
+0001aa60: 6567 6973 7465 725f 6175 676d 656e 7465  egister_augmente
+0001aa70: 645f 666f 7277 6172 6428 2274 6f72 6368  d_forward("torch
+0001aa80: 2e54 656e 736f 722e 636f 6e74 6967 756f  .Tensor.contiguo
+0001aa90: 7573 2229 0a40 7265 6769 7374 6572 5f61  us").@register_a
+0001aaa0: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+0001aab0: 2822 746f 7263 682e 636f 6e74 6967 756f  ("torch.contiguo
+0001aac0: 7573 2229 0a64 6566 2063 6f6e 7469 6775  us").def contigu
+0001aad0: 6f75 735f 6175 675f 6677 6428 783a 2054  ous_aug_fwd(x: T
+0001aae0: 656e 736f 7250 726f 7879 2c20 2f2c 202a  ensorProxy, /, *
+0001aaf0: 2c20 6d65 6d6f 7279 5f66 6f72 6d61 743a  , memory_format:
+0001ab00: 2074 6f72 6368 2e6d 656d 6f72 795f 666f   torch.memory_fo
+0001ab10: 726d 6174 203d 2074 6f72 6368 2e63 6f6e  rmat = torch.con
+0001ab20: 7469 6775 6f75 735f 666f 726d 6174 2920  tiguous_format) 
+0001ab30: 2d3e 2056 4a50 4475 616c 3a0a 2020 2020  -> VJPDual:.    
+0001ab40: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
+0001ab50: 6368 2069 6d70 6f72 7420 636f 6e74 6967  ch import contig
+0001ab60: 756f 7573 0a0a 2020 2020 7265 7475 726e  uous..    return
+0001ab70: 2056 4a50 4475 616c 2863 6f6e 7469 6775   VJPDual(contigu
+0001ab80: 6f75 7328 782c 206d 656d 6f72 795f 666f  ous(x, memory_fo
+0001ab90: 726d 6174 3d6d 656d 6f72 795f 666f 726d  rmat=memory_form
+0001aba0: 6174 292c 2074 7570 6c65 2829 290a 0a0a  at), tuple())...
+0001abb0: 4072 6567 6973 7465 725f 6261 636b 7761  @register_backwa
+0001abc0: 7264 2822 746f 7263 682e 5465 6e73 6f72  rd("torch.Tensor
+0001abd0: 2e63 6f6e 7469 6775 6f75 7322 290a 4072  .contiguous").@r
+0001abe0: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
+0001abf0: 2822 746f 7263 682e 636f 6e74 6967 756f  ("torch.contiguo
+0001ac00: 7573 2229 0a64 6566 2063 6f6e 7469 6775  us").def contigu
+0001ac10: 6f75 735f 6261 636b 7761 7264 282a 7265  ous_backward(*re
+0001ac20: 7369 6475 616c 735f 616e 645f 6772 6164  siduals_and_grad
+0001ac30: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
+0001ac40: 3a0a 2020 2020 2320 5265 7369 6475 616c  :.    # Residual
+0001ac50: 7320 6973 206e 6f74 2065 6d70 7479 2062  s is not empty b
+0001ac60: 6563 6175 7365 2063 6f6e 7469 6775 6f75  ecause contiguou
+0001ac70: 7320 7379 6d62 6f6c 2068 6173 2074 6865  s symbol has the
+0001ac80: 2073 616d 6520 6f75 7470 7574 2061 7320   same output as 
+0001ac90: 6974 7320 696e 7075 740a 2020 2020 6720  its input.    g 
+0001aca0: 3d20 7265 7369 6475 616c 735f 616e 645f  = residuals_and_
+0001acb0: 6772 6164 5b2d 315d 0a20 2020 2072 6574  grad[-1].    ret
+0001acc0: 7572 6e20 670a 0a0a 6465 6620 7265 6369  urn g...def reci
+0001acd0: 7072 6f63 616c 5f61 7567 5f66 7764 2861  procal_aug_fwd(a
+0001ace0: 3a20 5465 6e73 6f72 5072 6f78 7929 202d  : TensorProxy) -
+0001acf0: 3e20 564a 5044 7561 6c3a 0a20 2020 2070  > VJPDual:.    p
+0001ad00: 7269 6d61 6c20 3d20 7265 6369 7072 6f63  rimal = reciproc
+0001ad10: 616c 2861 290a 2020 2020 7265 7475 726e  al(a).    return
+0001ad20: 2056 4a50 4475 616c 2870 7269 6d61 6c2c   VJPDual(primal,
+0001ad30: 2028 7072 696d 616c 2c29 290a 0a0a 6465   (primal,))...de
+0001ad40: 6620 7265 6369 7072 6f63 616c 5f62 6163  f reciprocal_bac
+0001ad50: 6b77 6172 6428 7072 696d 616c 2c20 6729  kward(primal, g)
+0001ad60: 3a0a 2020 2020 7265 7475 726e 202d 6720  :.    return -g 
+0001ad70: 2a20 7072 696d 616c 202a 2070 7269 6d61  * primal * prima
+0001ad80: 6c0a 0a0a 4070 6172 7469 616c 2872 6567  l...@partial(reg
+0001ad90: 6973 7465 725f 6772 6164 2c20 7072 696d  ister_grad, prim
+0001ada0: 732e 5072 696d 4944 732e 5245 4349 5052  s.PrimIDs.RECIPR
+0001adb0: 4f43 414c 290a 6465 6620 7265 6369 7072  OCAL).def recipr
+0001adc0: 6f63 616c 5f6a 6f69 6e74 5f66 6f72 7761  ocal_joint_forwa
+0001add0: 7264 5f62 6163 6b77 6172 645f 7275 6c65  rd_backward_rule
+0001ade0: 2861 3a20 5465 6e73 6f72 5072 6f78 7929  (a: TensorProxy)
+0001adf0: 202d 3e20 5465 6e73 6f72 5072 6f78 793a   -> TensorProxy:
+0001ae00: 0a20 2020 2072 6573 756c 742c 2073 6176  .    result, sav
+0001ae10: 6564 203d 2072 6563 6970 726f 6361 6c5f  ed = reciprocal_
+0001ae20: 6175 675f 6677 6428 6129 0a20 2020 2067  aug_fwd(a).    g
+0001ae30: 203d 2067 6574 5f67 7261 6428 7265 7375   = get_grad(resu
+0001ae40: 6c74 290a 2020 2020 6761 203d 2072 6563  lt).    ga = rec
+0001ae50: 6970 726f 6361 6c5f 6261 636b 7761 7264  iprocal_backward
+0001ae60: 282a 7361 7665 642c 2067 290a 2020 2020  (*saved, g).    
+0001ae70: 7075 745f 6772 6164 2861 2c20 6761 290a  put_grad(a, ga).
+0001ae80: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0001ae90: 740a 0a0a 4072 6567 6973 7465 725f 6175  t...@register_au
+0001aea0: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
+0001aeb0: 2274 6f72 6368 2e69 6e64 6578 5f70 7574  "torch.index_put
+0001aec0: 2229 0a64 6566 2069 6e64 6578 5f70 7574  ").def index_put
+0001aed0: 5f61 7567 5f66 7764 280a 2020 2020 613a  _aug_fwd(.    a:
+0001aee0: 2054 656e 736f 7250 726f 7879 2c20 2f2c   TensorProxy, /,
+0001aef0: 2069 6e64 6963 6573 3a20 5365 7175 656e   indices: Sequen
+0001af00: 6365 5b54 656e 736f 7250 726f 7879 5d2c  ce[TensorProxy],
+0001af10: 2076 616c 7565 733a 2054 656e 736f 7250   values: TensorP
+0001af20: 726f 7879 2c20 6163 6375 6d75 6c61 7465  roxy, accumulate
+0001af30: 3a20 626f 6f6c 203d 2046 616c 7365 0a29  : bool = False.)
+0001af40: 202d 3e20 564a 5044 7561 6c3a 0a20 2020   -> VJPDual:.   
+0001af50: 2070 7269 6d61 6c20 3d20 636c 616e 672e   primal = clang.
+0001af60: 696e 6465 785f 7075 7428 612c 2069 6e64  index_put(a, ind
+0001af70: 6963 6573 2c20 7661 6c75 6573 2c20 6163  ices, values, ac
+0001af80: 6375 6d75 6c61 7465 290a 2020 2020 7265  cumulate).    re
+0001af90: 7369 6475 616c 7320 3d20 280a 2020 2020  siduals = (.    
+0001afa0: 2020 2020 696e 6469 6365 732c 0a20 2020      indices,.   
+0001afb0: 2020 2020 2076 616c 7565 732c 0a20 2020       values,.   
+0001afc0: 2020 2020 2061 6363 756d 756c 6174 652c       accumulate,
+0001afd0: 0a20 2020 2029 0a20 2020 2072 6574 7572  .    ).    retur
+0001afe0: 6e20 564a 5044 7561 6c28 7072 696d 616c  n VJPDual(primal
+0001aff0: 2c20 7265 7369 6475 616c 7329 0a0a 0a64  , residuals)...d
+0001b000: 6566 2073 756d 5f74 6f28 613a 2054 656e  ef sum_to(a: Ten
+0001b010: 736f 7250 726f 7879 2c20 7368 6170 653a  sorProxy, shape:
+0001b020: 2053 6571 7565 6e63 655b 696e 745d 2920   Sequence[int]) 
+0001b030: 2d3e 2054 656e 736f 7250 726f 7879 3a0a  -> TensorProxy:.
+0001b040: 2020 2020 6966 206e 6f74 2073 6861 7065      if not shape
+0001b050: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0001b060: 2061 2e73 756d 2829 0a20 2020 206c 6561   a.sum().    lea
+0001b070: 6469 6e67 5f64 696d 7320 3d20 612e 6e64  ding_dims = a.nd
+0001b080: 696d 202d 206c 656e 2873 6861 7065 290a  im - len(shape).
+0001b090: 2020 2020 7265 6475 6365 5f64 696d 7320      reduce_dims 
+0001b0a0: 3d20 7475 706c 6528 7261 6e67 6528 6c65  = tuple(range(le
+0001b0b0: 6164 696e 675f 6469 6d73 2929 202b 2074  ading_dims)) + t
+0001b0c0: 7570 6c65 280a 2020 2020 2020 2020 6920  uple(.        i 
+0001b0d0: 666f 7220 6920 696e 2072 616e 6765 286c  for i in range(l
+0001b0e0: 6561 6469 6e67 5f64 696d 732c 2061 2e6e  eading_dims, a.n
+0001b0f0: 6469 6d29 2069 6620 7368 6170 655b 6920  dim) if shape[i 
+0001b100: 2d20 6c65 6164 696e 675f 6469 6d73 5d20  - leading_dims] 
+0001b110: 3d3d 2031 2061 6e64 2061 2e73 6861 7065  == 1 and a.shape
+0001b120: 5b69 5d20 213d 2031 0a20 2020 2029 0a20  [i] != 1.    ). 
+0001b130: 2020 2061 203d 206c 746f 7263 682e 7375     a = ltorch.su
+0001b140: 6d28 612c 2064 696d 3d72 6564 7563 655f  m(a, dim=reduce_
+0001b150: 6469 6d73 2c20 6b65 6570 6469 6d3d 5472  dims, keepdim=Tr
+0001b160: 7565 290a 2020 2020 6966 206c 6561 6469  ue).    if leadi
+0001b170: 6e67 5f64 696d 7320 3e20 303a 0a20 2020  ng_dims > 0:.   
+0001b180: 2020 2020 2072 6574 7572 6e20 6c74 6f72       return ltor
+0001b190: 6368 2e76 6965 7728 612c 2073 6861 7065  ch.view(a, shape
+0001b1a0: 290a 2020 2020 7265 7475 726e 2061 0a0a  ).    return a..
+0001b1b0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
+0001b1c0: 6172 6428 2274 6f72 6368 2e69 6e64 6578  ard("torch.index
+0001b1d0: 5f70 7574 2229 0a64 6566 2069 6e64 6578  _put").def index
+0001b1e0: 5f70 7574 5f62 6163 6b77 6172 6428 696e  _put_backward(in
+0001b1f0: 6469 6365 733a 2053 6571 7565 6e63 655b  dices: Sequence[
+0001b200: 5465 6e73 6f72 5072 6f78 795d 2c20 7661  TensorProxy], va
+0001b210: 6c75 6573 3a20 5465 6e73 6f72 5072 6f78  lues: TensorProx
+0001b220: 792c 2061 6363 756d 756c 6174 653a 2062  y, accumulate: b
+0001b230: 6f6f 6c2c 2067 3a20 5465 6e73 6f72 5072  ool, g: TensorPr
+0001b240: 6f78 7929 3a0a 2020 2020 675f 7661 6c75  oxy):.    g_valu
+0001b250: 6573 203d 2067 5b69 6e64 6963 6573 5d0a  es = g[indices].
+0001b260: 2020 2020 2320 746f 7263 6820 6861 7320      # torch has 
+0001b270: 6578 7472 6120 6c6f 6769 6320 746f 2068  extra logic to h
+0001b280: 616e 646c 6520 7468 6520 6578 7061 6e64  andle the expand
+0001b290: 6564 2076 616c 7565 730a 2020 2020 6966  ed values.    if
+0001b2a0: 206e 6f74 2075 7469 6c73 2e73 616d 655f   not utils.same_
+0001b2b0: 7368 6170 6528 675f 7661 6c75 6573 2e73  shape(g_values.s
+0001b2c0: 6861 7065 2c20 7661 6c75 6573 2e73 6861  hape, values.sha
+0001b2d0: 7065 293a 0a20 2020 2020 2020 2069 6620  pe):.        if 
+0001b2e0: 636c 616e 672e 636f 6d70 7574 655f 6272  clang.compute_br
+0001b2f0: 6f61 6463 6173 745f 7368 6170 6528 675f  oadcast_shape(g_
+0001b300: 7661 6c75 6573 2e73 6861 7065 2c20 7661  values.shape, va
+0001b310: 6c75 6573 2e73 6861 7065 293a 0a20 2020  lues.shape):.   
+0001b320: 2020 2020 2020 2020 2067 5f76 616c 7565           g_value
+0001b330: 7320 3d20 7375 6d5f 746f 2867 5f76 616c  s = sum_to(g_val
+0001b340: 7565 732c 2076 616c 7565 732e 7368 6170  ues, values.shap
+0001b350: 6529 0a20 2020 2069 6620 6163 6375 6d75  e).    if accumu
+0001b360: 6c61 7465 3a0a 2020 2020 2020 2020 7265  late:.        re
+0001b370: 7475 726e 2067 2c20 675f 7661 6c75 6573  turn g, g_values
+0001b380: 0a20 2020 2072 6574 7572 6e20 636c 616e  .    return clan
+0001b390: 672e 696e 6465 785f 7075 7428 672c 2069  g.index_put(g, i
+0001b3a0: 6e64 6963 6573 2c20 6c74 6f72 6368 2e7a  ndices, ltorch.z
+0001b3b0: 6572 6f73 5f6c 696b 6528 7661 6c75 6573  eros_like(values
+0001b3c0: 292c 2046 616c 7365 292c 2067 5f76 616c  ), False), g_val
+0001b3d0: 7565 730a 0a0a 6465 6620 756e 6966 6f72  ues...def unifor
+0001b3e0: 6d5f 6175 675f 6677 6428 7368 6170 652c  m_aug_fwd(shape,
+0001b3f0: 206d 696e 7661 6c2c 206d 6178 7661 6c2c   minval, maxval,
+0001b400: 202a 2c20 6465 7669 6365 2c20 6474 7970   *, device, dtyp
+0001b410: 6529 3a0a 2020 2020 7072 696d 616c 203d  e):.    primal =
+0001b420: 2070 7269 6d73 2e75 6e69 666f 726d 2873   prims.uniform(s
+0001b430: 6861 7065 2c20 6d69 6e76 616c 2c20 6d61  hape, minval, ma
+0001b440: 7876 616c 2c20 6465 7669 6365 3d64 6576  xval, device=dev
+0001b450: 6963 652c 2064 7479 7065 3d64 7479 7065  ice, dtype=dtype
+0001b460: 290a 2020 2020 7265 7475 726e 2056 4a50  ).    return VJP
+0001b470: 4475 616c 2870 7269 6d61 6c2c 2028 7072  Dual(primal, (pr
+0001b480: 696d 616c 2c20 6d69 6e76 616c 2c20 6d61  imal, minval, ma
+0001b490: 7876 616c 2929 0a0a 0a64 6566 2075 6e69  xval))...def uni
+0001b4a0: 666f 726d 5f62 6163 6b77 6172 6428 7072  form_backward(pr
+0001b4b0: 696d 616c 2c20 6d69 6e76 616c 2c20 6d61  imal, minval, ma
+0001b4c0: 7876 616c 2c20 6729 3a0a 2020 2020 2320  xval, g):.    # 
+0001b4d0: 756e 6966 6f72 6d20 6973 2069 6d70 6c65  uniform is imple
+0001b4e0: 6d65 6e74 6564 2061 7320 286d 6178 7661  mented as (maxva
+0001b4f0: 6c20 2d20 6d69 6e76 616c 2920 2a20 756e  l - minval) * un
+0001b500: 6966 6f72 6d28 7368 6170 652c 2030 2c20  iform(shape, 0, 
+0001b510: 3129 202b 206d 696e 7661 6c0a 2020 2020  1) + minval.    
+0001b520: 756e 7363 616c 6564 5f70 7269 6d61 6c20  unscaled_primal 
+0001b530: 3d20 2870 7269 6d61 6c20 2d20 6d69 6e76  = (primal - minv
+0001b540: 616c 2920 2f20 286d 6178 7661 6c20 2d20  al) / (maxval - 
+0001b550: 6d69 6e76 616c 290a 2020 2020 7265 6475  minval).    redu
+0001b560: 6365 5f61 6c6c 5f64 696d 7320 3d20 7475  ce_all_dims = tu
+0001b570: 706c 6528 7261 6e67 6528 672e 6e64 696d  ple(range(g.ndim
+0001b580: 2929 0a20 2020 2073 756d 203d 2070 6172  )).    sum = par
+0001b590: 7469 616c 2870 7269 6d73 2e73 756d 2c20  tial(prims.sum, 
+0001b5a0: 6469 6d73 3d72 6564 7563 655f 616c 6c5f  dims=reduce_all_
+0001b5b0: 6469 6d73 290a 2020 2020 7265 7475 726e  dims).    return
+0001b5c0: 204e 6f6e 652c 2073 756d 2867 202a 2028   None, sum(g * (
+0001b5d0: 3120 2d20 756e 7363 616c 6564 5f70 7269  1 - unscaled_pri
+0001b5e0: 6d61 6c29 292c 2073 756d 2867 202a 2075  mal)), sum(g * u
+0001b5f0: 6e73 6361 6c65 645f 7072 696d 616c 290a  nscaled_primal).
+0001b600: 0a0a 6e6f 6e64 6966 6665 7265 6e74 6961  ..nondifferentia
+0001b610: 626c 655f 766a 705f 7379 6d62 6f6c 7320  ble_vjp_symbols 
+0001b620: 3d20 2870 7269 6d73 2e50 7269 6d49 4473  = (prims.PrimIDs
+0001b630: 2e42 4954 5749 5345 5f41 4e44 2c20 7072  .BITWISE_AND, pr
+0001b640: 696d 732e 5072 696d 4944 732e 5349 474e  ims.PrimIDs.SIGN
+0001b650: 4249 542c 2070 7269 6d73 2e50 7269 6d49  BIT, prims.PrimI
+0001b660: 4473 2e46 554c 4c29 0a0a 0a64 6566 2069  Ds.FULL)...def i
+0001b670: 735f 636f 6e73 7461 6e74 5f66 6f72 5f76  s_constant_for_v
+0001b680: 6a70 2873 796d 626f 6c3a 2070 7269 6d73  jp(symbol: prims
+0001b690: 2e53 796d 626f 6c29 202d 3e20 626f 6f6c  .Symbol) -> bool
+0001b6a0: 3a0a 2020 2020 2222 2243 6865 636b 2069  :.    """Check i
+0001b6b0: 6620 6120 7379 6d62 6f6c 2069 7320 636f  f a symbol is co
+0001b6c0: 6e73 7461 6e74 2066 6f72 2074 6865 2056  nstant for the V
+0001b6d0: 4a50 2074 7261 6e73 666f 726d 2e0a 0a20  JP transform... 
+0001b6e0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0001b6f0: 2073 796d 626f 6c20 2870 7269 6d73 2e53   symbol (prims.S
+0001b700: 796d 626f 6c29 3a20 5379 6d62 6f6c 2074  ymbol): Symbol t
+0001b710: 6f20 6368 6563 6b2e 0a0a 2020 2020 5265  o check...    Re
+0001b720: 7475 726e 733a 0a20 2020 2020 2020 2062  turns:.        b
+0001b730: 6f6f 6c3a 2054 7275 6520 6966 2074 6865  ool: True if the
+0001b740: 2073 796d 626f 6c20 6973 2063 6f6e 7374   symbol is const
+0001b750: 616e 742c 2046 616c 7365 206f 7468 6572  ant, False other
+0001b760: 7769 7365 2e0a 2020 2020 2222 220a 2020  wise..    """.  
+0001b770: 2020 6172 655f 616c 6c5f 6172 6773 5f6e    are_all_args_n
+0001b780: 6f6e 5f64 6966 6665 7265 6e74 6961 626c  on_differentiabl
+0001b790: 6520 3d20 6e6f 7420 616e 7928 6973 696e  e = not any(isin
+0001b7a0: 7374 616e 6365 2861 7267 2c20 2846 6c6f  stance(arg, (Flo
+0001b7b0: 6174 5072 6f78 792c 2054 656e 736f 7250  atProxy, TensorP
+0001b7c0: 726f 7879 2929 2066 6f72 2061 7267 2069  roxy)) for arg i
+0001b7d0: 6e20 7379 6d62 6f6c 2e66 6c61 745f 6172  n symbol.flat_ar
+0001b7e0: 6773 290a 2020 2020 7265 7475 726e 2028  gs).    return (
+0001b7f0: 0a20 2020 2020 2020 2061 7265 5f61 6c6c  .        are_all
+0001b800: 5f61 7267 735f 6e6f 6e5f 6469 6666 6572  _args_non_differ
+0001b810: 656e 7469 6162 6c65 0a20 2020 2020 2020  entiable.       
+0001b820: 206f 7220 7379 6d62 6f6c 2e61 7265 5f61   or symbol.are_a
+0001b830: 6c6c 5f61 7267 735f 636f 6e73 7461 6e74  ll_args_constant
+0001b840: 0a20 2020 2020 2020 206f 7220 7379 6d62  .        or symb
+0001b850: 6f6c 2e73 796d 2e69 6420 696e 206e 6f6e  ol.sym.id in non
+0001b860: 6469 6666 6572 656e 7469 6162 6c65 5f76  differentiable_v
+0001b870: 6a70 5f73 796d 626f 6c73 0a20 2020 2029  jp_symbols.    )
+0001b880: 0a0a 0a64 6566 2076 6a70 5f73 796d 626f  ...def vjp_symbo
+0001b890: 6c5f 6d61 7070 6572 2873 796d 626f 6c3a  l_mapper(symbol:
+0001b8a0: 2070 7269 6d73 2e53 796d 626f 6c2c 202a   prims.Symbol, *
+0001b8b0: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
+0001b8c0: 0a20 2020 2022 2222 5379 6d62 6f6c 206d  .    """Symbol m
+0001b8d0: 6170 7065 7220 666f 7220 7468 6520 564a  apper for the VJ
+0001b8e0: 5020 7472 616e 7366 6f72 6d2e 0a0a 2020  P transform...  
+0001b8f0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0001b900: 7379 6d62 6f6c 2028 7072 696d 732e 5379  symbol (prims.Sy
+0001b910: 6d62 6f6c 293a 2053 796d 626f 6c20 746f  mbol): Symbol to
+0001b920: 2062 6520 6d61 7070 6564 2e0a 2020 2020   be mapped..    
+0001b930: 2020 2020 6172 6773 2028 5475 706c 655b      args (Tuple[
+0001b940: 5661 7269 6162 6c65 5d29 3a20 4172 6775  Variable]): Argu
+0001b950: 6d65 6e74 7320 746f 2074 6865 2073 796d  ments to the sym
+0001b960: 626f 6c2e 0a20 2020 2020 2020 206b 7761  bol..        kwa
+0001b970: 7267 7320 2844 6963 745b 7374 722c 2056  rgs (Dict[str, V
+0001b980: 6172 6961 626c 655d 293a 204b 6579 776f  ariable]): Keywo
+0001b990: 7264 2061 7267 756d 656e 7473 2074 6f20  rd arguments to 
+0001b9a0: 7468 6520 7379 6d62 6f6c 2e0a 0a20 2020  the symbol...   
+0001b9b0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0001b9c0: 2020 4361 6c6c 6162 6c65 3a20 4120 6675    Callable: A fu
+0001b9d0: 6e63 7469 6f6e 2074 6861 7420 636f 6d70  nction that comp
+0001b9e0: 7574 6573 2074 6865 2056 4a50 206f 6620  utes the VJP of 
+0001b9f0: 7468 6520 7379 6d62 6f6c 2e0a 2020 2020  the symbol..    
+0001ba00: 2222 220a 2020 2020 2320 436f 6e73 7461  """.    # Consta
+0001ba10: 6e74 2063 6173 650a 2020 2020 6966 2069  nt case.    if i
+0001ba20: 735f 636f 6e73 7461 6e74 5f66 6f72 5f76  s_constant_for_v
+0001ba30: 6a70 2873 796d 626f 6c29 3a0a 0a20 2020  jp(symbol):..   
+0001ba40: 2020 2020 2064 6566 2076 6a70 5f69 6d70       def vjp_imp
+0001ba50: 6c5f 636f 6e73 7428 7379 6d62 6f6c 2c20  l_const(symbol, 
+0001ba60: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+0001ba70: 3a0a 2020 2020 2020 2020 2020 2020 6172  :.            ar
+0001ba80: 6773 2c20 6b77 6172 6773 203d 2074 7265  gs, kwargs = tre
+0001ba90: 655f 6d61 7028 6c61 6d62 6461 2078 3a20  e_map(lambda x: 
+0001baa0: 782e 7072 696d 616c 2069 6620 6973 696e  x.primal if isin
+0001bab0: 7374 616e 6365 2878 2c20 564a 5044 7561  stance(x, VJPDua
+0001bac0: 6c29 2065 6c73 6520 782c 2028 6172 6773  l) else x, (args
+0001bad0: 2c20 6b77 6172 6773 2929 0a20 2020 2020  , kwargs)).     
+0001bae0: 2020 2020 2020 2070 7269 6d61 6c73 203d         primals =
+0001baf0: 2073 796d 626f 6c5f 746f 5f65 7661 6c28   symbol_to_eval(
+0001bb00: 7379 6d62 6f6c 2928 2a61 7267 732c 202a  symbol)(*args, *
+0001bb10: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
+0001bb20: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0001bb30: 6365 2870 7269 6d61 6c73 2c20 5365 7175  ce(primals, Sequ
+0001bb40: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
+0001bb50: 2020 2020 2020 2072 6574 7572 6e20 7472         return tr
+0001bb60: 6565 5f6d 6170 286c 616d 6264 6120 783a  ee_map(lambda x:
+0001bb70: 2056 4a50 4475 616c 2878 2c20 7475 706c   VJPDual(x, tupl
+0001bb80: 6528 2929 2c20 7072 696d 616c 7329 0a20  e()), primals). 
+0001bb90: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001bba0: 6e20 564a 5044 7561 6c28 7072 696d 616c  n VJPDual(primal
+0001bbb0: 732c 2074 7570 6c65 2829 290a 0a20 2020  s, tuple())..   
+0001bbc0: 2020 2020 2072 6574 7572 6e20 7061 7274       return part
+0001bbd0: 6961 6c28 766a 705f 696d 706c 5f63 6f6e  ial(vjp_impl_con
+0001bbe0: 7374 2c20 7379 6d62 6f6c 290a 0a20 2020  st, symbol)..   
+0001bbf0: 2023 204e 6f72 6d61 6c20 6361 7365 2c20   # Normal case, 
+0001bc00: 7765 2068 6176 6520 6120 7072 6f78 7920  we have a proxy 
+0001bc10: 7461 6e67 656e 740a 2020 2020 766a 705f  tangent.    vjp_
+0001bc20: 696d 706c 203d 2061 7567 6d65 6e74 6564  impl = augmented
+0001bc30: 5f66 6f72 7761 7264 5f69 6d70 6c73 2e67  _forward_impls.g
+0001bc40: 6574 2873 796d 626f 6c2e 7379 6d2e 6964  et(symbol.sym.id
+0001bc50: 290a 0a20 2020 2069 6620 5f67 6574 5f67  )..    if _get_g
+0001bc60: 7261 6466 6e28 7379 6d62 6f6c 2920 6973  radfn(symbol) is
+0001bc70: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0001bc80: 2020 2076 6a70 5f69 6d70 6c2c 2062 6163     vjp_impl, bac
+0001bc90: 6b77 6172 645f 666e 203d 206d 616b 655f  kward_fn = make_
+0001bca0: 6175 675f 666f 7277 6172 645f 616e 645f  aug_forward_and_
+0001bcb0: 6261 636b 7761 7264 2873 796d 626f 6c29  backward(symbol)
+0001bcc0: 0a0a 2020 2020 6966 2076 6a70 5f69 6d70  ..    if vjp_imp
+0001bcd0: 6c20 6973 204e 6f6e 653a 0a20 2020 2020  l is None:.     
+0001bce0: 2020 2023 2057 6520 636f 756c 6420 6e6f     # We could no
+0001bcf0: 7420 6669 6e64 2061 2056 4a50 2066 6f72  t find a VJP for
+0001bd00: 2074 6869 7320 7379 6d62 6f6c 2c20 736f   this symbol, so
+0001bd10: 2077 6520 7472 7920 746f 2064 6563 6f6d   we try to decom
+0001bd20: 706f 7365 2069 740a 2020 2020 2020 2020  pose it.        
+0001bd30: 6966 206c 656e 2873 796d 626f 6c2e 7375  if len(symbol.su
+0001bd40: 6273 796d 626f 6c73 2920 3e20 3020 616e  bsymbols) > 0 an
+0001bd50: 6420 6e6f 7420 6973 696e 7374 616e 6365  d not isinstance
+0001bd60: 2873 796d 626f 6c2e 7379 6d2e 6964 2c20  (symbol.sym.id, 
+0001bd70: 7072 696d 732e 5072 696d 4944 7329 3a0a  prims.PrimIDs):.
+0001bd80: 2020 2020 2020 2020 2020 2020 766a 705f              vjp_
+0001bd90: 696d 706c 203d 2070 6172 7469 616c 2864  impl = partial(d
+0001bda0: 6563 6f6d 706f 7365 645f 666e 5f61 7567  ecomposed_fn_aug
+0001bdb0: 5f66 7764 5f72 756c 652c 2064 6563 6f6d  _fwd_rule, decom
+0001bdc0: 706f 7365 645f 666e 3d73 796d 626f 6c2e  posed_fn=symbol.
+0001bdd0: 7379 6d29 0a20 2020 2020 2020 2065 6c73  sym).        els
+0001bde0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+0001bdf0: 2057 6520 636f 756c 6420 6e6f 7420 6669   We could not fi
+0001be00: 6e64 2061 2056 4a50 2066 6f72 2074 6869  nd a VJP for thi
+0001be10: 7320 7379 6d62 6f6c 2061 6e64 2077 6520  s symbol and we 
+0001be20: 636f 756c 6420 6e6f 7420 6465 636f 6d70  could not decomp
+0001be30: 6f73 6520 6974 0a20 2020 2020 2020 2020  ose it.         
+0001be40: 2020 2023 2049 7420 636f 756c 6420 6265     # It could be
+0001be50: 2061 2074 6f72 6368 2e64 726f 706f 7574   a torch.dropout
+0001be60: 2077 6974 6820 302e 3020 7072 6f62 6162   with 0.0 probab
+0001be70: 696c 6974 792c 2073 6f20 7765 2073 6b69  ility, so we ski
+0001be80: 7020 6974 0a20 2020 2020 2020 2020 2020  p it.           
+0001be90: 2069 6620 7379 6d62 6f6c 2e73 796d 2e69   if symbol.sym.i
+0001bea0: 6420 3d3d 2022 746f 7263 682e 6e6e 2e66  d == "torch.nn.f
+0001beb0: 756e 6374 696f 6e61 6c2e 6472 6f70 6f75  unctional.dropou
+0001bec0: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
+0001bed0: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
+0001bee0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0001bef0: 7428 6622 564a 5020 666f 7220 7b73 796d  t(f"VJP for {sym
+0001bf00: 626f 6c7d 2069 7320 6e6f 7420 696d 706c  bol} is not impl
+0001bf10: 656d 656e 7465 6422 290a 2020 2020 2020  emented").      
+0001bf20: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
+0001bf30: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
+0001bf40: 6622 564a 5020 666f 7220 7b73 796d 626f  f"VJP for {symbo
+0001bf50: 6c2e 7379 6d2e 6964 7d20 6973 206e 6f74  l.sym.id} is not
+0001bf60: 2069 6d70 6c65 6d65 6e74 6564 2229 0a0a   implemented")..
+0001bf70: 2020 2020 6465 6620 5f76 6a70 5f69 6d70      def _vjp_imp
+0001bf80: 6c28 2a61 7267 732c 202a 2a6b 7761 7267  l(*args, **kwarg
+0001bf90: 7329 3a0a 2020 2020 2020 2020 7072 696d  s):.        prim
+0001bfa0: 616c 732c 206b 7761 7267 7320 3d20 7472  als, kwargs = tr
+0001bfb0: 6565 5f6d 6170 286c 616d 6264 6120 783a  ee_map(lambda x:
+0001bfc0: 2078 2e70 7269 6d61 6c20 6966 2069 7369   x.primal if isi
+0001bfd0: 6e73 7461 6e63 6528 782c 2056 4a50 4475  nstance(x, VJPDu
+0001bfe0: 616c 2920 656c 7365 2078 2c20 2861 7267  al) else x, (arg
+0001bff0: 732c 206b 7761 7267 7329 290a 2020 2020  s, kwargs)).    
+0001c000: 2020 2020 6f75 745f 7072 696d 616c 2c20      out_primal, 
+0001c010: 6f75 745f 7265 7369 6475 616c 7320 3d20  out_residuals = 
+0001c020: 766a 705f 696d 706c 282a 7072 696d 616c  vjp_impl(*primal
+0001c030: 732c 202a 2a6b 7761 7267 7329 0a0a 2020  s, **kwargs)..  
+0001c040: 2020 2020 2020 2320 5765 2061 7265 2073        # We are s
+0001c050: 6176 696e 6720 7468 6520 7265 7369 6475  aving the residu
+0001c060: 616c 7320 616e 6420 7075 6c6c 6261 636b  als and pullback
+0001c070: 206f 6e6c 7920 696e 2074 6865 2066 6972   only in the fir
+0001c080: 7374 206f 7574 7075 740a 2020 2020 2020  st output.      
+0001c090: 2020 2320 6261 636b 7761 7264 5f70 6173    # backward_pas
+0001c0a0: 7320 7468 656e 2072 6574 7269 6576 6573  s then retrieves
+0001c0b0: 2074 6865 2072 6573 6964 7561 6c73 2061   the residuals a
+0001c0c0: 6e64 2070 756c 6c62 6163 6b20 6672 6f6d  nd pullback from
+0001c0d0: 2074 6865 2066 6972 7374 206f 7574 7075   the first outpu
+0001c0e0: 740a 2020 2020 2020 2020 6966 2069 7369  t.        if isi
+0001c0f0: 6e73 7461 6e63 6528 6f75 745f 7072 696d  nstance(out_prim
+0001c100: 616c 2c20 5365 7175 656e 6365 293a 0a20  al, Sequence):. 
+0001c110: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001c120: 6e20 2856 4a50 4475 616c 286f 7574 5f70  n (VJPDual(out_p
+0001c130: 7269 6d61 6c5b 305d 2c20 6f75 745f 7265  rimal[0], out_re
+0001c140: 7369 6475 616c 7329 2c20 2a28 564a 5044  siduals), *(VJPD
+0001c150: 7561 6c28 6f2c 2074 7570 6c65 2829 2920  ual(o, tuple()) 
+0001c160: 666f 7220 6f20 696e 206f 7574 5f70 7269  for o in out_pri
+0001c170: 6d61 6c5b 313a 5d29 290a 0a20 2020 2020  mal[1:]))..     
+0001c180: 2020 2072 6574 7572 6e20 2856 4a50 4475     return (VJPDu
+0001c190: 616c 286f 7574 5f70 7269 6d61 6c2c 206f  al(out_primal, o
+0001c1a0: 7574 5f72 6573 6964 7561 6c73 292c 290a  ut_residuals),).
+0001c1b0: 0a20 2020 2072 6574 7572 6e20 5f76 6a70  .    return _vjp
+0001c1c0: 5f69 6d70 6c0a 0a0a 6465 6620 6368 6563  _impl...def chec
+0001c1d0: 6b5f 6273 796d 5f66 6f72 5f76 6a70 2862  k_bsym_for_vjp(b
+0001c1e0: 7379 6d29 3a0a 2020 2020 2222 220a 2020  sym):.    """.  
+0001c1f0: 2020 4368 6563 6b20 6966 2061 2062 6f75    Check if a bou
+0001c200: 6e64 2073 796d 626f 6c20 6973 2073 7570  nd symbol is sup
+0001c210: 706f 7274 6564 2062 7920 766a 702e 0a0a  ported by vjp...
+0001c220: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+0001c230: 2020 6273 796d 2028 426f 756e 6453 796d    bsym (BoundSym
+0001c240: 626f 6c29 3a20 5468 6520 626f 756e 6420  bol): The bound 
+0001c250: 7379 6d62 6f6c 2074 6f20 6368 6563 6b2e  symbol to check.
+0001c260: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+0001c270: 2020 2020 2020 2062 6f6f 6c3a 2054 7275         bool: Tru
+0001c280: 6520 6966 2074 6865 2062 6f75 6e64 2073  e if the bound s
+0001c290: 796d 626f 6c20 6973 2073 7570 706f 7274  ymbol is support
+0001c2a0: 6564 2062 7920 766a 702c 2046 616c 7365  ed by vjp, False
+0001c2b0: 206f 7468 6572 7769 7365 2e0a 2020 2020   otherwise..    
+0001c2c0: 2222 220a 0a20 2020 2069 6620 6273 796d  """..    if bsym
+0001c2d0: 2e73 796d 2e69 6420 696e 2074 7261 6e73  .sym.id in trans
+0001c2e0: 666f 726d 5f73 6b69 705f 6c69 7374 3a0a  form_skip_list:.
+0001c2f0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+0001c300: 7275 650a 0a20 2020 2069 6620 6273 796d  rue..    if bsym
+0001c310: 2e73 796d 2e69 6420 696e 2062 6163 6b77  .sym.id in backw
+0001c320: 6172 645f 696d 706c 7320 616e 6420 6273  ard_impls and bs
+0001c330: 796d 2e73 796d 2e69 6420 696e 2061 7567  ym.sym.id in aug
+0001c340: 6d65 6e74 6564 5f66 6f72 7761 7264 5f69  mented_forward_i
+0001c350: 6d70 6c73 3a0a 2020 2020 2020 2020 7265  mpls:.        re
+0001c360: 7475 726e 2054 7275 650a 0a20 2020 2069  turn True..    i
+0001c370: 6620 6273 796d 2e73 796d 2e69 6420 696e  f bsym.sym.id in
+0001c380: 205f 6772 6164 5f66 6e5f 6d61 703a 0a20   _grad_fn_map:. 
+0001c390: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+0001c3a0: 7565 0a0a 2020 2020 2320 5765 2063 6f75  ue..    # We cou
+0001c3b0: 6c64 206e 6f74 2066 696e 6420 6120 564a  ld not find a VJ
+0001c3c0: 5020 666f 7220 7468 6973 2073 796d 626f  P for this symbo
+0001c3d0: 6c2c 2073 6f20 7765 2074 7279 2074 6f20  l, so we try to 
+0001c3e0: 6465 636f 6d70 6f73 6520 6974 0a20 2020  decompose it.   
+0001c3f0: 2023 2069 6e74 6f20 7375 622d 7379 6d62   # into sub-symb
+0001c400: 6f6c 7320 616e 6420 6368 6563 6b20 6966  ols and check if
+0001c410: 2074 6865 7920 6172 6520 7375 7070 6f72   they are suppor
+0001c420: 7465 640a 2020 2020 6966 206c 656e 2862  ted.    if len(b
+0001c430: 7379 6d2e 7375 6273 796d 626f 6c73 2920  sym.subsymbols) 
+0001c440: 3e20 3020 616e 6420 6e6f 7420 6273 796d  > 0 and not bsym
+0001c450: 2e73 796d 2e69 735f 7072 696d 3a0a 2020  .sym.is_prim:.  
+0001c460: 2020 2020 2020 7375 6274 7261 6365 203d        subtrace =
+0001c470: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
+0001c480: 2829 2862 7379 6d2e 7379 6d2c 202a 6273  ()(bsym.sym, *bs
+0001c490: 796d 2e61 7267 732c 202a 2a62 7379 6d2e  ym.args, **bsym.
+0001c4a0: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
+0001c4b0: 7375 6274 7261 6365 203d 2075 6e77 7261  subtrace = unwra
+0001c4c0: 705f 6f6e 655f 6c65 7665 6c5f 6f66 5f73  p_one_level_of_s
+0001c4d0: 7562 7379 6d62 6f6c 7328 7375 6274 7261  ubsymbols(subtra
+0001c4e0: 6365 290a 2020 2020 2020 2020 616c 6c5f  ce).        all_
+0001c4f0: 7375 7070 6f72 7465 6420 3d20 616c 6c28  supported = all(
+0001c500: 6368 6563 6b5f 6273 796d 5f66 6f72 5f76  check_bsym_for_v
+0001c510: 6a70 2873 7562 6273 796d 2920 666f 7220  jp(subbsym) for 
+0001c520: 7375 6262 7379 6d20 696e 2073 7562 7472  subbsym in subtr
+0001c530: 6163 652e 626f 756e 645f 7379 6d62 6f6c  ace.bound_symbol
+0001c540: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
+0001c550: 6e20 616c 6c5f 7375 7070 6f72 7465 640a  n all_supported.
+0001c560: 0a20 2020 2072 6574 7572 6e20 4661 6c73  .    return Fals
+0001c570: 650a 0a0a 6465 6620 6175 676d 656e 7465  e...def augmente
+0001c580: 645f 666f 7277 6172 645f 7061 7373 282a  d_forward_pass(*
+0001c590: 6172 6773 2c20 7472 6163 653a 2054 7261  args, trace: Tra
+0001c5a0: 6365 2c20 2a2a 6b77 6172 6773 293a 0a20  ce, **kwargs):. 
+0001c5b0: 2020 2022 2222 4175 676d 656e 7465 6420     """Augmented 
+0001c5c0: 666f 7277 6172 6420 7061 7373 2066 6f72  forward pass for
+0001c5d0: 2074 6865 2056 4a50 2074 7261 6e73 666f   the VJP transfo
+0001c5e0: 726d 2e0a 0a20 2020 2054 6865 2061 7567  rm...    The aug
+0001c5f0: 6d65 6e74 6564 2066 6f72 7761 7264 2070  mented forward p
+0001c600: 6173 7320 6973 2061 2066 6f72 7761 7264  ass is a forward
+0001c610: 2070 6173 7320 7468 6174 2072 6574 7572   pass that retur
+0001c620: 6e73 2074 6865 2072 6573 6964 7561 6c73  ns the residuals
+0001c630: 0a20 2020 206f 6620 7468 6520 666f 7277  .    of the forw
+0001c640: 6172 6420 7061 7373 2e0a 2020 2020 5468  ard pass..    Th
+0001c650: 6573 6520 7265 7369 6475 616c 7320 6172  ese residuals ar
+0001c660: 6520 7573 6564 2069 6e20 7468 6520 6261  e used in the ba
+0001c670: 636b 7761 7264 2070 6173 7320 746f 2063  ckward pass to c
+0001c680: 6f6d 7075 7465 2074 6865 2056 4a50 2061  ompute the VJP a
+0001c690: 6e64 2074 6865 790a 2020 2020 6172 6520  nd they.    are 
+0001c6a0: 7265 636f 7264 6564 2069 6e20 7468 6520  recorded in the 
+0001c6b0: 656e 7669 726f 6e6d 656e 7420 6469 6374  environment dict
+0001c6c0: 696f 6e61 7279 2066 6f72 2065 6163 6820  ionary for each 
+0001c6d0: 7661 7269 6162 6c65 2e0a 0a20 2020 2041  variable...    A
+0001c6e0: 7267 733a 0a20 2020 2020 2020 2061 7267  rgs:.        arg
+0001c6f0: 7320 2854 7570 6c65 5b56 6172 6961 626c  s (Tuple[Variabl
+0001c700: 655d 293a 2041 7267 756d 656e 7473 2074  e]): Arguments t
+0001c710: 6f20 7468 6520 6675 6e63 7469 6f6e 2e0a  o the function..
+0001c720: 2020 2020 2020 2020 7472 6163 6520 2854          trace (T
+0001c730: 7261 6365 293a 2054 7261 6365 206f 6620  race): Trace of 
+0001c740: 7468 6520 6675 6e63 7469 6f6e 2e0a 2020  the function..  
+0001c750: 2020 2020 2020 6b77 6172 6773 2028 4469        kwargs (Di
+0001c760: 6374 5b73 7472 2c20 5661 7269 6162 6c65  ct[str, Variable
+0001c770: 5d29 3a20 4b65 7977 6f72 6420 6172 6775  ]): Keyword argu
+0001c780: 6d65 6e74 7320 746f 2074 6865 2066 756e  ments to the fun
+0001c790: 6374 696f 6e2e 0a0a 2020 2020 5265 7475  ction...    Retu
+0001c7a0: 726e 733a 0a20 2020 2020 2020 2054 7570  rns:.        Tup
+0001c7b0: 6c65 5b41 6e79 2c20 4469 6374 5b73 7472  le[Any, Dict[str
+0001c7c0: 2c20 416e 795d 5d3a 2054 7570 6c65 206f  , Any]]: Tuple o
+0001c7d0: 6620 7468 6520 7072 696d 616c 206f 7574  f the primal out
+0001c7e0: 7075 7473 2061 6e64 2074 6865 2065 6e76  puts and the env
+0001c7f0: 6972 6f6e 6d65 6e74 2e0a 2020 2020 2222  ironment..    ""
+0001c800: 220a 2020 2020 6172 6773 2c20 6b77 6172  ".    args, kwar
+0001c810: 6773 203d 2074 7265 655f 6d61 7028 6c61  gs = tree_map(la
+0001c820: 6d62 6461 2078 3a20 564a 5044 7561 6c28  mbda x: VJPDual(
+0001c830: 782c 2074 7570 6c65 2829 292c 2028 6172  x, tuple()), (ar
+0001c840: 6773 2c20 6b77 6172 6773 2929 0a20 2020  gs, kwargs)).   
+0001c850: 2072 6573 756c 742c 2065 6e76 203d 2065   result, env = e
+0001c860: 7661 6c5f 7472 6163 6528 0a20 2020 2020  val_trace(.     
+0001c870: 2020 2074 7261 6365 2c0a 2020 2020 2020     trace,.      
+0001c880: 2020 2a61 7267 732c 0a20 2020 2020 2020    *args,.       
+0001c890: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
+0001c8a0: 2020 2077 6974 685f 656e 763d 5472 7565     with_env=True
+0001c8b0: 2c0a 2020 2020 2020 2020 7379 6d62 6f6c  ,.        symbol
+0001c8c0: 5f6d 6170 7065 723d 766a 705f 7379 6d62  _mapper=vjp_symb
+0001c8d0: 6f6c 5f6d 6170 7065 722c 0a20 2020 2029  ol_mapper,.    )
+0001c8e0: 0a20 2020 2072 6573 756c 7420 3d20 7472  .    result = tr
+0001c8f0: 6565 5f6d 6170 286c 616d 6264 6120 783a  ee_map(lambda x:
+0001c900: 2078 2e70 7269 6d61 6c20 6966 2069 7369   x.primal if isi
+0001c910: 6e73 7461 6e63 6528 782c 2056 4a50 4475  nstance(x, VJPDu
+0001c920: 616c 2920 656c 7365 2078 2c20 7265 7375  al) else x, resu
+0001c930: 6c74 290a 2020 2020 7265 7475 726e 2072  lt).    return r
+0001c940: 6573 756c 742c 2065 6e76 0a0a 0a23 2054  esult, env...# T
+0001c950: 4f44 4f3a 2049 6e73 7465 6164 206f 6620  ODO: Instead of 
+0001c960: 7573 696e 6720 7468 6520 656e 7669 726f  using the enviro
+0001c970: 6e6d 656e 7420 6469 6374 696f 6e61 7279  nment dictionary
+0001c980: 2c20 7765 2063 6f75 6c64 2075 7365 2074  , we could use t
+0001c990: 6865 2074 7261 6365 0a23 2073 796d 626f  he trace.# symbo
+0001c9a0: 6c73 206f 7264 6572 2028 7468 6174 2073  ls order (that s
+0001c9b0: 686f 756c 6420 6265 2064 6574 6572 6d69  hould be determi
+0001c9c0: 6e69 7374 6963 2920 746f 2072 6574 7269  nistic) to retri
+0001c9d0: 6576 6520 7468 6520 7265 7369 6475 616c  eve the residual
+0001c9e0: 7320 6e65 6564 6564 0a23 2066 6f72 2074  s needed.# for t
+0001c9f0: 6865 2062 6163 6b77 6172 6420 7061 7373  he backward pass
+0001ca00: 2e0a 6465 6620 6261 636b 7761 7264 5f70  ..def backward_p
+0001ca10: 6173 7328 666f 7277 6172 645f 656e 762c  ass(forward_env,
+0001ca20: 2074 7261 6365 2c20 696e 6974 5f63 6f74   trace, init_cot
+0001ca30: 616e 6765 6e74 7329 3a0a 2020 2020 2222  angents):.    ""
+0001ca40: 2242 6163 6b77 6172 6420 7061 7373 2066  "Backward pass f
+0001ca50: 6f72 2074 6865 2056 4a50 2074 7261 6e73  or the VJP trans
+0001ca60: 666f 726d 2e0a 0a20 2020 2054 6865 2062  form...    The b
+0001ca70: 6163 6b77 6172 6420 7061 7373 2069 7320  ackward pass is 
+0001ca80: 6120 7265 7665 7273 6520 6d6f 6465 2061  a reverse mode a
+0001ca90: 7574 6f6d 6174 6963 2064 6966 6665 7265  utomatic differe
+0001caa0: 6e74 6961 7469 6f6e 2070 6173 7320 7468  ntiation pass th
+0001cab0: 6174 0a20 2020 2063 6f6d 7075 7465 7320  at.    computes 
+0001cac0: 7468 6520 7665 6374 6f72 2d4a 6163 6f62  the vector-Jacob
+0001cad0: 6961 6e20 7072 6f64 7563 7420 2856 4a50  ian product (VJP
+0001cae0: 2920 6f66 2074 6865 2066 756e 6374 696f  ) of the functio
+0001caf0: 6e2e 0a0a 2020 2020 4172 6773 3a0a 2020  n...    Args:.  
+0001cb00: 2020 2020 2020 666f 7277 6172 645f 656e        forward_en
+0001cb10: 7620 2844 6963 745b 7374 722c 2041 6e79  v (Dict[str, Any
+0001cb20: 5d29 3a20 456e 7669 726f 6e6d 656e 7420  ]): Environment 
+0001cb30: 6f66 2074 6865 2066 6f72 7761 7264 2070  of the forward p
+0001cb40: 6173 732e 0a20 2020 2020 2020 2074 7261  ass..        tra
+0001cb50: 6365 2028 5472 6163 6529 3a20 5472 6163  ce (Trace): Trac
+0001cb60: 6520 6f66 2074 6865 2066 756e 6374 696f  e of the functio
+0001cb70: 6e2e 0a20 2020 2020 2020 2069 6e69 745f  n..        init_
+0001cb80: 636f 7461 6e67 656e 7473 2028 5475 706c  cotangents (Tupl
+0001cb90: 655b 5661 7269 6162 6c65 5d29 3a20 496e  e[Variable]): In
+0001cba0: 6974 6961 6c20 636f 7461 6e67 656e 7473  itial cotangents
+0001cbb0: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+0001cbc0: 2020 2020 2020 2020 5475 706c 655b 5072          Tuple[Pr
+0001cbd0: 6f78 792c 202e 2e2e 5d3a 2054 7570 6c65  oxy, ...]: Tuple
+0001cbe0: 206f 6620 7468 6520 7265 7375 6c74 7320   of the results 
+0001cbf0: 6f66 2074 6865 2062 6163 6b77 6172 6420  of the backward 
+0001cc00: 7061 7373 2066 6f72 2065 6163 6820 696e  pass for each in
+0001cc10: 7075 742e 0a20 2020 2022 2222 0a20 2020  put..    """.   
+0001cc20: 2065 6e76 203d 207b 7d0a 0a20 2020 2064   env = {}..    d
+0001cc30: 6566 2067 6574 5f67 7261 6428 783a 2056  ef get_grad(x: V
+0001cc40: 6172 6961 626c 6529 3a0a 2020 2020 2020  ariable):.      
+0001cc50: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0001cc60: 782c 2056 6172 6961 626c 6529 3a0a 2020  x, Variable):.  
+0001cc70: 2020 2020 2020 2020 2020 2320 5265 7475            # Retu
+0001cc80: 726e 204e 6f6e 6520 6966 2074 6865 2076  rn None if the v
+0001cc90: 6172 6961 626c 6520 7761 7320 6e6f 7420  ariable was not 
+0001cca0: 7573 6564 2069 6e20 7468 6520 636f 6d70  used in the comp
+0001ccb0: 7574 6174 696f 6e20 616e 640a 2020 2020  utation and.    
+0001ccc0: 2020 2020 2020 2020 2320 6865 6e63 6520          # hence 
+0001ccd0: 6e6f 7420 696e 2074 6865 2065 6e76 0a20  not in the env. 
+0001cce0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001ccf0: 6e20 656e 762e 6765 7428 782e 6e61 6d65  n env.get(x.name
+0001cd00: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
+0001cd10: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001cd20: 2020 7265 7475 726e 2078 0a0a 2020 2020    return x..    
+0001cd30: 6465 6620 7075 745f 6772 6164 2876 3a20  def put_grad(v: 
+0001cd40: 5661 7269 6162 6c65 2c20 7661 6c3a 2041  Variable, val: A
+0001cd50: 6e79 2920 2d3e 204e 6f6e 653a 0a20 2020  ny) -> None:.   
+0001cd60: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0001cd70: 6365 2876 2c20 5661 7269 6162 6c65 293a  ce(v, Variable):
+0001cd80: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001cd90: 762e 6e61 6d65 2069 6e20 656e 763a 0a20  v.name in env:. 
+0001cda0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001cdb0: 6620 7661 6c20 6973 204e 6f6e 653a 0a20  f val is None:. 
+0001cdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cdd0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+0001cde0: 2020 2020 2020 2020 2020 2320 4163 6375            # Accu
+0001cdf0: 6d75 6c61 7465 2063 6f74 616e 6765 6e74  mulate cotangent
+0001ce00: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0001ce10: 2020 656e 765b 762e 6e61 6d65 5d20 3d20    env[v.name] = 
+0001ce20: 636c 616e 672e 6164 6428 656e 765b 762e  clang.add(env[v.
+0001ce30: 6e61 6d65 5d2c 2076 616c 2920 6966 2065  name], val) if e
+0001ce40: 6e76 5b76 2e6e 616d 655d 2069 7320 6e6f  nv[v.name] is no
+0001ce50: 7420 4e6f 6e65 2065 6c73 6520 7661 6c0a  t None else val.
+0001ce60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce70: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
+0001ce80: 2020 2065 6e76 5b76 2e6e 616d 655d 203d     env[v.name] =
+0001ce90: 2076 616c 0a20 2020 2020 2020 2065 6c69   val.        eli
+0001cea0: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
+0001ceb0: 5365 7175 656e 6365 2920 616e 6420 616c  Sequence) and al
+0001cec0: 6c28 6973 696e 7374 616e 6365 2878 2c20  l(isinstance(x, 
+0001ced0: 696e 7429 2066 6f72 2078 2069 6e20 7629  int) for x in v)
+0001cee0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0001cef0: 544f 444f 3a20 7265 6d6f 7665 2077 6865  TODO: remove whe
+0001cf00: 6e20 7765 206d 6f76 6520 6469 6d73 2074  n we move dims t
+0001cf10: 6f20 6b77 6172 6773 0a20 2020 2020 2020  o kwargs.       
+0001cf20: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
+0001cf30: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+0001cf40: 6528 762c 2073 7472 293a 0a20 2020 2020  e(v, str):.     
+0001cf50: 2020 2020 2020 2065 6e76 5b76 5d20 3d20         env[v] = 
+0001cf60: 7661 6c0a 2020 2020 2020 2020 656c 6966  val.        elif
+0001cf70: 2069 7369 6e73 7461 6e63 6528 762c 2053   isinstance(v, S
+0001cf80: 6571 7565 6e63 6529 2061 6e64 2076 616c  equence) and val
+0001cf90: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0001cfa0: 2020 2020 2020 2320 6272 6f61 6463 6173        # broadcas
+0001cfb0: 7420 4e6f 6e65 2074 6f20 7468 6520 7269  t None to the ri
+0001cfc0: 6768 7420 7368 6170 650a 2020 2020 2020  ght shape.      
+0001cfd0: 2020 2020 2020 7361 6665 5f6d 6170 2870        safe_map(p
+0001cfe0: 7574 5f67 7261 642c 2076 2c20 5b4e 6f6e  ut_grad, v, [Non
+0001cff0: 655d 202a 206c 656e 2876 2929 0a20 2020  e] * len(v)).   
+0001d000: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
+0001d010: 616e 6365 2876 2c20 5365 7175 656e 6365  ance(v, Sequence
+0001d020: 2920 616e 6420 6973 696e 7374 616e 6365  ) and isinstance
+0001d030: 2876 616c 2c20 5365 7175 656e 6365 293a  (val, Sequence):
+0001d040: 0a20 2020 2020 2020 2020 2020 2073 6166  .            saf
+0001d050: 655f 6d61 705f 666c 6174 2870 7574 5f67  e_map_flat(put_g
+0001d060: 7261 642c 2076 2c20 7661 6c29 0a20 2020  rad, v, val).   
+0001d070: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001d080: 2020 2020 2020 2023 2053 6b69 7020 7772         # Skip wr
+0001d090: 6974 696e 6720 746f 2063 6f6e 7374 616e  iting to constan
+0001d0a0: 7473 0a20 2020 2020 2020 2020 2020 2070  ts.            p
+0001d0b0: 6173 730a 0a20 2020 2069 6620 6973 696e  ass..    if isin
+0001d0c0: 7374 616e 6365 2869 6e69 745f 636f 7461  stance(init_cota
+0001d0d0: 6e67 656e 7473 2c20 5365 7175 656e 6365  ngents, Sequence
+0001d0e0: 2920 616e 6420 6c65 6e28 696e 6974 5f63  ) and len(init_c
+0001d0f0: 6f74 616e 6765 6e74 7329 203d 3d20 3120  otangents) == 1 
+0001d100: 616e 6420 6e6f 7420 6973 696e 7374 616e  and not isinstan
+0001d110: 6365 2874 7261 6365 2e6f 7574 7075 742c  ce(trace.output,
+0001d120: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
+0001d130: 2020 2020 696e 6974 5f63 6f74 616e 6765      init_cotange
+0001d140: 6e74 7320 3d20 696e 6974 5f63 6f74 616e  nts = init_cotan
+0001d150: 6765 6e74 735b 305d 0a20 2020 2073 6166  gents[0].    saf
+0001d160: 655f 6d61 705f 666c 6174 2870 7574 5f67  e_map_flat(put_g
+0001d170: 7261 642c 2074 7261 6365 2e6f 7574 7075  rad, trace.outpu
+0001d180: 742c 2069 6e69 745f 636f 7461 6e67 656e  t, init_cotangen
+0001d190: 7473 290a 0a20 2020 2066 6f72 2073 796d  ts)..    for sym
+0001d1a0: 626f 6c20 696e 2072 6576 6572 7365 6428  bol in reversed(
+0001d1b0: 6c69 7374 2869 7465 725f 626f 756e 645f  list(iter_bound_
+0001d1c0: 7379 6d62 6f6c 7328 7472 6163 652e 626f  symbols(trace.bo
+0001d1d0: 756e 645f 7379 6d62 6f6c 7329 2929 3a0a  und_symbols))):.
+0001d1e0: 2020 2020 2020 2020 7379 6d62 6f6c 5f6f          symbol_o
+0001d1f0: 7574 7075 7420 3d20 7365 7175 656e 6369  utput = sequenci
+0001d200: 6679 2873 796d 626f 6c2e 6f75 7470 7574  fy(symbol.output
+0001d210: 290a 0a20 2020 2020 2020 2063 6f74 616e  )..        cotan
+0001d220: 6765 6e74 7320 3d20 7472 6565 5f6d 6170  gents = tree_map
+0001d230: 2867 6574 5f67 7261 642c 2073 796d 626f  (get_grad, symbo
+0001d240: 6c5f 6f75 7470 7574 290a 2020 2020 2020  l_output).      
+0001d250: 2020 2320 4861 7669 6e67 2061 2073 696e    # Having a sin
+0001d260: 676c 6520 636f 7461 6e67 656e 7420 6973  gle cotangent is
+0001d270: 2061 2063 6f6d 6d6f 6e20 6361 7365 2c20   a common case, 
+0001d280: 736f 2077 6520 666c 6174 7465 6e20 6974  so we flatten it
+0001d290: 0a20 2020 2020 2020 2023 204f 7468 6572  .        # Other
+0001d2a0: 7769 7365 2c20 7765 2077 696c 6c20 6e65  wise, we will ne
+0001d2b0: 6564 2074 6f20 7265 7772 6974 6520 7468  ed to rewrite th
+0001d2c0: 6520 7075 6c6c 6261 636b 2066 756e 6374  e pullback funct
+0001d2d0: 696f 6e73 0a20 2020 2020 2020 2063 6f74  ions.        cot
+0001d2e0: 616e 6765 6e74 7320 3d20 7472 6565 5f66  angents = tree_f
+0001d2f0: 6c61 7474 656e 2863 6f74 616e 6765 6e74  latten(cotangent
+0001d300: 7329 5b30 5d0a 2020 2020 2020 2020 7265  s)[0].        re
+0001d310: 7369 6475 616c 7320 3d20 666f 7277 6172  siduals = forwar
+0001d320: 645f 656e 765b 7379 6d62 6f6c 5f6f 7574  d_env[symbol_out
+0001d330: 7075 745b 305d 2e6e 616d 655d 2e72 6573  put[0].name].res
+0001d340: 6964 7561 6c73 0a20 2020 2020 2020 2069  iduals.        i
+0001d350: 6620 6973 5f63 6f6e 7374 616e 745f 666f  f is_constant_fo
+0001d360: 725f 766a 7028 7379 6d62 6f6c 293a 0a20  r_vjp(symbol):. 
+0001d370: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
+0001d380: 6361 6e20 736b 6970 2074 6865 2070 756c  can skip the pul
+0001d390: 6c62 6163 6b20 6966 2061 6c6c 2074 6865  lback if all the
+0001d3a0: 2061 7267 756d 656e 7473 2061 7265 2063   arguments are c
+0001d3b0: 6f6e 7374 616e 740a 2020 2020 2020 2020  onstant.        
+0001d3c0: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+0001d3d0: 2020 2020 2020 6966 2061 6c6c 2863 6f74        if all(cot
+0001d3e0: 616e 6765 6e74 2069 7320 4e6f 6e65 2066  angent is None f
+0001d3f0: 6f72 2063 6f74 616e 6765 6e74 2069 6e20  or cotangent in 
+0001d400: 636f 7461 6e67 656e 7473 293a 0a20 2020  cotangents):.   
+0001d410: 2020 2020 2020 2020 2023 2057 6520 6361           # We ca
+0001d420: 6e20 736b 6970 2074 6865 2070 756c 6c62  n skip the pullb
+0001d430: 6163 6b20 6966 2074 6865 2063 6f74 616e  ack if the cotan
+0001d440: 6765 6e74 2069 7320 4e6f 6e65 0a20 2020  gent is None.   
+0001d450: 2020 2020 2020 2020 2073 6166 655f 6d61           safe_ma
+0001d460: 7028 7075 745f 6772 6164 2c20 7379 6d62  p(put_grad, symb
+0001d470: 6f6c 2e61 7267 732c 2028 4e6f 6e65 2c29  ol.args, (None,)
+0001d480: 202a 206c 656e 2873 796d 626f 6c2e 6172   * len(symbol.ar
+0001d490: 6773 2929 0a20 2020 2020 2020 2020 2020  gs)).           
+0001d4a0: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+0001d4b0: 2020 2069 6620 7379 6d62 6f6c 2e73 796d     if symbol.sym
+0001d4c0: 2e69 6420 3d3d 2022 746f 7263 682e 6e6e  .id == "torch.nn
+0001d4d0: 2e66 756e 6374 696f 6e61 6c2e 6472 6f70  .functional.drop
+0001d4e0: 6f75 7422 2061 6e64 206e 6f74 2073 796d  out" and not sym
+0001d4f0: 626f 6c2e 7375 6273 796d 626f 6c73 3a0a  bol.subsymbols:.
+0001d500: 2020 2020 2020 2020 2020 2020 2320 5765              # We
+0001d510: 2063 616e 2073 6b69 7020 7468 6520 7075   can skip the pu
+0001d520: 6c6c 6261 636b 2069 6620 7468 6520 6472  llback if the dr
+0001d530: 6f70 6f75 7420 7072 6f62 6162 696c 6974  opout probabilit
+0001d540: 7920 6973 2030 2e30 0a20 2020 2020 2020  y is 0.0.       
+0001d550: 2020 2020 2023 2041 7373 756d 696e 6720       # Assuming 
+0001d560: 7468 6174 2074 6865 2064 726f 706f 7574  that the dropout
+0001d570: 2073 796d 626f 6c20 6861 7320 7468 6520   symbol has the 
+0001d580: 7361 6d65 206f 7574 7075 7420 616e 6420  same output and 
+0001d590: 6172 6775 6d65 6e74 0a20 2020 2020 2020  argument.       
+0001d5a0: 2020 2020 2061 7373 6572 7420 7379 6d62       assert symb
+0001d5b0: 6f6c 2e6f 7574 7075 742e 6e61 6d65 203d  ol.output.name =
+0001d5c0: 3d20 7379 6d62 6f6c 2e61 7267 735b 305d  = symbol.args[0]
+0001d5d0: 2e6e 616d 652c 2022 4472 6f70 6f75 7420  .name, "Dropout 
+0001d5e0: 7379 6d62 6f6c 2068 6173 2061 2064 6966  symbol has a dif
+0001d5f0: 6665 7265 6e74 206f 7574 7075 7420 616e  ferent output an
+0001d600: 6420 6172 6775 6d65 6e74 220a 2020 2020  d argument".    
+0001d610: 2020 2020 2020 2020 6966 2073 796d 626f          if symbo
+0001d620: 6c2e 6172 6773 5b31 5d20 3d3d 2030 2e30  l.args[1] == 0.0
+0001d630: 206f 7220 7379 6d62 6f6c 2e61 7267 735b   or symbol.args[
+0001d640: 325d 2069 7320 4661 6c73 653a 0a20 2020  2] is False:.   
+0001d650: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0001d660: 7469 6e75 650a 0a20 2020 2020 2020 2062  tinue..        b
+0001d670: 6163 6b77 6172 6420 3d20 6261 636b 7761  ackward = backwa
+0001d680: 7264 5f69 6d70 6c73 2e67 6574 2873 796d  rd_impls.get(sym
+0001d690: 626f 6c2e 7379 6d2e 6964 290a 2020 2020  bol.sym.id).    
+0001d6a0: 2020 2020 6175 675f 666f 7277 6172 6420      aug_forward 
+0001d6b0: 3d20 6175 676d 656e 7465 645f 666f 7277  = augmented_forw
+0001d6c0: 6172 645f 696d 706c 732e 6765 7428 7379  ard_impls.get(sy
+0001d6d0: 6d62 6f6c 2e73 796d 2e69 6429 0a0a 2020  mbol.sym.id)..  
+0001d6e0: 2020 2020 2020 6966 205f 6765 745f 6772        if _get_gr
+0001d6f0: 6164 666e 2873 796d 626f 6c29 2069 7320  adfn(symbol) is 
+0001d700: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0001d710: 2020 2020 2020 6175 675f 666f 7277 6172        aug_forwar
+0001d720: 642c 2062 6163 6b77 6172 6420 3d20 6d61  d, backward = ma
+0001d730: 6b65 5f61 7567 5f66 6f72 7761 7264 5f61  ke_aug_forward_a
+0001d740: 6e64 5f62 6163 6b77 6172 6428 7379 6d62  nd_backward(symb
+0001d750: 6f6c 290a 0a20 2020 2020 2020 2069 6620  ol)..        if 
+0001d760: 6261 636b 7761 7264 2069 7320 4e6f 6e65  backward is None
+0001d770: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0001d780: 206c 656e 2873 796d 626f 6c2e 7375 6273   len(symbol.subs
+0001d790: 796d 626f 6c73 2920 3e20 3020 616e 6420  ymbols) > 0 and 
+0001d7a0: 6e6f 7420 6973 696e 7374 616e 6365 2873  not isinstance(s
+0001d7b0: 796d 626f 6c2e 7379 6d2e 6964 2c20 7072  ymbol.sym.id, pr
+0001d7c0: 696d 732e 5072 696d 4944 7329 3a0a 2020  ims.PrimIDs):.  
+0001d7d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0001d7e0: 5765 2063 6f75 6c64 206e 6f74 2066 696e  We could not fin
+0001d7f0: 6420 6120 6261 636b 7761 7264 2066 6f72  d a backward for
+0001d800: 2074 6869 7320 7379 6d62 6f6c 2c20 736f   this symbol, so
+0001d810: 2077 6520 7472 7920 746f 2064 6563 6f6d   we try to decom
+0001d820: 706f 7365 2069 740a 2020 2020 2020 2020  pose it.        
+0001d830: 2020 2020 2020 2020 6261 636b 7761 7264          backward
+0001d840: 203d 2070 6172 7469 616c 2864 6563 6f6d   = partial(decom
+0001d850: 706f 7365 645f 666e 5f62 6163 6b77 6172  posed_fn_backwar
+0001d860: 645f 7275 6c65 2c20 7379 6d62 6f6c 2e73  d_rule, symbol.s
+0001d870: 796d 290a 2020 2020 2020 2020 2020 2020  ym).            
+0001d880: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001d890: 2020 2020 2020 2320 5765 2063 6f75 6c64        # We could
+0001d8a0: 206e 6f74 2066 696e 6420 6120 6261 636b   not find a back
+0001d8b0: 7761 7264 2066 6f72 2074 6869 7320 7379  ward for this sy
+0001d8c0: 6d62 6f6c 2061 6e64 2077 6520 636f 756c  mbol and we coul
+0001d8d0: 6420 6e6f 7420 6465 636f 6d70 6f73 6520  d not decompose 
+0001d8e0: 6974 0a20 2020 2020 2020 2020 2020 2020  it.             
+0001d8f0: 2020 2072 6169 7365 204e 6f74 496d 706c     raise NotImpl
+0001d900: 656d 656e 7465 6445 7272 6f72 2866 2242  ementedError(f"B
+0001d910: 6163 6b77 6172 6420 666f 7220 7b73 796d  ackward for {sym
+0001d920: 626f 6c2e 7379 6d2e 6964 7d20 6973 206e  bol.sym.id} is n
+0001d930: 6f74 2069 6d70 6c65 6d65 6e74 6564 2229  ot implemented")
+0001d940: 0a0a 2020 2020 2020 2020 7265 7375 6c74  ..        result
+0001d950: 203d 2062 6163 6b77 6172 6428 2a72 6573   = backward(*res
+0001d960: 6964 7561 6c73 2c20 2a63 6f74 616e 6765  iduals, *cotange
+0001d970: 6e74 7329 0a20 2020 2020 2020 2069 6620  nts).        if 
+0001d980: 6973 696e 7374 616e 6365 2872 6573 756c  isinstance(resul
+0001d990: 742c 2064 6963 7429 3a0a 2020 2020 2020  t, dict):.      
+0001d9a0: 2020 2020 2020 2320 4966 2074 6865 2062        # If the b
+0001d9b0: 6163 6b77 6172 6420 7265 7475 726e 7320  ackward returns 
+0001d9c0: 6120 6469 6374 2c20 7765 2061 7373 756d  a dict, we assum
+0001d9d0: 6520 7468 6174 2069 7420 6973 2061 2064  e that it is a d
+0001d9e0: 6963 7420 6f66 0a20 2020 2020 2020 2020  ict of.         
+0001d9f0: 2020 2023 2066 6f72 7761 7264 2061 7267     # forward arg
+0001da00: 756d 656e 7473 2074 6f20 7468 6520 636f  uments to the co
+0001da10: 7272 6573 706f 6e64 696e 670a 2020 2020  rresponding.    
+0001da20: 2020 2020 2020 2020 2320 6772 6164 6965          # gradie
+0001da30: 6e74 732f 636f 7461 6e67 656e 7473 2f61  nts/cotangents/a
+0001da40: 646a 6f69 6e74 732f 7365 6e73 6974 6976  djoints/sensitiv
+0001da50: 6974 6965 732e 0a20 2020 2020 2020 2020  ities..         
+0001da60: 2020 2075 7365 645f 6e61 6d65 7320 3d20     used_names = 
+0001da70: 7365 7428 290a 2020 2020 2020 2020 2020  set().          
+0001da80: 2020 666f 7220 692c 2028 6b2c 2076 2920    for i, (k, v) 
+0001da90: 696e 2065 6e75 6d65 7261 7465 2869 6e73  in enumerate(ins
+0001daa0: 7065 6374 2e73 6967 6e61 7475 7265 2861  pect.signature(a
+0001dab0: 7567 5f66 6f72 7761 7264 292e 7061 7261  ug_forward).para
+0001dac0: 6d65 7465 7273 2e69 7465 6d73 2829 293a  meters.items()):
+0001dad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dae0: 2069 6620 762e 6b69 6e64 2069 6e20 2869   if v.kind in (i
+0001daf0: 6e73 7065 6374 2e50 6172 616d 6574 6572  nspect.Parameter
+0001db00: 2e50 4f53 4954 494f 4e41 4c5f 4f4e 4c59  .POSITIONAL_ONLY
+0001db10: 2c20 696e 7370 6563 742e 5061 7261 6d65  , inspect.Parame
+0001db20: 7465 722e 504f 5349 5449 4f4e 414c 5f4f  ter.POSITIONAL_O
+0001db30: 525f 4b45 5957 4f52 4429 3a0a 2020 2020  R_KEYWORD):.    
+0001db40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001db50: 7075 745f 6772 6164 2873 796d 626f 6c2e  put_grad(symbol.
+0001db60: 6172 6773 5b69 5d2c 2072 6573 756c 742e  args[i], result.
+0001db70: 6765 7428 6b2c 204e 6f6e 6529 290a 2020  get(k, None)).  
+0001db80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001db90: 2020 7573 6564 5f6e 616d 6573 2e61 6464    used_names.add
+0001dba0: 286b 290a 0a20 2020 2020 2020 2020 2020  (k)..           
+0001dbb0: 2023 2046 6f72 2064 6576 656c 6f70 6572   # For developer
+0001dbc0: 2063 6f6e 7665 6e69 656e 6365 2c20 7765   convenience, we
+0001dbd0: 2061 6c6c 6f77 2075 7369 6e67 2074 6865   allow using the
+0001dbe0: 206e 616d 6520 6672 6f6d 2074 6865 0a20   name from the. 
+0001dbf0: 2020 2020 2020 2020 2020 2023 2066 6f72             # for
+0001dc00: 7761 7264 206d 6574 6120 696e 2061 6464  ward meta in add
+0001dc10: 6974 696f 6e20 746f 2074 6865 206e 616d  ition to the nam
+0001dc20: 6520 6672 6f6d 2074 6865 2061 7567 6d65  e from the augme
+0001dc30: 6e74 6564 2066 6f72 7761 7264 0a20 2020  nted forward.   
+0001dc40: 2020 2020 2020 2020 2023 2073 6967 6e61           # signa
+0001dc50: 7475 7265 2e0a 2020 2020 2020 2020 2020  ture..          
+0001dc60: 2020 2320 4966 2062 6f74 6820 6e61 6d65    # If both name
+0001dc70: 7320 6172 6520 7573 6564 2c20 7468 6520  s are used, the 
+0001dc80: 6f6e 6520 6672 6f6d 2074 6865 2066 6f72  one from the for
+0001dc90: 7761 7264 206d 6574 6120 7461 6b65 730a  ward meta takes.
+0001dca0: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
+0001dcb0: 6563 6564 656e 6365 2e0a 2020 2020 2020  ecedence..      
+0001dcc0: 2020 2020 2020 666f 7220 692c 2028 6b2c        for i, (k,
+0001dcd0: 2076 2920 696e 2065 6e75 6d65 7261 7465   v) in enumerate
+0001dce0: 2869 6e73 7065 6374 2e73 6967 6e61 7475  (inspect.signatu
+0001dcf0: 7265 2873 796d 626f 6c2e 7379 6d2e 6d65  re(symbol.sym.me
+0001dd00: 7461 292e 7061 7261 6d65 7465 7273 2e69  ta).parameters.i
+0001dd10: 7465 6d73 2829 293a 0a20 2020 2020 2020  tems()):.       
+0001dd20: 2020 2020 2020 2020 2069 6620 762e 6b69           if v.ki
+0001dd30: 6e64 2069 6e20 2869 6e73 7065 6374 2e50  nd in (inspect.P
+0001dd40: 6172 616d 6574 6572 2e50 4f53 4954 494f  arameter.POSITIO
+0001dd50: 4e41 4c5f 4f4e 4c59 2c20 696e 7370 6563  NAL_ONLY, inspec
+0001dd60: 742e 5061 7261 6d65 7465 722e 504f 5349  t.Parameter.POSI
+0001dd70: 5449 4f4e 414c 5f4f 525f 4b45 5957 4f52  TIONAL_OR_KEYWOR
+0001dd80: 4429 3a0a 2020 2020 2020 2020 2020 2020  D):.            
+0001dd90: 2020 2020 2020 2020 6966 206b 206e 6f74          if k not
+0001dda0: 2069 6e20 7573 6564 5f6e 616d 6573 3a0a   in used_names:.
+0001ddb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ddc0: 2020 2020 2020 2020 7075 745f 6772 6164          put_grad
+0001ddd0: 2873 796d 626f 6c2e 6172 6773 5b69 5d2c  (symbol.args[i],
+0001dde0: 2072 6573 756c 742e 6765 7428 6b2c 204e   result.get(k, N
+0001ddf0: 6f6e 6529 290a 2020 2020 2020 2020 2020  one)).          
+0001de00: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
+0001de10: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
+0001de20: 7461 6e63 6528 7265 7375 6c74 2c20 5365  tance(result, Se
+0001de30: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
+0001de40: 2020 2020 2072 6573 756c 7420 3d20 2872       result = (r
+0001de50: 6573 756c 742c 290a 0a20 2020 2020 2020  esult,)..       
+0001de60: 2064 6566 2069 735f 6469 6666 6572 656e   def is_differen
+0001de70: 7469 6162 6c65 2861 7267 293a 0a20 2020  tiable(arg):.   
+0001de80: 2020 2020 2020 2020 206d 6174 6368 2061           match a
+0001de90: 7267 3a0a 2020 2020 2020 2020 2020 2020  rg:.            
+0001dea0: 2020 2020 6361 7365 2054 656e 736f 7250      case TensorP
+0001deb0: 726f 7879 2829 3a0a 2020 2020 2020 2020  roxy():.        
+0001dec0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001ded0: 726e 2064 7479 7065 732e 6973 5f69 6e65  rn dtypes.is_ine
+0001dee0: 7861 6374 5f64 7479 7065 2861 7267 2e64  xact_dtype(arg.d
+0001def0: 7479 7065 290a 2020 2020 2020 2020 2020  type).          
+0001df00: 2020 2020 2020 6361 7365 2053 6571 7565        case Seque
+0001df10: 6e63 6528 293a 0a20 2020 2020 2020 2020  nce():.         
+0001df20: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001df30: 6e20 6172 6720 616e 6420 616c 6c28 6973  n arg and all(is
+0001df40: 696e 7374 616e 6365 2878 2c20 5465 6e73  instance(x, Tens
+0001df50: 6f72 5072 6f78 7929 2061 6e64 2064 7479  orProxy) and dty
+0001df60: 7065 732e 6973 5f69 6e65 7861 6374 5f64  pes.is_inexact_d
+0001df70: 7479 7065 2878 2e64 7479 7065 2920 666f  type(x.dtype) fo
+0001df80: 7220 7820 696e 2061 7267 290a 2020 2020  r x in arg).    
+0001df90: 2020 2020 2020 2020 2020 2020 6361 7365              case
+0001dfa0: 205f 3a0a 2020 2020 2020 2020 2020 2020   _:.            
+0001dfb0: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+0001dfc0: 616c 7365 0a0a 2020 2020 2020 2020 6966  alse..        if
+0001dfd0: 206c 656e 2873 796d 626f 6c2e 6172 6773   len(symbol.args
+0001dfe0: 2920 213d 2028 6f72 6967 5f72 6573 5f6c  ) != (orig_res_l
+0001dff0: 656e 203a 3d20 6c65 6e28 7265 7375 6c74  en := len(result
+0001e000: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+0001e010: 6368 6563 6b28 0a20 2020 2020 2020 2020  check(.         
+0001e020: 2020 2020 2020 206f 7269 675f 7265 735f         orig_res_
+0001e030: 6c65 6e20 3c3d 206c 656e 2873 796d 626f  len <= len(symbo
+0001e040: 6c2e 6172 6773 292c 0a20 2020 2020 2020  l.args),.       
+0001e050: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
+0001e060: 2066 2242 6163 6b77 6172 6420 666f 7220   f"Backward for 
+0001e070: 7b73 796d 626f 6c2e 7379 6d2e 6964 7d20  {symbol.sym.id} 
+0001e080: 7265 7475 726e 6564 207b 6f72 6967 5f72  returned {orig_r
+0001e090: 6573 5f6c 656e 7d20 7661 6c75 6573 2c20  es_len} values, 
+0001e0a0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0001e0b0: 2020 2b20 6622 6275 7420 6578 7065 6374    + f"but expect
+0001e0c0: 6564 2061 7420 6d6f 7374 207b 6c65 6e28  ed at most {len(
+0001e0d0: 7379 6d62 6f6c 2e61 7267 7329 7d22 2c0a  symbol.args)}",.
+0001e0e0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0001e0f0: 2020 2020 2020 2020 2020 2320 4173 7375            # Assu
+0001e100: 6d69 6e67 2074 6861 7420 7468 6520 6e6f  ming that the no
+0001e110: 6e2d 6469 6666 6572 656e 7469 6162 6c65  n-differentiable
+0001e120: 2061 7267 756d 656e 7473 2077 6572 6520   arguments were 
+0001e130: 6472 6f70 7065 6420 6672 6f6d 0a20 2020  dropped from.   
+0001e140: 2020 2020 2020 2020 2023 2074 6865 2062           # the b
+0001e150: 6163 6b77 6172 6420 6675 6e63 7469 6f6e  ackward function
+0001e160: 2c20 7765 2061 7265 2067 6f69 6e67 2074  , we are going t
+0001e170: 6f20 6170 7065 6e64 204e 6f6e 6520 746f  o append None to
+0001e180: 2074 6865 2072 6573 756c 740a 2020 2020   the result.    
+0001e190: 2020 2020 2020 2020 2320 746f 206d 6174          # to mat
+0001e1a0: 6368 2074 6865 206e 756d 6265 7220 6f66  ch the number of
+0001e1b0: 2061 7267 756d 656e 7473 2e20 416c 7465   arguments. Alte
+0001e1c0: 726e 6174 6976 656c 792c 2077 6520 636f  rnatively, we co
+0001e1d0: 756c 6420 6a75 7374 0a20 2020 2020 2020  uld just.       
+0001e1e0: 2020 2020 2023 2068 6176 6520 6120 666f       # have a fo
+0001e1f0: 722d 6c6f 6f70 2077 6974 6820 6120 636f  r-loop with a co
+0001e200: 6e64 6974 696f 6e61 6c20 7768 656e 2077  nditional when w
+0001e210: 7269 7469 6e67 2074 6f20 7468 650a 2020  riting to the.  
+0001e220: 2020 2020 2020 2020 2020 2320 656e 7669            # envi
+0001e230: 726f 6e6d 656e 742e 0a0a 2020 2020 2020  ronment...      
+0001e240: 2020 2020 2020 6974 6572 5f72 6573 756c        iter_resul
+0001e250: 7420 3d20 6974 6572 2872 6573 756c 7429  t = iter(result)
+0001e260: 0a20 2020 2020 2020 2020 2020 206e 5f64  .            n_d
+0001e270: 6966 6665 7265 6e74 6961 626c 655f 6172  ifferentiable_ar
+0001e280: 6773 203d 2073 756d 2862 6f6f 6c28 6973  gs = sum(bool(is
+0001e290: 5f64 6966 6665 7265 6e74 6961 626c 6528  _differentiable(
+0001e2a0: 6172 6729 2920 666f 7220 6172 6720 696e  arg)) for arg in
+0001e2b0: 2073 796d 626f 6c2e 6172 6773 290a 2020   symbol.args).  
+0001e2c0: 2020 2020 2020 2020 2020 6368 6563 6b28            check(
+0001e2d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e2e0: 206e 5f64 6966 6665 7265 6e74 6961 626c   n_differentiabl
+0001e2f0: 655f 6172 6773 203c 3d20 6f72 6967 5f72  e_args <= orig_r
+0001e300: 6573 5f6c 656e 2c0a 2020 2020 2020 2020  es_len,.        
+0001e310: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
+0001e320: 6622 4261 636b 7761 7264 2066 6f72 207b  f"Backward for {
+0001e330: 7379 6d62 6f6c 2e73 796d 2e69 647d 2072  symbol.sym.id} r
+0001e340: 6574 7572 6e65 6420 7b6f 7269 675f 7265  eturned {orig_re
+0001e350: 735f 6c65 6e7d 2076 616c 7565 2873 292c  s_len} value(s),
+0001e360: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0001e370: 2020 202b 2066 2262 7574 2065 7870 6563     + f"but expec
+0001e380: 7465 6420 7b6e 5f64 6966 6665 7265 6e74  ted {n_different
+0001e390: 6961 626c 655f 6172 6773 7d22 2c0a 2020  iable_args}",.  
+0001e3a0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0001e3b0: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+0001e3c0: 3d20 7475 706c 6528 6e65 7874 2869 7465  = tuple(next(ite
+0001e3d0: 725f 7265 7375 6c74 2920 6966 2069 735f  r_result) if is_
+0001e3e0: 6469 6666 6572 656e 7469 6162 6c65 2861  differentiable(a
+0001e3f0: 7267 2920 656c 7365 204e 6f6e 6520 666f  rg) else None fo
+0001e400: 7220 6172 6720 696e 2073 796d 626f 6c2e  r arg in symbol.
+0001e410: 6172 6773 290a 0a20 2020 2020 2020 2023  args)..        #
+0001e420: 2053 6565 2022 4261 636b 7761 7264 2069   See "Backward i
+0001e430: 6d70 6c20 666f 7220 6f70 7320 6f66 2074  mpl for ops of t
+0001e440: 6865 2074 7970 6520 5365 7175 656e 6365  he type Sequence
+0001e450: 5b54 656e 736f 7250 726f 7879 5d2c 202e  [TensorProxy], .
+0001e460: 2e2e 202d 3e20 2e2e 2e20 7265 7375 6c74  .. -> ... result
+0001e470: 7320 696e 204e 6f6e 6520 6772 6164 732e  s in None grads.
+0001e480: 220a 2020 2020 2020 2020 2320 5468 6973  ".        # This
+0001e490: 2069 7320 6120 7465 6d70 6f72 6172 7920   is a temporary 
+0001e4a0: 776f 726b 6172 6f75 6e64 2e0a 2020 2020  workaround..    
+0001e4b0: 2020 2020 6966 2073 796d 626f 6c2e 7379      if symbol.sy
+0001e4c0: 6d2e 6964 2069 6e20 2870 7269 6d73 2e50  m.id in (prims.P
+0001e4d0: 7269 6d49 4473 2e43 4154 2c20 2274 6f72  rimIDs.CAT, "tor
+0001e4e0: 6368 2e63 6174 222c 2022 746f 7263 682e  ch.cat", "torch.
+0001e4f0: 7374 6163 6b22 293a 0a20 2020 2020 2020  stack"):.       
+0001e500: 2020 2020 2073 6166 655f 6d61 705f 666c       safe_map_fl
+0001e510: 6174 2870 7574 5f67 7261 642c 2073 796d  at(put_grad, sym
+0001e520: 626f 6c2e 6172 6773 2c20 7265 7375 6c74  bol.args, result
+0001e530: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0001e540: 2020 2020 2020 2020 2020 2020 7361 6665              safe
+0001e550: 5f6d 6170 2870 7574 5f67 7261 642c 2073  _map(put_grad, s
+0001e560: 796d 626f 6c2e 6172 6773 2c20 7265 7375  ymbol.args, resu
+0001e570: 6c74 290a 0a20 2020 2064 6566 2067 6574  lt)..    def get
+0001e580: 5f69 6e65 7861 6374 5f64 7479 7065 5f6f  _inexact_dtype_o
+0001e590: 725f 6e6f 6e65 2878 293a 0a20 2020 2020  r_none(x):.     
+0001e5a0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0001e5b0: 2878 2c20 2854 656e 736f 7250 726f 7879  (x, (TensorProxy
+0001e5c0: 2c20 4675 7475 7265 5465 6e73 6f72 5072  , FutureTensorPr
+0001e5d0: 6f78 7929 2920 616e 6420 6474 7970 6573  oxy)) and dtypes
+0001e5e0: 2e69 735f 696e 6578 6163 745f 6474 7970  .is_inexact_dtyp
+0001e5f0: 6528 782e 6474 7970 6529 3a0a 2020 2020  e(x.dtype):.    
+0001e600: 2020 2020 2020 2020 7265 7475 726e 2078          return x
+0001e610: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0001e620: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001e630: 6e20 4e6f 6e65 0a0a 2020 2020 6761 7267  n None..    garg
+0001e640: 7320 3d20 7472 6565 5f6d 6170 2867 6574  s = tree_map(get
+0001e650: 5f67 7261 642c 2074 7570 6c65 2874 7261  _grad, tuple(tra
+0001e660: 6365 2e61 7267 7329 290a 2020 2020 676b  ce.args)).    gk
+0001e670: 7761 7267 7320 3d20 7472 6565 5f6d 6170  wargs = tree_map
+0001e680: 2867 6574 5f67 7261 642c 2074 7261 6365  (get_grad, trace
+0001e690: 2e6b 7761 7267 7329 0a20 2020 2067 6b77  .kwargs).    gkw
+0001e6a0: 6172 6773 203d 207b 6b3a 2076 2066 6f72  args = {k: v for
+0001e6b0: 206b 2c20 7620 696e 2067 6b77 6172 6773   k, v in gkwargs
+0001e6c0: 2e69 7465 6d73 2829 2069 6620 7620 6973  .items() if v is
+0001e6d0: 206e 6f74 204e 6f6e 657d 0a20 2020 2067   not None}.    g
+0001e6e0: 6172 6773 2c20 676b 7761 7267 7320 3d20  args, gkwargs = 
+0001e6f0: 7472 6565 5f6d 6170 2867 6574 5f69 6e65  tree_map(get_ine
+0001e700: 7861 6374 5f64 7479 7065 5f6f 725f 6e6f  xact_dtype_or_no
+0001e710: 6e65 2c20 2867 6172 6773 2c20 676b 7761  ne, (gargs, gkwa
+0001e720: 7267 7329 290a 2020 2020 7265 7475 726e  rgs)).    return
+0001e730: 2067 6172 6773 202b 2028 676b 7761 7267   gargs + (gkwarg
+0001e740: 732c 2920 6966 206c 656e 2867 6b77 6172  s,) if len(gkwar
+0001e750: 6773 2920 213d 2030 2065 6c73 6520 6761  gs) != 0 else ga
+0001e760: 7267 730a 0a0a 6465 6620 766a 705f 6361  rgs...def vjp_ca
+0001e770: 6c6c 5f6d 6574 6166 756e 6328 6465 7461  ll_metafunc(deta
+0001e780: 6368 6564 3a20 626f 6f6c 2c20 7072 696d  ched: bool, prim
+0001e790: 616c 732c 2063 6f74 616e 6765 6e74 732c  als, cotangents,
+0001e7a0: 2074 7261 6365 3a20 5472 6163 652c 202a   trace: Trace, *
+0001e7b0: 2a6b 7761 7267 7329 3a0a 2020 2020 2320  *kwargs):.    # 
+0001e7c0: 4173 7375 6d69 6e67 2070 7269 6d61 6c73  Assuming primals
+0001e7d0: 2069 7320 666c 6174 0a0a 2020 2020 6966   is flat..    if
+0001e7e0: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+0001e7f0: 7072 696d 616c 732c 2053 6571 7565 6e63  primals, Sequenc
+0001e800: 6529 3a0a 2020 2020 2020 2020 7072 696d  e):.        prim
+0001e810: 616c 7320 3d20 2870 7269 6d61 6c73 2c29  als = (primals,)
+0001e820: 0a0a 2020 2020 6374 7820 3d20 6465 7461  ..    ctx = deta
+0001e830: 6368 6564 5f74 7261 6365 2829 2069 6620  ched_trace() if 
+0001e840: 6465 7461 6368 6564 2065 6c73 6520 6e75  detached else nu
+0001e850: 6c6c 636f 6e74 6578 7428 290a 2020 2020  llcontext().    
+0001e860: 7769 7468 2063 7478 3a0a 2020 2020 2020  with ctx:.      
+0001e870: 2020 7265 7375 6c74 2c20 656e 7620 3d20    result, env = 
+0001e880: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+0001e890: 645f 7061 7373 282a 7072 696d 616c 732c  d_pass(*primals,
+0001e8a0: 2074 7261 6365 3d74 7261 6365 2c20 2a2a   trace=trace, **
+0001e8b0: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
+0001e8c0: 6368 6563 6b28 0a20 2020 2020 2020 2020  check(.         
+0001e8d0: 2020 206c 656e 2872 6573 756c 7429 203d     len(result) =
+0001e8e0: 3d20 6c65 6e28 636f 7461 6e67 656e 7473  = len(cotangents
+0001e8f0: 2920 6966 2069 7369 6e73 7461 6e63 6528  ) if isinstance(
+0001e900: 7265 7375 6c74 2c20 5365 7175 656e 6365  result, Sequence
+0001e910: 2920 656c 7365 2054 7275 652c 0a20 2020  ) else True,.   
+0001e920: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
+0001e930: 2066 2245 7870 6563 7465 6420 636f 7461   f"Expected cota
+0001e940: 6e67 656e 7473 2074 6f20 6265 2061 2073  ngents to be a s
+0001e950: 6571 7565 6e63 6520 6f66 206c 656e 6774  equence of lengt
+0001e960: 6820 7b6c 656e 2872 6573 756c 7429 7d2c  h {len(result)},
+0001e970: 2067 6f74 2061 2073 6571 7565 6e63 6520   got a sequence 
+0001e980: 6f66 206c 656e 6774 6820 7b6c 656e 2863  of length {len(c
+0001e990: 6f74 616e 6765 6e74 7329 7d22 2c0a 2020  otangents)}",.  
+0001e9a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0001e9b0: 7265 7475 726e 2072 6573 756c 742c 2062  return result, b
+0001e9c0: 6163 6b77 6172 645f 7061 7373 2865 6e76  ackward_pass(env
+0001e9d0: 2c20 7472 6163 652c 2063 6f74 616e 6765  , trace, cotange
+0001e9e0: 6e74 7329 0a0a 0a23 2054 4f44 4f3a 2043  nts)...# TODO: C
+0001e9f0: 616e 2774 2075 7365 2061 2053 796d 626f  an't use a Symbo
+0001ea00: 6c20 6865 7265 2062 6563 6175 7365 206d  l here because m
+0001ea10: 6978 6564 2065 7865 6375 746f 7220 7379  ixed executor sy
+0001ea20: 6273 796d 626f 6c73 2073 6565 6d20 746f  bsymbols seem to
+0001ea30: 2062 650a 2320 756e 7375 7070 6f72 7465   be.# unsupporte
+0001ea40: 642e 2053 6565 2069 7373 7565 2022 436f  d. See issue "Co
+0001ea50: 756c 6420 6e6f 7420 6669 6e64 2061 6e20  uld not find an 
+0001ea60: 6578 6563 7574 6f72 2066 6f72 2062 6f75  executor for bou
+0001ea70: 6e64 2073 796d 626f 6c20 7768 656e 2069  nd symbol when i
+0001ea80: 7473 2073 7562 7379 6d62 6f6c 730a 2320  ts subsymbols.# 
+0001ea90: 6172 6520 6e6f 7420 6675 6c6c 7920 7375  are not fully su
+0001eaa0: 7070 6f72 7465 6420 6279 2061 2073 696e  pported by a sin
+0001eab0: 676c 6520 6578 6563 7574 6f72 220a 766a  gle executor".vj
+0001eac0: 705f 6361 6c6c 203d 2070 6172 7469 616c  p_call = partial
+0001ead0: 280a 2020 2020 766a 705f 6361 6c6c 5f6d  (.    vjp_call_m
+0001eae0: 6574 6166 756e 632c 2046 616c 7365 0a29  etafunc, False.)
+0001eaf0: 2020 2320 5379 6d62 6f6c 2869 643d 5472    # Symbol(id=Tr
+0001eb00: 616e 7366 6f72 6d73 2e56 6a70 4f70 2c20  ansforms.VjpOp, 
+0001eb10: 6e61 6d65 3d22 766a 705f 6361 6c6c 222c  name="vjp_call",
+0001eb20: 206d 6574 613d 7061 7274 6961 6c28 766a   meta=partial(vj
+0001eb30: 705f 6361 6c6c 5f6d 6574 6166 756e 632c  p_call_metafunc,
+0001eb40: 2046 616c 7365 2929 0a0a 0a64 6566 2076   False))...def v
+0001eb50: 6a70 2866 756e 6329 3a0a 2020 2020 2222  jp(func):.    ""
+0001eb60: 2243 6f6d 7075 7465 7320 7468 6520 564a  "Computes the VJ
+0001eb70: 5020 6f66 2061 2066 756e 6374 696f 6e2e  P of a function.
+0001eb80: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+0001eb90: 2020 2020 6675 6e63 2028 4361 6c6c 6162      func (Callab
+0001eba0: 6c65 293a 2046 756e 6374 696f 6e20 746f  le): Function to
+0001ebb0: 2062 6520 6469 6666 6572 656e 7469 6174   be differentiat
+0001ebc0: 6564 2e0a 2020 2020 2222 220a 0a20 2020  ed..    """..   
+0001ebd0: 2064 6566 205f 766a 7028 7072 696d 616c   def _vjp(primal
+0001ebe0: 732c 2063 6f74 616e 6765 6e74 732c 202a  s, cotangents, *
+0001ebf0: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+0001ec00: 2020 666c 6174 5f66 756e 632c 2066 6c61    flat_func, fla
+0001ec10: 745f 6172 6773 2c20 7370 6563 203d 2066  t_args, spec = f
+0001ec20: 6c61 7474 656e 5f66 756e 6328 6675 6e63  latten_func(func
+0001ec30: 2c20 7072 696d 616c 732c 206b 7761 7267  , primals, kwarg
+0001ec40: 7329 0a20 2020 2020 2020 2074 7261 6365  s).        trace
+0001ec50: 203d 2063 6f6e 7374 7275 6374 5f74 7261   = construct_tra
+0001ec60: 6365 2829 2866 6c61 745f 6675 6e63 2c20  ce()(flat_func, 
+0001ec70: 2a66 6c61 745f 6172 6773 290a 2020 2020  *flat_args).    
+0001ec80: 2020 2020 7265 7375 6c74 2c20 766a 705f      result, vjp_
+0001ec90: 7265 7375 6c74 203d 2076 6a70 5f63 616c  result = vjp_cal
+0001eca0: 6c28 666c 6174 5f61 7267 732c 2063 6f74  l(flat_args, cot
+0001ecb0: 616e 6765 6e74 732c 2074 7261 6365 3d74  angents, trace=t
+0001ecc0: 7261 6365 290a 2020 2020 2020 2020 6770  race).        gp
+0001ecd0: 7269 6d61 6c73 2c20 676b 7761 7267 7320  rimals, gkwargs 
+0001ece0: 3d20 7472 6565 5f75 6e66 6c61 7474 656e  = tree_unflatten
+0001ecf0: 2876 6a70 5f72 6573 756c 742c 2073 7065  (vjp_result, spe
+0001ed00: 6329 0a20 2020 2020 2020 2067 7261 6473  c).        grads
+0001ed10: 203d 2067 7072 696d 616c 7320 2b20 2867   = gprimals + (g
+0001ed20: 6b77 6172 6773 2c29 2069 6620 6c65 6e28  kwargs,) if len(
+0001ed30: 676b 7761 7267 7329 2021 3d20 3020 656c  gkwargs) != 0 el
+0001ed40: 7365 2067 7072 696d 616c 730a 2020 2020  se gprimals.    
+0001ed50: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0001ed60: 742c 2067 7261 6473 0a0a 2020 2020 7265  t, grads..    re
+0001ed70: 7475 726e 205f 766a 700a 0a0a 6465 6620  turn _vjp...def 
+0001ed80: 7661 6c75 655f 616e 645f 6772 6164 2866  value_and_grad(f
+0001ed90: 756e 6329 3a0a 2020 2020 2222 2243 6f6d  unc):.    """Com
+0001eda0: 7075 7465 7320 7468 6520 7661 6c75 6520  putes the value 
+0001edb0: 616e 6420 6772 6164 6965 6e74 206f 6620  and gradient of 
+0001edc0: 6120 6675 6e63 7469 6f6e 2e0a 0a20 2020  a function...   
+0001edd0: 2054 6869 7320 6973 2061 2063 6f6e 7665   This is a conve
+0001ede0: 6e69 656e 6365 2066 756e 6374 696f 6e20  nience function 
+0001edf0: 7468 6174 2063 6f6d 6269 6e65 7320 7468  that combines th
+0001ee00: 6520 6675 6e63 7469 6f6e 616c 6974 7920  e functionality 
+0001ee10: 6f66 0a20 2020 2060 766a 705f 6361 6c6c  of.    `vjp_call
+0001ee20: 6020 7769 7468 2069 6d70 6c69 6369 7420  ` with implicit 
+0001ee30: 696e 6974 6961 6c69 7a61 7469 6f6e 206f  initialization o
+0001ee40: 6620 7468 6520 636f 7461 6e67 656e 7420  f the cotangent 
+0001ee50: 746f 2031 2e0a 0a20 2020 2041 7267 733a  to 1...    Args:
+0001ee60: 0a20 2020 2020 2020 2066 756e 6320 2843  .        func (C
+0001ee70: 616c 6c61 626c 6529 3a20 4675 6e63 7469  allable): Functi
+0001ee80: 6f6e 2074 6f20 6265 2064 6966 6665 7265  on to be differe
+0001ee90: 6e74 6961 7465 642e 0a20 2020 2022 2222  ntiated..    """
+0001eea0: 0a0a 2020 2020 6465 6620 6f6e 6573 5f6c  ..    def ones_l
+0001eeb0: 696b 6528 7829 3a0a 2020 2020 2020 2020  ike(x):.        
+0001eec0: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
+0001eed0: 2054 656e 736f 7250 726f 7879 293a 0a20   TensorProxy):. 
+0001eee0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001eef0: 6e20 6675 6c6c 5f6c 696b 6528 782c 2066  n full_like(x, f
+0001ef00: 696c 6c5f 7661 6c75 653d 3129 0a20 2020  ill_value=1).   
+0001ef10: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
+0001ef20: 616e 6365 2878 2c20 4e75 6d62 6572 5072  ance(x, NumberPr
+0001ef30: 6f78 7929 3a0a 2020 2020 2020 2020 2020  oxy):.          
+0001ef40: 2020 7265 7475 726e 2074 7970 6528 782e    return type(x.
+0001ef50: 7661 6c75 6529 2831 290a 2020 2020 2020  value)(1).      
+0001ef60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001ef70: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+0001ef80: 7272 6f72 2866 226f 6e65 735f 6c69 6b65  rror(f"ones_like
+0001ef90: 2069 6e73 6964 6520 7661 6c75 655f 616e   inside value_an
+0001efa0: 645f 6772 6164 2067 6f74 2061 6e20 756e  d_grad got an un
+0001efb0: 7375 7070 6f72 7465 6420 7479 7065 207b  supported type {
+0001efc0: 7479 7065 2878 297d 2229 0a0a 2020 2020  type(x)}")..    
+0001efd0: 6465 6620 5f76 616c 7565 5f61 6e64 5f67  def _value_and_g
+0001efe0: 7261 6428 2a61 7267 732c 202a 2a6b 7761  rad(*args, **kwa
+0001eff0: 7267 7329 3a0a 2020 2020 2020 2020 7472  rgs):.        tr
+0001f000: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
+0001f010: 7472 6163 6528 2928 6675 6e63 2c20 2a61  trace()(func, *a
+0001f020: 7267 732c 202a 2a6b 7761 7267 7329 0a20  rgs, **kwargs). 
+0001f030: 2020 2020 2020 2063 6f74 616e 6765 6e74         cotangent
+0001f040: 7320 3d20 7472 6565 5f6d 6170 286c 616d  s = tree_map(lam
+0001f050: 6264 6120 763a 206f 6e65 735f 6c69 6b65  bda v: ones_like
+0001f060: 2876 292c 2074 7261 6365 2e6f 7574 7075  (v), trace.outpu
+0001f070: 7429 0a20 2020 2020 2020 2072 6574 7572  t).        retur
+0001f080: 6e20 766a 7028 6675 6e63 2928 6172 6773  n vjp(func)(args
+0001f090: 2c20 636f 7461 6e67 656e 7473 2c20 2a2a  , cotangents, **
+0001f0a0: 6b77 6172 6773 290a 0a20 2020 2072 6574  kwargs)..    ret
+0001f0b0: 7572 6e20 5f76 616c 7565 5f61 6e64 5f67  urn _value_and_g
+0001f0c0: 7261 640a 0a0a 466f 7277 6172 6442 6163  rad...ForwardBac
+0001f0d0: 6b77 6172 6454 7261 6365 7320 3d20 6e61  kwardTraces = na
+0001f0e0: 6d65 6474 7570 6c65 2822 466f 7277 6172  medtuple("Forwar
+0001f0f0: 6442 6163 6b77 6172 6454 7261 6365 7322  dBackwardTraces"
+0001f100: 2c20 5b22 666f 7277 6172 645f 7472 6163  , ["forward_trac
+0001f110: 6522 2c20 2262 6163 6b77 6172 645f 7472  e", "backward_tr
+0001f120: 6163 6522 5d29 0a0a 0a64 6566 205f 7370  ace"])...def _sp
+0001f130: 6c69 745f 7361 7665 645f 666f 725f 6261  lit_saved_for_ba
+0001f140: 636b 7761 7264 5f69 6e74 6f5f 7465 6e73  ckward_into_tens
+0001f150: 6f72 735f 616e 645f 6f74 6865 7228 0a20  ors_and_other(. 
+0001f160: 2020 2073 6176 6564 5f66 6f72 5f62 6163     saved_for_bac
+0001f170: 6b77 6172 643a 2053 6571 7565 6e63 655b  kward: Sequence[
+0001f180: 5661 7269 6162 6c65 5d2c 0a29 202d 3e20  Variable],.) -> 
+0001f190: 7475 706c 655b 5365 7175 656e 6365 5b56  tuple[Sequence[V
+0001f1a0: 6172 6961 626c 655d 2c20 5365 7175 656e  ariable], Sequen
+0001f1b0: 6365 5b56 6172 6961 626c 655d 5d3a 0a20  ce[Variable]]:. 
+0001f1c0: 2020 2022 2222 5370 6c69 7473 2073 6176     """Splits sav
+0001f1d0: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
+0001f1e0: 696e 746f 2074 656e 736f 7273 2061 6e64  into tensors and
+0001f1f0: 206f 7468 6572 2e0a 0a20 2020 2041 7267   other...    Arg
+0001f200: 733a 0a20 2020 2020 2020 2073 6176 6564  s:.        saved
+0001f210: 5f66 6f72 5f62 6163 6b77 6172 6420 2853  _for_backward (S
+0001f220: 6571 7565 6e63 655b 5661 7269 6162 6c65  equence[Variable
+0001f230: 5d29 3a20 5361 7665 645f 666f 725f 6261  ]): Saved_for_ba
+0001f240: 636b 7761 7264 2074 6f20 7370 6c69 742e  ckward to split.
+0001f250: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+0001f260: 2020 2020 2020 2074 7570 6c65 5b53 6571         tuple[Seq
+0001f270: 7565 6e63 655b 5661 7269 6162 6c65 5d2c  uence[Variable],
+0001f280: 2053 6571 7565 6e63 655b 5661 7269 6162   Sequence[Variab
+0001f290: 6c65 5d5d 3a20 5475 706c 6520 6f66 2074  le]]: Tuple of t
+0001f2a0: 656e 736f 7273 2061 6e64 206f 7468 6572  ensors and other
+0001f2b0: 2e0a 2020 2020 2222 220a 2020 2020 6973  ..    """.    is
+0001f2c0: 5f74 656e 736f 7220 3d20 6c61 6d62 6461  _tensor = lambda
+0001f2d0: 2078 3a20 6973 696e 7374 616e 6365 2878   x: isinstance(x
+0001f2e0: 2c20 5465 6e73 6f72 5072 6f78 7929 0a20  , TensorProxy). 
+0001f2f0: 2020 206f 7468 6572 2c20 7465 6e73 6f72     other, tensor
+0001f300: 7320 3d20 7574 696c 732e 7061 7274 6974  s = utils.partit
+0001f310: 696f 6e28 6973 5f74 656e 736f 722c 2073  ion(is_tensor, s
+0001f320: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001f330: 6429 0a20 2020 2072 6574 7572 6e20 7475  d).    return tu
+0001f340: 706c 6528 7465 6e73 6f72 7329 2c20 7475  ple(tensors), tu
+0001f350: 706c 6528 6f74 6865 7229 0a0a 0a64 6566  ple(other)...def
+0001f360: 205f 7570 6461 7465 5f66 6f72 7761 7264   _update_forward
+0001f370: 5f77 6974 685f 6e65 775f 7361 7665 645f  _with_new_saved_
+0001f380: 666f 725f 6261 636b 7761 7264 2866 6f72  for_backward(for
+0001f390: 7761 7264 5f74 7261 6365 3a20 5472 6163  ward_trace: Trac
+0001f3a0: 652c 2073 6176 6564 5f66 6f72 5f62 6163  e, saved_for_bac
+0001f3b0: 6b77 6172 643a 2053 6571 7565 6e63 655b  kward: Sequence[
+0001f3c0: 5661 7269 6162 6c65 5d29 202d 3e20 4e6f  Variable]) -> No
+0001f3d0: 6e65 3a0a 2020 2020 2222 2255 7064 6174  ne:.    """Updat
+0001f3e0: 6573 2074 6865 2066 6f72 7761 7264 2074  es the forward t
+0001f3f0: 7261 6365 2077 6974 6820 6e65 7720 7361  race with new sa
+0001f400: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001f410: 2e0a 0a20 2020 2054 6869 7320 6973 206e  ...    This is n
+0001f420: 6563 6573 7361 7279 2062 6563 6175 7365  ecessary because
+0001f430: 2074 6865 2075 7064 6174 6564 2073 6176   the updated sav
+0001f440: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
+0001f450: 6973 206e 6f74 2061 7661 696c 6162 6c65  is not available
+0001f460: 0a20 2020 2077 6865 6e20 7468 6520 666f  .    when the fo
+0001f470: 7277 6172 6420 616e 6420 6261 636b 7761  rward and backwa
+0001f480: 7264 2074 7261 6365 7320 6172 6520 636f  rd traces are co
+0001f490: 6e73 7472 7563 7465 642e 0a0a 2020 2020  nstructed...    
+0001f4a0: 4172 6773 3a0a 2020 2020 2020 2020 666f  Args:.        fo
+0001f4b0: 7277 6172 645f 7472 6163 6520 2854 7261  rward_trace (Tra
+0001f4c0: 6365 293a 2046 6f72 7761 7264 2074 7261  ce): Forward tra
+0001f4d0: 6365 2074 6f20 7570 6461 7465 2e0a 2020  ce to update..  
+0001f4e0: 2020 2020 2020 7361 7665 645f 666f 725f        saved_for_
+0001f4f0: 6261 636b 7761 7264 2028 5365 7175 656e  backward (Sequen
+0001f500: 6365 5b56 6172 6961 626c 655d 293a 2053  ce[Variable]): S
+0001f510: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001f520: 6420 746f 2075 7365 2074 6f0a 2020 2020  d to use to.    
+0001f530: 2020 2020 2020 2020 7570 6461 7465 2074          update t
+0001f540: 6865 2066 6f72 7761 7264 2074 7261 6365  he forward trace
+0001f550: 2e0a 2020 2020 2222 220a 2020 2020 7361  ..    """.    sa
+0001f560: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001f570: 203d 2074 7265 655f 6d61 7028 6c61 6d62   = tree_map(lamb
+0001f580: 6461 2078 3a20 782e 7661 6c75 6520 6966  da x: x.value if
+0001f590: 2069 7369 6e73 7461 6e63 6528 782c 204e   isinstance(x, N
+0001f5a0: 756d 6265 7250 726f 7879 2920 656c 7365  umberProxy) else
+0001f5b0: 2078 2c20 7361 7665 645f 666f 725f 6261   x, saved_for_ba
+0001f5c0: 636b 7761 7264 290a 2020 2020 7361 7665  ckward).    save
+0001f5d0: 645f 7465 6e73 6f72 732c 2073 6176 6564  d_tensors, saved
+0001f5e0: 5f6f 7468 6572 203d 205f 7370 6c69 745f  _other = _split_
+0001f5f0: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+0001f600: 7264 5f69 6e74 6f5f 7465 6e73 6f72 735f  rd_into_tensors_
+0001f610: 616e 645f 6f74 6865 7228 7361 7665 645f  and_other(saved_
+0001f620: 666f 725f 6261 636b 7761 7264 290a 2020  for_backward).  
+0001f630: 2020 6173 7365 7274 2066 6f72 7761 7264    assert forward
+0001f640: 5f74 7261 6365 2e62 6f75 6e64 5f73 796d  _trace.bound_sym
+0001f650: 626f 6c73 5b2d 315d 2e73 796d 2e69 6420  bols[-1].sym.id 
+0001f660: 3d3d 2070 7269 6d73 2e50 7269 6d49 4473  == prims.PrimIDs
+0001f670: 2e52 4554 5552 4e0a 2020 2020 6e65 775f  .RETURN.    new_
+0001f680: 7265 7475 726e 203d 2028 666f 7277 6172  return = (forwar
+0001f690: 645f 7472 6163 652e 6f75 7470 7574 5b30  d_trace.output[0
+0001f6a0: 5d2c 2028 7361 7665 645f 7465 6e73 6f72  ], (saved_tensor
+0001f6b0: 732c 2073 6176 6564 5f6f 7468 6572 2929  s, saved_other))
+0001f6c0: 0a20 2020 2066 6f72 7761 7264 5f74 7261  .    forward_tra
+0001f6d0: 6365 2e62 6f75 6e64 5f73 796d 626f 6c73  ce.bound_symbols
+0001f6e0: 5b2d 315d 203d 2072 6570 6c61 6365 2866  [-1] = replace(f
+0001f6f0: 6f72 7761 7264 5f74 7261 6365 2e62 6f75  orward_trace.bou
+0001f700: 6e64 5f73 796d 626f 6c73 5b2d 315d 2c20  nd_symbols[-1], 
+0001f710: 6172 6773 3d6e 6577 5f72 6574 7572 6e29  args=new_return)
+0001f720: 0a0a 0a64 6566 205f 7570 6461 7465 5f62  ...def _update_b
+0001f730: 6163 6b77 6172 645f 7769 7468 5f6e 6577  ackward_with_new
+0001f740: 5f73 6176 6564 5f66 6f72 5f62 6163 6b77  _saved_for_backw
+0001f750: 6172 6428 6261 636b 7761 7264 5f74 7261  ard(backward_tra
+0001f760: 6365 3a20 5472 6163 652c 2073 6176 6564  ce: Trace, saved
+0001f770: 5f66 6f72 5f62 6163 6b77 6172 643a 2053  _for_backward: S
+0001f780: 6571 7565 6e63 655b 5661 7269 6162 6c65  equence[Variable
+0001f790: 5d29 202d 3e20 4e6f 6e65 3a0a 2020 2020  ]) -> None:.    
+0001f7a0: 2222 2255 7064 6174 6573 2074 6865 2062  """Updates the b
+0001f7b0: 6163 6b77 6172 6420 7472 6163 6520 7769  ackward trace wi
+0001f7c0: 7468 206e 6577 2073 6176 6564 5f66 6f72  th new saved_for
+0001f7d0: 5f62 6163 6b77 6172 642e 0a0a 2020 2020  _backward...    
+0001f7e0: 5468 6973 2069 7320 6e65 6365 7373 6172  This is necessar
+0001f7f0: 7920 6265 6361 7573 6520 7468 6520 7570  y because the up
+0001f800: 6461 7465 6420 7361 7665 645f 666f 725f  dated saved_for_
+0001f810: 6261 636b 7761 7264 2069 730a 2020 2020  backward is.    
+0001f820: 6e6f 7420 6176 6169 6c61 626c 6520 7768  not available wh
+0001f830: 656e 2074 6865 2062 6163 6b77 6172 6420  en the backward 
+0001f840: 7472 6163 6520 6973 2063 6f6e 7374 7275  trace is constru
+0001f850: 6374 6564 2e0a 0a20 2020 2041 7267 733a  cted...    Args:
+0001f860: 0a20 2020 2020 2020 2062 6163 6b77 6172  .        backwar
+0001f870: 645f 7472 6163 6520 2854 7261 6365 293a  d_trace (Trace):
+0001f880: 2042 6163 6b77 6172 6420 7472 6163 6520   Backward trace 
+0001f890: 746f 2075 7064 6174 652e 0a20 2020 2020  to update..     
+0001f8a0: 2020 2073 6176 6564 5f66 6f72 5f62 6163     saved_for_bac
+0001f8b0: 6b77 6172 6420 2853 6571 7565 6e63 655b  kward (Sequence[
+0001f8c0: 5661 7269 6162 6c65 5d29 3a20 5361 7665  Variable]): Save
+0001f8d0: 645f 666f 725f 6261 636b 7761 7264 2074  d_for_backward t
+0001f8e0: 6f20 7573 6520 746f 0a20 2020 2020 2020  o use to.       
+0001f8f0: 2020 2020 2075 7064 6174 6520 7468 6520       update the 
+0001f900: 6261 636b 7761 7264 2074 7261 6365 2e0a  backward trace..
+0001f910: 2020 2020 2222 220a 0a20 2020 2064 6566      """..    def
+0001f920: 2075 6e70 6163 6b69 6e67 5f66 6e28 7361   unpacking_fn(sa
+0001f930: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001f940: 2c20 636f 7461 6e67 656e 7473 293a 0a20  , cotangents):. 
+0001f950: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+0001f960: 2063 6f74 616e 6765 6e74 7320 3d20 6261   cotangents = ba
+0001f970: 636b 7761 7264 5f74 7261 6365 2e61 7267  ckward_trace.arg
+0001f980: 735b 315d 0a20 2020 2073 6176 6564 5f74  s[1].    saved_t
+0001f990: 656e 736f 7273 2c20 7361 7665 645f 6f74  ensors, saved_ot
+0001f9a0: 6865 7220 3d20 5f73 706c 6974 5f73 6176  her = _split_sav
+0001f9b0: 6564 5f66 6f72 5f62 6163 6b77 6172 645f  ed_for_backward_
+0001f9c0: 696e 746f 5f74 656e 736f 7273 5f61 6e64  into_tensors_and
+0001f9d0: 5f6f 7468 6572 2873 6176 6564 5f66 6f72  _other(saved_for
+0001f9e0: 5f62 6163 6b77 6172 6429 0a20 2020 2075  _backward).    u
+0001f9f0: 6e70 6163 6b69 6e67 5f74 7261 6365 203d  npacking_trace =
+0001fa00: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
+0001fa10: 2872 656e 616d 655f 7072 6f78 6965 733d  (rename_proxies=
+0001fa20: 4661 6c73 652c 2075 7365 5f64 6365 3d46  False, use_dce=F
+0001fa30: 616c 7365 2928 0a20 2020 2020 2020 2075  alse)(.        u
+0001fa40: 6e70 6163 6b69 6e67 5f66 6e2c 2028 7361  npacking_fn, (sa
+0001fa50: 7665 645f 7465 6e73 6f72 732c 2073 6176  ved_tensors, sav
+0001fa60: 6564 5f6f 7468 6572 292c 2063 6f74 616e  ed_other), cotan
+0001fa70: 6765 6e74 730a 2020 2020 290a 2020 2020  gents.    ).    
+0001fa80: 6173 7365 7274 2075 6e70 6163 6b69 6e67  assert unpacking
+0001fa90: 5f74 7261 6365 2e62 6f75 6e64 5f73 796d  _trace.bound_sym
+0001faa0: 626f 6c73 5b2d 315d 2e73 796d 2e69 6420  bols[-1].sym.id 
+0001fab0: 3d3d 2070 7269 6d73 2e50 7269 6d49 4473  == prims.PrimIDs
+0001fac0: 2e52 4554 5552 4e0a 0a20 2020 2062 6163  .RETURN..    bac
+0001fad0: 6b77 6172 645f 7472 6163 652e 6172 6773  kward_trace.args
+0001fae0: 203d 2075 6e70 6163 6b69 6e67 5f74 7261   = unpacking_tra
+0001faf0: 6365 2e61 7267 730a 2020 2020 6261 636b  ce.args.    back
+0001fb00: 7761 7264 5f74 7261 6365 5f62 7379 6d73  ward_trace_bsyms
+0001fb10: 5f77 6974 686f 7574 5f75 6e70 6163 6b69  _without_unpacki
+0001fb20: 6e67 203d 2028 0a20 2020 2020 2020 2062  ng = (.        b
+0001fb30: 7379 6d0a 2020 2020 2020 2020 666f 7220  sym.        for 
+0001fb40: 6273 796d 2069 6e20 6261 636b 7761 7264  bsym in backward
+0001fb50: 5f74 7261 6365 2e62 6f75 6e64 5f73 796d  _trace.bound_sym
+0001fb60: 626f 6c73 0a20 2020 2020 2020 2069 6620  bols.        if 
+0001fb70: 6273 796d 2e73 796d 2e69 640a 2020 2020  bsym.sym.id.    
+0001fb80: 2020 2020 6e6f 7420 696e 2028 0a20 2020      not in (.   
+0001fb90: 2020 2020 2020 2020 2070 7269 6d73 2e50           prims.P
+0001fba0: 7269 6d49 4473 2e55 4e50 4143 4b5f 454d  rimIDs.UNPACK_EM
+0001fbb0: 5054 595f 4449 4354 2c0a 2020 2020 2020  PTY_DICT,.      
+0001fbc0: 2020 2020 2020 7072 696d 732e 5072 696d        prims.Prim
+0001fbd0: 4944 732e 554e 5041 434b 5f4b 4559 2c0a  IDs.UNPACK_KEY,.
+0001fbe0: 2020 2020 2020 2020 2020 2020 7072 696d              prim
+0001fbf0: 732e 5072 696d 4944 732e 554e 5041 434b  s.PrimIDs.UNPACK
+0001fc00: 5f53 4551 5545 4e43 452c 0a20 2020 2020  _SEQUENCE,.     
+0001fc10: 2020 2020 2020 2070 7269 6d73 2e50 7269         prims.Pri
+0001fc20: 6d49 4473 2e55 4e50 4143 4b5f 5452 4956  mIDs.UNPACK_TRIV
+0001fc30: 4941 4c2c 0a20 2020 2020 2020 2029 0a20  IAL,.        ). 
+0001fc40: 2020 2029 0a20 2020 2062 6163 6b77 6172     ).    backwar
+0001fc50: 645f 7472 6163 652e 626f 756e 645f 7379  d_trace.bound_sy
+0001fc60: 6d62 6f6c 7320 3d20 6c69 7374 2828 2a75  mbols = list((*u
+0001fc70: 6e70 6163 6b69 6e67 5f74 7261 6365 2e62  npacking_trace.b
+0001fc80: 6f75 6e64 5f73 796d 626f 6c73 5b3a 2d31  ound_symbols[:-1
+0001fc90: 5d2c 202a 6261 636b 7761 7264 5f74 7261  ], *backward_tra
+0001fca0: 6365 5f62 7379 6d73 5f77 6974 686f 7574  ce_bsyms_without
+0001fcb0: 5f75 6e70 6163 6b69 6e67 2929 0a0a 0a23  _unpacking))...#
+0001fcc0: 204e 4f54 453a 2052 6574 7572 6e69 6e67   NOTE: Returning
+0001fcd0: 206e 616d 6564 7475 706c 6573 2066 726f   namedtuples fro
+0001fce0: 6d20 636f 6d70 696c 6564 2066 756e 6374  m compiled funct
+0001fcf0: 696f 6e73 2064 6f65 736e 2774 2077 6f72  ions doesn't wor
+0001fd00: 6b2e 2053 6565 3a0a 2320 2241 6c6c 6f77  k. See:.# "Allow
+0001fd10: 2072 6574 7572 6e69 6e67 206e 616d 6564   returning named
+0001fd20: 7475 706c 6573 2066 726f 6d20 636f 6d70  tuples from comp
+0001fd30: 696c 6564 2066 756e 6374 696f 6e73 220a  iled functions".
+0001fd40: 2320 4e6f 7465 205b 4772 6164 2066 6f72  # Note [Grad for
+0001fd50: 7761 7264 206f 7574 7075 7420 7370 6563  ward output spec
+0001fd60: 5d0a 2320 4966 2069 7420 6469 6420 776f  ].# If it did wo
+0001fd70: 726b 2069 7420 776f 756c 6420 6265 206e  rk it would be n
+0001fd80: 6963 6520 746f 2075 7365 2074 6869 7320  ice to use this 
+0001fd90: 6e61 6d65 6474 7570 6c65 0a23 2069 6e73  namedtuple.# ins
+0001fda0: 7465 6164 206f 6620 7468 6520 706c 6169  tead of the plai
+0001fdb0: 6e20 7475 706c 6520 6f72 2064 6963 7420  n tuple or dict 
+0001fdc0: 7468 6174 2077 6527 7265 2075 7369 6e67  that we're using
+0001fdd0: 206e 6f77 2e0a 546f 7263 6841 7574 6f67   now..TorchAutog
+0001fde0: 7261 6446 6f72 7761 7264 4461 7461 203d  radForwardData =
+0001fdf0: 206e 616d 6564 7475 706c 6528 0a20 2020   namedtuple(.   
+0001fe00: 2022 546f 7263 6841 7574 6f67 7261 6446   "TorchAutogradF
+0001fe10: 6f72 7761 7264 4461 7461 222c 0a20 2020  orwardData",.   
+0001fe20: 205b 226f 7574 7075 7422 2c20 2266 6c61   ["output", "fla
+0001fe30: 745f 6172 6773 222c 2022 666c 6174 5f6f  t_args", "flat_o
+0001fe40: 7574 7075 7422 5d2c 0a29 0a0a 0a64 6566  utput"],.)...def
+0001fe50: 2066 6f72 7761 7264 5f61 6e64 5f62 6163   forward_and_bac
+0001fe60: 6b77 6172 645f 6672 6f6d 5f74 7261 6365  kward_from_trace
+0001fe70: 2874 7261 6365 3a20 5472 6163 652c 2074  (trace: Trace, t
+0001fe80: 6f72 6368 5f61 7574 6f67 7261 643d 4661  orch_autograd=Fa
+0001fe90: 6c73 6529 202d 3e20 466f 7277 6172 6442  lse) -> ForwardB
+0001fea0: 6163 6b77 6172 6454 7261 6365 733a 0a20  ackwardTraces:. 
+0001feb0: 2020 2022 2222 4765 6e65 7261 7465 7320     """Generates 
+0001fec0: 7468 6520 666f 7277 6172 6420 616e 6420  the forward and 
+0001fed0: 6261 636b 7761 7264 2070 6173 7365 7320  backward passes 
+0001fee0: 6672 6f6d 2061 2074 7261 6365 2e0a 0a20  from a trace... 
+0001fef0: 2020 2054 6869 7320 6973 2061 2063 6f6e     This is a con
+0001ff00: 7665 6e69 656e 6365 2066 756e 6374 696f  venience functio
+0001ff10: 6e20 7468 6174 2063 6f6d 6269 6e65 7320  n that combines 
+0001ff20: 7468 6520 6675 6e63 7469 6f6e 616c 6974  the functionalit
+0001ff30: 7920 6f66 0a20 2020 2060 6175 676d 656e  y of.    `augmen
+0001ff40: 7465 645f 666f 7277 6172 645f 7061 7373  ted_forward_pass
+0001ff50: 6020 616e 6420 6062 6163 6b77 6172 645f  ` and `backward_
+0001ff60: 7061 7373 602e 2054 6865 206d 6169 6e20  pass`. The main 
+0001ff70: 6469 6666 6572 656e 6365 2069 7320 7468  difference is th
+0001ff80: 6174 0a20 2020 2074 6869 7320 6675 6e63  at.    this func
+0001ff90: 7469 6f6e 2064 6f65 7320 6e6f 7420 7265  tion does not re
+0001ffa0: 7175 6972 6520 7468 6520 7573 6572 2074  quire the user t
+0001ffb0: 6f20 7072 6f76 6964 6520 6e65 7720 696e  o provide new in
+0001ffc0: 7075 7473 2066 6f72 2074 6865 0a20 2020  puts for the.   
+0001ffd0: 2074 7261 6365 2065 7661 6c75 6174 696f   trace evaluatio
+0001ffe0: 6e2e 2049 6e73 7465 6164 2069 7420 7573  n. Instead it us
+0001fff0: 6573 2074 6865 2069 6e70 7574 7320 7468  es the inputs th
+00020000: 6174 2077 6572 6520 7573 6564 2074 6f20  at were used to 
+00020010: 636f 6e73 7472 7563 740a 2020 2020 7468  construct.    th
+00020020: 6520 7472 6163 652e 0a0a 2020 2020 4172  e trace...    Ar
+00020030: 6773 3a0a 2020 2020 2020 2020 7472 6163  gs:.        trac
+00020040: 6520 2854 7261 6365 293a 2054 7261 6365  e (Trace): Trace
+00020050: 2074 6f20 6765 6e65 7261 7465 2074 6865   to generate the
+00020060: 2066 6f72 7761 7264 2061 6e64 2062 6163   forward and bac
+00020070: 6b77 6172 6420 7061 7373 6573 2066 726f  kward passes fro
+00020080: 6d2e 0a0a 2020 2020 5265 7475 726e 733a  m...    Returns:
+00020090: 0a20 2020 2020 2020 2046 6f72 7761 7264  .        Forward
+000200a0: 4261 636b 7761 7264 5472 6163 6573 3a20  BackwardTraces: 
+000200b0: 4120 6e61 6d65 6420 7475 706c 6520 636f  A named tuple co
+000200c0: 6e74 6169 6e69 6e67 2074 6865 2066 6f72  ntaining the for
+000200d0: 7761 7264 2061 6e64 2062 6163 6b77 6172  ward and backwar
+000200e0: 640a 2020 2020 2020 2020 2020 2020 7472  d.            tr
+000200f0: 6163 6573 2e0a 0a20 2020 2045 7861 6d70  aces...    Examp
+00020100: 6c65 3a0a 2020 2020 2020 2020 3e3e 3e20  le:.        >>> 
+00020110: 696d 706f 7274 2074 6f72 6368 0a20 2020  import torch.   
+00020120: 2020 2020 203e 3e3e 2066 726f 6d20 7468       >>> from th
+00020130: 756e 6465 7220 696d 706f 7274 2063 6f6d  under import com
+00020140: 7069 6c65 2c20 6c61 7374 5f74 7261 6365  pile, last_trace
+00020150: 730a 2020 2020 2020 2020 3e3e 3e20 6672  s.        >>> fr
+00020160: 6f6d 2074 6875 6e64 6572 2e63 6f72 652e  om thunder.core.
+00020170: 7472 616e 7366 6f72 6d73 2069 6d70 6f72  transforms impor
+00020180: 7420 666f 7277 6172 645f 616e 645f 6261  t forward_and_ba
+00020190: 636b 7761 7264 5f66 726f 6d5f 7472 6163  ckward_from_trac
+000201a0: 650a 2020 2020 2020 2020 3e3e 3e20 6465  e.        >>> de
+000201b0: 6620 6628 7829 3a0a 2020 2020 2020 2020  f f(x):.        
+000201c0: 2e2e 2e20 2020 2020 7265 7475 726e 2074  ...     return t
+000201d0: 6f72 6368 2e73 696e 2878 290a 2020 2020  orch.sin(x).    
+000201e0: 2020 2020 3e3e 3e20 7820 3d20 746f 7263      >>> x = torc
+000201f0: 682e 7465 6e73 6f72 2833 2e30 290a 2020  h.tensor(3.0).  
+00020200: 2020 2020 2020 3e3e 3e20 6366 203d 2063        >>> cf = c
+00020210: 6f6d 7069 6c65 2866 290a 2020 2020 2020  ompile(f).      
+00020220: 2020 3e3e 3e20 6f75 7420 3d20 6366 2878    >>> out = cf(x
+00020230: 290a 2020 2020 2020 2020 3e3e 3e20 7472  ).        >>> tr
+00020240: 6163 6520 3d20 6c61 7374 5f74 7261 6365  ace = last_trace
+00020250: 7328 6366 295b 305d 0a20 2020 2020 2020  s(cf)[0].       
+00020260: 203e 3e3e 2066 6f72 7761 7264 5f61 6e64   >>> forward_and
+00020270: 5f62 6163 6b77 6172 645f 6672 6f6d 5f74  _backward_from_t
+00020280: 7261 6365 2874 7261 6365 290a 2020 2020  race(trace).    
+00020290: 2020 2020 2e2e 2e20 466f 7277 6172 6442      ... ForwardB
+000202a0: 6163 6b77 6172 6454 7261 6365 7328 0a20  ackwardTraces(. 
+000202b0: 2020 2020 2020 202e 2e2e 2066 6f72 7761         ... forwa
+000202c0: 7264 5f74 7261 6365 3d23 2069 6d70 6f72  rd_trace=# impor
+000202d0: 7420 7468 756e 6465 7220 6173 2074 6875  t thunder as thu
+000202e0: 6e64 6572 0a20 2020 2020 2020 202e 2e2e  nder.        ...
+000202f0: 2023 2069 6d70 6f72 7420 7468 756e 6465   # import thunde
+00020300: 722e 636f 7265 2e70 7269 6d73 2061 7320  r.core.prims as 
+00020310: 7072 696d 730a 2020 2020 2020 2020 2e2e  prims.        ..
+00020320: 2e20 696d 706f 7274 2074 6f72 6368 0a20  . import torch. 
+00020330: 2020 2020 2020 202e 2e2e 0a20 2020 2020         ....     
+00020340: 2020 202e 2e2e 2040 746f 7263 682e 6e6f     ... @torch.no
+00020350: 5f67 7261 6428 290a 2020 2020 2020 2020  _grad().        
+00020360: 2e2e 2e20 6465 6620 6175 676d 656e 7465  ... def augmente
+00020370: 645f 666f 7277 6172 645f 666e 282a 6172  d_forward_fn(*ar
+00020380: 6773 293a 0a20 2020 2020 2020 202e 2e2e  gs):.        ...
+00020390: 2020 2023 2061 7267 733a 2022 436f 6c6c     # args: "Coll
+000203a0: 6563 7469 6f6e 2220 3d20 2028 7430 2c29  ection" =  (t0,)
+000203b0: 2020 2874 7269 7669 616c 2075 6e70 6163    (trivial unpac
+000203c0: 6b29 0a20 2020 2020 2020 202e 2e2e 2020  k).        ...  
+000203d0: 2074 302c 205c 0a20 2020 2020 2020 202e   t0, \.        .
+000203e0: 2e2e 2020 203d 2061 7267 730a 2020 2020  ..   = args.    
+000203f0: 2020 2020 2e2e 2e20 2020 7431 203d 2070      ...   t1 = p
+00020400: 7269 6d73 2e73 696e 2874 3029 2020 2320  rims.sin(t0)  # 
+00020410: 7431 3a20 2263 7075 2066 3332 5b5d 220a  t1: "cpu f32[]".
+00020420: 2020 2020 2020 2020 2e2e 2e20 2020 7265          ...   re
+00020430: 7475 726e 2074 312c 2028 7430 2c29 2c0a  turn t1, (t0,),.
+00020440: 2020 2020 2020 2020 2e2e 2e20 6261 636b          ... back
+00020450: 7761 7264 5f74 7261 6365 3d23 2069 6d70  ward_trace=# imp
+00020460: 6f72 7420 7468 756e 6465 7220 6173 2074  ort thunder as t
+00020470: 6875 6e64 6572 0a20 2020 2020 2020 202e  hunder.        .
+00020480: 2e2e 2023 2069 6d70 6f72 7420 7468 756e  .. # import thun
+00020490: 6465 722e 636f 7265 2e70 7269 6d73 2061  der.core.prims a
+000204a0: 7320 7072 696d 730a 2020 2020 2020 2020  s prims.        
+000204b0: 2e2e 2e20 696d 706f 7274 2074 6f72 6368  ... import torch
+000204c0: 0a20 2020 2020 2020 202e 2e2e 0a20 2020  .        ....   
+000204d0: 2020 2020 202e 2e2e 2040 746f 7263 682e       ... @torch.
+000204e0: 6e6f 5f67 7261 6428 290a 2020 2020 2020  no_grad().      
+000204f0: 2020 2e2e 2e20 6465 6620 6261 636b 7761    ... def backwa
+00020500: 7264 5f66 6e28 7361 7665 645f 666f 725f  rd_fn(saved_for_
+00020510: 6261 636b 7761 7264 2c20 636f 7461 6e67  backward, cotang
+00020520: 656e 7473 293a 0a20 2020 2020 2020 202e  ents):.        .
+00020530: 2e2e 2020 2023 2073 6176 6564 5f66 6f72  ..   # saved_for
+00020540: 5f62 6163 6b77 6172 643a 2022 436f 6c6c  _backward: "Coll
+00020550: 6563 7469 6f6e 2220 3d20 2028 7430 2c29  ection" =  (t0,)
+00020560: 2020 2874 7269 7669 616c 2075 6e70 6163    (trivial unpac
+00020570: 6b29 0a20 2020 2020 2020 202e 2e2e 2020  k).        ...  
+00020580: 2023 2063 6f74 616e 6765 6e74 733a 2022   # cotangents: "
+00020590: 6370 7520 6633 325b 5d22 203d 2020 636f  cpu f32[]" =  co
+000205a0: 7461 6e67 656e 7473 2020 2874 7269 7669  tangents  (trivi
+000205b0: 616c 2075 6e70 6163 6b29 0a20 2020 2020  al unpack).     
+000205c0: 2020 202e 2e2e 2020 2074 302c 205c 0a20     ...   t0, \. 
+000205d0: 2020 2020 2020 202e 2e2e 2020 203d 2073         ...   = s
+000205e0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+000205f0: 640a 2020 2020 2020 2020 2e2e 2e20 2020  d.        ...   
+00020600: 7431 203d 2070 7269 6d73 2e63 6f73 2874  t1 = prims.cos(t
+00020610: 3029 2020 2320 7431 3a20 2263 7075 2066  0)  # t1: "cpu f
+00020620: 3332 5b5d 220a 2020 2020 2020 2020 2e2e  32[]".        ..
+00020630: 2e20 2020 7432 203d 2070 7269 6d73 2e6d  .   t2 = prims.m
+00020640: 756c 2863 6f74 616e 6765 6e74 732c 2074  ul(cotangents, t
+00020650: 3129 2020 2320 7432 3a20 2263 7075 2066  1)  # t2: "cpu f
+00020660: 3332 5b5d 220a 2020 2020 2020 2020 2e2e  32[]".        ..
+00020670: 2e20 2020 7265 7475 726e 2028 7432 2c29  .   return (t2,)
+00020680: 290a 2020 2020 2222 220a 0a20 2020 206f  ).    """..    o
+00020690: 7574 7075 745f 7370 6563 203d 204e 6f6e  utput_spec = Non
+000206a0: 650a 0a20 2020 2064 6566 2061 7567 6d65  e..    def augme
+000206b0: 6e74 6564 5f66 6f72 7761 7264 5f66 6e28  nted_forward_fn(
+000206c0: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+000206d0: 3a0a 2020 2020 2020 2020 7265 7375 6c74  :.        result
+000206e0: 2c20 656e 7620 3d20 6175 676d 656e 7465  , env = augmente
+000206f0: 645f 666f 7277 6172 645f 7061 7373 282a  d_forward_pass(*
+00020700: 6172 6773 2c20 7472 6163 653d 7472 6163  args, trace=trac
+00020710: 652c 202a 2a6b 7761 7267 7329 0a20 2020  e, **kwargs).   
+00020720: 2020 2020 2073 6176 6564 5f66 6f72 5f62       saved_for_b
+00020730: 6163 6b77 6172 6420 3d20 6465 636f 6e73  ackward = decons
+00020740: 7472 7563 745f 666f 7277 6172 645f 656e  truct_forward_en
+00020750: 765f 666f 725f 6261 636b 7761 7264 2874  v_for_backward(t
+00020760: 7261 6365 2c20 656e 7629 0a20 2020 2020  race, env).     
+00020770: 2020 2069 6620 746f 7263 685f 6175 746f     if torch_auto
+00020780: 6772 6164 3a0a 2020 2020 2020 2020 2020  grad:.          
+00020790: 2020 6e6f 6e6c 6f63 616c 206f 7574 7075    nonlocal outpu
+000207a0: 745f 7370 6563 0a20 2020 2020 2020 2020  t_spec.         
+000207b0: 2020 2066 6c61 745f 6172 6773 2c20 5f20     flat_args, _ 
+000207c0: 3d20 7472 6565 5f66 6c61 7474 656e 2828  = tree_flatten((
+000207d0: 6172 6773 2c20 6b77 6172 6773 2929 0a20  args, kwargs)). 
+000207e0: 2020 2020 2020 2020 2020 2066 6c61 745f             flat_
+000207f0: 6f75 7470 7574 2c20 6f75 7470 7574 5f73  output, output_s
+00020800: 7065 6320 3d20 7472 6565 5f66 6c61 7474  pec = tree_flatt
+00020810: 656e 2872 6573 756c 7429 0a20 2020 2020  en(result).     
+00020820: 2020 2020 2020 2066 6c61 745f 6f75 7470         flat_outp
+00020830: 7574 203d 2074 7570 6c65 2866 6c61 745f  ut = tuple(flat_
+00020840: 6f75 7470 7574 290a 2020 2020 2020 2020  output).        
+00020850: 2020 2020 2320 5365 6520 4e6f 7465 205b      # See Note [
+00020860: 4772 6164 2066 6f72 7761 7264 206f 7574  Grad forward out
+00020870: 7075 7420 7370 6563 5d0a 2020 2020 2020  put spec].      
+00020880: 2020 2020 2020 666f 725f 6175 746f 6772        for_autogr
+00020890: 6164 203d 2054 6f72 6368 4175 746f 6772  ad = TorchAutogr
+000208a0: 6164 466f 7277 6172 6444 6174 6128 0a20  adForwardData(. 
+000208b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000208c0: 6573 756c 742c 0a20 2020 2020 2020 2020  esult,.         
+000208d0: 2020 2020 2020 2066 6c61 745f 6172 6773         flat_args
+000208e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000208f0: 2020 666c 6174 5f6f 7574 7075 742c 0a20    flat_output,. 
+00020900: 2020 2020 2020 2020 2020 2029 2e5f 6173             )._as
+00020910: 6469 6374 2829 0a20 2020 2020 2020 2020  dict().         
+00020920: 2020 2072 6574 7572 6e20 2866 6f72 5f61     return (for_a
+00020930: 7574 6f67 7261 642c 2073 6176 6564 5f66  utograd, saved_f
+00020940: 6f72 5f62 6163 6b77 6172 6429 0a20 2020  or_backward).   
+00020950: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
+00020960: 6c74 2c20 7361 7665 645f 666f 725f 6261  lt, saved_for_ba
+00020970: 636b 7761 7264 0a0a 2020 2020 2320 436f  ckward..    # Co
+00020980: 7079 2074 6865 2073 6967 6e61 7475 7265  py the signature
+00020990: 206f 6620 7468 6520 6f72 6967 696e 616c   of the original
+000209a0: 2066 756e 6374 696f 6e20 736f 2074 6861   function so tha
+000209b0: 7420 7468 6520 6172 6775 6d65 6e74 7320  t the arguments 
+000209c0: 6172 650a 2020 2020 2320 6e61 6d65 6420  are.    # named 
+000209d0: 636f 7272 6563 746c 7920 696e 2074 6865  correctly in the
+000209e0: 2061 7567 6d65 6e74 6564 2066 6f72 7761   augmented forwa
+000209f0: 7264 2070 6173 7320 696e 7374 6561 6420  rd pass instead 
+00020a00: 6f66 2062 6569 6e67 206e 616d 6564 0a20  of being named. 
+00020a10: 2020 2023 2022 6172 6773 2220 616e 6420     # "args" and 
+00020a20: 226b 7761 7267 7322 2e0a 2020 2020 6175  "kwargs"..    au
+00020a30: 676d 656e 7465 645f 666f 7277 6172 645f  gmented_forward_
+00020a40: 666e 2e5f 5f73 6967 6e61 7475 7265 5f5f  fn.__signature__
+00020a50: 203d 2069 6e73 7065 6374 2e73 6967 6e61   = inspect.signa
+00020a60: 7475 7265 2874 7261 6365 2e66 6e20 6f72  ture(trace.fn or
+00020a70: 2074 7261 6365 2e70 7974 686f 6e5f 6361   trace.python_ca
+00020a80: 6c6c 6162 6c65 2829 290a 0a20 2020 2064  llable())..    d
+00020a90: 6566 206f 6e65 735f 6c69 6b65 2878 293a  ef ones_like(x):
+00020aa0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+00020ab0: 7374 616e 6365 2878 2c20 5465 6e73 6f72  stance(x, Tensor
+00020ac0: 5072 6f78 7929 3a0a 2020 2020 2020 2020  Proxy):.        
+00020ad0: 2020 2020 7265 7475 726e 2066 756c 6c5f      return full_
+00020ae0: 6c69 6b65 2878 2c20 6669 6c6c 5f76 616c  like(x, fill_val
+00020af0: 7565 3d31 290a 2020 2020 2020 2020 656c  ue=1).        el
+00020b00: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
+00020b10: 204e 756d 6265 7250 726f 7879 293a 0a20   NumberProxy):. 
+00020b20: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00020b30: 6e20 7479 7065 2878 2e76 616c 7565 2928  n type(x.value)(
+00020b40: 3129 0a20 2020 2020 2020 2065 6c73 653a  1).        else:
+00020b50: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00020b60: 7572 6e20 4e6f 6e65 0a0a 2020 2020 666f  urn None..    fo
+00020b70: 7277 6172 645f 7472 6163 6520 3d20 636f  rward_trace = co
+00020b80: 6e73 7472 7563 745f 7472 6163 6528 2928  nstruct_trace()(
+00020b90: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+00020ba0: 645f 666e 2c20 2a74 7261 6365 2e61 7267  d_fn, *trace.arg
+00020bb0: 732c 202a 2a74 7261 6365 2e6b 7761 7267  s, **trace.kwarg
+00020bc0: 7329 0a20 2020 2023 2057 6520 7365 7420  s).    # We set 
+00020bd0: 666f 7277 6172 6420 7472 6163 6520 746f  forward trace to
+00020be0: 2063 6f6e 7374 7275 6374 2070 726f 7869   construct proxi
+00020bf0: 6573 2062 6563 6175 7365 2077 6520 6e65  es because we ne
+00020c00: 6564 2074 6865 7365 2070 726f 7869 6573  ed these proxies
+00020c10: 2074 6f0a 2020 2020 2320 6861 7665 2064   to.    # have d
+00020c20: 6966 6665 7265 6e74 206e 616d 6573 2074  ifferent names t
+00020c30: 6861 6e20 7468 6520 6f6e 6573 2069 6e20  han the ones in 
+00020c40: 7468 6520 666f 7277 6172 6420 7472 6163  the forward trac
+00020c50: 652e 0a20 2020 2074 7279 3a0a 2020 2020  e..    try:.    
+00020c60: 2020 2020 7472 6163 6563 7478 5f74 6f6b      tracectx_tok
+00020c70: 656e 203d 2073 6574 5f74 7261 6365 6374  en = set_tracect
+00020c80: 7828 666f 7277 6172 645f 7472 6163 6529  x(forward_trace)
+00020c90: 0a20 2020 2020 2020 2023 2057 6520 646f  .        # We do
+00020ca0: 6e27 7420 7761 6e74 2074 6f20 7265 636f  n't want to reco
+00020cb0: 7264 2074 686f 7365 206f 6e65 735f 6c69  rd those ones_li
+00020cc0: 6b65 2063 616c 6c73 2069 6e20 7468 6520  ke calls in the 
+00020cd0: 666f 7277 6172 6420 7472 6163 652e 0a20  forward trace.. 
+00020ce0: 2020 2020 2020 2077 6974 6820 6465 7461         with deta
+00020cf0: 6368 6564 5f74 7261 6365 2829 3a0a 2020  ched_trace():.  
+00020d00: 2020 2020 2020 2020 2020 6966 2074 6f72            if tor
+00020d10: 6368 5f61 7574 6f67 7261 643a 0a20 2020  ch_autograd:.   
+00020d20: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+00020d30: 7427 7320 6173 7375 6d65 6420 7468 6174  t's assumed that
+00020d40: 2066 6f72 7761 7264 5f74 7261 6365 2e6f   forward_trace.o
+00020d50: 7574 7075 745b 305d 2069 7320 6120 6469  utput[0] is a di
+00020d60: 6374 2066 726f 6d20 546f 7263 6841 7574  ct from TorchAut
+00020d70: 6f67 7261 6446 6f72 7761 7264 4461 7461  ogradForwardData
+00020d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020d90: 2066 6c61 745f 6f75 7470 7574 203d 2066   flat_output = f
+00020da0: 6f72 7761 7264 5f74 7261 6365 2e6f 7574  orward_trace.out
+00020db0: 7075 745b 305d 5b22 666c 6174 5f6f 7574  put[0]["flat_out
+00020dc0: 7075 7422 5d0a 2020 2020 2020 2020 2020  put"].          
+00020dd0: 2020 2020 2020 636f 7461 6e67 656e 7473        cotangents
+00020de0: 203d 2075 7469 6c73 2e73 6571 7565 6e63   = utils.sequenc
+00020df0: 6966 7928 7472 6565 5f6d 6170 286c 616d  ify(tree_map(lam
+00020e00: 6264 6120 763a 206f 6e65 735f 6c69 6b65  bda v: ones_like
+00020e10: 2876 292c 2066 6c61 745f 6f75 7470 7574  (v), flat_output
+00020e20: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
+00020e30: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00020e40: 2020 2020 2063 6f74 616e 6765 6e74 7320       cotangents 
+00020e50: 3d20 7574 696c 732e 7365 7175 656e 6369  = utils.sequenci
+00020e60: 6679 2874 7265 655f 6d61 7028 6c61 6d62  fy(tree_map(lamb
+00020e70: 6461 2076 3a20 6f6e 6573 5f6c 696b 6528  da v: ones_like(
+00020e80: 7629 2c20 7472 6163 652e 6f75 7470 7574  v), trace.output
+00020e90: 2929 0a20 2020 2066 696e 616c 6c79 3a0a  )).    finally:.
+00020ea0: 2020 2020 2020 2020 7265 7365 745f 7472          reset_tr
+00020eb0: 6163 6563 7478 2874 7261 6365 6374 785f  acectx(tracectx_
+00020ec0: 746f 6b65 6e29 0a0a 2020 2020 6465 6620  token)..    def 
+00020ed0: 6261 636b 7761 7264 5f66 6e28 7361 7665  backward_fn(save
+00020ee0: 645f 666f 725f 6261 636b 7761 7264 2c20  d_for_backward, 
+00020ef0: 636f 7461 6e67 656e 7473 293a 0a20 2020  cotangents):.   
+00020f00: 2020 2020 2065 6e76 203d 2072 6563 6f6e       env = recon
+00020f10: 7374 7275 6374 5f66 6f72 7761 7264 5f65  struct_forward_e
+00020f20: 6e76 5f66 6f72 5f62 6163 6b77 6172 6428  nv_for_backward(
+00020f30: 7472 6163 652c 2073 6176 6564 5f66 6f72  trace, saved_for
+00020f40: 5f62 6163 6b77 6172 6429 0a20 2020 2020  _backward).     
+00020f50: 2020 2069 6620 746f 7263 685f 6175 746f     if torch_auto
+00020f60: 6772 6164 3a0a 2020 2020 2020 2020 2020  grad:.          
+00020f70: 2020 636f 7461 6e67 656e 7473 203d 2074    cotangents = t
+00020f80: 7265 655f 756e 666c 6174 7465 6e28 636f  ree_unflatten(co
+00020f90: 7461 6e67 656e 7473 2c20 6f75 7470 7574  tangents, output
+00020fa0: 5f73 7065 6329 0a20 2020 2020 2020 206f  _spec).        o
+00020fb0: 7574 203d 2062 6163 6b77 6172 645f 7061  ut = backward_pa
+00020fc0: 7373 2865 6e76 2c20 7472 6163 652c 2063  ss(env, trace, c
+00020fd0: 6f74 616e 6765 6e74 7329 0a20 2020 2020  otangents).     
+00020fe0: 2020 2069 6620 746f 7263 685f 6175 746f     if torch_auto
+00020ff0: 6772 6164 3a0a 2020 2020 2020 2020 2020  grad:.          
+00021000: 2020 676b 7761 7267 7320 3d20 6f75 745b    gkwargs = out[
+00021010: 2d31 5d20 6966 2069 7369 6e73 7461 6e63  -1] if isinstanc
+00021020: 6528 6f75 745b 2d31 5d2c 2064 6963 7429  e(out[-1], dict)
+00021030: 2065 6c73 6520 7b7d 0a20 2020 2020 2020   else {}.       
+00021040: 2020 2020 2067 6172 6773 203d 206f 7574       gargs = out
+00021050: 5b3a 2d31 5d20 6966 2069 7369 6e73 7461  [:-1] if isinsta
+00021060: 6e63 6528 6f75 745b 2d31 5d2c 2064 6963  nce(out[-1], dic
+00021070: 7429 2065 6c73 6520 6f75 740a 2020 2020  t) else out.    
+00021080: 2020 2020 2020 2020 676b 7761 7267 7320          gkwargs 
+00021090: 3d20 7b6b 3a20 676b 7761 7267 732e 6765  = {k: gkwargs.ge
+000210a0: 7428 6b2c 204e 6f6e 6529 2066 6f72 206b  t(k, None) for k
+000210b0: 2069 6e20 7472 6163 652e 6b77 6172 6773   in trace.kwargs
+000210c0: 7d0a 2020 2020 2020 2020 2020 2020 6f75  }.            ou
+000210d0: 7420 3d20 282a 6761 7267 732c 2067 6b77  t = (*gargs, gkw
+000210e0: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
+000210f0: 2020 6f75 7420 3d20 7472 6565 5f66 6c61    out = tree_fla
+00021100: 7474 656e 286f 7574 295b 305d 0a20 2020  tten(out)[0].   
+00021110: 2020 2020 2072 6574 7572 6e20 6f75 740a       return out.
+00021120: 0a20 2020 2073 6176 6564 5f66 6f72 5f62  .    saved_for_b
+00021130: 6163 6b77 6172 6420 3d20 666f 7277 6172  ackward = forwar
+00021140: 645f 7472 6163 652e 6f75 7470 7574 5b31  d_trace.output[1
+00021150: 5d0a 2020 2020 6261 636b 7761 7264 5f74  ].    backward_t
+00021160: 7261 6365 203d 2063 6f6e 7374 7275 6374  race = construct
+00021170: 5f74 7261 6365 2872 656e 616d 655f 7072  _trace(rename_pr
+00021180: 6f78 6965 733d 4661 6c73 6529 2862 6163  oxies=False)(bac
+00021190: 6b77 6172 645f 666e 2c20 7361 7665 645f  kward_fn, saved_
+000211a0: 666f 725f 6261 636b 7761 7264 2c20 636f  for_backward, co
+000211b0: 7461 6e67 656e 7473 290a 0a20 2020 2023  tangents)..    #
+000211c0: 2057 6520 6172 6520 646f 6e65 2077 6974   We are done wit
+000211d0: 6820 636f 6e73 7472 7563 7469 6e67 2074  h constructing t
+000211e0: 6865 2066 6f72 7761 7264 2061 6e64 2062  he forward and b
+000211f0: 6163 6b77 6172 6420 7061 7373 6573 2061  ackward passes a
+00021200: 7420 7468 6973 0a20 2020 2023 2073 7461  t this.    # sta
+00021210: 6765 2e20 5468 6520 666f 6c6c 6f77 696e  ge. The followin
+00021220: 6720 6973 206e 6f74 2073 7472 6963 746c  g is not strictl
+00021230: 7920 6e65 6365 7373 6172 792c 2062 7574  y necessary, but
+00021240: 2069 7427 7320 676f 6f64 2074 6f20 6669   it's good to fi
+00021250: 6c74 6572 0a20 2020 2023 206f 7574 2074  lter.    # out t
+00021260: 6865 2075 6e75 7365 6420 656c 656d 656e  he unused elemen
+00021270: 7473 206f 6620 7468 6520 7361 7665 645f  ts of the saved_
+00021280: 666f 725f 6261 636b 7761 7264 2061 6e64  for_backward and
+00021290: 2066 6c61 7474 656e 2069 7420 666f 7220   flatten it for 
+000212a0: 6d6f 7265 0a20 2020 2023 2063 6f6d 7061  more.    # compa
+000212b0: 6374 2062 6163 6b77 6172 6420 7472 6163  ct backward trac
+000212c0: 652e 0a0a 2020 2020 2320 4e6f 7720 7765  e...    # Now we
+000212d0: 2063 616e 2064 6574 6572 6d69 6e65 2065   can determine e
+000212e0: 7861 6374 6c79 2077 6861 7427 7320 7573  xactly what's us
+000212f0: 6564 2069 6e20 7468 6520 6261 636b 7761  ed in the backwa
+00021300: 7264 2070 6173 7320 6672 6f6d 2074 6865  rd pass from the
+00021310: 0a20 2020 2023 2073 6176 6564 5f66 6f72  .    # saved_for
+00021320: 5f62 6163 6b77 6172 642e 2057 6520 6361  _backward. We ca
+00021330: 6e20 666c 6174 7465 6e20 616e 6420 6669  n flatten and fi
+00021340: 6c74 6572 2074 6865 2073 6176 6564 5f66  lter the saved_f
+00021350: 6f72 5f62 6163 6b77 6172 640a 2020 2020  or_backward.    
+00021360: 636f 6e73 756d 6572 7320 3d20 7574 696c  consumers = util
+00021370: 732e 636f 6e73 756d 6572 7328 6261 636b  s.consumers(back
+00021380: 7761 7264 5f74 7261 6365 290a 0a20 2020  ward_trace)..   
+00021390: 2023 2046 6f72 7761 7264 2773 2061 6e64   # Forward's and
+000213a0: 2062 6163 6b77 6172 6427 7320 2273 6176   backward's "sav
+000213b0: 6564 5f66 6f72 5f62 6163 6b77 6172 6422  ed_for_backward"
+000213c0: 2061 7265 206e 6f74 206e 6563 6573 7361   are not necessa
+000213d0: 7269 6c79 2074 6865 2073 616d 650a 2020  rily the same.  
+000213e0: 2020 2320 6173 2074 6865 2073 6176 6564    # as the saved
+000213f0: 5f66 6f72 5f62 6163 6b77 6172 642c 2062  _for_backward, b
+00021400: 6563 6175 7365 2073 6f6d 6520 6f72 2061  ecause some or a
+00021410: 6c6c 2065 6c65 6d65 6e74 7320 6f66 2074  ll elements of t
+00021420: 6865 0a20 2020 2023 2073 6176 6564 5f66  he.    # saved_f
+00021430: 6f72 5f62 6163 6b77 6172 6420 7265 7375  or_backward resu
+00021440: 6c74 7320 6d69 6768 7420 6265 2072 652d  lts might be re-
+00021450: 7072 6f78 6966 6965 642e 0a20 2020 2062  proxified..    b
+00021460: 775f 666c 6174 5f73 6176 6564 5f66 6f72  w_flat_saved_for
+00021470: 5f62 6163 6b77 6172 642c 2073 7065 6320  _backward, spec 
+00021480: 3d20 7472 6565 5f66 6c61 7474 656e 2862  = tree_flatten(b
+00021490: 6163 6b77 6172 645f 7472 6163 652e 6172  ackward_trace.ar
+000214a0: 6773 5b30 5d29 0a20 2020 2066 775f 666c  gs[0]).    fw_fl
+000214b0: 6174 5f73 6176 6564 5f66 6f72 5f62 6163  at_saved_for_bac
+000214c0: 6b77 6172 642c 205f 203d 2074 7265 655f  kward, _ = tree_
+000214d0: 666c 6174 7465 6e28 666f 7277 6172 645f  flatten(forward_
+000214e0: 7472 6163 652e 6f75 7470 7574 5b31 5d29  trace.output[1])
+000214f0: 0a20 2020 2075 7365 645f 6d61 736b 203d  .    used_mask =
+00021500: 206c 6973 7428 6c65 6e28 636f 6e73 756d   list(len(consum
+00021510: 6572 732e 6765 7428 782c 2028 2929 2920  ers.get(x, ())) 
+00021520: 3e20 3020 666f 7220 7820 696e 2062 775f  > 0 for x in bw_
+00021530: 666c 6174 5f73 6176 6564 5f66 6f72 5f62  flat_saved_for_b
+00021540: 6163 6b77 6172 6429 0a0a 2020 2020 2320  ackward)..    # 
+00021550: 446f 6e27 7420 7573 6520 7468 6520 7361  Don't use the sa
+00021560: 6d65 2076 6172 6961 626c 6520 7477 6963  me variable twic
+00021570: 6520 696e 2074 6865 2062 6163 6b77 6172  e in the backwar
+00021580: 6420 7061 7373 0a20 2020 2073 6565 6e20  d pass.    seen 
+00021590: 3d20 7365 7428 290a 2020 2020 6672 6f6d  = set().    from
+000215a0: 2074 6875 6e64 6572 2e63 6f72 652e 7072   thunder.core.pr
+000215b0: 6f78 6965 7320 696d 706f 7274 2056 6172  oxies import Var
+000215c0: 6961 626c 650a 0a20 2020 2066 6f72 2069  iable..    for i
+000215d0: 2c20 7820 696e 2065 6e75 6d65 7261 7465  , x in enumerate
+000215e0: 2866 775f 666c 6174 5f73 6176 6564 5f66  (fw_flat_saved_f
+000215f0: 6f72 5f62 6163 6b77 6172 6429 3a0a 2020  or_backward):.  
+00021600: 2020 2020 2020 7820 3d20 7661 7269 6162        x = variab
+00021610: 6c65 6966 7928 7829 0a20 2020 2020 2020  leify(x).       
+00021620: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
+00021630: 6365 2878 2c20 5661 7269 6162 6c65 293a  ce(x, Variable):
+00021640: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00021650: 7469 6e75 650a 2020 2020 2020 2020 6966  tinue.        if
+00021660: 2078 2069 6e20 7365 656e 3a0a 2020 2020   x in seen:.    
+00021670: 2020 2020 2020 2020 7573 6564 5f6d 6173          used_mas
+00021680: 6b5b 695d 203d 2046 616c 7365 0a20 2020  k[i] = False.   
+00021690: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000216a0: 2020 2020 2020 2073 6565 6e2e 6164 6428         seen.add(
+000216b0: 7829 0a0a 2020 2020 6f6e 6c79 5f75 7365  x)..    only_use
+000216c0: 645f 6677 5f73 6176 6564 5f66 6f72 5f62  d_fw_saved_for_b
+000216d0: 6163 6b77 6172 6420 3d20 7475 706c 6528  ackward = tuple(
+000216e0: 636f 6d70 7265 7373 2866 775f 666c 6174  compress(fw_flat
+000216f0: 5f73 6176 6564 5f66 6f72 5f62 6163 6b77  _saved_for_backw
+00021700: 6172 642c 2075 7365 645f 6d61 736b 2929  ard, used_mask))
+00021710: 0a20 2020 206f 6e6c 795f 7573 6564 5f62  .    only_used_b
+00021720: 775f 7361 7665 645f 666f 725f 6261 636b  w_saved_for_back
+00021730: 7761 7264 203d 2074 7570 6c65 2863 6f6d  ward = tuple(com
+00021740: 7072 6573 7328 6277 5f66 6c61 745f 7361  press(bw_flat_sa
+00021750: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+00021760: 2c20 7573 6564 5f6d 6173 6b29 290a 0a20  , used_mask)).. 
+00021770: 2020 2023 2057 6520 6e65 6564 2074 6f20     # We need to 
+00021780: 7570 6461 7465 2074 6865 2074 7261 6365  update the trace
+00021790: 7320 7769 7468 2074 6865 206e 6577 2073  s with the new s
+000217a0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+000217b0: 640a 2020 2020 5f75 7064 6174 655f 666f  d.    _update_fo
+000217c0: 7277 6172 645f 7769 7468 5f6e 6577 5f73  rward_with_new_s
+000217d0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+000217e0: 6428 666f 7277 6172 645f 7472 6163 652c  d(forward_trace,
+000217f0: 206f 6e6c 795f 7573 6564 5f66 775f 7361   only_used_fw_sa
+00021800: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+00021810: 290a 2020 2020 5f75 7064 6174 655f 6261  ).    _update_ba
+00021820: 636b 7761 7264 5f77 6974 685f 6e65 775f  ckward_with_new_
+00021830: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+00021840: 7264 2862 6163 6b77 6172 645f 7472 6163  rd(backward_trac
+00021850: 652c 206f 6e6c 795f 7573 6564 5f62 775f  e, only_used_bw_
+00021860: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+00021870: 7264 290a 2020 2020 666f 7277 6172 645f  rd).    forward_
+00021880: 7472 6163 652e 7365 745f 7072 6f76 656e  trace.set_proven
+00021890: 616e 6365 2854 7261 6365 5072 6f76 656e  ance(TraceProven
+000218a0: 616e 6365 2822 4175 676d 656e 7465 6420  ance("Augmented 
+000218b0: 666f 7277 6172 6420 7061 7373 2229 290a  forward pass")).
+000218c0: 2020 2020 6261 636b 7761 7264 5f74 7261      backward_tra
+000218d0: 6365 2e73 6574 5f70 726f 7665 6e61 6e63  ce.set_provenanc
+000218e0: 6528 5472 6163 6550 726f 7665 6e61 6e63  e(TraceProvenanc
+000218f0: 6528 2242 6163 6b77 6172 6420 7061 7373  e("Backward pass
+00021900: 2229 290a 2020 2020 7265 7475 726e 2046  ")).    return F
+00021910: 6f72 7761 7264 4261 636b 7761 7264 5472  orwardBackwardTr
+00021920: 6163 6573 2866 6f72 7761 7264 5f74 7261  aces(forward_tra
+00021930: 6365 2c20 6261 636b 7761 7264 5f74 7261  ce, backward_tra
+00021940: 6365 290a 0a0a 2320 646f 2077 6520 6861  ce)...# do we ha
+00021950: 7070 656e 2074 6f20 7761 6e74 2074 6f20  ppen to want to 
+00021960: 7265 6769 7374 6572 2060 6c74 6f72 6368  register `ltorch
+00021970: 6020 6f70 7320 7375 6368 2061 7320 606c  ` ops such as `l
+00021980: 746f 7263 682e 6c61 7965 725f 6e6f 726d  torch.layer_norm
+00021990: 6020 6173 2077 656c 6c3f 0a61 7574 6f63  ` as well?.autoc
+000219a0: 6173 745f 696d 706c 733a 2064 6963 745b  ast_impls: dict[
+000219b0: 7072 696d 732e 5072 696d 4944 732c 2043  prims.PrimIDs, C
+000219c0: 616c 6c61 626c 655d 203d 207b 7d0a 0a0a  allable] = {}...
+000219d0: 6465 6620 7265 6769 7374 6572 5f61 7574  def register_aut
+000219e0: 6f63 6173 745f 7275 6c65 286f 7029 3a0a  ocast_rule(op):.
+000219f0: 2020 2020 6465 6620 6465 636f 7261 746f      def decorato
+00021a00: 7228 6675 6e63 293a 0a20 2020 2020 2020  r(func):.       
+00021a10: 2061 7574 6f63 6173 745f 696d 706c 735b   autocast_impls[
+00021a20: 6f70 5d20 3d20 6675 6e63 0a20 2020 2020  op] = func.     
+00021a30: 2020 2072 6574 7572 6e20 6675 6e63 0a0a     return func..
+00021a40: 2020 2020 7265 7475 726e 2064 6563 6f72      return decor
+00021a50: 6174 6f72 0a0a 0a64 6566 206d 6179 6265  ator...def maybe
+00021a60: 5f64 6f77 6e63 6173 745f 746f 2864 7479  _downcast_to(dty
+00021a70: 7065 2c20 6172 6773 293a 0a20 2020 2061  pe, args):.    a
+00021a80: 6c6c 6f77 6564 5f64 6f77 6e63 6173 745f  llowed_downcast_
+00021a90: 7479 7065 7320 3d20 2864 7479 7065 732e  types = (dtypes.
+00021aa0: 666c 6f61 7431 362c 2064 7479 7065 732e  float16, dtypes.
+00021ab0: 6266 6c6f 6174 3136 2c20 6474 7970 6573  bfloat16, dtypes
+00021ac0: 2e66 6c6f 6174 3332 290a 0a20 2020 2064  .float32)..    d
+00021ad0: 6566 206d 6170 5f66 6e28 6129 3a0a 2020  ef map_fn(a):.  
+00021ae0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00021af0: 6e63 6528 612c 2054 656e 736f 7250 726f  nce(a, TensorPro
+00021b00: 7879 2920 616e 6420 612e 6474 7970 6520  xy) and a.dtype 
+00021b10: 696e 2061 6c6c 6f77 6564 5f64 6f77 6e63  in allowed_downc
+00021b20: 6173 745f 7479 7065 733a 0a20 2020 2020  ast_types:.     
+00021b30: 2020 2020 2020 2072 6574 7572 6e20 6d61         return ma
+00021b40: 7962 655f 636f 6e76 6572 745f 746f 5f64  ybe_convert_to_d
+00021b50: 7479 7065 2861 2c20 6474 7970 6529 0a20  type(a, dtype). 
+00021b60: 2020 2020 2020 2072 6574 7572 6e20 610a         return a.
+00021b70: 0a20 2020 2072 6574 7572 6e20 7472 6565  .    return tree
+00021b80: 5f6d 6170 286d 6170 5f66 6e2c 2061 7267  _map(map_fn, arg
+00021b90: 7329 0a0a 0a40 7265 6769 7374 6572 5f61  s)...@register_a
+00021ba0: 7574 6f63 6173 745f 7275 6c65 2822 746f  utocast_rule("to
+00021bb0: 7263 682e 6d61 746d 756c 2229 0a40 7265  rch.matmul").@re
+00021bc0: 6769 7374 6572 5f61 7574 6f63 6173 745f  gister_autocast_
+00021bd0: 7275 6c65 2870 7269 6d73 2e50 7269 6d49  rule(prims.PrimI
+00021be0: 4473 2e4d 4154 4d55 4c29 0a64 6566 2061  Ds.MATMUL).def a
+00021bf0: 7574 6f63 6173 745f 6d61 746d 756c 5f72  utocast_matmul_r
+00021c00: 756c 6528 612c 2062 2c20 6474 7970 6529  ule(a, b, dtype)
+00021c10: 3a0a 2020 2020 2222 2241 7574 6f63 6173  :.    """Autocas
+00021c20: 7420 7275 6c65 2066 6f72 206d 6174 6d75  t rule for matmu
+00021c30: 6c22 2222 0a20 2020 2072 6574 7572 6e20  l""".    return 
+00021c40: 7072 696d 732e 6d61 746d 756c 282a 286d  prims.matmul(*(m
+00021c50: 6179 6265 5f64 6f77 6e63 6173 745f 746f  aybe_downcast_to
+00021c60: 2864 7479 7065 2c20 2861 2c20 6229 2929  (dtype, (a, b)))
+00021c70: 290a 0a0a 4072 6567 6973 7465 725f 6175  )...@register_au
+00021c80: 746f 6361 7374 5f72 756c 6528 2274 6f72  tocast_rule("tor
+00021c90: 6368 2e6e 6e2e 6675 6e63 7469 6f6e 616c  ch.nn.functional
+00021ca0: 2e6c 696e 6561 7222 290a 4072 6567 6973  .linear").@regis
+00021cb0: 7465 725f 6175 746f 6361 7374 5f72 756c  ter_autocast_rul
+00021cc0: 6528 7072 696d 732e 5072 696d 4944 732e  e(prims.PrimIDs.
+00021cd0: 4c49 4e45 4152 290a 6465 6620 6175 746f  LINEAR).def auto
+00021ce0: 6361 7374 5f6c 696e 6561 725f 7275 6c65  cast_linear_rule
+00021cf0: 2861 2c20 772c 2062 6961 732c 2064 7479  (a, w, bias, dty
+00021d00: 7065 293a 0a20 2020 2069 6620 6269 6173  pe):.    if bias
+00021d10: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00021d20: 2020 2320 446f 6e27 7420 7061 7373 2060    # Don't pass `
+00021d30: 6269 6173 6020 746f 206d 6179 6265 5f64  bias` to maybe_d
+00021d40: 6f77 6e63 6173 745f 746f 2e0a 2020 2020  owncast_to..    
+00021d50: 2020 2020 646f 776e 6361 7374 5f61 7267      downcast_arg
+00021d60: 7320 3d20 6d61 7962 655f 646f 776e 6361  s = maybe_downca
+00021d70: 7374 5f74 6f28 6474 7970 652c 2028 612c  st_to(dtype, (a,
+00021d80: 2077 2929 202b 2028 6269 6173 2c29 0a20   w)) + (bias,). 
+00021d90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00021da0: 2064 6f77 6e63 6173 745f 6172 6773 203d   downcast_args =
+00021db0: 206d 6179 6265 5f64 6f77 6e63 6173 745f   maybe_downcast_
+00021dc0: 746f 2864 7479 7065 2c20 2861 2c20 772c  to(dtype, (a, w,
+00021dd0: 2062 6961 7329 290a 0a20 2020 2072 6574   bias))..    ret
+00021de0: 7572 6e20 7072 696d 732e 6c69 6e65 6172  urn prims.linear
+00021df0: 282a 646f 776e 6361 7374 5f61 7267 7329  (*downcast_args)
+00021e00: 0a0a 0a40 7265 6769 7374 6572 5f61 7574  ...@register_aut
+00021e10: 6f63 6173 745f 7275 6c65 2822 746f 7263  ocast_rule("torc
+00021e20: 682e 6e6e 2e66 756e 6374 696f 6e61 6c2e  h.nn.functional.
+00021e30: 7363 616c 6564 5f64 6f74 5f70 726f 6475  scaled_dot_produ
+00021e40: 6374 5f61 7474 656e 7469 6f6e 2229 0a64  ct_attention").d
+00021e50: 6566 2061 7574 6f63 6173 745f 7363 616c  ef autocast_scal
+00021e60: 6564 5f64 6f74 5f70 726f 6475 6374 5f61  ed_dot_product_a
+00021e70: 7474 656e 7469 6f6e 280a 2020 2020 7175  ttention(.    qu
+00021e80: 6572 792c 0a20 2020 206b 6579 2c0a 2020  ery,.    key,.  
+00021e90: 2020 7661 6c75 652c 0a20 2020 2061 7474    value,.    att
+00021ea0: 6e5f 6d61 736b 2c0a 2020 2020 6472 6f70  n_mask,.    drop
+00021eb0: 6f75 745f 702c 0a20 2020 2069 735f 6361  out_p,.    is_ca
+00021ec0: 7573 616c 2c0a 2020 2020 2a2c 0a20 2020  usal,.    *,.   
+00021ed0: 2064 7479 7065 2c0a 2020 2020 7363 616c   dtype,.    scal
+00021ee0: 652c 0a29 3a0a 2020 2020 6672 6f6d 2074  e,.):.    from t
+00021ef0: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
+00021f00: 6f72 7420 7363 616c 6564 5f64 6f74 5f70  ort scaled_dot_p
+00021f10: 726f 6475 6374 5f61 7474 656e 7469 6f6e  roduct_attention
+00021f20: 0a0a 2020 2020 712c 206b 2c20 7620 3d20  ..    q, k, v = 
+00021f30: 6d61 7962 655f 646f 776e 6361 7374 5f74  maybe_downcast_t
+00021f40: 6f28 6474 7970 652c 2028 7175 6572 792c  o(dtype, (query,
+00021f50: 206b 6579 2c20 7661 6c75 6529 290a 2020   key, value)).  
+00021f60: 2020 7265 7475 726e 2073 6361 6c65 645f    return scaled_
+00021f70: 646f 745f 7072 6f64 7563 745f 6174 7465  dot_product_atte
+00021f80: 6e74 696f 6e28 712c 206b 2c20 762c 2061  ntion(q, k, v, a
+00021f90: 7474 6e5f 6d61 736b 2c20 6472 6f70 6f75  ttn_mask, dropou
+00021fa0: 745f 702c 2069 735f 6361 7573 616c 2c20  t_p, is_causal, 
+00021fb0: 7363 616c 653d 7363 616c 6529 0a0a 0a64  scale=scale)...d
+00021fc0: 6566 2061 7574 6f63 6173 745f 7379 6d62  ef autocast_symb
+00021fd0: 6f6c 5f6d 6170 7065 7228 626f 756e 645f  ol_mapper(bound_
+00021fe0: 7379 6d62 6f6c 3a20 426f 756e 6453 796d  symbol: BoundSym
+00021ff0: 626f 6c49 6e74 6572 6661 6365 2c20 6474  bolInterface, dt
+00022000: 7970 653a 2064 7479 7065 732e 6474 7970  ype: dtypes.dtyp
+00022010: 6529 3a0a 2020 2020 2222 2252 6574 7572  e):.    """Retur
+00022020: 6e20 7468 6520 6361 6c6c 6162 6c65 2069  n the callable i
+00022030: 6d70 6c65 6d65 6e74 696e 6720 7468 6520  mplementing the 
+00022040: 6175 746f 6361 7374 2072 756c 6520 666f  autocast rule fo
+00022050: 7220 7468 6520 7379 6d62 6f6c 2e0a 0a20  r the symbol... 
+00022060: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+00022070: 2062 6f75 6e64 5f73 796d 626f 6c3a 204d   bound_symbol: M
+00022080: 6170 7065 6420 746f 2069 7473 2061 7574  apped to its aut
+00022090: 6f63 6173 7420 7275 6c65 2e0a 0a20 2020  ocast rule...   
+000220a0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+000220b0: 2020 4361 6c6c 6162 6c65 3a20 5468 6520    Callable: The 
+000220c0: 6361 6c6c 6162 6c65 2069 6d70 6c65 6d65  callable impleme
+000220d0: 6e74 696e 6720 7468 6520 6175 746f 6361  nting the autoca
+000220e0: 7374 2072 756c 6520 666f 7220 7468 6520  st rule for the 
+000220f0: 7379 6d62 6f6c 2e0a 2020 2020 2222 220a  symbol..    """.
+00022100: 2020 2020 6175 746f 6361 7374 5f69 6d70      autocast_imp
+00022110: 6c3a 2043 616c 6c61 626c 6520 7c20 4e6f  l: Callable | No
+00022120: 6e65 203d 2061 7574 6f63 6173 745f 696d  ne = autocast_im
+00022130: 706c 732e 6765 7428 626f 756e 645f 7379  pls.get(bound_sy
+00022140: 6d62 6f6c 2e73 796d 2e69 6429 0a20 2020  mbol.sym.id).   
+00022150: 2072 6574 7572 6e20 626f 756e 645f 7379   return bound_sy
+00022160: 6d62 6f6c 2e73 796d 2069 6620 6175 746f  mbol.sym if auto
+00022170: 6361 7374 5f69 6d70 6c20 6973 204e 6f6e  cast_impl is Non
+00022180: 6520 656c 7365 2070 6172 7469 616c 2861  e else partial(a
+00022190: 7574 6f63 6173 745f 696d 706c 2c20 6474  utocast_impl, dt
+000221a0: 7970 653d 6474 7970 6529 0a0a 0a64 6566  ype=dtype)...def
+000221b0: 2061 7574 6f63 6173 7428 6675 6e63 3a20   autocast(func: 
+000221c0: 4361 6c6c 6162 6c65 2c20 6474 7970 653a  Callable, dtype:
+000221d0: 2064 7479 7065 732e 6474 7970 6529 3a0a   dtypes.dtype):.
+000221e0: 2020 2020 2222 2254 7261 6e73 666f 726d      """Transform
+000221f0: 7320 6120 6675 6e63 7469 6f6e 2074 6f20  s a function to 
+00022200: 6175 746f 6361 7374 2063 6572 7461 696e  autocast certain
+00022210: 206f 7065 7261 7469 6f6e 732e 0a0a 2020   operations...  
+00022220: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00022230: 6675 6e63 3a20 5468 6520 6675 6e63 7469  func: The functi
+00022240: 6f6e 2074 6f20 6265 2074 7261 6e73 666f  on to be transfo
+00022250: 726d 6564 2e0a 2020 2020 2020 2020 6474  rmed..        dt
+00022260: 7970 653a 2054 6865 2064 6174 6120 7479  ype: The data ty
+00022270: 7065 2074 6f20 7768 6963 6820 6172 6775  pe to which argu
+00022280: 6d65 6e74 7320 6f66 2074 6865 2066 756e  ments of the fun
+00022290: 6374 696f 6e20 6f72 2073 7562 2066 756e  ction or sub fun
+000222a0: 6374 696f 6e73 2063 6f75 6c64 2067 6574  ctions could get
+000222b0: 2063 6173 7420 6966 0a20 2020 2020 2020   cast if.       
+000222c0: 2020 2020 2074 6865 7920 6172 6520 6064       they are `d
+000222d0: 7479 7065 732e 666c 6f61 7433 3260 2e0a  types.float32`..
+000222e0: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+000222f0: 2020 2020 2020 4361 6c6c 6162 6c65 3a20        Callable: 
+00022300: 5468 6520 7472 616e 7366 6f72 6d65 6420  The transformed 
+00022310: 6675 6e63 7469 6f6e 0a20 2020 2022 2222  function.    """
+00022320: 0a0a 2020 2020 6966 206e 6f74 2069 7369  ..    if not isi
+00022330: 6e73 7461 6e63 6528 6474 7970 652c 2064  nstance(dtype, d
+00022340: 7479 7065 732e 6474 7970 6529 3a0a 2020  types.dtype):.  
+00022350: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00022360: 6545 7272 6f72 2866 2260 6474 7970 6560  eError(f"`dtype`
+00022370: 2069 7320 6578 7065 6374 6564 2074 6f20   is expected to 
+00022380: 6265 2060 7468 756e 6465 722e 6474 7970  be `thunder.dtyp
+00022390: 652e 6474 7970 6560 2062 7574 207b 7479  e.dtype` but {ty
+000223a0: 7065 2864 7479 7065 297d 2229 0a20 2020  pe(dtype)}").   
+000223b0: 2069 6620 6474 7970 6520 6e6f 7420 696e   if dtype not in
+000223c0: 207b 6474 7970 6573 2e66 6c6f 6174 3136   {dtypes.float16
+000223d0: 2c20 6474 7970 6573 2e62 666c 6f61 7431  , dtypes.bfloat1
+000223e0: 367d 3a0a 2020 2020 2020 2020 7261 6973  6}:.        rais
+000223f0: 6520 5661 6c75 6545 7272 6f72 2866 2260  e ValueError(f"`
+00022400: 6474 7970 6560 2069 7320 6578 7065 6374  dtype` is expect
+00022410: 6564 2074 6f20 6265 2065 6974 6865 7220  ed to be either 
+00022420: 6074 6875 6e64 6572 2e66 6c6f 6174 3136  `thunder.float16
+00022430: 6020 6f72 2060 7468 756e 6465 722e 6266  ` or `thunder.bf
+00022440: 6c6f 6174 3136 602c 2062 7574 207b 6474  loat16`, but {dt
+00022450: 7970 657d 2229 0a0a 2020 2020 4077 7261  ype}")..    @wra
+00022460: 7073 2866 756e 6329 0a20 2020 2064 6566  ps(func).    def
+00022470: 2077 7261 7070 6572 282a 6172 6773 2c20   wrapper(*args, 
+00022480: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
+00022490: 2020 2074 7261 6365 203d 2063 6f6e 7374     trace = const
+000224a0: 7275 6374 5f74 7261 6365 2829 2866 756e  ruct_trace()(fun
+000224b0: 632c 202a 6172 6773 2c20 2a2a 6b77 6172  c, *args, **kwar
+000224c0: 6773 290a 2020 2020 2020 2020 7265 7475  gs).        retu
+000224d0: 726e 2065 7661 6c5f 7472 6163 6528 7472  rn eval_trace(tr
+000224e0: 6163 652c 202a 6172 6773 2c20 2a2a 6b77  ace, *args, **kw
+000224f0: 6172 6773 2c20 7379 6d62 6f6c 5f6d 6170  args, symbol_map
+00022500: 7065 723d 7061 7274 6961 6c28 6175 746f  per=partial(auto
+00022510: 6361 7374 5f73 796d 626f 6c5f 6d61 7070  cast_symbol_mapp
+00022520: 6572 2c20 6474 7970 653d 6474 7970 6529  er, dtype=dtype)
+00022530: 290a 0a20 2020 2072 6574 7572 6e20 7772  )..    return wr
+00022540: 6170 7065 720a                           apper.
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/utils.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/utils.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/core/vjp_utils.py` & `lightning_thunder-0.2.0.dev20240414/thunder/core/vjp_utils.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/cudagraphs/__init__.py` & `lightning_thunder-0.2.0.dev20240414/thunder/cudagraphs/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/distributed/__init__.py` & `lightning_thunder-0.2.0.dev20240414/thunder/distributed/__init__.py`

 * *Files 2% similar despite different names*

```diff
@@ -288,14 +288,17 @@
     LAYER = auto()
     BLOCK = auto()
 
 
 def get_extract_bucket_name_from_tensor_proxy(granularity: FSDPBucketingStrategy):
     from thunder.core.proxies import TensorProxy
 
+    # TODO(crcrpar): Consider making `BLOCK`'s behavior more meticulous for models with simple structure
+    # as in https://github.com/Lightning-AI/lightning-thunder/blob/b24e5b23/thunder/tests/distributed/test_ddp.py#L53-L60
+    # For the linked model, `block` cannot put `t_net1_weight` and `t_net1_bias` into the same bucket.
     # TODO(crcrpar): Consider having bucket_name include dtype (and device) in it
     # as it's possible (especially `FSDPBucketingStrategy.BLOCK`) that parameters of a block
     # have different dtypes such as BF16 and FP8.
     def f(tensor: TensorProxy) -> str:
         bucket_name: str = "fsdp_fwd_"
         match granularity:
             case FSDPBucketingStrategy.LAYER:
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/distributed/bucketing.py` & `lightning_thunder-0.2.0.dev20240414/thunder/distributed/bucketing.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/distributed/checkpoint.py` & `lightning_thunder-0.2.0.dev20240414/thunder/distributed/checkpoint.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/distributed/prims.py` & `lightning_thunder-0.2.0.dev20240414/thunder/distributed/prims.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/distributed/transforms/ddp.py` & `lightning_thunder-0.2.0.dev20240414/thunder/distributed/transforms/ddp.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/distributed/transforms/fsdp.py` & `lightning_thunder-0.2.0.dev20240414/thunder/distributed/transforms/fsdp.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/distributed/utils.py` & `lightning_thunder-0.2.0.dev20240414/thunder/distributed/utils.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/examine/__init__.py` & `lightning_thunder-0.2.0.dev20240414/thunder/examine/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/examine/memory_caculation.py` & `lightning_thunder-0.2.0.dev20240414/thunder/examine/memory_caculation.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/executors/__init__.py` & `lightning_thunder-0.2.0.dev20240414/thunder/executors/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/executors/apex_entropyex.py` & `lightning_thunder-0.2.0.dev20240414/thunder/executors/apex_entropyex.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/executors/cudnn_layernormex.py` & `lightning_thunder-0.2.0.dev20240414/thunder/executors/cudnn_layernormex.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/executors/cudnnex.py` & `lightning_thunder-0.2.0.dev20240414/thunder/executors/cudnnex.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/executors/data_dependent_partition.py` & `lightning_thunder-0.2.0.dev20240414/thunder/executors/data_dependent_partition.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/executors/nvfuserex.py` & `lightning_thunder-0.2.0.dev20240414/thunder/executors/nvfuserex.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/executors/nvfuserex_impl.py` & `lightning_thunder-0.2.0.dev20240414/thunder/executors/nvfuserex_impl.py`

 * *Files 0% similar despite different names*

```diff
@@ -507,17 +507,14 @@
     #   a cache to improve dispatch performance
     @lru_cache(maxsize=2048)
     def get_fd(input_descriptors) -> FusionDefinition:
         # A closure over local trace and region
         return create_fd(bsyms, input_descriptors, sorted_unique_inputs, sorted_unique_outputs)
 
     fdw = FusionDefinitionWrapper(get_fd, name, get_fd.cache_info, get_fd.cache_clear)
-    # Avoid hitting nvFuser error when there is no output
-    if not sorted_unique_outputs:
-        return lambda *args: tuple()
     return fdw
 
 
 class nvFuserExecutor(FusionExecutor):
     # Max number of times that this nvFuserExecutor instance can fuse.
     _optimization_fuel: int | FUEL_LEVEL
 
@@ -831,14 +828,27 @@
                     fusion_bsym: BoundSymbol = self.fuse(fusion, fusion_counter)
                     fused_bsyms.append(fusion_bsym)
                     fusion_counter += 1
                 else:
                     fused_bsyms.extend(fusion.bound_symbols)
             fused_bsyms.extend(epilogue)
 
+        # Force return operator to be the last one in the fused_bsyms
+        if fused_bsyms[-1].sym.id != PrimIDs.RETURN:
+            return_idx: int = -1
+            for i, fused_bsym in enumerate(fused_bsyms):
+                if fused_bsym.sym.id == PrimIDs.RETURN:
+                    return_idx = i
+                    break
+            utils.check(
+                return_idx != -1,
+                lambda: f"Return operator does not exist in bound symbols",
+            )
+            fused_bsyms.append(fused_bsyms.pop(return_idx))
+
         fusedtrace.bound_symbols = fused_bsyms
 
         # Some of the operations might be better placed with its consumers (for
         # example residual connection in transformer block). This pass moves
         # them to the consumer.
         if self._use_rematerialization:
             fusedtrace = rematerialize(fusedtrace)
@@ -2036,14 +2046,37 @@
 
     return fd.ops.batch_norm(nva, nvweight, nvbias, nvrunning_mean, nvrunning_var, nvmomentum, nveps, training)
 
 
 register_supported(PrimIDs.BATCH_NORM, batch_norm, _batch_norm_check)
 
 
+def _copy__check(
+    copy_from: TensorProxy,
+    copy_to: TensorProxy,
+) -> bool:
+    return are_supported_tensors(copy_from, copy_to)
+
+
+def copy_(
+    copy_from: TensorProxy,
+    copy_to: TensorProxy,
+    *,
+    fd: FusionDefinition,
+    lc_to_nv_map: dict,
+) -> Any:
+    nvcopy_from = getnv(copy_from, fd, lc_to_nv_map)
+    nvcopy_to = getnv(copy_to, fd, lc_to_nv_map)
+    fd.add_output(nvcopy_from, alias_input=nvcopy_to)
+    return nvcopy_to
+
+
+register_supported(PrimIDs.COPY_, copy_, _copy__check)
+
+
 # Removes excessive float casts, like those that occur when autocasting
 # NOTE This passes actually changes a program's semantics, because it will take a sequence like
 #   fp32 -> fp16 -> fp32 and remove all the operations, but casting fp32 values to fp16 can
 #   changes the values (because most fp32 values are not representable in fp16)
 # NOTE This only handles conversions performed by CONVERT_ELEMENT_TYPE, and not conversions caused
 #   by other Symbols, like torch.to, which may be unflattened
 # TODO This could be extended to non-float conversions, like complex -> complex conversions
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/executors/passes.py` & `lightning_thunder-0.2.0.dev20240414/thunder/executors/passes.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/executors/pythonex.py` & `lightning_thunder-0.2.0.dev20240414/thunder/executors/pythonex.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/executors/sdpaex.py` & `lightning_thunder-0.2.0.dev20240414/thunder/executors/sdpaex.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/executors/torch_autograd.py` & `lightning_thunder-0.2.0.dev20240414/thunder/executors/torch_autograd.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/executors/torch_compile.py` & `lightning_thunder-0.2.0.dev20240414/thunder/executors/torch_compile.py`

 * *Files 1% similar despite different names*

```diff
@@ -182,17 +182,16 @@
         return fusedtrace
 
 
 torch_compile_executor = TorchCompileExecutor()
 register_executor(torch_compile_executor)
 
 
-def register_supported(id: Hashable):
-    checker = lambda *args, **kwargs: True
-    torch_compile_executor.register_supported(id, checker)
+def register_supported(_id: Hashable):
+    torch_compile_executor.register_supported(_id, checker=None)
 
 
 # This is an initial list to support rotary positional embeddings
 # TODO: Carefully enable more ops checking that they do improve performance
 supported_ops = {
     "torch.split",
     prims.add,
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/executors/torchex.py` & `lightning_thunder-0.2.0.dev20240414/thunder/executors/torchex.py`

 * *Files 3% similar despite different names*

```diff
@@ -33,14 +33,19 @@
 import thunder.core.utils as utils
 
 import thunder.torch as ltorch
 from thunder.torch import DeviceLike, dtypeLike, TensorLike
 
 from thunder.extend import OperatorExecutor, register_executor, add_always_executor
 
+from thunder.core.transforms import (
+    get_grad,
+    put_grad,
+)
+
 ex = OperatorExecutor("torch", version=torch.__version__)
 register_executor(ex)
 add_always_executor(ex)
 
 # Common annotations
 TensorLike = TensorProxy
 FutureTensorLike = FutureTensorProxy
@@ -97,29 +102,33 @@
     tensor_dtype_or_device: None | TensorLike | dtypeLike | DeviceLike = None,
     optional_positional_dtype: None | dtypeLike = None,
     /,
     *,
     device: None | DeviceLike = None,
     dtype: None | dtypeLike = None,
     copy: bool = False,
+    memory_format: None | torch.memory_format = None,
 ) -> TensorLike:
     device: None | devices.Device
     dtype: None | dtypes.dtype
     device, dtype = ltorch._parse_to_device_and_dtype(
         tensor_dtype_or_device, optional_positional_dtype, device=device, dtype=dtype
     )
 
     torch_device: None | torch.device = to_torch_device(device)
     torch_dtype: None | torch.dtype = to_torch_dtype(dtype)
 
-    if torch_device is not None and torch_dtype is not None:
-        return to(a, torch_device, torch_dtype, copy=copy)
+    kwargs = {"copy": copy}
     if torch_device is not None:
-        return to(a, torch_device, copy=copy)
-    return to(a, torch_dtype, copy=copy)
+        kwargs["device"] = torch_device
+    if torch_dtype is not None:
+        kwargs["dtype"] = torch_dtype
+    if memory_format is not None:
+        kwargs["memory_format"] = memory_format
+    return to(a, **kwargs)
 
 
 def _device_put_transform(a: TensorProxy, device: devices.Device) -> TensorProxy:
     torch_device: str = str(device)
     return to(a, torch_device)
 
 
@@ -459,14 +468,15 @@
 select = _register_torch_operation("select")
 split = _register_torch_operation("split")
 stack = _register_torch_operation("stack")
 squeeze = _register_torch_operation("squeeze")
 tensor_split = _register_torch_operation("tensor_split")
 transpose = _register_torch_operation("transpose")
 unbind = _register_torch_operation("unbind")
+unfold = _register_torch_operation("unfold", module=torch.Tensor)
 unsqueeze = _register_torch_operation("unsqueeze")
 view = _register_torch_operation("view", module=torch.Tensor)
 
 
 def _broadcast_in_dim_prim_transform(
     a: TensorProxy, /, shape: Sequence[int], broadcast_dimensions: Sequence[int]
 ) -> TensorProxy:
@@ -529,14 +539,15 @@
 _register_implementation(prims.cat, cat, checker=_always_executable)
 _register_implementation(prims.flip, flip, checker=_always_executable)
 _register_implementation(prims.reshape, reshape, checker=_always_executable)
 slice_prim_impl = ex.register_operator("torch_slice_prim_impl", meta=prims.slice_prim.meta, fn=_slice_prim_impl)
 _register_implementation(prims.slice_prim, slice_prim_impl, checker=_always_executable)
 _register_implementation(prims.squeeze, checker=_always_executable, execution_transform=_squeeze_transform)
 _register_implementation(prims.transpose, checker=_always_executable, execution_transform=_transpose_prim_transform)
+_register_implementation(prims.unfold, unfold, checker=_always_executable)
 _register_implementation(prims.view, view, checker=_always_executable)
 
 _register_implementation(ltorch.cat, cat, checker=_always_executable)
 _register_implementation(ltorch.chunk, chunk, checker=_always_executable)
 _register_implementation(ltorch.diagonal, diagonal, checker=_always_executable)
 _register_implementation(ltorch.expand, expand, checker=_always_executable)
 _register_implementation(ltorch.flatten, flatten, checker=_always_executable)
@@ -549,14 +560,15 @@
 _register_implementation(ltorch.select, select, checker=_always_executable)
 _register_implementation(ltorch.split, split, checker=_always_executable)
 _register_implementation(ltorch.stack, stack, checker=_always_executable)
 _register_implementation(ltorch.squeeze, checker=_always_executable, execution_transform=_squeeze_transform)
 _register_implementation(ltorch.tensor_split, tensor_split, checker=_always_executable)
 _register_implementation(ltorch.transpose, transpose, checker=_always_executable)
 _register_implementation(ltorch.unbind, unbind, checker=_always_executable)
+_register_implementation(ltorch.unfold, unfold, checker=_always_executable)
 _register_implementation(ltorch.unsqueeze, unsqueeze, checker=_always_executable)
 _register_implementation(ltorch.view, view, checker=_always_executable)
 
 #
 # Memory format operations
 #
 contiguous = _register_torch_operation("contiguous", module=torch.Tensor)
@@ -1198,25 +1210,120 @@
 conv1d = _register_torch_operation("conv1d", module=torch.nn.functional)
 conv2d = _register_torch_operation("conv2d", module=torch.nn.functional)
 conv3d = _register_torch_operation("conv3d", module=torch.nn.functional)
 cross_entropy = _register_torch_operation("cross_entropy", module=torch.nn.functional)
 dropout = _register_torch_operation("dropout", module=torch.nn.functional)
 embedding = _register_torch_operation("embedding", module=torch.nn.functional)
 embedding_backward = _register_torch_operation("torch.ops.aten.embedding_backward", like=ltorch.embedding_backward)
+one_hot = _register_torch_operation("one_hot", module=torch.nn.functional)
 group_norm = _register_torch_operation("group_norm", module=torch.nn.functional)
 interpolate = _register_torch_operation("interpolate", module=torch.nn.functional)
 linear = _register_torch_operation("linear", module=torch.nn.functional)
 logsumexp = _register_torch_operation("logsumexp")
 log_softmax = _register_torch_operation("log_softmax", module=torch.nn.functional)
 log_softmax_backward = _register_torch_operation(
     "torch.ops.aten._log_softmax_backward_data", like=ltorch.log_softmax_backward
 )
 max_pool1d = _register_torch_operation("max_pool1d", module=torch.nn.functional)
 max_pool2d = _register_torch_operation("max_pool2d", module=torch.nn.functional)
 max_pool3d = _register_torch_operation("max_pool3d", module=torch.nn.functional)
+
+
+def _max_pool_with_indices_helper(
+    ndim: int,
+    a: TensorProxy,
+    /,
+    kernel_size: int | Sequence[int],
+    stride: int | Sequence[int] | None = None,
+    padding: int | Sequence[int] = 0,
+    dilation: int | Sequence[int] = 1,
+    ceil_mode: bool = False,
+) -> [TensorProxy, TensorProxy]:
+    def div_rtn(x, y):
+        q = x // y
+        r = x % y
+        if r != 0 and (r < 0) != (y < 0):
+            q -= 1
+        return q
+
+    def pooling_output_shape(in_, kernel_, pad_, stride_, dilation_, ceil_mode_: bool):
+        out_size = (
+            div_rtn(in_ + 2 * pad_ - dilation_ * (kernel_ - 1) - 1 + (stride - 1 if ceil_mode else 0), stride) + 1
+        )
+        if ceil_mode and (out_size - 1) * stride >= in_ + pad_:
+            out_size -= 1
+        return out_size
+
+    def get_maybe_ith_entry(arg_name: str, seq: int | Sequence[int], i: int, default: int | None = None):
+        if seq is None:
+            return default
+
+        if not isinstance(seq, Sequence):
+            return seq
+
+        if len(seq) == 1:
+            return seq[0]
+        else:
+            utils.check(
+                i < len(seq),
+                lambda: f"invalid pooling argument: {arg_name} needs to be None / a scalar / size-{ndim} Sequence, but received {seq}",
+            )
+            return seq[i]
+
+    out_sizes = []
+    for i in range(ndim):
+        in_ = a.shape[i - ndim]  # i - ndim is the i-th spatial dimension
+        kernel_ = get_maybe_ith_entry("kernel_size", kernel_size, i)
+        stride_ = get_maybe_ith_entry("stride", stride, i, kernel_)
+        pad_ = get_maybe_ith_entry("padding", padding, i)
+        dilation_ = get_maybe_ith_entry("dilation", dilation, i)
+        utils.check(
+            kernel_ is not None and stride_ is not None and pad_ is not None and dilation_ is not None,
+            lambda: f"max_pool argument extraction failed.",
+        )
+        out_sizes.append(pooling_output_shape(in_, kernel_, pad_, stride_, dilation_, ceil_mode))
+
+    return TensorProxy(like=a, shape=out_sizes), TensorProxy(like=a, shape=out_sizes)
+
+
+def max_pool_with_indices_backward_meta(
+    grad: TensorProxy,
+    a: TensorProxy,
+    kernel_size: int | Sequence[int],
+    stride: int | Sequence[int] | None,
+    padding: int | Sequence[int],
+    dilation: int | Sequence[int],
+    ceil_mode: bool,
+    result1: TensorProxy,
+) -> TensorProxy:
+    return TensorProxy(like=a)
+
+
+max_pool2d_with_indices_meta = partial(_max_pool_with_indices_helper, 2)
+
+max_pool2d_with_indices = ex.register_operator(
+    "max_pool2d_with_indices", meta=max_pool2d_with_indices_meta, fn=torch.ops.aten.max_pool2d_with_indices
+)
+max_pool2d_with_indices_backward = ex.register_operator(
+    "max_pool2d_with_indices_backward",
+    meta=max_pool_with_indices_backward_meta,
+    fn=torch.ops.aten.max_pool2d_with_indices_backward,
+)
+
+max_pool3d_with_indices_meta = partial(_max_pool_with_indices_helper, 3)
+
+max_pool3d_with_indices = ex.register_operator(
+    "max_pool3d_with_indices", meta=max_pool3d_with_indices_meta, fn=torch.ops.aten.max_pool3d_with_indices
+)
+max_pool3d_with_indices_backward = ex.register_operator(
+    "max_pool3d_with_indices_backward",
+    meta=max_pool_with_indices_backward_meta,
+    fn=torch.ops.aten.max_pool3d_with_indices_backward,
+)
+
 nll_loss = _register_torch_operation("nll_loss", module=torch.nn.functional)
 pad = _register_torch_operation("pad", module=torch.nn.functional)
 scaled_dot_product_attention = _register_torch_operation("scaled_dot_product_attention", module=torch.nn.functional)
 softmax = _register_torch_operation("softmax")
 
 
 # NOTE This transform translates number proxies to boolean values
@@ -1443,25 +1550,77 @@
 cross_entropy_backward = ex.register_operator(
     "torch_cross_entropy_backward_impl", meta=ltorch.cross_entropy_backward, fn=_cross_entropy_backward_impl
 )
 _register_implementation(ltorch.cross_entropy_backward, cross_entropy_backward, checker=_always_executable)
 _register_implementation(ltorch.dropout, dropout, checker=_always_executable)
 _register_implementation(ltorch.embedding, embedding, checker=_always_executable)
 _register_implementation(ltorch.embedding_backward, embedding_backward, checker=_always_executable)
+_register_implementation(ltorch.one_hot, one_hot, checker=_always_executable)
 _register_implementation(ltorch.group_norm, group_norm, checker=_always_executable)
 _register_implementation(ltorch.interpolate, interpolate, checker=_interpolate_checker)
 _register_implementation(ltorch.linear, linear, checker=_always_executable)
 _register_implementation(ltorch.logsumexp, logsumexp, checker=_always_executable)
 _register_implementation(ltorch.log_softmax, checker=_always_executable, execution_transform=_log_softmax_transform)
 _register_implementation(
     ltorch.log_softmax_backward, checker=_always_executable, execution_transform=_log_softmax_backward_transform
 )
 _register_implementation(ltorch.max_pool1d, max_pool1d, checker=_always_executable)
-_register_implementation(ltorch.max_pool2d, max_pool2d, checker=_always_executable)
-_register_implementation(ltorch.max_pool3d, max_pool3d, checker=_always_executable)
+
+
+def max_pool2d_bwd_wrapper(
+    a: TensorProxy,
+    /,
+    kernel_size: int | Sequence[int],
+    stride: int | Sequence[int] | None = None,
+    padding: int | Sequence[int] = 0,
+    dilation: int | Sequence[int] = 1,
+    return_indices: bool = False,
+    ceil_mode: bool = False,
+) -> tuple[TensorProxy, TensorProxy] | TensorProxy:
+    primals = max_pool2d_with_indices(a, kernel_size, stride, padding, dilation, ceil_mode)
+
+    grad = get_grad(primals[0])
+    grad_a = max_pool2d_with_indices_backward(grad, a, kernel_size, stride, padding, dilation, ceil_mode, primals[1])
+    put_grad(a, grad_a)
+
+    if return_indices:
+        return primals
+    else:
+        return primals[0]
+
+
+def max_pool3d_bwd_wrapper(
+    a: TensorProxy,
+    /,
+    kernel_size: int | Sequence[int],
+    stride: int | Sequence[int] | None = None,
+    padding: int | Sequence[int] = 0,
+    dilation: int | Sequence[int] = 1,
+    return_indices: bool = False,
+    ceil_mode: bool = False,
+) -> tuple[TensorProxy, TensorProxy] | TensorProxy:
+    primals = max_pool3d_with_indices(a, kernel_size, stride, padding, dilation, ceil_mode)
+
+    grad = get_grad(primals[0])
+    grad_a = max_pool3d_with_indices_backward(grad, a, kernel_size, stride, padding, dilation, ceil_mode, primals[1])
+    put_grad(a, grad_a)
+
+    if return_indices:
+        return primals
+    else:
+        return primals[0]
+
+
+# ltorch.max_pool2d/3d decomposition uses convolution, which has performance issue running through torchex. We added grad_transform that keep both forward and backward max_pool as a torch composite operator, which avoids the performance issue. For details: https://github.com/Lightning-AI/lightning-thunder/issues/164. Aten doesn't have explicit functions for max_pool1d fwd/bwd. So the specialization is only done for 2d/3d case.
+ex.register_implementation(
+    ltorch.max_pool2d, max_pool2d, checker=_always_executable, grad_transform=max_pool2d_bwd_wrapper
+)
+ex.register_implementation(
+    ltorch.max_pool3d, max_pool3d, checker=_always_executable, grad_transform=max_pool3d_bwd_wrapper
+)
 _register_implementation(ltorch.nll_loss, checker=_always_executable, execution_transform=_nll_loss_transform)
 nll_loss_backward = ex.register_operator(
     "torch_nll_loss_backward_impl", meta=ltorch.nll_loss_backward, fn=_nll_loss_backward_impl
 )
 _register_implementation(ltorch.nll_loss_backward, nll_loss_backward, checker=_always_executable)
 _register_implementation(ltorch.pad, pad, checker=_always_executable)
 pad_prim_impl = ex.register_operator("torch_pad_prim_impl", meta=prims.pad.meta, fn=_pad_prim_impl)
@@ -1797,7 +1956,16 @@
 
         def is_float_type(self, input):
             return dtypes.is_float_dtype(input.dtype)
 
     # We force the registration of the backend here to not use
     # the torch backend when diverting isinstance
     einops._backends._type2backend[TensorProxy] = EinopsThunderBackend()
+
+
+def _copy__impl(copy_from, copy_to):
+    copy_to.copy_(copy_from)
+    return copy_to
+
+
+copy_ = ex.register_operator("copy_", meta=prims.copy_, tags=(prims.OpTags.DONT_DCE,), fn=_copy__impl)
+_register_implementation(prims.copy_, copy_, checker=_always_executable)
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/executors/transformer_engineex.py` & `lightning_thunder-0.2.0.dev20240414/thunder/executors/transformer_engineex.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/executors/triton_crossentropy_impl.py` & `lightning_thunder-0.2.0.dev20240414/thunder/executors/triton_crossentropy_impl.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/executors/utils.py` & `lightning_thunder-0.2.0.dev20240414/thunder/executors/utils.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/functional.py` & `lightning_thunder-0.2.0.dev20240414/thunder/functional.py`

 * *Files 2% similar despite different names*

```diff
@@ -10,14 +10,15 @@
     INTERPRETATION_OPTIONS,
     CACHE_OPTIONS,
     SHARP_EDGES_OPTIONS,
 )
 from thunder.core.trace import (
     TraceCtx,
     tracectx,
+    TraceResults,
 )
 
 import thunder.core.prims as prims
 
 from thunder.extend import Executor
 from thunder.core.compile_data import get_cache_option
 from thunder.core.langctxs import LanguageContext
@@ -296,15 +297,15 @@
 # An interpreter must do two things:
 #   1) Create a prologue function with the same signature as the original function that
 #       acquires all supported inputs and validates them according to the caching option
 #   2) Creates a computation function that accepts the output of the prologue function and
 #       returns what the original function did
 def _eager_unpacking_interpreter(
     interpreter: Callable, fn: Callable, args, kwargs, /, *, interpreter_name: str
-) -> tuple[TraceCtx, TraceCtx]:
+) -> TraceResults:
     # Unpacks the inputs
     si: SigInfo = get_siginfo(fn, args, kwargs)
 
     prologue_trc: TraceCtx = TraceCtx(si.unwrapped_fn)
     computation_trc: TraceCtx = TraceCtx()
 
     # Constructs the prologue trace (which just trivially unpacks the tensor arguments for now)
@@ -381,15 +382,17 @@
     with tracectx(computation_trc):
         p: Proxy
         for p in computation_args:
             prims.unpack_trivial(p)
             csi.args.append((p.name, None))
             computation_trc.add_name(p.name)
 
-        result = interpreter(si.unwrapped_fn)(*interpretation_args, **interpretation_kwargs)
+        jfn = interpreter(si.unwrapped_fn)
+        result = jfn(*interpretation_args, **interpretation_kwargs)
+        interpreter_log = getattr(jfn, "_last_interpreter_log", [])
 
         # Validates that the returned items are proxies or printable values
         def leaf_test(x: Any) -> bool:
             if isinstance(x, Proxy):
                 return True
             if is_base_printable(x):
                 return True
@@ -408,36 +411,34 @@
     with tracectx(prologue_trc):
         prims.python_return(tuple(computation_args))
 
     # Constructs the computation trace's signature
     computation_trc._siginfo = csi
     computation_trc.args = computation_args
 
-    return prologue_trc, computation_trc
+    return TraceResults(prologue_trc, computation_trc, None, interpreter_log)
 
 
 # Translates the Python function a thunder program using the Python interpreter
-def _python_interpreter(
-    fn: Callable, args, kwargs, /, *, sharp_edges: SHARP_EDGES_OPTIONS
-) -> tuple[TraceCtx, TraceCtx]:
+def _python_interpreter(fn: Callable, args, kwargs, /, *, sharp_edges: SHARP_EDGES_OPTIONS) -> TraceResults:
     if sharp_edges is not SHARP_EDGES_OPTIONS.ALLOW:
         raise ValueError(
             f"Detecting sharp edges is not supported when using the Python interpreter. To detect sharp edges use another interpretation option."
         )
 
     def _interpreter(fn_):
         return fn_
 
     return _eager_unpacking_interpreter(_interpreter, fn, args, kwargs, interpreter_name="Python")
 
 
 # Translates the Python function to a thunder program using the thunder interpreter
 def _translate_functions_interpreter(
     fn: Callable, args, kwargs, /, *, sharp_edges: SHARP_EDGES_OPTIONS
-) -> tuple[TraceCtx, TraceCtx]:
+) -> TraceResults:
     from thunder.core.jit_ext import minimal_thunder_jit
 
     pjit = partial(minimal_thunder_jit, sharp_edges=sharp_edges)
     return _eager_unpacking_interpreter(pjit, fn, args, kwargs, interpreter_name="translate functions")
 
 
 # note: keep this roughly in sync with thunder.jit
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/numpy/__init__.py` & `lightning_thunder-0.2.0.dev20240414/thunder/numpy/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/numpy/langctx.py` & `lightning_thunder-0.2.0.dev20240414/thunder/numpy/langctx.py`

 * *Files identical despite different names*

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/torch/__init__.py` & `lightning_thunder-0.2.0.dev20240414/thunder/torch/__init__.py`

 * *Files 1% similar despite different names*

```diff
@@ -232,48 +232,62 @@
         device_ = tensor_dtype_or_device.device if device is None else to_device(device)
         dtype_ = tensor_dtype_or_device.true_dtype if dtype is None else to_dtype(dtype)
         device, dtype = device_, dtype_
 
     return device, dtype
 
 
-# TODO Model non_blocking, copy, and memory_format (as kwargs)
+# TODO Model non_blocking (as kwargs)
 @torchsymbol(torch.Tensor.to, is_method=True)
 def to(
     a: TensorLike,
     tensor_dtype_or_device: None | TensorLike | dtypeLike | DeviceLike = None,
     optional_positional_dtype: None | dtypeLike = None,
     /,
     *,
     device: None | DeviceLike = None,
     dtype: None | dtypeLike = None,
     copy: bool = False,
+    memory_format: None | torch.memory_format = None,
 ) -> TensorLike:
     device, dtype = _parse_to_device_and_dtype(
         tensor_dtype_or_device, optional_positional_dtype, device=device, dtype=dtype
     )
 
     if copy:
         if device is not None:
             device = to_device(device)
             a = prims.device_put(a, device)
         if dtype is not None:
             dtype = to_dtype(dtype)
             a = prims.convert_element_type(a, dtype)
+        if memory_format is not None:
+            # NOTE not sure if we need to handle torch.preserve_format explicitly
+            if memory_format == torch.channels_last:
+                a = prims.stride_order(a, (3, 0, 2, 1))
+            elif memory_format == torch.channels_last_3d:
+                a = prims.stride_order(a, (4, 0, 3, 2, 1))
         return a
 
     # NOTE copy == False
     # NOTE to() returns the tensor unmodified if the device and dtype requested are the same
     #   (and copy=False)
     # NOTE clang.device_put does nothing when device is None or a.device == device
     a = clang.device_put(a, device)
 
     if dtype is not None:
         return clang.maybe_convert_to_dtype(a, dtype)
 
+    if memory_format is not None:
+        # NOTE not sure if we need to handle torch.preserve_format explicitly
+        if memory_format == torch.channels_last:
+            a = prims.stride_order(a, (3, 0, 2, 1))
+        elif memory_format == torch.channels_last_3d:
+            a = prims.stride_order(a, (4, 0, 3, 2, 1))
+
     return a
 
 
 @torchsymbol(torch.Tensor.type_as, is_method=True)
 def type_as(a: TensorProxy, b: TensorProxy, /) -> TensorProxy:
     # NOTE This type check is intentional since we're accessing the true_dtype
     #   attribute of the TensorProxy
@@ -952,14 +966,19 @@
     utils.check(
         len(a.size()) > 0,
         lambda: f"Dimension specified as={dim} but tensor has no dimensions.",
     )
     return tuple(s.squeeze(dim) for s in tensor_split(a, a.shape[dim], dim))
 
 
+@torchsymbol(torch.Tensor.unfold, is_method=True)
+def unfold(a: TensorLike, /, dim: int, size: int, step: int) -> TensorLike:
+    return clang.unfold(a, dim, size, step)
+
+
 @torchsymbol(torch.unsqueeze, is_method=True)
 def unsqueeze(a: TensorLike, /, dim: int) -> TensorLike:
     return clang.unsqueeze(a, dim)
 
 
 # TODO Review view functionalization
 # TODO Add type annotations
@@ -3485,14 +3504,32 @@
 
 @torchsymbol(torch.ops.aten.embedding_backward)
 def embedding_backward(grad, indices, num_weights, padding_idx, scale_grad_by_freq, sparse):
     result = prims.embedding_backward(grad, indices, num_weights, padding_idx, scale_grad_by_freq, sparse)
     return result
 
 
+@torchsymbol(torch.nn.functional.one_hot, id="torch.nn.functional.one_hot", is_method=False)
+def one_hot(a: TensorLike, /, num_classes: int) -> TensorLike:
+    # TODO: refactor when we're ready to support auto-inference for `num_classes = -1` using `.item()`
+    utils.check(
+        num_classes >= 1,
+        lambda: f"Currently supports only positive input for num_classes, got num_classes={num_classes}",
+        exception_type=NotImplementedError,
+    )
+    # TODO: would we want to implement this check in the future?
+    #  utils.check(a.any() >= 0, lambda f"input tensor should have non-negative values", exception_type=ValueError)
+
+    canvas = zeros(*a.shape, num_classes, device=a.device, dtype=dtypes.int64)
+    index = a.unsqueeze(-1)
+    src = ones_like(index, device=a.device, dtype=dtypes.int64)
+
+    return scatter_add(canvas, dim=-1, index=index, src=src)
+
+
 @torchsymbol(torch.group_norm, torch.nn.functional.group_norm, id="torch.nn.functional.group_norm", is_method=False)
 def group_norm(
     a: TensorProxy,
     /,
     num_groups: int,
     weight: None | TensorProxy = None,
     bias: None | TensorProxy = None,
```

### Comparing `lightning-thunder-0.2.0.dev20240407/thunder/torch/langctx.py` & `lightning_thunder-0.2.0.dev20240414/thunder/torch/langctx.py`

 * *Files identical despite different names*

